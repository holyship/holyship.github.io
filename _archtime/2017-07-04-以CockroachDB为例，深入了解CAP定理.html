---
title: 以CockroachDB为例，深入了解CAP定理
author: 薛命灯
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499656728&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvWxnaSzyLxMLhJzn9jKm*dNZzNOL-qoOPpxfQXfebTvzD1HzIFuQ5ZU9OfhPLFxT67FjRs*RzYgv9QG8Boa5lpUOPSSmPXPTSf7xizaBxqu41u2ML24PfLIfxDl3P5-*a*9lnqiCxxP3EpdlL1bafmyA=
date: '2017-07-04 00:00:00 +0000'

---

{% raw  %}
<section style="color: rgb(63, 63, 63); font-size: 14px; font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif; text-align: center; box-sizing: border-box;"><section class="" style="box-sizing: border-box; text-align: left;">
		<img src="http://mmbiz.qpic.cn/mmbiz_jpg/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5fdlRpQEk53HNYYFp7tCKKwxYQAIGmaKDN5xeLuOfDFiaVNQrTZtPUHpw/0?wx_fmt=jpeg" style="border-radius: 4px; margin-bottom: 25px; width: 770px !important; height: 463.203px !important; visibility: visible !important;">
	</section><section class="" style="box-sizing: border-box; color: rgb(145, 145, 145); text-align: left; line-height: 1em; margin-top: 13px; padding-left: 14px;">
		作者｜薛命灯	</section><section class="" style="box-sizing: border-box; color: rgb(145, 145, 145); text-align: left; line-height: 1em; margin-top: 13px; padding-left: 14px;">
		编辑｜郭蕾	</section><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">CAP 定理是分布式系统理论的基础，它的核心内容是说，在存在分区（如网络故障）的情况下，一个系统无法同时保证一致性（consistency）和可用性（availability），只能二选其一。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">有些数据库选择了一致性，那么这类系统就被称为 CP 系统。而有些系统更看重可用性，也就是 AP 系统。一致性和可用性对于任何一个业务系统来说都是至关重要的，如何在这两者之间做出选择也就变成一个大难题。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">这篇文章将说明如何在保证系统一致性的同时仍然能够保证高可用性，并以 CockroachDB 为例来解释 CAP 定理，以及为什么对于大多数数据库来说一致性更重要。</p><section class="" style="box-sizing: border-box; font-size: 20px;">
		<span style="margin-top: 38px; margin-bottom: 10px; height: 65px; line-height: 96px; color: rgb(60, 112, 198); background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5fVLTAKu4nWw8rl4Ad2ic6RqqSWu83GOZKmNemMJFlbYibEexp1uxkM0Pw/0?wx_fmt=png&quot;); background-position: 50% 50%; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; border-bottom: 2px solid rgb(27, 95, 160); background-size: 55px; display: inline-block;">高可用性</span>
	</section><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">在 CAP 定理里，可用性具有严格的二元性：一个系统要么可用，要么不可用。但在服务级别协议（SLA）里，可用性具有连续性。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">例如，一个系统可以保证 99.99% 的可用性（4 个 9，也就是说每年允许宕机的时间不超过一个小时）。100% 的可用性是不现实的。工程上的高可用性要求对各种中断的严重程度进行评估，并在降低故障率所要花费的成本上做出平衡。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">一个具有一致性保证的系统有时候因为网络分区出现不可用，但即使是具有可用性保证的系统，也会因为各种原因出现不可用。在一个良好的网络环境里，因网络分区造成的故障不会比其他类型的故障更常见。既然故障是不可避免的，进而导致不可用，那为什么不先保证一致性呢？</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">Brewer 博士说 Google 的网络很少会出现分区，Spanner 数据库理论上是“CP”，但实际上几乎是“CA”的。这听起来有点跑题了，不过却也说明了在可用性方面做出一些权衡，其影响面不会太大。</p><section class="" style="box-sizing: border-box; font-size: 20px;">
		<span style="margin-top: 38px; margin-bottom: 10px; height: 65px; line-height: 96px; color: rgb(60, 112, 198); background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5fVLTAKu4nWw8rl4Ad2ic6RqqSWu83GOZKmNemMJFlbYibEexp1uxkM0Pw/0?wx_fmt=png&quot;); background-position: 50% 50%; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; border-bottom: 2px solid rgb(27, 95, 160); background-size: 55px; display: inline-block;">合理的权衡</span>
	</section><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">在分布式系统里，权衡无处不在，我们总是要在一致性、可用性、性能和灵活性之间做出权衡。而 CAP 定理将选择的范围缩小到一致性和可用性之间，但无法涵盖所有可能造成不可用的问题根源。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">有各种原因可能造成系统中断，比如硬件单点故障、应用程序的缺陷或运维人员的人为错误。而从整个系统层面来看，如果能够处理好网络分区问题，那么就有可能在不牺牲一致性的前提下提升可用性。CAP 的可用性不一定会带来实质性的可用性保证，但如果牺牲了一致性，将会给应用程序的代码带来复杂性，也意味着更高的工程成本。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">假设有一个应用程序，它部署在 3 个数据中心里，客户端的流量经过负载均衡器连接到应用程序上。如果其中的一个数据中心因网络故障掉线，那么连接到这个数据中心的客户端将会遭遇中断，而不管底层的数据库是 CP 还是 CA 的。而如果负载均衡器将这些中断的客户端流量重定向到活跃的数据中心，不管底层的数据库如何处理网络分区问题，服务仍然可用。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">只有当数据中心复本之间无法通信而客户端仍然能够与各个数据中心对话时，AP 系统仍然可用，而 CP 系统不可用。如果把整个系统作为整体部署来考虑，可以不用遵循 CAP 定理所要求的需要每个节点都要返回响应的原则，从而达到高可用性。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">如果 AP 系统所能带来的可用性价值不高，那么为什么要为此牺牲一致性呢？理由只有一个，因为写入延迟。一致性系统在执行写入操作的时候需要协调各个节点来保证一致性（当然，有些系统对一致性读也有很高要求）。非一致性系统允许丢失数据，所以可以很快返回响应。对于速度比健壮性更重要的系统来说，或许这会是更好的选择。</p><section class="" style="box-sizing: border-box; font-size: 20px;">
		<span style="margin-top: 38px; margin-bottom: 10px; height: 65px; line-height: 96px; color: rgb(60, 112, 198); background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5fVLTAKu4nWw8rl4Ad2ic6RqqSWu83GOZKmNemMJFlbYibEexp1uxkM0Pw/0?wx_fmt=png&quot;); background-position: 50% 50%; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; border-bottom: 2px solid rgb(27, 95, 160); background-size: 55px; display: inline-block;">CockroachDB 的 CAP</span>
	</section><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">CockroachDB 是 CP 系统：每一份数据至少有 3 个复本，在写入数据时要求每个复本之间进行通信。在数据读取方面，其中的一个复本被授予一段时间的租期或一个数据子集的临时所有权，这个复本可以在不与其他复本通信的情况下处理读取请求。如果这个复本与其他复本失去联系，在租期内（默认是 9 秒钟）它仍然能够提供读取数据服务（但不能写入）。在租约到期之后，另外两个复本中的一个会得到新的租约。这样可以确保系统能够快速地从中断中恢复，提供最高的可用性，尽管它不符合 CAP 定理对可用性的定义。</p><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">CockroachDB 的强一致性基因让它有可能为分布式数据库提供与传统的非分布式数据库一样的一致性保证，同时保持高可用。对于大多数应用程序来说，CP 数据库会是更好的选择，尽管存在潜在的延迟，但它也为开发者提供了一些保证。</p><ul style="margin-top: 10px; line-height: 1em; text-align: left;" class="list-paddingleft-2"><li><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; color: rgb(74, 74, 74);">大部分最近的写入对后续的读取是可见的。</p></li><li><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; color: rgb(74, 74, 74);">其他开发人员无法破坏应用整体的一致性。</p></li><li><p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; color: rgb(74, 74, 74);">发生分区事件时，系统会阻塞，而不是返回不完整的数据。</p></li></ul><section class="" style="box-sizing: border-box; padding-top: 19px;">
		<h5 style="height: 51px; line-height: 52px; font-size: 18px; margin-top: 38px; color: rgb(60, 112, 198); background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5fdUho73IAQf1dzLrqvscheetq6at2ibAA0CIq43EicsryZ9ib16PxZtZrA/0?wx_fmt=png&quot;); background-position: center center; background-size: initial; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial;"><span style="display: inline-block; height: 51px; width: 37%; float: left; background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5fdXqhmNMcCWB4Wd8CDUgJE4V1h8yEaeYdb02DnyEoibbY47K328VT1Rg/0?wx_fmt=png&quot;); background-position: center center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 100%;"></span>今日荐文<span style="display: inline-block; height: 51px; width: 37%; float: right; background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5fFia6Ym3ibp5egkp7eiafiafqlaf8DHDibYWqOdTQqj3EicSAPxLe151muiaXA/0?wx_fmt=png&quot;); background-position: center center; background-repeat: no-repeat; background-attachment: initial; background-origin: initial; background-clip: initial; background-size: 100%;"></span></h5>
		<p style="box-sizing: border-box; white-space: pre-line; line-height: 27px; font-size: 15px; color: rgb(200, 199, 199); padding-top: 28px; padding-bottom: 28px;">点击下方图片即可阅读</p>
		
		
		
		
		
		
				<a href="https://mp.weixin.qq.com/s?__biz=MzA5Nzc4OTA1Mw==&amp;mid=2659599384&amp;idx=1&amp;sn=654308f6a6c5ea7fdc783b464eb33f49&amp;scene=21#wechat_redirect" style="color: #5BACEB;">
			<img src="http://mmbiz.qpic.cn/mmbiz_jpg/LaW7jDBKBg2KGk1Kkl8qYKuEIYYWnCD0wUpTx6898PiawibNdkfkibIptuZ7qYicdueRASWt72UCibne2tTcNDk588Q/640?wx_fmt=jpeg" style="color: inherit; float: left; width: 770px !important; height: 512.531px !important;">
		</a>
		<section class="" style="text-align: left; width: 100%; margin-top: -3em; margin-bottom: 29px; float: left; box-sizing: border-box; background-color: rgba(13, 14, 28, 0.8); max-width: 640px;">
			<section style="text-align: center; color: inherit; box-sizing: border-box;">
				<p style="font-size: 16px; line-height: 27px; text-align: left; color: rgb(255, 255, 255); box-sizing: border-box; white-space: normal; padding-top: 8px; padding-bottom: 8px; padding-left: 13px;"><span style="display: inline-block; width: 22px; height: 18px; background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5f2hozCy0e81g3DYJjdrhKBGibzRBwFiajMO7eHWwj7OQYlkHbkicNicFeYQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat; vertical-align: middle; margin-right: 8px;"></span>
					轻松筹 1.6 亿注册用户的 Passport 账户体系架构设计				</p>
			</section>
		</section>
		<hr style="width: 100%; height: 1px; border-top-style: dotted; border-top-color: rgb(165, 165, 165);">
	</section><section class="" style="box-sizing: border-box; width: 100%; text-align: left;">
		<p style="box-sizing: border-box; font-size: 16px; text-align: justify; white-space: pre-line; line-height: 27px; padding-top: 23px; padding-right: 8px; padding-left: 8px; color: rgb(74, 74, 74);">近日，由 InfoQ 参与承办的以“在一起，梦飞扬”为主题的 2017 华为开发者大赛正式开赛，大赛设置百万现金奖励，面向参赛者征集采用华为 11 个领域开放能力的优秀作品，包括：云计算、大数据、物联网、企业云通信、eLTE、视频、CloudCaaS 、移动、开放工场、运营商运营管理、IES SmallCell。如果你是华为的合作伙伴，或者对华为合作伙伴生态感兴趣，可以点击“<span class="" style="text-align: left; color: rgb(91, 172, 235);">阅读原文</span>”链接报名，InfoQ 将提供全程赛事指导，提交作品更有开发者礼包相赠。</p>
		<img src="http://mmbiz.qpic.cn/mmbiz_jpg/LaW7jDBKBg1xiayAqWCIfYxCj71fRYD5ffu0ykFxO9QPkADATAqCic5rSsP6PBCfvt5vEbZAM2QxobdG496icPMfw/0?wx_fmt=jpeg" style="padding-right: 8px; padding-left: 8px; margin-top: 28px; margin-right: auto; margin-left: auto; width: 770px !important; height: 418.219px !important;"></section></section><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499656728&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvWxnaSzyLxMLhJzn9jKm*dNZzNOL-qoOPpxfQXfebTvzD1HzIFuQ5ZU9OfhPLFxT67FjRs*RzYgv9QG8Boa5lpUOPSSmPXPTSf7xizaBxqu41u2ML24PfLIfxDl3P5-*a*9lnqiCxxP3EpdlL1bafmyA=">微信地址</a> | <a href="http://infoqstatic.com/cn/zones/huawei/index.html#utm_source=InfoQ&amp;utm_medium=archtime&amp;utm_campaign=hdc&amp;utm_term=0703&amp;utm_content=01">阅读原文</a>
{% endraw  %}

