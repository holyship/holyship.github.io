---
title: 前端本地文件操作与上传
author: 人人网FED
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512890585&src=3&ver=1&signature=nJHJ*lkpUmWR2w6oU7bDOsSS-8Q91g9q3gppAf*YzodGa8*kFsjsjxlxjgvUsxhcPuHPudx98CYtGO1llmvZoL6vWN4SHU6btvEIx5aJrKpPHM3eAs*fXI-XkwifZpvHpNf6jpeP0kIpJ9HZy8xSWFTJCvEj0u42AlhwY2NzahU=
date: '2017-12-06 00:00:00 +0000'

---

{% raw  %}
<p><img src="http://mmbiz.qpic.cn/mmbiz_gif/d8tibSEfhMMrjNKjEmoX7KR4FZKdwlrguCicepySoficvu2OMNxXQT0YbHdMcVtVV4P8ZqsqXBnegtw4VibYxhichMQ/0?wx_fmt=gif" style="border: 0px; vertical-align: middle; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 720px !important; height: 100px !important;"></p><p class="editor-said" style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;max-width: 100%;color: rgb(51, 51, 51);"><span style="background-color: rgb(255, 254, 213);">编者按：本文由人人网FED发表于掘金，由作者授权分享到奇舞周刊。</span></p><p style="text-align: center;"><img src="https://mmbiz.qpic.cn/mmbiz_gif/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAmT0YYRbQyUu9YNPWPDbdJ3HNynAMTaqsZy7aDHNGsib8OKRwz42ITzQ/0?wx_fmt=gif" style="width: 400px !important; height: 300px !important;"></p><p style="text-align: center;"><span style="color: rgb(136, 136, 136);font-size: 15px;">（图片来自网络）</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">前端无法像原生APP一样直接操作本地文件，否则的话打开个网页就能把用户电脑上的文件偷光了，所以需要通过用户触发，用户可通过以下三种方式操作触发：</p><ol style="" class=" list-paddingleft-2"><li><p>通过input type="file" 选择本地文件</p></li><li><p>通过拖拽的方式把文件拖过来</p></li><li><p>在编辑框里面复制粘贴</p></li></ol><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">第一种是最常用的手段，通常还会自定义一个按钮，然后盖在它上面，因为type="file"的input不好改变样式。如下代码写一个选择控件，并放在form里面：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-html" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;</span>form</span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;</span>input</span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">type</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>file<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">id</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>file-input<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">name</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>fileContent<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;/</span>form</span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">然后就可以用<strong style="border: 0px;">FormData</strong>获取整个表单的内容：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">$</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"#file-input"</span><span class="token punctuation" style="border: 0px;">).</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">on</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"change"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">()</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(<span class="token string" style="color: rgb(166, 226, 46);">`file name is&nbsp;</span><span class="token interpolation" style=""><span class="token interpolation-punctuation punctuation" style="border: 0px;">${</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>value<span class="token interpolation-punctuation punctuation" style="border: 0px;">}</span></span><span class="token string" style="color: rgb(166, 226, 46);">`</span>);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;formData&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">FormData(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>form<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;formData<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">append</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"fileName"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>value<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(</span>formData<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">});</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">把input的value和formData打印出来是这样的：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAgQqpUMuj9saOC9nTvpbtCBq4oP2RRXbfSVibFZusE5ibNvianibjibBoMyQ/0?wx_fmt=other" style="border: 0px; vertical-align: middle; width: 558px !important; height: 142px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">可以看到文件的路径是一个假的路径，也就是说在浏览器无法获取到文件的真实存放位置。同时FormData打印出来是一个空的Objet，但并不是说它的内容是空的，只是它对前端开发人员是透明的，无法查看、修改、删除里面的内容，只能append添加字段。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">FormData无法得到文件的内容，而使用<strong style="border: 0px;">FileReader</strong>可以读取整个文件的内容。用户选择文件之后，input.files就可以得到用户选中的文件，如下代码：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">$</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"#file-input"</span><span class="token punctuation" style="border: 0px;">).</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">on</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"change"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">()</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;fileReader&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">FileReader(),</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fileType&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">].</span>type<span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;fileReader<span class="token punctuation" style="border: 0px;">.</span>onload&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">()</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">if</span>&nbsp;<span class="token punctuation" style="border: 0px;">(</span><span class="token regex" style="border: 0px;color: rgb(253, 151, 31);">/^image/</span><span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">test</span><span class="token punctuation" style="border: 0px;">(</span>fileType<span class="token punctuation" style="border: 0px;">))</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 读取结果在fileReader.result里面</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">$</span><span class="token punctuation" style="border: 0px;">(<span class="token string" style="color: rgb(166, 226, 46);">`&lt;img src="</span><span class="token interpolation" style=""><span class="token interpolation-punctuation punctuation" style="border: 0px;">${</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>result<span class="token interpolation-punctuation punctuation" style="border: 0px;">}</span></span><span class="token string" style="color: rgb(166, 226, 46);">"&gt;`</span>).</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">appendTo</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"body"</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">}</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">}</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 打印原始File对象</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">]);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// base64方式读取</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;fileReader<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readAsDataURL</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">]);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">});</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">把原始的File对象打印出来是这样的：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAJv6X7XKsswJY28ictLh9qxysvWJ2EMs5xN87uXbQKum4ibVVuO2uwmjg/0?wx_fmt=png" style="border: 0px; vertical-align: middle; width: 546px !important; height: 294px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">它是一个window.File的实例，包含了文件的修改时间、文件名、文件的大小、文件的mime类型等。如果需要限制上传文件的大小就可以通过判断size属性有没有超，单位是字节，而要判断是否为图片文件就可以通过type类型是否以image开头。通过判断文件名的后缀可能会不准，而通过这种判断会比较准。上面的代码使用了一个正则判断，如果是一张图片的话就把它赋值给img的src，并添加到dom里面，但其实这段代码有点问题，就是web不是所有的图片都能通过img标签展示出来，通常是jpg/png/gif这三种，所以你应该需要再判断一下图片格式，如可以把判断改成：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token regex" style="border: 0px;color: rgb(253, 151, 31);">/^image\/[jpeg|png|gif]/</span><span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">test</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>type<span class="token punctuation" style="border: 0px;">)</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">然后实例化一个FileReader，调它的readAsDataURL并把File对象传给它，监听它的onload事件，load完读取的结果就在它的result属性里了。它是一个base64格式的，可直接赋值给一个img的src.</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">使用FileReader除了可读取为base64之外，还能读取为以下格式：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 按base64的方式读取，结果是base64，任何文件都可转成base64的形式</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">fileReader<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readAsDataURL</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">]);</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 以二进制字符串方式读取，结果是二进制内容的utf-8形式，已被废弃了</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">fileReader<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readAsBinaryString</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">]);</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 以原始二进制方式读取，读取结果可直接转成整数数组</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">fileReader<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readAsArrayBuffer</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">]);</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">其它的主要是能读取为ArrayBuffer，它是一个原始二进制格式的结果。把ArrayBuffer打印出来是这样的：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAibqHplvrkdFOUT7zKMHbhuGOICtsAha5ykLnDDLVEGC4uSKNwAot4Rg/0?wx_fmt=png" style="border: 0px; vertical-align: middle; width: 522px !important; height: 142px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">可以看到，它对前端开发人员也是透明的，不能够直接读取里面的内容，但可以通过ArrayBuffer.length得到长度，还能转成整型数组，就能知道文件的原始二进制内容了：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;buffer&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>result<span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 依次每字节8位读取，放到一个整数数组</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;view&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">Uint8Array(</span>buffer<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(</span>view<span class="token punctuation" style="border: 0px;">);</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">如果是通过第二种<strong style="border: 0px;">拖拽的方式</strong>，应该怎么读取文件呢？如下html（样式略）：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-html" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;</span>div</span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">class</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>img-container<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;drop your image here</p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;/</span>div</span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">这将在页面显示一个框：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAQfGkksspyY56tq51KKDUImUt0Rqa6Q6bSPBK6ibKqia5pobloNe6oz3A/0?wx_fmt=png" style="border: 0px; vertical-align: middle; width: 276px !important; height: 270px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">然后监听它的拖拽事件：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">$</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">".img-container"</span><span class="token punctuation" style="border: 0px;">).</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">on</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"dragover"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="token punctuation" style="border: 0px;">(</span>event<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;event<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">preventDefault</span><span class="token punctuation" style="border: 0px;">();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">})</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">on</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"drop"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">(</span>event<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;event<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">preventDefault</span><span class="token punctuation" style="border: 0px;">();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 数据在event的dataTransfer对象里</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;file&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;event<span class="token punctuation" style="border: 0px;">.</span>originalEvent<span class="token punctuation" style="border: 0px;">.</span>dataTransfer<span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">];</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 然后就可以使用FileReader进行操作</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;fileReader<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readAsDataURL</span><span class="token punctuation" style="border: 0px;">(</span>file<span class="token punctuation" style="border: 0px;">);</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 或者是添加到一个FormData</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;formData&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">FormData();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;formData<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">append</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"fileContent"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;file<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">})</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">数据在drop事件的event.dataTransfer.files里面，拿到这个File对象之后就可以和输入框进行一样的操作了，即使用FileReader读取，或者是新建一个空的formData，然后把它append到formData里面。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">第三种<strong style="border: 0px;">粘贴的方式</strong>，通常是在一个编辑框里操作，如把div的contenteditable设置为true：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-html" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;</span>div</span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">contenteditable</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>true<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;hello, paste your image here</p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;/</span>div</span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">粘贴的数据是在event.clipboardData.files里面：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">$</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"#editor"</span><span class="token punctuation" style="border: 0px;">).</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">on</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"paste"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">(</span>event<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;file&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;event<span class="token punctuation" style="border: 0px;">.</span>originalEvent<span class="token punctuation" style="border: 0px;">.</span>clipboardData<span class="token punctuation" style="border: 0px;">.</span>files<span class="token punctuation" style="border: 0px;">[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">];</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">});</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">但是Safari的粘贴不是通过event传递的，它是直接在输入框里面添加一张图片，如下图所示：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAI9ZfSRCSeo7HFXnPe93yjcLPrnqZbDoJVs4YUyPMaRT8ld2bE8tSCg/0?wx_fmt=png" style="border: 0px; vertical-align: middle; width: 770px !important; height: 145.444px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">它新建了一个img标签，并把img的src指向一个blob的本地数据。什么是blob呢，如何读取blob的内容呢？</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">blob是一种类文件的存储格式，它可以存储几乎任何格式的内容，如json：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;data&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span>hello<span class="token punctuation" style="border: 0px;">:</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"world"</span><span class="token punctuation" style="border: 0px;">};</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;blob&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">Blob([</span>JSON<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">stringify</span><span class="token punctuation" style="border: 0px;">(</span>data<span class="token punctuation" style="border: 0px;">)],</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">{</span>type&nbsp;<span class="token punctuation" style="border: 0px;">:</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'application/json'</span><span class="token punctuation" style="border: 0px;">});</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">为了获取本地的blob数据，我们可以用ajax发个本地的请求：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">$</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"#editor"</span><span class="token punctuation" style="border: 0px;">).</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">on</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"paste"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">(</span>event<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 需要setTimeout 0等图片出来了再处理</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">setTimeout</span><span class="token punctuation" style="border: 0px;">(()</span>&nbsp;<span class="token operator" style="border: 0px;">=&gt;</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;img&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">$</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">).</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">find</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"img[src^='blob']"</span><span class="token punctuation" style="border: 0px;">)[</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">];</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(</span>img<span class="token punctuation" style="border: 0px;">.</span>src<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 用一个xhr获取blob数据</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;xhr&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">XMLHttpRequest();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xhr<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">open</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"GET"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;img<span class="token punctuation" style="border: 0px;">.</span>src<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 改变mime类型</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xhr<span class="token punctuation" style="border: 0px;">.</span>responseType&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"blob"</span><span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xhr<span class="token punctuation" style="border: 0px;">.</span>onload&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="token punctuation" style="border: 0px;">()</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// response就是一个Blob对象</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>response<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">};</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xhr<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">send</span><span class="token punctuation" style="border: 0px;">();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">},</span>&nbsp;<span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">});</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">上面代码把blob打印出来是这样的：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAwtzIlXMVSoDNOF7YnTlujX0MvMPcsZ2IXicPmuxJTWJkXePZNbgjRAA/0?wx_fmt=png" style="border: 0px; vertical-align: middle; width: 770px !important; height: 169.065px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">能得到它的大小和类型，但是具体内容也是不可见的，它有一个slice的方法，可用于切割大文件。和File一样，可以使用FileReader读取它的内容：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readBlob</span><span class="token punctuation" style="border: 0px;">(</span>blobImg<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;fileReader&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">FileReader();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;fileReader<span class="token punctuation" style="border: 0px;">.</span>onload&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">()</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>result<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">}</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;fileReader<span class="token punctuation" style="border: 0px;">.</span>onerror&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">(</span>err<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">log</span><span class="token punctuation" style="border: 0px;">(</span>err<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">}</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;fileReader<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readAsDataURL</span><span class="token punctuation" style="border: 0px;">(</span>blobImg<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">}</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readBlob</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>response<span class="token punctuation" style="border: 0px;">);</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">除此，还能使用window.URL读取，这是一个新的API，经常和Service Worker配套使用，因为SW里面常常要解析url。如下代码：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readBlob</span><span class="token punctuation" style="border: 0px;">(</span>blobImg<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;urlCreator&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;window<span class="token punctuation" style="border: 0px;">.</span>URL&nbsp;<span class="token operator" style="border: 0px;">||</span>&nbsp;window<span class="token punctuation" style="border: 0px;">.</span>webkitURL<span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 得到base64结果</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;imageUrl&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;urlCreator<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">createObjectURL</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>response<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">return</span>&nbsp;imageUrl<span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">}</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">readBlob</span><span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>response<span class="token punctuation" style="border: 0px;">);</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">关于src使用的是blob链接的，除了上面提到的img之外，另外一个很常见的是video标签，如youtobe的视频就是使用的blob：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAvgLrQIl4dfEmFz6wKKLHhwxaKWFiaiaZ7uOt0t8augzoQiaK8zoxoEeibw/0?wx_fmt=png" style="border: 0px; vertical-align: middle; width: 770px !important; height: 76.4653px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">这种数据不是直接在本地的，而是通过持续请求视频数据，然后再通过blob这个容器媒介添加到video里面，它也是通过URL的API创建的：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;mediaSource&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">MediaSource();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">video<span class="token punctuation" style="border: 0px;">.</span>src&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;URL<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">createObjectURL</span><span class="token punctuation" style="border: 0px;">(</span>mediaSource<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;sourceBuffer&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;mediaSource<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">addSourceBuffer</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">sourceBuffer<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">appendBuffer</span><span class="token punctuation" style="border: 0px;">(</span>buf<span class="token punctuation" style="border: 0px;">);</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">具体我也没实践过，不再展开讨论。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">上面，我们使用了三种方式获取文件内容，最后得到：</p><ol style="" class=" list-paddingleft-2"><li><p>FormData格式</p></li><li><p>FileReader读取得到的base64或者ArrayBuffer二进制格式</p></li></ol><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">如果直接就是一个FormData了，那么直接用ajax发出去就行了，不用做任何处理：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;form&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;document<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">querySelector</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"form"</span><span class="token punctuation" style="border: 0px;">),</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;formData&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">FormData(</span>form<span class="token punctuation" style="border: 0px;">),</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">formData<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">append</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"fileName"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"photo.png"</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;xhr&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">XMLHttpRequest();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 假设上传文件的接口叫upload</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">xhr<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">open</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"POST"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"/upload"</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">xhr<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">send</span><span class="token punctuation" style="border: 0px;">(</span>formData<span class="token punctuation" style="border: 0px;">);</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">如果用jQuery的话，要设置两个属性为false：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">$<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">ajax</span><span class="token punctuation" style="border: 0px;">({</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;url<span class="token punctuation" style="border: 0px;">:</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"/upload"</span><span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;type<span class="token punctuation" style="border: 0px;">:</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"POST"</span><span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;data<span class="token punctuation" style="border: 0px;">:</span>&nbsp;formData<span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;processData<span class="token punctuation" style="border: 0px;">:</span>&nbsp;<span class="token boolean" style="border: 0px;color: rgb(174, 129, 255);">false</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 不处理数据</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;contentType<span class="token punctuation" style="border: 0px;">:</span>&nbsp;<span class="token boolean" style="border: 0px;color: rgb(174, 129, 255);">false</span>&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 不设置内容类型</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">});</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">因为jQuery会自动把内容做一些转义，并且根据data自动设置请求mime类型，这里告诉jQuery直接用xhr.send发出去就行了。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">观察控制台发请求的数据：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAWj3azhIGuvoMULdJIplbc6kLs7oyuyJZmnOHE03e5xP4ic6RNlD4hog/0?wx_fmt=other" style="border: 0px; vertical-align: middle; width: 770px !important; height: 260.973px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">可以看到这是一种区别于用&amp;连接参数的方式，它的编码格式是multipart/form-data，就是上传文件form表单写的enctype：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-html" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;</span>form</span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">enctype</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>multipart/form-data<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">method</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>post<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;</span>input</span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">type</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>file<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span>&nbsp;<span class="token attr-name" style="color: rgb(166, 226, 46);">name</span><span class="token attr-value" style="color: rgb(230, 219, 116);"><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">="</span>fileContent<span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">"</span></span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token tag" style="border: 0px;color: rgb(249, 38, 114);"><span class="token tag" style=""><span class="token punctuation" style="border: 0px;color: rgb(248, 248, 242);">&lt;/</span>form</span><span class="token punctuation" style="color: rgb(248, 248, 242);">&gt;</span></span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">如果xhr.send的是FormData类型话，它会自动设置enctype，如果你用默认表单提交上传文件的话就得在form上面设置这个属性，因为上传文件只能使用POST的这种编码。常用的POST编码是application/x-www-form-urlencoded，它和GET一样，发送的数据里面，参数和参数之间使用&amp;连接，如：</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">key1=value1&amp;key2=value2</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">特殊字符做转义，这个数据POST是放在请求body里的，而GET是拼在url上面的，如果用jq的话，jq会帮你拼并做转义。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">而上传文件用的这种multipart/form-data，参数和参数之间是且一个相同的字符串隔开的，上面的是使用：</p><blockquote class="blockquote" style="margin-top: 10px;margin-bottom: 10px;border-width: 0px 0px 0px 2px;border-left-color: rgb(18, 122, 230);padding-top: 10px;padding-right: 10px;padding-bottom: 10px;background-color: rgb(239, 239, 239);font-size: 14px;color: rgb(51, 51, 51);"><p style="border: 0px;line-height: 1.5;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;text-overflow: ellipsis;overflow: hidden;">------WebKitFormBoundary72yvM25iSPYZ4a3F</p></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">这个字符通常会取得比较长、比较随机，因为要保证正常的内容里面不会出现这个字符串，这样内容的特殊字符就不用做转义了。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">请求的contentType被浏览器设置成：</p><blockquote class="blockquote" style="margin-top: 10px;margin-bottom: 10px;border-width: 0px 0px 0px 2px;border-left-color: rgb(18, 122, 230);padding-top: 10px;padding-right: 10px;padding-bottom: 10px;background-color: rgb(239, 239, 239);font-size: 14px;color: rgb(51, 51, 51);"><p style="border: 0px;line-height: 1.5;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;text-overflow: ellipsis;overflow: hidden;">Content-Type:</p><p style="margin-top: 10px;border: 0px;line-height: 1.5;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;text-overflow: ellipsis;overflow: hidden;">multipart/form-data; boundary=----WebKitFormBoundary72yvM25iSPYZ4a3F</p></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">后端服务通过这个就知道怎么解析这么一段数据了。（通常是使用的框架处理了，而具体的接口不需要关心应该怎么解析）</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">如果读取结果是ArrayBuffer的话，也是可以直接用xhr.send发送出去的，但是一般我们不会直接把一个文件的内容发出去，而是用某个字段名等于文件内容的方式。如果你读取为ArrayBuffer的话再上传的话其实作用不是很大，还不如直接用formData添加一个File对象的内容，因为上面三种方式都可以拿到File对象。如果一开始就是一个ArrayBuffer了，那么可以转成blob然后再append到FormData里面。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">使用比较多的应该是base64，因为前端经常要处理图片，读取为base64之后就可以把它画到一个canvas里面，然后就可以做一些处理，如压缩、裁剪、旋转等。最后再用canvas导出一个base64格式的图片，那怎么上传base64格式的呢？</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">第一种是拼一个表单上传的multipart/form-data的格式，再用xhr.sendAsBinary发出去，如下代码：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;base64Data&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;base64Data<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">replace</span><span class="token punctuation" style="border: 0px;">(</span><span class="token regex" style="border: 0px;color: rgb(253, 151, 31);">/^data:image\/[^;]+;base64,/</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">""</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;boundary&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"----------boundaryasoifvlkasldvavoadv"</span><span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">xhr<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">sendAsBinary</span><span class="token punctuation" style="border: 0px;">([</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// name=data</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;boundary<span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'Content-Disposition: form-data; name="data"; filename="'</span>&nbsp;<span class="token operator" style="border: 0px;">+</span>&nbsp;fileName&nbsp;<span class="token operator" style="border: 0px;">+</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'"'</span><span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'Content-Type: '</span>&nbsp;<span class="token operator" style="border: 0px;">+</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"image/"</span>&nbsp;<span class="token operator" style="border: 0px;">+</span>&nbsp;fileType<span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">''</span><span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">atob</span><span class="token punctuation" style="border: 0px;">(</span>base64Data<span class="token punctuation" style="border: 0px;">),</span>&nbsp;boundary<span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">//name=imageType</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;boundary<span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'Content-Disposition: form-data; name="imageType"'</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">''</span><span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fileType<span class="token punctuation" style="border: 0px;">,</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;boundary&nbsp;<span class="token operator" style="border: 0px;">+</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'--'</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">].</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">join</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">'\r\n'</span><span class="token punctuation" style="border: 0px;">));</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">上面代码使用了window.atob的api，它可以把base64还原成原始内容的字符串表示，如下图所示：</p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz/d8tibSEfhMMrOib5xTV3aMdEJHsbjf0RoAc2icA1nXDn7zKnfX9QQy5RgEJOS6jmVo8sPNicFu5ichTuEysNdLeJrlw/0?wx_fmt=other" style="border: 0px; vertical-align: middle; width: 364px !important; height: 152px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">btoa是把内容转化成base64编码，而atob是把base64还原。在调atob之前，需要把表示内容格式的不属于base64内容的字符串去掉，即上面代码第一行的replace处理。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">这样就和使用formData类似了，但是由于sendAsBinary已经被deprecated了，所以新代码不建议再使用这种方式。那怎么办呢？</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">可以把base64转化成blob，然后再append到一个formData里面，下面的函数（来自<span class="link" style="border: 0px;word-break: break-word;word-wrap: break-word;">b64-to-blob</span>）可以把base64转成blob：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">b64toBlob</span><span class="token punctuation" style="border: 0px;">(</span>b64Data<span class="token punctuation" style="border: 0px;">,</span>&nbsp;contentType<span class="token punctuation" style="border: 0px;">,</span>&nbsp;sliceSize<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;contentType&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;contentType&nbsp;<span class="token operator" style="border: 0px;">||</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">''</span><span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;sliceSize&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;sliceSize&nbsp;<span class="token operator" style="border: 0px;">||</span>&nbsp;<span class="token number" style="border: 0px;color: rgb(174, 129, 255);">512</span><span class="token punctuation" style="border: 0px;">;</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;byteCharacters&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">atob</span><span class="token punctuation" style="border: 0px;">(</span>b64Data<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;byteArrays&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token punctuation" style="border: 0px;">[];</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">for</span>&nbsp;<span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;offset&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">;</span>&nbsp;offset&nbsp;<span class="token operator" style="border: 0px;">&lt;</span>&nbsp;byteCharacters<span class="token punctuation" style="border: 0px;">.</span>length<span class="token punctuation" style="border: 0px;">;</span>&nbsp;offset&nbsp;<span class="token operator" style="border: 0px;">+=</span>&nbsp;sliceSize<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;slice&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;byteCharacters<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">slice</span><span class="token punctuation" style="border: 0px;">(</span>offset<span class="token punctuation" style="border: 0px;">,</span>&nbsp;offset&nbsp;<span class="token operator" style="border: 0px;">+</span>&nbsp;sliceSize<span class="token punctuation" style="border: 0px;">);</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;byteNumbers&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">Array(</span>slice<span class="token punctuation" style="border: 0px;">.</span>length<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">for</span>&nbsp;<span class="token punctuation" style="border: 0px;">(</span><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;i&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token number" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="token punctuation" style="border: 0px;">;</span>&nbsp;i&nbsp;<span class="token operator" style="border: 0px;">&lt;</span>&nbsp;slice<span class="token punctuation" style="border: 0px;">.</span>length<span class="token punctuation" style="border: 0px;">;</span>&nbsp;i<span class="token operator" style="border: 0px;">++)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byteNumbers<span class="token punctuation" style="border: 0px;">[</span>i<span class="token punctuation" style="border: 0px;">]</span>&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;slice<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">charCodeAt</span><span class="token punctuation" style="border: 0px;">(</span>i<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">}</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;byteArray&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">Uint8Array(</span>byteNumbers<span class="token punctuation" style="border: 0px;">);</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byteArrays<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">push</span><span class="token punctuation" style="border: 0px;">(</span>byteArray<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">}</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">var</span>&nbsp;blob&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">Blob(</span>byteArrays<span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span>type<span class="token punctuation" style="border: 0px;">:</span>&nbsp;contentType<span class="token punctuation" style="border: 0px;">});</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">return</span>&nbsp;blob<span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">}</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">然后就可以append到formData里面：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;blob&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token function" style="border: 0px;color: rgb(230, 219, 116);">b64toBlob</span><span class="token punctuation" style="border: 0px;">(</span>b64Data<span class="token punctuation" style="border: 0px;">,</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"image/png"</span><span class="token punctuation" style="border: 0px;">),</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;formData&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="token class-name" style="border: 0px;">FormData();</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">formData<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">append</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"fileContent"</span><span class="token punctuation" style="border: 0px;">,</span>&nbsp;blob<span class="token punctuation" style="border: 0px;">);</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">这样就不用自己去拼一个multipart/form-data的格式数据了。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">上面处理和上传文件的API可以兼容到IE10+，如果要<strong style="border: 0px;">兼容老的浏览器</strong>应该怎么办呢？</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">可以<strong style="border: 0px;">借助一个iframe</strong>，原理是默认的form表单提交会刷新页面，或者跳到target指定的那个url，但是如果把ifrmae的target指向一个iframe，那么刷新的就是iframe，返回结果也会显示在ifame，然后获取这个ifrmae的内容就可得到上传接口返回的结果。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">如下代码：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;iframe&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;document<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">createElement</span><span class="token punctuation" style="border: 0px;">(</span><span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"iframe"</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">iframe<span class="token punctuation" style="border: 0px;">.</span>display&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"none"</span><span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">iframe<span class="token punctuation" style="border: 0px;">.</span>name&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"form-iframe"</span><span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">document<span class="token punctuation" style="border: 0px;">.</span>body<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">appendChild</span><span class="token punctuation" style="border: 0px;">(</span>iframe<span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 改变form的target</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">form<span class="token punctuation" style="border: 0px;">.</span>target&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token string" style="border: 0px;color: rgb(166, 226, 46);">"form-iframe"</span><span class="token punctuation" style="border: 0px;">;</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">iframe<span class="token punctuation" style="border: 0px;">.</span>onload&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="token punctuation" style="border: 0px;">()</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">//获取iframe的内容，即服务返回的数据</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">let</span>&nbsp;responseText&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>contentDocument<span class="token punctuation" style="border: 0px;">.</span>body<span class="token punctuation" style="border: 0px;">.</span>textContent</p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token operator" style="border: 0px;">||</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">this</span><span class="token punctuation" style="border: 0px;">.</span>contentWindow<span class="token punctuation" style="border: 0px;">.</span>document<span class="token punctuation" style="border: 0px;">.</span>body<span class="token punctuation" style="border: 0px;">.</span>textContent<span class="token punctuation" style="border: 0px;">;</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">};</span></p><p class="lbr" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">form<span class="token punctuation" style="border: 0px;">.</span><span class="token function" style="border: 0px;color: rgb(230, 219, 116);">submit</span><span class="token punctuation" style="border: 0px;">();</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">form.submit会触发表单提交，当请求完成（成功或者失败）之后就会触发iframe的onload事件，然后在onload事件获取返回的数据，如果请求失败了的话，iframe里的内容就为空，可以用这个判断请求有没有成功。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">使用iframe没有办法获取<strong style="border: 0px;">上传进度</strong>，使用xhr可以获取当前上传的进度，这个是在XMLHttpRequest 2.0引入的：</p><blockquote class="code-wrap" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="language-js" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">xhr<span class="token punctuation" style="border: 0px;">.</span>upload<span class="token punctuation" style="border: 0px;">.</span>onprogress&nbsp;<span class="token operator" style="border: 0px;">=</span>&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="token punctuation" style="border: 0px;">(</span>event<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token keyword" style="border: 0px;color: rgb(102, 217, 239);">if</span>&nbsp;<span class="token punctuation" style="border: 0px;">(</span>event<span class="token punctuation" style="border: 0px;">.</span>lengthComputable<span class="token punctuation" style="border: 0px;">)</span>&nbsp;<span class="token punctuation" style="border: 0px;">{</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="token comment" spellcheck="true" style="border: 0px;color: slategray;">// 当前上传进度的百分比</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;duringCallback&nbsp;<span class="token punctuation" style="border: 0px;">((</span>event<span class="token punctuation" style="border: 0px;">.</span>loaded&nbsp;<span class="token operator" style="border: 0px;">/</span>&nbsp;event<span class="token punctuation" style="border: 0px;">.</span>total<span class="token punctuation" style="border: 0px;">)*</span><span class="token number" style="border: 0px;color: rgb(174, 129, 255);">100</span><span class="token punctuation" style="border: 0px;">);</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="token punctuation" style="border: 0px;">}</span></p><p class="line" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="token punctuation" style="border: 0px;">};</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">这样就可以做一个真实的loading进度条。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">本文讨论了3种交互方式的读取方式，通过input控件在input.files可以得到File文件对象，通过拖拽的是在drop事件的event.dataTransfer.files里面，而通过粘贴的paste事件在event.clipboardData.files里面，Safari这个怪胎是在编辑器里面插入一个src指向本地的img标签，可以通过发送一个请求加载本地的blob数据，然后再通过FileReader读取，或者直接append到formData里面。得到的File对象就可以直接添加到FormData里面，如果需要先读取base64格式做处理的，那么可以把处理后的base64转化为blob数据再append到formData里面。对于老浏览器，可以使用一个iframe解决表单提交刷新页面或者跳页的问题。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">总之，前端处理和上传本地文件应该差不多就是这些内容了，但是应该还有好多细节没有提及到，读者可通过本文列的方向自行实践。如果有其它的上传方式还请告知。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;"><br></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">奇舞周刊</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">———<span style="max-width: 100%;color: rgb(136, 136, 136);line-height: 25.6px;">————————————</span>———</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">领略前端技术 阅读奇舞周刊</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;"><br style="border: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.5em;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;font-size: 13px;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">长按二维码，关注奇舞周刊</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: normal;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;font-size: 10px;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="border: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">▼</strong></span></p><p class="img-wrap" style="margin: 15px auto;border: 0px;line-height: 25.6px;white-space: normal;word-break: break-word;overflow: hidden;text-align: center;"><img src="http://mmbiz.qpic.cn/mmbiz/d8tibSEfhMMpC84jhdw7cmZFzrDoG5IsHcpRcls0Ahx6PhRMAicM1gc2ZmG68Tb8t3cyaia5lFicoY8kWXWibCb609A/640?wx_fmt=jpeg" style="border: 0px; vertical-align: middle; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 200px !important; height: 200px !important;"></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512890585&src=3&ver=1&signature=nJHJ*lkpUmWR2w6oU7bDOsSS-8Q91g9q3gppAf*YzodGa8*kFsjsjxlxjgvUsxhcPuHPudx98CYtGO1llmvZoL6vWN4SHU6btvEIx5aJrKpPHM3eAs*fXI-XkwifZpvHpNf6jpeP0kIpJ9HZy8xSWFTJCvEj0u42AlhwY2NzahU=">微信地址</a> | <a href="https://juejin.im/post/5a193b4bf265da43052e528a">阅读原文</a>
{% endraw  %}

