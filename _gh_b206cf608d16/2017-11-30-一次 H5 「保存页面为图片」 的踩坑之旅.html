---
title: 一次 H5 「保存页面为图片」 的踩坑之旅
author: 丁香园F2E
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512890585&src=3&ver=1&signature=nJHJ*lkpUmWR2w6oU7bDOsSS-8Q91g9q3gppAf*YzodGa8*kFsjsjxlxjgvUsxhcPuHPudx98CYtGO1llmvZoIEpSf5ZX4AHVX-cV-pNfFJZJAKbWdQyFS7zYelZFJNiXuys9EBbNfkzcg7bitenIxw8pRYYTVci2pOZPJdXBcE=
date: '2017-11-29 00:00:00 +0000'

---

{% raw  %}
<p><img src="http://mmbiz.qpic.cn/mmbiz_gif/d8tibSEfhMMrjNKjEmoX7KR4FZKdwlrguCicepySoficvu2OMNxXQT0YbHdMcVtVV4P8ZqsqXBnegtw4VibYxhichMQ/0?wx_fmt=gif" style="border: 0px; vertical-align: middle; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 720px !important; height: 100px !important;"></p><p class="" style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;max-width: 100%;color: rgb(51, 51, 51);"><span style="background-color: rgb(255, 254, 213);">编者按：原文由<span style="background-color: rgb(255, 254, 213);color: rgb(51, 51, 51);">丁香园F2E的顾重喜发表于掘金。经作者授权分享到奇舞周刊。</span></span></p><h2 style="margin-top: 22px;margin-bottom: 12px;border-width: 0px 0px 1px;border-bottom-style: solid;border-bottom-color: rgb(25, 128, 230);font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 20px;color: rgb(25, 128, 230);text-align: center;">1. 需求</h2><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">最近丁香医生的产品大佬又双叒叕搞事情，想要在 H5 中做一个医生邀请提问的功能，可以将医生的二维码名片分享出去，支持移动、PC 和微信。之前的图片是由后端生成的，并且会缓存三天，导致信息更新不及时。由前端来做就能避免这些问题。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">我一听，这好说，不就是个保存图片的功能么，简单看看需求：</p><ul style="" class="list-paddingleft-2"><li><p>完善卡片信息，分享出去时候信息更加立体</p></li><li><p>编辑个人资料入口</p></li><li><p>保存图片入口</p></li><li><p>可解决医生名片缓存时间问题</p></li><li><p>长下面这样 ⬇</p></li></ul><p><br></p><figure class="" style="margin: 15px auto;border: 0px;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz/d8tibSEfhMMrqq0ibQa16TbxuTzqHtZstHG2eWgib6G5W1dHZtEpJHiaxPbia87vLFicbIbl0C2rqwqcGv8Df7Gia5t7w/0?wx_fmt=other" style="border: 0px; vertical-align: middle; width: 326px !important; height: 568px !important; visibility: visible !important;"></figure><p><br></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">分析下来就两点</p><ul style="" class="list-paddingleft-2"><li><p>html展示实时用户信息</p></li><li><p>点击保存将当前页面保存成图片至本地，并且不包含功能按钮</p></li></ul><h2 style="margin-top: 22px;margin-bottom: 12px;border-width: 0px 0px 1px;border-bottom-style: solid;border-bottom-color: rgb(25, 128, 230);font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 20px;color: rgb(25, 128, 230);text-align: center;">2. 方案</h2><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">因为之前已经听说过有个库能将 HTML 转为 canvas，然后又听说 canvas 能转为图片，然后又听说图片能下载....(开发基本靠听说（搜索），这是废话)</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">那我的基本方案就是：<br style="border: 0px;">html -&gt; canvas -&gt; image -&gt; a[download]</p><ol style="" class="list-paddingleft-2"><li><p>html2canvas.js：可将 htmldom 转为 canvas 元素。<span class="" style="border: 0px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">传送门</span></p></li><li><p>canvasAPI：toDataUrl() 可将 canvas 转为 base64 格式</p></li><li><p>创建 a[download] 标签触发 click 事件实现下载</p></li></ol><h2 style="margin-top: 22px;margin-bottom: 12px;border-width: 0px 0px 1px;border-bottom-style: solid;border-bottom-color: rgb(25, 128, 230);font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 20px;color: rgb(25, 128, 230);text-align: center;">3. 采坑表演</h2><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">既然方案定下来了，下面就开始踩坑表演了，👏</p><h3 style="margin-top: 12px;margin-bottom: 8px;border: 0px;font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 20px;color: rgb(51, 51, 51);">3.1. 原理</h3><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">官方是这样介绍的：</p><blockquote class="" style="margin-top: 10px;margin-bottom: 10px;border-width: 0px 0px 0px 2px;border-left-color: rgb(18, 122, 230);padding-top: 10px;padding-right: 10px;padding-bottom: 10px;background-color: rgb(239, 239, 239);font-size: 14px;color: rgb(51, 51, 51);"><p style="border: 0px;line-height: 1.5;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;text-overflow: ellipsis;overflow: hidden;">js将遍历加载页面的 DOM 节点，收集所有元素的信息，然后用这些信息来呈现页面。换句话说，实际上这个库并不是真的对页面进行截图，而是基于从 DOM 读取的元素及属性来一点点的绘制 canvas。 因此，它只能正确地呈现它理解的元素和属性，这意味着有许多 CSS 属性不起作用。</p></blockquote><blockquote class="" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" spellcheck="true" style="border: 0px;color: slategray;">// v0.4.1</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;color: rgb(230, 219, 116);">html2canvas</span><span class="" style="border: 0px;">(</span>element<span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;onrendered<span class="" style="border: 0px;">:</span>&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">function</span><span class="" style="border: 0px;">(</span>canvas<span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 现在你已经拿到了canvas DOM元素</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;">}</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;">}</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" spellcheck="true" style="border: 0px;color: slategray;">// v0.5.0</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;color: rgb(230, 219, 116);">html2canvas</span><span class="" style="border: 0px;">(</span>element<span class="" style="border: 0px;">,</span>&nbsp;options<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">then</span><span class="" style="border: 0px;">(</span>canvas&nbsp;<span class="" style="border: 0px;">=</span><span class="" style="border: 0px;">&gt;</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 现在你已经拿到了canvas DOM元素</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;">}</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">所以基本可以猜到整个工作流程应该是：</p><ol style="" class="list-paddingleft-2"><li><p>递归处理每个节点，记录这个节点应该怎么画。（比如div就画边框和背景，文字就画文字等等）</p></li><li><p>考虑节点的层级问题。比如很多布局相关样式属性： z-index、float、position 等的影响。</p></li><li><p>从低层级开始画到 canvas 上，逐渐向上画。层级高的覆盖层级低的（和浏览器本身的渲染流程很像）。</p></li></ol><h3 style="margin-top: 12px;margin-bottom: 8px;border: 0px;font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 20px;color: rgb(51, 51, 51);">3.2 坑💀</h3><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">目前官方提供的版本有很多，正式版本是<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">v0.4.1 - 7.9.2013</span>，最新版本是<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">v0.5.0-beta4</span>，那对于我们开发来说如果不是玩新特性什么的一般还是会选择正式版，结果第一个坑就掉进去爬了半天。</p><h4 style="margin-top: 8px;margin-bottom: 5px;border: 0px;font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 18px;color: rgb(51, 51, 51);">3.2.1 图片模糊</h4><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">因为开发的时候是用 chrome 模拟器生成 canvas 后没有发现有模糊的地方，但是用 PC 代理手机请求开发资源时,发现画面的模糊感非常明显。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">如图：</p><figure class="" style="margin: 15px auto;border: 0px;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><figcaption style="border: 0px;"></figcaption></figure><p style="text-align: center;"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrqq0ibQa16TbxuTzqHtZstHzeMAAYj0a5YKADR84gj8uxmGRUsxjMaQtwVDSLTEMdZ3oAqjd9T0qw/0?wx_fmt=png" style="width: 328px !important; height: 502px !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">容易想到，可能是移动端像素密度计算的问题。</p><blockquote class="" style="margin-top: 10px;margin-bottom: 10px;border-width: 0px 0px 0px 2px;border-left-color: rgb(18, 122, 230);padding-top: 10px;padding-right: 10px;padding-bottom: 10px;background-color: rgb(239, 239, 239);font-size: 14px;color: rgb(51, 51, 51);"><p style="border: 0px;line-height: 1.5;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;text-overflow: ellipsis;overflow: hidden;">设备像素比 (简称 dpr) 定义了物理像素和设备独立像素的对应关系，它的值可以按如下的公式的得到：</p></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);"><span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">设备像素比 = 物理像素 / 设备独立像素 // 在某一方向上，x方向或者y方向</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">知道了这个也没用，因为文档中根本没有给出能够配置像素比的地方。。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">然而通过研究发现，官方文档其实还是 <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">0.4.1</span> 的，从 <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">0.5.0</span> 版本开始，其实已经偷偷摸摸支持自定义 canvas 作为配置项传入了，它会根据我们传入的 canvas 为基础开始绘制。所以我们在调用 html2canvas 的时候，可以先创建好一个尺寸合适的 canvas，再传进去。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">话不多说，首先将库升级到 <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">0.5.0</span>，然后：</p><blockquote class="" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" spellcheck="true" style="border: 0px;color: slategray;">/**</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;* 根据window.devicePixelRatio获取像素比</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;*/</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">DPR</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">if</span>&nbsp;<span class="" style="border: 0px;">(</span>window<span class="" style="border: 0px;">.</span>devicePixelRatio&nbsp;<span class="" style="border: 0px;">&amp;&amp;</span>&nbsp;window<span class="" style="border: 0px;">.</span>devicePixelRatio&nbsp;<span class="" style="border: 0px;">&gt;</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">1</span><span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">return</span>&nbsp;window<span class="" style="border: 0px;">.</span>devicePixelRatio<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;">}</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">return</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">1</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;">}</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" spellcheck="true" style="border: 0px;color: slategray;">/**</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;* 将传入值转为整数</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;*/</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">parseValue</span><span class="" style="border: 0px;">(</span>value<span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">return</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">parseInt</span><span class="" style="border: 0px;">(</span>value<span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">10</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;">}</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" spellcheck="true" style="border: 0px;color: slategray;">/**</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;* 绘制canvas</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;*/</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;color: rgb(102, 217, 239);">async</span>&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">function</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">drawCanvas</span><span class="" style="border: 0px;">(</span>selector<span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 获取想要转换的 DOM 节点</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;dom&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;document<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">querySelector</span><span class="" style="border: 0px;">(</span>selector<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;box&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;window<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">getComputedStyle</span><span class="" style="border: 0px;">(</span>dom<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// DOM 节点计算后宽高</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;width&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">parseValue</span><span class="" style="border: 0px;">(</span>box<span class="" style="border: 0px;">.</span>width<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;height&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">parseValue</span><span class="" style="border: 0px;">(</span>box<span class="" style="border: 0px;">.</span>height<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 获取像素比</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;scaleBy&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">DPR</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 创建自定义 canvas 元素</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;canvas&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;document<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">createElement</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'canvas'</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 设定 canvas 元素属性宽高为 DOM 节点宽高 * 像素比</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;canvas<span class="" style="border: 0px;">.</span>width&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;width&nbsp;<span class="" style="border: 0px;">*</span>&nbsp;scaleBy<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;canvas<span class="" style="border: 0px;">.</span>height&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;height&nbsp;<span class="" style="border: 0px;">*</span>&nbsp;scaleBy<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 设定 canvas css宽高为 DOM 节点宽高</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;canvas<span class="" style="border: 0px;">.</span>style<span class="" style="border: 0px;">.</span>width&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;<span class="" style="border: 0px;"><span class="" style="border: 0px;color: rgb(166, 226, 46);">`</span><span class="" style="border: 0px;"><span class="" style="border: 0px;">${</span>width<span class="" style="border: 0px;">}</span></span><span class="" style="border: 0px;color: rgb(166, 226, 46);">px`</span></span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;canvas<span class="" style="border: 0px;">.</span>style<span class="" style="border: 0px;">.</span>height&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;<span class="" style="border: 0px;"><span class="" style="border: 0px;color: rgb(166, 226, 46);">`</span><span class="" style="border: 0px;"><span class="" style="border: 0px;">${</span>height<span class="" style="border: 0px;">}</span></span><span class="" style="border: 0px;color: rgb(166, 226, 46);">px`</span></span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 获取画笔</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;context&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;canvas<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">getContext</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'2d'</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 将所有绘制内容放大像素比倍</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;context<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">scale</span><span class="" style="border: 0px;">(</span>scaleBy<span class="" style="border: 0px;">,</span>&nbsp;scaleBy<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 将自定义 canvas 作为配置项传入，开始绘制</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">return</span>&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">await</span>&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">html2canvas</span><span class="" style="border: 0px;">(</span>dom<span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;">{</span>canvas<span class="" style="border: 0px;">}</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;">}</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">以上代码先获取设备像素比，并根据比例创建尺寸更大的 canvas。如二倍屏就是二倍，三倍屏就是三倍，八倍镜就是八倍···<br style="border: 0px;">手机端截图，和html展示效果一致，基本看不出来差别。（编者注：微信压缩配图，请阅读原文查看效果）</p><figure class="" style="margin: 15px auto;border: 0px;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz_png/d8tibSEfhMMrqq0ibQa16TbxuTzqHtZstHtvYXfomGzUTw6ZC7L7Wl3nYubiant0R4fRlF5iaCaGan4q4NwhXdibUvg/0?wx_fmt=png" style="width: 312px !important; height: 466px !important;"></figure><p><br></p><h4 style="margin-top: 8px;margin-bottom: 5px;border: 0px;font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 18px;color: rgb(51, 51, 51);">3.2.2 图片画出来怎么不见了</h4><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">PC端截图：</p><p><br></p><figure class="" style="margin: 15px auto;border: 0px;overflow: hidden;text-align: center;color: rgb(51, 51, 51);"><img src="http://mmbiz.qpic.cn/mmbiz/d8tibSEfhMMrqq0ibQa16TbxuTzqHtZstHk89iaNwLXgKaaztu0DrVGPd2frZTe1jGe2JHt9LAWmt7xqFicny3icnWQ/0?wx_fmt=other" style="border: 0px; vertical-align: middle; width: 309px !important; height: 437px !important;"><figcaption style="border: 0px;"><br></figcaption></figure><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">可能有多种原因，排查后发现是因为 canvas 内的图片跨域了 <span class="" style="border: 0px;word-break: break-word;word-wrap: break-word;">这里有解释</span><br style="border: 0px;">总而言之，就是：可以在 canvas 中绘制跨域的图片，但此时的 canvas 处于被 「污染」 的状态，而污染状态的 canvas 使用 toDataUrl() 等 API 是会出现问题的。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">所以，现在我们需要做两件事：</p><ol style="" class="list-paddingleft-2"><li><p>给 img 元素设置&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">crossOrigin</span>&nbsp;属性，值为&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">anonymous</span></p></li><li><p>图片服务端设置允许跨域（返回 CORS 头）</p></li></ol><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">第一件事好办，因为 html2canvas 本身支持配置<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">useCORS: true</span>；</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">但是第二件事就要分情况。当图片放在自己服务器时，仅仅是让后端小哥改个配置的事儿。但是当图片放在 CDN 上时······嗯， 为了更快的响应，很多 CDN 会缓存图片的返回值，而缓存的值是不带 CORS 头的。因为没有 CORS 头，所以 js 请求会被拦截。这个时候，我们可以使用服务器转发，在转发时带上 CORS 头。（前端撸一个 node 中间层来进行服务器转发是个很好的方案，这个下回再单独说）</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">OK。使用以上方案，我们测试一下。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">PC 端打开，完美。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">微信端，咦，还是不行。<br style="border: 0px;">后期发现，使用 html2canvas <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">0.5.0</span> 版本是没有问题的，但是开发时使用 <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">0.4.1</span> 绘制 canvas 还是会导致图片丢失。猜测是因为 html2canvas 在预载图片和绘制图片时多了什么不可描述的东西。为了解决这个问题，我们使用了一个非常暴力的解决方案：用 js 去获取图片，获得其 base64，放回 img 的 src 中再进行绘制。</p><blockquote class="" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" spellcheck="true" style="border: 0px;color: slategray;">/**</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;* 图片转base64格式</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;*/</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;color: rgb(230, 219, 116);">img2base64</span><span class="" style="border: 0px;">(</span>url<span class="" style="border: 0px;">,</span>&nbsp;crossOrigin<span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">return</span>&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="" style="border: 0px;">Promise</span><span class="" style="border: 0px;">(</span>resolve&nbsp;<span class="" style="border: 0px;">=</span><span class="" style="border: 0px;">&gt;</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;img&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">new</span>&nbsp;<span class="" style="border: 0px;">Image</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img<span class="" style="border: 0px;">.</span>onload&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;<span class="" style="border: 0px;">(</span><span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">=</span><span class="" style="border: 0px;">&gt;</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;c&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;document<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">createElement</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'canvas'</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span class="" style="border: 0px;">.</span>width&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;img<span class="" style="border: 0px;">.</span>naturalWidth<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c<span class="" style="border: 0px;">.</span>height&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;img<span class="" style="border: 0px;">.</span>naturalHeight<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;cxt&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;c<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">getContext</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'2d'</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cxt<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">drawImage</span><span class="" style="border: 0px;">(</span>img<span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" spellcheck="true" style="border: 0px;color: slategray;">// 得到图片的base64编码数据</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(230, 219, 116);">resolve</span><span class="" style="border: 0px;">(</span>c<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">toDataURL</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'image/png'</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;">}</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crossOrigin&nbsp;<span class="" style="border: 0px;">&amp;&amp;</span>&nbsp;img<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">setAttribute</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'crossOrigin'</span><span class="" style="border: 0px;">,</span>&nbsp;crossOrigin<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;img<span class="" style="border: 0px;">.</span>src&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;url<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;">}</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;">}</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">这个坑总算是磕磕碰碰趟过去了。</p><h4 style="margin-top: 8px;margin-bottom: 5px;border: 0px;font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 18px;color: rgb(51, 51, 51);">3.2.3 倒角</h4><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);"><span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">border-radius</span> 必须 ≤ 短边长度的一半，并且是具体数值，否则可能会出现奇妙的效果。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">另外使用伪元素实现 0.5px 边框也可能会出现奇妙效果，建议直接使用 <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">border</span> 属性</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);"><span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">0.4.1</span> 版本中需要做圆形图片只能置为背景图，img 不支持绘制 border-radius，<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">0.5.0</span> 中则无此限制</p><h4 style="margin-top: 8px;margin-bottom: 5px;border: 0px;font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 18px;color: rgb(51, 51, 51);">3.2.4 虚线</h4><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">前面说的， html2canvas 并不支持所有 css 属性。使用 <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">border-style: dashed/dotted</span> 无效，还是大实线。切图在 PC 端有效，但是在微信中，尝试使用切图渲染虚线时有可能还会报 <span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;word-break: break-word;word-wrap: break-word;">SecurityError, The operation is insecure.</span> 错误，导致转 base64 失败</p><h3 style="margin-top: 12px;margin-bottom: 8px;border: 0px;font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 20px;color: rgb(51, 51, 51);">3.3 保存</h3><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">理想：</p><blockquote class="" style="border: 0px;padding-left: 0px;color: rgb(51, 51, 51);"><pre class="" style="border: 0px;padding: 1em;overflow: auto;background-color: rgb(39, 40, 34);color: rgb(248, 248, 242);"><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" spellcheck="true" style="border: 0px;color: slategray;">/**</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;* 在本地进行文件保存</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;* @param {String} data 要保存到本地的图片数据</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;* @param {String} filename 文件名</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;*/</p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;color: rgb(230, 219, 116);">saveFile</span><span class="" style="border: 0px;">(</span>data<span class="" style="border: 0px;">,</span>&nbsp;filename<span class="" style="border: 0px;">)</span>&nbsp;<span class="" style="border: 0px;">{</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;save_link&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;document<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">createElementNS</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'http://www.w3.org/1999/xhtml'</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(166, 226, 46);">'a'</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;save_link<span class="" style="border: 0px;">.</span>href&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;data<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;save_link<span class="" style="border: 0px;">.</span>download&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;filename<span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 0;word-break: break-word;word-wrap: break-word;font-size: 14px;height: 6px;white-space: nowrap !important;"><br style="border: 0px;"></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">const</span>&nbsp;event&nbsp;<span class="" style="border: 0px;">=</span>&nbsp;document<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">createEvent</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'MouseEvents'</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;event<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">initMouseEvent</span><span class="" style="border: 0px;">(</span><span class="" style="border: 0px;color: rgb(166, 226, 46);">'click'</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">true</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">false</span><span class="" style="border: 0px;">,</span>&nbsp;window<span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">false</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">false</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">false</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">false</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(174, 129, 255);">0</span><span class="" style="border: 0px;">,</span>&nbsp;<span class="" style="border: 0px;color: rgb(102, 217, 239);">null</span><span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;">&nbsp;&nbsp;&nbsp;&nbsp;save_link<span class="" style="border: 0px;">.</span><span class="" style="border: 0px;color: rgb(230, 219, 116);">dispatchEvent</span><span class="" style="border: 0px;">(</span>event<span class="" style="border: 0px;">)</span><span class="" style="border: 0px;">;</span></p><p class="" style="margin-top: 3px;margin-bottom: 3px;border: 0px;line-height: 16px;word-break: break-word;word-wrap: break-word;font-size: 14px;white-space: nowrap !important;"><span class="" style="border: 0px;">}</span></p></pre></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">现实：</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">PC端： 完美。<strong style="border: 0px;">微信大佬</strong>：不好意思，你说什么？我听不见？！</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">好嘛，微信中根本没有任何反应。查看 <span class="" style="border: 0px;word-break: break-word;word-wrap: break-word;">微信sdk</span> 后发现：</p><ul style="" class="list-paddingleft-2"><li><p><span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">downloadImage</span>&nbsp;仅支持&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">uploadImage</span>&nbsp;接口上传的图片。</p></li><li><p><span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">uploadImage</span>&nbsp;接口仅支持&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">chooseImage</span>&nbsp;接口相册选择的图片。</p></li><li><p><span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">chooseImage</span>&nbsp;接口是从本地相册选择图片。</p></li><li><p>那么问题来了，图片都在相册了还需要我们干啥？</p></li><li><p>....</p></li></ul><h2 style="margin-top: 22px;margin-bottom: 12px;border-width: 0px 0px 1px;border-bottom-style: solid;border-bottom-color: rgb(25, 128, 230);font-weight: bold;word-break: break-all;word-wrap: break-word;font-size: 20px;color: rgb(25, 128, 230);text-align: center;">4. (在痛苦和妥协中) 交付</h2><p style="margin-top: 8px;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">最终实现的方案是：</p><ul style="" class="list-paddingleft-2"><li><p>用户进入该页面</p></li><li><p>获取当前用户所有信息，头像，二维码等</p></li><li><p>将所有图片转为 base64</p></li><li><p>渲染&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">html</span></p></li><li><p>绘制&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">canvas</span></p></li><li><p>将 canvas 保存为 base64</p></li><li><p>替换&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">html</span>&nbsp;为&nbsp;<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">img</span>，<span class="" style="margin-right: 2px;margin-left: 2px;border: 1px solid rgb(225, 225, 232);padding: 2px 4px;font-size: 14px;font-family: monospace;color: rgb(221, 17, 68);background-color: rgb(247, 247, 249);border-top-left-radius: 2px;border-top-right-radius: 2px;border-bottom-right-radius: 2px;border-bottom-left-radius: 2px;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;">src</span>为 base64</p></li><li><p>完成页面到图片的转换，微信中用户可长按页面调起 actionSheet 识别或保存图片</p></li></ul><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">也就是说，用户刚进入页面时，显示的是 html。js 执行完后，将原有 html 删掉，替换为图片。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">再回头看我们的需求：</p><blockquote class="" style="margin-top: 10px;margin-bottom: 10px;border-width: 0px 0px 0px 2px;border-left-color: rgb(18, 122, 230);padding-top: 10px;padding-right: 10px;padding-bottom: 10px;background-color: rgb(239, 239, 239);font-size: 14px;color: rgb(51, 51, 51);"><ul class="list-paddingleft-2"><li><p>html 展示实时用户信息</p></li><li><p>点击保存将当前页面保存成图片至本地</p></li></ul></blockquote><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">其实最终只实现了第一点，而第二点其实是实现了一半，图片虽然生成了，但保存功能还是需要用户长按图片，调起微信内置菜单来完成。在进行 H5 开发时，一旦考虑到微信，就有可能出现一些之前考虑不到的问题和限制，对此，产品经理和程序员都要尽可能地多多了解。知道在微信中，能干什么，不能干什么，降低开发和反复沟通的成本。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">希望以上内容能够对大家以后的开发有所帮助。</p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.7;white-space: pre-wrap;word-break: break-word;word-wrap: break-word;color: rgb(51, 51, 51);">（点击下方“阅读原文”即可查看原文链接）<br></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;"><span style="border: 0px;max-width: 100%;line-height: 1.6;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="border: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;"><span style="border: 0px;max-width: 100%;line-height: 1.6;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;"></span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">奇舞周刊</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">———<span style="border: 0px;max-width: 100%;color: rgb(136, 136, 136);line-height: 25.6px;box-sizing: border-box !important;word-wrap: break-word !important;">————————————</span>———</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">领略前端技术 阅读奇舞周刊</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 25.6px;white-space: pre-wrap;word-break: break-word;"><br style="border: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: 1.5em;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;font-size: 13px;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;">长按二维码，关注奇舞周刊</span></p><p style="margin-top: 1em;margin-bottom: 1em;border: 0px;line-height: normal;white-space: pre-wrap;word-break: break-word;text-align: center;"><span style="border: 0px;max-width: 100%;font-size: 10px;color: rgb(68, 68, 68);box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="border: 0px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">▼</strong></span></p><p class="" style="margin: 15px auto;border: 0px;line-height: 25.6px;white-space: normal;word-break: break-word;overflow: hidden;text-align: center;"><img src="http://mmbiz.qpic.cn/mmbiz/d8tibSEfhMMpC84jhdw7cmZFzrDoG5IsHcpRcls0Ahx6PhRMAicM1gc2ZmG68Tb8t3cyaia5lFicoY8kWXWibCb609A/640?wx_fmt=jpeg" style="border: 0px; vertical-align: middle; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 200px !important; height: 200px !important;"></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512890585&src=3&ver=1&signature=nJHJ*lkpUmWR2w6oU7bDOsSS-8Q91g9q3gppAf*YzodGa8*kFsjsjxlxjgvUsxhcPuHPudx98CYtGO1llmvZoIEpSf5ZX4AHVX-cV-pNfFJZJAKbWdQyFS7zYelZFJNiXuys9EBbNfkzcg7bitenIxw8pRYYTVci2pOZPJdXBcE=">微信地址</a> | <a href="https://juejin.im/post/5a17c5e26fb9a04527254689">阅读原文</a>
{% endraw  %}

