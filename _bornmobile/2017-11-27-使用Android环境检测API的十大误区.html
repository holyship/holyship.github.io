---
title: 使用Android环境检测API的十大误区
author: 大愚若智 译
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512889070&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKBS-dfm53e69UIAI7OFZCkuYfVmPeeq9rBeacTsaEtwx0jMr*eJ24ixB3jT9*4pUUOxq8O8B3ry5NsX78GjM1HwuWdUyFWjgYvoloontF*ZxktYqIN8WhJh2xUVB1O-XBqaUjGebHV43y5e-NkgsYxc=
date: '2017-11-27 00:00:00 +0000'

---

{% raw  %}
<section class="h1" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1em;color: rgb(145, 145, 145);margin-top: 13px;font-size: 14px;white-space: normal;background-color: rgb(255, 255, 255);padding-left: 14px;">作者｜Oscar Rodriguez</section><section class="h1" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1em;color: rgb(145, 145, 145);margin-top: 13px;font-size: 14px;white-space: normal;background-color: rgb(255, 255, 255);padding-left: 14px;">译者｜大愚若智</section><section class="h1" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1em;color: rgb(145, 145, 145);margin-top: 13px;font-size: 14px;white-space: normal;background-color: rgb(255, 255, 255);padding-left: 14px;">编辑｜覃云</section><section class="preface" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;white-space: normal;font-size: 15px;text-align: justify;line-height: 27px;color: rgb(89, 89, 89);background-color: rgb(239, 239, 239);padding: 19px;margin-top: 40px;margin-right: 8px;margin-left: 8px;">本文介绍了 Android 开发者在自己的应用中使用 SafetyNet Attestation API 验证设备完整性过程中需要注意的十大问题。</section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">SafetyNet Attestation API 可以帮助我们评估运行应用的 Android 环境的安全性与兼容性。自从 2015 年 3 月发布后，很多开发者已经将其成功集成在自己的 Android 应用中，进而根据运行自己应用的设备完整性和兼容性做出更多合理的决策。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">几年来，SafetyNet Attestation API 也在不断完善，使用率稳步增长。然而与任何安全 / 反滥用相关的 API 一样，围绕 SafetyNet 有很多常见误区会导致开发者开发的系统不够稳定，甚至产生虚假的安全感。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">本文将介绍开发者在给自己的应用集成 SafetyNet Attestation API 时最常见的十大误区。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">1. 未获取 API key</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">与 Google 的其他很多 API 类似，SafetyNet Attestation API 需要具备 API key 才能正常使用。此外 SafetyNet Attestation API 每个 Key 还有用量限制。虽然这个限制可以增加，但为了提交申请同样需要具备 API key。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">API Key 的申请过程很简单，完全免费，没理由不申请 API key。如果尚未申请，可以 在这里获取 API key。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">2. 未使用最新版 API</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">SafetyNet Attestation API 的进化和完善从未停止，并且这个过程中某些接口还产生过变化。最近随着 Google Play 服务 11.0.0 版的发布，我们彻底改造了整套 SafetyNet API，提供了更易于理解和使用的接口：这套全新 API 使用 SafetyNetClient 取代了 SafetyNetApi，后者已被停用，因此请务必更新你的实现，使用该 API 的最新版本。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">大部分设备应该已经安装了最新版 Google Play 服务，但如果设备没有安装 Google Play 服务，或没有使用最新版本，此时使用 SafetyNet Attestation API 可能导致应用无法响应或崩溃。为了防止出现这种问题，可以在使用该 API 之前 检查已安装的 Google Play 服务版本。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">3. 错误地使用随机数</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">SafetyNet Attestation API 可以让开发者设置一个随机数（Nonce）体现每次 API 调用时的全局唯一性。通过这个功能可以防止恶意用户重复使用已经成功认证的结果取代未成功认证的结果（这也叫做 重播攻击（Replay Attack））。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">创建随机数的好办法之一 是在服务器上使用密码学上足够安全的随机函数创建一个足够大（16 字节甚至更长）的随机数字。SafetyNet 的认证响应结果中可以包含你设置的随机数，因此请确保验证返回的随机数与发出的请求中包含的随机数相匹配。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">4. 未在你自己的服务器上检查结果</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">SafetyNet 可以针对运行应用的设备状态提供有用的信息，然而如果针对这些信息做出反应的逻辑只在设备本地直接实现，攻击者就可以修改你的应用并绕过你执行的任何检查。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">为了防止这种情况，应当在自己能够控制并信任的服务器上运行这些逻辑，借此对认证结果进行验证并根据结果强制执行所需的操作。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">5. 在生产环境中使用测试专用的认证验证服务</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">为了简化 SafetyNet Attestation API 的开发和测试，Google 提供了一个 在线验证服务，该服务可以使用简单的 HTTPS 请求检查 SafetyNet 验证结果的数字签名。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">但是按照设计，这个服务仅是面向测试用途，具备非常严格的用量限额，并且无法通过申请增大。因此你应该在自己服务器上实现一套不依赖 Google 服务器的数字签名验证逻辑。大部分 JWT 库提供了签名验证函数，我们也提供了 代码示例，向大家展示如何通过 Java 和 C# 进行验证。我们还计划在未来提供面向更多语言的示例。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">6. 未检查随机数、时间戳、APK 名称和哈希</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="color: rgb(255, 41, 65);">SafetyNet Attestation</span> API 以完整性和兼容性检查而著称，该 API 可通过<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">ctsProfileMatch</span></code>和<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">basicIntegrity</span></code>返回检查结果。虽然这两个值确实非常有用，但你还应当检查回应中包含的其他值，其中也包含了很多重要信息。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">例如可以按照上文介绍的那样使用<code style="box-sizing: border-box;">nonce</code>将回应与请求相匹配，并可使用<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">timestampMs</span></code>检查发出请求到收到<code style="box-sizing: border-box;">回应之间经</code>过了多长时间。如果在发出请求后，延误了数小时甚至数天才收到回应，那么这种情况就非常可疑了。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">你还可以使用<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">apkPackageName</span></code>检查发出认证请求的 APK 名称，并将<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">apkDigestSha256</span></code>和<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">apkCertificateDigestSha256</span></code>与你的应用在 Google Play 中的签名 APK 相匹配，借此判断已安装应用的完整性。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">另外要注意回应信息整体的可信与否取决于<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">ctsProfileMatch</span></code>和<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">basicIntegrity</span></code>的结果。对于一个<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">basicIntegrity</span></code>检查失败的被攻陷设备，想伪造回应中的其他值并不是什么难事。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span><span style="box-sizing: border-box;">7. 未能理解<code style="box-sizing: border-box;">ctsProfileMatch</code>和<code style="box-sizing: border-box;">basicIntegrity</code>的差异</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">SafetyNet Attestation API 最初只提供了一个名叫<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">basicIntegrity</span></code>的值，借此帮助开发者判断设备的完整性。随着该 API 的逐渐完善，我们新增了一种更严格的检查，其结果会包含在名为<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">ctsProfileMatch</span></code>的值中，这个值可以帮助开发者更细致地评估运行应用的设备。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">大体上来说，<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">basicIntegrity</span></code>可以告诉你设备及其 API 的常规完整性情况。已 Root 的设备、模拟器、虚拟设备，以及有篡改迹象（例如使用 API 钩子）的设备<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">basicIntegrity</span></code>检查会失败。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">另一方面，<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">ctsProfileMatch</span></code>可以帮你更严谨地判断设备的兼容性。只有被 Google 认证且未经修改的设备可以成功通过<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">ctsProfileMatch</span></code>检查。如果设备存在下列情况，将无法成功通过<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">ctsProfileMatch</span></code>检查：</p><ul style="" class=" list-paddingleft-2"><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">设备的<code style="box-sizing: border-box;"><span style="color: rgb(255, 41, 65);">basicIntegrity</span></code>检查失败</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">设备的 <span style="color: rgb(255, 41, 65);">BootLoader </span>已解锁</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">设备使用了自定义系统镜像（自制 ROM）</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">设备制造商未申请或未通过 Google 认证</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">设备的系统镜像直接使用 Android Open Source Program 源文件构建</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">设备系统镜像以 Beta 测试或开发者预览项目（包括 Android Beta Program）方式发布</p></li></ul><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">8. 未实施验证时间检查策略</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">SafetyNet Attestation API 可以针对设备发起验证请求那一刻的状态提供快照。成功的验证结果并不一定意味着设备也曾在过去成功通过了验证，或未来能够继续成功通过验证。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">由于这种验证是一种时间点检查，因此你应该规划出适当的策略，决定需要在什么时候发起验证请求。例如可以要求用户进行应用内购买之前必须成功通过验证，在上一次成功验证若干天后重新进行验证，每次启动应用时进行验证，每次重启动之后验证，或按照任何其他针对你的应用来说有必要的时候进行验证。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">但是也要注意，验证请求会产生很大的运算量，会耗费设备的电池和带宽，并且会占用你的配额。建议制定合理计划，以最少数量的验证检查满足应用的具体要求。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">9. 使用 SafetyNet Attestation API 结果作为预防滥用的唯一指标</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">很多人会想当然地认为 SafetyNet Attestation API 足以帮助自己获得保护设备防范滥用所需的全部机制，并且会只使用这套 API 来构建自己的反滥用系统。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">SafetyNet Attestation API 只能帮你了解设备状态，无法帮你了解用户意图，而用户意图需要通过反滥用系统检测才能获知。因此你应该同时考虑其他机制，例如访问日志和行为模式，借此更精确地检测用户滥用情况，绝不应该仅因为该 API 验证失败就屏蔽用户。此外还有很多其他因素会导致验证失败，例如网络连接问题、配额问题以及传输问题。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">换句话说，并非所有未能通过验证的用户都是滥用的用户，也并非所有滥用的用户一定会验证失败。如果仅凭验证结果屏蔽用户，可能会漏掉验证成功的滥用用户，此外也有可能因此而错误地屏蔽了由于非滥用的其他因素导致未能成功通过验证的合法、忠实用户。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">10. 未积极监视并管理你的用量配额</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">正如上文所述，SafetyNet Attestation API 的服务速率有一定限制，默认情况下每个 API key 每天有 10,000 个请求的配额上限。虽然这个配额对大部分开发、测试和新发布的应用来说已经足够了，但随着用户数的增加，你的应用可能很快就会用到配额上限。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">为了防止无意间达到配额限制导致验证出错，应该构建一套监视 API 用量的系统，并在即将达到配额上限后发出警告，以便随时申请提升配额。此外也应该针对由于达到配额限制而导致的验证失败做好相应准备，避免在这种情况下屏蔽用户。</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">如果即将达到配额上限，或者可能因为短期峰值导致超出配额上限，你可以 提交这个表单 申请短期或长期提升 API key 的配额。提升过程以及提升后的配合同样是免费的。</p><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">原文链接</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;"><span style="color: rgb(120, 172, 254);">https://android-developers.googleblog.com/2017/11/10-things-you-might-be-doing-wrong-when.html</span></p><section class="h4" style="margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);background-color: rgb(255, 255, 255);"><span style="margin-right: 10px;box-sizing: border-box;display: inline-block;width: 15px;height: 15px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobI1MiaUeOMYzg2iahCbOgEgm4VWHrXGfvpSX7goSzO7GdZo12gKkrjZ2mTwQCAPRYWKh6bJnicr0Sjw/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">移动开发前线</span></section><p style="padding-top: 23px;padding-right: 8px;padding-left: 8px;font-size: 16px;box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;"><strong>「移动开发前线</strong>」是 InfoQ 旗下关注移动开发技术的垂直社群。投稿请发邮件到 editors@cn.infoq.com，注明“移动开发前线投稿”。</p><section class="ad" style="white-space: normal;box-sizing: border-box;color: rgb(63, 63, 63);font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;font-size: 14px;background-color: rgb(255, 255, 255);width: 429.5px;text-align: center;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/ibnDKD3ktAobI1MiaUeOMYzg2iahCbOgEgm0NfxUHdjxSq0EP2DxpJkoQEgGCcNiaqrTib6ccdv7bPDQEFOQf8icRibiaA/0?wx_fmt=jpeg" style="margin-top: 28px; margin-right: auto; margin-left: auto; padding-right: 8px; padding-left: 8px; box-sizing: border-box; border-width: 0px; border-style: initial; border-color: initial; vertical-align: middle; width: 429.5px !important; height: 229.493px !important;"></section><section class="h4" style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;line-height: 1.1;color: rgb(60, 112, 198);margin-top: 30px;margin-left: 8px;font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);"><span style="box-sizing: border-box;display: inline-block;width: 15px;height: 15px;margin-right: 10px;background: url(&quot;http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftxzx9MNQ66KY57IGRicqKr9ck9OVkja72y6AdAKUTbpPV3uc0VJb2XJQ/0?wx_fmt=png&quot;) center center / 100% 100% no-repeat;"></span>&nbsp;<span style="box-sizing: border-box;">新时代的移动开发</span></section><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;">12 月 8-11 日，ArchSummit 全球架构师峰会即将于北京举行，大会邀请了 ECMAScript 标准委员会 /W3C 成员 Alex Russell 等诸多资深技术人前来分享，部分案例如下：</p><ul style="" class=" list-paddingleft-2"><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">阿里菜鸟技术团队全栈化之路：开发全栈前端</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">阿里 UC 浏览器容器化架构</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">饿了么移动性能可视化建设</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">滴滴国际化、跨地域 iOS 构建优化与持续集成</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">美团客户端架构演进</p></li><li><p style="box-sizing: border-box;font-size: 16px;text-align: justify;white-space: pre-line;color: rgb(74, 74, 74);line-height: 1.75em;">京东金融移动端多业务集成解决方案</p></li></ul><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;"><strong style="box-sizing: border-box;text-align: left;">大会将在下周五开幕</strong>，完整演讲目录可识别下方二维码或点击 <strong style="box-sizing: border-box;text-align: left;">阅读原文</strong> 进一步了解！</p><p style="box-sizing: border-box;font-family: Avenir, -apple-system-font, 微软雅黑, sans-serif;background-color: rgb(255, 255, 255);font-size: 16px;text-align: justify;white-space: pre-line;padding-top: 23px;padding-right: 8px;padding-left: 8px;color: rgb(74, 74, 74);line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/ibnDKD3ktAobib96V8gDQkC5VXACZTx1ftTeoDGqXbIgSicoGxwwuaiaKqWO8k4Ta26Nia2X0uA0mDOFhaSbZG5jUgA/0?wx_fmt=png" style="box-sizing: border-box; border-width: 0px; border-style: initial; border-color: initial; vertical-align: middle; width: 693px !important; height: 423.5px !important;"><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512889070&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKBS-dfm53e69UIAI7OFZCkuYfVmPeeq9rBeacTsaEtwx0jMr*eJ24ixB3jT9*4pUUOxq8O8B3ry5NsX78GjM1HwuWdUyFWjgYvoloontF*ZxktYqIN8WhJh2xUVB1O-XBqaUjGebHV43y5e-NkgsYxc=">微信地址</a> | <a href="http://bj2017.archsummit.com/track?utm_source=wechat&amp;utm_medium=mobile&amp;utm_campaign=last10text&amp;utm_term=1127">阅读原文</a>
{% endraw  %}

