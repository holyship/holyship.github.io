---
title: 手工逆 Chrome 扩展后门的一些思路
author: 余弦
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512888019&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKPvNcbsGx2W6BvKjMgwiVYeZ*-NnMC0cIm6MxXQtG1byEWaGEimydsT5vxArbGUjmjjpuyji5KJXwi95uym7SG993NhQnKXyxOhHPAku3i27G40yNKExJN0RBxBLoHqzP76Vo*O2kdrRUIb6Szm437E=
date: '2017-09-10 00:00:00 +0000'

---

{% raw  %}
<p>昨天看到 V2EX 上的这个讨论：</p><p><br></p><blockquote><p>大家注意了 Chrome 的插件 User-Agent Switcher 是个木马<br></p><p>https://www.v2ex.com/t/389340<span style="color: rgb(192, 0, 0); max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"></span></p></blockquote><p><br></p><p>对于我这种很在意隐私与安全，且研究过 Chrome 扩展木马的老司机来说，也还是吓了一跳。刚开始以为自己也中招了，后来发现没有，如果有，那这个确实是很细思恐极的事。</p><p><br></p><p>Chrome 扩展，在 Google 那是有安全审计的，所以基本上会觉得靠谱，但是对于玩安全的我们来说，都是默认抱着怀疑的态度去安装一些扩展。你们只要注意下，那些你安装的扩展需要的权限是不是很多？（这点很像 Android App 的权限生态，同样的陋习）。如果这些扩展是恶意的或者存在 XSS、MITM 等漏洞被恶意利用，那么危害就很大了。扩展的权限是大于网页的（但一般情况下小于本地文件），至少可以无视同源策略。这意味着，如果你安装了一个恶意扩展，那么在这个浏览器的一切行为都有可能被监控，隐私数据都有可能被盗取。<br></p><p><br></p><p>当年我挖掘过一些扩展漏洞，达到的效果如：访问我的一个链接，就可以拿你 Gmail 权限。也写过扩展后门及相关安全工具，早期这方面更不安全，第三方扩展都可以随意安装，现在安装会麻烦得多，但不是不可以。</p><p><br></p><p>这是我玩 Chrome 扩展的一些见解。这次这个后门，我手工逆起来很快，给大家简单分享下经验。</p><p><br></p><p>首先是后门扩展地址：</p><p><br></p><blockquote><p>https://chrome.google.com/webstore/detail/user-agent-switcher-for-g/ffhkkpnppgnfaobgihpdblnhmmbodake<br></p></blockquote><p><br></p><p>可以随便搜索个 Chrome 扩展下载服务把扩展文件下载下来分析。比如这个：</p><p><br></p><blockquote><p>https://chrome-extension-downloader.com/<br></p></blockquote><p><br></p><p>扩展后缀是 crx，改为 7z，解压就好。</p><p><br></p><p>解压后，直接去读相关文件：js、html、json 等，可以先看看 manifest.json 文件，这里做了这个扩展需要的基本声明，尤其是权限，如下：</p><p><br></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/kicMePHlP6TCcx5ibTFjV8iayv2OfjuqkoDGq6QcZDt3jibYkgYLreT8xHGhPtJGKVwhc8wG5sMgeiaDXvrRE2e9nwA/0?wx_fmt=png" style="width: 425px !important; height: 256px !important;"></p><p><br></p><p>可以看到这个权限已经足够控制你 Chrome 的一切网络行为了，只要它愿意。</p><p><br></p><p>然后直入主题去看这次出问题的 js 文件：background.js，第 80 行，这行是一大段代码，做了些加密操作，可以用我开源的 XSS'OR（http://xssor.io）直接去解。</p><p><br></p><p>把这行代码粘贴到 XSS'OR 的 ENCODE/DECODE 的文本框去，然后点击 JS BEAUTIFY 就可以一键解密并美化。<br></p><p><br></p><p>美化后，里面的 Canvas 操作逻辑就很明显了，恶意代码隐藏在图片 promo.jpg 里，通过 Canvas 技术读取出来并应用下面这个技巧来动态执行：</p><p><br></p><blockquote><p><span style="color: rgb(192, 0, 0); max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">document.defaultView[(typeof r.Ae).charAt(0).toUpperCase() + (typeof r.Ae).slice(1)](n)()</span></p></blockquote><p><br></p><p>实际上，这个技巧等于：</p><p><br></p><blockquote><p><span style="color: rgb(192, 0, 0); max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">document.defaultView[Function](n)()</span><br></p></blockquote><p><br></p><p>n 这个变量可以是任意一段 JavaScript 代码。</p><p><br></p><p>我们在做调试时，可以把这些代码片段拿出来，在 XSS'OR 的 ENCODE/DECODE 里进行，用其中的 EVAL CODZ 功能就好（在 JS BEAUTIFY 按钮旁边）。调试输出，可以用 alert，也可以 console.log，看个人喜好。</p><p><br></p><p>不过由于这里涉及到从图片里获取数据并解析输出，我还是写了个独立页面进行手动调试，这里：</p><p><br></p><blockquote><p><span style="color: rgb(192, 0, 0); max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">http://xssor.io/s/uasbackdoor.html</span><br></p></blockquote><p><br></p><p><em>注：独立页面的调试可以考虑用在 Chrome 开发者工具里去断点调试跟踪输出。</em></p><p><br></p><p>你可以访问看看，等几秒，就可以看到上面那个 n 变量的内容了（来自 promo.jpg 图片并解析后的）。内容不小，如图：</p><p><br></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/kicMePHlP6TCcx5ibTFjV8iayv2OfjuqkoDBRbOQDrDuiaibXpKiaAcoXK3g6xQic9tKUqX3yxn942kwRsFPk2OoYWmrg/0?wx_fmt=png" style="width: 770px !important; height: 459.965px !important;"></p><p><br></p><p>这段内容很眼花，但是我们已经可以接触到真相了。后续可以继续通过 XSS'OR 的 JS BEAUTIFY 去美化，但是还是会很眼花，因为所有变量都加花了，而且这里运用了大量 ES6 语法糖，如果对 JavaScript 新标准不了解，看这段代码很容易晕。</p><p><br></p><p>到这，重复上面的一些调试技巧逐一耐心调试，没有解不开的代码。</p><p><br></p><p>如果你想更清晰了解某些代码片段的意思，有必要好好去了解下 Chrome 扩展开发的一些知识。</p><p><br></p><p>更多细节自己实战起来吧，这里懒得展开。通过昨晚的简单调试可以得出结论这个扩展确实具备后门特点，不过懒得深入判断细节逻辑，至于危害是多大，目前不好说。但是，我还是希望通过本文的分享，告诉大家小心 Chrome 恶意扩展带来的威胁，在使用一些不那么可信的扩展时，多留意。可以开个网络抓包分析是否有怪异请求发出去，能力 OK 的话，就自己审计一番，扩展的源码按照如上方式是可以轻易得到的，毕竟都是前端那些事。</p><p><br></p><hr><p><br></p><p>继续广告，如果你想及时跟进一些安全事件、学习交流一些安全技能，可以加入我们开的付费圈子“安全技能树”。:)</p><p><br></p><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/kicMePHlP6TDtLicNW1wOxt6vUnJOibosGAeaeia2oRZ3hlhSY05BnSW09FBW7S1DKD5wx39Gk7O9HdwfX2NK9j6ibQ/0?wx_fmt=jpeg" style="width: 710px !important; height: 1016px !important;"></p><p><br></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">-----------------</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号「<span style="max-width: 100%; color: rgb(192, 0, 0); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">Lazy-Thought</strong></span>」</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">几个黑客在维护，都很懒，都想改变点什么</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512888019&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKPvNcbsGx2W6BvKjMgwiVYeZ*-NnMC0cIm6MxXQtG1byEWaGEimydsT5vxArbGUjmjjpuyji5KJXwi95uym7SG993NhQnKXyxOhHPAku3i27G40yNKExJN0RBxBLoHqzP76Vo*O2kdrRUIb6Szm437E=">微信地址</a>
{% endraw  %}

