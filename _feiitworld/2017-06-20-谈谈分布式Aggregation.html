---
title: 谈谈分布式Aggregation
author: 冯宇 数据管理
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1498052229&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ3jT3pMI3MaYYMYbZDiicfiIzYDxKgPulk7FXkHIlSCgD61gy4SCphb5MOvT5hCRBlbqcZHkb4SALVeS-yHSuygVEfspWuJXt*CdCOK3FOL6bdOu4J2L1R-41mhzQok0sT9mFMKrtUzBhsmO85zDgVo=
date: '2017-06-20 00:00:00 +0000'

---

{% raw  %}
<p>本文由数据管理授权转发。</p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">前 &nbsp;言</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">聚合操作（Aggregation）是OLAP分析查询中最常见的操作之一，可以说它是数据分析查询的基石，它对应着SQL中的GROUP BY子句，OLAP中的上卷下钻操作无非就是对于GROUP BY和WHERE条件的改变。如何能够高效的实现聚合是决定OLAP分析性能的最重要因素之一（另外几个因素包括如何减少SCAN记录数、如何高效实现JOIN等）。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">从OLAP引擎的划分来看主要分成MOLAP和ROLAP两大类，MOLAP基于CUBE模型进行预计算，可以直接将Aggregation之后的结果预计算并保存，这样查询的时候只需要查询已经预计算的结果或者做少量的运算就可以了；而ROLAP则始终基于原始数据计算，计算开销相对于MOLAP更大，但是它的优势在于灵活，不受限于模型的约束。前者的代表是Apache Kylin、Druid等；后者的代表则为Impala、Presto、SparkSQL等。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">在分布式环境下，要做到高效的Aggregation就需要想办法增加并行度，Hadoop的出现解决了这个问题.想想经常提到的Word Count其实就是一个计算count(1)的Aggregation运算，因此本文就以一个简单的表和数据谈谈对分布式Aggregation的理解。</span></p><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; color: inherit; clear: both; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">单机实现</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; color: inherit; clear: both; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">说了这么多Aggregation，那么什么是Aggregation呢？虽然很简单但是在对校招生面试的时候发现很多同学对SQL的了解还停留在提到SQL立马反应就是“SELECT * FROM xxx”。聚合简单来说就是将某一列的值或者多列的组合值按照相同的值进行分组，每一个组内做聚合运算（对应着聚合函数），典型的聚合函数包括COUNT/SUM/MIN/MAX/COUNT DISTINCT等等，单线程情况下的聚合操作可以用如下的伪代码实现：</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">伪代码：对于某一列A进行COUNT(1)计算。</span></p><table width="670"><tbody style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><tr class="" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><td width="461" valign="top" style="margin: 5px 10px; word-break: break-all; max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">构造一个Map&lt;String, Int&gt; M</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">对于输入的每一条记录：</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;获取A列的值a;</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;if(M.contains(a)) {</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;M.put(a, M.get(a) + 1); </span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;} else {</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;M.put(a, 1);</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;}</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: monospace; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">依次输出M的每一个&lt;key, value&gt;</span></span></p></td></tr></tbody></table><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">这种实现在大数据场景下会存在两个问题：</span></p><ul class="list-paddingleft-2" style="max-width: 100%; width: 438.891px; font-size: 14px; color: rgb(51, 51, 51); box-sizing: border-box !important; word-wrap: break-word !important;"><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">M这个缓存会占用很大的空间;</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">单线程执行，执行速度不能够让人满意。</span></p></li></ul><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">分布式Aggregation</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">在分布式环境下，Hadoop的出现解决了这两个问题，想想入门Hadoop经常提到的word count程序其实就是一个根据单词计算COUNT(1)的聚合运算，那么Hadoop是如何利用分布式计算来解决这个问题的呢？它会把输入的记录分散到多个并行的运算节点中执行，每一个节点如上伪代码中的实现逻辑，记录的分散需要保证一条记录只会被一个计算节点处理（防止一条记录被多次处理），每一个计算节点会输出一个M，然后在经过汇总节点把所有的M进行汇总。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">在介绍这个之前首先看一下分布式聚合运算的执行流程，如果要实现一个聚合函数（UDAF），需要分解成如下几个步骤：</span></p><ol class="list-paddingleft-2" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">Init操作，分配缓存空间等一些初始化操作，例如上面伪代码中的第一行初始化Map对象。</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">Update操作，对于每一条输入记录执行更新状态的操作，例如上面例子中的3-8行</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">Merge操作，将来自多个计算节点的输出进行再次聚合运算。</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">Finish操作，对于再次聚合运算的结果求值，得到最终结果。</span></p></li></ol><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">示 &nbsp;例</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">下面一个示例展示了详细的计算流程。本例子使用的表T数据如下，执行的SQL：</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><table width="670"><tbody style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><tr class="" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><td width="461" valign="top" style="margin: 5px 10px; word-break: break-all; max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">SELECT A, COUNT(1), SUM(C) FROM T GROUP BY A;</span></td></tr></tbody></table><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">表中原始数据如下：</span><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_png/v1TDugurKBQwtu3do2LAmhWesaLL8EqugJtaWcqb0jvWEWGiaFPOViaSJ6sq8nxQXckVMotATAY2DwV9xPGR5Dkg/0?" style="background-color: rgb(238, 237, 235); border-width: 0px; border-style: initial; border-color: initial; background-size: 22px; background-position: center center; background-repeat: no-repeat; background-image: none; box-sizing: border-box !important; word-wrap: break-word !important; width: 593px !important; height: 374px !important;"></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">为了描述简单，假设它被分割成两个分区被两个计算节点计算，计算流程如下图：</span></p><p style="max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/v1TDugurKBQwtu3do2LAmhWesaLL8EquHWnJv7zQalPiaVrl9MM3LrqXzqLlHX4zYccbqvA8OeMrYakI8KxyvXQ/0?" style="background-color: rgb(238, 237, 235); border-width: 0px; border-style: initial; border-color: initial; background-size: 22px; background-position: center center; background-repeat: no-repeat; background-image: none; box-sizing: border-box !important; word-wrap: break-word !important; width: 670px !important; height: 531.614px !important;"></p><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">MR vs Data Pipeline</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">按照Hadoop的计算逻辑可以将整个计算分成两个阶段：Map和Reduce，Map阶段对于每一个分区的每一条记录执行Update操作，计算完成之后通过一个Shuffle过程将Map结果打散，Shuffle过程可以使用不同的散列算法实现，但是需要保证相同的key（这里是A列的值）被输出到相同的Reduce节点执行。在Reduce阶段执行Merge操作，所有的Merge操作完成之后对于每一个key执行Finish操作将结果输出（这里的Finish操作并没有执行任何计算）。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">上面的计算流程可以做到完全分布式化，计算时可以同时启动M个Map和N个Reduce计算节点执行计算，但是Hadoop的计算流程存在一个问题，那就是Shuffle过程，Shuffle需要首先将Map的计算结果在本地持久化，然后再从持久化的结果中读取打散发送到下游的Reduce节点，一旦数据落地，性能必然会有所下降，这么做的原因是为了可靠性，一旦计算结果落地，这个Map节点的任务就可以完成了，不用关心Reduce什么时候来读取数据，即使Reduce计算过程中挂了，Map的结果也不需要重新计算了，重新启动一个Reduce计算节点重新读取一次数据就可以了；另外，Map计算节点和Reduce计算节点是顺序的，Reduce只能等到所有的Map都结束之后才能启动执行，这无疑降低了计算的并行度。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">在Impala实现的过程中使用了不同的处理方式，它不会对需要Shuffle的数据进行任何的数据持久化，并且直接通过数据流水线（data pipeline）的方式进行并行计算，不持久化需要Shuffle的数据意味着Map的结果会直接通过网络发送到对应的Reduce计算节点，data pipeline意味着Map和Reduce过程可以同时进行计算，这又是怎么做到的呢？</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">首先为了确定哪些计算可以并行，Impala计算引擎会把计算节点分成BlockingNode和NonBlockingNode，BlockingNode表示需要等到处理完全部的输入数据之后才能产生本节点的输出；而后者则不需要等待。典型的BlockingNode有Sort操作和Merge-Aggregation节点（也就是Aggregation的Merge阶段），NonBlockingNode则可以并行的执行，例如上图中的Map阶段的Update操作，它其实是Map操作的第一个阶段，它不需要等到所有的输入都处理完再输出，那就意味着Update的结果可以边计算边进行Shffle到下一个计算节点（Merge）。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">所以从Impala执行Aggregation的流程可以看出，它可以增大计算的并行度，但是什么时机将需要Shuffle的数据进行输出呢，有两个极端：1）每一条都输出，那相当于Update操作不执行任何计算了；2）所有的都计算完成再输出，那就回到了Hadoop的处理模式了。所以需要在这两者之间寻找一个平衡。</span></p><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">Count Distinct困惑</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">上面介绍了分布式Aggregation的执行流程，以及基于Map-Reduce和data pipeline的计算模式，但是还有一个常用的比较消耗资源的聚合函数：COUNT DISTINCT。看上去它也是类似于COUNT/SUM之类的聚合函数，但是它和COUNT/SUM之类的聚合函数的主要区别在于COUNT/SUM之类的状态保存在最终的值里面，而COUNT DISTINCT的计算状态和最终的值是两个东西，计算状态是什么？就是Shuffle的信息，Merge依赖于每一个key和它对应的计算状态；最终的值则是Finish操作执行计数之后的结果值。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">COUNT DISTINCT聚合函数的计算状态无非就是每一个key对应的一大串去重之后的成员值，这又有什么难的呢？试想一下上面的T表有1亿条记录，A列的不同的值只有10个，我们要计算COUNT DISTINCT的B列包含2千万个不同的值，Map的输出结果很可能是下图的形式。</span></p><p style="max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); text-align: center; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_png/v1TDugurKBQwtu3do2LAmhWesaLL8EquFEoxJsadB6Btq1W4o8F68Xq7gIItOjJibqNAicicbrcPNmxSpGVibf8XpA/640?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 273px !important; height: 139px !important;"></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">这些数据需要经过shuffle之后传递到Reduce，Reduce阶段再根据相同的key进行merge，这会带来三个问题：</span></p><ol class="list-paddingleft-2" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">shuffle数据量非常巨大；</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">占用大量内存，也就是每一个set都至少需要保存所有成员；</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">merge操作的代价很大，因为此类的merge说白了就是两个set求并集，需要遍历两个set。</span></p></li></ol><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">可以说这个问题困扰着各个大数据生态圈的SQL引擎。典型的优化方法有两类：</span></p><ol class="list-paddingleft-2" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">使用基于基数统计的HyperLogLog算法实现非精确的COUNT DISTINCT，通常情况下它能够在不占用大量内存的情况把错误率维持在2%甚至1%以内；</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">对每一个成员进行编码，然后使用bitmap存储成员列表而不在使用set，这种方式可以计算精确的COUNT DISTINCT，但是这需要额外的数据编码，实现起来也比较复杂。</span></p></li></ol><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">Apache Kylin使用了这两种方法实现COUNT DISTINCT。但是Impala并没有用其中任何一种方案，而是另辟蹊径。</span></p><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">Count Distinct in Impala</strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">在介绍Impala中的COUNT DISTINCT实现之前，先看一下如下的两个SQL：</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><table width="670"><tbody style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><tr class="" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><td width="461" valign="top" style="margin: 5px 10px; word-break: break-all; max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">Q1：SELECT A, COUNT(DISTINCT B), SUM(C) FROM T GROUP BY A;</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">Q2：SELECT A, COUNT(1), SUM(SC) FROM&nbsp;</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp; &nbsp; &nbsp; &nbsp;(SELECT A, COUNT(1), SUM(C) AS SC&nbsp;</span><br style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp; &nbsp; &nbsp; &nbsp;FROM T GROUP BY A, B) TT GROUP BY A;</span></td></tr></tbody></table><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">仔细分析可以发现这两个SQL执行结果是相同的，按照这样的思路我们可以把COUNT DISTINCT计算转换成两层的COUNT计算，计算流程如下图：</span><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/v1TDugurKBQwtu3do2LAmhWesaLL8EquWWGCvvaeoVmI6fd3byqzlQvQsicLwUDVZWN1qxKNbbqeZ7pmbpicYic4w/640?wx_fmt=jpeg" style="border-width: 0px; border-style: initial; border-color: initial; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 826px !important;"></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">Impala的COUNT DISTINCT实现就是将Q1中的查询隐式得转换成Q2，于是肯定有读者会纳闷为什么要做这样的优化呢？</span></p><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">分 &nbsp;析</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">这里的流程和上面计算COUNT/SUM的区别在于第一阶段Update是根据A和B聚合的，但是Shuffle是根据A进行的，然后在Reduce阶段的Merge分成两阶段，第一阶段的Merge是按照A、B进行COUNT(1)和SUM(C)的聚合运算，正如Q2中子查询一样，接着再执行Merge-2阶段，该阶段对于SUM再次执行Merge操作（参见UDAF的四个阶段），对COUNT执行Update操作，最后执行Finish操作，这里同样没有执行任何计算而直接输出。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">Impala的COUNT DISTINCT实现流程看上去和Map-Reduce很相似，只不过增加了一步，但是使用过Impala的都会发现，COUNT DISTINCT聚合函数的速度还是非常快的，通过分析这两个流程的每一步，结合Map-Reduce计算COUNT DISTINCT的三个问题，我们逐一分析（下面时间复杂度的分析都是基于二叉树实现map和set）：</span></p><ol class="list-paddingleft-2" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">Shuffle数据量，Map-Reduce的方式需要把每一个A的成员和它对应的B的成员值进行Shuffle，而Impala的方式变成了A和B的组合在Update之后进行Shuffle，总的来看Shuffle的数据量是没有什么差别的，都需要传输O(M * N)大小的数据，M和N分别是A个B的成员数，另外Impala的实现方式还增加了一次shuffle，只不过这次数据量的传输比较小。</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">内存占用情况：采用Impala处理COUNT DISTINCT不存在A对应的一个个set了，但是它在做Merge操作的时候需要按照A和B的组合作为key，这占据的内存其实和Map-Reduce的方式相差不大的，都是需要一个O(M * N)大小的Map。</span></p></li><li><p style="max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">聚合运算速度，Map-Reduce的方式对于每一个输入需要遍历其中一个set将成员逐个的插入到另外一个set中，假设两个大小为N的set合并的时间复杂度为O(N)，需要对M个A列的成员值都进行合并。那么总的时间复杂度为O(M&nbsp;N)，其中M为A列的成员个数，N为B列的成员个数。但是Impala方式的实现分成两阶段，第一阶段需要找到A和B组合对应的key进行加一，第二阶段则需要找到A对应的key进行加一，总的时间复杂度为O(log(M&nbsp;N)) + O(log(M))&nbsp;K = O(log(M&nbsp;N) * K)。其中M为A的成员个数，N为B的成员个数，K为节点个数。</span></p></li></ol><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">从上面的分析可以看出，两种实现网络传输的数据量和占用的内存大小是相差不大的，比较大的区别在于merge阶段的时间复杂度，通过对两个时间复杂度进行分析可以很容易的看到Impala的实现方式时间复杂度要低非常多，查询速度更快也是理所当然的了。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">对于Map-Reduce的Merge实现可以有一种更好的基于最小堆的实现方式，聚合操作可以从O(X*log(Y))降低到O(X +Ｙ)的时间复杂度，其中Y为较大set的成员个数，X为较小set的成员个数，这个有机会再做介绍。</span></p><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; color: inherit; clear: both; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">缺 &nbsp;陷</strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; color: inherit; clear: both; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">介绍完了Impala中COUNT DISTINCT的实现，可能有人要问了，为什么其他的SQL引擎不使用这种方式实现呢？这是因为它有一个非常大的弊端：只支持在一层查询中出现一个COUNT DISTINCT运算，例如在Impala中执行如下的SQL：</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><table width="670"><tbody style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><tr class="" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><td width="461" valign="top" style="margin: 5px 10px; word-break: break-all; max-width: 100%; word-wrap: break-word !important; box-sizing: border-box !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; font-size: 14px; white-space: pre-wrap; background-color: rgb(248, 248, 248); box-sizing: border-box !important; word-wrap: break-word !important;">SELECT A, COUNT(DISTINCT B), COUNT(DISTINCT C) FROM T GROUP BY A;</span></td></tr></tbody></table><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">按照前面的转换逻辑，在Merge-2阶段将无法选择使用哪些列进行聚合，无论使用A/B还是使用A/C都会丢失A和另外一列的组合信息，如果直接使用A进行聚合，则得到的是SELECT A, COUNT(DISTINCT B,C) FROM T GROUP BY A的执行结果。</span></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">最后还需要说明的是在Impala的实现中，Merge和Merge-2阶段都会被设置成是BlockingNode，可能是考虑到Merge之后的数据量一般比较小了，没有和下一个节点并行执行的必要性了。</span></p><p><br></p><p></p><section data-width="25px" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-width="25px" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; text-align: right; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><section style="margin-right: 10px; margin-left: 10px; max-width: 100%; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="margin-left: 4px; max-width: 100%; box-sizing: border-box; color: rgb(6, 6, 6); line-height: 2.8em; border-color: rgb(226, 86, 27); word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">总 &nbsp;结</span></strong><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></strong></span></p></section></section><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; clear: both; color: inherit; width: 25px; display: inline-block; box-sizing: border-box !important; word-wrap: break-word !important;"><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; width: 25px; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; width: 20px; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; display: inline-block; word-wrap: break-word !important;"></section></section><section style="max-width: 100%; line-height: 0em; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; border-top: 2px solid rgb(107, 172, 239); height: 2px; color: inherit; width: 15px; display: inline-block; word-wrap: break-word !important;"></section></section></section><p></p><p><br></p><p style="margin-bottom: 15px; max-width: 100%; min-height: 1em; font-size: 14px; color: rgb(51, 51, 51); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;">在大数据SQL引擎中（大体上都是OLAP引擎），Aggregation和Join的计算性能直接影响着查询速度，本文主要介绍了笔者在使用MapReduce和Impala系统中对实现Aggregation操作的理解，最后详细介绍了Impala能够实现高速的单个DISTINCT COUNT查询的原理，希望能够能够对于读者有点帮助和启发，如果本文中笔者的理解有所偏差，也请多多指正。</span></p><p><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p><br></p><p></p><section class="" powered-by="xiumi.us" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; text-align: center; line-height: 2; letter-spacing: 1px; word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;">欢迎打赏支持飞总的写作</strong></p></section></section></section><p></p><p><br></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p><br></p><p></p><section class="" powered-by="xiumi.us" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; box-sizing: border-box; text-align: center; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_png/e8uayZybZ7IZU2NvN9upF9DTUdA6Z0dF4jdVl80H07XTTHtf9o7BBDLNtdqR4Mdl2A6U1iahs7kLUibzaekxfMibw/640?wx_fmt=png" style="box-sizing: border-box; vertical-align: middle; word-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 845px !important;"></section></section><section class="" powered-by="xiumi.us" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 556px; vertical-align: top; word-wrap: break-word !important;">&nbsp;</p><section class="" style="max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 670px; vertical-align: top; word-wrap: break-word !important;">&nbsp;往期精选</p></section><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><section class="" style="max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 670px; vertical-align: top; text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484224&amp;idx=1&amp;sn=9fced8d0ae82ab9b5a312beef90f76a2&amp;chksm=ec96d90bdbe1501d3b95a1d5aa7624f02f23c1c0f3c954a732daee20d16c41ffc8a308e9735c&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484224&amp;idx=1&amp;sn=9fced8d0ae82ab9b5a312beef90f76a2&amp;chksm=ec96d90bdbe1501d3b95a1d5aa7624f02f23c1c0f3c954a732daee20d16c41ffc8a308e9735c&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">修Bug的罪与罚(1)</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; background-color: rgb(255, 255, 255); text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484209&amp;idx=1&amp;sn=31d449c3455262b67af730633a987e2d&amp;chksm=ec96d97adbe1506c627190ee2680aa5c2caa43269d6e3effd08c37f9bcc7dc7b7a5419f8187a&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484209&amp;idx=1&amp;sn=31d449c3455262b67af730633a987e2d&amp;chksm=ec96d97adbe1506c627190ee2680aa5c2caa43269d6e3effd08c37f9bcc7dc7b7a5419f8187a&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">做人不能太无耻之微软build大会的宇宙数据库</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><section class="" style="max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 670px; vertical-align: top; text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484060&amp;idx=1&amp;sn=975148338bf2296a6c0f89fa3c94bae1&amp;chksm=ec96d8d7dbe151c155f417ee05c22b8cb15797bfd7ad891771e5bdecf6ddbc1ca9f89b87eb90&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484060&amp;idx=1&amp;sn=975148338bf2296a6c0f89fa3c94bae1&amp;chksm=ec96d8d7dbe151c155f417ee05c22b8cb15797bfd7ad891771e5bdecf6ddbc1ca9f89b87eb90&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">缺失的价值回报体系</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section><section class="" style="max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 670px; vertical-align: top; text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484047&amp;idx=1&amp;sn=4efac37195a779579ddfa999e13e8079&amp;chksm=ec96d8c4dbe151d2042d9bce729537b2c6d71b12c0dc4f3e7a6c74b14ef4e87b07a8cd265ace&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484047&amp;idx=1&amp;sn=4efac37195a779579ddfa999e13e8079&amp;chksm=ec96d8c4dbe151d2042d9bce729537b2c6d71b12c0dc4f3e7a6c74b14ef4e87b07a8cd265ace&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">血淋淋的Cloudera上市路</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; background-color: rgb(255, 255, 255); text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247483893&amp;idx=1&amp;sn=7a0251137bcca186d5fac0e0eb669f53&amp;chksm=ec96dbbedbe152a8e83b3c2684ef693d5ebf14da9fe7ac1c6f9e209c72a13f9642fd3ee96554&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247483893&amp;idx=1&amp;sn=7a0251137bcca186d5fac0e0eb669f53&amp;chksm=ec96dbbedbe152a8e83b3c2684ef693d5ebf14da9fe7ac1c6f9e209c72a13f9642fd3ee96554&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">陆奇为什么去百度？</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><section class="" style="max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 670px; vertical-align: top; text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484099&amp;idx=1&amp;sn=a18b7f0e9dd0fe596bdf80e3a1f9709e&amp;chksm=ec96d888dbe1519ec1d69a1e9bd4081eb6492ed99e93387a59e8d2438abf27a537a468252889&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484099&amp;idx=1&amp;sn=a18b7f0e9dd0fe596bdf80e3a1f9709e&amp;chksm=ec96d888dbe1519ec1d69a1e9bd4081eb6492ed99e93387a59e8d2438abf27a537a468252889&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">Log:被BigData遗忘的奠基者</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section><section class="" style="max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 670px; vertical-align: top; text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247483786&amp;idx=1&amp;sn=94b99648f9c2761ecc3fe0205e4ae575&amp;chksm=ec96dbc1dbe152d7ed246eac13807e627d1d8b89742460fefcd7a01eedc4d0daec3fb9c54ae1&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247483786&amp;idx=1&amp;sn=94b99648f9c2761ecc3fe0205e4ae575&amp;chksm=ec96dbc1dbe152d7ed246eac13807e627d1d8b89742460fefcd7a01eedc4d0daec3fb9c54ae1&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">大数据的那些事（1）：Google的后悔药</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section><section class="" style="max-width: 100%; box-sizing: border-box; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 670px; vertical-align: top; text-indent: 2em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247483757&amp;idx=1&amp;sn=78d24e0bc43c1e27627b59d3adb1c236&amp;chksm=ec96db26dbe152300bc8320c215368d8a2ae5baa45ca474240bc27ed28c9454e666b577a4da2&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247483757&amp;idx=1&amp;sn=78d24e0bc43c1e27627b59d3adb1c236&amp;chksm=ec96db26dbe152300bc8320c215368d8a2ae5baa45ca474240bc27ed28c9454e666b577a4da2&amp;scene=21#wechat_redirect" style="text-decoration: underline; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">SAP HANA神话（一）：Michael Stonebraker梦碎</a></p></section><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 556px; vertical-align: top; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section><section class="" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; display: inline-block; width: 556px; vertical-align: top; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section></section><section class="" powered-by="xiumi.us" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; text-align: center; line-height: 2; letter-spacing: 1px; word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;">加飞总小密圈和大咖嘉宾聊天</strong></p></section></section></section><section class="" powered-by="xiumi.us" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; display: inline-block; width: 556px; vertical-align: top; word-wrap: break-word !important;"><section class="" powered-by="xiumi.us" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; box-sizing: border-box; text-align: center; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/e8uayZybZ7IZU2NvN9upF9DTUdA6Z0dFRzicAHYiblpcq8UywsXCDSS2ibmYHp7x3rZLLGaOic5MpeN7ufCMWeKiaCA/640?wx_fmt=jpeg" style="box-sizing: border-box; vertical-align: middle; word-wrap: break-word !important; visibility: visible !important; width: 333.594px !important; height: 345.851px !important;"></section></section></section></section></section><p></p><p><br></p><p><span style="max-width: 100%; color: rgb(63, 63, 63); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><br></span><br></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1498052229&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ3jT3pMI3MaYYMYbZDiicfiIzYDxKgPulk7FXkHIlSCgD61gy4SCphb5MOvT5hCRBlbqcZHkb4SALVeS-yHSuygVEfspWuJXt*CdCOK3FOL6bdOu4J2L1R-41mhzQok0sT9mFMKrtUzBhsmO85zDgVo=">微信地址</a>
{% endraw  %}

