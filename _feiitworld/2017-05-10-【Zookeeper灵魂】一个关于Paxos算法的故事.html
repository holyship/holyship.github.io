---
title: 【Zookeeper灵魂】一个关于Paxos算法的故事
author: 大数据研习社
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1494425729&src=3&ver=1&signature=T3pUTKCUVTFXYE3cOj0PN**Ah0Pztul9eEG1vIHB28YHFOdQpfoj*4*L5Z-MwUMCmrtzgOsGkeMGyoa3ck9uqEUmYk4I4Uiv**7BZcz33z53KNawGvVJsv5NbQUdQycMNZUm95EakRW9K6jcslJSHQMfdXH8RLuYsflzWSaAuFw=
date: '2017-05-10 00:00:00 +0000'

---

{% raw  %}
<section style="background-color: rgb(255, 255, 255); box-sizing: border-box;"><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 15px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">飞总语：Paxos是分布式系统中里程碑式的成就。我觉得每个做大数据的人都应该有所了解。我一直在写一篇通俗易懂的稿子但是几次写了都不满意。主要还是自己对Paxos的理解不够深刻。然后我看到了这篇文章。果断把自己的文章扔垃圾桶里。然后特意申请了转载。感谢大数据研习社允许我转载本文。</strong></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;"><br style="box-sizing: border-box;"></strong></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;">Zookeeper默认采用FastLeaderElection算法,然而FastLeaderElection对于Zookeeper来讲只是相当于paxos中的leader选举。下面我们用最简单的方式加以描述并建立起Paxos和ZKServer的对应关系。<br style="box-sizing: border-box;"></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">Paxos描述了这样一个场景:</strong></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><img src="/feiitworld/images/61d82dd35a51d8a9b171659d6ea27a892e90cd86.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 640px !important; height: 396px !important; visibility: visible !important;"></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 15px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;">1.有一个叫做Paxos的小岛(Island)上面住了一批居民，岛上面所有的事情由一些特殊的人决定，他们叫做议员(Senator)。<br style="box-sizing: border-box;">2.议员的总数(SenatorCount)是确定的，不能更改。<br style="box-sizing: border-box;">3.岛上每次环境事务的变更都需要通过一个提议(Proposal)，每个提议都有一个编号(PID)，这个编号是一直增长的，不能倒退。<br style="box-sizing: border-box;">4.每个提议都需要超过半数((SenatorCount)/2+1)的议员同意才能生效。<br style="box-sizing: border-box;">5.每个议员只会同意大于当前编号的提议，包括已生效的和未生效的。<br style="box-sizing: border-box;">6.如果议员收到小于等于当前编号的提议，他会拒绝，并告知对方：你的提议已经有人提过了。这里的当前编号是每个议员在自己记事本上面记录的编号，他不断更新这个编号。整个议会不能保证所有议员记事本上的编号总是相同的。<br style="box-sizing: border-box;"></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">现在议会有一个目标：保证所有的议员对于提议都能达成一致的看法。</strong></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><img src="/feiitworld/images/595e5055006e9bceaea3fd8e16a6671abdbc0e40.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 450px !important; height: 283px !important;"></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 15px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;">好，现在议会开始运作，所有议员一开始记事本上面记录的编号都是0。<br style="box-sizing: border-box;">有一个议员发了一个提议：<br style="box-sizing: border-box;">将电费设定为1元/度。他首先看了一下记事本，嗯，当前提议编号是0，那么我的这个提议的编号就是1，于是他给所有议员发消息：1号提议，设定电费1元/度。其他议员收到消息以后查了一下记事本，哦，当前提议编号是0，这个提议可接受，于是他记录下这个提议并回复：我接受你的1号提议，同时他在记事本上记录：当前提议编号为1。发起提议的议员收到了超过半数的回复，立即给所有人发通知：1号提议生效！收到的议员会修改他的记事本，将1好提议由记录改成正式的法令，当有人问他电费为多少时，他会查看法令并告诉对方：1元/度。<br style="box-sizing: border-box;"></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">现在看冲突的解决：</strong></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><img src="/feiitworld/images/20a13b8a413dc25ee865e5f4c1a8a2c87a68370b.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 630px !important; height: 335px !important;"></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 15px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;">假设总共有三个议员S1-S3，S1和S2同时发起了一个提议:1号提议，设定电费。S1想设为1元/度,S2想设为2元/度。结果S3先收到了S1的提议，于是他做了和前面同样的操作。紧接着他又收到了S2的提议，结果他一查记事本，咦，这个提议的编号小于等于我的当前编号1，于是他拒绝了这个提议：对不起，这个提议先前提过了。于是S2的提议被拒绝，S1正式发布了提议:1号提议生效。S2向S1或者S3打听并更新了1号法令的内容，然后他可以选择继续发起2号提议。<br style="box-sizing: border-box;">好，我觉得Paxos的精华就这么多内容。现在让我们来对号入座，看看在ZKServer里面Paxos是如何得以贯彻实施的。<br style="box-sizing: border-box;">小岛(Island)——ZKServerCluster<br style="box-sizing: border-box;">议员(Senator)——ZKServer<br style="box-sizing: border-box;">提议(Proposal)—ZNodeChange(Create/Delete/SetData…)<br style="box-sizing: border-box;">提议编号(PID)—Zxid(ZooKeeperTransactionId)<br style="box-sizing: border-box;"><strong style="box-sizing: border-box;">正式法令——所有ZNode及其数据：<br style="box-sizing: border-box;"></strong>貌似关键的概念都能一一对应上，但是等一下，Paxos岛上的议员应该是人人平等的吧，而ZKServer好像有一个Leader的概念。没错，其实Leader的概念也应该属于Paxos范畴的。如果议员人人平等，在某种情况下会由于提议的冲突而产生一个“活锁”（所谓活锁我的理解是大家都没有死，都在动，但是一直解决不了冲突问题）。Paxos的作者Lamport在他的文章”ThePart-TimeParliament“中阐述了这个问题并给出了解决方案——在所有议员中设立一个总统，只有总统有权发出提议，如果议员有自己的提议，必须发给总统并由总统来提出。好，我们又多了一个角色：总统。<br style="box-sizing: border-box;">总统——ZKServerLeader</p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">又一个问题产生了，总统怎么选出来的？<br style="box-sizing: border-box;"></strong></p><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;">现在我们假设总统已经选好了，下面看看ZKServer是怎么实施的。</p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><img src="/feiitworld/images/e7b54c9113f1659635e083d25328a47b98129b74.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 600px !important; height: 389px !important;"></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 15px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">情况一：<br style="box-sizing: border-box;"></strong>屁民甲(Client)到某个议员(ZKServer)那里询问(Get)某条法令的情况(ZNode的数据)，议员毫不犹豫的拿出他的记事本(localstorage)，查阅法令并告诉他结果，同时声明：我的数据不一定是最新的。你想要最新的数据？没问题，等着，等我找总统Sync一下再告诉你。<br style="box-sizing: border-box;"><strong style="box-sizing: border-box;">情况二：</strong><br style="box-sizing: border-box;">屁民乙(Client)到某个议员(ZKServer)那里要求政府归还欠他的一万元钱，议员让他在办公室等着，自己将问题反映给了总统，总统询问所有议员的意见，多数议员表示欠屁民的钱一定要还，于是总统发表声明，从国库中拿出一万元还债，国库总资产由100万变成99万。屁民乙拿到钱回去了(Client函数返回)。<br style="box-sizing: border-box;"><strong style="box-sizing: border-box;">情况三：<br style="box-sizing: border-box;"></strong>总统突然挂了，议员接二连三的发现联系不上总统，于是各自发表声明，推选新的总统，总统大选期间政府停业，拒绝屁民的请求。<br style="box-sizing: border-box;">呵呵，到此为止吧，当然还有很多其他的情况，但这些情况总是能在Paxos的算法中找到原型并加以解决。这也正是我们认为Paxos是Zookeeper的灵魂的原因。当然ZKServer还有很多属于自己特性的东西：Session,Watcher，Version等等，需要我们花更多的时间去研究和学习。</p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 15px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">欢迎加入飞总的小密圈，小密圈正在邀请领域大牛行业大咖作为嘉宾入驻</strong><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><img src="/feiitworld/images/c364b97df97887524f481d17451f5c8bf1615721.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 640px !important; height: 932px !important;"></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 15px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;">非常感谢大数据研习社授权转载本文。</p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 10px 0% 0px;  box-sizing: border-box; "><section class="" style="text-align: justify; font-size: 16px; line-height: 1.9; letter-spacing: 1px; padding: 0px 20px; box-sizing: border-box;"><p style="text-align: center; white-space: normal; margin: 0px; padding: 0px; box-sizing: border-box;">赞赏二维码</p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><img src="/feiitworld/images/a1c01b7edf70d98a2091a6da8629612e76f4490f.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 640px !important; height: 624px !important;"></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="display: inline-block; width: 100%; vertical-align: top; box-sizing: border-box;"><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin: 10px 0%;  box-sizing: border-box; "><img src="/feiitworld/images/e167ac491157b1876062b9aeef3e035ffb6dc1a2.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 77px !important; height: 65.383px !important;"></section></section></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="display: inline-block; vertical-align: top; width: 38.2%; box-sizing: border-box;"><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" text-align: center; margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><img src="/feiitworld/images/d0a96cb599aa092121e2808dcf30249553c0ffd6.jpeg" style="max-width: 100%; vertical-align: middle; box-sizing: border-box; width: 294px !important; height: 294px !important;"></section></section></section><section class="" style="display: inline-block; vertical-align: top; width: 60%; box-sizing: border-box;"><section class="" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="line-height: 2; box-sizing: border-box;"><p style="margin: 0px; padding: 0px; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 0.5em 0px;  box-sizing: border-box; "><section class="" style="background-color: rgb(226, 223, 223); height: 1px; box-sizing: border-box;"></section></section></section><section class="" style="box-sizing: border-box;" powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="font-size: 11px; color: rgb(79, 79, 86); box-sizing: border-box;"><p style="margin: 0px; padding: 0px; box-sizing: border-box;"><strong style="box-sizing: border-box;">飞总聊IT</strong></p><p style="margin: 0px; padding: 0px; box-sizing: border-box;"><span style="font-size: 8px; box-sizing: border-box;">IT八卦，大数据风云，业界动态，职场风波</span></p><p style="margin: 0px; padding: 0px; box-sizing: border-box;"><span style="font-size: 8px; letter-spacing: 0px; box-sizing: border-box;">咨询，问题，合作垂询：feizongitworld@gmail.com</span><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin: 0.5em 0px;  box-sizing: border-box; "><section class="" style="background-color: rgb(226, 223, 223); height: 1px; box-sizing: border-box;"></section></section></section></section></section></section></section><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1494425729&src=3&ver=1&signature=T3pUTKCUVTFXYE3cOj0PN**Ah0Pztul9eEG1vIHB28YHFOdQpfoj*4*L5Z-MwUMCmrtzgOsGkeMGyoa3ck9uqEUmYk4I4Uiv**7BZcz33z53KNawGvVJsv5NbQUdQycMNZUm95EakRW9K6jcslJSHQMfdXH8RLuYsflzWSaAuFw=">微信地址</a>
{% endraw  %}

