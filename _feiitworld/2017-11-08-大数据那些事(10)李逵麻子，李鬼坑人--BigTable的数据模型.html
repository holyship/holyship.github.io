---
title: '大数据那些事(10):李逵麻子，李鬼坑人--BigTable的数据模型'
author: 飞总
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512886720&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKAVqG3uyRr7Up0mX-9moatw0YAWxZv5QX0DeeOqZo8zQEvh*imFnqx5zuBXdDaPFTEzVMWPywLJkTF6o1v98yxqXe09rE8re-s57wSHkXu2QgeEPupJ56QRwu8ulYn3nF5Ghy4quu3rUaFEupBDhWx0=
date: '2017-11-08 00:00:00 +0000'

---

{% raw  %}
<p style="white-space: normal;text-indent: 2em;">今天我们回归技术路线，讲讲Google三驾马车里的BigTable。以前有个说法叫做麻子不叫麻子，叫坑人。取其原意是满脸是坑的人，谐音表示人被坑了。我们知道水浒里面有李鬼装李逵然后遇到真李逵的段子。BigTable这篇论文非常的难懂，很大程度上是因为它选择了一些名为李逵实为李鬼的名字来装饰自己，从而使得通俗易懂的数据模型变得奇葩起来。<br></p><p style="white-space: normal;"><br></p><p style="white-space: normal;text-indent: 2em;">Google三架马车里面，唯独BigTable写得高深难懂，很多时候其实是你首先要理解BigTable里面的一些名字的基本概念。因为BigTable借用了很多的关系数据库的术语来表示并非是关系数据库的东西，所以我们的理解就似是而非了。<span style="text-indent: 2em;">这篇文章我们先聊一聊BigTable的数据模型。下一篇文章我们再仔细谈BigTable的实现。</span></p><p style="white-space: normal;text-indent: 2em;"><br></p><p style="white-space: normal;text-indent: 2em;">关于这个数据模型我一直很困惑，一知半解，直到某天读了一篇文章：Understanding HBase and BigTable，顿时有豁然开朗的感觉。本文的数据模型部分很大程度上是我理解了这篇文章以后自己的一个小结，强烈建议大家再把这篇文章翻出来读一读。<br></p><p style="white-space: normal;text-indent: 2em;"><mpcpc js_editor_cpcad="" class="" data-category_id_list="12|15|14|17|16|8|9|10|24|37|11|35|29|25|7|26|5" src="/cgi-bin/readtemplate?t=tmpl/cpc_tmpl" style="display: none;"></mpcpc></p><p style="white-space: normal;text-indent: 2em;">BigTable的论文是这样解释BigTable的：</p><p style="white-space: normal;text-indent: 2em;">A BigTable is a sparse, distributed, persistent multidimensional sorted map.</p><p style="white-space: normal;text-indent: 2em;">大家注意一下，BigTable是一个Map不是一个Table。所以一开始就给带到沟里去了，你想象一个有行有列的table的时候，对方告诉你其实就是Map。 Map是什么，学过数据结构的都知道。C++有 map和unordered_map， Java有TreeMap HashMap。说白了map就是有key有value的KV store。这就是为什么BigTable被叫做key-value store的原因。其实我觉得干脆改名叫BigMap大家估计就没那么糊涂了。Map叫Table，就和李鬼叫李逵区别不大，只有坑人的份。所以下面开始我就用BigMap来称呼。</p><p style="white-space: normal;text-indent: 2em;"><br></p><p style="white-space: normal;text-indent: 2em;">我们继续看看这个map是什么样的，map的value很简单，是个string。Key就比较复杂了，它是一个复合key&lt;key1, key2, key3&gt;.其中这几个key的名字分别如下：</p><p style="white-space: normal;text-indent: 2em;">key1： row</p><p style="white-space: normal;text-indent: 2em;">key2： column</p><p style="white-space: normal;text-indent: 2em;">key3：timestamp</p><p style="white-space: normal;text-indent: 2em;"><br></p><p style="white-space: normal;text-indent: 2em;">所以我们知道为什么又一次坑爹了，因为在一个正常的Table里面的row和column到这里变成了key的一部分。在BigTable里，key3是个64bit的number，key1和key2分别是string。key1是很单纯的string，而key2则复杂一点，key2的组成如下</p><p style="white-space: normal;text-indent: 2em;">key2prefix：postfix</p><p style="white-space: normal;text-indent: 2em;">key2prefix叫做column family，和postfix一起组成完整的key，column family在每个BigMap里面有有限个，但是那个postfix其实可以有无数多个。我这里用key1，key2，key3是希望大家不要再去联想那个有行有列的对我们非常熟悉的关系数据库里面的表。说白了，就是key和value的一个很简单的数据模型。</p><p style="white-space: normal;text-indent: 2em;"><br></p><p style="white-space: normal;text-indent: 2em;">我们再看看这个定义：</p><p style="white-space: normal;text-indent: 2em;">Sorted：这个好理解了，BigMap是个sortedMap，不是个HashMap。这一点不同于Amazon的Dynamo，另外一个非常著名的Key-Value store。具体来讲是sort在key1和key2的顺序，而key3的timestamp则从大排到小。要注意的是，虽然说key3被称为timestamp，实际上按照论文的说法，你可以自己随便指定值，而不是非得要当前的timestamp。</p><p style="white-space: normal;text-indent: 2em;"><span style="text-indent: 2em;">Persistent：这个也好理解。这个Map不会因为断了电，机器挂了之类的数据就丢失了。</span><br></p><p style="white-space: normal;text-indent: 2em;"><span style="text-indent: 2em;">Sparse：说白了这个Map非常的sparse，不像我们理解的关系数据库里面的表那样，每个行列组成的格子里面都有值。</span><br></p><p style="white-space: normal;text-indent: 2em;"><br></p><p style="white-space: normal;text-indent: 2em;">对BigTable进行查找主要有几种方式：</p><ol class="list-paddingleft-2" style=""><li><p style="text-indent: 0em;">给key1，key2，key3，返回的是小于或者等于key3的那个最大的数据。</p></li><li><p style="text-indent: 0em;">给了key1和key2，返回是key3值最高的那个数据。</p></li><li><p style="text-indent: 0em;">key2可以只给prefix，返回所有prefix符合的值。</p><p style="text-indent: 0em;"><br></p></li></ol><p style="white-space: normal;text-indent: 2em;">从上述查询来看，其实key3叫timestamp还算合理，但是key1和key2分别叫row和column则有些坑爹，加上整个Map又被叫成了Table，所以我读的时候总是会联想到那个关系数据库里面行列组成的Table，于是在理解数据模型的时候就被带到沟里了。等我终于理解以后，我真有一种特别想骂人的感觉。所以取名很重要，不会因为黄小明改名成黄晓明就变成帅哥的。</p><section class="" powered-by="xiumi.us" style="white-space: normal;box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><section class="" style="text-align: center;font-size: 18px;line-height: 2;letter-spacing: 1px;box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">打赏专用二维码</strong></p></section></section></section><p><br></p><section class="" powered-by="xiumi.us" style="white-space: normal;box-sizing: border-box;"><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><p style="max-width: 100%;vertical-align: middle;display: inline-block;box-sizing: border-box;text-indent: 0em;text-align: left;overflow: hidden !important;"><img src="http://mmbiz.qpic.cn/mmbiz_png/e8uayZybZ7JPxkqn0Kf8L7Ry9Arb80nj6lhRpsCvfewy89oGCVG4guibKeiaTZKyzxxp0H0XbRPA27DRnmIQmjeg/0?wx_fmt=png" style="vertical-align: middle; box-sizing: border-box; width: 90px !important; height: 118.828px !important;"><strong>近期更新：</strong></p></section><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><p style="max-width: 100%;vertical-align: middle;display: inline-block;box-sizing: border-box;text-indent: 0em;text-align: left;overflow: hidden !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484613&amp;idx=1&amp;sn=fd28264f36074df63ee8d088bbfd5f3c&amp;chksm=ec96de8edbe15798f163f97417452e9583f999a2242bf20b91b28499566035f014ee673ae1b6&amp;scene=21#wechat_redirect" target="_blank"><strong>正本清源还是个人偏见：聊聊朱松存教授的人工智能雄文</strong></a><br></p></section><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><p style="max-width: 100%;vertical-align: middle;display: inline-block;box-sizing: border-box;text-indent: 0em;text-align: left;overflow: hidden !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484608&amp;idx=1&amp;sn=9efdc26afd502a61528b202b8fc720e2&amp;chksm=ec96de8bdbe1579d15da862088bef16b6f9b91f101644688bd8506d141d74621dfa231390c1a&amp;scene=21#wechat_redirect" target="_blank"><strong>卡夫卡长大了--写在Kafka1.0.0发布之际</strong></a><br></p></section><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><p style="max-width: 100%;vertical-align: middle;display: inline-block;box-sizing: border-box;text-indent: 0em;text-align: left;overflow: hidden !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484602&amp;idx=1&amp;sn=d43a20dd0b9367f9ad176d5ba999d217&amp;chksm=ec96def1dbe157e774ef9bff69d63e8de4629bfac84622460514e597f042e6c60d1c53d8a29b&amp;scene=21#wechat_redirect" target="_blank"><strong>思维的惰性</strong></a><br></p></section><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><p style="max-width: 100%;vertical-align: middle;display: inline-block;box-sizing: border-box;text-indent: 0em;text-align: left;overflow: hidden !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzI5OTM3MjMyNA==&amp;mid=2247484598&amp;idx=1&amp;sn=c9aed635319ef48aa4a08d8a913a3502&amp;chksm=ec96defddbe157eb0a2b937daaf11192bdd7e7540c82cbe71222ac0e2e004dda647cb6fa2419&amp;scene=21#wechat_redirect" target="_blank"><strong>RealNetworks：一个帝国的兴衰（上）</strong></a><br></p></section><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><p style="max-width: 100%;vertical-align: middle;display: inline-block;box-sizing: border-box;overflow: hidden !important;"><br></p></section><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/e8uayZybZ7K6l5Te80Y0A5c3DWGIzRnM9vzAsQZTfrETJ3Cc7PMXwps0guicqVnS8W7eJ669xr0rrJoSOQHkJtg/0?wx_fmt=jpeg" style="width: 626px !important; height: 649px !important;"></p><p style="max-width: 100%;vertical-align: middle;display: inline-block;box-sizing: border-box;overflow: hidden !important;"><br></p></section></section><section class="" powered-by="xiumi.us" style="white-space: normal;box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><section class="" style="display: inline-block;width: 556px;vertical-align: top;box-sizing: border-box;"><section class="" powered-by="xiumi.us" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" powered-by="xiumi.us" style="box-sizing: border-box;"><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><section class="" style="max-width: 100%;vertical-align: middle;display: inline-block;width: 55.6px;box-sizing: border-box;overflow: hidden !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/qtwdTjayLdWuJtms1rnkqQD8JibicUwnwhDEHeBx4vaDw2ItnYPmdcSxRVptlSWsG2h8od4ZRFVfeuXPFCzfh0dg/0?wx_fmt=jpeg" style="vertical-align: middle; box-sizing: border-box; width: 55.5938px !important; height: 47.2063px !important;"></section></section></section><section class="" powered-by="xiumi.us" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" powered-by="xiumi.us" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><p style="box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section></section></section></section><section class="" powered-by="xiumi.us" style="white-space: normal;box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><section class="" style="display: inline-block;vertical-align: top;width: 212.387px;box-sizing: border-box;"><section class="" powered-by="xiumi.us" style="box-sizing: border-box;"><section class="" style="margin-top: 10px;margin-bottom: 10px;text-align: center;box-sizing: border-box;"><section class="" style="max-width: 100%;vertical-align: middle;display: inline-block;width: 212.387px;box-sizing: border-box;overflow: hidden !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/e8uayZybZ7JPxkqn0Kf8L7Ry9Arb80njF2MBxj1XibHPoQicOETb5vaJ7syD9ceDRELlicB8W5epN9I7fowmg1pnA/0?wx_fmt=jpeg" style="vertical-align: middle; box-sizing: border-box; width: 212px !important; height: 212px !important;"></section></section></section></section><section class="" style="display: inline-block;vertical-align: top;width: 333.6px;box-sizing: border-box;"><section class="" powered-by="xiumi.us" style="box-sizing: border-box;"><section class="" style="margin-top: 0.5em;margin-bottom: 0.5em;box-sizing: border-box;"><section class="" style="background-color: rgb(226, 223, 223);height: 1px;box-sizing: border-box;"></section></section></section><section class="" powered-by="xiumi.us" style="box-sizing: border-box;"><section class="" style="box-sizing: border-box;"><section class="" style="font-size: 15px;color: rgb(79, 79, 86);box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">飞总聊IT</strong></p><p style="box-sizing: border-box;"><span style="font-size: 11px;box-sizing: border-box;">IT八卦，大数据风云，职场风波</span></p><p style="box-sizing: border-box;"><span style="font-size: 11px;box-sizing: border-box;">长按二维码订阅</span></p><p style="box-sizing: border-box;"><span style="font-size: 11px;box-sizing: border-box;">合作垂询：feizongitworld@gmail.com</span></p></section></section></section></section></section></section><p><br></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512886720&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKAVqG3uyRr7Up0mX-9moatw0YAWxZv5QX0DeeOqZo8zQEvh*imFnqx5zuBXdDaPFTEzVMWPywLJkTF6o1v98yxqXe09rE8re-s57wSHkXu2QgeEPupJ56QRwu8ulYn3nF5Ghy4quu3rUaFEupBDhWx0=">微信地址</a>
{% endraw  %}

