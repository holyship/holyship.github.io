---
title: CA，给了数据库，给了机器，为啥也扩不了容？
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-*unZla4xW9axOAqX40TB4xY-jiZp70NDSgrWfT4FJUtsBTtyN8w2QngUdsZVfsGMCw9vUGMVMxImVWU20pYRSI=
date: '2017-11-28 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;letter-spacing: 1px;">随着业务越来越复杂，数据量越来越大，并发量越来越大，数据库的性能越来越低。好不容易找运维申请了两台机器，让DBA部署了几个实例，想把一些业务库拆分出来，却发现拆不出来，扩不了容，尴尬！</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">因为数据库强关联在一起，无法通过增加数据库实例扩容，就是一个耦合的典型案例。</span></strong></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">场景还原</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">有一个公共用户数据库DB_USER，里面table_user存放了<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">通用的用户数据</span>：</span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="letter-spacing: 1px;font-size: 12px;">table_user (<span style="letter-spacing: 1px;font-size: 12px;">uid</span>, name, passwd, …)</span></em></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">在数据量比较小，并发量比较小，业务还没有这么复杂的时候，为了提高资源利用率（程序员才没有考虑什么资源利用率，更多的是图方便），业务A把<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">用户个性化的数</span>据也放在这个库里：</span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="letter-spacing: 1px;font-size: 12px;">table_A(<span style="letter-spacing: 1px;font-size: 12px;">uid</span>, A业务的个性化属性)</span></em></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">业务A有一个需求，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">即要展现用户公共属性，又要展现业务A个性化属性</span>，程序员经常这么实现的：</span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="letter-spacing: 1px;font-size: 12px;">select * from table_user, table_A</span></em></span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="color: rgb(0, 82, 255);letter-spacing: 1px;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; where table_user.uid = table_A.uid</span></em></span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="color: rgb(0, 82, 255);letter-spacing: 1px;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and table_user.uid = $uid</span></em></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">初期关联查询没有任何问题，单条记录访问，命中索引，一次查询所有数据，简单高效。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">如何产生各业务数据耦合？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">通过join实现业务，导致通用表table_user和业务表table_A必须存在于一个数据库实例里。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"></span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOycklag15ia3xJzuSMfPkWJ80Iuia0j3hgeDaK4nt9CJCP7wu8eFkSeYuicbJYZN0Fd9ZBx4iaeOXzOIA/0?wx_fmt=png" style="width: 555px !important; height: 270px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">如果业务B也这么做，业务C也这么做，会导致<strong>公用业务，业务A，业务B，业务C都<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">必须存在于一个数据库实例</span>里</strong>。</span></p><p><br></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">会产生什么潜在问题呢？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">假如A业务线上线了一个新功能，不小心进行了全表扫描，导致数据库CPU100%，数据库实例性能下降，由于实例共用，通用业务，业务B和业务C都会受影响。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">即某个业务线的数据库性能急剧下降导致所有业务都受影响，这种耦合，历史总是惊人的相似：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务B的大boss</span></strong><span style="font-size: 14px;letter-spacing: 1px;">在群里首先发飙：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">技术都干啥了，怎么系统挂了</span>” </span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务B的rd</span></strong><span style="font-size: 14px;letter-spacing: 1px;">一脸无辜：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">业务A上线了，所以我们挂了</span>”</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">额，然而，这个理由，好像在大boss那解释不通…</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务B的大boss</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">赶紧加几台机器，拆分开</span>”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务B的rd</span></strong><span style="font-size: 14px;letter-spacing: 1px;">一脸无奈：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">加机器加实例也扩容不了</span>”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务B的大boss</span></strong><span style="font-size: 14px;letter-spacing: 1px;">对业务2的rd吼道“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">还想甩锅，拖出去祭天</span>”</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">... <br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">唉，加了几台机器，加了几个实例，然而并没有什么卵用，都耦合在一个实例里，完全扩不了容。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">那，如何解除公共数据库与业务数据库的耦合？</span></strong></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">第一步：公共数据访问下沉<span style="letter-spacing: 1px;color: rgb(255, 76, 0);font-size: 16px;">服务化</span></span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOycklag15ia3xJzuSMfPkWJ8LzZZjh7wiaAdutVJo1zWNiaMeKmiaeObew2fNEDj5DUPt8FURjd1cFUEg/0?wx_fmt=png" style="width: 555px !important; height: 214px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">还是上面的例子，当公共的user数据访问服务化之后，依据服务化的原则：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p><span style="font-size: 14px;letter-spacing: 1px;">业务层只能通过服务RPC接口访问数据</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">底层user库属于user服务私有</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">任何上游不允许跨过服务访问底层的user库</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">第二步：<span style="letter-spacing: 1px;color: rgb(255, 76, 0);font-size: 16px;">垂直拆分</span>，个性化数据访问上浮</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">原来业务方：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p><span style="font-size: 14px;letter-spacing: 1px;">通过join一次性获取通用的数据和个性化的业务数据数据</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">服务化+垂直拆分后，变成两次访问：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p><span style="font-size: 14px;letter-spacing: 1px;">一次取得业务数据（业务可以直接调用自己的数据库，也可以自己做业务服务调用RPC接口）</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">一次取得共性数据（调用通用的RPC接口）</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">两种方式相比：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">之前的方式</span></strong><span style="font-size: 14px;letter-spacing: 1px;">其实<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">业务代码可能会更简单一些</span>，因为它是将这个业务逻辑放在了SQL语句中，但是导致<strong>数据库耦合</strong>在了一起</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">后面这种方式</span></strong><span style="font-size: 14px;letter-spacing: 1px;">就是<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">业务的代码会更复杂</span>，会变成多次访问，将<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">原来在SQL中进行的逻辑计算变成业务代码中的逻辑计算<span style="font-size: 14px;letter-spacing: 1px;color: rgb(0, 0, 0);">，但是<strong>数据库解耦了</strong></span></span></span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">业务复杂，数据量大，并发老大，对扩展性要求更高的架构，一定是后者。<br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">此时各业务有自己的库，公共有公共的库：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">早期</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：可以放在一个数据库实例里</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">后期</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：可以很容易地通过新增数据库实例，把user库或者业务A/B/C的库拆分出来，实现<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">增加机器增加实例就实现扩容</span></span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">个性业务数据访问<span style="font-size: 16px;letter-spacing: 1px;color: rgb(255, 76, 0);">垂直拆分</span>，共性数据访问<span style="font-size: 16px;letter-spacing: 1px;color: rgb(255, 76, 0);">服务化</span>下沉</span></strong></span><span style="font-size: 14px;letter-spacing: 1px;">，只是一个很小的优化点，但对于<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">数据库解耦</span>却是非常的有效。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">希望大家每天收获一点点，这样架构就能美好一点点。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">你痛过吗，你见过一个库里耦合了几百个表吗？那帮<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">转</span>下。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">相关文章：</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960643&amp;idx=1&amp;sn=adb2660bc1a367e118d0a3a799a312fa&amp;chksm=bd2d009f8a5a898917ebe65caf0dc31d3f257594d5c18a468ebef344877b64e989ee292bf22e&amp;scene=21#wechat_redirect" target="_blank">小小的IP，大大的耦合，你痛过吗？</a><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960650&amp;idx=1&amp;sn=7c63fdc50a130e1d9fc3e5b6791ce01f&amp;chksm=bd2d00968a5a89801861bd1665ad60fe240b5ff3d6eab984e70938d9cfd6502aca8de5686e0c&amp;scene=21#wechat_redirect" target="_blank">小小的公共库，大大的耦合，你痛过吗？</a><br></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-*unZla4xW9axOAqX40TB4xY-jiZp70NDSgrWfT4FJUtsBTtyN8w2QngUdsZVfsGMCw9vUGMVMxImVWU20pYRSI=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960650&amp;idx=1&amp;sn=7c63fdc50a130e1d9fc3e5b6791ce01f&amp;chksm=bd2d00968a5a89801861bd1665ad60fe240b5ff3d6eab984e70938d9cfd6502aca8de5686e0c#rd">阅读原文</a>
{% endraw  %}

