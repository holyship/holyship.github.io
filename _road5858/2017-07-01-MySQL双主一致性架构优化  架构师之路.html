---
title: MySQL双主一致性架构优化 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499131416&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ2C-mFRC1Hh3Dphb3zLBkqij4Jaanumtg17LZBDShHzuc5xEdFWfukz5FMlV5a5dB1FA2uQuFVU0pucyAYSy3obbJtAgxawrgfqM1*W-Wsqec-nxPsavrHtJ-*SvNqbMcXuiS5lceU0YoFxJeZjOiJ4=
date: '2017-07-01 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 18px;"><strong><span style="font-family: 等线;">一、双主保证高可用</span></strong></span></p><p><span style="font-family: 等线; font-size: 14px;">MySQL数据库集群常使用<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">一主多从，主从同步，读写分离</span>的方式来扩充数据库的读性能，保证读库的高可用，但此时写库仍然是单点。</span></p><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 等线; font-size: 14px;">在一个MySQL数据库集群中可以设置两个主库，并设置双向同步，以<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">冗余写库的方式来保证写库的高可用</span>。</span></p><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 等线;">二、并发引发不一致</span></strong></span></p><p><span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">数据冗余会引发数据的一致性问题</span><span style="font-family: 等线; font-size: 14px;">，因为数据的同步有一个时间差，并发的写入可能导致数据同步失败，引起数据丢失：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxW0Cq26svdRgDDRyISwFtav1Kpa0icpeHDGqeT4p7e2ln3CKDwvxrVzSZQpxyJoLZtwMVibTyBS6VA/0?wx_fmt=png" style="width: 770px !important; height: 439.709px !important; visibility: visible !important;"></p><p><span style="font-family: 等线; font-size: 14px;">如上图所述，假设主库使用了auto increment来作为自增主键：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 等线; font-size: 14px;">两个MySQL-master设置双向同步可以用来保证主库的高可用</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">数据库中现存的记录主键是1，2，3</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">主库1插入了一条记录，主键为4，并向主库2同步数据</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">数据同步成功之前，主库2也插入了一条记录，由于数据还没有同步成功，插入记录生成的主键也为4，并向主库1也同步数据</span></p></li><li><p><span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">主库1和主库2都插入了主键为4的记录，双主同步失败</span><span style="font-family: 等线; font-size: 14px;">，数据不一致</span></p></li></ul><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 等线;">三、相同步长免冲突</span></strong></span></p><p><strong><span style="font-family: 等线; font-size: 14px;">能否保证两个主库生成的主键一定不冲突呢？</span></strong></p><p><strong><span style="font-family: 等线; font-size: 14px;">回答</span></strong><span style="font-family: 等线; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 等线; font-size: 14px;">设置<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">不同的初始值</span></span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">设置<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">相同的增长步长</span></span></p></li></ul><p><span style="font-family: 等线; font-size: 14px;">就能够做到。</span></p><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxW0Cq26svdRgDDRyISwFtaia6ybGKQOcT6NGQo0PMjAInDGFqkfKEiaZnqkia0psj8uDib5HNbgFYwJA/0?wx_fmt=png" style="width: 770px !important; height: 406.576px !important;"></p><p><span style="font-family: 等线; font-size: 14px;">如上图所示：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 等线; font-size: 14px;">两个MySQL-master设置双向同步可以用来保证主库的高可用</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">库1的自增初始值是1，库2的自增初始值是2，增长步长都为2</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">库1中插入数据主键为1/3/5/7，库2中插入数据主键为2/4/6/8，不冲突</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">数据双向同步后，两个主库会包含全部数据</span></p></li></ul><p><span style="font-family: 等线; font-size: 14px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxW0Cq26svdRgDDRyISwFtaxx42d4grHM8DTiaWQjBBLnicIuILuW4O4omXV0EUZYvSQ2zE8lLYg4Zg/0?wx_fmt=png" style="width: 770px !important; height: 424.147px !important;"></p><p><span style="font-family: 等线; font-size: 14px;">如上图所示，两个主库最终都将包含1/2/3/4/5/6/7/8所有数据，即使有一个主库挂了，另一个主库也能够保证写库的高可用。</span></p><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 等线;">四、上游生成ID避冲突</span></strong></span></p><p><strong><span style="font-family: 等线; font-size: 14px;">换一个思路，为何要依赖于数据库的自增ID，来保证数据的一致性呢？</span></strong></p><p><span style="font-family: 等线; font-size: 14px;">完全可以由<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">业务上游，使用统一的ID生成器，来保证ID的生成不冲突</span>：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxW0Cq26svdRgDDRyISwFtaiabcscloibjFv9Vv64niaDoV7iaD8DuazU24pUHtUBgxrEmicm6vnMAO3dA/0?wx_fmt=png" style="width: 770px !important; height: 271.653px !important;"></p><p><span style="font-family: 等线; font-size: 14px;">如上图所示，调用方插入数据时，带入全局唯一ID，而不依赖于数据库的auto increment，也能解决这个问题。</span></p><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 等线; font-size: 14px;">至于如何生成全局唯一，趋势递增的ID，参见文章《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960245&amp;idx=1&amp;sn=5cef3d8ca6a3e6e94f61e0edaf985d11&amp;chksm=bd2d06698a5a8f7fc89056af619b9b7e79b158bceb91bdeb776475bc686721e36fb925904a67&amp;scene=21#wechat_redirect" target="_blank">分布式ID生成算法</a>》。</span></p><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 等线;">五、消除双写不治本</span></strong></span></p><p><span style="font-family: 等线; font-size: 14px;">使用auto increment两个主库并发写可能导致数据不一致，<strong>只使用一个主库提供服务</strong>，另一个主库作为shadow-master，只用来保证高可用，能否避免一致性问题呢？</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxW0Cq26svdRgDDRyISwFtamIOswOa7TCew2zb0A1ianJcTfE4oZWx1Hmkd9anDrfbEnmdicGTfFY0g/0?wx_fmt=png" style="width: 770px !important; height: 315.3px !important;"></p><p><span style="font-family: 等线; font-size: 14px;">如上图所示：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 等线; font-size: 14px;">两个MySQL-master设置双向同步可以用来保证主库的高可用</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">只有主库1对外提供写入服务</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">两个主库设置相同的虚IP，在主库1挂掉或者网络异常的时候，虚IP自动漂移，shadow master顶上，保证主库的高可用</span></p></li></ul><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 等线; font-size: 14px;">这个切换由于虚IP没有变化，所以切换过程对调用方是透明的，但在极限的情况下，也可能引发数据的不一致：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxW0Cq26svdRgDDRyISwFtaJcbqicRRQVEkJss7whmzQGsqP3a91mfkh8CDlxWLwxov3ibibyI8b5w8g/0?wx_fmt=png" style="width: 770px !important; height: 359.3px !important;"></p><p><span style="font-family: 等线; font-size: 14px;">如上图所示：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 等线; font-size: 14px;">两个MySQL-master设置双向同步可以用来保证主库的高可用，并设置了相同的虚IP</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">网络抖动前，主库1对上游提供写入服务，插入了一条记录，主键为4，并向shadow master主库2同步数据</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">突然主库1网络异常，keepalived检测出异常后，实施虚IP漂移，主库2开始提供服务</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">在主键4的数据同步成功之前，主库2插入了一条记录，也生成了主键为4的记录，结果导致数据不一致</span></p></li></ul><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 等线;">六、内网DNS探测</span></strong></span></p><p><span style="font-family: 等线; font-size: 14px;">虚IP漂移，双主同步延时导致的数据不一致，本质上，<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">需要在双主同步完数据之后，再实施虚IP偏移</span>，使用内网DNS探测，可以实现shadow master延时高可用：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 等线; font-size: 14px;">使<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">用内网域名连接数据库</span>，例如：db.58daojia.org</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">主库1和主库2设置双主同步，不使用相同虚IP，而是分别使用ip1和ip2</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">一开始db.58daojia.org指向ip1</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">用一个<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">小脚本轮询探测ip1主库的连通性</span></span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">当ip1主库发生异常时，小脚本delay一个x秒的延时，等待主库2同步完数据之后，再将db.58daojia.org解析到ip2</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">程序以内网域名进行重连，即可自动连接到ip2主库，并保证了数据的一致性</span></p></li></ul><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 等线;">七、总结</span></strong></span></p><p><span style="font-family: 等线; font-size: 14px;">主库高可用，主库一致性，一些小技巧：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">双主同步</span><span style="font-family: 等线; font-size: 14px;">是一种常见的保证写库高可用的方式</span></p></li><li><p><span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">设置相同步长，不同初始值</span><span style="font-family: 等线; font-size: 14px;">，可以避免auto increment生成冲突主键</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">不依赖数据库，<span style="color: rgb(255, 76, 0); font-family: 等线; font-size: 14px;">业务调用方自己生成全局唯一ID</span>是一个好方法</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">shadow master保证写库高可用，只有一个写库提供服务，并不能完全保证一致性</span></p></li><li><p><span style="font-family: 等线; font-size: 14px;">内网DNS探测，可以实现在主库1出现问题后，延时一个时间，再进行主库切换，以保证数据一致性</span></p></li></ul><p><span style="font-family: 等线; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 等线; font-size: 14px;">相关文章：</span></p><p><span style="font-family: 等线; font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959728&amp;idx=1&amp;sn=933227840ec8cdc35d3a33ae3fe97ec5&amp;chksm=bd2d046c8a5a8d7a13551124af36bedf68f7a6e31f6f32828678d2adb108b86b7e08c678f22f&amp;scene=21#wechat_redirect" target="_blank">究竟啥才是互联网架构“高可用”</a></span></p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960245&amp;idx=1&amp;sn=5cef3d8ca6a3e6e94f61e0edaf985d11&amp;chksm=bd2d06698a5a8f7fc89056af619b9b7e79b158bceb91bdeb776475bc686721e36fb925904a67&amp;scene=21#wechat_redirect" target="_blank"><span style="font-family: 等线; font-size: 14px;">分布式ID生产算法</span></a><span style="font-family: 等线; font-size: 14px;"></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499131416&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ2C-mFRC1Hh3Dphb3zLBkqij4Jaanumtg17LZBDShHzuc5xEdFWfukz5FMlV5a5dB1FA2uQuFVU0pucyAYSy3obbJtAgxawrgfqM1*W-Wsqec-nxPsavrHtJ-*SvNqbMcXuiS5lceU0YoFxJeZjOiJ4=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960245&amp;idx=1&amp;sn=5cef3d8ca6a3e6e94f61e0edaf985d11&amp;chksm=bd2d06698a5a8f7fc89056af619b9b7e79b158bceb91bdeb776475bc686721e36fb925904a67#rd">阅读原文</a>
{% endraw  %}

