---
title: 服务通过缓存传递数据，绝不推荐
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1515986097&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siBo3oPDK8DK*88F4CWijxQ5EFX6jGrv3BrjQoFMwQzo-*jiN8gkDoGNv71FTxFvM1NI7yR1cTECLM1kV6d4JNUX3rpz9e5V5vfBzSux1DjObwXSHwukPfhhPz*OTj1I2ocmu-orUaY7phDimVteh3Rw=
date: '2017-12-28 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;letter-spacing: 1px;">《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960768&amp;idx=1&amp;sn=7a10095e20208e2cb6ac2ce68f1bbd27&amp;chksm=bd2d001c8a5a890a8db2f512ad85ddb860d8dbe0ca99afdc2af9a7eb0dc4620160111c53a26b&amp;scene=21#wechat_redirect" target="_blank">服务通过缓存传递数据，是否可行</a>》一文引发一个服务之间“通过缓存传递数据”设计合理性的讨论。</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzdicvWyBDjciaup1P7sy4FZicvwKojfzQFlrKUKw4NicjjJnEHar3aYW31fRicDlqoyv91ja8eL47ZSGg/0?wx_fmt=png" style="width: 305px !important; height: 90px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">如上图：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">service-A将数据放入cache</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">service-B从cache里读取数据</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">这种架构设计好还是不好，网友进行了激烈的讨论，感兴趣的同学可以看下《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960768&amp;idx=1&amp;sn=7a10095e20208e2cb6ac2ce68f1bbd27&amp;chksm=bd2d001c8a5a890a8db2f512ad85ddb860d8dbe0ca99afdc2af9a7eb0dc4620160111c53a26b&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 14px;letter-spacing: 1px;white-space: normal;">服务通过缓存传递数据，是否可行</a>》的评论，看到这么多互联网技术人对一个技术方案问题进行思考与探讨，很是开心。这里，分享下个人的观点。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;letter-spacing: 1px;"><strong>先说结论</strong></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">楼主旗帜鲜明的反对“服务之间通过缓存传递数据”。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;letter-spacing: 1px;"><strong>核心理由</strong></span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">一、数据管道场景，MQ比cache更加适合</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">如果只是单纯的将cache作为两个服务数据通讯的管道，service-A生产数据，service-B（当然，可能有service-C/service-D等）订阅数据，MQ比cache更加合适：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">MQ是互联网常见的逻辑解耦，物理解耦组件，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">支持1对1，1对多各种模式</span>，非常成熟的数据通道</span></p></li></ul><p><span style="color: rgb(0, 82, 255);"><em><span style="font-size: 14px;letter-spacing: 1px;">画外音：详见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960726&amp;idx=1&amp;sn=0fdaf0e7040318aabfeba553f815d691&amp;chksm=bd2d004a8a5a895ca80180443cc0f18e66b3d15dbbbd120dabaf3e6d4ef00fbc1030bf41c24b&amp;scene=21#wechat_redirect" target="_blank">MQ，互联网架构解耦神器</a>》</span></em></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">而cache反而会将service-A/B/C/D<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">耦合在一起</span>，大家要彼此协同约定key的格式，ip地址等</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">MQ能够支持push，而cache只能拉取，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">不实时，有时延</span></span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">MQ<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">天然支持集群，支持高可用</span>，而cache未必</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">MQ能<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">支持数据落地</span>，cache具备将数据存在内存里，具有“易失”性，当然，有些cache支持落地，但互联网技术选型的原则是，<strong>让专业的软件干专业的事情</strong>：nginx做反向代理，db做固化，cache做缓存，mq做通道</span></p></li></ul><p><img src="http://mmsns.qpic.cn/mmsns/YrezxckhYOzdicvWyBDjciaup1P7sy4FZicYYlIMo8Bkf23juH3Mo3Q1Q/0" style="width: 334px !important; height: 130px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">综上，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">数据管道场景，MQ比cache更加适合</span>。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">二、数据共管场景，两个(多个)service同时读写一个cache实例会导致耦合</span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzdicvWyBDjciaup1P7sy4FZic1MbgHUarFEb5ic2KyMiayQHUgXEyULbMr6LQM7iaBf0VoflF34RW4PYaQ/0?wx_fmt=png" style="width: 270px !important; height: 90px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">如果不是数据管道，是两个(多个)service对一个cache进行数据共管，同时读写，也是不推荐的，这些service会因为这个cache耦合在一起：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">大家要彼此协同约定key的格式，ip地址等，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">耦合</span></span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">约定好同一个key，可能会<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">产生数据覆盖，导致数据不一致</span></span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">不同服务业务模式，数据量，并发量不一样，会<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">因为一个cache相互影响</span>，例如service-A<strong>数据量大，占用了cache的绝大部分内存</strong>，会导致service-B的热数据全部被挤出cache，导致cache失效；又例如service-A<strong>并发量高，占用了cache的绝大部分连接</strong>，会导致service-B拿不到cache的连接，从而服务异常</span></p></li></ul><p><br></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzdicvWyBDjciaup1P7sy4FZicbp8Ly9kWOsnZRLNbj9SKSMCdGHxE2TurMnthMWMf3PqPjPMAMqTAag/0?wx_fmt=png" style="width: 271px !important; height: 93px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">综上，数据共管场景，多个service耦合在一个cache实例里，也是不推荐的，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">需要垂直拆分，实例解耦</span>。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">三、数据访问场景，两个(多个)service有读写一份数据的需求</span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzdicvWyBDjciaup1P7sy4FZicDnMVknpdt3rj8FCE9z2jgC0NwM1Oj6nlBCIOicv2V2JJIY5eBdyqxQw/0?wx_fmt=png" style="width: 249px !important; height: 90px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">根据服务化的原则，数据是私有的（本质也是解耦）：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">service层会<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">向数据的需求方屏蔽下层存储引擎，分库，chace的复杂性</span></span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">任何需求方<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">不能绕过service读写其后端的数据</span></span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzdicvWyBDjciaup1P7sy4FZica8fMnasIT9AyR7vOcn6ziay0SJCFJ6ibPkGfvlmZiaZDdO5usDNdUqc8A/0?wx_fmt=png" style="width: 308px !important; height: 158px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">假设有其他service要有数据获取的需求，应该<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">通过service提供的RPC接口来访问</span>，而不是直接读写后端的数据，无论是cache还是db。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">综上</span></strong></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">数据管道，MQ比cache更合适</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">多个服务不应该公用一个cache实例，应该垂直拆分解耦</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">服务化架构，不应该绕过service读取其后端的cache/db，而应该通过RPC接口访问</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">希望逻辑是清晰的，供大伙参考，</span><span style="font-size: 14px;letter-spacing: 1px;">欢迎不同的声音共同探讨</span><span style="font-size: 14px;letter-spacing: 1px;">。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1515986097&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siBo3oPDK8DK*88F4CWijxQ5EFX6jGrv3BrjQoFMwQzo-*jiN8gkDoGNv71FTxFvM1NI7yR1cTECLM1kV6d4JNUX3rpz9e5V5vfBzSux1DjObwXSHwukPfhhPz*OTj1I2ocmu-orUaY7phDimVteh3Rw=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960775&amp;idx=1&amp;sn=1a9c9f4b94dfe71ad2528fb2c84f5ec7&amp;chksm=bd2d001b8a5a890d302d139ea42e9ffde44407738a618865934e40b8e35486b13cafca2933f6#rd">阅读原文</a>
{% endraw  %}

