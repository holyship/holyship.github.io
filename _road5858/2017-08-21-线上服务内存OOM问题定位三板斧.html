---
title: 线上服务内存OOM问题定位三板斧
author: 58到家
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1503366049&src=3&ver=1&signature=OYewMZH60kmig22U24i7m6sKVnTwzt3UPW4YGe4v-5baZmWG6eeyYwlgndoMQvEZ2rCh6bD1GFvpiI6UKWdhjboZ97vl27*0C-H01Z5w1gxgvCHr*eXFGWc2nfVj8qnpWQS*GY0W3JFVAbB5oHcQ8nR8WBqAvJzZWNCgxJQhVxU=
date: '2017-08-21 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px; line-height: 1.6;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">相信大家都有感触，线上服务<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px; color: rgb(255, 76, 0);">内存OOM的问题</span>，是最难定位的问题，不过归根结底，最常见的原因：</span></span></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 14px; line-height: 1.6;"><span style="font-family: 宋体; line-height: 22.4px;">本身资源不够</span></span></p></li><li><p><span style="font-size: 14px; line-height: 1.6;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">申请的太多</span></span></p></li><li><p><span style="font-size: 14px; line-height: 1.6;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">资源耗尽</span></span></p></li></ul><ul class="list-paddingleft-2" style="list-style-type: disc;"></ul><p><span style="font-size: 14px; line-height: 1.6;"><br></span></p><p><span style="font-size: 14px; line-height: 1.6;">58</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">到家架构部，运维部，</span><span style="font-size: 14px; line-height: 1.6;">58</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">速运技术部联合进行了一次线上服务<strong>内存OOM问题</strong>排查实战演练，将<strong>内存OOM问题定位三板斧</strong>分享出来，希望对大家也有帮助。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">题目</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">某服务器上部署了</span>Java<span style="font-size: 14px; font-family: 宋体;">服务一枚，出现了</span>OutOfMemoryError<span style="font-size: 14px; font-family: 宋体;">，请问有可能是什么原因，问题应该如何定位？</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">不妨设服务进程</span>PID<span style="font-size: 14px; font-family: 宋体;">为</span>10765<span style="font-size: 14px; font-family: 宋体;">（没错，就是</span>CPU<span style="font-size: 14px; font-family: 宋体;">占用高的那个倒霉的进程《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960332&amp;idx=1&amp;sn=63cb23e04ac4bf926434f34001c0718a&amp;chksm=bd2d01d08a5a88c6a01e62533162cc3535defb37cefa61a800e405edda8240ad17432e023d53&amp;scene=21#wechat_redirect" target="_blank"><span style="font-size: 14px; font-family: 宋体;">线上服务</span>CPU100%<span style="font-size: 14px; font-family: 宋体;">问题快速定位实战</span></a><span style="font-size: 14px; font-family: 宋体;">》）。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">解决思路</span></strong></span></p><p><span style="font-size: 14px;">Java<span style="font-size: 14px; font-family: 宋体;">服务</span>OOM<span style="font-size: 14px; font-family: 宋体;">，最常见的原因为：</span></span></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体;">有可能是内存分配确实过小，而正常业务使用了大量内存</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">某一个对象被频繁申请，却没有释放，内存不断泄漏，导致内存耗尽</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">某一个资源被频繁申请，系统资源耗尽，例如：不断创建线程，不断发起网络连接</span></span></p></li></ul><ul class="list-paddingleft-2" style="list-style-type: disc;"></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">更具体的，可以使用以下的一些工具逐一排查。</span></p><p><span style="font-size: 14px;"></span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">一、确认是不是内存本身就分配过小</span></strong></span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 14px;"><span style="font-family: 宋体;">方法：</span><span style="font-size: 14px; color: rgb(255, 76, 0);">jmap </span>-heap 10765</span></p><p style="line-height: 25.6px; white-space: normal;"><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxiacnickoCpdKk29UN25JFBibgib9oCicicufurPH61ZgM9p7gDqtcdnvggavWQXeYPrWM2EtC5jTNFiaqw/0?wx_fmt=png" style="width: 770px !important; height: 1512.43px !important; visibility: visible !important;"></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-family: 宋体; font-size: 14px;">如上图，可以查看新生代，老生代堆内存的分配大小以及使用情况，看是否本身分配过小。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">二、找到最耗内存的对象</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">方法</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span><span style="font-size: 14px; color: rgb(255, 76, 0);">jmap</span> -histo:live 10765 | more</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">图示</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxiacnickoCpdKk29UN25JFBibuWcaZKwIrAjpSscVoy7FXF4RLGhdiakUkQdqPlnHsMBsI9myvBxo58Q/0?wx_fmt=png" style="width: 770px !important; height: 532.685px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">如上图，输入命令后，会以表格的形式显示存活对象的信息，并按照所占内存大小排序：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">实例数</span></span></strong></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">所占内存大小</span></span></strong></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">类名</span></span></strong></p></li></ul><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">是不是很直观？对于实例数较多，占用内存大小较多的实例</span>/<span style="font-size: 14px; font-family: 宋体;">类，相关的代码就要针对性</span>review<span style="font-size: 14px; font-family: 宋体;">了。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">上图中占内存最多的对象是</span>RingBufferLogEvent<span style="font-size: 14px; font-family: 宋体;">，共占用内存</span>18M<span style="font-size: 14px; font-family: 宋体;">，属于正常使用范围。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果发现某类对象占用内存很大（例如几个</span>G<span style="font-size: 14px; font-family: 宋体;">），很可能是类对象创建太多，且一直未释放。例如：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">申请完资源后，未调用</span>close()<span style="font-size: 14px; font-family: 宋体;">或</span>dispose()<span style="font-size: 14px; font-family: 宋体;">释放资源</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">消费者消费速度慢（或停止消费了），而生产者不断往队列中投递任务，导致队列中任务累积过多</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">三、确认是否是资源耗尽</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">工具：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; color: rgb(255, 76, 0);">pstree</span></p></li><li><p><span style="font-size: 14px; color: rgb(255, 76, 0);">netstat</span></p></li></ul><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">查看进程创建的线程数，以及网络连接数，如果资源耗尽，也可能出现</span>OOM<span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">这里介绍另一种方法，通过</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">/proc/${PID}/fd</span></p></li><li><p><span style="font-size: 14px;">/proc/${PID}/task</span></p></li></ul><p><span style="font-family: 宋体; font-size: 14px;">可以分别查看句柄详情和线程数。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">例如，某一台线上服务器的</span>sshd<span style="font-size: 14px; font-family: 宋体;">进程</span>PID<span style="font-size: 14px; font-family: 宋体;">是</span>9339<span style="font-size: 14px; font-family: 宋体;">，查看</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">ll /proc/9339/fd</span></p></li><li><p><span style="font-size: 14px;">ll /proc/9339/task</span></p></li></ul><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxiacnickoCpdKk29UN25JFBibBAiaMFLiaqPQtiah5SUuKhJ5VRcL01Q6TYOecnYPB943xZo7DN8Ejd3rg/0?wx_fmt=png" style="width: 712px !important; height: 235px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图，</span>sshd<span style="font-size: 14px; font-family: 宋体;">共占用了四个句柄</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">0 -&gt; <span style="font-size: 14px; font-family: 宋体;">标准输入</span></span></p></li><li><p><span style="font-size: 14px;">1 -&gt; <span style="font-size: 14px; font-family: 宋体;">标准输出</span></span></p></li><li><p><span style="font-size: 14px;">2 -&gt; <span style="font-size: 14px; font-family: 宋体;">标准错误输出</span></span></p></li><li><p><span style="font-size: 14px;">3 -&gt; socket<span style="font-size: 14px; font-family: 宋体;">（容易想到是监听端口）</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">sshd<span style="font-size: 14px; font-family: 宋体;">只有一个主线程</span>PID<span style="font-size: 14px; font-family: 宋体;">为</span>9339<span style="font-size: 14px; font-family: 宋体;">，并没有多线程。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-family: 宋体; font-size: 14px;">所以，只要</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">ll /proc/${PID}/fd | wc -l</span></p></li><li><p><span style="font-size: 14px;">ll /proc/${PID}/task | wc -l&nbsp;<span style="font-size: 14px; font-family: 宋体;">（效果等同</span>pstree -p | wc -l<span style="font-size: 14px; font-family: 宋体;">）</span></span></p></li></ul><p><span style="font-family: 宋体; font-size: 14px;">就能知道进程打开的句柄数和线程数。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">作业</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">对线上服务器的一台</span>tomcat<span style="font-size: 14px; font-family: 宋体;">，查看</span>proc<span style="font-size: 14px; font-family: 宋体;">下的fd目录和task目录，特别是对于句柄</span>fd<span style="font-size: 14px; font-family: 宋体;">目录的查询，有意想不到的惊喜哟，一定要动手试试哈。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; line-height: 22.4px; box-sizing: border-box !important; word-wrap: break-word !important;">如果有收获，<span style="max-width: 100%; line-height: 22.4px; color: rgb(255, 76, 0); box-sizing: border-box !important; word-wrap: break-word !important;">帮转</span>哈。</span></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">相关文章：</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960332&amp;idx=1&amp;sn=63cb23e04ac4bf926434f34001c0718a&amp;chksm=bd2d01d08a5a88c6a01e62533162cc3535defb37cefa61a800e405edda8240ad17432e023d53&amp;scene=21#wechat_redirect" target="_blank">线上服务CPU100%问题快速定位实战</a><br></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960323&amp;idx=1&amp;sn=e04af14d2ebf939133869e0f18bb0dd1&amp;chksm=bd2d01df8a5a88c98c3cb94a99334a16b372fd997f36bc757a38bb44b70d977797fa840064dc&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">常见线上操作Linux命令实战</span></a></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=205216499&amp;idx=1&amp;sn=656b5403f3be045772bb539c873e6bd0&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">Linux追查线上问题常用命令</span></a></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=400743254&amp;idx=1&amp;sn=147abc381ccd61e28f52699735c8748e&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">一分钟awk够用</span></a><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=403340380&amp;idx=1&amp;sn=9b4ced5a19f60b0cebf6fd582f1d52ae&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">一分钟sed够用</a></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1503366049&src=3&ver=1&signature=OYewMZH60kmig22U24i7m6sKVnTwzt3UPW4YGe4v-5baZmWG6eeyYwlgndoMQvEZ2rCh6bD1GFvpiI6UKWdhjboZ97vl27*0C-H01Z5w1gxgvCHr*eXFGWc2nfVj8qnpWQS*GY0W3JFVAbB5oHcQ8nR8WBqAvJzZWNCgxJQhVxU=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960332&amp;idx=1&amp;sn=63cb23e04ac4bf926434f34001c0718a&amp;chksm=bd2d01d08a5a88c6a01e62533162cc3535defb37cefa61a800e405edda8240ad17432e023d53#rd">阅读原文</a>
{% endraw  %}

