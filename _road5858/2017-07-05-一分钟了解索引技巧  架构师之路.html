---
title: 一分钟了解索引技巧 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499656649&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvW1gSMMfgEt5EdAbfzM6PjFHlOYWGtySuV7QzFwUsJRtBEcZZtFpUZwXGF1fH9emhUdFU-gb6n1J0FupeogQCbG7sueVe7EvXbgW3vhe9AmjBLOftC7b3doJz0kgmx0dKtSkovIHIgIMlwIOkbHdG6e0=
date: '2017-07-05 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;"><span style="font-family: 宋体;">花</span>1<span style="font-family: 宋体;">分钟时间，了解聚集索引，非聚集索引，联合索引，索引覆盖。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">举例，业务场景，用户表，表结构为：</span></p><p><span style="font-size: 12px;">t_user(</span></p><p><span style="font-size: 12px;">uid primary key,</span></p><p><span style="font-size: 12px;">login_name unique,</span></p><p><span style="font-size: 12px;">passwd,</span></p><p><span style="font-size: 12px;">login_time,</span></p><p><span style="font-size: 12px;">age,</span></p><p><span style="font-size: 12px;">…</span></p><p><span style="font-size: 12px;">);</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">聚集索引</span>(clustered index)</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">聚集索引决定数据在磁盘上的物理排序</span>，一个表只能有一个聚集索引，一般用</span>primary key<span style="font-size: 14px; font-family: 宋体;">来约束。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">举例</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span>t_user<span style="font-size: 14px; font-family: 宋体;">场景中，</span><span style="font-size: 14px; color: rgb(255, 76, 0);">uid<span style="font-size: 14px; font-family: 宋体;">上的索引</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">非聚集索引</span>(non-clustered index)</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：它并不决定数据在磁盘上的物理排序，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">索引上只包含被建立索引的数据，以及一个行定位符</span>row-locator</span><span style="font-size: 14px; font-family: 宋体;">，这个行定位符，可以理解为一个聚集索引物理排序的指针，通过这个指针，可以找到行数据。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">举例</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，查找年轻</span>MM<span style="font-size: 14px; font-family: 宋体;">的业务需求：</span></span></p><p><span style="font-size: 12px;">select uid from t_user where age &gt; 18 and age &lt; 26;</span></p><p><span style="font-size: 14px;">age<span style="font-size: 14px; font-family: 宋体;">上建立的索引，就是非聚集索引。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">联合索引</span></strong><span style="font-family: 宋体; font-size: 14px;">：<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">多个字段上建立的索引</span>，能够加速复核查询条件的检索</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">举例</span></strong><span style="font-family: 宋体; font-size: 14px;">，登录业务需求：</span></p><p><span style="font-size: 12px;">select uid, login_time from t_user where&nbsp;</span></p><p><span style="font-size: 12px;">login_name=? and passwd=?</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">可以建立</span>(login_name, passwd)<span style="font-size: 14px; font-family: 宋体;">的联合索引。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">联合索引能够满足最左侧查询需求</span><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，例如</span>(a, b, c)<span style="font-size: 14px; font-family: 宋体;">三列的联合索引，能够加速</span>a | (a, b) | (a, b, c)&nbsp;<span style="font-size: 14px; font-family: 宋体;">三组查询需求。</span></span></p><p><span style="font-size: 14px; font-family: 宋体;"><br></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这也就是为何</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">不建立</span>(passwd, login_name)<span style="font-size: 14px; font-family: 宋体;">这样联合索引</span></span><span style="font-size: 14px; font-family: 宋体;">的原因，业务上几乎没有</span>passwd<span style="font-size: 14px; font-family: 宋体;">的单条件查询需求，而有很多</span>login_name<span style="font-size: 14px; font-family: 宋体;">的单条件查询需求。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">提问</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><span style="color: rgb(255, 76, 0); font-size: 12px;">select uid, login_time from t_user where</span></p><p><span style="color: rgb(255, 76, 0); font-size: 12px;"><strong>passwd</strong>=? and login_name=?</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">能否命中</span>(<strong>login_name</strong>, passwd)<span style="font-size: 14px; font-family: 宋体;">这个联合索引？</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">回答：<strong>可以</strong>，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">最左侧查询需求，并</span><strong><span style="font-size: 14px; font-family: 宋体;">不是指</span>SQL<span style="font-size: 14px; font-family: 宋体;">语句的写法必须满足索引的顺序</span></strong></span><span style="font-size: 14px; font-family: 宋体;">（这是很多朋友的误解）</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">索引覆盖</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">被查询的列，数据能从索引中取得</span>，而不用通过行定位符</span>row-locator<span style="font-size: 14px; font-family: 宋体;">再到</span>row<span style="font-size: 14px; font-family: 宋体;">上获取，即“被查询列要被所建的索引覆盖”，这能够加速查询速度。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">举例，登录业务需求：</span></p><p><span style="font-size: 12px;">select uid, login_time from t_user where</span></p><p><span style="font-size: 12px;">login_name=? and passwd=?</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">可以建立</span><strong>(login_name, passwd, <span style="font-size: 14px; color: rgb(255, 76, 0);">login_time</span>)<span style="font-size: 14px; font-family: 宋体;">的联合索引</span></strong><span style="font-size: 14px; font-family: 宋体;">，由于</span>login_time<span style="font-size: 14px; font-family: 宋体;">已经建立在索引中了，被查询的</span>uid<span style="font-size: 14px; font-family: 宋体;">和</span>login_time<span style="font-size: 14px; font-family: 宋体;">就不用去</span>row<span style="font-size: 14px; font-family: 宋体;">上获取数据了，从而加速查询。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">末了多说一句，登录这个业务场景，</span>login_name<span style="font-size: 14px; font-family: 宋体;">具备唯一性，建这个单列索引就好。</span></span></p><p><span style="font-size: 14px; font-family: 宋体;"><br></span></p><p><strong><span style="font-family:宋体"><span style="font-size: 14px; line-height: 22.4px;">作业</span></span></strong><span style="font-family:宋体"><span style="font-size: 14px; line-height: 22.4px;">：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体;">假设订单有三种状态</span>：</span><span style="font-size: 14px; line-height: 1.6;">0</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">已下单，</span><span style="font-size: 14px; line-height: 1.6;">1</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">已支付，</span><span style="font-size: 14px; line-height: 1.6;">2</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">已完成</span></p><p><span style="font-family: 宋体; font-size: 14px;">业务需求，查询<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">未完成的订单</span>，哪个SQL更快呢？</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 12px;">select * from order where status<span style="font-size: 12px; color: rgb(255, 76, 0);"><strong>!=</strong></span>2</span></p></li><li><p><span style="font-size: 12px;">select * from order where status=0 <span style="font-size: 12px; color: rgb(255, 76, 0);"><strong>or</strong></span> status=1</span></p></li><li><p><span style="font-size: 12px;">select * from order where status <span style="font-size: 12px; color: rgb(255, 76, 0);"><strong>IN</strong></span> (0,1)</span></p></li><li><p><span style="font-size: 12px;">select * from order where status=0 </span></p><p><span style="color: rgb(255, 76, 0);"><strong><span style="font-size: 12px;">union</span></strong></span><span style="font-size: 12px;"> </span></p><p><span style="font-size: 12px;">select * from order where stauts=1</span></p></li></ul><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499656649&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvW1gSMMfgEt5EdAbfzM6PjFHlOYWGtySuV7QzFwUsJRtBEcZZtFpUZwXGF1fH9emhUdFU-gb6n1J0FupeogQCbG7sueVe7EvXbgW3vhe9AmjBLOftC7b3doJz0kgmx0dKtSkovIHIgIMlwIOkbHdG6e0=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960255&amp;idx=1&amp;sn=1bf42b6d8f5658f9d8b54274d62ca714&amp;chksm=bd2d06638a5a8f757502004f4d206f1a4e0f3e8ab4b1d3ba0635308e7d5b7a30860ae6d91e0c#rd">阅读原文</a>
{% endraw  %}

