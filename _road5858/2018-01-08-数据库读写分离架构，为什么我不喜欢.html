---
title: 数据库读写分离架构，为什么我不喜欢
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1515986097&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siBo3oPDK8DK*88F4CWijxQ5EFX6jGrv3BrjQoFMwQzo-*jiN8gkDoGNv71FTxFvM1GKeV5jUoJlXqisazxLyCCuoPIT5u7f2XWqZxWyhM0HjmEf8W1Hbby0cbRfQUSLEWR5ch7ZtyKk*FpmlbEvrHAw=
date: '2018-01-08 00:00:00 +0000'

---

{% raw  %}
<p><strong><span style="font-size: 14px;letter-spacing: 1px;">RD</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：单库数据量太大，数据库扛不住了，我要申请一个数据库从库，读写分离。</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">DBA</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：数据量多少？</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">RD</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：5000w左右。</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">DBA</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：读写吞吐量呢？</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">RD</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：读QPS约200，写QPS约30左右。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">上周在公司听到两个技术同学讨论，感觉对读写分离解决什么问题没有弄清楚，有些奔溃。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">另，对于互联网某些业务场景，并不是很喜欢数据库读写分离架构，一些浅见见文末。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">一、读写分离</span></strong></span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">什么是数据库读写分离？</span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxjNNl6CNdbCr8dka9iatth45ahmMvM3adOPiayUzwdyxKBWFwYljibnBfEFpM4o5l0lung3dH3Zd15w/0?wx_fmt=png" style="width: 233px !important; height: 182px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">答：<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">一主多从，读写分离，主动同步</span>，是一种常见的数据库架构，一般来说：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">主库，提供数据库写服务</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">从库，提供数据库读服务</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">主从之间，通过某种机制同步数据，例如mysql的binlog</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">一个组从同步集群通常称为一个<strong>“分组”</strong>。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">分组架构究竟解决什么问题？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">答：大部分互联网业务读多写少，数据库的读往往最先成为性能瓶颈，如果希望：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">线性提升数据库读性能</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">通过消除读写锁冲突提升数据库写性能</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">此时可以使用分组架构。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">一句话，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">分组主要解决“数据库读性能瓶颈”问题</span>，在数据库扛不住读的时候，通常读写分离，通过增加从库线性提升系统读性能。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">二、水平切分</span></strong></span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">什么是数据库水平切分？</span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxjNNl6CNdbCr8dka9iatth4cUT38uDiaRnibHbVNysJKaMHhKXpxl5pibUkkjEm6ohtzu8x1YojNzfCw/0?wx_fmt=png" style="width: 215px !important; height: 104px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">答：水平切分，也是一种常见的数据库架构，一般来说：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">每个数据库之间没有数据重合，没有类似binlog同步的关联</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">所有数据并集，组成全部数据</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">会用算法，来完成数据分割<span style="font-size: 14px;letter-spacing: 1px;">，例如“取模”</span></span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">一个水平切分集群中的每一个数据库，通常称为一个<strong>“分片”</strong>。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">水平切分架构究竟解决什么问题？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">答：大部分互联网业务数据量很大，单库容量容易成为瓶颈，如果希望：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">线性降低单库数据容量</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">线性提升数据库写性能</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">此时可以使用水平切分架构。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">一句话总结，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">水平切分主要解决“数据库数据量大”问题</span>，在数据库容量扛不住的时候，通常水平切分。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">三、为什么不喜欢读写分离</span></strong></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">对于互联网<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">大数据量，高并发量，高可用要求高，一致性要求高，前端面向用户的业务场景</span>，如果数据库读写分离：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">数据库连接池需要区分：读连接池，写连接池</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">如果要保证读高可用，读连接池要实现故障自动转移</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">有潜在的主库从库一致性问题</span></p></li></ul><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOxjNNl6CNdbCr8dka9iatth4PNyz5ojzbSQPnHkAEDqTmky2aYqQLN3ssQicwmiaPw6ldUQGxQ8SKJWQ/0?wx_fmt=png" style="width: 200px !important; height: 156px !important;"></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">如果面临的是“读性能瓶颈”问题，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">增加缓存可能来得更直接，更容易一点</span></span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">关于成本，从库的成本比缓存高不少</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">对于云上的架构，以阿里云为例，主库提供高可用服务，从库不提供高可用服务</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">所以，上述业务场景下，楼主建议使用缓存架构来加强系统读性能，替代数据库主从分离架构。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">当然，使用缓存架构的<strong>潜在问题</strong>：如果缓存挂了，流量全部压到数据库上，数据库会雪崩。不过幸好，云上的缓存一般都提供高可用的服务。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">四、总结</span></strong></span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">读写分离，解决“数据库读性能瓶颈”问题</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">水平切分，解决“数据库数据量大”问题</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">对于互联网大数据量，高并发量，高可用要求高，一致性要求高，前端面向用户的业务场景，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">微服务缓存架构，可能比数据库读写分离架构更合适</span></span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">你有没有用读写分离，你的思考是什么呢？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">希望这一分钟你有收获。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">随手<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">转</span>，谢过。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1515986097&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siBo3oPDK8DK*88F4CWijxQ5EFX6jGrv3BrjQoFMwQzo-*jiN8gkDoGNv71FTxFvM1GKeV5jUoJlXqisazxLyCCuoPIT5u7f2XWqZxWyhM0HjmEf8W1Hbby0cbRfQUSLEWR5ch7ZtyKk*FpmlbEvrHAw=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960800&amp;idx=1&amp;sn=595842fb2dc75aa505f544b956f2d65c&amp;chksm=bd2d003c8a5a892ab497fbed42f37d852949e7d1ecbd9cc1bd249910be1c70da978c60ecfc0b#rd">阅读原文</a>
{% endraw  %}

