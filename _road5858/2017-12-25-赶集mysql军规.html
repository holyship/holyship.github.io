---
title: 赶集mysql军规
author: 架构师之路
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1515986097&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siBo3oPDK8DK*88F4CWijxQ5EFX6jGrv3BrjQoFMwQzo-*jiN8gkDoGNv71FTxFvM1PdZfS5mHVfeJgqUsV*-eez-YJPdWgOi*80bgTHGhDqwmGhD7Aw*hKJTTDJ5gbxEr02szWvj2w1ifxlCJJj-y7Q=
date: '2017-12-25 00:00:00 +0000'

---

{% raw  %}
<p><span style="letter-spacing: 1px;font-size: 14px;">总是在灾难发生后，才想起容灾的重要性。</span><span style="letter-spacing: 1px;font-size: 14px;"><br>总是在吃过亏后，才记得曾经有人提醒过。</span></p><p><br></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">一，核心军规</span></strong></span><span style="letter-spacing: 1px;font-size: 14px;"><br></span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">不在数据库做计算</span><span style="letter-spacing: 1px;font-size: 14px;">，cpu计算务必移至业务层</span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">控制单表数据量，单表记录控制在千万级</span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">控制列数量，字段数控制在20以内</span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">平衡范式与冗余，<span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">为提高效率可以牺牲范式设计，冗余数据</span></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">拒绝3B(big)，大sql，大事务，大批量</span></p></li></ul><p><br></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">二，字段类军规</span></strong></span><span style="letter-spacing: 1px;font-size: 14px;"><br></span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="letter-spacing: 1px;font-size: 14px;">用好数值类型<br>tinyint(1Byte)<br>smallint(2Byte)<br>mediumint(3Byte)<br>int(4Byte)<br>bigint(8Byte)<br>bad case：int(1)/int(11)<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">有些字符转化为数字<br>用int而不是char(15)存储ip<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">优先使用enum或set<br>例如：`sex` enum (‘F’, ‘M’)<br></span></p></li><li><p><span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">避免使用NULL字段</span><span style="letter-spacing: 1px;font-size: 14px;"><br>NULL字段很难查询优化<br>NULL字段的索引需要额外空间<br>NULL字段的复合索引无效<br>bad case：<br>`name` char(32) default null<br>`age` int not null<br>good case：<br>`age` int not null default 0<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">不在数据库里存图片</span></p></li></ul><p><br></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">三，索引类军规</span></strong></span><span style="letter-spacing: 1px;font-size: 14px;"><br></span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="letter-spacing: 1px;font-size: 14px;">谨慎合理使用索引<br>改善查询、减慢更新<br>索引一定不是越多越好（能不加就不加，要加的一定得加）<br>覆盖记录条数过多不适合建索引，例如“性别”<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">字符字段必须建前缀索引<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">不在索引做列运算<br>bad case：<br>select id where age +1 = 10;<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">innodb主键合理使用自增列<br>主键建立聚簇索引<br>主键不应该被修改<br><span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">字符串不应该做主键</span><br>如果不指定主键，innodb会使用唯一且非空值索引代替<br></span></p></li><li><p><span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">不用外键，请由程序保证约束</span></p></li></ul><p><br></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">四，sql类军规</span></strong></span><span style="letter-spacing: 1px;font-size: 14px;"><br></span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="letter-spacing: 1px;font-size: 14px;">sql语句尽可能简单<br>一条sql只能在一个cpu运算<br>大语句拆小语句，减少锁时间<br>一条大sql可以堵死整个库<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">简单的事务<br>事务时间尽可能短<br>bad case：<br>上传图片事务<br></span></p></li><li><p><span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">避免使用触发器，用户自定义函数</span><span style="letter-spacing: 1px;font-size: 14px;">，请由程序取而代之<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">不用select *<br>消耗cpu，io，内存，带宽<br>这种程序不具有扩展性<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">OR改写为IN()<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">OR改写为UNION</span></p></li></ul><p><span style="color: rgb(0, 82, 255);"><em><span style="letter-spacing: 1px;font-size: 14px;">画外音：最新的mysql内核已经进行了相关优化</span></em></span><span style="letter-spacing: 1px;font-size: 14px;"><br></span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="letter-spacing: 1px;font-size: 14px;">limit高效分页<br>limit越大，效率越低<br>select id from t limit 10000, 10;<br>应该改为 =&gt;<br>select id from t where id &gt; 10000 limit 10;<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">使用union all替代union，union有去重开销<br></span></p></li><li><p><span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">尽量不用连接join</span><span style="letter-spacing: 1px;font-size: 14px;"><br></span></p></li><li><p><span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">务必请使用“同类型”进行比较</span><span style="letter-spacing: 1px;font-size: 14px;">，否则可能全表扫面</span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">打散批量更新<br></span></p></li><li><p><span style="letter-spacing: 1px;font-size: 14px;">使用新能分析工具<br>show profile;<br>mysqlsla;<br>mysqldumpslow;<br>explain;<br>show slow log;<br>show processlist;<br>show query_response_time(percona)</span></p></li></ul><p><br></p><p><span style="letter-spacing: 1px;font-size: 14px;">相关文章：</span></p><p><span style="letter-spacing: 1px;font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959906&amp;idx=1&amp;sn=2cbdc66cfb5b53cf4327a1e0d18d9b4a&amp;chksm=bd2d07be8a5a8ea86dc3c04eced3f411ee5ec207f73d317245e1fefea1628feb037ad71531bc&amp;scene=21#wechat_redirect" target="_blank">58到家数据库30条军规解读</a>&nbsp;(4.5W+)</span></p><p><span style="letter-spacing: 1px;font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959910&amp;idx=1&amp;sn=6b6853b70dbbe6d689a12a4a60b84d8b&amp;chksm=bd2d07ba8a5a8eac6783bac951dba345d865d875538755fe665a5daaf142efe670e2c02b7c71&amp;scene=21#wechat_redirect" target="_blank">再议数据库军规</a>&nbsp;(2W+)</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1515986097&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siBo3oPDK8DK*88F4CWijxQ5EFX6jGrv3BrjQoFMwQzo-*jiN8gkDoGNv71FTxFvM1PdZfS5mHVfeJgqUsV*-eez-YJPdWgOi*80bgTHGhDqwmGhD7Aw*hKJTTDJ5gbxEr02szWvj2w1ifxlCJJj-y7Q=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959906&amp;idx=1&amp;sn=2cbdc66cfb5b53cf4327a1e0d18d9b4a&amp;chksm=bd2d07be8a5a8ea86dc3c04eced3f411ee5ec207f73d317245e1fefea1628feb037ad71531bc#rd">阅读原文</a>
{% endraw  %}

