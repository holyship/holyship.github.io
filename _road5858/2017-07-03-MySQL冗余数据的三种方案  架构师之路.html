---
title: MySQL冗余数据的三种方案 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499131416&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ2C-mFRC1Hh3Dphb3zLBkqij4Jaanumtg17LZBDShHzuc5xEdFWfukz5FMlV5a5dB4ns5cGH7VCQUndGbgtSF8VWcjVIZFlyq6d5EzhSRD0QAtBVGoOt49oCvJrUrr25b-lbOgiS6Tb8whBlMuKJiJ0=
date: '2017-07-03 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">一，为什么要冗余数据</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">互联网数据量很大的业务场景，往往数据库需要进行水平切分来降低单库数据量。</span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">水平切分会有一个</span>patition key<span style="font-family: 宋体; font-size: 14px;">，</span><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">通过</span>patition key<span style="font-family: 宋体; font-size: 14px;">的查询能够直接定位到库，但是非</span>patition key<span style="font-family: 宋体; font-size: 14px;">上的查询可能就需要扫描多个库了。</span></span></span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">此时常见的架构设计方案，是使用<strong>数据冗余</strong>这种<span style="color: rgb(255, 76, 0); font-family: 宋体; font-size: 14px;">反范式设计来满足分库后不同维度的查询需求</span>。</span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">例如：订单业务，对用户和商家都有订单查询需求：</span></p><p><span style="font-size: 12px;">Order(oid, info_detail);</span></p><p><span style="font-size: 12px;">T(buyer_id, seller_id, oid);</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如果用</span>buyer_id<span style="font-family: 宋体; font-size: 14px;">来分库，</span>seller_id<span style="font-family: 宋体; font-size: 14px;">的查询就需要扫描多库。</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如果用</span>seller_id<span style="font-family: 宋体; font-size: 14px;">来分库，</span>buyer_id<span style="font-family: 宋体; font-size: 14px;">的查询就需要扫描多库。</span></span></p><p><br></p><p><span style="font-family: 宋体; font-size: 14px;">此时可以使用数据冗余来分别满足buyer_id和seller_id上的查询需求：</span></p><p><span style="font-size: 12px;">T1(buyer_id, seller_id, oid)</span></p><p><span style="font-size: 12px;">T2(seller_id, buyer_id, oid)</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">同一个数据，冗余两份，一份以</span>buyer_id<span style="font-family: 宋体; font-size: 14px;">来分库，满足买家的查询需求；</span></span><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">一份以</span>seller_id<span style="font-family: 宋体; font-size: 14px;">来分库，满足卖家的查询需求。</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如何实施数据的冗余，是今天将要讨论的内容。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 18px;">二，服务同步双写</span></strong></p><p><img src="http://mmbiz.qpic.cn/mmbiz/YrezxckhYOzQ21dcCHZQFDV2dlA4Xdeg3eXznztmgkCuKxzO807YOiaZMXEo2sEg8P2F0zcVybhmGtlefUt2EBg/0?wx_fmt=png" style="width: 176px !important; height: 152px !important; visibility: visible !important;"><br><span style="font-size: 14px;"><span style="color: rgb(51, 51, 51); line-height: 1.6; font-family: 宋体; font-size: 14px; background-color: white;">顾名思义，<span style="color: rgb(255, 41, 65); line-height: 1.6; font-family: 宋体; font-size: 14px; background-color: white;">由服务层同步写冗余数据</span>，如上图</span><span style="color: rgb(51, 51, 51); line-height: 1.6; font-family: Arial,sans-serif; font-size: 14px; background-color: white;">1-4</span><span style="color: rgb(51, 51, 51); line-height: 1.6; font-family: 宋体; font-size: 14px; background-color: white;">流程：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">业务方调用服务，新增数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务先插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T1</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务再插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T2</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务返回业务方新增数据成功</span></span></p></li></ul><p><span style="font-size: 14px;"><strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;"><br></span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">优点</span></span></strong><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;"></span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">不复杂，服务层由单次写，变两次写</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据一致性相对较高（因为双写成功才返回）</span></span></p></li></ul><p><span style="font-size: 14px;"><strong><span style="font-family: 宋体; font-size: 14px;"><br></span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">缺点</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"></span><span style="font-family: 宋体; font-size: 14px;">：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">请求的处理时间增加（要插入两次，时间加倍）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据仍可能不一致，例如第二步写入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T1</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">完成后服务重启，则数据不会写入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T2</span></span></p></li></ul><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;"><span style="color: rgb(255, 41, 65); font-family: 宋体; font-size: 14px;">如果系统对处理时间比较敏感</span><span style="font-family: 宋体; font-size: 14px;">，引出常用的第二种方案。</span></span></p><p><span style="font-size: 14px;"><strong><span style="font-family: 宋体; font-size: 14px;"><br></span></strong></span></p><p><span style="font-size: 14px;"><strong><span style="font-family: 宋体; font-size: 14px;"></span><span style="font-family: 宋体; font-size: 18px;">三，服务异步双写</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;"></span></strong></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz/YrezxckhYOzQ21dcCHZQFDV2dlA4XdegZGJEUOvex25ibugWy34paictibh0RfBsErUSsCa07bfGydt1qJHW08d4w/0?wx_fmt=png" style="width: 335px !important; height: 162px !important;"><br><span style="font-size: 14px;"><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">数据的双写并不再由服务来完成，服务层异步发出一个消息，通过消息总线发送给一个专门的数据复制服务来写入冗余数据，如上图</span><span style="line-height: 1.6; font-size: 14px;">1-6</span><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">流程：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">业务方调用服务，新增数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务先插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T1</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务向消息总线发送一个异步消息（发出即可，不用等返回，通常很快就能完成）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务返回业务方新增数据成功</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">消息总线将消息投递给数据同步中心</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据同步中心插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T2</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据</span></span></p></li></ul><p><span style="font-size: 14px;"><strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;"><br></span></strong></span></p><p><span style="font-size: 14px;"><strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">优点</span></strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">请求处理时间短（只插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">1</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">次）</span></span></p></li></ul><p><span style="font-size: 14px;"><strong><span style="font-family: 宋体; font-size: 14px;"><br></span></strong></span></p><p><span style="font-size: 14px;"><strong><span style="font-family: 宋体; font-size: 14px;">缺点</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">系统的复杂性增加了，多引入了一个组件（消息总线）和一个服务（专用的数据复制服务）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">因为返回业务线数据插入成功时，数据还不一定插入到</span>T2<span style="font-family: 宋体; font-size: 14px;">中，因此数据有一个不一致时间窗口（这个窗口很短，最终是一致的）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">在消息总线丢失消息时，冗余表数据会不一致</span></span></p></li></ul><p><span style="font-size: 14px;"><br></span></p><p><span style="color: rgb(0, 0, 0); font-family: 宋体; font-size: 14px;">不管是服务同步双写，还是服务异步双写，服务都需要关注“冗余数据”带来的复杂性。</span><span style="font-size: 14px;"><span style="color: rgb(255, 41, 65); font-family: 宋体; font-size: 14px;">如果想解除“数据冗余”对系统的耦合</span><span style="font-family: 宋体; font-size: 14px;">，引出常用的第三种方案。</span></span></p><p><span style="font-size: 14px;"><strong><span style="font-family: 宋体; font-size: 14px;"><br></span></strong></span></p><p><strong><span style="font-family: 宋体; font-size: 18px;">四，线下异步双写</span></strong></p><p><img src="http://mmbiz.qpic.cn/mmbiz/YrezxckhYOzQ21dcCHZQFDV2dlA4Xdeg1Sbxc7U5SDCK8XuVyCyGFN0LxesJUIXibUV2UO6bG0yGgoxkOsib4bPQ/0?wx_fmt=png" style="width: 206px !important; height: 211px !important;"><br><span style="font-size: 14px;"><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">为了屏蔽<span style="font-family:宋体">“冗余数据”对服务带来的复杂性<span style="font-family:宋体">，</span></span>数据的双写不再由服务层来完成，而是由线下的一个服务或者任务来完成，如上图</span><span style="line-height: 1.6; font-size: 14px;">1-6</span><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">流程：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">业务方调用服务，新增数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务先插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T1</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">服务返回业务方新增数据成功</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据会被写入到数据库的</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">log</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">中</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">线下服务或者任务读取数据库的</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">log</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">线下服务或者任务插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">T2</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">数据</span></span></p></li></ul><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;"><br></span></span></p><p><span style="font-size: 14px;"><strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">优点</span></strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">数据双写与业务完全解耦</span></span></p></li><li><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">请求处理时间短（只插入</span><span style="background: white; color: rgb(51, 51, 51); font-family: Arial,sans-serif; font-size: 14px;">1</span><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">次）</span></span></p></li></ul><p><span style="font-size: 14px;"><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;"><br></span></span></p><p><span style="font-size: 14px;"><strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">缺点</span></strong><span style="background: white; color: rgb(51, 51, 51); font-family: 宋体; font-size: 14px;">：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">返回业务线数据插入成功时，数据还不一定插入到</span>T2<span style="font-family: 宋体; font-size: 14px;">中，因此数据有一个不一致时间窗口（这个窗口很短，最终是一致的）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">数据的一致性依赖于线下服务或者任务的可靠性</span></span></p></li></ul><p><br></p><p><span style="font-size: 18px;"><strong><span style="line-height: 1.6; font-family: 宋体;">五<span style="font-family: 宋体;">，</span>总结</span></strong></span></p><p><span style="font-size: 14px;"><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">互联网数据量大的业务场景<span style="font-family:宋体">，</span>常常:</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">使用<span style="color: rgb(255, 76, 0); line-height: 1.6; font-family: 宋体; font-size: 14px;">水平切分</span>来降低单库数据量</span></span></p></li><li><p><span style="font-size: 14px;"><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">使用<span style="color: rgb(255, 76, 0); line-height: 1.6; font-family: 宋体; font-size: 14px;">数据冗余</span>的反范式设计来满足不同维度的查询需求</span></span></p></li><li><p><span style="font-size: 14px;"><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">使用<span style="color: rgb(255, 76, 0); line-height: 1.6; font-family: 宋体; font-size: 14px;">服务<span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">同</span>步双写法</span>能够很容易的实现数据冗余</span></span></p></li><li><p><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">为了降低时延<span style="font-family:宋体">，</span>可以优化为<span style="color: rgb(255, 76, 0); line-height: 1.6; font-family: 宋体; font-size: 14px;">服务异步双写法</span></span></p></li><li><p><span style="line-height: 1.6; font-family: 宋体; font-size: 14px;">为了屏蔽<span style="font-family:宋体">“冗余数据”对服务带来的复杂性<span style="font-family:宋体">，</span>可以优化为<span style="color: rgb(255, 76, 0); line-height: 1.6; font-family: 宋体; font-size: 14px;">线下异步双写法</span></span></span></p></li></ul><p><span style="color: rgb(0, 0, 0); line-height: 1.6; font-family: 宋体; font-size: 14px;"><br></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499131416&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ2C-mFRC1Hh3Dphb3zLBkqij4Jaanumtg17LZBDShHzuc5xEdFWfukz5FMlV5a5dB4ns5cGH7VCQUndGbgtSF8VWcjVIZFlyq6d5EzhSRD0QAtBVGoOt49oCvJrUrr25b-lbOgiS6Tb8whBlMuKJiJ0=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960253&amp;idx=1&amp;sn=cce01d9d305024b5cc7e1e7149507ae9&amp;chksm=bd2d06618a5a8f77db3731e8687f9a116c0c3113a4b9a8574149530610dc95fbcf7e4ab92ae5#rd">阅读原文</a>
{% endraw  %}

