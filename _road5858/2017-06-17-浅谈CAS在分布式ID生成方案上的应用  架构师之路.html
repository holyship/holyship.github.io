---
title: 浅谈CAS在分布式ID生成方案上的应用 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1498052271&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ1KJasWOsq8hSo-mm4SVBUqXpDLOmbKmY46mI-tH6ASrpLYSYQojdSaCl4vWp*Xp7aC2VAqLTbIUPcBLVpaw3uz4gfCRljnhLTACL1fWupBkmt9KemJ0gsfOI3OEyHb7KSsPKSYF5kBZXVW7XKiXBLg=
date: '2017-06-17 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;"><span style="font-family: 宋体;">近几篇文章聊</span>CAS<span style="font-family: 宋体;">被骂得较多，今天还是聊</span>CAS<span style="font-family: 宋体;">，谈谈</span>CAS<span style="font-family: 宋体;">在一种“分布式</span>ID<span style="font-family: 宋体;">生成方案”上的应用。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">所谓“分布式</span>ID<span style="font-size: 14px; font-family: 宋体;">生成方案”，是指</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">在分布式环境下，生成全局唯一</span>ID<span style="font-size: 14px; font-family: 宋体;">的方法</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">可以</span><strong><span style="font-size: 14px; font-family: 宋体;">利用DB自增键</span>(auto inc id)<span style="font-size: 14px; font-family: 宋体;">来生成全局唯一</span>ID</strong><span style="font-size: 14px; font-family: 宋体;">，插入一条记录，生成一个</span>ID<span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5lXSnI3042JlhibOzMpUofEIROTXKU9Je909wvVBZJ5YP2RtDL4icjt5qw/0?wx_fmt=png" style="width: 228px !important; height: 106px !important; visibility: visible !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">这个方案利用了数据库的单点特性，其优点为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">无需写额外代码</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">全局唯一</span></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">绝对</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">递增</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">递增</span>ID<span style="font-size: 14px; font-family: 宋体;">的步长确定</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">其不足为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">需要做数据库</span>HA<span style="font-size: 14px; font-family: 宋体;">，保证生成</span>ID<span style="font-size: 14px; font-family: 宋体;">的高可用</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">数据库中记录数较多</span></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">生成</span>ID<span style="font-size: 14px; font-family: 宋体;">的性能，取决于数据库插入性能</span></span></strong></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">优化方案为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">利用双主保证高可用</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">定期删除数据</span></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">增加一层服务，采用<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">批量生成</span>的方式降低数据库的写压力，提升整体性能</span></span></strong></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">增加服务后，DB中只需保存当前最大的</span>ID<span style="font-size: 14px; font-family: 宋体;">即可，在服务启动初始化的过程中，首先拉取当前的</span>max-id<span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5liaXVPgza7XOSicIXQeokgj73APFZqOA0RcuNtt2dLZojfgjL7v8IhqKg/0?wx_fmt=png" style="width: 217px !important; height: 108px !important;"></p><p><span style="font-size: 12px;">select max_id from T;</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">然后批量获取一批</span>ID<span style="font-size: 14px; font-family: 宋体;">，放到</span>id-servcie<span style="font-size: 14px; font-family: 宋体;">内存里，并将</span>max-id<span style="font-size: 14px; font-family: 宋体;">写回数据库：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5lJa1u9p4mhbvq1ZNP2516RjvuqaYqRWMtsG7x98SwPJYtwRo2PszVGQ/0?wx_fmt=png" style="width: 236px !important; height: 166px !important;"></p><p><span style="font-size: 12px;">update T set max_id=200;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这样，</span>id-service<span style="font-size: 14px; font-family: 宋体;">就拿到了</span>[100, 200]<span style="font-size: 14px; font-family: 宋体;">这</span><strong><span style="font-size: 14px; font-family: 宋体;">一批</span>ID</strong><span style="font-size: 14px; font-family: 宋体;">，上游在获取</span>ID<span style="font-size: 14px; font-family: 宋体;">时，不用每次都插入数据库，而是分配完</span>100<span style="font-size: 14px; font-family: 宋体;">个</span>ID<span style="font-size: 14px; font-family: 宋体;">后，再修改</span>max-id<span style="font-size: 14px; font-family: 宋体;">的值，这样分配</span>ID<span style="font-size: 14px; font-family: 宋体;">的整体性能就增加了</span>100<span style="font-size: 14px; font-family: 宋体;">倍。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">这个方案的优点：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">数据库只保存一条记录</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">性能极大增强</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">其不足为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果</span>id-service<span style="font-size: 14px; font-family: 宋体;">重启，可能内存会有一段已经申请的</span>ID<span style="font-size: 14px; font-family: 宋体;">没有分配出去，导致</span><strong>ID<span style="font-size: 14px; font-family: 宋体;">空洞</span></strong><span style="font-size: 14px; font-family: 宋体;">，当然，这不是一个严重的问题</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">服务没有做</span>HA<span style="font-size: 14px; font-family: 宋体;">，无法保证高可用</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">优化方案为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">冗余服务，做集群保证高可用</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">冗余了服务后，多个服务在启动过程中，进行</span>ID<span style="font-size: 14px; font-family: 宋体;">批量申请时，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">可能由于并发导致数据不一致</span>：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5lib1bz2ZEwWNY0bAabM3ibfLeKKF8Z9ibTo81uuaH5GeAa59Z90RL7tCNQ/0?wx_fmt=png" style="width: 305px !important; height: 137px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"></span></span></p><p style="line-height: 25.6px; white-space: normal;"><span style="font-size: 12px;">select max_id from T;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图所示，两个</span>id-service<span style="font-size: 14px; font-family: 宋体;">在启动的过程中，同时拿到了</span>max-id<span style="font-size: 14px; font-family: 宋体;">为</span>100<span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">两个</span>id-service<span style="font-size: 14px; font-family: 宋体;">同时对数据库的</span>max-id<span style="font-size: 14px; font-family: 宋体;">进行写回：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5lE8PnqBZLVG4D9oYpxKfboSDnBZFnDHNPiaIQiay9W3liawSpicRo3Q381Q/0?wx_fmt=png" style="width: 421px !important; height: 162px !important;"></p><p><span style="font-size: 12px;">update T set max_id=200;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">写回</span>max-id<span style="font-size: 14px; font-family: 宋体;">成功后，这</span><strong><span style="font-size: 14px; font-family: 宋体;">两个</span>id-service<span style="font-size: 14px; font-family: 宋体;">都以为自己拿到了</span>[100,200]<span style="font-size: 14px; font-family: 宋体;">这一批</span>ID</strong><span style="font-size: 14px; font-family: 宋体;">，导致集群会生成重复的</span>ID<span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">问题发生的原因，是</span><strong><span style="font-size: 14px; font-family: 宋体;">并发写回时，没有对</span>max-id<span style="font-size: 14px; font-family: 宋体;">的初始值进行比对</span></strong><span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><span style="font-size: 14px;">id-service1<span style="font-size: 14px; font-family: 宋体;">写回</span>max-id=200<span style="font-size: 14px; font-family: 宋体;">成功的条件是，</span>max-id<span style="font-size: 14px; font-family: 宋体;">必须等于</span>100</span></p><p><span style="font-size: 14px;">id-service2<span style="font-size: 14px; font-family: 宋体;">写回</span>max-id=200<span style="font-size: 14px; font-family: 宋体;">成功的条件是，</span>max-id<span style="font-size: 14px; font-family: 宋体;">也必须等于</span>100</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">id-service1<span style="font-size: 14px; font-family: 宋体;">写回时，</span>max-id<span style="font-size: 14px; font-family: 宋体;">是</span>100<span style="font-size: 14px; font-family: 宋体;">，理应写回成功</span></span></p><p><span style="font-size: 14px;">id-service2<span style="font-size: 14px; font-family: 宋体;">写回时，</span>max-id<span style="font-size: 14px; font-family: 宋体;">已经被改成了</span>200<span style="font-size: 14px; font-family: 宋体;">，不应该写回成功</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">只要实施</span>CAS<span style="font-size: 14px; font-family: 宋体;">乐观锁，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">在写回时对</span>max-id<span style="font-size: 14px; font-family: 宋体;">的初始条件进行比对</span></span><span style="font-size: 14px; font-family: 宋体;">，就能避免数据的不一致，写回</span>SQL<span style="font-size: 14px; font-family: 宋体;">由：</span></span></p><p><span style="font-size: 12px;">update T set max_id=200;</span></p><p><span style="font-family: 宋体; font-size: 14px;">升级为：</span></p><p><span style="font-size: 12px;">update T set max_id=200 <span style="font-size: 12px; color: rgb(255, 76, 0);">where max_id=100;</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这样，</span>id-service2<span style="font-size: 14px; font-family: 宋体;">写回时，就会失败：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5le9OrEH3cRDgO9nuoHOicIgc1JF0jr6y8eqxLQ9GyGvrtSIUNicq2EYcA/0?wx_fmt=png" style="width: 403px !important; height: 182px !important;"></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">失败后，</span>id-service2<span style="font-size: 14px; font-family: 宋体;">要再次查询</span>max-id<span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5libdZagpG8NtaibO295KtyfEJ9Tzic7K4p0h1lFxFE9tYM63NSJGRVBZUA/0?wx_fmt=png" style="width: 412px !important; height: 179px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">此时</span>max-id<span style="font-size: 14px; font-family: 宋体;">已经变为</span>200<span style="font-size: 14px; font-family: 宋体;">，于是</span>id-service2<span style="font-size: 14px; font-family: 宋体;">获取到了</span>[200, 300]<span style="font-size: 14px; font-family: 宋体;">这一批</span>ID<span style="font-size: 14px; font-family: 宋体;">，并将</span>max-id=300<span style="font-size: 14px; font-family: 宋体;">写回：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwn9GQG9vPibc9vnTgRele5lLwsibTiaj1e7v1ZV5Qoicuct9WDPjXnEHsGnrRCN86ZrmBufz001IbouQ/0?wx_fmt=png" style="width: 426px !important; height: 181px !important;"></p><p><span style="font-size: 12px;">update t set max_id=300 <span style="font-size: 12px; color: rgb(255, 76, 0);">where max_id=200</span>;</span></p><p><span style="font-family: 宋体; font-size: 14px;">写回成功。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">这种方案的好处是：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">能够通过水平扩展的方式，达到分布式</span>ID<span style="font-size: 14px; font-family: 宋体;">生成服务的无限性能</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">使用</span>CAS<span style="font-size: 14px; font-family: 宋体;">简洁的保证不会生成重复的</span>ID</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">其不足为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">由于有多个</span>service<span style="font-size: 14px; font-family: 宋体;">，生成的</span>ID <strong><span style="font-size: 14px; font-family: 宋体;">不是绝对递增</span></strong><span style="font-size: 14px; font-family: 宋体;">的，而是<strong>趋势递增</strong>的</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">本文介绍了</span>CAS<span style="font-size: 14px; font-family: 宋体;">在分布式</span>ID<span style="font-size: 14px; font-family: 宋体;">生成方案上的一种应用，更多的分布式</span>ID<span style="font-size: 14px; font-family: 宋体;">生成方案，请参考《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=403837240&amp;idx=1&amp;sn=ae9f2bf0cc5b0f68f9a2213485313127&amp;scene=21#wechat_redirect" target="_blank"><span style="font-size: 14px; font-family: 宋体;">细聊分布式</span>ID<span style="font-size: 14px; font-family: 宋体;">生成器架构</span></a><span style="font-size: 14px; font-family: 宋体;">》。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">==【完】==</span></span></p><p><br></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">看了《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568&amp;scene=21#wechat_redirect" target="_blank">库存扣多了，到底怎么整</a>》与《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960200&amp;idx=1&amp;sn=fdec629caceee07b3946b6c338b8ceb7&amp;chksm=bd2d06548a5a8f424dd32be960222edf5cecc3c1e5a8fcbb4cfff35e7da6787e702861131597&amp;scene=21#wechat_redirect" target="_blank">库存扣减多种方案</a>》两篇文章的评论，还挺受挫的，也挺委屈的。描述了</span>A<span style="font-size: 14px; font-family: 宋体;">方案和</span>B<span style="font-size: 14px; font-family: 宋体;">方案，也从来没说</span>C<span style="font-size: 14px; font-family: 宋体;">方案和</span>D<span style="font-size: 14px; font-family: 宋体;">方案不行，好友网友反问“为什么不用</span>C<span style="font-size: 14px; font-family: 宋体;">”“为什么不用</span>D<span style="font-size: 14px; font-family: 宋体;">”“误导”“取关”。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">只想说，时间有限，经验有限，</span>2<span style="font-size: 14px; font-family: 宋体;">个小时的时间，真的只能聊</span>1-2<span style="font-size: 14px; font-family: 宋体;">个技术点。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">最后想起一个段子：</span></p><p><span style="font-size: 14px;">code review 100<span style="font-size: 14px; font-family: 宋体;">行代码，总能挑出</span>100<span style="font-size: 14px; font-family: 宋体;">个毛病</span></span></p><p><span style="font-size: 14px;">code review 10000<span style="font-size: 14px; font-family: 宋体;">行代码，却只是说，代码写得不错</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">末了，如《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568&amp;scene=21#wechat_redirect" target="_blank">库存扣多了，到底怎么整</a>》与《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960200&amp;idx=1&amp;sn=fdec629caceee07b3946b6c338b8ceb7&amp;chksm=bd2d06548a5a8f424dd32be960222edf5cecc3c1e5a8fcbb4cfff35e7da6787e702861131597&amp;scene=21#wechat_redirect" target="_blank">库存扣减多种方案</a>》两篇文章中很多读者的评论所述，</span><span style="font-size: 14px; color: rgb(255, 76, 0);">CAS<span style="font-size: 14px; font-family: 宋体;">方法会遇到</span>ABA<span style="font-size: 14px; font-family: 宋体;">问题</span></span><span style="font-size: 14px; font-family: 宋体;">，下一篇文章聊聊</span>ABA<span style="font-size: 14px; font-family: 宋体;">问题，以及优化方案。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">本文有收获的话，帮转下，给作者一些鼓励，谢谢。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1498052271&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ1KJasWOsq8hSo-mm4SVBUqXpDLOmbKmY46mI-tH6ASrpLYSYQojdSaCl4vWp*Xp7aC2VAqLTbIUPcBLVpaw3uz4gfCRljnhLTACL1fWupBkmt9KemJ0gsfOI3OEyHb7KSsPKSYF5kBZXVW7XKiXBLg=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=403837240&amp;idx=1&amp;sn=ae9f2bf0cc5b0f68f9a2213485313127#rd">阅读原文</a>
{% endraw  %}

