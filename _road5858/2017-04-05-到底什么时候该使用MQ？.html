---
title: 到底什么时候该使用MQ？
author: 58沈剑
date: '2017-04-05 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">一、缘起</span></strong></span></p><p><span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">一切脱离业务的架构设计与新技术引入都是耍流氓</span><span style="font-family: 宋体; font-size: 14px;">。</span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">引入一个技术之前，首先应该解答的问题是，这个技术解决什么问题。</span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">就像微服务分层架构之前，应该首先回答，为什么要引入微服务，微服务究竟解决什么问题（详见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959519&amp;idx=1&amp;sn=065074b135fc9cb243abe897261e1a72&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959519&amp;idx=1&amp;sn=065074b135fc9cb243abe897261e1a72&amp;scene=21#wechat_redirect">互联网架构为什么要做微服务？</a>》）。</span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">最近分享了几篇</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">相关的文章：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect"><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">如何实现延时消息</span></a><span style="font-family: 宋体; font-size: 14px;">》</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect"><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">如何实现消息必达</span></a><span style="font-family: 宋体; font-size: 14px;">》</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960002&amp;idx=1&amp;sn=c0775231bccf002c3178eabe43f1cdcb&amp;chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960002&amp;idx=1&amp;sn=c0775231bccf002c3178eabe43f1cdcb&amp;chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&amp;scene=21#wechat_redirect"><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">如何实现幂等性</span></a><span style="font-family: 宋体; font-size: 14px;">》</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">不少网友询问，究竟什么时候使用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">究竟适合什么场景，故有了此文。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">二、</span><span style="font-family: Calibri;">MQ</span></strong><strong><span style="font-family: 宋体;">是干嘛的</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">消息总线（</span><span style="font-family: Calibri; font-size: 14px;">Message Queue</span><span style="font-family: 宋体; font-size: 14px;">），后文称</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">，是一种跨进程的通信机制，用于上下游传递消息。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><img src="/road5858/images/92f3aa63baee704e59a82c9427edde1af13114b7.png" style="width: 746px !important; height: 884px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">在互联网架构中，</span><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">是一种非常常见的上下游“逻辑解耦</span><span style="font-family: Calibri; font-size: 14px;">+</span><span style="font-family: 宋体; font-size: 14px;">物理解耦”的消息通信服务</span></span><span style="font-family: 宋体; font-size: 14px;">。</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">使用了</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">之后，消息发送上游只需要依赖</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">，逻辑上和物理上都不用依赖其他服务。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">三、什么时候不使用消息总线</span></strong></span></p><p><img src="/road5858/images/9677b670d7e6edeaacfd9631e5c1186a5b2bc33f.png" style="width: 740px !important; height: 511px !important;"></p><p><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">既然</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">是互联网分层架构中的解耦利器，那所有通讯都使用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">岂不是很好？</span></span><strong><span style="font-family: 宋体; font-size: 14px;">这是一个严重的误区</span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">，调用与被调用的关系，是无法被</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">取代的。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">的<strong>不足</strong>是：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">系统更复杂</span>，多了一个</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">组件</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">消息传递路径更长</span>，延时会增加</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）消息可靠性和重复性互为矛盾，<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">消息不丢不重难以同时保证</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">4</span><span style="font-family: 宋体; font-size: 14px;">）<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">上游无法知道下游的执行结果</span>，这一点是很致命的</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">举个<span style="font-family: 宋体; font-size: 16px;"><strong>栗子</strong></span>：<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">用户登录场景</span>，登录页面调用</span><span style="font-family: Calibri; font-size: 14px;">passport</span><span style="font-family: 宋体; font-size: 14px;">服务，</span><span style="font-family: Calibri; font-size: 14px;">passport</span><span style="font-family: 宋体; font-size: 14px;">服务的执行结果直接影响登录结果，此处的“登录页面”与“</span><span style="font-family: Calibri; font-size: 14px;">passport</span><span style="font-family: 宋体; font-size: 14px;">服务”就必须使用调用关系，而不能使用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">通信。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">无论如何，记住这个<strong>结论</strong>：</span><strong><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">调用方实时依赖执行结果的业务场景，请使用调用，而不是</span><span style="font-family: Calibri; font-size: 14px;">MQ</span></span></strong><span style="font-family: 宋体; font-size: 14px;">。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">四、什么时候使用</span><span style="font-family: Calibri;">MQ</span></strong></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">【典型场景一：数据驱动的任务依赖】</span></strong></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;什么是任务依赖，</span><span style="font-family: 宋体; font-size: 14px;">举个<span style="font-family: 宋体; font-size: 16px;"><strong>栗子</strong></span>，互联网公司经常在凌晨进行一些数据统计任务，这些<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">任务之间有一定的依赖关系</span>，比如：</span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task3</span><span style="font-family: 宋体; font-size: 14px;">需要使用</span><span style="font-family: Calibri; font-size: 14px;">task2</span><span style="font-family: 宋体; font-size: 14px;">的输出作为输入</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task2</span><span style="font-family: 宋体; font-size: 14px;">需要使用</span><span style="font-family: Calibri; font-size: 14px;">task1</span><span style="font-family: 宋体; font-size: 14px;">的输出作为输入</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">这样的话，</span><span style="font-family: Calibri; font-size: 14px;">tast1, task2, task3</span><span style="font-family: 宋体; font-size: 14px;">之间就有任务依赖关系，必须</span><span style="font-family: Calibri; font-size: 14px;">task1</span><span style="font-family: 宋体; font-size: 14px;">先执行，再</span><span style="font-family: Calibri; font-size: 14px;">task2</span><span style="font-family: 宋体; font-size: 14px;">执行，载</span><span style="font-family: Calibri; font-size: 14px;">task3</span><span style="font-family: 宋体; font-size: 14px;">执行。</span></span></p><p><img src="/road5858/images/87b0cfd0e18fe3b57f76380ce8eeeb07dd52b292.png" style="width: 770px !important; height: 552.803px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">对于这类需求，<strong>常见的实现方式</strong>是，使用</span><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">cron</span><span style="font-family: 宋体; font-size: 14px;">人工排执行时间表</span></span><span style="font-family: 宋体; font-size: 14px;">：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task1</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">0:00</span><span style="font-family: 宋体; font-size: 14px;">执行，经验执行时间为</span><span style="font-family: Calibri; font-size: 14px;">50</span><span style="font-family: 宋体; font-size: 14px;">分钟</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task2</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">1:00</span><span style="font-family: 宋体; font-size: 14px;">执行（为</span><span style="font-family: Calibri; font-size: 14px;">task1</span><span style="font-family: 宋体; font-size: 14px;">预留</span><span style="font-family: Calibri; font-size: 14px;">10</span><span style="font-family: 宋体; font-size: 14px;">分钟</span><span style="font-family: Calibri; font-size: 14px;">buffer</span><span style="font-family: 宋体; font-size: 14px;">），经验执行时间也是</span><span style="font-family: Calibri; font-size: 14px;">50</span><span style="font-family: 宋体; font-size: 14px;">分钟</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task3</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">2:00</span><span style="font-family: 宋体; font-size: 14px;">执行（为</span><span style="font-family: Calibri; font-size: 14px;">task2</span><span style="font-family: 宋体; font-size: 14px;">预留</span><span style="font-family: Calibri; font-size: 14px;">10</span><span style="font-family: 宋体; font-size: 14px;">分钟</span><span style="font-family: Calibri; font-size: 14px;">buffer</span><span style="font-family: 宋体; font-size: 14px;">）</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">这种方法的<strong>坏处</strong>是：</span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）如果有一个任务</span><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">执行时间超过了预留</span><span style="font-family: Calibri; font-size: 14px;">buffer</span><span style="font-family: 宋体; font-size: 14px;">的时间，将会得到错误的结果</span></span><span style="font-family: 宋体; font-size: 14px;">，因为后置任务不清楚前置任务是否执行成功，此时要手动重跑任务，还有可能要调整排班表</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）总任务的<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">执行时间很长</span>，总是要预留很多</span><span style="font-family: Calibri; font-size: 14px;">buffer</span><span style="font-family: 宋体; font-size: 14px;">，如果前置任务提前完成，后置任务不会提前开始</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）如果一个任务被多个任务依赖，这个任务将会称为关键路径，排班表很难体现依赖关系，<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">容易出错</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">4</span><span style="font-family: 宋体; font-size: 14px;">）如果有一个任务的执行时间要调整，将会有<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">多个任务的执行时间要调整</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">无论如何，采用“</span><span style="font-family: Calibri; font-size: 14px;">cron</span><span style="font-family: 宋体; font-size: 14px;">排班表”的方法，各任务耦合，<strong>谁用过谁痛谁知道</strong>（采用此法的请评论留言）</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><img src="/road5858/images/e94c2308891d7e11e4fa146056a3c92e8a428567.png" style="width: 770px !important; height: 413.994px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">优化方案是，采用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">解耦：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task1</span><span style="font-family: 宋体; font-size: 14px;">准时开始，结束后发一个“</span><span style="font-family: Calibri; font-size: 14px;">task1 done</span><span style="font-family: 宋体; font-size: 14px;">”的消息</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task2</span><span style="font-family: 宋体; font-size: 14px;">订阅“</span><span style="font-family: Calibri; font-size: 14px;">task1 done</span><span style="font-family: 宋体; font-size: 14px;">”的消息，收到消息后第一时间启动执行，结束后发一个“</span><span style="font-family: Calibri; font-size: 14px;">task2 done</span><span style="font-family: 宋体; font-size: 14px;">”的消息</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="font-family: Calibri; font-size: 14px;">task3</span><span style="font-family: 宋体; font-size: 14px;">同理</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">采用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">的<strong>优点</strong>是：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）不需要预留</span><span style="font-family: Calibri; font-size: 14px;">buffer</span><span style="font-family: 宋体; font-size: 14px;">，上游任务执行完，<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">下游任务总会在第一时间被执行</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）依赖多个任务，被多个任务依赖都很好处理，<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">只需要订阅相关消息</span>即可</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）有任务执行时间变化，下游任务都<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">不需要调整执行时间</span></span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">需要<strong>特别说明</strong>的是，</span><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">只用来传递上游任务执行完成的消息，并不用于传递真正的输入输出数据</span></span><span style="font-family: 宋体; font-size: 14px;">。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">【典型场景二：上游不关心执行结果】</span></strong></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">上游需要关注执行结果时要用“调用”，上游不关注执行结果时，就可以使用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">了。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">举个<span style="font-family: 宋体; font-size: 16px;"><strong>栗子</strong></span>，</span><span style="font-family: Calibri; font-size: 14px;">58</span><span style="font-family: 宋体; font-size: 14px;">同城的很多下游需要关注“用户发布帖子”这个事件，比如招聘用户发布帖子后，招聘业务要奖励</span><span style="font-family: Calibri; font-size: 14px;">58</span><span style="font-family: 宋体; font-size: 14px;">豆，房产用户发布帖子后，房产业务要送</span><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">个置顶，二手用户发布帖子后，二手业务要修改用户统计数据。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><img src="/road5858/images/9ea3ea85a200d0ea3b75b9e67518b0ab26c1864f.png" style="width: 770px !important; height: 328.382px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">对于这类需求，<strong>常见的实现方式</strong>是，使用<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">调用关系</span>：</span></p><p><span style="font-family: 宋体; font-size: 14px;">帖子发布服务执行完成之后，调用下游招聘业务、房产业务、二手业务，来完成消息的通知，但事实上，这个通知是否正常正确的执行，帖子发布服务根本不关注。</span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">这种方法的<strong>坏处</strong>是：</span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）帖子发布流程的执行<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">时间增加</span>了</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）下游服务当机，可能导致帖子发布服务受影响，</span><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">上下游逻辑</span><span style="font-family: Calibri; font-size: 14px;">+</span><span style="font-family: 宋体; font-size: 14px;">物理依赖严重</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）每当增加一个需要知道“帖子发布成功”信息的下游，修改代码的是帖子发布服务，这一点是最恶心的，属于<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">架构设计中典型的依赖倒转<span style="font-family:宋体">，</span><span style="color: rgb(0, 0, 0); font-family: 宋体; font-size: 14px;"><strong><span style="font-family: 宋体;">谁用过谁痛谁知道</span></strong><span style="font-family: 宋体;">（采用此法的请评论留言）</span></span></span></span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><img src="/road5858/images/8699464f5f956537de0aebc65ea04b23e1bac479.png" style="width: 770px !important; height: 485.654px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">优化方案是，采用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">解耦：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）帖子发布成功后，向</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">发一个消息</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）哪个下游关注“帖子发布成功”的消息，主动去</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">订阅</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">采用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">的<strong>优点</strong>是：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）上游<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">执行时间短</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）</span><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">上下游逻辑</span><span style="font-family: Calibri; font-size: 14px;">+</span><span style="font-family: 宋体; font-size: 14px;">物理解耦</span></span><span style="font-family: 宋体; font-size: 14px;">，除了与</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">有物理连接，模块之间都不相互依赖</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">新增一个下游消息关注方，上游不需要修改任何代码</span></span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">典型场景三：上游关注执行结果，但执行时间很长</span></strong></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">有时候上游需要关注执行结果，但执行结果时间很长（典型的是<span style="font-family:宋体">调用</span><span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">离线处理，或者跨公网调用</span>），也经常使用</span><strong><span style="font-family: 宋体; font-size: 14px;">回调网关</span><span style="font-family: Calibri; font-size: 14px;">+MQ</span></strong><span style="font-family: 宋体; font-size: 14px;">来解耦。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">举个<span style="font-family: 宋体; font-size: 16px;"><strong>栗子</strong></span>，微信支付，跨公网调用微信的接口，执行时间会比较长，但调用方又非常关注执行结果，此时一般怎么玩呢？</span></p><p><img src="/road5858/images/60897e3cb637a7c7dd497c261c949aebf57e2de4.png" style="width: 770px !important; height: 333.976px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">一般采用“回调网关</span><span style="font-family: Calibri; font-size: 14px;">+MQ</span><span style="font-family: 宋体; font-size: 14px;">”方案来解耦：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）调用方直接跨公网调用微信接口</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">2</span><span style="font-family: 宋体; font-size: 14px;">）微信返回调用成功，此时并不代表返回成功</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">）微信执行完成后，回调统一网关</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">4</span><span style="font-family: 宋体; font-size: 14px;">）网关将返回结果通知</span><span style="font-family: Calibri; font-size: 14px;">MQ</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">5</span><span style="font-family: 宋体; font-size: 14px;">）请求方收到结果通知</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">这里<strong>需要注意</strong>的是，<span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">不应该由回调网关来调用上游来通知结果</span>，如果是这样的话，每次新增调用方，回调网关都需要修改代码，仍然会反向依赖，使用</span><strong><span style="font-family: 宋体; font-size: 14px;">回调网关</span><span style="font-family: Calibri; font-size: 14px;">+MQ</span></strong><span style="font-family: 宋体; font-size: 14px;">的方案，新增任何对微信支付的调用，都不需要修改代码啦。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">五、总结</span></strong></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">MQ是一个互联网架构中常见的解耦利器。</span></strong></p><p><strong><span style="font-family: 宋体; font-size: 14px;"><br></span></strong></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">什么时候不使用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">？</span></span></strong></p><p><span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">上游实时关注执行结果</span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">什么时候使用</span><span style="font-family: Calibri; font-size: 14px;">MQ</span><span style="font-family: 宋体; font-size: 14px;">？</span></span></strong></p><p><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">1</span><span style="font-family: 宋体; font-size: 14px;">）数据驱动的任务依赖</span></span></p><p><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="color: rgb(244, 114, 7); font-family: Calibri; font-size: 14px;">2</span><span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">）上游不关心多下游执行结果</span></span></p><p><span style="color: rgb(244, 114, 7); font-size: 14px;"><span style="color: rgb(244, 114, 7); font-family: Calibri; font-size: 14px;">3</span><span style="color: rgb(244, 114, 7); font-family: 宋体; font-size: 14px;">）异步返回执行时间长</span></span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-size: 14px; font-family: 宋体;">==【完】==</span></p><p><span style="font-size: 14px; font-family: 宋体;">相关阅读：</span></p><p><span style="text-decoration: none;"><span style="font-family: 宋体; font-size: 14px; text-decoration: none;">《</span><span style="font-size: 14px; text-decoration: none;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect"><span style="color: rgb(0, 102, 204); font-family: Calibri; font-size: 14px; text-decoration: none;">MQ</span><span style="color: rgb(0, 102, 204); font-family: 宋体; font-size: 14px; text-decoration: none;">如何实现延时消息</span></a><span style="font-family: 宋体; font-size: 14px; text-decoration: none;">》</span></span></span></p><p><span style="text-decoration: none;"><span style="font-family: 宋体; font-size: 14px; text-decoration: none;">《</span><span style="font-size: 14px; text-decoration: none;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect"><span style="color: rgb(0, 102, 204); font-family: Calibri; font-size: 14px; text-decoration: none;">MQ</span><span style="color: rgb(0, 102, 204); font-family: 宋体; font-size: 14px; text-decoration: none;">如何实现消息必达</span></a><span style="font-family: 宋体; font-size: 14px; text-decoration: none;">》</span></span></span></p><p><span style="text-decoration: none;"><span style="font-family: 宋体; font-size: 14px; text-decoration: none;">《</span><span style="font-size: 14px; text-decoration: none;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960002&amp;idx=1&amp;sn=c0775231bccf002c3178eabe43f1cdcb&amp;chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960002&amp;idx=1&amp;sn=c0775231bccf002c3178eabe43f1cdcb&amp;chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&amp;scene=21#wechat_redirect"><span style="color: rgb(0, 102, 204); font-family: Calibri; font-size: 14px; text-decoration: none;">MQ</span><span style="color: rgb(0, 102, 204); font-family: 宋体; font-size: 14px; text-decoration: none;">如何实现幂等性</span></a><span style="font-family: 宋体; font-size: 14px; text-decoration: none;">》</span></span></span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">栗子不少，有收获确实可以帮转一手。</span></p>
{% endraw  %}

