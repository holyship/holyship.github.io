---
title: 小小的IP，大大的耦合，你痛过吗？
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-2-rM19QPpY5EpqhdAD6TBeaF38IqeT198Af-HFeVgUwWCVIInkrW0eRptdQFmxfYZ1EPUmuY9jEzsULpPyoxD4=
date: '2017-11-23 00:00:00 +0000'

---

{% raw  %}
<p><strong><span style="font-size: 14px;letter-spacing: 1px;">什么是耦合？</span></strong><br></p><p><span style="font-size: 14px;letter-spacing: 1px;">耦合，是架构中，本来不相干的代码、模块、服务、系统因为某些原因联系在一起，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">各自独立性差</span>，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">影响则相互影响</span>，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">变动则相互变动</span>的一种架构状态。</span></p><p><br></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">感官上，怎么发现系统中的耦合？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">作为技术人，每每在心中骂上下游，骂兄弟部门，“这个东西跟我有什么关系？为什么需要我来配合做这个事情？”。</span><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">明明不应该联动，却要被动配合</span><span style="font-size: 14px;letter-spacing: 1px;">，就可能有潜在的耦合。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="letter-spacing: 1px;">因为IP配置，导致上下游必须联动，就是一个耦合的典型案例。</span></strong></span></p><p><br></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">场景还原</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">线上有一台数据库服务器，因为某种原因，例如磁盘故障，要进行更换。运维部署了一台新机器，DBA部署好数据库实例，做好了数据，只等调用方切换。</span></p><p><br></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">如何切换呢？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">原来数据库有个旧IP，现在有个新IP，要通知上游将流量切到新IP上来，怎么办？</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">一一通知上游切换呗。找到上游，抱歉，IP换了，麻烦修改配置重启一下，连到新的IP上去。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;"></span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzmHdUtaJia2IwTK9IDFIUZITjGcHupq4km8PwGtmo1GT6nfySvrZ3tSBibQccu1UF1zdMO2ia5bHDYw/0?wx_fmt=png" style="width: 684px !important; height: 321px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">不知道大家工作中会不会遇到这样的场景，数据库或者服务的IP换了，你作为上游的调用方，需要配合修改配置重启。此时你心里可能就在骂娘了，明明变化IP的是别人，为什么配合修改配置重启的人是我。</span></p><p><br></p><p><span style="font-size: 14px;letter-spacing: 1px;">特别的，如果变换IP的是一个基础服务或者一个基础数据库，调用它的上游很多，那么可能A部门、B部门、C部门，要全部找一遍，全部配合修改配置重启。</span></p><p><br></p><p><span style="font-size: 14px;letter-spacing: 1px;">所以这个因为IP配置使得上下游耦合在一起的案例，其耦合范围非常广的，<strong>理想的情况是</strong>：<span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">谁修改IP，只有一处修改</span>，流量就能默默迁移过去，这就是解耦。</span></p><p><br></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">如何解除IP耦合？</span></strong></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">常见的方法是</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">使用内网域名替代内网IP</span>，如果没有做这个优化，强烈的建议马上实施，将配置文件中的内网IP全部干掉，全部改为内网域名。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">使用内网域名，就不需要上游配合重启了吗？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">假设现在不用内网IP，改用内网域名了，一个服务或者数据库的IP变更，只需要一个地方更改，而不是所有上游更改：</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"></span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzmHdUtaJia2IwTK9IDFIUZIc84WZS6nZRIMia8D7zYYhQRL7Ju6ujxdWbDYZCsHEmQgrcvCbwzOvsQ/0?wx_fmt=png" style="width: 710px !important; height: 314px !important;"></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">运维修改内网DNS，将内网域名指向新的IP</span></strong><span style="font-size: 14px;letter-spacing: 1px;">，如果是短连接调用，未来新的请求流量，自然会切到新的IP上；如果是长连接调用，新的长连接会连到新的IP上，但旧的长连接仍然连接的是旧IP</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">运维统一将旧IP上的连接切断</span></strong><span style="font-size: 14px;letter-spacing: 1px;">，如无意外，服务或者数据库的连接池都有<span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">重连</span>功能，重连后就会自动连到新IP上去</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">如此这般，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">只要运维配合就可以完成IP的迁移</span>，对于所有上游的调用方不需要配合修改配置重启。</span></p><p><br></p><p><span style="font-size: 18px;"><strong><span style="letter-spacing: 1px;">使用内网域名来替换内网IP</span></strong></span><span style="font-size: 14px;letter-spacing: 1px;">，只是一个很小的优化点，但对于<span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">IP解耦</span>却是非常的有效。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">希望大家每天收获一点点，这样架构就能美好一点点。</span></p><p><br></p><p><span style="font-size: 14px;letter-spacing: 1px;">你痛过吗？那帮<span style="color: rgb(255, 76, 0);letter-spacing: 1px;font-size: 14px;">转</span>下。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-2-rM19QPpY5EpqhdAD6TBeaF38IqeT198Af-HFeVgUwWCVIInkrW0eRptdQFmxfYZ1EPUmuY9jEzsULpPyoxD4=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960558&amp;idx=1&amp;sn=57189db18602b77bfcce1a258f66e329&amp;chksm=bd2d01328a5a88245d4d91b90abf759c4a112562785c5641e7b8835097ab2e7bfce10efa1c32#rd">阅读原文</a>
{% endraw  %}

