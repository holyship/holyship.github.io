---
title: 消息总线真的能保证幂等？
author: 58沈剑
date: '2017-03-31 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;"><strong><span style="font-family: 宋体;">一、缘起</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">如《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect">消息总线消息必达</a>》所述，MQ消息必达，架构上有两个核心设计点：</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）消息落地</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）消息超时、重传、确认</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><img src="/road5858/images/b010c943ed85e1131696c547944ea2c43f82e35a.png" style="width: 298px !important; height: 154px !important; visibility: visible !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">再次回顾消息总线核心架构，它由<strong>发送端、服务端、固化存储、接收端</strong>四大部分组成。</span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">为保证消息的可达性，超时、重传、确认机制<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 104, 39);">可能导致消息总线、或者业务方<strong>收到重复的消息</strong></span>，从而对业务产生影响。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">举个栗子：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">购买会员卡，上<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">游支付系统负责给用户扣款</span>，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">下游系统负责给用户发卡</span>，通过MQ异步通知。不管是上半场的</span>ACK<span style="font-size: 14px; font-family: 宋体;">丢失，导致</span>MQ<span style="font-size: 14px; font-family: 宋体;">收到重复的消息，还是下半场</span>ACK<span style="font-size: 14px; font-family: 宋体;">丢失，导致购卡系统收到重复的购卡通知，都可能出现，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">上游扣了一次钱，下游发了多张卡</span>。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;"><strong>消息总线的幂等性设计</strong>至关重要，是本文将要讨论的重点。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">二、上半场的幂等性设计</span></strong></span></p><p><img src="/road5858/images/b010c943ed85e1131696c547944ea2c43f82e35a.png" style="line-height: 25.6px; white-space: normal; width: 298px !important; height: 154px !important;"></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">消息发送上半场，即上图中的</span>1-3</span></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">，发送端</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">将消息发给服务端</span>MQ-server</span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">，服务端</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">将消息落地</span></span></p><p><span style="font-size: 14px;">3<span style="font-size: 14px; font-family: 宋体;">，服务端</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">回</span>ACK<span style="font-size: 14px; font-family: 宋体;">给发送端</span>MQ-client</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果</span><span style="font-size: 14px; color: rgb(255, 104, 39);">3<span style="font-size: 14px; font-family: 宋体;">丢失</span></span><span style="font-size: 14px; font-family: 宋体;">，发送端</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">超时后会重发消息，</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">可能导致服务端</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">收到重复消息</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">此时</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">重发是</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">发起的，消息的处理是</span>MQ-server</span><span style="font-size: 14px; font-family: 宋体;">，为了避免步骤</span>2<span style="font-size: 14px; font-family: 宋体;">落地重复的消息，对每条消息，</span><strong>MQ<span style="font-size: 14px; font-family: 宋体;">系统内部必须生成一个</span>inner-msg-id</strong><span style="font-size: 14px; font-family: 宋体;">，作为去重和幂等的依据，这个</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">内部消息</span>ID</span><span style="font-size: 14px; font-family: 宋体;">的特性是：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）全局唯一</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）</span>MQ<span style="font-size: 14px; font-family: 宋体;">生成，具备业务无关性，对消息发送方和消息接收方屏蔽</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">有了这个</span>inner-msg-id<span style="font-size: 14px; font-family: 宋体;">，就能保证上半场重发，也只有</span>1<span style="font-size: 14px; font-family: 宋体;">条消息落到</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">的</span>DB<span style="font-size: 14px; font-family: 宋体;">中，实现上半场</span><span style="font-size: 14px; font-family: 宋体;">幂等。</span></span></strong></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">三、下半场的幂等性设计</span></strong></span></p><p><img src="/road5858/images/b010c943ed85e1131696c547944ea2c43f82e35a.png" style="line-height: 25.6px; white-space: normal; width: 298px !important; height: 154px !important;"></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">消息发送下半场，即上图中的</span>4-6</span></p><p><span style="font-size: 14px;">4<span style="font-size: 14px; font-family: 宋体;">，服务端</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">将消息发给接收端</span>MQ-client</span></p><p><span style="font-size: 14px;">5<span style="font-size: 14px; font-family: 宋体;">，接收端</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">回</span>ACK<span style="font-size: 14px; font-family: 宋体;">给服务端</span></span></p><p><span style="font-size: 14px;">6<span style="font-size: 14px; font-family: 宋体;">，服务端</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">将落地消息删除</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">需要强调的是，</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">接收端</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">回</span>ACK<span style="font-size: 14px; font-family: 宋体;">给服务端</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">，是消息消费业务方的主动调用行为，不能由</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">自动发起</span></span><span style="font-size: 14px; font-family: 宋体;">，因为</span>MQ<span style="font-size: 14px; font-family: 宋体;">系统不知道消费方什么时候真正消费成功。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果</span><span style="font-size: 14px; color: rgb(255, 104, 39);">5<span style="font-size: 14px; font-family: 宋体;">丢失</span></span><span style="font-size: 14px; font-family: 宋体;">，服务端</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">超时后会重发消息，</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">可能导致</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">收到重复的消息</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">此时重发是</span><span style="font-size: 14px; color: rgb(255, 104, 39);">MQ-server<span style="font-size: 14px; font-family: 宋体;">发起的</span></span><span style="font-size: 14px; font-family: 宋体;">，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">消息的处理是消息消费业务方</span>，消息重发势必导致业务方重复消费（上例中的一次付款，重复发卡），为了保证业务幂等性</span><strong><span style="font-size: 14px; font-family: 宋体;">，业务消息体中，必须有一个</span>biz-id</strong><span style="font-size: 14px; font-family: 宋体;">，作为去重和幂等的依据，这个</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">业务</span>ID</span><span style="font-size: 14px; font-family: 宋体;">的特性是：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）对于同一个业务场景，全局唯一</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）由业务消息发送方生成，业务相关，对</span>MQ<span style="font-size: 14px; font-family: 宋体;">透明</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>3<span style="font-size: 14px; font-family: 宋体;">）由业务消息消费方负责判重，以保证幂等</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">最常见的业务</span>ID<span style="font-size: 14px; font-family: 宋体;">有：支付</span>ID<span style="font-size: 14px; font-family: 宋体;">，订单</span>ID<span style="font-size: 14px; font-family: 宋体;">，帖子</span>ID<span style="font-size: 14px; font-family: 宋体;">等。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">具体到支付购卡场景，发送方必须将支付</span>ID<span style="font-size: 14px; font-family: 宋体;">放到消息体中，消费方必须对同一个支付</span>ID<span style="font-size: 14px; font-family: 宋体;">进行判重，保证购卡的幂等。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">有了这个业务ID，才能够保证下半场消息消费业务方即使收到重复消息，也只有</span>1<span style="font-size: 14px; font-family: 宋体;">条消息被消费，保证了幂等。</span></span></strong></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">三、总结</span></strong></span></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">为了保证消息必达，消息上下半场均可能发送重复消息，如何保证消息的幂等性呢？</span></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">上半场</span></strong></p><p><span style="font-size: 14px; color: rgb(255, 104, 39);">MQ-client<span style="font-size: 14px; font-family: 宋体;">生成</span>inner-msg-id<span style="font-size: 14px; font-family: 宋体;">，保证上半场幂等</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></p><p><span style="font-size: 14px; font-family: 宋体;">这个ID全局唯一，业务无关，由MQ保证。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">下半场</span></strong></p><p><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">业务<strong>发送方</strong>带入</span>biz-id<span style="font-size: 14px; font-family: 宋体;">，业务<strong>接收方去重</strong>保证幂等</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></p><p><span style="font-size: 14px; font-family: 宋体;">这个ID对单业务唯一，业务相关，对MQ透明。</span></p><p><span style="font-size: 14px; font-family: 宋体;"><br></span></p><p><span style="font-size: 14px; font-family: 宋体;">结论：幂等性，不仅对MQ有要求，对业务上下游也有要求。</span></p><p><span style="font-size: 14px; font-family: 宋体;"><br></span></p><p><span style="font-size: 14px; font-family: 宋体;">==【完】==</span></p><p><span style="font-size: 14px; font-family: 宋体;">相关阅读：<br></span></p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect"><span style="font-size: 14px; font-family: 宋体;">“延迟消息”如何实现</span></a><span style="font-size: 14px; font-family: 宋体;"><br></span></p><p><span style="font-size: 14px; font-family: 宋体;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect">消息总线能否实现消息必达</a></span></p>
{% endraw  %}

