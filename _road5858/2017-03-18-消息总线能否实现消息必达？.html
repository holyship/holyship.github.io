---
title: 消息总线能否实现消息必达？
author: 58沈剑
date: '2017-03-18 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;"><strong><span style="font-family: 宋体;">一、缘起</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">上周讨论了两期环形队列的业务应用：</span></p><p><span style="font-size: 14px; font-family: 宋体;">《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959957&amp;idx=1&amp;sn=a82bb7e8203b20b2a0cb5fc95b7936a5&amp;chksm=bd2d07498a5a8e5f9f8e7b5aeaa5bd8585a0ee4bf470956e7fd0a2b36d132eb46553265f4eaf&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959957&amp;idx=1&amp;sn=a82bb7e8203b20b2a0cb5fc95b7936a5&amp;chksm=bd2d07498a5a8e5f9f8e7b5aeaa5bd8585a0ee4bf470956e7fd0a2b36d132eb46553265f4eaf&amp;scene=21#wechat_redirect">高效定时任务的触发</a>》</span></p><p><span style="font-size: 14px; font-family: 宋体;">《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect">延迟消息的快速实现</a></span>》</p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">两期的均有大量读者提问：</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">任务、延迟消息都放在内存里，万一重启了怎么办？</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">能否保证消息必达？</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">今天就简单聊聊</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">消息队列（</span>MsgQueue<span style="font-size: 14px; font-family: 宋体;">）的消息必达性架构与流程</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">二、架构方向</span></strong></span></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">要想尽量消息必达，架构上有两个核心设计点：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）<strong>消息落地</strong></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）<strong>消息超时、重传、确认</strong></span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">三、</span></strong><strong><span style="font-size: 16px;">MQ</span></strong><strong><span style="font-size: 16px; font-family: 宋体;">核心架构</span></strong></span></p><p><img src="/road5858/images/3fd63827cd3bcdcb081f391cfcf46a0045db05d0.png" style="width: auto !important; height: auto !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">上图是一个</span>MQ<span style="font-size: 14px; font-family: 宋体;">的核心架构图，基本可以分为三大块：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）<strong>发送方</strong></span> -&gt; <span style="font-size: 14px; font-family: 宋体;">左侧<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">粉色</span>部分</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）</span><strong>MQ<span style="font-size: 14px; font-family: 宋体;">核心集群</span></strong> -&gt; <span style="font-size: 14px; font-family: 宋体;">中间<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">蓝色</span>部分</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>3<span style="font-size: 14px; font-family: 宋体;">）<strong>接收方</strong></span> -&gt; <span style="font-size: 14px; font-family: 宋体;">右侧<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">黄色</span>部分</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">粉色发送方</span></strong><span style="font-size: 14px; font-family: 宋体;">又由两部分构成：<strong>业务调用方</strong>与</span><strong>MQ-client-sender</strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">其中后者向前者提供了</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">两个核心</span>API</span><span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><span style="font-size: 12px;"><span style="color: rgb(255, 104, 39);">SendMsg</span>(bytes[] msg)</span></p><p><span style="font-size: 12px;"><span style="color: rgb(255, 104, 39);">SendCallback</span>()</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">蓝色</span>MQ</strong><strong><span style="font-size: 14px; font-family: 宋体;">核心集群</span></strong><span style="font-size: 14px; font-family: 宋体;">又分为四个部分：</span><strong>MQ-server<span style="font-size: 14px; font-family: 宋体;">，</span>zk<span style="font-size: 14px; font-family: 宋体;">，</span>db<span style="font-size: 14px; font-family: 宋体;">，管理后台</span>web</strong></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">黄色接收方</span></strong><span style="font-size: 14px; font-family: 宋体;">也由两部分构成：<strong>业务接收方</strong>与</span><strong>MQ-client-receiver</strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">其中后者向前者提供了</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">两个核心</span>API</span><span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><span style="font-size: 12px; color: rgb(255, 104, 39);">RecvCallback</span><span style="font-size: 12px;">(bytes[] msg)</span></p><p><span style="font-size: 12px;"><span style="font-size: 12px; color: rgb(255, 104, 39);">SendAck</span>()</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px; color: rgb(255, 104, 39);">MQ<span style="font-size: 14px; font-family: 宋体;">是一个系统间解耦的利器</span></span><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，它能够很好的解除发布订阅者之间的耦合，它将上下游的消息投递解耦成两个部分，如上述架构图中的</span>1<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">箭头</span><span style="font-size: 14px; font-family: 宋体;">和</span>2<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">箭头</span><span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）发送方将消息投递给</span>MQ<span style="font-size: 14px; font-family: 宋体;">，<strong>上半场</strong></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）</span>MQ<span style="font-size: 14px; font-family: 宋体;">将消息投递给接收方，<strong>下半场</strong></span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">四、</span></strong><strong><span style="font-size: 16px;">MQ</span></strong><strong><span style="font-size: 16px; font-family: 宋体;">消息可靠投递核心流程</span></strong></span></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">既然将消息投递拆成了上下半场，为了保证消息的可靠投递，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">上下半场都必须尽量保证消息必达</span>。</span></span></p><p><img src="/road5858/images/b010c943ed85e1131696c547944ea2c43f82e35a.png" style="width: 298px !important; height: 154px !important;"></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">消息投递<strong>上半场</strong>，</span>MQ-client-sender<span style="font-size: 14px; font-family: 宋体;">到</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">流程见上图</span>1-3<span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">将消息发送给</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">（此时业务方调用的是</span>API<span style="font-size: 14px; font-family: 宋体;">：</span>SendMsg<span style="font-size: 14px; font-family: 宋体;">）</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">将<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">消息落地，落地后即为发送成功</span></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>3<span style="font-size: 14px; font-family: 宋体;">）</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">将应答发送给</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">（此时回调业务方是</span>API<span style="font-size: 14px; font-family: 宋体;">：</span>SendCallback<span style="font-size: 14px; font-family: 宋体;">）</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">消息投递<strong>下半场</strong>，</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">到</span>MQ-client-receiver<span style="font-size: 14px; font-family: 宋体;">流程见上图</span>4-6<span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">将消息发送给</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">（此时回调业务方是</span>API<span style="font-size: 14px; font-family: 宋体;">：</span>RecvCallback<span style="font-size: 14px; font-family: 宋体;">）</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">回复应答给</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">（此时业务方主动调用</span>API<span style="font-size: 14px; font-family: 宋体;">：</span>SendAck<span style="font-size: 14px; font-family: 宋体;">）</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>3<span style="font-size: 14px; font-family: 宋体;">）</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">收到</span>ack<span style="font-size: 14px; font-family: 宋体;">，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">将之前已经落地的消息删除，完成消息的可靠投递</span></span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">如果消息丢了怎么办？</span></strong></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">消息投递的上下半场，都可以出现消息丢失，</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">为了降低消息丢失的概率，</span>MQ<span style="font-size: 14px; font-family: 宋体;">需要进行超时和重传</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">上半场的超时与重传</span></strong></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">上半场的</span>1<span style="font-size: 14px; font-family: 宋体;">或者</span>2<span style="font-size: 14px; font-family: 宋体;">或者</span>3<span style="font-size: 14px; font-family: 宋体;">如果丢失或者超时，</span>MQ-client-sender<span style="font-size: 14px; font-family: 宋体;">内的</span>timer<span style="font-size: 14px; font-family: 宋体;">会重发消息，直到期望收到</span>3<span style="font-size: 14px; font-family: 宋体;">，如果重传</span>N<span style="font-size: 14px; font-family: 宋体;">次后还未收到，则</span>SendCallback<span style="font-size: 14px; font-family: 宋体;">回调发送失败，需要注意的是，这个过程中</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">可能会收到同一条消息的多次重发。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">下半场的超时与重传</span></strong></p><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">下半场的</span>4<span style="font-size: 14px; font-family: 宋体;">或者</span>5<span style="font-size: 14px; font-family: 宋体;">或者</span>6<span style="font-size: 14px; font-family: 宋体;">如果丢失<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">或者超时</span>，</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">内的</span>timer<span style="font-size: 14px; font-family: 宋体;">会重发消息，直到收到</span>5<span style="font-size: 14px; font-family: 宋体;">并且成功执行</span>6<span style="font-size: 14px; font-family: 宋体;">，这个过程可能会重发很多次消息，一般采用<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">指数退避的策略</span>，先隔</span>x<span style="font-size: 14px; font-family: 宋体;">秒重发，</span>2x<span style="font-size: 14px; font-family: 宋体;">秒重发，</span>4x<span style="font-size: 14px; font-family: 宋体;">秒重发，以此类推，需要注意的是，这个过程中</span>MQ-client-receiver<span style="font-size: 14px; font-family: 宋体;">也可能会收到同一条消息的多次重发。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">MQ-client<span style="font-size: 14px; font-family: 宋体;">与</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">如何进行消息去重，如何进行架构幂等性设计，下一次撰文另述，此处暂且认为为了保证消息必达，可能收到重复的消息。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">五、总结</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">消息总线是系统之间的解耦利器，但切勿滥用，未来也会撰文细究</span>MQ<span style="font-size: 14px; font-family: 宋体;">的使用场景，消息总线为了尽量保证消息必达，架构设计方向为：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>1<span style="font-size: 14px; font-family: 宋体;">）<strong>消息收到先落地</strong></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">（</span>2<span style="font-size: 14px; font-family: 宋体;">）<strong>消息超时、重传、确认保证消息必达</strong></span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">有问题随时沟通交流，后续讲消息去重、幂等性设计、何时该使用</span>MQ<span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">==【完】==</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">相关阅读：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959886&amp;idx=1&amp;sn=03e45a5014053607eff5e55ed2c660d7&amp;chksm=bd2d07928a5a8e8454d395e176fa9d346682abfe9dfbf3244f1dead83ee4508aa25121f9b811&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959886&amp;idx=1&amp;sn=03e45a5014053607eff5e55ed2c660d7&amp;chksm=bd2d07928a5a8e8454d395e176fa9d346682abfe9dfbf3244f1dead83ee4508aa25121f9b811&amp;scene=21#wechat_redirect">架构师之路16年精选66篇</a><br></span></span></p>
{% endraw  %}

