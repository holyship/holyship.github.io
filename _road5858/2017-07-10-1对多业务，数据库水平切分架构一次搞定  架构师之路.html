---
title: 1对多业务，数据库水平切分架构一次搞定 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499656649&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvW1gSMMfgEt5EdAbfzM6PjFHlOYWGtySuV7QzFwUsJRtBEcZZtFpUZwXGF1fH9emhUVhBPpKGNZz6aOFoOmujaQmnxDdKrfpl7W7k2oWtFSdRlafSRn1tdnGhHbxi9HoqU3WgOkUfCxg7DLRheJ0Z46A=
date: '2017-07-10 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;"><span style="font-family: 宋体;">本文将以“帖子中心”为例，介绍“</span>1<span style="font-family: 宋体;">对多”类业务，随着数据量的逐步增大，数据库性能显著降低，数据库水平切分相关的架构实践：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; font-family: 宋体;">如何来实施水平切分</span></p></li><li><p><span style="font-size: 14px; font-family: 宋体;">水平切分后常见的问题</span></p></li><li><p><span style="font-size: 14px; font-family: 宋体;">典型问题的优化思路及实践</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">一、什么是</span>1</strong><strong><span style="font-family: 宋体;">对多关系</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">所谓的“</span>1<span style="font-size: 14px; font-family: 宋体;">对</span>1<span style="font-size: 14px; font-family: 宋体;">”，“</span>1<span style="font-size: 14px; font-family: 宋体;">对多”，“多对多”，来自数据库设计中的“实体</span>-<span style="font-size: 14px; font-family: 宋体;">关系”</span>ER<span style="font-size: 14px; font-family: 宋体;">模型，用来描述实体之间的映射关系。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">对</span>1</span></strong></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; font-family: 宋体;">一个用户只有一个登录名，一个登录名只对应一个用户</span></p></li><li><p><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">一个</span><span style="font-size: 14px; line-height: 1.6;">uid</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">对应<span style="font-size: 14px; line-height: 1.6; font-family: 宋体; color: rgb(255, 76, 0);">一个</span></span><span style="font-size: 14px; line-height: 1.6;">login_name<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">，一个login_name只对应<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px; color: rgb(255, 76, 0);">一个</span>uid</span></span></p></li></ul><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这是一个</span>1<span style="font-size: 14px; font-family: 宋体;">对</span>1<span style="font-size: 14px; font-family: 宋体;">的关系。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">对多</span></span></strong></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 宋体; font-size: 14px;">一个用户可以发多条微博，一条微博只有一个发送者</span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">一个</span>uid<span style="font-size: 14px; font-family: 宋体;">对应<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">多个</span></span>msg_id<span style="font-size: 14px; font-family: 宋体;">，一个</span>msg_id<span style="font-size: 14px; font-family: 宋体;">只对应<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">一个</span></span>uid</span></p></li></ul><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这是一个</span>1<span style="font-size: 14px; font-family: 宋体;">对多的关系。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">多对多</span></strong></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-family: 宋体; font-size: 14px;">一个用户可以关注<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">多个</span>用户</span></p></li><li><p><span style="font-family: 宋体; font-size: 14px;">一个用户也可以被<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">多个</span>粉丝关注</span></p></li></ul><p><span style="font-family: 宋体; font-size: 14px;">这是一个多对多的关系。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">二、帖子中心业务分析</span></strong></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXia1jVp6CE6wSeXEkVsCxrIicIhbnqCP8waqTGg2MqM5BglialJGgRXbHg/0?wx_fmt=png" style="width: 288px !important; height: 57px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">帖子中心是一个典型的</span>1<span style="font-size: 14px; font-family: 宋体;">对多业务。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXvVEian5vvmtRPAw9fEzu9Cia2CModeRSja03OWHwINJFKOeriaI0EuRHw/0?wx_fmt=png" style="width: 197px !important; height: 179px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">一个用户可以发布多个帖子，一个帖子只对应一个发布者。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">任何脱离业务的架构设计都是耍流氓</span><span style="font-family: 宋体; font-size: 14px;">，先来看看帖子中心对应的业务需求。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">帖子中心</span></strong><span style="font-family: 宋体; font-size: 14px;">，是一个提供帖子发布/修改/删除/查看/搜索的服务。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">写操作：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">发布</span>(insert)<span style="font-size: 14px; font-family: 宋体;">帖子</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">修改</span>(update)<span style="font-size: 14px; font-family: 宋体;">帖子</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">删除</span>(delete)<span style="font-size: 14px; font-family: 宋体;">帖子</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">读操作：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span>tid<span style="font-size: 14px; font-family: 宋体;">查询<span style="font-size: 14px; line-height: 22.4px;">(select)</span>帖子实体，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">单行查询</span></span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span>uid<span style="font-size: 14px; font-family: 宋体;">查询<span style="font-size: 14px; line-height: 22.4px;">(select)</span>用户发布过的帖子，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">列表查询</span></span></span></p></li><li><p><span style="font-family: 宋体; font-size: 14px;">帖子<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">检索</span>(search)，例如通过时间、标题、内容搜索符合条件的帖子</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">在数据量较大，并发量较大的时候，通常通过<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">元数据与索引数据分离</span>的<strong>架构</strong>来满足不同类型的需求：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXHMTsmxYeT0UJaHgoey0yedRByRCXGpHLqvjaFTsWtAV3dyUyAnvibgw/0?wx_fmt=png" style="width: 509px !important; height: 197px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">架构中的几个关键点：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">tiezi-center：<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">帖子</span><span style="font-size: 14px; font-family: 宋体;">服务</span></span></p></li><li><p><span style="font-size: 14px;">tiezi-db<span style="font-size: 14px; font-family: 宋体;">：提供元数据存储</span></span></p></li><li><p><span style="font-size: 14px;">tiezi-search：<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">帖子</span><span style="font-size: 14px; font-family: 宋体;">搜索服务</span></span></p></li><li><p><span style="font-size: 14px;">tiezi-index<span style="font-size: 14px; font-family: 宋体;">：提供索引数据存储</span></span></p></li><li><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">：</span>tiezi-center<span style="font-size: 14px; font-family: 宋体;">与</span>tiezi-search<span style="font-size: 14px; font-family: 宋体;">通讯媒介，一般不直接使用</span>RPC<span style="font-size: 14px; font-family: 宋体;">调用，而是通过</span>MQ<span style="font-size: 14px; font-family: 宋体;">对两个<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">子系统解耦</span>（为何这么解耦，请参见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect" target="_blank">到底什么时候该使用MQ？</a>》）</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">其中，</span>tiezi-center<span style="font-size: 14px; font-family: 宋体;">和</span>tiezi-search<span style="font-size: 14px; font-family: 宋体;">分别满足两类不同的<strong>读需求</strong>：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXicjhynt5sOe2RWPf1b39GEon7S5bKicup1y1niaKhFCsNU8Xpm6tzmJfw/0?wx_fmt=png" style="width: 510px !important; height: 219px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">如上图所示：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">tid<span style="font-size: 14px; font-family: 宋体;">和</span>uid<span style="font-size: 14px; font-family: 宋体;">上的查询需求，可以由</span>tiezi-center<span style="font-size: 14px; font-family: 宋体;">从<strong>元数据</strong>读取并返回</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">其他类检索需求，可以由</span>tiezi-search<span style="font-size: 14px; font-family: 宋体;">从<strong>索引数据</strong>检索并返回</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">对于<strong>写需求</strong>：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXwx7Yn4eorgd8G7icxyibmn7qzKMKtFPF9sj8OcFnTqOgGxaTO7BH1Jcg/0?wx_fmt=png" style="width: 539px !important; height: 214px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">如上图所示：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">增加，修改，删除的操作都会从</span>tiezi-center<span style="font-size: 14px; font-family: 宋体;">发起</span></span></p></li><li><p><span style="font-size: 14px;">tiezi-center<span style="font-size: 14px; font-family: 宋体;">修改元数据</span></span></p></li><li><p><span style="font-size: 14px;">tiezi-center<span style="font-size: 14px; font-family: 宋体;">将信息修改通知发送给</span>MQ</span></p></li><li><p><span style="font-size: 14px;">tiezi-search<span style="font-size: 14px; font-family: 宋体;">从</span>MQ<span style="font-size: 14px; font-family: 宋体;">接受修改信息</span></span></p></li><li><p><span style="font-size: 14px;">tiezi-search<span style="font-size: 14px; font-family: 宋体;">修改索引数据</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">tiezi-search<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">，搜索架构</span><span style="font-size: 14px; font-family: 宋体;">不是本文的重点（外置索引架构设计，请参见<span style="color: rgb(62, 62, 62); font-family: 宋体; font-size: 14px; line-height: 25.6px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959855&amp;idx=1&amp;sn=f33abe8ec598c273f29cebb9365ece59&amp;chksm=bd2d07f38a5a8ee58a944507a134e1da1efc3ac9c4d1c4cff261137cd986e51f5fe7cee9de15&amp;scene=21#wechat_redirect" target="_blank" style="font-family: 宋体; font-size: 14px; line-height: 25.6px; white-space: normal;">100亿数据1万属性数据架构设计</a><span style="color: rgb(62, 62, 62); font-family: 宋体; font-size: 14px; line-height: 25.6px;">》</span>），后文将重点描述帖子中心元数据这一块的水平切分设计。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">三、帖子中心元数据设计</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">通过帖子中心业务分析，很容易了解到，其核心元数据为：</span></p><p><span style="font-size: 12px;">Tiezi(tid, uid, time, title, content, …);</span></p><p><span style="font-family: 宋体; font-size: 14px;">其中：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">tid<span style="font-size: 14px; font-family: 宋体;">为帖子</span>ID<span style="font-size: 14px; font-family: 宋体;">，主键</span></span></p></li><li><p><span style="font-size: 14px;">uid<span style="font-size: 14px; font-family: 宋体;">为用户</span>ID<span style="font-size: 14px; font-family: 宋体;">，发帖人</span></span></p></li><li><p><span style="font-size: 14px;">time, title, content …<span style="font-size: 14px; font-family: 宋体;">等为帖子属性</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">数据库设计上，在业务初期，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">单库</span>就能满足元数据存储要求，其典型的架构设计为：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXPicic8trFqkyC5DaZVPRQ0s7HTdKsbjciaZK8rctibBjBQO7FsyUISkuLg/0?wx_fmt=png" style="width: 288px !important; height: 116px !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">tiezi-center<span style="font-size: 14px; font-family: 宋体;">：帖子中心服务，对调用者提供友好的</span>RPC<span style="font-size: 14px; font-family: 宋体;">接口</span></span></p></li><li><p><span style="font-size: 14px;">tiezi-db<span style="font-size: 14px; font-family: 宋体;">：对帖子数据进行存储</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">在相关字段上建立索引，就能满足相关业务需求：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">帖子记录查询，</span><strong><span style="font-size: 14px; font-family: 宋体;">通过</span>tid<span style="font-size: 14px; font-family: 宋体;">查询</span></strong><span style="font-size: 14px; font-family: 宋体;">，约占</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">读请求量</span>90%</span></span></p></li></ul><p><span style="font-size: 12px;">select * from t_tiezi where tid=$tid</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">帖子列表查询，</span><strong><span style="font-size: 14px; font-family: 宋体;">通过</span>uid<span style="font-size: 14px; font-family: 宋体;">查询</span></strong><span style="font-size: 14px; font-family: 宋体;">其发布的所有帖子，约占</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">读请求量</span>10%</span></span></p></li></ul><p><span style="font-size: 12px;">select * from t_tiezi where uid=$uid</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">四、帖子中心水平切分</span>-tid</strong><strong><span style="font-family: 宋体;">切分法</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">当数据量越来越大时，需要对帖子数据的存储进行线性扩展。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">既然是帖子中心，并且帖子记录查询量占了总请求的</span>90%<span style="font-size: 14px; font-family: 宋体;">，很容易想到</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">通过</span>tid<span style="font-size: 14px; font-family: 宋体;">字段取模来进行水平切分</span></span><span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXbAm7vrvMhCKK1eZiaxjHn9uUZ6uiaoS48bxXNWx5b7iaIFmueMKKZA37Q/0?wx_fmt=png" style="width: 320px !important; height: 170px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">这个方法简单直接，<strong>优点</strong>：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">100%<span style="font-size: 14px; font-family: 宋体;">写请求可以直接定位到库</span></span></p></li><li><p><span style="font-size: 14px;">90%<span style="font-size: 14px; font-family: 宋体;">的读请求可以直接定位到库</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">缺点</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">一个用户发布的所有帖子可能会落到不同的库上，</span>10%<span style="font-size: 14px; font-family: 宋体;">的请求通过</span>uid<span style="font-size: 14px; font-family: 宋体;">来查询会比较麻烦</span></span></p></li></ul><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXg7WAVHEk7IcIng2XhnekZrhhiagXlyACwyYaroW2bX7mPp6cuXcpBWA/0?wx_fmt=png" style="width: 321px !important; height: 172px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图，一个</span>uid<span style="font-size: 14px; font-family: 宋体;">访问需要遍历所有库。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">五、帖子中心水平切分</span>-uid</strong><strong><span style="font-family: 宋体;">切分法</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">有没有一种切分方法，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">确保同一个用户发布的所有帖子都落在同一个库上</span>，而在查询一个用户发布的所有帖子时，不需要去遍历所有的库呢？</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：使用</span><span style="font-size: 14px; color: rgb(255, 76, 0);">uid<span style="font-size: 14px; font-family: 宋体;">来分库</span></span><span style="font-size: 14px; font-family: 宋体;">可以解决这个问题。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">新出现的问题：如果使用</span>uid<span style="font-size: 14px; font-family: 宋体;">来分库，确保了一个用户的帖子数据落在同一个库上，那</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">通过</span>tid<span style="font-size: 14px; font-family: 宋体;">来查询，就不知道这个帖子落在哪个库上</span></span><span style="font-size: 14px; font-family: 宋体;">了，岂不是还需要遍历全库，需要怎么优化呢？</span></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span><strong>tid<span style="font-size: 14px; font-family: 宋体;">的查询是单行记录查询</span></strong><span style="font-size: 14px; font-family: 宋体;">，只要</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">在数据库（或者缓存）记录</span>tid<span style="font-size: 14px; font-family: 宋体;">到</span>uid<span style="font-size: 14px; font-family: 宋体;">的映射关系</span></span><span style="font-size: 14px; font-family: 宋体;">，就能解决这个问题。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">新增一个索引库：</span></p><p><span style="font-size: 12px;">t_mapping(tid, uid);</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这个库只有两列，可以承载很多数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">即使数据量过大，索引库可以利用</span>tid<span style="font-size: 14px; font-family: 宋体;">水平切分</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这类</span>kv<span style="font-size: 14px; font-family: 宋体;">形式的索引结构，可以很好的利用</span>cache<span style="font-size: 14px; font-family: 宋体;">优化查询性能</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">一旦帖子发布，</span>tid<span style="font-size: 14px; font-family: 宋体;">和</span>uid<span style="font-size: 14px; font-family: 宋体;">的映射关系就不会发生变化，</span>cache<span style="font-size: 14px; font-family: 宋体;">的命中率会非常高</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">使用</span>uid<span style="font-size: 14px; font-family: 宋体;">分库，并增加索引库记录</span>tid<span style="font-size: 14px; font-family: 宋体;">到</span>uid<span style="font-size: 14px; font-family: 宋体;">的映射关系之后，每当有</span>uid<span style="font-size: 14px; font-family: 宋体;">上的查询：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXZK3lgJic1pRhk9qgLs7qHXHuKTX1aE315cCFxuEA2gW54BXAubF18Vg/0?wx_fmt=png" style="width: 507px !important; height: 168px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">可以通过</span>uid<span style="font-size: 14px; font-family: 宋体;">直接定位到库。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">每当有</span>tid<span style="font-size: 14px; font-family: 宋体;">上的查询：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaX5j3OZicWvDUDwDd4dnAmYQU5eFlxApguiaHmaYAFRtIeEiaT7fDApjqXg/0?wx_fmt=png" style="width: 561px !important; height: 176px !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">先查询索引表，通过</span>tid<span style="font-size: 14px; font-family: 宋体;">查询到对应的</span>uid</span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">再通过</span>uid<span style="font-size: 14px; font-family: 宋体;">定位到库</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">这个方法的<strong>优点</strong>：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">一个用户发布的所以帖子落在同一个库上</span></span></p></li><li><p><span style="font-size: 14px;">10%<span style="font-size: 14px; font-family: 宋体;">的请求过过</span>uid<span style="font-size: 14px; font-family: 宋体;">来查询列表，可以直接定位到库</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">索引表</span>cache<span style="font-size: 14px; font-family: 宋体;">命中率非常高，因为</span>tid<span style="font-size: 14px; font-family: 宋体;">与</span>uid<span style="font-size: 14px; font-family: 宋体;">的映射关系不会变</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">缺点</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">90%<span style="font-size: 14px; font-family: 宋体;">的</span>tid<span style="font-size: 14px; font-family: 宋体;">请求，以及</span>100%<span style="font-size: 14px; font-family: 宋体;">的修改请求，不能直接定位到库，需要先进行一次索引表的查询，当然这个查询非常块，通常在</span>5ms<span style="font-size: 14px; font-family: 宋体;">内可以返回</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">数据插入时需要操作元数据与索引表，可能引发潜在的一致性问题</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="font-family: 宋体;">六、帖子中心水平切分</span>-</strong><strong><span style="font-family: 宋体;">基因法</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">有没有一种方法，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">既能够通过</span>uid<span style="font-size: 14px; font-family: 宋体;">定位到库，又不需要建立索引表来进行二次查询</span></span><span style="font-size: 14px; font-family: 宋体;">呢，这就是本文要叙述的“</span>1<span style="font-size: 14px; font-family: 宋体;">对多”业务分库<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">最佳实践</span>，<strong>基因法</strong>。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">什么是分库基因？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span>uid<span style="font-size: 14px; font-family: 宋体;">分库，假设分为</span>16<span style="font-size: 14px; font-family: 宋体;">个库，采用</span><span style="font-size: 14px; color: rgb(255, 76, 0);">uid%16</span><span style="font-size: 14px; font-family: 宋体;">的方式来进行数据库路由，这里的</span>uid%16<span style="font-size: 14px; font-family: 宋体;">，其本质是</span><strong>uid<span style="font-size: 14px; font-family: 宋体;">的最后</span>4<span style="font-size: 14px; font-family: 宋体;">个</span>bit</strong><span style="font-size: 14px; font-family: 宋体;">决定这行数据落在哪个库上，</span><strong><span style="font-size: 14px; font-family: 宋体;">这</span>4<span style="font-size: 14px; font-family: 宋体;">个</span>bit<span style="font-size: 14px; font-family: 宋体;">，就是分库基因</span></strong><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">什么是基因法分库？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">在“</span>1<span style="font-size: 14px; font-family: 宋体;">对多”的业务场景，使用“</span>1<span style="font-size: 14px; font-family: 宋体;">”分库，在“多”的数据</span>id<span style="font-size: 14px; font-family: 宋体;">生成时，</span>id<span style="font-size: 14px; font-family: 宋体;">末端加入分库基因，就能同时满足“</span>1<span style="font-size: 14px; font-family: 宋体;">”和“多”的分库查询需求。</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzajH6V9v1iaKUia3p9an5fiaXxZicgV0Ls3uBpno1sml4Gl3d53offWhnufuqzYEKrpJ0JeOtKicsocmQ/0?wx_fmt=png" style="width: 581px !important; height: 250px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图所示，</span>uid=666<span style="font-size: 14px; font-family: 宋体;">的用户发布了一条帖子（666的二进制表示为：101001<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">1010</span>）：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">使用</span>uid%16<span style="font-size: 14px; font-family: 宋体;">分库，决定这行数据要插入到哪个库中</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">分库基因是</span>uid<span style="font-size: 14px; font-family: 宋体;">的最后</span>4<span style="font-size: 14px; font-family: 宋体;">个</span>bit<span style="font-size: 14px; font-family: 宋体;">，即</span>1010</span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">在生成</span>tid<span style="font-size: 14px; font-family: 宋体;">时，先使用一种分布式</span>ID<span style="font-size: 14px; font-family: 宋体;">生成算法生成前</span>60bit<span style="font-size: 14px; font-family: 宋体;">（上图中绿色部分）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">将分库基因加入到</span>tid<span style="font-size: 14px; font-family: 宋体;">的最后</span>4<span style="font-size: 14px; font-family: 宋体;">个</span>bit<span style="font-size: 14px; font-family: 宋体;">（上图中粉色部分）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">拼装成最终的</span>64bit<span style="font-size: 14px; font-family: 宋体;">帖子</span>tid<span style="font-size: 14px; font-family: 宋体;">（上图中蓝色部分）</span></span></p></li></ul><p><span style="font-family:宋体"><span style="font-size: 14px; line-height: 22.4px;">（怎么生成60bit分布式唯一ID，请参见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960245&amp;idx=1&amp;sn=5cef3d8ca6a3e6e94f61e0edaf985d11&amp;chksm=bd2d06698a5a8f7fc89056af619b9b7e79b158bceb91bdeb776475bc686721e36fb925904a67&amp;scene=21#wechat_redirect" target="_blank">分布式ID生成算法</a>》）</span></span></p><p><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;"><br></span></p><p><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">这般，保证了同一个用户发布的所有帖子的</span><span style="font-size: 14px; line-height: 1.6;">tid</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">，都落在同一个库上，</span><span style="font-size: 14px; line-height: 1.6;">tid</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">的最后</span><span style="font-size: 14px; line-height: 1.6;">4</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">个</span><span style="font-size: 14px; line-height: 1.6;">bit</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">都相同，于是：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span>uid%16<span style="font-size: 14px; font-family: 宋体;">能够定位到库</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span>tid%16<span style="font-size: 14px; font-family: 宋体;">也能定位到库</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">潜在问题一：同一个</span>uid<span style="font-size: 14px; font-family: 宋体;">发布的</span>tid<span style="font-size: 14px; font-family: 宋体;">落在同一个库上，会不会出现数据不均衡？</span></span></strong></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：只要</span>uid<span style="font-size: 14px; font-family: 宋体;">是均衡的，每个用户发布的平均帖子数是均衡的，每个库的数据就是均衡的。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">潜在问题二：最开始分</span>16<span style="font-size: 14px; font-family: 宋体;">库，分库基因是</span>4bit<span style="font-size: 14px; font-family: 宋体;">，未来要扩充成</span>32<span style="font-size: 14px; font-family: 宋体;">库，分库基因变成了</span>5bit<span style="font-size: 14px; font-family: 宋体;">，那怎么办？</span></span></strong></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：需要提前做好容量预估，例如事先规划好</span>5<span style="font-size: 14px; font-family: 宋体;">年内数据增长</span>256<span style="font-size: 14px; font-family: 宋体;">库足够，就提前预留</span>8bit<span style="font-size: 14px; font-family: 宋体;">基因。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">七、总结</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">将以“帖子中心”为典型的“</span>1<span style="font-size: 14px; font-family: 宋体;">对多”类业务，在架构上，采用<strong>元数据与索引数据分离</strong>的架构设计方法：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">帖子服务，元数据满足</span>uid<span style="font-size: 14px; font-family: 宋体;">和</span>tid<span style="font-size: 14px; font-family: 宋体;">的查询需求</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">搜索服务，索引数据满足复杂搜索寻求</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">对于<strong>元数据</strong>的存储，在数据量较大的情况下，有三种常见的切分方法：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;">tid<span style="font-size: 14px; font-family: 宋体;">切分法</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，按照</span>tid<span style="font-size: 14px; font-family: 宋体;">分库，同一个用户发布的帖子落在不同的库上，通过</span>uid<span style="font-size: 14px; font-family: 宋体;">来查询要遍历所有库</span></span></p></li><li><p><strong><span style="font-size: 14px;">uid<span style="font-size: 14px; font-family: 宋体;">切分法</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，按照</span>uid<span style="font-size: 14px; font-family: 宋体;">分库，同一个用户发布的帖子落在同一个库上，需要通过索引表或者缓存来记录</span>tid<span style="font-size: 14px; font-family: 宋体;">与</span>uid<span style="font-size: 14px; font-family: 宋体;">的映射关系，通过</span>tid<span style="font-size: 14px; font-family: 宋体;">来查询时，先查到</span>uid<span style="font-size: 14px; font-family: 宋体;">，再通过</span>uid<span style="font-size: 14px; font-family: 宋体;">定位库</span></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">基因法</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，按照</span>uid<span style="font-size: 14px; font-family: 宋体;">分库，在生成</span>tid<span style="font-size: 14px; font-family: 宋体;">里加入</span>uid<span style="font-size: 14px; font-family: 宋体;">上的分库基因，保证通过</span>uid<span style="font-size: 14px; font-family: 宋体;">和</span>tid<span style="font-size: 14px; font-family: 宋体;">都能直接定位到库</span></span></p></li></ul><p><span style="font-size: 14px; font-family: 宋体;"><br></span></p><p><span style="font-size: 14px; font-family: 宋体;">对于1对多的业务场景，分库架构不再是瓶颈。</span></p><p><span style="font-size: 14px; font-family: 宋体;"><br></span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">相关推荐</span></strong></p><p><span style="font-size: 14px; font-family: 宋体;">关于“搜索架构”，请参考系列文章：</span></p><p><span style="font-size: 14px; font-family: 宋体;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959917&amp;idx=1&amp;sn=8faeae7419a756b0c355af2b30c255df&amp;chksm=bd2d07b18a5a8ea75f16f7e98ea897c7e7f47a0441c64bdaef8445a2100e0bdd2a7de99786c0&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959917&amp;idx=1&amp;sn=8faeae7419a756b0c355af2b30c255df&amp;chksm=bd2d07b18a5a8ea75f16f7e98ea897c7e7f47a0441c64bdaef8445a2100e0bdd2a7de99786c0&amp;scene=21#wechat_redirect" style="line-height: 25.6px; white-space: normal; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">如何迅猛的实现搜索需求</a><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;">》</span></span></p><p><span style="font-size: 14px; font-family: 宋体;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959895&amp;idx=1&amp;sn=de25ce2544c088ff9be0b93fd3ea4d15&amp;chksm=bd2d078b8a5a8e9d5ae4339a683d3f980ff2994f3c10c4081c7bab7f0d77f37521de95e974bf&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959895&amp;idx=1&amp;sn=de25ce2544c088ff9be0b93fd3ea4d15&amp;chksm=bd2d078b8a5a8e9d5ae4339a683d3f980ff2994f3c10c4081c7bab7f0d77f37521de95e974bf&amp;scene=21#wechat_redirect" style="line-height: 25.6px; white-space: normal; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">深入浅出搜索引擎架构、方案与细节</a><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;">》</span></span></span></p><p><span style="font-size: 14px; font-family: 宋体;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959949&amp;idx=1&amp;sn=83f78cf6293714bd1fd97a11ff7c2c35&amp;chksm=bd2d07518a5a8e47e6fce9fc03cddec1d8a43f2b4ac67cfbbf73a55143593da8a132da7a0815&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959949&amp;idx=1&amp;sn=83f78cf6293714bd1fd97a11ff7c2c35&amp;chksm=bd2d07518a5a8e47e6fce9fc03cddec1d8a43f2b4ac67cfbbf73a55143593da8a132da7a0815&amp;scene=21#wechat_redirect" style="line-height: 25.6px; white-space: normal; max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">58同城如何检索到1秒前发布的帖子</a><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;">》</span></span></span></span></p><p><span style="font-size: 14px; font-family: 宋体;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;"><span style="color: rgb(62, 62, 62); line-height: 25.6px;  font-size: 14px;"><span style="font-size: 14px;">《</span><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959855&amp;idx=1&amp;sn=f33abe8ec598c273f29cebb9365ece59&amp;chksm=bd2d07f38a5a8ee58a944507a134e1da1efc3ac9c4d1c4cff261137cd986e51f5fe7cee9de15&amp;scene=21#wechat_redirect" target="_blank" style="white-space: normal; font-size: 14px;">100亿数据1万属性数据架构设计</a><span style="font-size: 14px;">》</span></span></span></span></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499656649&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvW1gSMMfgEt5EdAbfzM6PjFHlOYWGtySuV7QzFwUsJRtBEcZZtFpUZwXGF1fH9emhUVhBPpKGNZz6aOFoOmujaQmnxDdKrfpl7W7k2oWtFSdRlafSRn1tdnGhHbxi9HoqU3WgOkUfCxg7DLRheJ0Z46A=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960212&amp;idx=1&amp;sn=ab4c52ab0309f7380f7e0207fa357128&amp;chksm=bd2d06488a5a8f5e3b7c9de0cc5936818bd9a6ed4058679ae8d819175e0693c6fbd9cdea0c87#rd">阅读原文</a>
{% endraw  %}

