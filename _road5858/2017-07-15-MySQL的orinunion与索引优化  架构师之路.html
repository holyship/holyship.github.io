---
title: MySQL的or/in/union与索引优化 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1500385227&src=3&ver=1&signature=FkzcjJJ48va4gLuFLNnuhrve1mIqPwtdONnZQh9P9FfrZqZXZ5nKykmm5tcSTHkaO*EnYIpe*W3G8PNs-oTbZko64Yn4uNCDJHCWv*cTtPJCBZxzQ8-vTMIy2sHZl014NRN7aLxtcg8N5JyBaPC89F7brcl9pkg1QUf2cWPMwhk=
date: '2017-07-15 00:00:00 +0000'

---

{% raw  %}
<p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">本文缘起自《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960258&amp;idx=1&amp;sn=caf8295fa5c0ee47d6b9e6bf5cffcb49&amp;chksm=bd2d061e8a5a8f08374ddc84a3c59355368b840ab38ba97782947e02c0d9d6d3c289032b3d39&amp;scene=21#wechat_redirect" target="_blank">一分钟了解索引技巧</a>》的作业题。</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;"><br></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">假设订单业务表结构为：</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">order(oid, date, uid, status, money, time, …)</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">其中：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="font-size: 14px;"><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">oid</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，订单</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">ID</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，<strong>主键</strong></span></span></p></li><li><p style="margin: 0px;"><span style="font-size: 14px;"><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">date</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，下单日期，有<strong>普通索引</strong>，管理后台经常按照<span style="font-size: 14px;"><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">date</span></span></span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">查询</span></span></p></li><li><p style="margin: 0px;"><span style="font-size: 14px;"><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">uid</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，用户</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">ID</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，有<strong>普通索引</strong>，用户查询自己订单</span></span></p></li><li><p style="margin: 0px;"><span style="font-size: 14px;"><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">status</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，订单状态，有<strong>普通索引</strong>，管理后台经常按照</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">status</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">查询</span></span></p></li><li><p style="margin: 0px;"><span style="font-size: 14px;"><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">money/time</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，订单金额</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">/时间</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，被查询字段，无索引</span></span></p></li><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">…</span></p></li></ul><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">假设订单有三种状态：</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">0</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">已下单，</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">1</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">已支付，</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">2</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">已完成</span></span></p><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">业务需求，查询未完成的订单，哪个</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">SQL</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">更快呢？</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status!=2</span></p></li><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status=0 or
status=1</span></p></li><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status IN (0,1)</span></p></li><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status=0 </span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">union all</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status=1</span></p></li></ul><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;"><br></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">结论：<strong>方案1最慢，方案2，3，4都能命中索引</strong></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;"><br></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">但是...&nbsp;</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;"><br></span></p><p style="margin: 0px;"><span style="font-size: 16px;"><strong><span style="margin: 0px; font-family: 宋体;">一：</span><span lang="EN-US" style="margin: 0px; font-family: Calibri;">union all </span><span style="margin: 0px; font-family: 宋体;">肯定是能够命中索引的</span></strong></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status=0 </span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">union all</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status=1</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">说明：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">直接告诉</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">MySQL</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">怎么做，</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">MySQL</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">耗费的</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">CPU</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">最少</span></span></p></li><li><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">程序员并不经常这么写</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">SQL(union all)</span></span></p></li></ul><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p style="margin: 0px;"><span style="font-size: 16px;"><strong><span style="margin: 0px; font-family: 宋体;">二：简单的</span><span lang="EN-US" style="margin: 0px; font-family: Calibri;">in</span><span style="margin: 0px; font-family: 宋体;">能够命中索引</span></strong></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status in (0,1)</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">说明：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">让</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">MySQL</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">思考，查询优化</span><span style="font-family:宋体">耗费的</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">cpu</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">比</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">union all</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">多，但可以忽略不计</span></span></p></li><li><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">程序员最常这么写</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">SQL(in)，<span style="margin: 0px; color: rgb(255, 76, 0); font-family: Calibri; font-size: 14px;">这个例子，最建议这么写</span></span></span></p></li></ul><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p style="margin: 0px;"><span style="font-size: 16px;"><strong><span style="margin: 0px; font-family: 宋体;">三：对于</span><span lang="EN-US" style="margin: 0px; font-family: Calibri;">or</span><span style="margin: 0px; font-family: 宋体;">，新版的</span><span lang="EN-US" style="margin: 0px; font-family: Calibri;">MySQL</span><span style="margin: 0px; font-family: 宋体;">能够命中索引</span></strong></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status=0 or
status=1</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">说明：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">让</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">MySQL</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">思考，查询优化<span style="font-family:宋体">耗费的</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">cpu</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">比</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">in</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">多</span>，别把负担交给</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">MySQL</span></span></p></li><li><p style="margin: 0px;"><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">不建议</span>程序员频繁用</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">or</span></span><span style="font-size: 14px;"><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;"></span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，不是所有的</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">or</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">都命中索引</span></span></p></li><li><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">对于老版本的MySQL，建议查询分析下</span></span></p></li></ul><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p style="margin: 0px;"><span style="font-size: 16px;"><strong><span style="margin: 0px; font-family: 宋体;">四、对于</span><span lang="EN-US" style="margin: 0px; font-family: Calibri;">!=</span><span style="margin: 0px; font-family: 宋体;">，负向查询肯定不能命中索引</span></strong></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status!=2</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">说明：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="color: rgb(0, 0, 0);"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">全表扫描，效率最低</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">，</span></span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">所有方案中最慢</span></p></li><li><p style="margin: 0px;"><span style="margin: 0px; color: rgb(255, 76, 0); font-family: 宋体; font-size: 14px;">禁止使用负向查询</span></p></li></ul><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p style="margin: 0px;"><span style="font-size: 16px;"><strong><span style="margin: 0px; font-family: 宋体;">五、其他方案</span></strong></span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 12px;">select * from order where status &lt; 2</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">这个具体的例子中，确实快，但是：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">这个例子只举了</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">3</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">个状态，实际业务不止这</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">3</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">个状态，并且状态的“值”正好满足偏序关系，万一是查其他状态呢，SQL不宜依赖于枚举的值，<span style="margin: 0px; color: rgb(255, 76, 0); font-family: 宋体; font-size: 14px;">方案不通用</span></span></span></p></li><li><p style="margin: 0px;"><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">这个</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">SQL</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">可读性差，可理解性差，可维护性差，强烈不推荐</span></span></p></li></ul><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p style="margin: 0px;"><span style="font-size: 16px;"><strong><span style="margin: 0px; font-family: 宋体;">六、作业</span></strong></span></p><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">这样的</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">查询<span style="margin: 0px; color: rgb(255, 76, 0); font-family: 宋体; font-size: 14px;">能够命中索引么</span>？</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">select * from order where uid in (</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select
uid from order where status=0</span></p><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">)</span></p></li><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">select * from order where status in (0, 1)
order by date desc</span></p></li><li><p style="margin: 0px;"><span style="margin: 0px; font-family: Calibri; font-size: 14px;">select * from order where status=0 or date
&lt;= CURDATE()</span></p></li></ul><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;"><br></span></span></p><p style="margin: 0px;"><span style="font-size: 14px;"><span style="margin: 0px; font-family: 宋体; font-size: 14px;">注：此为示例，别较真</span><span lang="EN-US" style="margin: 0px; font-family: Calibri; font-size: 14px;">SQL</span><span style="margin: 0px; font-family: 宋体; font-size: 14px;">对应业务的合理性。</span></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1500385227&src=3&ver=1&signature=FkzcjJJ48va4gLuFLNnuhrve1mIqPwtdONnZQh9P9FfrZqZXZ5nKykmm5tcSTHkaO*EnYIpe*W3G8PNs-oTbZko64Yn4uNCDJHCWv*cTtPJCBZxzQ8-vTMIy2sHZl014NRN7aLxtcg8N5JyBaPC89F7brcl9pkg1QUf2cWPMwhk=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960258&amp;idx=1&amp;sn=caf8295fa5c0ee47d6b9e6bf5cffcb49&amp;chksm=bd2d061e8a5a8f08374ddc84a3c59355368b840ab38ba97782947e02c0d9d6d3c289032b3d39#rd">阅读原文</a>
{% endraw  %}

