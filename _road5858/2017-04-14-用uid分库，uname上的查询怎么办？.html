---
title: 用uid分库，uname上的查询怎么办？
author: 58沈剑
date: '2017-04-14 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;">1<span style="font-family: 宋体;">分钟系列</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">【缘起】</span></strong></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">用户中心</span></strong><span style="font-family: 宋体; font-size: 14px;">是几乎每一个公司必备的基础服务，用户注册、登录、信息查询与修改都离不开用户中心。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">当数据量越来越大时，需要多用户中心进行水平切分。最常见的<strong>水平切分方式</strong>，</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">按照</span>uid<span style="font-size: 14px; font-family: 宋体;">取模分库</span></span><span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><img src="/road5858/images/aa31606fbef982feef4100331989928fd629609b.png" style="width: 306px !important; height: 126px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span><span style="font-size: 14px; color: rgb(255, 104, 39);">uid<span style="font-size: 14px; font-family: 宋体;">取模</span></span><span style="font-size: 14px; font-family: 宋体;">，将数据分布到多个数据库实例上去，<strong>提高服务实例个数，降低单库数据量</strong>，以达到扩容的目的。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">水平切分之后：</span></p><p><img src="/road5858/images/14437582903a5875591b45ee8f9387b86eb47638.png" style="width: 299px !important; height: 168px !important; visibility: visible !important;"></p><p><span style="font-size: 14px; color: rgb(255, 104, 39);">uid<span style="font-size: 14px; font-family: 宋体;">属性上的查询可以直接路由到库</span></span><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，如上图，假设访问</span>uid=124<span style="font-size: 14px; font-family: 宋体;">的数据，取模后能够直接定位</span>db-user1<span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">对于</span>uname<span style="font-size: 14px; font-family: 宋体;">上的查询，就不能这么幸运了：</span></span></p><p><img src="/road5858/images/6f66cbe356879b08232956ce4826316e81404f3e.png" style="width: 307px !important; height: 174px !important;"></p><p><span style="font-size: 14px;">uname<span style="font-size: 14px; font-family: 宋体;">上的查询，如上图，假设访问</span>uname=shenjian<span style="font-size: 14px; font-family: 宋体;">的数据，由于不知道数据落在哪个库上，往往需要遍历所有库</span><strong><span style="font-size: 16px; font-family: 宋体;">【扫全库法】</span></strong><span style="font-size: 14px; font-family: 宋体;">，当分库数量多起来，性能会显著降低。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">用</span>uid<span style="font-size: 14px; font-family: 宋体;">分库，如何高效实现上的查询，是本文将要讨论的问题。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">【索引表法】</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">思路</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span>uid<span style="font-size: 14px; font-family: 宋体;">能直接定位到库，</span>uname<span style="font-size: 14px; font-family: 宋体;">不能直接定位到库，如果通过</span>uname<span style="font-size: 14px; font-family: 宋体;">能查询到</span>uid<span style="font-size: 14px; font-family: 宋体;">，问题解决</span></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">解决方案</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">）</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">建立一个索引表记录</span>uname-&gt;uid<span style="font-size: 14px; font-family: 宋体;">的映射关系</span></span></span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">）用</span>uname<span style="font-size: 14px; font-family: 宋体;">来访问时，先通过索引表查询到</span>uid<span style="font-size: 14px; font-family: 宋体;">，再定位相应的库</span></span></p><p><span style="font-size: 14px;">3<span style="font-size: 14px; font-family: 宋体;">）索引表属性较少，可以容纳非常多数据，一般不需要分库</span></span></p><p><span style="font-size: 14px;">4<span style="font-size: 14px; font-family: 宋体;">）如果数据量过大，可以通过</span>uname<span style="font-size: 14px; font-family: 宋体;">来分库</span></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">潜在不足</span></strong><span style="font-family: 宋体; font-size: 14px;">：多一次数据库查询，性能下降一倍</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">【缓存映射法】</span></strong></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">思路</span></strong><span style="font-family: 宋体; font-size: 14px;">：访问索引表性能较低，把映射关系放在缓存里性能更佳</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">解决方案</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">）</span><span style="font-size: 14px; color: rgb(255, 104, 39);">uname<span style="font-size: 14px; font-family: 宋体;">查询先到</span>cache<span style="font-size: 14px; font-family: 宋体;">中查询</span>uid<span style="font-size: 14px; font-family: 宋体;">，再根据</span>uid<span style="font-size: 14px; font-family: 宋体;">定位数据库</span></span></span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">）假设</span>cache miss<span style="font-size: 14px; font-family: 宋体;">，采用扫全库法获取</span>uname<span style="font-size: 14px; font-family: 宋体;">对应的</span>uid<span style="font-size: 14px; font-family: 宋体;">，放入</span>cache</span></p><p><span style="font-size: 14px;">3<span style="font-size: 14px; font-family: 宋体;">）</span>uname<span style="font-size: 14px; font-family: 宋体;">到</span>uid<span style="font-size: 14px; font-family: 宋体;">的映射关系不会变化，映射关系一旦放入缓存，不会更改，无需淘汰，缓存命中率超高</span></span></p><p><span style="font-size: 14px;">4<span style="font-size: 14px; font-family: 宋体;">）如果数据量过大，可以通过</span>name<span style="font-size: 14px; font-family: 宋体;">进行</span>cache<span style="font-size: 14px; font-family: 宋体;">水平切分</span></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">潜在不足</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：多一次</span>cache<span style="font-size: 14px; font-family: 宋体;">查询</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">【</span></strong><strong><span style="font-size: 16px;">uname</span></strong><strong><span style="font-size: 16px; font-family: 宋体;">生成</span></strong><strong><span style="font-size: 16px;">uid</span></strong><strong><span style="font-size: 16px; font-family: 宋体;">】</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">思路</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：不进行远程查询，由</span>uname<span style="font-size: 14px; font-family: 宋体;">直接得到</span>uid</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">解决方案</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">）</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">在用户注册时，设计函数</span>uname<span style="font-size: 14px; font-family: 宋体;">生成</span>uid</span><span style="font-size: 14px; font-family: 宋体;">，</span>uid=f(uname)<span style="font-size: 14px; font-family: 宋体;">，按</span>uid<span style="font-size: 14px; font-family: 宋体;">分库插入数据</span></span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">）用</span>uname<span style="font-size: 14px; font-family: 宋体;">来访问时，先通过函数计算出</span>uid<span style="font-size: 14px; font-family: 宋体;">，即</span>uid=f(uname)<span style="font-size: 14px; font-family: 宋体;">再来一遍，由</span>uid<span style="font-size: 14px; font-family: 宋体;">路由到对应库</span></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">潜在不足</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：该函数设计需要非常讲究技巧，有</span>uid<span style="font-size: 14px; font-family: 宋体;">生成冲突风险</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">【</span></strong><strong><span style="font-size: 16px;">uname</span></strong><strong><span style="font-size: 16px; font-family: 宋体;">基因融入</span></strong><strong><span style="font-size: 16px;">uid</span></strong><strong><span style="font-size: 16px; font-family: 宋体;">】</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">思路</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：不能用</span>uname<span style="font-size: 14px; font-family: 宋体;">生成</span>uid<span style="font-size: 14px; font-family: 宋体;">，可以从</span>uname<span style="font-size: 14px; font-family: 宋体;">抽取“基因”，融入</span>uid<span style="font-size: 14px; font-family: 宋体;">中</span></span></p><p><img src="/road5858/images/4742c6fae0b48cfcb87a57d7a6576a7cd2f2ca3f.png" style="width: 538px !important; height: 163px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">假设分</span>8<span style="font-size: 14px; font-family: 宋体;">库，采用</span>uid%8<span style="font-size: 14px; font-family: 宋体;">路由，潜台词是，</span>uid<span style="font-size: 14px; font-family: 宋体;">的最后</span>3<span style="font-size: 14px; font-family: 宋体;">个</span>bit<span style="font-size: 14px; font-family: 宋体;">决定这条数据落在哪个库上，这</span>3<span style="font-size: 14px; font-family: 宋体;">个</span>bit<span style="font-size: 14px; font-family: 宋体;">就是所谓的“基因”。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">解决方案</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">）</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">在用户注册时，设计函数</span>uname<span style="font-size: 14px; font-family: 宋体;">生成</span>3bit<span style="font-size: 14px; font-family: 宋体;">基因</span></span><span style="font-size: 14px; font-family: 宋体;">，</span>uname_gene=f(uname)<span style="font-size: 14px; font-family: 宋体;">，如上图粉色部分</span></span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">）同时，生成</span>61bit<span style="font-size: 14px; font-family: 宋体;">的全局唯一</span>id<span style="font-size: 14px; font-family: 宋体;">，作为用户的标识，如上图绿色部分</span></span></p><p><span style="font-size: 14px;">3<span style="font-size: 14px; font-family: 宋体;">）接着把</span>3bit<span style="font-size: 14px; font-family: 宋体;">的</span>uname_gene<span style="font-size: 14px; font-family: 宋体;">也作为</span>uid<span style="font-size: 14px; font-family: 宋体;">的一部分，如上图屎黄色部分</span></span></p><p><span style="font-size: 14px;">4<span style="font-size: 14px; font-family: 宋体;">）生成</span>64bit<span style="font-size: 14px; font-family: 宋体;">的</span>uid<span style="font-size: 14px; font-family: 宋体;">，由</span>id<span style="font-size: 14px; font-family: 宋体;">和</span>uname_gene<span style="font-size: 14px; font-family: 宋体;">拼装而成，并按照</span>uid<span style="font-size: 14px; font-family: 宋体;">分库插入数据</span></span></p><p><span style="font-size: 14px;">5<span style="font-size: 14px; font-family: 宋体;">）用</span>uname<span style="font-size: 14px; font-family: 宋体;">来访问时，先通过函数由</span>uname<span style="font-size: 14px; font-family: 宋体;">再次复原</span>3bit<span style="font-size: 14px; font-family: 宋体;">基因，</span>uname_gene=f(uname)<span style="font-size: 14px; font-family: 宋体;">，通过</span>uname_gene%8<span style="font-size: 14px; font-family: 宋体;">直接定位到库</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 16px; font-family: 宋体;">【总结】</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">业务场景</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：用户中心，数据量大，通过</span>uid<span style="font-size: 14px; font-family: 宋体;">分库后，通过</span>uname<span style="font-size: 14px; font-family: 宋体;">路由不到库</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">解决方案</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">）<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">扫全库法</span>：遍历所有库</span></span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">）<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">索引表法</span>：数据库中记录</span>uname-&gt;uid<span style="font-size: 14px; font-family: 宋体;">的映射关系</span></span></p><p><span style="font-size: 14px;">3<span style="font-size: 14px; font-family: 宋体;">）<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">缓存映射法</span>：缓存中记录</span>uname-&gt;uid<span style="font-size: 14px; font-family: 宋体;">的映射关系</span></span></p><p><span style="font-size: 14px;">4<span style="font-size: 14px; font-family: 宋体;">）</span><span style="font-size: 14px; color: rgb(255, 104, 39);">uname<span style="font-size: 14px; font-family: 宋体;">生成</span>uid</span></span></p><p><span style="font-size: 14px;">5<span style="font-size: 14px; font-family: 宋体;">）</span>uname<span style="font-size: 14px; font-family: 宋体;">基因融入</span>uid</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">==【完】==</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">推荐阅读：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959773&amp;idx=1&amp;sn=7e4ad0dcd050f6662dfaf39d9de36f2c&amp;chksm=bd2d04018a5a8d17b92098b4840aac23982e32d179cdd957e4c55011f6a08f6bd31f9ba5cfee&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959773&amp;idx=1&amp;sn=7e4ad0dcd050f6662dfaf39d9de36f2c&amp;chksm=bd2d04018a5a8d17b92098b4840aac23982e32d179cdd957e4c55011f6a08f6bd31f9ba5cfee&amp;scene=21#wechat_redirect">一分钟掌握数据库垂直拆分</a><br></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959883&amp;idx=1&amp;sn=e7df8510c7096a5b069e0f12eaaca010&amp;chksm=bd2d07978a5a8e815c2ae41b16b6b4c579923502fb919008a22bb108a1e920109f25387f8903&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959883&amp;idx=1&amp;sn=e7df8510c7096a5b069e0f12eaaca010&amp;chksm=bd2d07978a5a8e815c2ae41b16b6b4c579923502fb919008a22bb108a1e920109f25387f8903&amp;scene=21#wechat_redirect">数据库秒级平滑扩容架构方案</a><br></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959906&amp;idx=1&amp;sn=2cbdc66cfb5b53cf4327a1e0d18d9b4a&amp;chksm=bd2d07be8a5a8ea86dc3c04eced3f411ee5ec207f73d317245e1fefea1628feb037ad71531bc&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959906&amp;idx=1&amp;sn=2cbdc66cfb5b53cf4327a1e0d18d9b4a&amp;chksm=bd2d07be8a5a8ea86dc3c04eced3f411ee5ec207f73d317245e1fefea1628feb037ad71531bc&amp;scene=21#wechat_redirect">58到家数据库30条军规解读</a><br></span></span></p>
{% endraw  %}

