---
title: session一致性架构设计实践
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1495452139&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeW-T5kTNB0lmNIDfirdmdp3IhNxo89xisNdP56ZXTe4KJtg9Glou1t4ppqeRe4PZrWKzUexcZsKRfP3EKrEBzFKhkdm*ISIqkuZsC6iS65qPZt2JiA8Dt01vZ8hpMWAGnRhjSGcpJNEuj4iZVHTGQBE=
date: '2017-05-18 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;"></span></strong></span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">一、缘起</span></strong></span><br></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">什么是</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">？</span></span></strong></p><p><span style="font-family: 宋体; font-size: 14px;">服务器为每个用户创建一个会话，存储用户的相关信息，以便多次请求能够定位到同一个上下文。</span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">Web</span><span style="font-family: 宋体; font-size: 14px;">开发中，</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">可以自动为同一个浏览器的访问用户自动创建</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">，提供数据存储功能。最常见的，会把用户的登录信息、用户信息存储在</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">中，以保持登录状态。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">什么是</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">一致性问题？</span></span></strong></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">只要用户不重启浏览器，每次</span><span style="font-family: Calibri; font-size: 14px;">http</span><span style="font-family: 宋体; font-size: 14px;">短连接请求，理论上服务端都能定位到</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">，保持会话。</span></span></p><p><img src="/road5858/images/0a90a10322e4b04994fb27e5258829ac63f26e5c.png" style="width: 612px !important; height: 407px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">当只有一台</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">提供服务时，每次</span><span style="font-family: Calibri; font-size: 14px;">http</span><span style="font-family: 宋体; font-size: 14px;">短连接请求，都能够正确路由到存储</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">的对应</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">（废话，因为只有一台</span><span style="font-family: 宋体; font-size: 14px;">）。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">此时的</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">是无法保证高可用的，采用“冗余</span><span style="font-family: Calibri; font-size: 14px;">+</span><span style="font-family: 宋体; font-size: 14px;">故障转移”的</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">多台<span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;"></span>来保证高可用时，每次</span><span style="font-family: Calibri; font-size: 14px;">http</span><span style="font-family: 宋体; font-size: 14px;">短连接请求就不一定能路由到正确的</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">了</span></span><span style="font-family: 宋体; font-size: 14px;">。</span></span></p><p><img src="/road5858/images/a451120b951e929988b7a3208715cb61911b9ebf.png" style="width: 573px !important; height: 417px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如上图，假设用户包含登录信息的</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">都记录在第一台</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">上，反向代理如果将请求路由到另一台</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">上，可能就找不到相关信息，而导致用户需要重新登录。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">在</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">高可用时，如何保证</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">路由的一致性，是今天将要讨论的问题。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">二、</span><span style="font-family: Calibri;">session</span><span style="font-family: 宋体;">同步法</span></strong></span></p><p><img src="/road5858/images/023e74bf392a354ceca206b34c22a4b600872b92.png" style="width: 611px !important; height: 422px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><strong>思路</strong>：</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">多个</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">之间相互同步</span><span style="font-family: Calibri; font-size: 14px;">session</span></span><span style="font-family: 宋体; font-size: 14px;">，这样每个</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">之间都包含全部的</span><span style="font-family: Calibri; font-size: 14px;">session</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">优点</span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">：</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">支持的功能，<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">应用程序不需要修改代码</span></span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">不足</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">的同步需要数据传输，<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">占<strong>内网带宽</strong></span>，有时延</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">所有</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">都包含所有</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">数据，数据量<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">受内存限制，无法水平扩展</span></span></span></p></li><li><p><span style="font-size: 14px;"><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">有更多</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">时要歇菜</span></span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">三、客户端存储法</span></strong></span></p><p><img src="/road5858/images/d5dca0a75683e1cd51ffce2ac3b60ac331084936.png" style="width: 568px !important; height: 418px !important;"></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">思路</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">：服务端存储所有用户的</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">，内存占用较大，可以</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">将<span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;"></span>存储到浏览器</span><span style="font-family: Calibri; font-size: 14px;">cookie</span><span style="font-family: 宋体; font-size: 14px;">中</span></span><span style="font-family: 宋体; font-size: 14px;">，每个端只要存储一个用户的数据了</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">优点</span></strong><span style="font-family: 宋体; font-size: 14px;">：<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">服务端不需要存储</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">缺点</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">每次</span><span style="font-family: Calibri; font-size: 14px;">http</span><span style="font-family: 宋体; font-size: 14px;">请求都携带</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">，<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">占<strong>外网带宽</strong></span></span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">数据存储在端上，并在网络传输，存在泄漏、篡改、窃取等<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">安全隐患</span></span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">session</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">存储的数据大小受</span><span style="font-family: Calibri; font-size: 14px;">cookie</span><span style="font-family: 宋体; font-size: 14px;">限制</span></span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">“端存储”的方案虽然不常用，但确实是一种思路。</span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">三、反向代理</span><span style="font-family: Calibri;">hash</span><span style="font-family: 宋体;">一致性</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">思路</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">：</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">为了保证高可用，有多台冗余，反向代理层能不能做一些事情，让</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">同一个用户的请求保证落在一台</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">上</span></span><span style="font-family: 宋体; font-size: 14px;">呢？</span></span></p><p><img src="/road5858/images/920ade4f76ef4ce1fcf24ea300e034ffeccf0394.png" style="width: 625px !important; height: 420px !important;"></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">方案一：四层代理</span><span style="font-family: Calibri; font-size: 14px;">hash</span></span></strong></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">反向代理层使用</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">用户</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">来做</span><span style="font-family: Calibri; font-size: 14px;">hash</span></span><span style="font-family: 宋体; font-size: 14px;">，以保证同一个</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">的请求落在同一个</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">上</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><img src="/road5858/images/60b0992f2869140b2239310a126f142bef53c9d6.png" style="width: 743px !important; height: 420px !important;"></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">方案二：七层代理</span><span style="font-family: Calibri; font-size: 14px;">hash</span></span></strong></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">反向代理使用</span><span style="font-family: Calibri; font-size: 14px;">http</span><span style="font-family: 宋体; font-size: 14px;">协议中的</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">某些业务属性来做</span><span style="font-family: Calibri; font-size: 14px;">hash</span></span><span style="font-family: 宋体; font-size: 14px;">，例如</span><span style="font-family: Calibri; font-size: 14px;">sid</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">city_id</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">user_id</span><span style="font-family: 宋体; font-size: 14px;">等，能够更加灵活的实施</span><span style="font-family: Calibri; font-size: 14px;">hash</span><span style="font-family: 宋体; font-size: 14px;">策略，以保证同一个浏览器用户的请求落在同一个</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">上</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">优点</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">只需要改</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">配置，<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">不需要修改应用代码</span></span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">负载均衡</span>，只要<span style="font-family: Calibri; font-size: 14px;">hash</span><span style="font-family: 宋体; font-size: 14px;"></span>属性</span><span style="font-family: 宋体; font-size: 14px;">是均匀的，多台</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">的负载是均衡的</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><span style="font-family:宋体">可以</span><span style="font-family: Calibri; font-size: 14px;"></span>支</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">持</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">水平扩展</span></span><span style="font-family: 宋体; font-size: 14px;">（</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">同步法是不行的，受内存限制）</span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">不足</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如果</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">重启，一部分</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">会丢失</span></span><span style="font-family: 宋体; font-size: 14px;">，产生业务影响，例如部分用户重新登录</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如果</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">水平扩展，</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">rehash</span><span style="font-family: 宋体; font-size: 14px;">后</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">重新分布，也会有一部分用户路由不到正确的</span><span style="font-family: Calibri; font-size: 14px;">session</span></span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">一般是有有效期的，所有不足中的两点，可以认为等同于部分</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">失效，一般问题不大。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">对于四层</span><span style="font-family: Calibri; font-size: 14px;">hash</span><span style="font-family: 宋体; font-size: 14px;">还是七层</span><span style="font-family: Calibri; font-size: 14px;">hash</span><span style="font-family: 宋体; font-size: 14px;">，个人推荐前者</span></span><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">：<strong>让专业的软件做专业的事情</strong>，反向代理就负责转发，尽量不要引入应用层业务属性，除非不得不这么做（例如，有时候多机房多活需要按照业务属性路由到不同机房的</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">）。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">四、后端统一存储</span></strong></span></p><p><img src="/road5858/images/1e6880c80ac4ffc78b3c54ba28dc19bbc32f6673.png" style="width: 770px !important; height: 363.269px !important;"></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">思路</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">：</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">将</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">存储在</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">后端的存储层</span></span><span style="font-family: 宋体; font-size: 14px;">，数据库或者缓存</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">优点</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">没有安全隐患</span></span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">可以水平扩展</span>，数据库</span><span style="font-family: Calibri; font-size: 14px;">/</span><span style="font-family: 宋体; font-size: 14px;">缓存水平切分即可</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">重启或者扩容都</span><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">不会有</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">丢失</span></span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">不足</span></strong><span style="font-family: 宋体; font-size: 14px;">：增加了一次网络调用，并且<span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">需要修改应用代码</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">对于</span><span style="font-family: Calibri; font-size: 14px;">db</span><span style="font-family: 宋体; font-size: 14px;">存储还是</span><span style="font-family: Calibri; font-size: 14px;">cache</span><span style="font-family: 宋体; font-size: 14px;">，个人推荐后者</span></span><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">：</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">读取的频率会很高，数据库压力会比较大。如果有</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">高可用需求，</span><span style="font-family: Calibri; font-size: 14px;">cache</span><span style="font-family: 宋体; font-size: 14px;">可以做高可用，但大部分情况下</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">可以丢失，一般也不需要考虑高可用。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">五、总结</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">保证</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">一致性</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">的架构设计常见方法：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">同步法</span></span><span style="font-family: 宋体; font-size: 14px;">：多台</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">相互同步数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">客户端存储法</span>：一个用户只存储自己的数据</span></span></p></li><li><p><span style="font-size: 14px;"><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">反向代理</span><span style="font-family: Calibri; font-size: 14px;">hash</span><span style="font-family: 宋体; font-size: 14px;">一致性</span></span><span style="font-family: 宋体; font-size: 14px;">：四层</span><span style="font-family: Calibri; font-size: 14px;">hash</span><span style="font-family: 宋体; font-size: 14px;">和七层</span><span style="font-family: Calibri; font-size: 14px;">hash</span><span style="font-family: 宋体; font-size: 14px;">都可以做，保证一个用户的请求落在一台</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">上</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><span style="color: rgb(255, 76, 65); font-family: 宋体; font-size: 14px;">后端统一存储</span>：</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">重启和扩容，</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">也不会丢失</span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="color: rgb(255, 76, 65); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">对于方案</span><span style="font-family: Calibri; font-size: 14px;">3</span><span style="font-family: 宋体; font-size: 14px;">和方案</span><span style="font-family: Calibri; font-size: 14px;">4</span><span style="font-family: 宋体; font-size: 14px;">，个人建议推荐后者</span></span><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">web</span><span style="font-family: 宋体; font-size: 14px;">层、</span><span style="font-family: Calibri; font-size: 14px;">service</span><span style="font-family: 宋体; font-size: 14px;">层无状态是大规模分布式系统设计原则之一</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">属于状态，不宜放在</span><span style="font-family: Calibri; font-size: 14px;">web</span><span style="font-family: 宋体; font-size: 14px;">层</span></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">让专业的软件做专业的事情</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">存</span><span style="font-family: Calibri; font-size: 14px;">session</span><span style="font-family: 宋体; font-size: 14px;">？还是让</span><span style="font-family: Calibri; font-size: 14px;">cache</span><span style="font-family: 宋体; font-size: 14px;">去做这样的事情吧</span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">希望大伙有收获，思路比结果重要，帮转哟。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1495452139&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeW-T5kTNB0lmNIDfirdmdp3IhNxo89xisNdP56ZXTe4KJtg9Glou1t4ppqeRe4PZrWKzUexcZsKRfP3EKrEBzFKhkdm*ISIqkuZsC6iS65qPZt2JiA8Dt01vZ8hpMWAGnRhjSGcpJNEuj4iZVHTGQBE=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960118&amp;idx=1&amp;sn=767e038cb4378be1c88dd42569a9264f&amp;chksm=bd2d06ea8a5a8ffc7c69c71c2153b10565ecf72b6957c5667fbf9099c9f5478111132e967a35#rd">阅读原文</a>
{% endraw  %}

