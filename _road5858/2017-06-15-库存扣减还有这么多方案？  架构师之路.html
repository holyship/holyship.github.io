---
title: 库存扣减还有这么多方案？ | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1498052271&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ1KJasWOsq8hSo-mm4SVBUqXpDLOmbKmY46mI-tH6ASrpLYSYQojdSaCl4vWp*Xp7QhjTVxLv9g9coxL9xmzm2movMXm2X0OXI3--0fIRcym-eaggZi-HkBXm0i3TCW4qEz3A-PiB81MOhueDSj9iQA=
date: '2017-06-15 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-family: 宋体; font-size: 14px;">昨天一篇《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568&amp;scene=21#wechat_redirect" target="_blank" style="font-family: 宋体; font-size: 14px; line-height: 22.4px; white-space: normal;">库存扣多了，到底怎么整</a><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;"></span>》，核心观点是：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; font-family: 宋体;"><span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">用“设置库存”替代“扣减库存”</span>，以保证<strong>幂等性</strong></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">使</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">用</span>CAS<span style="font-size: 14px; font-family: 宋体;">乐观锁</span></span><span style="font-size: 14px; font-family: 宋体;">，在“设置库存”时加上原始库存的比对，<strong>避免数据不一致</strong></span></span></p></li></ul><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">文章非常多朋友留言发表观点，“架构师之路”能引发不少同学思考，甚是欣慰。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">原以为两个核心观点应该是没有疑义的，结果很多朋友说方案不好，今天交流下部分回复的方案，个人的一些看法。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">留言一</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">是否能使用</span></p><p><span style="font-size: 12px;">update stock set num=num-$count where sid=$sid <span style="font-size: 12px; color: rgb(255, 76, 0);">and stock&gt;=$count</span>;</span></p><p><span style="font-family: 宋体; font-size: 14px;">的方式扣减库存？</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">回答</span></strong><span style="font-family: 宋体; font-size: 14px;">：这个方案<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">无法保证幂等性</span>，有可能出现重复扣减。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">留言二</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">把库存放到</span>reids<span style="font-size: 14px; font-family: 宋体;">里，利用</span>redis<span style="font-size: 14px; font-family: 宋体;">的事务性来扣减库存。</span></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">分析</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><strong><span style="font-size: 14px;">redis<span style="font-size: 14px; font-family: 宋体;">是如何实现事务操作的？</span></span></strong></p><p><span style="font-family: 宋体; font-size: 14px;">本质也是乐观锁。</span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">在</span>redis<span style="font-size: 14px; font-family: 宋体;">客户端执行：</span></span></p><p><span style="font-size: 12px;">$num = GET key</span></p><p><span style="font-size: 12px;">$num = $num - $count</span></p><p><span style="font-size: 12px;">SET key $num</span></p><p><span style="font-family: 宋体; font-size: 14px;">在并发量大的时候，会遇到和《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568&amp;scene=21#wechat_redirect" target="_blank" style="font-family: 宋体; font-size: 14px; line-height: 22.4px; white-space: normal;">库存扣多了，到底怎么整</a><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;"></span>》文章中一样的并发一致性问题。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px; color: rgb(255, 76, 0);">redis<span style="font-size: 14px; font-family: 宋体;">的</span>WATCH<span style="font-size: 14px; font-family: 宋体;">和</span>EXEC<span style="font-size: 14px; font-family: 宋体;">可以提供类似事务的机制</span></span><span style="font-size: 14px; font-family: 宋体;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">WATCH<span style="font-size: 14px; font-family: 宋体;">观察</span>key<span style="font-size: 14px; font-family: 宋体;">是否被改动</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果提交时</span>key<span style="font-size: 14px; font-family: 宋体;">被改动，</span>EXEC<span style="font-size: 14px; font-family: 宋体;">将返回</span>null<span style="font-size: 14px; font-family: 宋体;">，表示事务失败</span></span></p></li></ul><p><span style="font-family: 宋体; font-size: 14px;">上面保证一致性的库存扣减可能类似于这样执行：</span></p><p><span style="font-size: 12px;">WATCH key</span></p><p><span style="font-size: 12px;">$num = GET key</span></p><p><span style="font-size: 12px;">$num = $num - $count</span></p><p><span style="font-size: 12px;">MULTI</span></p><p><span style="font-size: 12px;">SET key $num</span></p><p><span style="font-size: 12px;">EXEC</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">在</span>WATCH<span style="font-size: 14px; font-family: 宋体;">之后，</span>EXEC<span style="font-size: 14px; font-family: 宋体;">执行之前，如果</span>key<span style="font-size: 14px; font-family: 宋体;">的值发生变化，则</span>EXEC<span style="font-size: 14px; font-family: 宋体;">会失败。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">redis<span style="font-size: 14px; font-family: 宋体;">的</span>WATCH<span style="font-size: 14px; font-family: 宋体;">为何能够保证事务性，本质上，它使用的就是乐观锁</span>CAS<span style="font-size: 14px; font-family: 宋体;">机制。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">大部分情况下，</span>redis<span style="font-size: 14px; font-family: 宋体;">不同的客户端会访问不同的</span>key<span style="font-size: 14px; font-family: 宋体;">，所以</span>WATCH<span style="font-size: 14px; font-family: 宋体;">碰撞的概率会比较小，在秒杀的业务场景，即使使用</span>WATCH<span style="font-size: 14px; font-family: 宋体;">，调用侧仍然需要重试。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">在</span>CAS<span style="font-size: 14px; font-family: 宋体;">机制这一点上，</span>redis<span style="font-size: 14px; font-family: 宋体;">和</span>mysql<span style="font-size: 14px; font-family: 宋体;">相比没有额外的优势。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;">redis<span style="font-size: 14px; font-family: 宋体;">的<strong>性能之所以高</strong>，还是</span><span style="font-size: 14px; color: rgb(255, 76, 0);">redis<span style="font-size: 14px; font-family: 宋体;">内存访问与</span>mysql<span style="font-size: 14px; font-family: 宋体;">数据落盘</span></span><span style="font-size: 14px; font-family: 宋体;">的差异导致的。内存访问的不足是，数据具备“易失性”，如果重启，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">可能导致数据的丢失</span>。当然</span>redis<span style="font-size: 14px; font-family: 宋体;">也可以固化数据，难道每次都刷盘？</span>redis<span style="font-size: 14px; font-family: 宋体;">真心没法当作</span>mysql<span style="font-size: 14px; font-family: 宋体;">用。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">最后，</span>redis<span style="font-size: 14px; font-family: 宋体;">用单线程来避免物理锁，但</span>mysql<span style="font-size: 14px; font-family: 宋体;">多线程也有多线程并发的优势。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">回答</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：可以使用</span>redis<span style="font-size: 14px; font-family: 宋体;">的事务性扣减库存，但在</span>CAS<span style="font-size: 14px; font-family: 宋体;">机制上比</span>mysql<span style="font-size: 14px; font-family: 宋体;">没有优势，高性能是因为其内存存储的原因，带来的副作用是数据有丢失风险，具体怎么用，还得结合业务折衷（<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">任何脱离业务的架构设计都是耍流氓</span>）。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">柳岩三</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">支持幂等能否使用客户端</span>token<span style="font-size: 14px; font-family: 宋体;">，业务流水？</span></span></p><p><span style="font-family: 宋体; font-size: 14px;">能否使用时间戳，版本号来保证一致性？</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">回答</span></strong><span style="font-family: 宋体; font-size: 14px;">：可以。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">留言四</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">能否使用队列，在数据库侧串行执行，降低锁冲突？</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">回答</span></strong><span style="font-family: 宋体; font-size: 14px;">：可以。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">留言五</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">能否使用事务？</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">回答</span></strong><span style="font-family: 宋体; font-size: 14px;">：容易死锁，吞吐量很低，不建议。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">留言六</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">能否使用分布式锁解决，例如</span>setnx<span style="font-size: 14px; font-family: 宋体;">,&nbsp;</span>mc<span style="font-size: 14px; font-family: 宋体;">,&nbsp;</span>zookeeper<span style="font-size: 14px; font-family: 宋体;">？</span></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">回答</span></strong><span style="font-family: 宋体; font-size: 14px;">：可以，但吞吐量真的高么。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><strong><span style="font-size: 14px; font-family: 宋体;">留言六</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">文章重点讲了幂等性和一致性，没有深入展开讲高吞吐，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">利用缓存抗读请求</span>，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">利用水平扩展增加性能</span>是提升吞吐量的根本方案。</span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">回复</span></strong><span style="font-size: 14px; font-family: 宋体;">：很中肯。<br><br></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">留言</span>1-6<span style="font-size: 14px; font-family: 宋体;">代表了评论的多个观点，由于时间有限，《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568&amp;scene=21#wechat_redirect" target="_blank">库存扣多了，到底怎么整</a>》许多地方没有讲清楚，大伙见谅。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果本文让你对redis的事务操作有个重新认识，帮忙点赞和<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">转发</span>哟。</span></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1498052271&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ1KJasWOsq8hSo-mm4SVBUqXpDLOmbKmY46mI-tH6ASrpLYSYQojdSaCl4vWp*Xp7QhjTVxLv9g9coxL9xmzm2movMXm2X0OXI3--0fIRcym-eaggZi-HkBXm0i3TCW4qEz3A-PiB81MOhueDSj9iQA=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960197&amp;idx=1&amp;sn=2e5c17d521772d28d39f31af5d22b34a&amp;chksm=bd2d06598a5a8f4f9de2da89ba8fab711823935442fc632b65d461c923852485ff392c987568#rd">阅读原文</a>
{% endraw  %}

