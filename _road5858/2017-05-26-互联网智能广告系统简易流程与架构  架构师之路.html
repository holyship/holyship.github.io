---
title: 互联网智能广告系统简易流程与架构 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496016963&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgD6V1fy1gfLC4SdOVjUMYr24p0ry-*E0jo0taCYhoUWChRsD7Qs8WnL8arP3cvMke6Nl66lqdt*d9li-EkIInh6sZKZsp1eHCPVdu8PcurldW3k2iUkNp7r2X5qnqQzrtw9YN06hQVq0ukMhPl3qlMk=
date: '2017-05-26 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;">很多朋友估计没有做过这一块，争取最简洁的语言描述清楚。</span></p><p><br></p><p><span style="font-size: 16px;"><strong>一、业务简述</strong></span></p><p><span style="font-size: 14px;"><img src="/road5858/images/799a8e7b9f3624fafd4b700a7b78a403f04b1cf3" style="width: 380px !important; height: 287px !important; visibility: visible !important;"></span></p><p><span style="font-size: 14px;">从业务上看&nbsp;&nbsp;&nbsp;&nbsp;整个智能广告系统，主要分为：</span></p><p><span style="font-size: 14px;">1）<strong>业务端</strong>：广告主的广告后台</span></p><p><span style="font-size: 14px;">2）<strong>展现端</strong>：用户实际访问的页面</span></p><p><br></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">业务端</span><span style="font-size: 14px;">，<strong>广告主</strong>主要有两类行为：</span></p><p><span style="font-size: 14px;">1）<strong>广告设置行为</strong>：例如设置投放计划，设置地域，类别，关键字，竞价等</span></p><p><span style="font-size: 14px;">2）<strong>效果查看行为</strong>：例如广告展示次数是多少，广告点击次数是多少等</span></p><p><br></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">展现端</span><span style="font-size: 14px;">，<strong>用户</strong>主要也有两类行为：</span></p><p><span style="font-size: 14px;">1）<strong>站点浏览行为</strong>：用户浏览实际的信息，此时广告系统决定出广告主的什么广告</span></p><p><span style="font-size: 14px;">2）<strong>广告点击行为</strong>：此时广告系统会对广告主进行扣费</span></p><p><br></p><p><span style="font-size: 16px;"><strong>二、业务流程</strong></span></p><p><span style="font-size: 14px;">下面通过一个的例子，让业务流程更直观。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">步骤一：<strong>广告主</strong>在业务端投递广告</span></p><p><span style="font-size: 14px;">广告主登录业务端后台，进行设置：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">今日投放<strong>地域</strong>是“北京-上地”</span></p></li><li><p><span style="font-size: 14px;">投放<strong>类别</strong>是“租房”</span></p></li><li><p><span style="font-size: 14px;">定向<strong>人群</strong>为“女”，“30岁以下”</span></p></li><li><p><span style="font-size: 14px;">需要推广的广告<strong>内容</strong>是他发布的一条“房屋出租”的帖子</span></p></li><li><p><strong><span style="font-size: 14px;">竞价</span></strong><span style="font-size: 14px;">设置的是0.2元</span></p></li><li><p><span style="font-size: 14px;">单日<strong>预算</strong>是20元</span></p></li></ul><p><span style="font-size: 14px;">这些数据，当然通过业务端存储到了数据层，即数据库和缓存里。</span></p><p><br></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">步骤二：<strong>用户</strong>来到了网站，进入了“北京-上地-租房”类别，广告初筛实施</span></p><p><span style="font-size: 14px;">用户产生了平台浏览行为，网站除了展示自然内容，还要展示广告内容。</span><span style="font-size: 14px;">被展现的广告不能太离谱，太离谱用户也不会点击。</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px;"><img src="/road5858/images/799a8e7b9f3624fafd4b700a7b78a403f04b1cf3" style="width: 380px !important; height: 287px !important;"></span></span></p><p><span style="font-size: 14px;">合适的广告，必须符合“<strong>语义相关性</strong>”，即<strong>基础检索</strong><span style="color: rgb(255, 76, 0); font-size: 14px;">属性（广告属性）</span>必须符合（<strong>广告能否满足用户的需求</strong>，满足了点击率才高），这个工作是通过<span style="color: rgb(255, 76, 0); font-size: 14px;">BS-basic search</span>检索服务完成的。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">BS从数据层检索到“北京-上地-租房”的广告帖子。</span></p><p><br></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">步骤三：用户属性与广告主属性匹配，广告精筛实施</span></p><p><span style="font-size: 14px;">步骤二中，基础属性初筛了以后，要进行<strong>更深层次的策略筛选</strong>（<strong>用户能否满足广告的需求</strong>），此例中，</span><span style="font-size: 14px;">广告主的精准需求为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">用户<strong>性别</strong>为“女”</span></p></li><li><p><span style="font-size: 14px;">用户<strong>年龄</strong>为“30岁以下”</span></p></li><li><p><span style="font-size: 14px;">用户<strong>访问IP</strong>是“北京”</span></p></li></ul><p><span style="font-size: 14px;"><span style="font-size: 14px;"><img src="/road5858/images/799a8e7b9f3624fafd4b700a7b78a403f04b1cf3" style="width: 380px !important; height: 287px !important;"></span></span></p><p><span style="font-size: 14px;">系统将初筛出来的M条广告和<span style="color: rgb(255, 76, 0); font-size: 14px;">用户属性</span>进行匹配筛选，又过滤掉了一部分，最后剩余N条待定广告，这些广告既满足用户的需求（初筛），这些用户也满足广告主的需求（精筛），后者是在<span style="color: rgb(255, 76, 0); font-size: 14px;">AS-advanced search</span>策略服务完成的。</span></p><p><br></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">步骤四：综合排序，并返回Top X的广告</span></p><p><span style="font-size: 14px;">经过步骤2和步骤3的初筛和精筛之后，待选的N条广告既能满足用户当前的需求，用户亦能满足广告主的筛选需求，但实际情况是，广告位只有3个，怎么办呢？就需要我们对N条广告进行综合打分排序（<strong>满足平台的需求</strong>，广告平台要多赚钱嘛）。</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">打分排序的依据是什么呢？</span></strong></p><p><span style="font-size: 14px;">有人说按照<span style="color: rgb(255, 76, 0); font-size: 14px;">竞价</span>排序bid，出价高的打分高（这是大家对百度最大的误解，百度是cpc收费）</span></p><p><span style="font-size: 14px;">有人说按照<span style="color: rgb(255, 76, 0); font-size: 14px;">CTR点击率</span>排序，CTR高的点的人多（百度的kpi指标可不是pv）</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">出价高，但没人点击，广告平台没有收益；点击率高，但出价低，广告平台还是没有收益。<strong>最终应该按照广告的出价与CTR的乘积作为综合打分排序的依据，bid*CTR</strong>。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">既然bid*CTR是所有广告综合打分的依据，且<span style="font-size: 14px; color: rgb(255, 0, 0);">出价bid又是广告主事先设定好的，那么实际上，广告排序问题的核心又转向了广告CTR的预测</span>，<strong>CTR预测</strong>是推荐系统、广告系统、搜索系统里非常重要的一部分，是一个工程，算法，业务三方结合的问题，本文就不展开讨论了。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">无论如何，N条广告，根据bid*预估CTR进行综合打分排序后，返回了打分最高的3个广告（广告位只有3个）。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">有些系统没有第二步骤用户属性过滤，而是将用户属性因素考虑到综合排序中。</span></p><p><br></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">步骤五：展现端展示了广告，用户点击了广告</span></p><p><span style="font-size: 14px;">展示了广告后，展现端js会上报广告<strong>展示日志</strong>，有部分用户点击了广告，服务端会记录<strong>点击日志</strong>，这些日志可以作为广告算法实施的数据源，同时，他们经过统计分析之后，会被展示给广告主，让他们能够看到自己广告的展示信息，点击信息。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">这些日志（一般会实施AB测），也是算法效果好坏评估的重要依据，根据效果逐步优化改进算法。</span></p><p><br></p><p><span style="font-size: 14px; color: rgb(255, 0, 0);">步骤六：对广告主进行扣费</span></p><p><span style="font-size: 14px;">用户既然点击了广告，平台就要对投放广告的广告主进行<strong>扣费</strong>了，扣费前当然要经过反作弊系统的过滤（主要是恶意点击），扣费后信息会实时反映到数据层，费用扣光后，广告就要从数据层下线。</span></p><p><br></p><p><strong>三、系统综述</strong></p><p><span style="font-size: 14px;"><img src="/road5858/images/799a8e7b9f3624fafd4b700a7b78a403f04b1cf3" style="width: 380px !important; height: 287px !important;"></span></p><p><span style="font-size: 14px;">聊完业务流程，再来看系统架构，任何脱离业务的架构设计都是耍流氓。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">从系统分层架构上看，智能广告系统分为三层：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><strong>站点层</strong>：用户和广告主直接面向的网站站点</span></p></li><li><p><span style="font-size: 14px;"><strong>服务层</strong>：为了实现智能广告的业务逻辑，提供的通用服务，此处又主要分为<strong>四大类服务</strong>：</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; color: rgb(255, 0, 0);">策略服务BS</span>：实施广告策略，综合排序</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; color: rgb(255, 0, 0);">检索服务AS</span>：语义相关性检索</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; color: rgb(255, 0, 0);">计费服务</span>：用户点击广告时进行扣费</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; color: rgb(255, 0, 0);">反作弊服务</span>：不是每次点击都扣费，要经过反作弊，去除恶意点击（相对独立，未在架构图中画出）</span></p></li><li><p><span style="font-size: 14px;"><strong>数据层</strong>：用户数据，广告数据，竞价数据，日志数据等等等等</span></p></li></ul><p><br></p><p><span style="font-size: 14px;"><strong>四、总结</strong></span></p><p><span style="font-size: 14px;">智能广告系统的业务流程与系统架构：</span></p><p><span style="font-size: 14px;">1）<strong>广告主投放与设置广告</strong></span></p><p><span style="font-size: 14px;">2）<strong>用户访问平台，展现合适广告</strong></span></p><p><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;通过<span style="color: rgb(255, 76, 0); font-size: 14px;"><strong>广告属性</strong></span>，进行<span style="color: rgb(255, 76, 0); font-size: 14px;">“语义相关性”初筛</span>，通过BS完成</span></p><p><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;通过<span style="color: rgb(255, 76, 0); font-size: 14px;"><strong>用户属性</strong></span>，出价信息，点击率预测信息，进行<span style="color: rgb(255, 76, 0); font-size: 14px;">综合打分排序</span>筛选，通过AS完成</span></p><p><span style="font-size: 14px;">3）<strong>记录展现日志，点击日志，进行扣费</strong></span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">广告是展现，是一个：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">广告满足用户需求（初筛）</span></p></li><li><p><span style="font-size: 14px;">用户满足广告需求（精筛）</span></p></li><li><p><span style="font-size: 14px;">平台利益最大化（bid*CTR综合排序）</span></p></li></ul><p><span style="font-size: 14px;">的过程</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">广告的排序</span></strong><span style="color: rgb(255, 76, 0); font-size: 14px;">不是由出价(bid)决定的</span><span style="font-size: 14px;">，而是<span style="color: rgb(255, 76, 0); font-size: 14px;">由出价(bid)*点击率(ctr)决定</span>的。</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">点击率(ctr)</span></strong><span style="font-size: 14px;">是一个<span style="color: rgb(255, 76, 0); font-size: 14px;">未来将要发生的行为</span>，智能广告系统的<strong>核心与难点</strong>是<span style="color: rgb(255, 76, 0); font-size: 14px;">点击率预测</span>。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">==【完】==</span></p><p><span style="font-size: 14px;">文章说清楚了么，希望这一分钟没有浪费。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">若有收获，<span style="color: rgb(255, 76, 0); font-size: 14px;">帮转</span>哟。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496016963&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgD6V1fy1gfLC4SdOVjUMYr24p0ry-*E0jo0taCYhoUWChRsD7Qs8WnL8arP3cvMke6Nl66lqdt*d9li-EkIInh6sZKZsp1eHCPVdu8PcurldW3k2iUkNp7r2X5qnqQzrtw9YN06hQVq0ukMhPl3qlMk=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960086&amp;idx=1&amp;sn=70bbe7165ecddc7896767f4503a927fe&amp;chksm=bd2d06ca8a5a8fdc67fcacb169583f53a968fdf623a20395926059d44e6abae6b2e56ff1f9f9#rd">阅读原文</a>
{% endraw  %}

