---
title: 小小的公共库，大大的耦合，你痛过吗？
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-6KJpmzI7WA1rLCVt-D02UKBlMIOzqdyL9Ycz2O9CWMJImAAN-YHNU5Ww*dnYmXMMTvF-XlKGe2FwswbLBB6e48=
date: '2017-11-24 00:00:00 +0000'

---

{% raw  %}
<p><strong><span style="font-size: 14px;letter-spacing: 1px;">什么是耦合？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">耦合，是架构中，本来不相干的代码、模块、服务、系统因为某些原因联系在一起，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">各自独立性差，影响则相互影响，变动则相互变动</span>的一种架构状态。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">感官上，怎么发现系统中的耦合？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">作为技术人，每每在心中骂上下游，骂兄弟部门，“这个东西跟我有什么关系？为什么需要我来配合做这个事情？”。<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">明明不应该联动，却要被动受影响</span>，就可能有潜在的耦合。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="letter-spacing: 1px;">因为公共库，导致相互受影响，就是一个耦合的典型案例。</span></strong></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">场景还原</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">一个看似“公共”的业务库(*.so *.jar *.dll *.php)，很多业务系统都依赖于这个公共库，这个库使得这些系统都耦合在了一起。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">注：这里的公共库不是指像“字符串操作”这样的不变化的工具库，更多是指通用业务的公共库。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">耦合如何导致相互影响？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">业务1，业务2，业务3都依赖于某一个biz.jar，业务1因为某个需求需要升级biz.jar。上线前，业务1的QA进行了大量的测试，确保无误后，代码发布，发布完线上验证无误后，上线完成，闪人。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">突然，bug群里有人反馈，业务2的系统挂了，业务3的系统也挂了，一下炸开了锅：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务2的大boss</span></strong><span style="font-size: 14px;letter-spacing: 1px;">首先发飙：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">技术都干啥了，怎么系统挂了</span>”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务2的rd</span></strong><span style="font-size: 14px;letter-spacing: 1px;">一脸无辜：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">业务1上线了，所以我们挂了</span>”</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">额，然而，这个理由，好像在大boss那解释不通…</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务2的大boss</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">业务1上线？业务1上线前测试了么</span>”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务1的qa</span></strong><span style="font-size: 14px;letter-spacing: 1px;">自信满满：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">测试了呀，上线前上线后都验证了，没问题呀</span>”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务2的大boss</span></strong><span style="font-size: 14px;letter-spacing: 1px;">对业务2的rd吼道“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">还想甩锅，拖出去祭天</span>”</span></p></li></ul><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzkEdETg7Agpw0ffP8JKaL5aDQgzOnrvaibicd4WCYuKJp8UuW79OB08qIP0corUiafKtGLiaB23C2Dxw/0?wx_fmt=png" style="width: 554px !important; height: 230px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">不知道大家工作中会不会遇到这样的场景，因为公共库的耦合，兄弟部门上线，影响的确是你，此时你心里可能就在骂娘了，这帮不靠谱的**队友。</span><br></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">特别的，如果公共库的使用方很广，这个耦合很严重，可能影响很大的范围。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">如何解除公共库耦合？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">方案一：代码拷贝一份</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">别嘲笑这个方案，谁敢说自己写代码的时候没这么干过？</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">我们都知道这不是一个好的方案，但不可否认，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">拷贝之后，代码各自演化，一个地方升级出错，只影响一方</span>，拷贝方只要不动原有代码，至少是不会受影响的。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">代码拷贝缺点很多，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">系统拆分时，万不得已不要使用这个方案</span>。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">方案二：<span style="letter-spacing: 1px;font-size: 18px;">垂直拆分</span>，将公共库里业务个性化的代码拆到调用方去，不要放在公共库里</span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzkEdETg7Agpw0ffP8JKaL5vibznGODaf5McneqjFQ25TEuvlO1VLV5Owkx1ibhsVahF3Q1DWa1hDxg/0?wx_fmt=png" style="width: 555px !important; height: 234px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">需要把<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">业务个性的代码拆分到各个业务线自己的工程</span>，自己的业务库里去，例如</span><span style="font-size: 14px;letter-spacing: 1px;">s1.jar / s2.jar / s3.jar</span><span style="font-size: 14px;letter-spacing: 1px;">，修改各自的代码，至少不会扩大影响范围。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">大家为什么都把代码往一个公共库里塞？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">很多时候，因为惰性，一点一点的惰性，日积月累，终成大坑。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">这个垂直拆分是一个架构重构的过程，需要各业务方配合。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">方案三：<span style="letter-spacing: 1px;font-size: 18px;">服务化</span>，将公共库里通用业务代码拆到下层去</span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOzkEdETg7Agpw0ffP8JKaL5GVzOrpjHbriaBby47icoKAhIr1pEHeiawFgDbCjFTeYt5QSN6oNticf5oA/0?wx_fmt=png" style="width: 770px !important; height: 328.219px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">完成了第一步，业务个性化的代码提取到业务侧上游。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">接下来是第二步，业务通用的代码，下沉抽取一层服务</span><span style="font-size: 14px;letter-spacing: 1px;">，服务对上游提供RPC接口：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">每次修改底层接口，需要测试接口的兼容性，保证不影响旧调用方</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">如果是新的业务，则建议新增接口</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">最终，达到通过服务RPC调用的方式来解除耦合。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">有朋友会问：</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">底层服务接口的测试</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">上游业务层对公共库的测试</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">都是测试，为何前者能控制影响范围呢？</span></p><ul class=" list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">底层接口，所有人调用</span><span style="font-size: 14px;letter-spacing: 1px;">，接口没问题则调用方都没问题</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">上游业务层对公共库测试，只能保证自己的业务没有问题</span><span style="font-size: 14px;letter-spacing: 1px;">，并不能保证其他业务方没有问题</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="letter-spacing: 1px;">个性业务代码上浮，共性业务代码服务化下沉</span></strong></span><span style="font-size: 14px;letter-spacing: 1px;">，只是一个很小的优化点，但对于<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">公共库解耦</span>却是非常的有效。</span></p><p><br><span style="font-size: 14px;letter-spacing: 1px;">希望大家每天收获一点点，这样架构就能美好一点点。</span><br></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">别人上线，你的系统挂了，痛过吗？那帮<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">转</span>下。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-6KJpmzI7WA1rLCVt-D02UKBlMIOzqdyL9Ycz2O9CWMJImAAN-YHNU5Ww*dnYmXMMTvF-XlKGe2FwswbLBB6e48=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960632&amp;idx=1&amp;sn=769f12c5180bdc37d71c99cdf7b4077f&amp;chksm=bd2d00e48a5a89f2fa42e0c360e31c28cfd9cce7ab31b425cb5ef8da43bef117c95d0ca8c2cd#rd">阅读原文</a>
{% endraw  %}

