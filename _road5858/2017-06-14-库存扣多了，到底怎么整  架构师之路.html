---
title: 库存扣多了，到底怎么整 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1498052271&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ1KJasWOsq8hSo-mm4SVBUqXpDLOmbKmY46mI-tH6ASrpLYSYQojdSaCl4vWp*Xp7QNUyDBLaKgB6O17FwYl6Zc7z7sZG-gI8TaDgrkQkeOT3bc0SgRsdwxbmNYM7Vz7Q2*i8kE9*JSR0yRCGoj1vVw=
date: '2017-06-14 00:00:00 +0000'

---

{% raw  %}
<p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUKugibKPiajBh7ibRjpZ3GibNk7ufMUEqHeiaNM11L8wOPbqbIhlBibwOicrJQ/0?wx_fmt=png" style="width: 143px !important; height: 187px !important; visibility: visible !important;"></p><p><span style="font-size: 14px; line-height: 1.6;">业务复杂、数据量大、并发量大的业务场景下，典型的互联网架构，一般会分为这么几层：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">调用层，一般是处于端上的browser或者APP</span></p></li><li><p><span style="font-size: 14px;">站点层，一般是拼装html或者json返回的web-server层</span></p></li><li><p><span style="font-size: 14px;">服务层，一般是提供RPC调用接口的service层</span></p></li><li><p><span style="font-size: 14px;">数据层，提供固化数据存储的db</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">对于库存业务，一般有个库存服务，提供库存的</span><strong><span style="font-size: 14px;">查询、扣减、设置</span></strong><span style="font-size: 14px;">等RPC接口：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUsOXKFDNKXxK8lGe29KwnR260YeteT6xQcn2bMjHofibiaoEVOkSib2hew/0?wx_fmt=png" style="width: auto !important; height: auto !important; visibility: visible !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;">库存查询</span></strong><span style="font-size: 14px;">，stock-service本质上执行的是</span></p><p><span style="font-size: 12px;">select num from stock where sid=$sid</span></p></li><li><p><strong><span style="font-size: 14px;">库存扣减</span></strong><span style="font-size: 14px;">，stock-service本质上执行的是</span></p><p><span style="font-size: 12px;">update stock set num=num-$reduce where sid=$sid</span></p></li><li><p><strong><span style="font-size: 14px;">库存设置</span></strong><span style="font-size: 14px;">，stock-service本质上执行的是</span></p><p><span style="font-size: 12px;">update stock set num=$num_new where sid=$sid</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">用户下单前，一般会对库存进行查询，有足够的存量才允许扣减：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUcwFSu0Bdt1qdtnGnlLZE3pG0AuswI55G0dy9eQ1SaeX0zuj8bAiaPJg/0?wx_fmt=png" style="width: 182px !important; height: 182px !important;"></p><p><span style="font-size: 14px;">如上图所示，通过查询接口，得到库存是5。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">用户下单时，接着会对库存进行扣减：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUoib3OehDV9rJXwtVGh3zAIjHAUS0O0KHm4q7ng4482coAQTsxiarn5lw/0?wx_fmt=png" style="width: 187px !important; height: 183px !important;"></p><p><span style="font-size: 14px;">如上图所示，购买3单位的商品，通过扣减接口，最终得到库存是2。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">希望设计往往有<strong>容错机制</strong>，例如“<span style="font-size: 14px; color: rgb(255, 76, 0);">重试</span>”，如果通过扣减接口来修改库存，在<span style="font-size: 14px; color: rgb(255, 76, 0);">重试时，可能会得到错误的数据，导致重复扣减</span>：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUgss9lmJPXtZuYn0dlDAR99I86dKsUWDx7KiaeUHruKXXcSAcRJTAQuw/0?wx_fmt=png" style="width: 195px !important; height: 188px !important;"></p><p><span style="font-size: 14px;">如上图所示，如果数据库层面有重试容错机制，可能导致一次扣减执行两次，最终得到一个负数的错误库存。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">重试导致错误的<strong>根本原因</strong>，是因为<span style="font-size: 14px; color: rgb(255, 76, 0);">“扣减”操作是一个<strong>非幂等</strong>的操作</span>，不能够重复执行，改成设置操作则不会有这个问题：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUJE4wWb7RbOtW39MSu8hHtibIhiawl4ece7KbNk5wDUWia9BkvyV8EOmVA/0?wx_fmt=png" style="width: 191px !important; height: 187px !important;"></p><p><span style="font-size: 14px;">如上图所示，同样是购买3单位的商品，通过设置库存操作，即使有重试容错机制，也不会得到错误的库存，<span style="font-size: 14px; color: rgb(255, 76, 0);">设置库存是一个<strong>幂等</strong>操作</span>。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">在并发量很大的情况下，还会有其他的问题：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUTt7sPadyVCqoLQh384jbcqoF7xfOdSMvXic1NeX663LxKfUYv1iaskgA/0?wx_fmt=png" style="width: 273px !important; height: 186px !important;"></p><p><span style="font-size: 14px;">如上图所示，两个并发的操作，查询库存，都得到了库存是5。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">接下来用户发生了<strong>并发</strong>的购买动作（秒杀类业务特别容易出现）：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyBCMV76yGykNE4SM5f10ibUm5zx4iadz3pe9wHbNAktYqghPvQ5nictk0ic8qJ1BJ8JWnE9Q66I3Wmow/0?wx_fmt=png" style="width: 296px !important; height: 181px !important;"></p><p><span style="font-size: 14px;">如上图所示：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">用户1购买了3个库存，于是库存要设置为2</span></p></li><li><p><span style="font-size: 14px;">用户2购买了2个库存，于是库存要设置为3</span></p></li><li><p><span style="font-size: 14px;">这两个设置库存的接口并发执行，<strong>库存会先变成2，再变成3，导致数据不一致</strong>（实际卖出了5件商品，但库存只扣减了2，<span style="font-size: 14px; color: rgb(255, 76, 0);">最后一次设置库存会覆盖和掩盖前一次并发操作</span>）</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">其<strong>根本原因</strong>是，<span style="font-size: 14px; color: rgb(255, 76, 0);">设置操作发生的时候，没有检查库存与查询出来的库存有没有变化</span>，理论上：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">库存为5时，用户1的库存设置才能成功</span></p></li><li><p><span style="font-size: 14px;">库存为5时，用户2的库存设置才能成功</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">实际执行的时候：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">库存为5，用户1的set stock 2确实应该成功</span></p></li><li><p><span style="font-size: 14px;">库存变为2了，用户2的set stock 3应该失败掉</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">升级修改很容易，将库存设置接口，stock-service上执行的：</span></p><p><span style="font-size: 12px;">update stock set num=$y where sid=$sid</span></p><p><span style="font-size: 14px;">升级为：</span></p><p><span style="font-size: 12px;">update stock set num=$num_new where sid=$sid <span style="font-size: 12px; color: rgb(255, 76, 0);">and num=$num_old</span></span></p><p><span style="font-size: 14px;">这正是大家常说的“Compare And Set”（CAS），是一种常见的降低读写锁冲突，保证数据一致性的方法。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;">总结</span></strong></p><p><span style="font-size: 14px;">在业务复杂，数据量大，并发量大的情况下，库存扣减容易引发数据的不一致，常见的优化方案有两个：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">调用“设置库存”接口，能够保证数据的<strong>幂等性</strong></span></p></li><li><p><span style="font-size: 14px;">在实现“<strong>设置库存</strong>”接口时，<span style="font-size: 14px; color: rgb(255, 76, 0);">需要加上原有库存的比较</span>，才允许设置成功，能解决高并发下库存扣减的一致性问题</span></p></li></ul><p><span style="font-size: 14px;"></span></p><p><span style="font-size: 14px;">希望大伙有收获。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1498052271&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ1KJasWOsq8hSo-mm4SVBUqXpDLOmbKmY46mI-tH6ASrpLYSYQojdSaCl4vWp*Xp7QNUyDBLaKgB6O17FwYl6Zc7z7sZG-gI8TaDgrkQkeOT3bc0SgRsdwxbmNYM7Vz7Q2*i8kE9*JSR0yRCGoj1vVw=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960185&amp;idx=1&amp;sn=0acd4a563c8c9684373fd05c116c4441&amp;chksm=bd2d06a58a5a8fb3281acd95a7d9494161e75dcd27e95fdd526fce2b031ba79c4153bf255cee#rd">阅读原文</a>
{% endraw  %}

