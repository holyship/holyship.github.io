---
title: 一分钟了解四层/七层反向代理 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1495452139&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeW-T5kTNB0lmNIDfirdmdp3IhNxo89xisNdP56ZXTe4KJtg9Glou1t4ppqeRe4PZrWSlfJW-hvXSswM7*vvqPh-IlcKNbLa-lRhVRrkXoAj8o1vVIHsJkxIhhGqvIHOojdRhkaQG3LLC4ela*Su8GeY=
date: '2017-05-19 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;">上一篇文章《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960128&amp;idx=1&amp;sn=8e0e409b10ab9db549432af461385314&amp;chksm=bd2d069c8a5a8f8ab5cdee602d4062bbdbb25da290668515d36682afa854e374d2a5ff02004b&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960128&amp;idx=1&amp;sn=8e0e409b10ab9db549432af461385314&amp;chksm=bd2d069c8a5a8f8ab5cdee602d4062bbdbb25da290668515d36682afa854e374d2a5ff02004b&amp;scene=21#wechat_redirect">session一致性架构设计实践</a>》，对于其中的第三种“反向代理hash法”，不少同学留言问：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;">什么是四层反向代理hash</span></p></li><li><p><span style="font-size: 14px;">什么是七层反向代理hash</span></p></li><li><p><span style="font-size: 14px;">中间还有三层那里去了</span></p></li><li><p><span style="font-size: 14px;">...</span></p></li></ul><p><br></p><p><span style="font-size: 14px;">今天花几分钟简单和大家解释一下。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">场景：<strong>访问</strong>用户通过proxy请求<strong>被访问</strong>的真实服务器</span></p><p><span style="font-size: 14px;">路径：用户 -&gt; <span style="color: rgb(255, 76, 0); font-size: 14px;">proxy</span> -&gt; real-server</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">什么是代理？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px;">回答：</span><span style="color: rgb(255, 76, 0); font-size: 14px;">[proxy]代表[访问用户]</span>，此时proxy是<strong>代理</strong>。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">例如：</span></p><p><span style="font-size: 14px;">在家访问xxoo网站，不希望xxoo网站trace到我们的真实ip，于是就找一个proxy，通过proxy来访问，<span style="color: rgb(255, 76, 0); font-size: 14px;">此时proxy代表用户</span>，<strong>网站以为proxy的ip就是用户的ip</strong>。</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">什么是反向代理？</span></strong></p><p><span style="font-size: 14px;">回答：<span style="color: rgb(255, 76, 0); font-size: 14px;">[proxy]代表[被访问的服务器]</span>，此时proxy是<strong>反向代理</strong>。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">例如：</span></p><p><span style="font-size: 14px;">web-server希望对用户屏蔽高可用、屏蔽web-server扩展、web-server内网ip等细节，于是就找了一个proxy隔在中间，<span style="color: rgb(255, 76, 0); font-size: 14px;">此时proxy代表web-server集群</span>，<strong>用户以为proxy的ip就是被访问web-server的ip</strong>（web-server是集群，具体访问了哪个web-server，用户不知道），由于web-server集群有多台，此时反向代理服务器要具备<strong>负载均衡</strong>的功能。</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">一般怎么做反向代理，负载均衡？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px;">回答：</span>nginx/apache，lvs，F5</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">什么是四层（转发/交换），什么是七层（转发/交换）？</span></strong></p><p><span style="font-size: 14px;">回答：这个是来源于<span style="color: rgb(255, 76, 0); font-size: 14px;">OSI七层模型</span></span></p><p><span style="font-size: 14px;">大学“计算机网络”课程，之前都是用这个七层模型，新版教程用TCP/IP五层模型，这两个模型之间有一个<span style="color: rgb(255, 76, 0); font-size: 14px;">对应关系</span>如下：</span></p><p><span style="font-size: 14px;"><br></span></p><p><img src="/road5858/images/8eaf207866aef693fbd70db3939b3ae0589fed12.png" style="width: 770px !important; height: 568.588px !important;"></p><p><br></p><p><span style="font-size: 14px;">可以看到，<strong>四层</strong><span style="color: rgb(255, 76, 0); font-size: 14px;">是指传输层</span>，<strong>七层</strong><span style="color: rgb(255, 76, 0); font-size: 14px;">是指应用层</span>。</span></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-size: 14px;">更具体的，对应到nginx反向代理hash：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;">四层</span></strong><span style="font-size: 14px;">：根据<span style="color: rgb(255, 76, 0); font-size: 14px;">用户ip+port</span>来做hash</span></p></li><li><p><strong><span style="font-size: 14px;">七层</span></strong><span style="font-size: 14px;">：根据<span style="color: rgb(255, 76, 0); font-size: 14px;">http协议</span>中的某些属性来做hash</span></p></li></ul><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">为什么中间少了几层？</span></strong></p><p><span style="font-size: 14px;">回答：OSI应用层、表示层、会话层<span style="color: rgb(255, 76, 0); font-size: 14px;">合并</span>到TCP/IP的应用层啦。</span></p><p><span style="font-size: 14px;"><br></span></p><p><strong><span style="font-size: 14px;">上面有四层，七层，那有没有二层，三层呢？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px;">回答：有</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px;">二层：根据<strong>数据链路层</strong><span style="color: rgb(255, 76, 0); font-size: 14px;">MAC地址</span>完成数据交换</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px;">三层：根据<strong>网络层</strong><span style="color: rgb(255, 76, 0); font-size: 14px;">IP地址</span>完成数据交换</span></span></p></li></ul><p><span style="font-size: 14px;"><span style="font-size: 14px;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px;">希望解答了大伙之前的一些疑问，希望这一分钟没有浪费，如果有描述不准确的地方，欢迎指正。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px;">==【完】==</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px;">相关推荐：</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960128&amp;idx=1&amp;sn=8e0e409b10ab9db549432af461385314&amp;chksm=bd2d069c8a5a8f8ab5cdee602d4062bbdbb25da290668515d36682afa854e374d2a5ff02004b&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960128&amp;idx=1&amp;sn=8e0e409b10ab9db549432af461385314&amp;chksm=bd2d069c8a5a8f8ab5cdee602d4062bbdbb25da290668515d36682afa854e374d2a5ff02004b&amp;scene=21#wechat_redirect">session一致性架构设计实践</a></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960118&amp;idx=1&amp;sn=767e038cb4378be1c88dd42569a9264f&amp;chksm=bd2d06ea8a5a8ffc7c69c71c2153b10565ecf72b6957c5667fbf9099c9f5478111132e967a35&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960118&amp;idx=1&amp;sn=767e038cb4378be1c88dd42569a9264f&amp;chksm=bd2d06ea8a5a8ffc7c69c71c2153b10565ecf72b6957c5667fbf9099c9f5478111132e967a35&amp;scene=21#wechat_redirect">DNS在架构设计中的巧用</a></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960105&amp;idx=1&amp;sn=0069f2264e227e86a63ee50a4899e0a7&amp;chksm=bd2d06f58a5a8fe33271ed3a378932ad023af7a9004d7fdb44e30a53d53928f984f293a41256&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960105&amp;idx=1&amp;sn=0069f2264e227e86a63ee50a4899e0a7&amp;chksm=bd2d06f58a5a8fe33271ed3a378932ad023af7a9004d7fdb44e30a53d53928f984f293a41256&amp;scene=21#wechat_redirect">跨公网调用的大坑与架构优化方案</a></span></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1495452139&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeW-T5kTNB0lmNIDfirdmdp3IhNxo89xisNdP56ZXTe4KJtg9Glou1t4ppqeRe4PZrWSlfJW-hvXSswM7*vvqPh-IlcKNbLa-lRhVRrkXoAj8o1vVIHsJkxIhhGqvIHOojdRhkaQG3LLC4ela*Su8GeY=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960128&amp;idx=1&amp;sn=8e0e409b10ab9db549432af461385314&amp;chksm=bd2d069c8a5a8f8ab5cdee602d4062bbdbb25da290668515d36682afa854e374d2a5ff02004b#rd">阅读原文</a>
{% endraw  %}

