---
title: 线上服务CPU100%问题快速定位实战
author: 58到家
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1503366049&src=3&ver=1&signature=OYewMZH60kmig22U24i7m6sKVnTwzt3UPW4YGe4v-5baZmWG6eeyYwlgndoMQvEZ2rCh6bD1GFvpiI6UKWdhjRs7AAm5kx2J6jqY1qqw6bH2USSQH-aFhm9jshDyvL5UdTh5K*j*t2j2lhlSIC8SRQjIuRIYZ2aajAdhuTcurQM=
date: '2017-08-18 00:00:00 +0000'

---

{% raw  %}
<p><strong><span style="font-size: 14px;"><span style="font-family: 宋体;">功能</span><span style="font-family: 宋体;">问题</span></span></strong><span style="font-size: 14px;"><span style="font-family: 宋体;">，通过日志，单步调试相对比较好定位。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">性能</span><span style="font-size: 14px; font-family: 宋体;">问题</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，例如线上服务器</span>CPU100%<span style="font-size: 14px; font-family: 宋体;">，如何找到相关服务，如何定位问题代码，更考验技术人的功底。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;">58<span style="font-size: 14px; font-family: 宋体;">到家架构部，运维部，</span>58<span style="font-size: 14px; font-family: 宋体;">速运技术部联合进行了一次</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">线上服务</span>CPU<span style="font-size: 14px; font-family: 宋体;">问题排查实战演练</span></span><span style="font-size: 14px; font-family: 宋体;">，同学们反馈有收获，特将实战演练的试题和答案公布出来，希望对大家也有帮助。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">题目</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">某服务器上部署了若干</span>tomcat<span style="font-size: 14px; font-family: 宋体;">实例，即若干垂直切分的</span>Java<span style="font-size: 14px; font-family: 宋体;">站点服务，以及若干</span>Java<span style="font-size: 14px; font-family: 宋体;">微服务，突然收到运维的</span>CPU<span style="font-size: 14px; font-family: 宋体;">异常告警。</span></span></p><p><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">问：如何定位是<strong>哪个服务进程</strong>导致</span><span style="font-size: 14px; line-height: 1.6;">CPU</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">过载，<strong>哪个线程</strong>导致</span><span style="font-size: 14px; line-height: 1.6;">CPU</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">过载，<strong>哪段代码</strong>导致</span><span style="font-size: 14px; line-height: 1.6;">CPU</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">过载？</span><br></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">步骤一、找到最耗</span>CPU</strong><strong><span style="font-family: 宋体;">的进程</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">工具</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span>top</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">方法</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">执行</span><span style="font-size: 14px; color: rgb(255, 76, 0);">top -c</span> <span style="font-size: 14px; font-family: 宋体;">，显示进程运行信息列表</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">键入</span><span style="font-size: 14px; color: rgb(255, 76, 0);">P</span> (<span style="font-size: 14px; font-family: 宋体;">大写</span>p)<span style="font-size: 14px; font-family: 宋体;">，进程按照</span>CPU<span style="font-size: 14px; font-family: 宋体;">使用率排序</span></span></p></li></ul><p><strong><span style="font-family: 宋体; font-size: 14px;">图示</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwqQNj1v6A8STxric6DhicO1RNpS1RoZ6kgVks8tTvI6CtYpjYshib8ugjpbLCRMzGjYP5MUK3Fwhq9w/0?wx_fmt=png" style="width: 770px !important; height: 249.956px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图，最耗</span>CPU<span style="font-size: 14px; font-family: 宋体;">的进程</span>PID<span style="font-size: 14px; font-family: 宋体;">为</span>10765</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">步骤二：找到最耗</span>CPU</strong><strong><span style="font-family: 宋体;">的线程</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">工具</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span>top</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">方法</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; color: rgb(255, 76, 0);">top -Hp 10765</span><span style="font-size: 14px;"> <span style="font-size: 14px; font-family: 宋体;">，显示一个进程的线程运行信息列表</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">键入</span><span style="font-size: 14px; color: rgb(255, 76, 0);">P</span> (<span style="font-size: 14px; font-family: 宋体;">大写</span>p)<span style="font-size: 14px; font-family: 宋体;">，线程按照</span>CPU<span style="font-size: 14px; font-family: 宋体;">使用率排序</span></span></p></li></ul><p><strong><span style="font-family: 宋体; font-size: 14px;">图示</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwqQNj1v6A8STxric6DhicO1RpEQ1HvfmxdKCxuA3cGe2s5S64HPcFHwowbcNrQsAuia4psFWYmTyBwA/0?wx_fmt=png" style="width: 770px !important; height: 338.896px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图，进程</span>10765<span style="font-size: 14px; font-family: 宋体;">内，最耗</span>CPU<span style="font-size: 14px; font-family: 宋体;">的线程</span>PID<span style="font-size: 14px; font-family: 宋体;">为</span>10804</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">步骤三：将线程</span>PID</strong><strong><span style="font-family: 宋体;">转化为</span>16</strong><strong><span style="font-family: 宋体;">进制</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">工具</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span>printf</span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">方法</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span><span style="font-size: 14px; color: rgb(255, 76, 0);">printf “%x\n” 10804</span></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">图示</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwqQNj1v6A8STxric6DhicO1R1NI7Gwhyj6iaiaR87lfiacwuTLbwmtM6MFUuBERVdqsGbz4jWbkbVm4nQ/0?wx_fmt=png" style="width: 600px !important; height: 70px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图，</span>10804<span style="font-size: 14px; font-family: 宋体;">对应的</span>16<span style="font-size: 14px; font-family: 宋体;">进制是</span>0x2a34<span style="font-size: 14px; font-family: 宋体;">，当然，这一步<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">可以用计算器</span>。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">之所以要转化为</span>16<span style="font-size: 14px; font-family: 宋体;">进制，是因为堆栈里，线程</span>id<span style="font-size: 14px; font-family: 宋体;">是用</span>16<span style="font-size: 14px; font-family: 宋体;">进制表示的。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">步骤四：查看堆栈，找到线程在干嘛</span></strong></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">工具</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span>pstack/jstack/grep</span></p><p><strong><span style="font-size: 14px; font-family: 宋体;">方法</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：</span><span style="font-size: 14px; color: rgb(255, 76, 0);">jstack 10765 | grep ‘0x2a34’ -C5 --color</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">打印进程堆栈</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过线程</span>id<span style="font-size: 14px; font-family: 宋体;">，过滤得到线程堆栈</span></span></p></li></ul><p><strong><span style="font-family: 宋体; font-size: 14px;">图示</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOwqQNj1v6A8STxric6DhicO1Rlr3V2ibWsbgvRs5LBicicSXMMcCrfMWKxL8IibbiaBcuDb4dDcvoRmJF67w/0?wx_fmt=png" style="width: 770px !important; height: 270.109px !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如上图，找到了耗</span>CPU<span style="font-size: 14px; font-family: 宋体;">高的线程对应的线程名称“</span>AsyncLogger-1<span style="font-size: 14px; font-family: 宋体;">”，以及看到了该线程正在执行代码的堆栈。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">希望对经常进行线上CPU问题排查的同学有帮助，如果有更好的实践，也欢迎分享。</span></p><p><span style="font-family: 宋体; font-size: 14px;">想要印象深刻，请大家务必<strong>线上实操练习</strong>哟。</span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family:宋体"><span style="font-size: 14px; line-height: 22.4px;">如果有收获，<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px; color: rgb(255, 76, 0);">帮转</span>哈。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">相关文章：</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960323&amp;idx=1&amp;sn=e04af14d2ebf939133869e0f18bb0dd1&amp;chksm=bd2d01df8a5a88c98c3cb94a99334a16b372fd997f36bc757a38bb44b70d977797fa840064dc&amp;scene=21#wechat_redirect" target="_blank"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">常见线上操作Linux命令实战</span></a></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=205216499&amp;idx=1&amp;sn=656b5403f3be045772bb539c873e6bd0&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">Linux追查线上问题常用命令</span></a></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=400743254&amp;idx=1&amp;sn=147abc381ccd61e28f52699735c8748e&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;">一分钟awk够用</span></a><span style="max-width: 100%; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; font-family: 宋体; font-size: 14px; letter-spacing: 0.5px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=403340380&amp;idx=1&amp;sn=9b4ced5a19f60b0cebf6fd582f1d52ae&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">一分钟sed够用</a></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1503366049&src=3&ver=1&signature=OYewMZH60kmig22U24i7m6sKVnTwzt3UPW4YGe4v-5baZmWG6eeyYwlgndoMQvEZ2rCh6bD1GFvpiI6UKWdhjRs7AAm5kx2J6jqY1qqw6bH2USSQH-aFhm9jshDyvL5UdTh5K*j*t2j2lhlSIC8SRQjIuRIYZ2aajAdhuTcurQM=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960323&amp;idx=1&amp;sn=e04af14d2ebf939133869e0f18bb0dd1&amp;chksm=bd2d01df8a5a88c98c3cb94a99334a16b372fd997f36bc757a38bb44b70d977797fa840064dc#rd">阅读原文</a>
{% endraw  %}

