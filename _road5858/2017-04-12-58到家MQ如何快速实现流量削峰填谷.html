---
title: 58到家MQ如何快速实现流量削峰填谷
author: 58沈剑
date: '2017-04-12 00:00:00 +0000'

---

{% raw  %}
<p><strong><span style="font-family: 宋体; font-size: 14px;">问：为什么会有本文？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答：上一篇文章《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect">到底什么时候该使用MQ？</a></span><span style="font-size: 14px; font-family: 宋体;">》引起了广泛的讨论，有朋友回复说，</span>MQ<span style="font-size: 14px; font-family: 宋体;">的还有一个<strong>典型应用场景</strong>是<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">缓冲流量，削峰填谷</span>，本文将简单介绍下，</span>MQ<span style="font-size: 14px; font-family: 宋体;">要实现什么细节，才能缓冲流量<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">，削峰填谷</span>。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">问：站点与服务，服务与服务上下游之间，一般如何通讯？</span></strong></p><p><span style="font-family: 宋体; font-size: 14px;">答：有两种常见的方式</span></p><p><img src="/road5858/images/c62276ad6a122398b8f2612c7bf44e1bd9d17102.png" style="width: 123px !important; height: 115px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">一种是“<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">直接调用</span>”，通过</span>RPC<span style="font-size: 14px; font-family: 宋体;">框架，上游直接调用下游。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><img src="/road5858/images/c65df4d60a6b0d313d53f581d01ed5acc8b484a6.png" style="width: 315px !important; height: 111px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">在某些业务场景之下（具体哪些业务场景，见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect">到底什么时候该使用MQ？</a>》），可以采用“</span><span style="font-size: 14px; color: rgb(255, 104, 39);">MQ<span style="font-size: 14px; font-family: 宋体;">推送</span></span><span style="font-size: 14px; font-family: 宋体;">”，上游将消息发给</span>MQ<span style="font-size: 14px; font-family: 宋体;">，</span>MQ<span style="font-size: 14px; font-family: 宋体;">将消息推送给下游。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">问：为什么会有流量冲击？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答：不管采用</span><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">“</span><span style="font-size: 14px; font-family: 宋体;">直接调用</span><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">”</span><span style="font-size: 14px; font-family: 宋体;">还是</span><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">“</span>MQ<span style="font-size: 14px; font-family: 宋体;">推送</span><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">”</span><span style="font-size: 14px; font-family: 宋体;">，都有一个<strong>缺点</strong>，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">下游消息接收方无法控制到达自己的流量，如果调用方不限速，很有可能把下游压垮</span>。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">举个<span style="font-family: 宋体; font-size: 16px;"><strong>栗子</strong></span>，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">秒杀业务</span>：</span></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">上游</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">发起下单操作</span></span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">下游</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">完成秒杀业务逻辑（库存检查，库存冻结，余额检查，余额冻结，订单生成，余额扣减，库存扣减，生成流水，余额解冻，库存解冻）</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">上游下单业务简单，每秒发起了</span>10000<span style="font-size: 14px; font-family: 宋体;">个请求，下游秒杀业务复杂，每秒只能处理</span>2000<span style="font-size: 14px; font-family: 宋体;">个请求，很有可能上游不限速的下单，导致下游系统被压垮，引发雪崩。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">为了避免雪崩，<strong>常见的优化方案</strong>有两种：</span></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">）业务<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">上游队列缓冲，限速发送</span></span></span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">）业务<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">下游队列缓冲，限速执行</span></span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">不管哪种方案，都会引入业务的复杂性，有“缓冲流量”需求的系统都需要加入类似的机制（具体怎么保证消息可达，见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect">消息总线能否实现消息必达？</a>》），正所谓“<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 104, 39);">通用痛点统一解决</span>”，需要一个通用的机制解决这个问题。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">问：如何缓冲流量？</span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答：明明中间有了</span>MQ<span style="font-size: 14px; font-family: 宋体;">，并且</span>MQ<span style="font-size: 14px; font-family: 宋体;">有消息落地的机制，为何不能</span><span style="font-size: 14px; color: rgb(255, 104, 39);"><span style="font-size: 14px; font-family: 宋体;">利用</span>MQ<span style="font-size: 14px; font-family: 宋体;">来做缓冲</span></span><span style="font-size: 14px; font-family: 宋体;">呢？显然是可以的。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">问：</span>MQ<span style="font-size: 14px; font-family: 宋体;">怎么改能缓冲流量？</span></span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答：由</span>MQ-server<span style="font-size: 14px; font-family: 宋体;">推模式，升级为</span><span style="font-size: 14px; color: rgb(255, 104, 39);">MQ-client<span style="font-size: 14px; font-family: 宋体;">拉模式</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><img src="/road5858/images/c9c1e7b12be3966b9e98ad849328185d687ca31c.png" style="width: 320px !important; height: 114px !important;"></p><p><span style="font-size: 14px;">MQ-client<span style="font-size: 14px; font-family: 宋体;">根据自己的处理能力，<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">每隔一定时间</span>，或者<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">每次拉取若干条消息</span>，实施<strong>流控</strong>，达到<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">保护自身</span>的效果。并且这是</span>MQ<span style="font-size: 14px; font-family: 宋体;">提供的通用功能，无需上下游修改代码。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">问：如果上游发送流量过大，</span>MQ<span style="font-size: 14px; font-family: 宋体;">提供拉模式确实可以起到下游自我保护的作用，会不会导致消息在</span>MQ<span style="font-size: 14px; font-family: 宋体;">中堆积？</span></span></strong></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">答：下游</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">拉取消息，消息接收方能够批量获取消息，需要<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">下游消息接收方进行优化，方能够提升整体吞吐量</span>，例如：批量写。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">结论</span></strong></p><p><span style="font-size: 14px;">1<span style="font-size: 14px; font-family: 宋体;">）</span>MQ-client<span style="font-size: 14px; font-family: 宋体;">提供<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">拉模式</span>，定时或者批量拉取，可以起到削平流量，下游自我保护的作用（</span>MQ<span style="font-size: 14px; font-family: 宋体;">需要做的）</span></span></p><p><span style="font-size: 14px;">2<span style="font-size: 14px; font-family: 宋体;">）要想提升整体吞吐量，需要下游优化，例如批量处理等方式（消息接收方需要做的）</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">58到家架构优化具备<strong>整体性</strong>，需要<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">通用服务</span>和<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 104, 39);">业务方</span>一起优化升级。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"></span></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">==【完】==</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">相关阅读：</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect"><span style="font-size: 14px; line-height: 25.6px; white-space: normal; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; color: rgb(0, 102, 204); font-family: Calibri; background-color: rgb(255, 255, 255);">到底什么时候使用MQ</span></a>》</span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">《</span><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959961&amp;idx=1&amp;sn=afec02c8dc6db9445ce40821b5336736&amp;chksm=bd2d07458a5a8e5314560620c240b1c4cf3bbf801fc0ab524bd5e8aa8b8ef036cf755d7eb0f6&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(0, 102, 204); font-family: Calibri; box-sizing: border-box !important; word-wrap: break-word !important;">MQ</span><span style="max-width: 100%; color: rgb(0, 102, 204); font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">如何实现延时消息</span></a><span style="max-width: 100%; font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">》</span></span></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">《</span><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959966&amp;idx=1&amp;sn=068a2866dcc49335d613d75c4a5d1b17&amp;chksm=bd2d07428a5a8e54162ad8ea8e1e9302dfaeb664cecc453bd16a5f299820755bd2e1e0e17b60&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(0, 102, 204); font-family: Calibri; box-sizing: border-box !important; word-wrap: break-word !important;">MQ</span><span style="max-width: 100%; color: rgb(0, 102, 204); font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">如何实现消息必达</span></a><span style="max-width: 100%; font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">》</span></span></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; line-height: 25.6px; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: 宋体; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">《</span><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960002&amp;idx=1&amp;sn=c0775231bccf002c3178eabe43f1cdcb&amp;chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960002&amp;idx=1&amp;sn=c0775231bccf002c3178eabe43f1cdcb&amp;chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(0, 102, 204); font-family: Calibri; box-sizing: border-box !important; word-wrap: break-word !important;">MQ</span><span style="max-width: 100%; color: rgb(0, 102, 204); font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">如何实现幂等性</span></a><span style="max-width: 100%; font-family: 宋体; box-sizing: border-box !important; word-wrap: break-word !important;">》</span></span></span></p>
{% endraw  %}

