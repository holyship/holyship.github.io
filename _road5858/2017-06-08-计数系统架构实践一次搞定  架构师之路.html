---
title: 计数系统架构实践一次搞定 | 架构师之路
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1497276648&src=3&ver=1&signature=aHg31JU*BGTH2xoiR2ftYtT1lp65Ct9IFCcpgHI8heQXWucOsCMClGdUCACo*fN*SxWDJC5shik-jE9Pca*I9VTSsaAEoEky27e*ObrkgNTzBrRDo0BcrAryndhBpecwlM3pxH8BTjYpT1mQylz-jNV8VuTVqZasWuO9ui4kej8=
date: '2017-06-08 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-family: 宋体; font-size: 14px;">提醒，本文较长，可提前收藏/转发。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">一、需求缘起</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">很多业务都有“计数”需求，以微博为例：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VGb1icKvLEQBciahu6vJibSODxWkKuh5CQcAJVzfibGRWhvdJmHUFB3vibEQ/0?wx_fmt=png" style="width: 222px !important; height: 156px !important; visibility: visible !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">微博首页的<strong>个人中心</strong>部分，有三个重要的计数：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; font-family: 宋体;">关注了多少人的计数</span></p></li><li><p><span style="font-size: 14px; font-family: 宋体;">粉丝的计数</span></p></li><li><p><span style="font-size: 14px; font-family: 宋体;">发布博文的计数</span></p><p><span style="font-size: 14px; font-family: 宋体;"></span></p></li></ul><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6Vf7TUCUsKEEiaSuqW9PagtZicyqib1kQpchIGXD3icM1PD0ay1wqmEuQ5dA/0?wx_fmt=png" style="line-height: 1.6; width: 688px !important; height: 373px !important; visibility: visible !important;"><br></p><p><span style="font-family: 宋体; font-size: 14px;">微博首页的<strong>博文消息主体</strong>部分，也有有很多计数，分别是一条博文的：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; font-family: 宋体;">转发计数</span></p></li><li><p><span style="font-size: 14px; font-family: 宋体;">评论计数</span></p></li><li><p><span style="font-size: 14px; font-family: 宋体;">点赞计数</span></p></li><li><p><span style="font-size: 14px; font-family: 宋体;">甚至是浏览计数</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">在<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">业务复杂，计数扩展频繁，数据量大，并发量大</span>的情况下，<strong>计数系统的架构演进与实践</strong>，是本文将要讨论的问题。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">二、业务分析与计数初步实现</span></strong></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VST0bKKpBtMNhg3MgibuPOI3svDNb29udLE1ia7t70Z5HqTDm9U8CsF7g/0?wx_fmt=png" style="width: 143px !important; height: 187px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">典型的互联网架构，常常分为这么几层：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">调用层：处于端上的</span>browser<span style="font-size: 14px; font-family: 宋体;">或者</span>APP</span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">站点层：拼装</span>html<span style="font-size: 14px; font-family: 宋体;">或者</span>json<span style="font-size: 14px; font-family: 宋体;">返回的</span>web-server<span style="font-size: 14px; font-family: 宋体;">层</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">服务层：提供</span>RPC<span style="font-size: 14px; font-family: 宋体;">调用接口的</span>service<span style="font-size: 14px; font-family: 宋体;">层</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">数据层：提供固化数据存储的</span>db<span style="font-size: 14px; font-family: 宋体;">，以及加速存储的</span>cache</span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">针对“缘起”里微博计数的例子，主要涉及“关注”业务，“粉丝”业务，“微博消息”业务，一般来说，会有相应的</span>db<span style="font-size: 14px; font-family: 宋体;">存储相关数据，相应的</span>service<span style="font-size: 14px; font-family: 宋体;">提供相关业务的</span>RPC<span style="font-size: 14px; font-family: 宋体;">接口：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6V18UX0t0Ey0g2NDUtFD9rPkLia0pQYHA3w3Le0UU3pnh3mbTwdESyJOw/0?wx_fmt=png" style="width: 679px !important; height: 231px !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">关注服务：提供关注数据的增删查改</span>RPC<span style="font-size: 14px; font-family: 宋体;">接口</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">粉丝服务：提供粉丝数据的增删查改</span>RPC<span style="font-size: 14px; font-family: 宋体;">接口</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">消息服务：提供微博消息数据的增删查改</span>RPC<span style="font-size: 14px; font-family: 宋体;">接口，消息业务相对比较复杂，涉及微博消息、转发、评论、点赞等数据的存储</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">对关注、粉丝、微博业务进行了初步解析，<strong>那首页的计数需求应该如何满足呢？</strong></span></p><p><span style="font-family: 宋体; font-size: 14px;"><strong><br></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">很容易想到，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">关注服务</span>+<span style="font-size: 14px; font-family: 宋体;">粉丝服务</span>+<span style="font-size: 14px; font-family: 宋体;">消息服务均提供相应接口，就能拿到相关计数数据</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VYcKyIicWgvDwkfbdghkeBYuzxVdmO4P1ebjRA7zWGPoBTYegpPN14jw/0?wx_fmt=png" style="width: 688px !important; height: 362px !important;"><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">例如，个人中心首页，需要展现博文数量这个计数，</span><span style="font-size: 14px; line-height: 1.6;">web</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">层访问</span><span style="font-size: 14px; line-height: 1.6;">message-service</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">的</span><span style="font-size: 14px; line-height: 1.6;">count</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">接口，这个接口执行：</span></p><p><span style="font-size: 12px;">select count(*) from t_msg where uid = XXX</span><span style="font-size: 14px;"> </span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VGb1icKvLEQBciahu6vJibSODxWkKuh5CQcAJVzfibGRWhvdJmHUFB3vibEQ/0?wx_fmt=png" style="width: 222px !important; height: 156px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">同理，也很容易拿到关注，粉丝的这些计数。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这个方案叫做</span><strong>“count”<span style="font-size: 14px; font-family: 宋体;">计数法</span></strong><span style="font-size: 14px; font-family: 宋体;">，在数据量并发量不大的情况下，最容易想到且最经常使用的就是这种方法，但随着数据量的上升，并发量的上升，这个方法的弊端将逐步展现。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">例如，微博首页有很多条微博消息，每条消息有若干计数，此时计数的拉取就成了一个庞大的工程：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VZkTwaw115b3sLJX70bK7nSNRF9MSibWIAicmxkW3ccdCwYLhHtAarHkw/0?wx_fmt=png" style="width: 593px !important; height: 412px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">整个拉取计数的伪代码如下：</span></p><p><span style="font-size: 12px;">list&lt;msg_id&gt; = getHomePageMsg(uid);// <span style="font-family: 宋体;">获取首页所有消息</span></span></p><p><span style="font-size: 12px;">for( msg_id in list&lt;msg_id&gt;){ // <span style="font-family: 宋体; font-size: 12px;">对每一条消息</span></span></p><p><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getReadCount(msg_id);&nbsp; // <span style="font-family: 宋体; font-size: 12px;">阅读计数</span></span></p><p><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getForwordCount(msg_id); // <span style="font-family: 宋体; font-size: 12px;">转发计数</span></span></p><p><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getCommentCount(msg_id); // <span style="font-family: 宋体; font-size: 12px;">评论计数</span></span></p><p><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getPraiseCount(msg_id); // <span style="font-family: 宋体; font-size: 12px;">赞计数</span></span></p><p><span style="font-size: 12px;">}</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">其中：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">每一个微博消息的若干个计数，都对应</span>4<span style="font-size: 14px; font-family: 宋体;">个后端服务访问</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">每一个访问，对应一条</span>count<span style="font-size: 14px; font-family: 宋体;">的数据库访问（</span>count<span style="font-size: 14px; font-family: 宋体;">要了老命了）</span></span></p></li></ul><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">其效率之低，资源消耗之大，处理时间之长，可想而知。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;"><strong style="font-size: 14px; line-height: 22.4px; white-space: normal;">“count”<span style="font-family: 宋体;">计数法</span></strong>方案，可以总结为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">多条消息多次查询，</span>for<span style="font-size: 14px; font-family: 宋体;">循环进行</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">一条消息多次查询，多个计数的查询</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">一次查询一个</span>count<span style="font-size: 14px; font-family: 宋体;">，每个计数都是一个</span>count<span style="font-size: 14px; font-family: 宋体;">语句</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">那如何进行优化呢？</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">三、计数外置的架构设计</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">计数是一个通用的需求，有没有可能，这个计数的需求<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">实现在一个通用的系统里</span>，而不是由关注服务、粉丝服务、微博服务来分别来提供相应的功能呢（否则扩展性极差）？</span></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">这样需要实现一个通用的计数服务。</span></strong></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">通过分析，上述微博的业务可以抽象成两类：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">用户(</span>uid<span style="font-size: 14px; font-family: 宋体;">)<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">维度</span></span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;"></span>的计数：用户的关注计数，粉丝计数，发布的微博计数</span></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">微博消息(</span>msg_id<span style="font-size: 14px; font-family: 宋体;">)维度</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">的计数：消息转发计数，评论计数，点赞计数</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">于是可以<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">抽象出两个表，针对这两个维度来进行计数的存储</span>：</span></p><p><strong><span style="font-size: 12px;">t_user_count</span></strong><span style="font-size: 12px;"> (uid, gz_count, fs_count, wb_count);</span></p><p><strong><span style="font-size: 12px;">t_msg_count</span></strong><span style="font-size: 12px;"> (msg_id, forword_count, comment_count, praise_count);</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">甚至可以更为抽象，一个表搞定所有计数：</span></p><p><span style="font-size: 12px;">t_count(id, type, c1, c2, c3, …)</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span>type<span style="font-size: 14px; font-family: 宋体;">来判断，</span>id<span style="font-size: 14px; font-family: 宋体;">究竟是</span>uid<span style="font-size: 14px; font-family: 宋体;">还是</span>msg_id<span style="font-size: 14px; font-family: 宋体;">，但并不建议这么做。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">存储抽象完，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">再抽象出一个计数服务对这些数据进行管理，提供友善的</span>RPC<span style="font-size: 14px; font-family: 宋体;">接口</span></span><span style="font-size: 14px; font-family: 宋体;">：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6V7mGTCyQdaccPciccAaDQc2x6xViaCTQicoYBlGicnBmc9nmBQ7AokhZF4w/0?wx_fmt=png" style="width: 403px !important; height: 125px !important;"></p><p><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">这样，在查询一条微博消息的若干个计数的时候，</span><span style="color: rgb(255, 76, 0);"><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">不用进行多次数据库</span><span style="font-size: 14px; line-height: 1.6;">count</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">操作，而会转变为一条数据的多个属性的查询</span></span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">：</span></p><p><span style="font-size: 12px;">for(msg_id in list&lt;msg_id&gt;) {</span></p><p><span style="font-size: 12px;">select forword_count, comment_count, praise_count&nbsp;</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; from t_msg_count&nbsp;</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; where msg_id=$msg_id;</span></p><p><span style="font-size: 12px;">}</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">甚至，可以将微博首页所有消息的计数，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">转变为一条</span>IN<span style="font-size: 14px; font-family: 宋体;">语句</span></span><span style="font-size: 14px; font-family: 宋体;">（不用多次查询了）的批量查询：</span></span></p><p><span style="font-size: 12px;">select * from t_msg_count&nbsp;</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; where msg_id IN</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; ($msg_id1, $msg_id2, $msg_id3, …);</span></p><p><strong><span style="font-size: 14px;">IN<span style="font-size: 14px; font-family: 宋体;">查询可以命中</span>msg_id<span style="font-size: 14px; font-family: 宋体;">聚集索引</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，效率很高。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">方案非常帅气，接下来，问题转化为：<strong>当有微博被转发、评论、点赞的时候，计数服务如何同步的进行计数的变更呢？</strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果让业务服务</span><span style="font-size: 14px; font-family: 宋体;">来调用计数服务，势必会导致业务系统与计数系统耦合。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">之前的文章介绍过，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">对于不关心下游结果的业务，可以使用</span>MQ<span style="font-size: 14px; font-family: 宋体;">来解耦<span style="font-family: 宋体; font-size: 14px; line-height: 22.4px; color: rgb(0, 0, 0);">（具体请查阅《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect" target="_blank">到底什么时候该使用MQ？</a>》）</span></span></span><span style="font-size: 14px; font-family: 宋体;">，在业务发生变化的时候，向</span>MQ<span style="font-size: 14px; font-family: 宋体;">发送一条异步消息，通知计数系统计数发生了变化即可：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VSibc2CzleWuPElIYWICKvPzLlMJjAXzNWSib6Up9AxgRct9zmlXMTDzQ/0?wx_fmt=png" style="width: 770px !important; height: 358.761px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">如上图：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px; font-family: 宋体;">用户新发布了一条微博</span></p></li><li><p><span style="font-size: 14px;">msg-service<span style="font-size: 14px; font-family: 宋体;">向</span>MQ<span style="font-size: 14px; font-family: 宋体;">发送一条消息</span></span></p></li><li><p><span style="font-size: 14px;">counting-service<span style="font-size: 14px; font-family: 宋体;">从</span>MQ<span style="font-size: 14px; font-family: 宋体;">接收消息</span></span></p></li><li><p><span style="font-size: 14px;">counting-service<span style="font-size: 14px; font-family: 宋体;">变更这个</span>uid<span style="font-size: 14px; font-family: 宋体;">发布微博消息计数</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这个方案称为</span><strong>“<span style="font-size: 14px; font-family: 宋体;">计数外置</span>”</strong><span style="font-size: 14px; font-family: 宋体;">，可以总结为：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">通过</span>counting-service<span style="font-size: 14px; font-family: 宋体;">单独保存计数</span></span></p></li><li><p><span style="font-size: 14px;">MQ<span style="font-size: 14px; font-family: 宋体;">同步计数的变更</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">多条消息的多个计数，一个批量</span>IN<span style="font-size: 14px; font-family: 宋体;">查询完成</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">计数外置</span></strong><span style="font-family: 宋体; font-size: 14px;">，<strong>本质是数据的冗余</strong>，架构设计上，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">数据冗余必将引发数据的一致性问题</span>，需要有机制来保证计数系统里的数据与业务系统里的数据一致，常见的方法有：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">对于一致性要求比较高的业务，要有定期</span>check<span style="font-size: 14px; font-family: 宋体;">并</span>fix<span style="font-size: 14px; font-family: 宋体;">的机制，例如关注计数，粉丝计数，微博消息计数等</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">对于一致性要求比较低的业务，即使有数据不一致，业务可以接受，例如微博浏览数，微博转发数等</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">四、计数外置缓存优化</span></strong></span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">计数外置很大程度上解决了计数存取的性能问题，但是否还有优化空间呢？</span></strong></p><p><span style="font-family: 宋体; font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">像关注计数，粉丝计数，微博消息计数，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">变化的频率很低，查询的频率很高，这类读多些少的业务场景</span>，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">非常适合使用<strong>缓存</strong>来进行查询优化</span>，减少数据库的查询次数，降低数据库的压力。</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">但是，缓存是</span>kv<span style="font-size: 14px; font-family: 宋体;">结构的，无法像数据库一样，设置成</span>t_uid_count(uid, c1, c2, c3)<span style="font-size: 14px; font-family: 宋体;">这样的</span>schema<span style="font-size: 14px; font-family: 宋体;">，</span><strong><span style="font-size: 14px; font-family: 宋体;">如何来对</span>kv<span style="font-size: 14px; font-family: 宋体;">进行设计呢？</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">缓存</span>kv<span style="font-size: 14px; font-family: 宋体;">结构的</span><span style="font-size: 14px; color: rgb(255, 76, 0);">value<span style="font-size: 14px; font-family: 宋体;">是计数</span></span><span style="font-size: 14px; font-family: 宋体;">，看来只能在</span>key<span style="font-size: 14px; font-family: 宋体;">上做设计，很容易想到，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">可以使用</span>uid:type<span style="font-size: 14px; font-family: 宋体;">来做</span>key</span><span style="font-size: 14px; font-family: 宋体;">，存储对应</span>type<span style="font-size: 14px; font-family: 宋体;">的计数。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">对于</span>uid=123<span style="font-size: 14px; font-family: 宋体;">的用户，其关注计数，粉丝计数，微博消息计数的缓存就可以设计为：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VRibOj1XuUUIiaicAvBeVvCNtu3hn4BUBR5ygtfiaciccqtU5lhSkfq13RgA/0?wx_fmt=png" style="width: 212px !important; height: 95px !important;"></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">此时对应的</span>counting-service<span style="font-size: 14px; font-family: 宋体;">架构变为：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VjbrOM0p2we3tkMr0SUdG5XQ5zbMgoicGiaeQ6vjn5E6cjRxRv45nr0xw/0?wx_fmt=png" style="width: 376px !important; height: 158px !important;"></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如此这般，多个</span>uid<span style="font-size: 14px; font-family: 宋体;">的多个计数，又<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">可能会变为多次缓存的访问</span>：</span></span></p><p><span style="font-size: 12px;">for(uid in list&lt;uid&gt;) {</span></p><p><span style="font-size: 12px;">&nbsp;memcache::get($uid:c1, $uid:c2, $uid:c3);</span></p><p><span style="font-size: 12px;">}</span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">这个</span><strong>“<span style="font-size: 14px; font-family: 宋体;">计数外置缓存优化</span>”<span style="font-size: 14px; font-family: 宋体;">方案</span></strong><span style="font-size: 14px; font-family: 宋体;">，可以总结为：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">使用缓存来保存读多写少的计数（其实写多读少，一致性要求不高的计数，也可以先用缓存保存，然后定期刷到数据库中，以降低数据库的读写压力）</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">使用</span>id:type<span style="font-size: 14px; font-family: 宋体;">的方式作为缓存的</span>key<span style="font-size: 14px; font-family: 宋体;">，使用</span>count<span style="font-size: 14px; font-family: 宋体;">来作为缓存的</span>value</span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">多次读取缓存来查询多个</span>uid<span style="font-size: 14px; font-family: 宋体;">的计数</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">五、缓存批量读取优化</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">缓存的使用能够极大降低数据库的压力，<strong>但多次缓存交互依旧存在优化空间，有没有办法进一步优化呢？</strong></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">当当当当！</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">不要陷入思维定式，</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">谁说</span>value<span style="font-size: 14px; font-family: 宋体;">一定只能是一个计数，难道不能多个计数存储在一个</span>value<span style="font-size: 14px; font-family: 宋体;">中么？</span></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">缓存</span>kv<span style="font-size: 14px; font-family: 宋体;">结构的</span><span style="font-size: 14px; color: rgb(255, 76, 0);">key<span style="font-size: 14px; font-family: 宋体;">是</span>uid</span><span style="font-size: 14px; font-family: 宋体;">，</span><span style="font-size: 14px; color: rgb(255, 76, 0);">value<span style="font-size: 14px; font-family: 宋体;">可以是多个计数同时存储</span></span><span style="font-size: 14px; font-family: 宋体;">。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">对于</span>uid=123<span style="font-size: 14px; font-family: 宋体;">的用户，其关注计数，粉丝计数，微博消息计数的缓存就可以设计为：</span></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VUhiahPklOpazicF0Nicvqs6ZPHrpkVHuDnfvOFhMo9jByibUXzWRkhBhSA/0?wx_fmt=png" style="width: 225px !important; height: 67px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">这样多个用户，多个计数的查询就可以一次搞定：</span></p><p><span style="font-size: 12px;">memcache::get($uid1, $uid2, $uid3, …);</span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">然后对获取的</span>value<span style="font-size: 14px; font-family: 宋体;">进行分析，得到关注计数，粉丝计数，微博计数。</span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">如果计数value能够事先预估一个范围，甚至可以用一个整数的不同bit来存储多个计数，用整数的与或非计算提高效率。</span></span></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">这个<strong>“计数外置缓存批量优化”方案</strong>，可以总结为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">使用</span>id<span style="font-size: 14px; font-family: 宋体;">作为</span>key<span style="font-size: 14px; font-family: 宋体;">，使用同一个</span>id<span style="font-size: 14px; font-family: 宋体;">的多个计数的拼接作为</span>value</span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">多个</span>id<span style="font-size: 14px; font-family: 宋体;">的多个计数查询，一次搞定</span></span></p></li></ul><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">六、计数扩展性优化</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">考虑完效率，架构设计上还需要考虑<strong>扩展性</strong>，如果</span>uid<span style="font-size: 14px; font-family: 宋体;">除了关注计数，粉丝计数，微博计数，还要<strong>增加一个计数，这时系统需要做什么变更呢？</strong></span></span></p><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;"><br></span></span></p><p><span style="font-family: 宋体; font-size: 14px;">之前的数据库结构是：</span></p><p><span style="font-size: 12px;">t_user_count(uid, gz_count, fs_count, wb_count)</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VZdjfDxlZqicQHlyGAPheGxF8Zzk22MzDlzOJBf1rWuGTwjD9rTEDtKQ/0?wx_fmt=png" style="width: 336px !important; height: 131px !important;"></p><p><span style="font-family: 宋体; font-size: 14px; line-height: 22.4px;">这种设计，</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体; color: rgb(255, 76, 0);">通过列来进行计数的存储</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">，如果增加一个</span><span style="font-size: 14px; line-height: 1.6;">XX</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">计数，数据库的表结构要变更为：</span></p><p><span style="font-size: 12px;">t_user_count(uid, gz_count, fs_count, wb_count, XX_count)</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VYMJk3XAvqyE6iaKhVHFNmQib66BOnpQgnFuOtjEZ6lI2bB0Uax2rUBiaA/0?wx_fmt=png" style="width: 409px !important; height: 135px !important;"></p><p><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">在数据量很大的情况下，</span><strong><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">频繁的变更数据库</span><span style="font-size: 14px; line-height: 1.6;">schema</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">的结构显然是不可取的</span></strong><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">，有没有扩展性更好的方式呢？</span><br></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">当当当当！</span></p><p><span style="font-family: 宋体; font-size: 14px;">不要陷入思维定式，谁说只能通过扩展列来扩展属性，<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">通过扩展行来扩展属性</span>，在“架构师之路”的系列文章里也不是第一次出现了（具体请查阅《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959762&amp;idx=1&amp;sn=f7d8d7648416a0157af6ac61a6b555c8&amp;chksm=bd2d040e8a5a8d181ec1baa2e96982991ddfc218bb6838f38da61b651e4b8de5f0bbbd94f814&amp;scene=21#wechat_redirect" target="_blank">啥，又要为表增加一列属性？</a>》《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959765&amp;idx=1&amp;sn=b9916aa95c320e41035977e0a8098ca6&amp;chksm=bd2d04098a5a8d1f3af38f658c05002151e621170949d2e3bb5b1bceea55c64b0477dba4c647&amp;scene=21#wechat_redirect" target="_blank">这才是真正的表扩展方案</a>》《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959855&amp;idx=1&amp;sn=f33abe8ec598c273f29cebb9365ece59&amp;chksm=bd2d07f38a5a8ee58a944507a134e1da1efc3ac9c4d1c4cff261137cd986e51f5fe7cee9de15&amp;scene=21#wechat_redirect" target="_blank">100亿数据1万属性数据架构设计</a>》），完全可以这样设计表结构：</span></p><p><span style="font-size: 12px;">t_user_count(uid, count_key, count_value)</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6Vx0VW7ibpNSGvazUbYdHBm14Q3HTJCaXwYdqL4oFpuibLflK1JDd7gqMQ/0?wx_fmt=png" style="width: 298px !important; height: 94px !important;"></p><p><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">如果需要新增一个计数</span><span style="font-size: 14px; line-height: 1.6;">XX_count</span><span style="font-size: 14px; line-height: 1.6; font-family: 宋体;">，只需要增加一行即可，而不需要变更表结构：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VwY5uNpDwzibFTnQXvQljR6gy5yLgicuImWqMDFXaMsxeJ8ay0VGm6EoA/0?wx_fmt=png" style="width: 310px !important; height: 102px !important;"></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">七、总结</span></strong></span></p><p><span style="font-family: 宋体; font-size: 14px;">小小的计数，在数据量大，并发量大的时候，其架构实践思路为：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px; font-family: 宋体;">计数外置</span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">：由“</span>count<span style="font-size: 14px; font-family: 宋体;">计数法”升级为<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">“计数外置法”</span></span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">读多写少，甚至写多但一致性要求不高的计数，需要进行<strong>缓存优化</strong>，降低数据库压力</span></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">缓存</span>kv<span style="font-size: 14px; font-family: 宋体;">设计优化</span></span></strong><span style="font-size: 14px;"><span style="font-size: 14px; font-family: 宋体;">，可以</span><span style="font-size: 14px; color: rgb(255, 76, 0);"><span style="font-size: 14px; font-family: 宋体;">由</span>[key:type]-&gt;[count]<span style="font-size: 14px; font-family: 宋体;">，优化为</span>[key]-&gt;[c1:c2:c3]</span></span></p></li></ul><p><span style="font-family: 宋体; font-size: 14px;">即：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VRibOj1XuUUIiaicAvBeVvCNtu3hn4BUBR5ygtfiaciccqtU5lhSkfq13RgA/0?wx_fmt=png" style="width: 212px !important; height: 95px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">优化为：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VUhiahPklOpazicF0Nicvqs6ZPHrpkVHuDnfvOFhMo9jByibUXzWRkhBhSA/0?wx_fmt=png" style="width: 225px !important; height: 67px !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px; font-family: 宋体;">数据库扩展性优化</span></strong><span style="font-size: 14px; font-family: 宋体;">，可以由<span style="font-size: 14px; font-family: 宋体; color: rgb(255, 76, 0);">列扩展优化为行扩展</span></span></p></li></ul><p><span style="font-family: 宋体; font-size: 14px;">即：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6VZdjfDxlZqicQHlyGAPheGxF8Zzk22MzDlzOJBf1rWuGTwjD9rTEDtKQ/0?wx_fmt=png" style="width: 336px !important; height: 131px !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">优化为：</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyhdjRm6mNM9SsHXFZU0z6Vx0VW7ibpNSGvazUbYdHBm14Q3HTJCaXwYdqL4oFpuibLflK1JDd7gqMQ/0?wx_fmt=png" style="width: 298px !important; height: 94px !important;"></p><p><span style="font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">计数系统架构先聊到这里，希望大家有收获。</span></p><p><span style="font-family: 宋体; font-size: 14px;">===【完】===</span></p><p><span style="font-family: 宋体; font-size: 14px;">相关阅读：</span></p><p><span style="font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960012&amp;idx=1&amp;sn=c6af5c79ecead98daa4d742e5ad20ce5&amp;chksm=bd2d07108a5a8e0624ae6ad95001c4efe09d7ba695f2ddb672064805d771f3f84bee8123b8a6&amp;scene=21#wechat_redirect" target="_blank" style="font-family: 宋体; font-size: 14px; line-height: 22.4px; white-space: normal;">到底什么时候该使用MQ？</a></span></p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959762&amp;idx=1&amp;sn=f7d8d7648416a0157af6ac61a6b555c8&amp;chksm=bd2d040e8a5a8d181ec1baa2e96982991ddfc218bb6838f38da61b651e4b8de5f0bbbd94f814&amp;scene=21#wechat_redirect" target="_blank" style="font-family: 宋体; font-size: 14px; line-height: 22.4px; white-space: normal;">啥，又要为表增加一列属性？</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959765&amp;idx=1&amp;sn=b9916aa95c320e41035977e0a8098ca6&amp;chksm=bd2d04098a5a8d1f3af38f658c05002151e621170949d2e3bb5b1bceea55c64b0477dba4c647&amp;scene=21#wechat_redirect" target="_blank" style="font-family: 宋体; font-size: 14px; line-height: 22.4px; white-space: normal;">这才是真正的表扩展方案</a></p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959855&amp;idx=1&amp;sn=f33abe8ec598c273f29cebb9365ece59&amp;chksm=bd2d07f38a5a8ee58a944507a134e1da1efc3ac9c4d1c4cff261137cd986e51f5fe7cee9de15&amp;scene=21#wechat_redirect" target="_blank" style="font-family: 宋体; font-size: 14px; line-height: 22.4px; white-space: normal;">100亿数据1万属性数据架构设计</a></p><p><span style="font-size: 14px;"><br></span></p><p><span style="font-family: 宋体; font-size: 14px;">本文值得读第二遍，值得<span style="font-family: 宋体; font-size: 14px; color: rgb(255, 76, 0);">转发</span>，谢谢。</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1497276648&src=3&ver=1&signature=aHg31JU*BGTH2xoiR2ftYtT1lp65Ct9IFCcpgHI8heQXWucOsCMClGdUCACo*fN*SxWDJC5shik-jE9Pca*I9VTSsaAEoEky27e*ObrkgNTzBrRDo0BcrAryndhBpecwlM3pxH8BTjYpT1mQylz-jNV8VuTVqZasWuO9ui4kej8=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959886&amp;idx=1&amp;sn=03e45a5014053607eff5e55ed2c660d7&amp;chksm=bd2d07928a5a8e8454d395e176fa9d346682abfe9dfbf3244f1dead83ee4508aa25121f9b811#rd">阅读原文</a>
{% endraw  %}

