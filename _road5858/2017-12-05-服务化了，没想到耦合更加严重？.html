---
title: 服务化了，没想到耦合更加严重？
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-5bnMFuhd4doDEPpoFsls3oFEIXN45CW-2S1yNHjZNqHO9otUfrcPbkc8kYadUABdL9UDuZk5kzRNXoCtx4sSvg=
date: '2017-12-05 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;letter-spacing: 1px;">通过“库”来实现业务，可能会引发业务系统之间耦合，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">需要通用业务服务化</span>，将通用业务下沉，详见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960650&amp;idx=1&amp;sn=7c63fdc50a130e1d9fc3e5b6791ce01f&amp;chksm=bd2d00968a5a89801861bd1665ad60fe240b5ff3d6eab984e70938d9cfd6502aca8de5686e0c&amp;scene=21#wechat_redirect" target="_blank">小小的公共库，大大的耦合，你痛过吗</a>》。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">通过“join”来实现业务，可能会导致数据库之间耦合，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">需要基础数据服务化</span>，实现数据库私有化，解除数据库之间的耦合，详见《<a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960667&amp;idx=1&amp;sn=850cc7370b7fe3fec43878e39baadb2b&amp;chksm=bd2d00878a5a89917bf55546a0c1b44523190679849953cfcc94c886bc5b77ad136006b448f1&amp;scene=21#wechat_redirect" target="_blank">小小的数据库，大大的耦合，你通过吗</a>》。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">但如果服务化不合理，将部分个性化业务下沉到了底层，耦合与瓶颈会更加严重</span></strong></span><span style="font-size: 14px;letter-spacing: 1px;">。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">场景还原</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">业务1，业务2，业务3，因为join导致数据库实例耦合在了一起。</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyoofzdxSQdWuw7ThuArMr3on5TTwvJy2YLqLhiaYu2yYNkoFsHJU5eqv0xAwbdbWturusPQX4ib61w/0?wx_fmt=png" style="width: 555px !important; height: 270px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;"><br></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">为了实现通用数据库table-user的解耦，实施了服务化，将通用user数据的访问抽象出了服务。</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyoofzdxSQdWuw7ThuArMr3ic8KTl5UJPoxmA4b3lcAiag9m7DQ3Az3IUvlLYJ7c3dsUYePibwhGQCeQ/0?wx_fmt=png" style="width: 555px !important; height: 214px !important; visibility: visible !important;"></p><p><br></p><p><span style="font-size: 14px;letter-spacing: 1px;">由于服务化不合理，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">会有很少很少的个性化业务逻辑，实现在底层的服务中</span>，典型的伪代码是：</span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="letter-spacing: 1px;font-size: 12px;">switch(biz_type){</span></em></span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="color: rgb(0, 82, 255);letter-spacing: 1px;font-size: 12px;">&nbsp;case(1) : exec_logic1();</span></em></span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="color: rgb(0, 82, 255);letter-spacing: 1px;font-size: 12px;">&nbsp;case(2) : exec_logic2();</span></em></span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="color: rgb(0, 82, 255);letter-spacing: 1px;font-size: 12px;">&nbsp;case(3) : exec_logic3();</span></em></span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="color: rgb(0, 82, 255);letter-spacing: 1px;font-size: 12px;">&nbsp;default : exec_default();</span></em></span></p><p><span style="color: rgb(0, 82, 255);"><em><span style="color: rgb(0, 82, 255);letter-spacing: 1px;font-size: 12px;">}</span></em></span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">为什么会引发耦合呢？</span></strong></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyoofzdxSQdWuw7ThuArMr3KzPSlF7CuGSvdbXiabafM1OibccxJdX2P8Nzy8khfdgohuQaRpYGe4Ew/0?wx_fmt=png" style="width: 770px !important; height: 380.845px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">不妨设，业务1来了一个新的<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">个性化需求</span>，这个需求本来实现在业务1自己的代码里是合理的，但工程师S想到，底层的通用服务里也有业务1的一小撮个性化代码，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">评估后，发现实现在底层新的需求改动的代码最小，时间最短</span>，于是来找底层服务的负责人工程师B。</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务1工程师S</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：“有个小需求，帮个忙呗”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">底层工程师B</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：“个性化实现在底层不合理”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务1工程师S</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：“反正都有switch case的代码了，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">再改一点也不麻烦，在我这边实现特别复杂</span>，要xxoo这么搞”</span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">底层工程师B</span></strong><span style="font-size: 14px;letter-spacing: 1px;">：“确实很复杂，那我来吧”</span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">…</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">遗留了不合理的代码，就会有第一次妥协，妥协了业务1，就会妥协业务2，随着时间的推移，<strong>底层服务越来越复杂</strong>：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;letter-spacing: 1px;">业务1，业务2，业务3的<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">个性化代码越来越多</span></span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;">业务1，业务2，业务3的<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">需求越来越多提给底层工程师</span></span></p></li><li><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">底层工程师慢慢成了项目瓶颈</span><span style="font-size: 14px;letter-spacing: 1px;">，业务1，业务2，业务3的项目逐步delay，但逐步都怪到了底层工程师的头上</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">直到有一天，<strong>底层服务出了一个小bug，影响了业务1，业务2，业务3</strong>，历史总是惊人的相似：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务1的大boss</span></strong><span style="font-size: 14px;letter-spacing: 1px;">在群里首先发飙：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">技术都干啥了，怎么系统挂了</span>” </span></p></li><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">业务1的工程师S</span></strong><span style="font-size: 14px;letter-spacing: 1px;">一脸无辜：“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">底层系统改造，工程师S的bug</span>”</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">额，然而，这个理由，好像在大boss那解释不通…</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;letter-spacing: 1px;">底层服务工程师B</span></strong><span style="font-size: 14px;letter-spacing: 1px;">一脸委屈：<span style="font-size: 14px;letter-spacing: 1px;">“...”<span style="font-size: 14px;letter-spacing: 1px;">。</span></span></span><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">明明需求是业务方的，为什么修改代码的是我底层呢，业务代码出了问题，为什么责怪的是我底层呢</span><span style="font-size: 14px;letter-spacing: 1px;">，每每心中骂娘，系统中很可能就存在耦合。</span></p></li></ul><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">如何解耦呢？</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">业务代码上浮，通用代码下沉，服务化彻底</span><span style="font-size: 14px;letter-spacing: 1px;">。</span></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/YrezxckhYOyoofzdxSQdWuw7ThuArMr3LPNAgNBmGSlH8iaxJUB7K3gev6J7ruCFLtgBOJKfTjtXMxDd9GP0m8Q/0?wx_fmt=png" style="width: 555px !important; height: 244px !important;"></p><p><span style="font-size: 14px;letter-spacing: 1px;">解决方案并不复杂，分层架构中，<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">每一层都有自己的职责，每一层都应该守住自己的底线</span>。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;">启示</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">一、讨论技术方案时，不要总以：</span></p><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">“放在你那边做代码少”</span></p><p><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">“放在你那边做时间短”</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">作为设计折衷的理由，而要多问：</span></p><p><strong><span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">“怎么做合理”</span></strong></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">二、尽量杜绝底层出现switch case(biz_type)走不同分支的代码。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 16px;"><strong><span style="letter-spacing: 1px;">业务代码上浮，通用代码下沉，服务化彻底</span></strong></span><span style="font-size: 14px;letter-spacing: 1px;">，只是一个很小的优化点，但对于<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">底层服务解耦</span>却是非常的有效。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">&nbsp;</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">希望大家每天收获一点点，这样架构就能美好一点点。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;">你痛过吗，你被反问过“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">你实现代价小，你来搞</span>”吗？你被迫实现过“<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">switch case</span>”吗？那帮<span style="font-size: 14px;letter-spacing: 1px;color: rgb(255, 76, 0);">转</span>下。</span></p><p><span style="font-size: 14px;letter-spacing: 1px;"></span></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 14px;letter-spacing: 1px;box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></span></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 14px;letter-spacing: 1px;box-sizing: border-box !important;word-wrap: break-word !important;">相关文章：</span></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960667&amp;idx=1&amp;sn=850cc7370b7fe3fec43878e39baadb2b&amp;chksm=bd2d00878a5a89917bf55546a0c1b44523190679849953cfcc94c886bc5b77ad136006b448f1&amp;scene=21#wechat_redirect" target="_blank"><span style="max-width: 100%;font-size: 14px;letter-spacing: 1px;box-sizing: border-box !important;word-wrap: break-word !important;">小小的数据库，大大的耦合，你痛过吗？</span></a></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 14px;letter-spacing: 1px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960643&amp;idx=1&amp;sn=adb2660bc1a367e118d0a3a799a312fa&amp;chksm=bd2d009f8a5a898917ebe65caf0dc31d3f257594d5c18a468ebef344877b64e989ee292bf22e&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">小小的IP，大大的耦合，你痛过吗？</a><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></span></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);font-size: 16px;white-space: normal;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 14px;letter-spacing: 1px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960650&amp;idx=1&amp;sn=7c63fdc50a130e1d9fc3e5b6791ce01f&amp;chksm=bd2d00968a5a89801861bd1665ad60fe240b5ff3d6eab984e70938d9cfd6502aca8de5686e0c&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">小小的公共库，大大的耦合，你痛过吗？</a></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512886848&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKD4mxxcCZBqQCpMqS7HCyNBsct4LhNg8ttyk4jAVZh144v2Qu0nvlRoytzz4ujea-5bnMFuhd4doDEPpoFsls3oFEIXN45CW-2S1yNHjZNqHO9otUfrcPbkc8kYadUABdL9UDuZk5kzRNXoCtx4sSvg=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960682&amp;idx=1&amp;sn=ec925e0ebbf4c901590b7c4279676f88&amp;chksm=bd2d00b68a5a89a0c66e8e48fdd0da3ceacb454c1ebb672bbab15a25c42234909072b6e481ef#rd">阅读原文</a>
{% endraw  %}

