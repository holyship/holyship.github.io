---
title: DNS在架构设计中的巧用
author: 58沈剑
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1495452139&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeW-T5kTNB0lmNIDfirdmdp3IhNxo89xisNdP56ZXTe4KJtg9Glou1t4ppqeRe4PZrUuV6abjPM1txwB6XseHhOTEg85LY4-3x3JQDVAyILVkBaVlRzhXsJv-TXnfxyhoqlZT*gUruQMGIiJAsKeUQCg=
date: '2017-05-17 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 14px;"><strong><span style="font-family: 宋体;"></span></strong></span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">一、缘起</span></strong></span><br></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">一个</span><span style="font-family: Calibri; font-size: 14px;">http</span><span style="font-family: 宋体; font-size: 14px;">请求从客户端到服务端，整个执行流程是怎么样的呢？</span></span></strong></p><p><img src="/road5858/images/bcf63d2749e8aca4e552c40dfcbb8b292847a2a8.png" style="width: 391px !important; height: 182px !important; visibility: visible !important;"></p><p><span style="font-family: 宋体; font-size: 14px;">一个典型流程如上：</span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(1)</span><span style="font-family: 宋体; font-size: 14px;">客户端通过域名</span><span style="font-family: Calibri; font-size: 14px;">daojia.com</span><span style="font-family: 宋体; font-size: 14px;">请求</span><span style="font-family: Calibri; font-size: 14px;">dns-server</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(2)dns-server</span><span style="font-family: 宋体; font-size: 14px;">返回域名对应的外网</span><span style="font-family: Calibri; font-size: 14px;">ip(1.2.3.4)</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(3)</span><span style="font-family: 宋体; font-size: 14px;">客户端访问外网</span><span style="font-family: Calibri; font-size: 14px;">ip(1.2.3.4)</span><span style="font-family: 宋体; font-size: 14px;">向反向代理</span><span style="font-family: Calibri; font-size: 14px;">nginx</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(4)</span><span style="font-family: 宋体; font-size: 14px;">反向代理</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">配置了多个<span style="font-family: 宋体; font-size: 14px;">后端</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">服务</span>内网</span><span style="font-family: Calibri; font-size: 14px;">ip(192.168.0.1/192.168.0.2)</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(5)</span><span style="font-family: 宋体; font-size: 14px;">请求最终落到某一个</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">进行处理</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">其中，第一个步骤域名</span><span style="font-family: Calibri; font-size: 14px;">daojia.com</span><span style="font-family: 宋体; font-size: 14px;">到外网</span><span style="font-family: Calibri; font-size: 14px;">ip(1.2.3.4)</span><span style="font-family: 宋体; font-size: 14px;">的转换，发生在整个服务端外部，服务端不可控。</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;"><br></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">架构设计时，能够巧用</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">做一些什么事情呢，是本文要讨论的问题。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">二、</span><span style="font-family: Calibri;">反向代理</span></strong><strong><span style="font-family: 宋体;">水平扩展</span></strong></span></p><p><img src="/road5858/images/bcf63d2749e8aca4e552c40dfcbb8b292847a2a8.png" style="width: 391px !important; height: 182px !important; visibility: visible !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">典型的互联网架构中，可以通过增加</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">来扩充</span><span style="font-family: Calibri; font-size: 14px;">web</span><span style="font-family: 宋体; font-size: 14px;">层的性能，但</span><strong><span style="font-family: 宋体; font-size: 14px;">反向代理</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">仍是整个系统的唯一入口</span></strong><span style="font-family: 宋体; font-size: 14px;">，</span><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如果系统吞吐超过</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">的性能极限，难以扩容</span></span><span style="font-family: 宋体; font-size: 14px;">，此时就需要</span><span style="font-family: Calibri; font-size: 14px;">dns-server</span><span style="font-family: 宋体; font-size: 14px;">来配合</span><span style="font-family: 宋体; font-size: 14px;">水平扩展。</span></span></p><p><br></p><p><img src="/road5858/images/a421432592051d7ce758bf24547909ef917d2356.png" style="width: 500px !important; height: 202px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">具体做法是：在</span><span style="font-family: Calibri; font-size: 14px;">dns-server</span><span style="font-family: 宋体; font-size: 14px;">对于同一个域名可以配置多个</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">的外网</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">每次</span><span style="font-family: Calibri; font-size: 14px;">dns解析</span><span style="font-family: 宋体; font-size: 14px;">请求，轮询返回不同的</span><span style="font-family: Calibri; font-size: 14px;">ip</span></span><span style="font-family: 宋体; font-size: 14px;">，这样就能实现</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">的水平扩展，这个方法叫“</span><strong><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">轮询</span></strong><span style="font-family: 宋体; font-size: 14px;">”。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">三、</span><span style="font-family: Calibri;">web-server</span></strong><strong><span style="font-family: 宋体;">负载均衡</span></strong></span></p><p><img src="/road5858/images/70390f8c6d7c94f7ea6fe1fcf993ed91e7667547.png" style="width: 417px !important; height: 127px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">既然“</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">轮询”可以将同一个域名的流量均匀分配到不同的</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">，那么也可以利用它来做</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">的负载均衡：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">(1)架构中</span><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">去掉</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">层</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">(2)将多个</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">的</span><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">内网</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">直接改为外网</span><span style="font-family: Calibri; font-size: 14px;">ip</span></span></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">(3)在</span><span style="font-family: Calibri; font-size: 14px;">dns<span style="font-family:Calibri">-server</span></span><span style="font-family: 宋体; font-size: 14px;">将域名对应的外网</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">进行<span style="color: rgb(255, 76, 0); font-family: 宋体; font-size: 14px;">轮询<span style="font-family: 宋体; font-size: 14px;">解析</span></span></span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">和</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">相比，</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">来实施负载均衡有什么优缺点呢？</span></span></strong></p><p><strong><span style="font-family: 宋体; font-size: 14px;">优点</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">利用第三方</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">实施，服务端架构不用动</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">少了一层网络请求</span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><strong><span style="font-family: 宋体; font-size: 14px;">不足</span></strong><span style="font-family: 宋体; font-size: 14px;">：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">只具备解析功能，不能保证对应外网</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">的可用性</span></span><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">（即使能够做</span><span style="font-family: Calibri; font-size: 14px;">80</span><span style="font-family: 宋体; font-size: 14px;">口的探测，实时性肯定也是比</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">差很多的），而</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">做反向代理时，与</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">之间有保活探测机制，当</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">挂掉时，能够自动迁移流量</span></span></p></li><li><p><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">当</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">需要扩容时，通过</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">扩容生效时间长</span></span><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">，而</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">是服务端完全自己可控的部分，</span><span style="font-family: Calibri; font-size: 14px;">web-server</span><span style="font-family: 宋体; font-size: 14px;">扩容更实时更方便</span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">因为上面两个原因，<strong><span style="font-family:宋体">架构上</span>很少取消反向代理层</strong>，而直接使用</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">来实施负载均衡。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">四、用户就近访问</span></strong></span></p><p><img src="/road5858/images/9f0ebba8e4441b92f47418a983f3abd94f4d3c4d.png" style="width: 424px !important; height: 195px !important;"></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">如文章“缘起”中所述，</span><span style="font-family: Calibri; font-size: 14px;">http</span><span style="font-family: 宋体; font-size: 14px;">请求的第一个步骤域名到外网</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">的转换，发生在整个服务端外部，服务端不可控，那么如果要实施“</span><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">根据客户端</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">来分配最近的服务器机房访问</span></span><span style="font-family: 宋体; font-size: 14px;">”，就只能在</span><span style="font-family: Calibri; font-size: 14px;">dns-server</span><span style="font-family: 宋体; font-size: 14px;">上做了：</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(1)</span><span style="font-family: 宋体; font-size: 14px;">电信用户想要访问某一个服务器资源</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(2)</span><span style="font-family: 宋体; font-size: 14px;">浏览器向</span><span style="font-family: Calibri; font-size: 14px;">dns-server</span><span style="font-family: 宋体; font-size: 14px;">发起服务器域名解析请求</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(3)dns-server</span><span style="font-family: 宋体; font-size: 14px;">识别出访问者是电信用户</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(4)dns-server</span><span style="font-family: 宋体; font-size: 14px;">将电信机房的</span><span style="font-family: Calibri; font-size: 14px;">nginx</span><span style="font-family: 宋体; font-size: 14px;">外网</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">返回给访问者</span></span></p><p><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">(5)</span><span style="font-family: 宋体; font-size: 14px;">访问者就近访问</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">根据用户</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">来返回最近的服务器</span><span style="font-family: Calibri; font-size: 14px;">ip</span></span><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;"></span><span style="font-family: 宋体; font-size: 14px;">，称为“</span><strong><span style="font-family: 宋体; font-size: 14px;">智能</span><span style="font-family: Calibri; font-size: 14px;">dns</span></strong><span style="font-family: 宋体; font-size: 14px;">”，</span><strong><span style="font-family: Calibri; font-size: 14px;">cdn</span></strong><span style="font-family: Calibri; font-size: 14px;">以及<strong>多机房多活</strong></span><span style="font-family: 宋体; font-size: 14px;">中最常用。</span></span></p><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-size: 18px;"><strong><span style="font-family: 宋体;">五、总结</span></strong></span></p><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">架构设计中，</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">有它独特的功能和作用：</span></span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><strong><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">轮询</span></span></strong><span style="font-family: 宋体; font-size: 14px;">，<span style="color: rgb(255, 76, 0); font-family: 宋体; font-size: 14px;">水平扩展反向代理层</span></span></p></li><li><p><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">去掉反向代理层，</span><strong><span style="font-family: 宋体; font-size: 14px;">利用</span><span style="font-family: Calibri; font-size: 14px;">dns</span><span style="font-family: 宋体; font-size: 14px;">实施负载均衡</span></strong></span></p></li><li><p><strong><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">智能</span><span style="font-family: Calibri; font-size: 14px;">dns</span></span></strong><span style="font-size: 14px;"><span style="font-family: Calibri; font-size: 14px;"></span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="color: rgb(255, 76, 0); font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">根据用户</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">来就近访问服务器</span></span></span></p></li></ul><p><span style="font-family: Calibri; font-size: 14px;">&nbsp;</span></p><p><span style="font-family: 宋体; font-size: 14px;">其他相关技术点：</span></p><p><span style="font-family: 宋体; font-size: 14px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959595&amp;idx=1&amp;sn=5f0633afd24c547b895f29f6538baa99&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959595&amp;idx=1&amp;sn=5f0633afd24c547b895f29f6538baa99&amp;scene=21#wechat_redirect">lvs为何不能完全替代DNS轮询</a></span></p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959728&amp;idx=1&amp;sn=933227840ec8cdc35d3a33ae3fe97ec5&amp;chksm=bd2d046c8a5a8d7a13551124af36bedf68f7a6e31f6f32828678d2adb108b86b7e08c678f22f&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651959728&amp;idx=1&amp;sn=933227840ec8cdc35d3a33ae3fe97ec5&amp;chksm=bd2d046c8a5a8d7a13551124af36bedf68f7a6e31f6f32828678d2adb108b86b7e08c678f22f&amp;scene=21#wechat_redirect"><span style="font-family: 宋体; font-size: 14px;">反向代理层的高可用架构设计</span></a></p><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960086&amp;idx=1&amp;sn=70bbe7165ecddc7896767f4503a927fe&amp;chksm=bd2d06ca8a5a8fdc67fcacb169583f53a968fdf623a20395926059d44e6abae6b2e56ff1f9f9&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960086&amp;idx=1&amp;sn=70bbe7165ecddc7896767f4503a927fe&amp;chksm=bd2d06ca8a5a8fdc67fcacb169583f53a968fdf623a20395926059d44e6abae6b2e56ff1f9f9&amp;scene=21#wechat_redirect"><span style="font-size: 14px;"><span style="font-family: 宋体; font-size: 14px;">免</span><span style="font-family: Calibri; font-size: 14px;">dns解析</span><span style="font-family: 宋体; font-size: 14px;">，</span><span style="font-family: Calibri; font-size: 14px;">ip</span><span style="font-family: 宋体; font-size: 14px;">直通车技术</span></span></a></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1495452139&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeW-T5kTNB0lmNIDfirdmdp3IhNxo89xisNdP56ZXTe4KJtg9Glou1t4ppqeRe4PZrUuV6abjPM1txwB6XseHhOTEg85LY4-3x3JQDVAyILVkBaVlRzhXsJv-TXnfxyhoqlZT*gUruQMGIiJAsKeUQCg=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&amp;mid=2651960105&amp;idx=1&amp;sn=0069f2264e227e86a63ee50a4899e0a7&amp;chksm=bd2d06f58a5a8fe33271ed3a378932ad023af7a9004d7fdb44e30a53d53928f984f293a41256#rd">阅读原文</a>
{% endraw  %}

