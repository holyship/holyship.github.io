---
title: 聊聊游戏辅助那些事上部第一篇——过掉那些讨厌的游戏保护
author: youngboz
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496307545&src=3&ver=1&signature=93SzgWWUmeel8Ref4eZJuIODr9gzme7fJtytKfz*8Te*huPLcrDR7zVn0cJjpY*sniFCQ4qoj4lMopJTTObiD4QGeFXTzr81IiCMZoYFk4xb--1ZJ7xvQzkgM0fxphNaZ-SSZk1ijcdtIBjPhS9hNgvI8hMXr8CSPPMvpfv0S8Q=
date: '2017-05-30 00:00:00 +0000'

---

{% raw  %}
<p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">这个系列计划分为上下两部，上部是内置型辅助，下部是按键型辅助。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">相对以前那些裸奔游戏，现在的新游戏多少都会有些保护，这是绕不过去的坎。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">下面针对我发现的几个保护方法，逐个的聊一聊。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"><br></span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span></p><section class="" data-tools="135编辑器" data-id="89351" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px;"><section class="__bg_gif" style="background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_gif/1UG7KPNHN8GgibI3AmdxbRtLJBKkf3GeHvuLCiapVQPbwtshpPOAXVL6SrqMZdddHjUK2fXQQk8d9XPekrbwCzCQ/0?&quot;); background-size: 100%; background-repeat: no-repeat; width: 40px; height: 40px; margin: 0px auto; color: rgb(255, 255, 255);" data-order="0"><section style="margin: 0px auto; text-align: center; font-size: 14px; line-height: 40px; color: rgb(255, 255, 255);"><p style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; margin: 0px;">0<span class="" data-original-title="" title="">1</span></p></section></section></section><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span><br></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">R3 应用层下，DebugActiveProcess 加载调试器时，会设置一个远程断点，而这个远程断点其实多此一举，反而有时会触发反调试检测。唯一要做的就是绕过它。</span></p><p style="line-height: normal;"><span style="font-size: 15px;">这是 NtDebugActiveProcess 的上层函数，DbgUiDebugActiveProcess 的反汇编代码：</span><a style="font-size: 14px; text-decoration: underline;"><span style="font-size: 14px;"><br></span></a></p><p style="line-height: normal;"><a style="font-size: 14px; text-decoration: underline;"><span style="font-size: 14px;"><br></span></a></p><blockquote><p style="line-height: normal;"><a style="font-size: 14px; text-decoration: underline;"><span style="font-size: 14px;">NtDebugActiveProcess@8</span></a><span style="font-size: 14px;"> (775909A4h)&nbsp; <br>7760FC64&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,eax&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;原始返回地址<br>7760FC66&nbsp; test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,esi&nbsp; <br>7760FC68&nbsp; jl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><a style="font-size: 14px; text-decoration: underline;"><span style="font-size: 14px;">_DbgUiIssueRemoteBreakin@4</span></a><span style="font-size: 14px;"> (7760FC03h)&nbsp; <br>7760FC72&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,eax&nbsp; <br>7760FC74&nbsp; test&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi,esi&nbsp; <br>7760FC76&nbsp; jge&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><a style="font-size: 14px; text-decoration: underline;"><span style="font-size: 14px;">_DbgUiStopDebugging@4</span></a><span style="font-size: 14px;"> (7760FB88h)&nbsp; <br>7760FC80&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; eax,esi&nbsp; <br>7760FC82&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; esi&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;+0x1E后的返回地址<br>7760FC83&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ebp&nbsp; <br>7760FC84&nbsp; ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4&nbsp;</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">下面是64位 WINDOW7 下面的 NtDebugActiveProcess 的钩子函数的具体代码，绕过远程断点的方法是在返回地址上加偏移0x1E</span><br></p><p><img src="/ikanxue/images/9dc7ce33ec065e16aac05783f461748d2c0abac5.png" style="width: 564px !important; height: 441px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"><br></span></p><section class="" data-tools="135编辑器" data-id="89351" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px;"><section class="__bg_gif" style="background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_gif/1UG7KPNHN8GgibI3AmdxbRtLJBKkf3GeHvuLCiapVQPbwtshpPOAXVL6SrqMZdddHjUK2fXQQk8d9XPekrbwCzCQ/0?&quot;); background-size: 100%; background-repeat: no-repeat; width: 40px; height: 40px; margin: 0px auto; color: rgb(255, 255, 255);" data-order="1"><section style="margin: 0px auto; text-align: center; font-size: 14px; line-height: 40px; color: rgb(255, 255, 255);"><p style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; margin: 0px;"><span style="font-size: 16px;"><strong>02</strong></span></p></section></section></section><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span><br></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">如果保护程序有驱动，那么在 R0 核心层下调试端口清零会是绝大多数游戏保护的选择。进程的调试端口保存了一个调试器对像，当有异常发生时，操作系统的异常处理程序会查询这个端口，如果存在调试器，就会将异常发送给调试器，调试器会优先获得异常处理的权利。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">网上有不少方法，这儿采用自建调试端口管理的方法绕过它，呵呵，你想清零就清零，反正我又不用它。直接上获取设置调试端口的相关代码。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span></p><p><img src="/ikanxue/images/38dd3734480bdbd67e9433527f3146e3b7bf4a74.png" style="width: 658px !important; height: 591px !important;"></p><p><img src="/ikanxue/images/0c6a26432172afbf376502b10a1da513b9fc287f.png" style="width: 545px !important; height: 467px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span><span style="font-size: 15px;">这是真正的核心代码，注意看注释。后面的 DeviceIoControlDispatch 会调用这个函数。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span></p><p><img src="/ikanxue/images/c4373958975f1f255040a49d1210e1ff40028df8.png" style="width: 579px !important; height: 617px !important;"></p><p><img src="/ikanxue/images/1dd679780abf167a5a51594d2e478d531ab283a2.png" style="width: 527px !important; height: 614px !important;"></p><p><img src="/ikanxue/images/e63a2ad19bef56e886da4e4dfe287630f5b9104e.png" style="width: 515px !important; height: 466px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span><span style="font-size: 15px;">但是用 OnNtDebugActiveProcess 加载那是完全不调试，因为这个函数不用你清零调试端口了，我自己就直接清零了。然后就要对 DbgkForwardException下钩子，让我们自己保存的调试端口发挥作用。具体代码。</span></p><blockquote><pre class=""><p style="line-height: normal;"><span style="font-size: 12px;">BOOLEAN
OnDbgkForwardException(
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;PEXCEPTION_RECORD&nbsp;ExceptionRecord,
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;BOOLEAN&nbsp;DebugException,
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;BOOLEAN&nbsp;SecondChance
&nbsp;&nbsp;&nbsp;&nbsp;)
{
&nbsp;&nbsp;&nbsp;&nbsp;DBGKM_APIMSG&nbsp;m;
&nbsp;&nbsp;&nbsp;&nbsp;PDBGKM_EXCEPTION&nbsp;args;
&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;st;
&nbsp;&nbsp;&nbsp;&nbsp;PAGED_CODE();
&nbsp;if&nbsp;(!DebugException)
&nbsp;{
&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;}
&nbsp;//
&nbsp;//&nbsp;进程设置了调试端口，或者没有影射当前进程的调试端口
&nbsp;//
&nbsp;if&nbsp;(GetDebugPort(PsGetCurrentProcess())&nbsp;==&nbsp;NULL)
&nbsp;{
&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;}
&nbsp;//
&nbsp;//&nbsp;调试端口被置零。
&nbsp;//
&nbsp;_KdPrint(("DbgkForwardException&nbsp;ExceptionAddress&nbsp;=&nbsp;%08x,&nbsp;ExceptionCode&nbsp;=&nbsp;%08x&nbsp;\r\n",&nbsp;ExceptionRecord-&gt;ExceptionAddress,&nbsp;ExceptionRecord-&gt;ExceptionCode));
&nbsp;args&nbsp;=&nbsp;&amp;m.u.Exception;
&nbsp;//
&nbsp;//&nbsp;Initialize&nbsp;the&nbsp;debug&nbsp;LPC&nbsp;message&nbsp;with&nbsp;default&nbsp;information.
&nbsp;//
&nbsp;_KdPrint(("DBGKM_FORMAT_API_MSG\r\n"));
&nbsp;DBGKM_FORMAT_API_MSG(m,DbgKmExceptionApi,sizeof(*args));
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Fill&nbsp;in&nbsp;the&nbsp;remainder&nbsp;of&nbsp;the&nbsp;debug&nbsp;LPC&nbsp;message.
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;_KdPrint(("args-&gt;ExceptionRecord&nbsp;=&nbsp;*ExceptionRecord\r\n"));
&nbsp;args-&gt;ExceptionRecord&nbsp;=&nbsp;*ExceptionRecord;
&nbsp;&nbsp;&nbsp;&nbsp;args-&gt;FirstChance&nbsp;=&nbsp;!SecondChance;
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;the&nbsp;debug&nbsp;message&nbsp;to&nbsp;the&nbsp;destination&nbsp;LPC&nbsp;port.
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;_KdPrint(("DbgkpSendApiMessage\r\n"));
&nbsp;st&nbsp;=&nbsp;DbgkpSendApiMessage(&amp;m,DebugException);

&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;If&nbsp;the&nbsp;send&nbsp;was&nbsp;not&nbsp;successful,&nbsp;then&nbsp;return&nbsp;a&nbsp;FALSE&nbsp;indicating&nbsp;that
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;port&nbsp;did&nbsp;not&nbsp;handle&nbsp;the&nbsp;exception.&nbsp;Otherwise,&nbsp;if&nbsp;the&nbsp;debug&nbsp;port
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;is&nbsp;specified,&nbsp;then&nbsp;look&nbsp;at&nbsp;the&nbsp;return&nbsp;status&nbsp;in&nbsp;the&nbsp;message.
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!NT_SUCCESS(st)&nbsp;||
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((DebugException)&nbsp;&amp;&amp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(m.ReturnedStatus&nbsp;==&nbsp;DBG_EXCEPTION_NOT_HANDLED&nbsp;||&nbsp;!NT_SUCCESS(m.ReturnedStatus))))
&nbsp;{
&nbsp;&nbsp;_KdPrint(("DbgkForwardException&nbsp;FAILED,&nbsp;STATUS&nbsp;=&nbsp;%08x,&nbsp;DebugException&nbsp;=&nbsp;%d,&nbsp;ReturnedStatus&nbsp;=&nbsp;%08x!\r\n",&nbsp;st,&nbsp;DebugException,&nbsp;m.ReturnedStatus));
&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;else
&nbsp;{
&nbsp;&nbsp;_KdPrint(("DbgkForwardException&nbsp;SUCCESSED!\r\n"));
&nbsp;&nbsp;return&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</span></p></pre></blockquote><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">上面的两个函数用到了几个没有导出的核心函数，这就需要自己定位相关的函数了，这里就不再展开定位的方法了。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">调试器在应用层需要添加钩子函数：DbgNtDebugActiveProcess64，与前面的
 DbgNtDebugActiveProcess64 的差别在不再调用 TrueNtDebugActiveProcess，而是通过 
DeviceIoControl 调用我们自己的NtDebugActiveProcess</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span></p><p><img src="/ikanxue/images/7a4f7980abcc9917ca9ba54ec6683aca8053412f.png" style="width: 544px !important; height: 586px !important;"></p><p><img src="/ikanxue/images/84ee2f444605be72f68811115533963d1fe96755.png" style="width: 484px !important; height: 69px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span><br></p><section class="" data-tools="135编辑器" data-id="89351" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px;"><section class="__bg_gif" style="background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_gif/1UG7KPNHN8GgibI3AmdxbRtLJBKkf3GeHvuLCiapVQPbwtshpPOAXVL6SrqMZdddHjUK2fXQQk8d9XPekrbwCzCQ/0?&quot;); background-size: 100%; background-repeat: no-repeat; width: 40px; height: 40px; margin: 0px auto; color: rgb(255, 255, 255);" data-order="2"><section style="margin: 0px auto; text-align: center; font-size: 14px; line-height: 40px; color: rgb(255, 255, 255);"><p style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; margin: 0px;"><strong><span style="font-size: 16px;">03</span></strong></p></section></section></section><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><br></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">调试器对像降权。当系统的调试器对像的访问权限被设置为零时，表现为附加不上所有程序，游戏保护让我们创建的调试对像成为没有调试权限的调试对像。处理方法：重建一个调试对像类型，然后替换掉系统的调试对像类型。</span></p><blockquote><pre class=""><p style="line-height: normal;"><span style="font-size: 12px;">NTSTATUS
DbgkCreateDebugObjectType(
&nbsp;POBJECT_TYPE*&nbsp;DebugObjectType
)
{
&nbsp;NTSTATUS&nbsp;Status;
&nbsp;UNICODE_STRING&nbsp;Name;
&nbsp;POBJECT_TYPE&nbsp;SysDebugObjectType;
&nbsp;POBJECT_TYPE&nbsp;ObpTypeObjectType;
&nbsp;PAGED_CODE();
&nbsp;//
&nbsp;//&nbsp;先打开系统本身的调试对像
&nbsp;//
&nbsp;RtlInitUnicodeString(&amp;Name,&nbsp;L"\\ObjectTypes\\DebugObject");
&nbsp;ObpTypeObjectType&nbsp;=&nbsp;ObGetObjectType(*PsProcessType);
&nbsp;Status&nbsp;=&nbsp;ObReferenceObjectByName(&amp;Name,&nbsp;OBJ_CASE_INSENSITIVE,&nbsp;NULL,&nbsp;0,&nbsp;ObpTypeObjectType,&nbsp;KernelMode,&nbsp;NULL,&nbsp;(PVOID*)&amp;SysDebugObjectType);
&nbsp;if&nbsp;(NT_SUCCESS(Status))
&nbsp;{
&nbsp;&nbsp;//
&nbsp;&nbsp;//&nbsp;系统调试器的对像关闭函数
&nbsp;&nbsp;//
&nbsp;&nbsp;(OB_CLOSE_METHOD&amp;)SysDbgkpCloseObject&nbsp;=&nbsp;SysDebugObjectType-&gt;TypeInfo.CloseProcedure;
&nbsp;&nbsp;//
&nbsp;&nbsp;//&nbsp;先试着打开我们的调试对像类型，如果打开成功，直接使用即可
&nbsp;&nbsp;//
&nbsp;&nbsp;RtlInitUnicodeString(&amp;Name,&nbsp;L"\\ObjectTypes\\NewDebugObject");
&nbsp;&nbsp;Status&nbsp;=&nbsp;ObReferenceObjectByName(&amp;Name,&nbsp;OBJ_CASE_INSENSITIVE,&nbsp;NULL,&nbsp;0,&nbsp;ObpTypeObjectType,&nbsp;KernelMode,&nbsp;NULL,&nbsp;(PVOID*)DebugObjectType);
&nbsp;&nbsp;if&nbsp;(Status&nbsp;==&nbsp;STATUS_OBJECT_NAME_NOT_FOUND)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;RtlInitUnicodeString(&amp;Name,&nbsp;L"NewDebugObject");
&nbsp;&nbsp;&nbsp;GENERIC_MAPPING&nbsp;GenericMapping&nbsp;=&nbsp;{&nbsp;STANDARD_RIGHTS_READ&nbsp;|&nbsp;DEBUG_READ_EVENT,
&nbsp;&nbsp;&nbsp;&nbsp;STANDARD_RIGHTS_WRITE&nbsp;|&nbsp;DEBUG_PROCESS_ASSIGN,
&nbsp;&nbsp;&nbsp;&nbsp;STANDARD_RIGHTS_EXECUTE&nbsp;|&nbsp;SYNCHRONIZE,
&nbsp;&nbsp;&nbsp;&nbsp;DEBUG_ALL_ACCESS&nbsp;};
&nbsp;&nbsp;&nbsp;OBJECT_TYPE_INITIALIZER&nbsp;oti&nbsp;=&nbsp;{&nbsp;0&nbsp;};
&nbsp;&nbsp;&nbsp;oti.Length&nbsp;=&nbsp;sizeof(oti);
&nbsp;&nbsp;&nbsp;oti.SecurityRequired&nbsp;=&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;oti.InvalidAttributes&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;oti.PoolType&nbsp;=&nbsp;NonPagedPool;
&nbsp;&nbsp;&nbsp;oti.DeleteProcedure&nbsp;=&nbsp;SysDebugObjectType-&gt;TypeInfo.DeleteProcedure;
&nbsp;&nbsp;&nbsp;oti.CloseProcedure&nbsp;=&nbsp;(OB_CLOSE_METHOD)DbgkpCloseObject;
&nbsp;&nbsp;&nbsp;oti.ValidAccessMask&nbsp;=&nbsp;DEBUG_ALL_ACCESS;
&nbsp;&nbsp;&nbsp;oti.GenericMapping&nbsp;=&nbsp;GenericMapping;
&nbsp;&nbsp;&nbsp;oti.DefaultPagedPoolCharge&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;oti.DefaultNonPagedPoolCharge&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;Status&nbsp;=&nbsp;ObCreateObjectType(&amp;Name,&nbsp;&amp;oti,&nbsp;NULL,&nbsp;DebugObjectType);
&nbsp;&nbsp;}
&nbsp;&nbsp;else&nbsp;if&nbsp;(NT_SUCCESS(Status))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;(*DebugObjectType)-&gt;TypeInfo.CloseProcedure&nbsp;=&nbsp;(OB_CLOSE_METHOD)DbgkpCloseObject;
&nbsp;&nbsp;}
&nbsp;&nbsp;ObDereferenceObject(SysDebugObjectType);
&nbsp;}
&nbsp;return&nbsp;Status;
}
NTSTATUS&nbsp;DbgkInitialize()
{
&nbsp;POBJECT_TYPE&nbsp;NewDebugObjectType;
&nbsp;Status&nbsp;=&nbsp;DbgkCreateDebugObjectType(&amp;NewDebugObjectType);
&nbsp;if&nbsp;(NT_SUCCESS(Status))
&nbsp;{
&nbsp;&nbsp;*DbgkDebugObjectType&nbsp;=&nbsp;NewDebugObjectType;
&nbsp;}
}</span></p></pre></blockquote><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">DbgkDebugObjectType 为系统内核调试器对像地址，可以通过符号搜索获取地址。TP在启动后会让所用的附加或启动调试失败，然后我们来这么一下，整个世界就安静了。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"><br></span></p><section class="" data-tools="135编辑器" data-id="89351" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px;"><section class="__bg_gif" style="background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_gif/1UG7KPNHN8GgibI3AmdxbRtLJBKkf3GeHvuLCiapVQPbwtshpPOAXVL6SrqMZdddHjUK2fXQQk8d9XPekrbwCzCQ/0?&quot;); background-size: 100%; background-repeat: no-repeat; width: 40px; height: 40px; margin: 0px auto; color: rgb(255, 255, 255);" data-order="3"><section style="margin: 0px auto; text-align: center; font-size: 14px; line-height: 40px; color: rgb(255, 255, 255);"><p style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; margin: 0px;"><strong><span style="font-size: 16px;">04</span></strong></p></section></section></section><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><br></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">这里感谢一下微软，64位的PG帮了我们不少忙，干掉了很多的游戏保护。在64位的系统下，游戏保护基本上过掉这三个就可以了，当然最后还要加上一个过PG的布丁。32位下则一般还还需要过掉
 
NtOpenProcess，NtReadVirtualMemory，NtWriteVirtualMemory，NtQuerySystemInformation等几个函数，如果采用主动式难度不算很大。所谓主动式就是你走你的阳关道，我走我的独木桥，我另外开辟一条路走，把钩子下在应用层，让所有调用这些函数都转到我的函数上来。而且这些钩子不是加在游戏程序上，而是加在调试器上。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">贴一个32下的应用层 NtOpenProcess 钩子函数：利用 DeviceIoControl 跳到核心层，调用我们自己的核心层的 NtOpenProcess，其它的就不一一贴了。</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span></p><p><img src="/ikanxue/images/678c39bfd1a168a6a7cf0211fc2971bc928309ff.png" style="width: 440px !important; height: 530px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;"></span><br></p><section class="" data-tools="135编辑器" data-id="89351" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px;"><section class="__bg_gif" style="background-image: url(&quot;http://mmbiz.qpic.cn/mmbiz_gif/1UG7KPNHN8GgibI3AmdxbRtLJBKkf3GeHvuLCiapVQPbwtshpPOAXVL6SrqMZdddHjUK2fXQQk8d9XPekrbwCzCQ/0?&quot;); background-size: 100%; background-repeat: no-repeat; width: 40px; height: 40px; margin: 0px auto; color: rgb(255, 255, 255);" data-order="4"><section style="margin: 0px auto; text-align: center; font-size: 14px; line-height: 40px; color: rgb(255, 255, 255);"><p style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; margin: 0px;"><strong><span style="font-size: 16px;">05</span></strong></p></section></section></section><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><br></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">前面几个应用层的钩子都用到了 DeviceIoControl，所以贴一下驱动中的 DeviceIoControlDispatch 函数。</span></p><blockquote><pre class=""><p style="line-height: normal;"><span style="font-size: 12px;">NTSTATUS&nbsp;DbgHelperDeviceIoControlDispatch
(
&nbsp;IN&nbsp;&nbsp;PDEVICE_OBJECT&nbsp;&nbsp;DeviceObject,
&nbsp;IN&nbsp;&nbsp;PIRP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Irp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)
{
&nbsp;PIO_STACK_LOCATION&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;irpStack;
&nbsp;NTSTATUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status;
&nbsp;PDBGHELPER_DEVICE_EXTENSION&nbsp;&nbsp;deviceExtension;
&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inputLength;
&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outputLength;
&nbsp;_KdPrint(&nbsp;(__FUNCTION__"++.&nbsp;IRP&nbsp;%p",&nbsp;Irp)&nbsp;);
&nbsp;deviceExtension&nbsp;=&nbsp;(PDBGHELPER_DEVICE_EXTENSION)DeviceObject-&gt;DeviceExtension;
&nbsp;//&nbsp;Get&nbsp;our&nbsp;IRP&nbsp;stack&nbsp;location
&nbsp;irpStack&nbsp;=&nbsp;IoGetCurrentIrpStackLocation(Irp);
&nbsp;//&nbsp;Get&nbsp;the&nbsp;buffer&nbsp;lengths
&nbsp;inputLength&nbsp;=&nbsp;irpStack-&gt;Parameters.DeviceIoControl.InputBufferLength;
&nbsp;outputLength&nbsp;=&nbsp;irpStack-&gt;Parameters.DeviceIoControl.OutputBufferLength;
&nbsp;switch&nbsp;(irpStack-&gt;Parameters.DeviceIoControl.IoControlCode)&nbsp;
&nbsp;{
&nbsp;case&nbsp;IOCTL_NtOpenProcess:
&nbsp;{
&nbsp;&nbsp;_KdPrint(("IOCTL_NtOpenProcess"));
&nbsp;&nbsp;PARAM_NtOpenProcess*&nbsp;ioBuffer&nbsp;=&nbsp;(PARAM_NtOpenProcess*)Irp-&gt;AssociatedIrp.SystemBuffer;
&nbsp;&nbsp;if&nbsp;((ioBuffer&nbsp;==&nbsp;NULL)&nbsp;||&nbsp;(inputLength&nbsp;!=&nbsp;sizeof(PARAM_NtOpenProcess))&nbsp;||&nbsp;(outputLength&nbsp;&lt;&nbsp;sizeof(NTSTATUS)))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_INVALID_PARAMETER,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;//&nbsp;调用真正的函数&nbsp;NtOpenProcess
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;DbgHelperNtOpenProcess(ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;DesiredAccess,&nbsp;ioBuffer-&gt;ObjectAttributes,&nbsp;ioBuffer-&gt;ClientId);
&nbsp;&nbsp;&nbsp;_KdPrint(("STATUS&nbsp;=&nbsp;0x%08x,&nbsp;ProcessHandle&nbsp;=&nbsp;0x%08x,&nbsp;ProcessId&nbsp;=&nbsp;0x%08x,&nbsp;ThreadId&nbsp;=&nbsp;0x%08x",&nbsp;status,&nbsp;ioBuffer-&gt;ProcessHandle&nbsp;?&nbsp;*ioBuffer-&gt;ProcessHandle&nbsp;:&nbsp;(PHANDLE)-1,&nbsp;ioBuffer-&gt;ClientId-&gt;UniqueProcess,&nbsp;ioBuffer-&gt;ClientId-&gt;UniqueThread));
&nbsp;&nbsp;&nbsp;*(NTSTATUS&nbsp;*)ioBuffer&nbsp;=&nbsp;status;
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_SUCCESS,&nbsp;sizeof(NTSTATUS));
&nbsp;&nbsp;}
&nbsp;}
&nbsp;break;
&nbsp;case&nbsp;IOCTL_NtCreateDebugObject:
&nbsp;{
&nbsp;&nbsp;_KdPrint(("IOCTL_NtCreateDebugObject&nbsp;Enter\n"));
&nbsp;&nbsp;PARAM_NtCreateDebugObject*&nbsp;ioBuffer&nbsp;=&nbsp;(PARAM_NtCreateDebugObject*)Irp-&gt;AssociatedIrp.SystemBuffer;
&nbsp;&nbsp;if&nbsp;((ioBuffer&nbsp;==&nbsp;NULL)&nbsp;||&nbsp;(inputLength&nbsp;!=&nbsp;sizeof(PARAM_NtCreateDebugObject))&nbsp;||&nbsp;(outputLength&nbsp;&lt;&nbsp;sizeof(NTSTATUS)))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_INVALID_PARAMETER,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;//&nbsp;调用我们自己的函数&nbsp;NtCreateDebugObject，返回的&nbsp;DebugObjectHandle&nbsp;兼容系统的调试对像
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;OnNtCreateDebugObject(ioBuffer-&gt;DebugObjectHandle,&nbsp;ioBuffer-&gt;DesiredAccess,&nbsp;ioBuffer-&gt;ObjectAttributes,&nbsp;ioBuffer-&gt;Flags);
&nbsp;&nbsp;&nbsp;_KdPrint(("STATUS&nbsp;=&nbsp;0x%08x,&nbsp;DebugObjectHandle&nbsp;=&nbsp;0x%08x,&nbsp;DesiredAccess&nbsp;=&nbsp;0x%08x,&nbsp;Flags&nbsp;=&nbsp;&nbsp;0x%08x",&nbsp;status,&nbsp;ioBuffer-&gt;DebugObjectHandle&nbsp;?&nbsp;*ioBuffer-&gt;DebugObjectHandle&nbsp;:&nbsp;(HANDLE)-1,&nbsp;ioBuffer-&gt;DesiredAccess,&nbsp;ioBuffer-&gt;Flags));
&nbsp;&nbsp;&nbsp;*(NTSTATUS&nbsp;*)ioBuffer&nbsp;=&nbsp;status;
&nbsp;&nbsp;&nbsp;_KdPrint(("IOCTL_NtCreateDebugObject&nbsp;Leave\n"));
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_SUCCESS,&nbsp;sizeof(NTSTATUS));
&nbsp;&nbsp;}
&nbsp;}
&nbsp;break;
&nbsp;case&nbsp;IOCTL_NtDebugActiveProcess:
&nbsp;{
&nbsp;&nbsp;_KdPrint(("IOCTL_NtDebugActiveProcess&nbsp;Enter\n"));
&nbsp;&nbsp;PARAM_NtDebugActiveProcess*&nbsp;ioBuffer&nbsp;=&nbsp;(PARAM_NtDebugActiveProcess*)Irp-&gt;AssociatedIrp.SystemBuffer;
&nbsp;&nbsp;if&nbsp;((ioBuffer&nbsp;==&nbsp;NULL)&nbsp;||&nbsp;(inputLength&nbsp;!=&nbsp;sizeof(PARAM_NtDebugActiveProcess))&nbsp;||&nbsp;(outputLength&nbsp;&lt;&nbsp;sizeof(NTSTATUS)))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_INVALID_PARAMETER,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;//&nbsp;调用我们自己的函数&nbsp;NtDebugActiveProcess
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;OnNtDebugActiveProcess(ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;DebugObjectHandle);
&nbsp;&nbsp;&nbsp;_KdPrint(("STATUS&nbsp;=&nbsp;0x%08x,&nbsp;ProcessHandle&nbsp;=&nbsp;0x%08x,&nbsp;DebugObjectHandle&nbsp;=&nbsp;0x%08x",&nbsp;status,&nbsp;ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;DebugObjectHandle));
&nbsp;&nbsp;&nbsp;*(NTSTATUS&nbsp;*)ioBuffer&nbsp;=&nbsp;status;
&nbsp;&nbsp;&nbsp;_KdPrint(("IOCTL_NtDebugActiveProcess&nbsp;Leave\n"));
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_SUCCESS,&nbsp;sizeof(NTSTATUS));
&nbsp;&nbsp;}
&nbsp;}
&nbsp;break;
&nbsp;case&nbsp;IOCTL_NtRemoveProcessDebug:
&nbsp;{
&nbsp;&nbsp;_KdPrint(("IOCTL_NtRemoveProcessDebug&nbsp;Enter\n"));
&nbsp;&nbsp;PARAM_NtRemoveProcessDebug*&nbsp;ioBuffer&nbsp;=&nbsp;(PARAM_NtRemoveProcessDebug*)Irp-&gt;AssociatedIrp.SystemBuffer;
&nbsp;&nbsp;if&nbsp;((ioBuffer&nbsp;==&nbsp;NULL)&nbsp;||&nbsp;(inputLength&nbsp;!=&nbsp;sizeof(PARAM_NtRemoveProcessDebug))&nbsp;||&nbsp;(outputLength&nbsp;&lt;&nbsp;sizeof(NTSTATUS)))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_INVALID_PARAMETER,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;//&nbsp;调用我们自己的函数&nbsp;NtRemoveProcessDebug
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;OnNtRemoveProcessDebug(ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;DebugObjectHandle);
&nbsp;&nbsp;&nbsp;_KdPrint(("STATUS&nbsp;=&nbsp;0x%08x,&nbsp;ProcessHandle&nbsp;=&nbsp;0x%08x,&nbsp;DebugObjectHandle&nbsp;=&nbsp;0x%08x",&nbsp;status,&nbsp;ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;DebugObjectHandle));
&nbsp;&nbsp;&nbsp;*(NTSTATUS&nbsp;*)ioBuffer&nbsp;=&nbsp;status;
&nbsp;&nbsp;&nbsp;_KdPrint(("IOCTL_NtRemoveProcessDebug&nbsp;Leave\n"));
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_SUCCESS,&nbsp;sizeof(NTSTATUS));
&nbsp;&nbsp;}
&nbsp;}
&nbsp;break;
&nbsp;case&nbsp;IOCTL_NtReadVirtualMemory:
&nbsp;{
&nbsp;&nbsp;_KdPrint(("IOCTL_NtReadVirtualMemory"));
&nbsp;&nbsp;PARAM_NtReadVirtualMemory*&nbsp;ioBuffer&nbsp;=&nbsp;(PARAM_NtReadVirtualMemory*)Irp-&gt;AssociatedIrp.SystemBuffer;
&nbsp;&nbsp;if&nbsp;((ioBuffer&nbsp;==&nbsp;NULL)&nbsp;||&nbsp;(inputLength&nbsp;!=&nbsp;sizeof(PARAM_NtReadVirtualMemory))&nbsp;||&nbsp;(outputLength&nbsp;&lt;&nbsp;sizeof(NTSTATUS)))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_INVALID_PARAMETER,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;//&nbsp;调用我们自己的&nbsp;NtReadVirtualMemory&nbsp;函数
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;DbgHelperNtReadVirtualMemory(ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;BaseAddress,&nbsp;ioBuffer-&gt;Buffer,&nbsp;ioBuffer-&gt;BufferSize,&nbsp;ioBuffer-&gt;NumberOfBytesWritten);
&nbsp;&nbsp;&nbsp;_KdPrint(("STATUS&nbsp;=&nbsp;0x%08x,&nbsp;ProcessHandle&nbsp;=&nbsp;0x%08x,&nbsp;BaseAddress&nbsp;=&nbsp;0x%08x,&nbsp;BufferSize&nbsp;=&nbsp;0x%08x",&nbsp;status,&nbsp;ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;BaseAddress,&nbsp;ioBuffer-&gt;BufferSize));
&nbsp;&nbsp;&nbsp;*(NTSTATUS&nbsp;*)ioBuffer&nbsp;=&nbsp;status;
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_SUCCESS,&nbsp;sizeof(NTSTATUS));
&nbsp;&nbsp;}
&nbsp;}
&nbsp;break;
&nbsp;case&nbsp;IOCTL_NtWriteVirtualMemory:
&nbsp;{
&nbsp;&nbsp;_KdPrint(("IOCTL_NtWriteVirtualMemory"));
&nbsp;&nbsp;PARAM_NtWriteVirtualMemory*&nbsp;ioBuffer&nbsp;=&nbsp;(PARAM_NtWriteVirtualMemory*)Irp-&gt;AssociatedIrp.SystemBuffer;
&nbsp;&nbsp;if&nbsp;((ioBuffer&nbsp;==&nbsp;NULL)&nbsp;||&nbsp;(inputLength&nbsp;!=&nbsp;sizeof(PARAM_NtWriteVirtualMemory))&nbsp;||&nbsp;(outputLength&nbsp;&lt;&nbsp;sizeof(NTSTATUS)))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_INVALID_PARAMETER,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;//&nbsp;调用我们自己的&nbsp;NtWriteVirtualMemory&nbsp;函数
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;DbgHelperNtWriteVirtualMemory(ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;BaseAddress,&nbsp;ioBuffer-&gt;Buffer,&nbsp;ioBuffer-&gt;BufferSize,&nbsp;ioBuffer-&gt;NumberOfBytesWritten);
&nbsp;&nbsp;&nbsp;_KdPrint(("STATUS&nbsp;=&nbsp;0x%08x,&nbsp;ProcessHandle&nbsp;=&nbsp;0x%08x,&nbsp;BaseAddress&nbsp;=&nbsp;0x%08x,&nbsp;BufferSize&nbsp;=&nbsp;0x%08x",&nbsp;status,&nbsp;ioBuffer-&gt;ProcessHandle,&nbsp;ioBuffer-&gt;BaseAddress,&nbsp;ioBuffer-&gt;BufferSize));
&nbsp;&nbsp;&nbsp;*(NTSTATUS&nbsp;*)ioBuffer&nbsp;=&nbsp;status;
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_SUCCESS,&nbsp;sizeof(NTSTATUS));
&nbsp;&nbsp;}
&nbsp;}
&nbsp;break;
&nbsp;case&nbsp;IOCTL_NtQuerySystemInformation:
&nbsp;{
&nbsp;&nbsp;_KdPrint(("IOCTL_NtQuerySystemInformation&nbsp;Enter\n"));
&nbsp;&nbsp;PARAM_NtQuerySystemInformation*&nbsp;ioBuffer&nbsp;=&nbsp;(PARAM_NtQuerySystemInformation*)Irp-&gt;AssociatedIrp.SystemBuffer;
&nbsp;&nbsp;if&nbsp;((ioBuffer&nbsp;==&nbsp;NULL)&nbsp;||&nbsp;(inputLength&nbsp;!=&nbsp;sizeof(PARAM_NtQuerySystemInformation))&nbsp;||&nbsp;(outputLength&nbsp;&lt;&nbsp;sizeof(NTSTATUS)))
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_INVALID_PARAMETER,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;//&nbsp;调用我们自己的函数&nbsp;NtRemoveProcessDebug
&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;NtQuerySystemInformation(ioBuffer-&gt;SystemInformationClass,&nbsp;ioBuffer-&gt;SystemInformation,&nbsp;ioBuffer-&gt;SystemInformationLength,&nbsp;ioBuffer-&gt;ReturnLength);
&nbsp;&nbsp;&nbsp;_KdPrint(("STATUS&nbsp;=&nbsp;0x%08x,&nbsp;SystemInformationClass&nbsp;=&nbsp;%d,&nbsp;SystemInformation&nbsp;=&nbsp;%d",&nbsp;status,&nbsp;ioBuffer-&gt;SystemInformationClass,&nbsp;ioBuffer-&gt;SystemInformation));
&nbsp;&nbsp;&nbsp;*(NTSTATUS&nbsp;*)ioBuffer&nbsp;=&nbsp;status;
&nbsp;&nbsp;&nbsp;_KdPrint(("IOCTL_NtQuerySystemInformation&nbsp;Leave\n"));
&nbsp;&nbsp;&nbsp;return&nbsp;CompleteIrp(Irp,&nbsp;STATUS_SUCCESS,&nbsp;sizeof(NTSTATUS));
&nbsp;&nbsp;}
&nbsp;}
&nbsp;break;
&nbsp;default:
&nbsp;&nbsp;status&nbsp;=&nbsp;STATUS_INVALID_DEVICE_REQUEST;
&nbsp;&nbsp;Irp-&gt;IoStatus.Status&nbsp;=&nbsp;status;
&nbsp;&nbsp;IoCompleteRequest&nbsp;(Irp,&nbsp;IO_NO_INCREMENT);
&nbsp;&nbsp;break;
&nbsp;}
&nbsp;_KdPrint(&nbsp;(__FUNCTION__"--.&nbsp;IRP&nbsp;%p&nbsp;STATUS&nbsp;%x",&nbsp;Irp,&nbsp;status)&nbsp;);
&nbsp;return&nbsp;status;
}</span></p></pre></blockquote><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">最后预告一下，本系列的第二篇，聊聊游戏辅助那些事上部第二篇——跟踪是个苦力活，调试器有什么好建议？</span></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">当然什么时候发我自己也不知道了，因为还没写呢。想看的就自己关注了。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em; text-align: center;"><span style="font-size: 15px; color: rgb(136, 136, 136);">本文由看雪论坛<span class=""> youngboz</span><span class=""> </span>原创</span><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">你可能对以下内容感兴趣：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">等你来挑战！| 看雪 CTF 2017 攻击篇</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">【终于等到你！】看雪 CTF 2017</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283039&amp;idx=2&amp;sn=7965f942fd1629eb4b0502b01a522998&amp;chksm=b1815c9586f6d583b224490858104e7a5e5affad9542fe33da744c091ec234c3a55016f41690&amp;scene=21#wechat_redirect" target="_blank">MS17-010 SMB 远程命令执行漏洞利用分析</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283033&amp;idx=2&amp;sn=7a0d3fa2c8c5e2bdcac6379351269330&amp;chksm=b1815c9386f6d585439b2186c5fc7099c74ce5398483563db182f868911a3a2c6c4be7500021&amp;scene=21#wechat_redirect" target="_blank">新手逆向学习--Win7 下 64 位扫雷逆向以及辅助制作</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283005&amp;idx=2&amp;sn=2fc411b70549c789085e517ef6dfc3e9&amp;chksm=b1815b7786f6d261975cd000d4ddf2c4cffe3cf2d8ab06d870e7971e862c29c7278996bdfb6c&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283017&amp;idx=3&amp;sn=745024d678707b6dcf0cdc94ff5472a5&amp;chksm=b1815c8386f6d59538bfeeb8d3837007f07b0b4d3cd77b439f7856edd391127b6b2f36fb105d&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">Ring3 注入总结及编程实现【有码】</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283003&amp;idx=1&amp;sn=bcfd852aea24f274bf8fda85f9300a85&amp;chksm=b1815b7186f6d26758f7f0f1cb0c7ec9da888ab0d80a7b2e2850453bfc03f05640443839d7bf&amp;scene=21#wechat_redirect" target="_blank">【原创】WannaCry勒索软件中“永恒之蓝”漏洞利用分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="/ikanxue/images/a0942aca19665d63c4ee222be971a37cd63dc1e4.jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span><span style="font-size: 15px;"></span><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496307545&src=3&ver=1&signature=93SzgWWUmeel8Ref4eZJuIODr9gzme7fJtytKfz*8Te*huPLcrDR7zVn0cJjpY*sniFCQ4qoj4lMopJTTObiD4QGeFXTzr81IiCMZoYFk4xb--1ZJ7xvQzkgM0fxphNaZ-SSZk1ijcdtIBjPhS9hNgvI8hMXr8CSPPMvpfv0S8Q=">微信地址</a> | <a href="http://bbs.pediy.com/thread-215797.htm">阅读原文</a>
{% endraw  %}

