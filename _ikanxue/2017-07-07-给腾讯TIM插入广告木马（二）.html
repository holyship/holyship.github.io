---
title: 给腾讯TIM插入广告木马（二）
author: 看雪iOS安全小组
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499656441&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvWzQOeuhSoNW9OwNWgZNLWSYC6qMb3ZXn30HCkumczAHebEjZwV6NvKvUTZHIhDAT8lDn4vYegsek8-8pGOVK3wTw7zEKpXR8rzOd*n-E6X4lPSexS3cR9pEbHMstPaC-VNRadqnZ3j6to-FKte9f1J4=
date: '2017-07-07 00:00:00 +0000'

---

{% raw  %}
<section label="Copyright Reserved by ipaiban.com." style="margin: 1em auto; padding: 0.5em 1em; white-space: normal; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-style: none;"><section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;">二、</p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 16px;">在 TIM App 中注入 jailbreak 广告库</span></p></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="font-size: 15px; color: rgb(64, 118, 0);">（1）砸壳 ipa</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia4mf1L3zGv6oEFR1DOglicLa5q0FlNwT3VibzpDPwvBXwyob67bg7YgW5g/0?wx_fmt=png" style="width: 770px !important; height: 134.523px !important; visibility: visible !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="font-size: 15px; color: rgb(64, 118, 0);">（2）拷贝com.tencent.tim-iOS7.0-(Clutch-2.0.4).ipa至电脑并解压</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia4G1xrib8cRRcS12R0YwXTM9V4f0FRa2FfHaibmlh9ia53nHlWsk0giaRQfA/0?wx_fmt=png" style="width: 770px !important; height: 39.0821px !important; visibility: visible !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(64, 118, 0);"><strong><span style="font-size: 15px;">（3）在TIM中注入jailbreak</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia4C8VQTCh4tqrPNjuwQuIaWc7PsewzXoEtmYPkPQ4Qj7SP8tdNO8YIXg/0?wx_fmt=png" style="width: 770px !important; height: 208.785px !important; visibility: visible !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(64, 118, 0);"><strong><span style="font-size: 15px;">（4）重新签名并打包为ipa文件，安装新程序至iOS</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">工具：iOS App Signner、codesign、AppResign、Cydia Impactor皆可以</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(64, 118, 0);"><strong><span style="font-size: 15px;">（5）iOS配置局域网代理，并使用BurpSuite抓包，BurpSuite开启修改Intercept Client Resquests功能</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(64, 118, 0);"><strong><span style="font-size: 15px;">（6）撰写新的动态链接库（文件见附件）用于劫持流程</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">压缩并计算md5。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia447LElahPouLTRfg9eu32wJAhianuq5aBGIibypshBsmb8zJqduiauicicmA/0?wx_fmt=png" style="width: 770px !important; height: 36.8261px !important;"></p><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></h4><section label="Copyright Reserved by ipaiban.com." style="margin: 1em auto; padding: 0.5em 1em; white-space: normal; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-style: none;"><section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;">三、</p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 16px;">使用BurpSuite中间人劫持木马，成功任意代码执行</span></p></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="font-size: 15px; color: rgb(64, 118, 0);">（7）启动本地httpd，并将DailyUploadDownloadLib.framework.zip放置在根目录</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia4AVsoQFeHDZyvMLicOZuiaiaPpg5b6PebnoibGOp7D1NEMhBkEvMibYQSpKA/0?wx_fmt=png" style="width: 770px !important; height: 37.8275px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="font-size: 15px; color: rgb(64, 118, 0);">（8）启动App,使用burp修改以下请求回包</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia485CMibWVcOgr2Wn5WGO4CRoqUc0EC7QegiaJDYIt7vHMe2RXVibTv9J3w/0?wx_fmt=png" style="width: 770px !important; height: 108.216px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">修改返回的response数据包</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia4kPVnSGCE0kfJ0c7REK5Qc6oiba3ESKY0hCBJxaHx1Z0kzvpAuLclzIw/0?wx_fmt=png" style="width: 770px !important; height: 161.758px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">修改linkfw和md5fw的值</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia4oic3SiciaTqGVFqFCG3DnuicicfEV7Fz0AJic5M95eiaIaicRmib7nWQib5YMDHA/0?wx_fmt=png" style="width: 770px !important; height: 37.8824px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(64, 118, 0);"><strong><span style="font-size: 15px;">（9）弹出alert</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">结果会弹出我们写在DailyUploadDownloadLib中的弹框。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FmBWPp8vhoYufa66sbs7ia4EytiaicOl7viaibNLjNibMZ1g0zOY6NyGeP0bFLibcjpicCl4EWERic6oniaMYw/0?wx_fmt=png" style="width: 770px !important; height: 51.9936px !important;"></p><section label="Copyright Reserved by ipaiban.com." style="margin: 1em auto; padding: 0.5em 1em; white-space: normal; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-style: none;"><section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;">四、</p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;">相关工具<br></p></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">IDA</span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Hopper</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">IFunBox</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">usbmuxd</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Xcode</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">dumpdecrypted</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Cycript</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">codesign</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">yololib</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Class-dump</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Clutch</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">iOS App Signner</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">BurpSuite</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Charles</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">AppResign</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Cydia Impactor</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><hr><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em; text-align: center;"><span style="font-size: 15px;"></span>完<br></p><p style="text-align: center; margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">本文由 <strong>看雪论坛iOS 小组成员 afox、AliceForever、KoU2N、物以类聚</strong> 原创，</span></p><p style="text-align: center; margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">转载请注明来自看雪论坛 <br></span></p><p style="text-align: center; margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span></p><p style="text-align: center; margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; color: rgb(255, 104, 39); box-sizing: border-box !important; overflow-wrap: break-word !important;">如果你喜欢的话，不要忘记点个赞哦！</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br></strong></span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">热门阅读文章：<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283175&amp;idx=1&amp;sn=c799c0b1773dea71c74457c446cb2c59&amp;chksm=b1815c2d86f6d53b6e6722395e4d3d4cfdd2af00131e0462b3a19767bf4e271dd8ead5c8e35b&amp;scene=21#wechat_redirect" target="_blank">选择看雪企业 SRC 的 5 大理由</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283834&amp;idx=2&amp;sn=7b143154dc6fe1c0eec8649b761df78f&amp;chksm=b1815fb086f6d6a654efaa14b26aacac038790223ac71059c531234ce087203a4192b2d154ae&amp;scene=21#wechat_redirect" target="_blank">初学Windows内核漏洞利用（二）：熟悉HEVD</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283824&amp;idx=1&amp;sn=479e8f40d0d1deb69cbbe7a1c36f285d&amp;chksm=b1815fba86f6d6acccc9a7ac0da361c091dd1e714249f415f5dd64e47f27de76938334469b75&amp;scene=21#wechat_redirect" target="_blank">初学Windows内核漏洞利用（一）：搭建实验环境</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283801&amp;idx=3&amp;sn=7b7133c3b9e03a2d3a3110f505655a56&amp;chksm=b1815f9386f6d685d472ab31664b6b46df80402db1c21dd9e6947dec12984554181454a5c1f1&amp;scene=21#wechat_redirect" target="_blank">从内核角度分析 Dirty Cow 原理</a></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283781&amp;idx=2&amp;sn=f3f15b42abe63e728089c9eab8b97e81&amp;chksm=b1815f8f86f6d6994e85d53f0da97791bb0c4a112762c067be8bbe8e1d2cac4a45b21815532c&amp;scene=21#wechat_redirect" target="_blank">『资源』Web安全在线练习平台</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbp7wPVAEujKLHZQicNHsdY9rLP72MmjtDsEjIfRIs36EezoZj3S4a4Qsw/640?wx_fmt=jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 427px !important;"></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">&nbsp;&nbsp;&nbsp; 商务合作：wsc@kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499656441&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvWzQOeuhSoNW9OwNWgZNLWSYC6qMb3ZXn30HCkumczAHebEjZwV6NvKvUTZHIhDAT8lDn4vYegsek8-8pGOVK3wTw7zEKpXR8rzOd*n-E6X4lPSexS3cR9pEbHMstPaC-VNRadqnZ3j6to-FKte9f1J4=">微信地址</a> | <a href="http://bbs.pediy.com/thread-218920.htm">阅读原文</a>
{% endraw  %}

