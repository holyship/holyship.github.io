---
title: 初学Windows内核漏洞利用（三）：窃取访问凭证
author: 木无聊偶
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499656441&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvWzQOeuhSoNW9OwNWgZNLWSYC6qMb3ZXn30HCkumczAHebEjZwV6NvKvUTZHIhDAT8gt2W4ByfMtwo08CaZcDNOFveLLAs7eI6j*LT9IgnslhdlWjJZPQwyY0qDa0eR5XKjZrENq5K4vCmqP92xIfy7A=
date: '2017-07-04 00:00:00 +0000'

---

{% raw  %}
<p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">最近我刚刚开始学习Windows内核漏洞利用，因此决定以博客的形式分享一些我的学习心得。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">之前的部分我介绍了如何搭建环境：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283834&amp;idx=2&amp;sn=7b143154dc6fe1c0eec8649b761df78f&amp;chksm=b1815fb086f6d6a654efaa14b26aacac038790223ac71059c531234ce087203a4192b2d154ae&amp;scene=21#wechat_redirect" target="_blank">初学Windows内核漏洞利用（二）：熟悉HEVD</a><br></span></p></li><li><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283824&amp;idx=1&amp;sn=479e8f40d0d1deb69cbbe7a1c36f285d&amp;chksm=b1815fba86f6d6acccc9a7ac0da361c091dd1e714249f415f5dd64e47f27de76938334469b75&amp;scene=21#wechat_redirect" target="_blank">初学Windows内核漏洞利用（一）：搭建实验环境</a><br></span></p></li></ul><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">现在我们将接触熟悉用于权限提升的载荷。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">本部分我所用到的工具环境如下：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">在（1）和（2）中所描述的环境；</span></p></li><li><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">nasm工具（下载网址：</span><span style="font-size: 15px;">http://www.nasm.us/</span><span style="font-size: 15px;">&nbsp;）；</span></p></li><li><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">HxD工具（下载网址：</span><span style="font-size: 15px;">https://mh-nexus.de/en/hxd/</span><span style="font-size: 15px;">&nbsp;）。</span></p></li></ul><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">回顾一下，我们的攻击目标是存在漏洞的驱动程序，我们将从用户层向其提交一段缓冲区数据。上一部分中，我们通过提交畸形的输入数据，成功触发了一些崩溃场景；然而我们的目标并不是破坏执行流程，而是通过精心构造输入来控制执行流程重定向到我们的代码中。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">通常，传输载荷被用于提升攻击者应用程序的权限；而这可以通过窃取拥有更高权限的应用程序的访问凭证（关于访问凭证的具体含义，可参考相关维基百科，网址：https://en.wikipedia.org/wiki/Access_token）来实现。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br></p><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;"><strong>查看访问凭证</strong></span></p></section><p><br></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 16px;"></span><span style="font-size: 15px;">系统中运行的每个进程都有其对应的EPROCESS数据结构，其中封装了所有与之相关的数据。该结构的完整定义，详见网址</span><span style="font-size: 15px;">https://www.nirsoft.net/kernel_struct/vista/EPROCESS.html</span><span style="font-size: 15px;">（EPROCESS数据结构在Windows操作系统的不同版本之间会有细微差别，更多信息参见网址</span><span style="font-size: 15px;">https://www.geoffchappell.com/studies/windows/km/ntoskrnl/structs/eprocess/index.htm</span><span style="font-size: 15px;">&nbsp;）。EPROCESS结构的某些成员，比如PEB（Process Environment Block，进程环境块，具体含义可参考维基百科，网址：</span><span style="font-size: 15px;">https://en.wikipedia.org/wiki/Process_Environment_Block</span><span style="font-size: 15px;">），用户模式下即可访问；而另一些，比如所提到的访问凭证，只能在内核模式下访问。我们可以通过如下命令，使用WinDbg调试器查看EPROCESS结构的所有域成员，结果如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">dt&nbsp;nt!_EPROCESS</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mw1ia9JnWd69Vr1pC59NcibuGMA7EzTic6nOSO3YsiaNg2vFrxAne3354BpQ/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 300px !important;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">可见，结构起始位置到域成员Token的偏移为0xF8。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">通过使用如下命令，让我们查看凭证中所包含类型的细节，结果如下图所示。</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">dt&nbsp;nt!_EX_FAST_REF</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwhiaJibDRlt2KhG5TKP2CjyjscPdrpmMPXv6cV1QYTbGTkKgN1cmS1ccw/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 354px !important; height: 64px !important;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">凭证存储于一个联合结构体_EX_FAST_REF中，其有两个域成员：RefCnt（引用计数）和Value。我们只对替代Value感兴趣；出于应用程序的稳定性考虑，最好不要改变引用计数。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">现在，让我们查看被调试方主机上运行的某些应用程序的凭证。我们可以使用如下命令来列举进程：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">!dml_proc</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;"><strong>示例</strong></span></p></section><p><br></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">结果如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mw0ERwTibAR6roBHvOgrAPjWzCfIJ0PxAlA90FPVDrfTszjVoJEpwXUPA/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 241px !important; height: 208px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">图中所示的第一列，是对应于特定进程的EPROCESS结构首地址。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">现在，使用图中的地址，我们可以通过如下命令来发现更多选定进程相关的细节：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">!process&nbsp;[address&nbsp;of&nbsp;EPROCESS]</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">在如下图所示的各个域成员之中，我们可以看到访问凭证。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mw7rm5BLTsn5kRlJhj7fxN6QtGnsbPm6emGuebzibnSQSN7wDy1zkCnPg/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 237px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">通过如下命令，我们还可以在更低层次上查看凭证的具体内容：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">dt&nbsp;nt!_EX_FAST_REF&nbsp;[address&nbsp;of&nbsp;EPROCESS]&nbsp;+&nbsp;[offset&nbsp;to&nbsp;the&nbsp;Token&nbsp;field]</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">命令执行结果如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mw6OTQBuGPJ6KuF3kP6Ef02WQ8KSqibezWToyZGWagiaPq1MVzmvXiaF2FQ/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 377px !important; height: 58px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">或者使用如下命令：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">dd&nbsp;[address&nbsp;of&nbsp;EPROCESS]&nbsp;+&nbsp;[offset&nbsp;to&nbsp;the&nbsp;Token&nbsp;field]</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">结果如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwHxoxtDicuiahCxczfeaeWSibicUDIht3iaTj8icKqsv4iaictib8jcz5QbNjjow/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 369px !important; height: 121px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">从上面的结果我们可以看出，!process命令会自动应用掩码，并从显示信息中过滤引用计数；我们可以通过使用最右3比特置零的掩码，在如下表达式求值的帮助下，人工实现相同的功能：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">?[token]&nbsp;&amp;&nbsp;0xFFFFFFF8</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">结果如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwvUib83Sd9W6YjaPyrR6gAuxjWMkUicx240IfvRiao3T9vHAmhca1Tv57g/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 363px !important; height: 33px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">通过WinDbg调试器窃取访问凭证</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">作为练习，我们将在被调试方主机运行cmd.exe，并在调试方主机使用WinDbg调试器来提升其权限。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">首先，列举所有进程；然后，显示查看选定进程System和cmd的访问凭证；之后，将System进程的访问凭证复制到cmd进程内，在这个过程中为了保持引用计数不变我们需要使用相应的掩码；最终，cmd.exe提权成功。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;"><strong>窃取凭证的载荷</strong></span></p></section><p><br></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">现在我们需要通过注入代码来重现以上过程；当然这并不简单，因为我们不能再借助WinDbg调试器了。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">在官方的HEVD知识库中，提供了一些用于窃取凭证的载荷的完整例子，作为漏洞利用代码的一部分（网址：</span><span style="font-size: 15px;">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Exploit/Payloads.c</span><span style="font-size: 15px;">&nbsp;）。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">代码中所包含的所有载荷的目的是相同的，即窃取访问凭证；然而我们可以看到，为了适应特定的漏洞，它们之间有一点差别。它们的代码大部分是相同的，只有结尾不同（该部分被称之为“内核恢复桩程序”）；这部分代码被用于进行必要的清理工作，以便在载荷部分执行完成返回之后，应用程序不会崩溃。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">接着，我们看一个通用版本（网址：</span><span style="font-size: 15px;">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Exploit/Payloads.c#L186</span><span style="font-size: 15px;">&nbsp;），具体代码如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwRQ6cI7ASm7BOvJia2yWaTAquWrRL0X6nID8LpP5Okb2LMYDbibkpTic8Q/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 499px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">首先，我们必须找到EPROCESS结构的起始位置。使用WinDbg调试器这轻而易举，一条命令就可以显示该信息；现在，我们需要从其他的域来顺藤摸瓜，自己动手找到该结构的起始位置。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">我们使用KPCR（Kernel Processor Control Region，内核处理器控制区域）结构作为起点，32位Windows操作系统上的FS寄存器（64位系统上则是GS寄存器）指向该结构。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">上图中所述的代码利用了以下结构之间的关系：</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">KPCR</span><span style="font-size: 15px;">（PrcbData）-&gt;</span><span style="font-size: 15px;">KPRCB</span><span style="font-size: 15px;">（CurrentThread）-&gt;</span><span style="font-size: 15px;">KTHREAD</span><span style="font-size: 15px;">（ApcState）-&gt;</span><span style="font-size: 15px;">KAPC_STATE</span><span style="font-size: 15px;">（Process）-&gt;</span><span style="font-size: 15px;">KPROCESS</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">KPROCESS结构是EPROCESS结构的第一个域，如下图所示；因此，通过找到它我们最终找到了EPROCESS结构的起始位置。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mw6D4j4wkWKNdDzxfexEzh6AKKibKj9jPsBxbXnlEG39MLZDfV31A5W3A/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 257px !important; height: 130px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">当前进程的EPROCESS结构找到之后，我们将利用其另一个域来找到SYSTEM进程的EPROCESS结构，如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwGe3NTtoCjWnkrECRFWVLYqYO8pxdibryTXpFSzziakT51hTdicFDDd9yQ/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 266px !important; height: 133px !important;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">LIST_ENTRY是双向链表的一个成员类型，该表将所有正在运行的进程连接到一起。该结构的具体定义如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwSqy92ABbv0PNxjhQibLELIHSAszgT0KnJ1D0IMWru8yKctC8cUXBcPQ/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 203px !important; height: 79px !important;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">其域成员Flink指向另一个进程的LIST_ENTRY域；因此，通过该指针索引并替代域成员的偏移，我们可以得到指向另一个进程的EPROCESS结构的指针。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">然后，我们需要获取PID值（对应于域成员UniqueProcessId），并将其与System进程的特有PID进行比对；PID值在EPROCESS结构中的位置如图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mwph2jeTgy2oVRMOo89nJeT9LCia1T4X9SgBGnCgZ2kqYQhque4zzjtjQ/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 266px !important; height: 134px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">漏洞利用中对应以上过程的代码片段，如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mwj6ia7qRWsNic9Vj5CxZwEPmBTlYPGmgiaSuQJiclcIyOeksjGiaCpKfva9w/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 139px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">在获取我们的进程和System进程的EPROCESS结构之后，我们就可以将凭证从一方复制到另一方。在以下代码中，引用计数并没有保留（如下图所示）。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwuHHHbdIqgBFJvo39TqNw8rMuHDV0yGPWCaJe5htiazh06UPcOAGZ73A/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 75px !important;"><span style="font-size: 15px;">使用WinDbg调试器查看特定域成员的偏移非常方便，我们可以使用如下命令来显示指定结构的具体定义：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">dt&nbsp;nt!&lt;structure&nbsp;name&gt;</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">例如：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">dt&nbsp;nt!_KPCR</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">结果如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mwo0GjCfiaEcPT2Mto7LAaWmgdWcYy7aSjsMdbfLnc2CYou9nQLGf2zxw/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 544px !important; height: 466px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">之后执行如下命令：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">dt&nbsp;nt!_KPRCB</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">结果如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mwlbiab3wpLa3iahPyic19UDYgkicHiaLK7g0Z9xEs4BEQL9FO4cx9kkMmHRw/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 357px !important; height: 56px !important;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">因此，计算可得_KTHREAD的偏移为&nbsp;0x120 + 0x004 = 0x124。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">代码片段中给出上述偏移，如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mwn96eDpKlgNce2MMpdA9Z7yptzbHJvMRicV0p5P7FwvA94llvL6jKMow/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 43px !important;"></p><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;"><strong>编写载荷</strong></span></p></section><p><br></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">正如HEVD中的漏洞利用代码（网址：</span><span style="font-size: 15px;">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Exploit/Payloads.c#L63</span><span style="font-size: 15px;">&nbsp;）所演示的那样，我们可以使用内嵌汇编（封装于C/C++代码之中）来编写载荷代码。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">然而，在这种情况下，编译器将对我们的代码进行加工；如下图所示，代码前后添加了多余的前缀和后缀。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9Mwu31B002p9tzWEMDttVEPUIot6H9BogKicojHicyNOI00QrFM1YTPniaUw/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 235px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">这就是我们在执行返回之前，通过堆栈指针（ESP）加上12（0xC）字节的方式，从堆栈中移除多余的DWORD类型数据的原因，具体代码（网址：</span><span style="font-size: 15px;">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Exploit/Payloads.c#L94</span><span style="font-size: 15px;">&nbsp;）如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwSmwnLe11gdohZMv6Nw6kgiceQxeCNC26n1ragYaVcccYzemX6v9Zq1g/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 438px !important; height: 112px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">如果想避免麻烦，我们可以将函数声明为裸代码类型（更多内容详见网址：</span><span style="font-size: 15px;">https://msdn.microsoft.com/en-us/library/5ekezyy2.aspx</span><span style="font-size: 15px;">&nbsp;）；这可以通过在函数之前添加一个特殊声明来实现，例如如下代码（网址：</span><span style="font-size: 15px;">https://github.com/hasherezade/wke_exercises/blob/master/stackoverflow_expl/payload.h#L16</span><span style="font-size: 15px;">&nbsp;）：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">__declspec(naked)&nbsp;VOID&nbsp;TokenStealingPayloadWin7()</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">另一个选择是外部编译其汇编代码，例如使用NASM编译器；之后，我们可以将编译缓冲区内容导出为十六进制字符串。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">作为练习，我们还将对上述载荷代码加以细微的修改，使其能够保持引用次数不变，具体代码（网址：</span><span style="font-size: 15px;">https://github.com/hasherezade/wke_exercises/blob/master/stackoverflow_expl/shellc.asm</span><span style="font-size: 15px;">&nbsp;）如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwUibztRMdaqqajbIQQgia2rxcZlw0K1hgVU3USZDQTmVUKR9P7gdgzozQ/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 528px !important;"><br style="box-sizing: inherit;"></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">使用如下命令，编译代码：</span></p><blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 14px;">nasm.exe&nbsp;shellc.asm</span></p></blockquote><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="font-size: 15px;">然后，我们使用十六进制编辑器打开编译结果，并复制字节；某些十六进制编辑器（比如HxD）甚至支持以特定编程语言的数组格式来复制数据，如下图所示。</span></p><p style="margin: 15px 1em; text-align: justify; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HObKKYicp5LY9csvicK6z9MwmhiaicYxlb5MbpzOT3opCdiabD6RaSVQ089KPWic6nPZJexT7iaDbAd1ywg/0?wx_fmt=png" style="box-sizing: inherit; border-style: none; vertical-align: middle; width: 554px !important; height: 260px !important;"></p><p style="margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">在我针对HEVD的栈溢出漏洞利用示例中，你可以找到内嵌和外部编译两个版本的载荷代码，具体代码网址：</span><span style="font-size: 15px;">https://github.com/hasherezade/wke_exercises/tree/master/stackoverflow_expl</span><span style="font-size: 15px;">，编译后代码网址：</span><span style="font-size: 15px;">https://drive.google.com/open?id=0Bzb5kQFOXkiSWTJOS2VZZ0JiU3c</span><span style="font-size: 15px;">。</span></p><p style="margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">利用该漏洞的细节将在下一部分详细介绍，也可以阅读附录中所提到的Osanda和Sam的文章。</span></p><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: center; line-height: 1.75em;"><span style="max-width: 100%; font-size: 14px; color: rgb(136, 136, 136); box-sizing: border-box !important; overflow-wrap: break-word !important;">本文由 看雪翻译小组<span class="" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">&nbsp;木无聊偶</span>&nbsp;编译，来源</span>&nbsp;<span style="max-width: 100%; font-size: 15px; color: rgb(136, 136, 136); box-sizing: border-box !important; overflow-wrap: break-word !important;">hasherezade's 1001 nights</span></p><p style="max-width: 100%; min-height: 1em; text-align: center; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; color: rgb(136, 136, 136); box-sizing: border-box !important; overflow-wrap: break-word !important;">转载请注明来自看雪论坛<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; text-align: center; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; color: rgb(255, 104, 39); box-sizing: border-box !important; overflow-wrap: break-word !important;">如果你喜欢的话，不要忘记点个赞哦！</span><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">热门阅读文章：<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283801&amp;idx=3&amp;sn=7b7133c3b9e03a2d3a3110f505655a56&amp;chksm=b1815f9386f6d685d472ab31664b6b46df80402db1c21dd9e6947dec12984554181454a5c1f1&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">从内核角度分析 Dirty Cow 原理</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283731&amp;idx=2&amp;sn=7607156e89c10583d4fc3402eb2f9871&amp;chksm=b1815e5986f6d74f401a562ca55e7af38b3c2de32d489dc221955f4f721c32204afb78e3b002&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">来自内部的威胁以及如何防御</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283717&amp;idx=1&amp;sn=76b71e037f1582b430ec7b72ac2eacf5&amp;chksm=b1815e4f86f6d759d89b72279c639555607077b74cb933035593187bec6209671d531b042b09&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">硬盘 LED 灯中泄露的数据 （一）</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283725&amp;idx=2&amp;sn=5f47edc0822653fb64508ee807efaacc&amp;chksm=b1815e4786f6d751a61088e8514eee5cdfb737ecacbb057e1e65fa3aa32d2ed6a2de9007b5e8&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">硬盘 LED 灯中泄露的数据 （二）</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170); box-sizing: border-box !important; overflow-wrap: break-word !important;">关注看雪学院公众号</span>”查看！</span></p><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbp7wPVAEujKLHZQicNHsdY9rLP72MmjtDsEjIfRIs36EezoZj3S4a4Qsw/640?wx_fmt=jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 427px !important;"></p><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="max-width: 100%; min-height: 1em; letter-spacing: 0.5px; box-sizing: border-box !important; overflow-wrap: break-word !important; margin: 15px 1em; text-align: justify; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">商务合作：wsc@kanxue.com<br></span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499656441&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvWzQOeuhSoNW9OwNWgZNLWSYC6qMb3ZXn30HCkumczAHebEjZwV6NvKvUTZHIhDAT8gt2W4ByfMtwo08CaZcDNOFveLLAs7eI6j*LT9IgnslhdlWjJZPQwyY0qDa0eR5XKjZrENq5K4vCmqP92xIfy7A=">微信地址</a> | <a href="http://bbs.pediy.com/thread-218963.htm">阅读原文</a>
{% endraw  %}

