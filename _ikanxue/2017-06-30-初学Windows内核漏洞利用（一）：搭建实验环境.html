---
title: 初学Windows内核漏洞利用（一）：搭建实验环境
author: 木无聊偶
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499131012&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ62YXf1MWi8Zh8usUjq2T6Tp8olMm-6I1I4qsl-rYUzkEslKlH6cxolxoLxftDKuPmi**P8zPtt9kTSw5*Iu27rWojL-RapRHiLWBQm8oOcn7HhyrQAIlbxq9gEw*V6Ss5HFiXo2u4uKFouhRBqq4yI=
date: '2017-06-30 00:00:00 +0000'

---

{% raw  %}
<p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">最近我刚刚开始学习Windows内核漏洞利用，决定以博客的形式分享一些我的学习心得。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">本部分主要是关于搭建实验环境；接下来的部分我计划介绍一下如何使用Ashfaq
 Ansari 所开发的“HackSys Extreme Vulnerable 
Driver”（HEVD，项目网址为：https://github.com/hacksysteam/HackSysExtremeVulnerableDriver）来做一些练习。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">希望对大家有所帮助！</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><section label="Copyright Reserved by PLAYHUDONG." style="padding: 0.5em 1em; border-style: none; background: rgb(235, 235, 235) none repeat scroll 0% 0%;"><section style="padding: 16px; line-height: 2.4;"><span style="font-size: 15px;">本文中我所用的环境如下：</span><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">使用Kali Linux作为主机系统（当然，你可以选择你所偏好的任何系统）；</span></p></li><li><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">VirtualBox虚拟机软件（下载网址：</span><span style="font-size: 15px;">https://www.virtualbox.org/</span><span style="font-size: 15px;">）；</span></p></li><li><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">2台虚拟机，操作系统为Windows 7(32位)，且都安装了Virtual Guest Additions工具（译者注：类似于VMware Workstation上的VMTools）——其中一台虚拟机用作调试方，另一台作为被调试方；</span></p></li><li><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">WinDbg调试器（可以在Windows SDK中找到，下载网址：</span><span style="font-size: 15px;">https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk</span><span style="font-size: 15px;">）。</span></p></li></ul></section></section><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;"></span><span style="font-size: 15px;">当我们进行用户级的调试时，调试方与被调试方在同一台机器上；而在内核级调试的情况下这不可能，因为我们需要对被调试的操作系统进行完全控制（即，如果我们中断程序执行，整个系统都将冻结）。这就是为什么我们需要两台虚拟机扮演不同的角色。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 18px; background-color: rgb(0, 0, 0); color: rgb(255, 251, 0);"><strong>建立调试方</strong></span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">调试方是指我们用于监视被调试方的机器；因此，我们需要在上面安装WinDbg调试器，并配置符号以解析系统结构。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">为了安装WinDbg调试器，我们需要下载Windows
 
SDK（下载网址：https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk）；根据Windows系统版本，有时我们还需要安装一些必要的更新。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">在安装选项中，必须选择调试工具，如下图所示。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpHuCOweRib2lDfpAP28HG38wPibuNCRWakmiblpop5G6GMhcjg3SE8gQkA/0?wx_fmt=jpeg" style="width: 554px !important; height: 405px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">WinDbg调试器安装后，我们应该添加符号；为此，我们只需要添加一个环境变量“_NT_SYMBOL_PATH”，WinDbg调试器将自动引用该变量。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后使用能够下载符号的链接为其赋值，如下所示：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">https://msdl.microsoft.com/download/symbols</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">完整的变量内容看起来就像这样（含义：下载的符号将存储于C:\Symbols文件夹中）：</span></p><blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">SRV*C:\Symbols*https://msdl.microsoft.com/download/symbols</span></p></blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><strong><span style="background-color: rgb(0, 0, 0); color: rgb(255, 251, 0); font-size: 18px;">建立被调试方</span></strong></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">我们需要配置被调试方，使其能够被外部控制。为此，我们在启动菜单中添加一个额外选项；当我们以该配置启动系统时，将启用调试功能。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp; &nbsp; 我们需要用到一个工具“bcdedit”。首先，我们将当前设置复制到一个新的选项，比方说名为“Debug me”。具体命令格式如下：</span></p><blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">bcdedit&nbsp;/copy&nbsp;{current}&nbsp;/d&nbsp;"Debug&nbsp;me"</span></p></blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">该命令将返回一个新选项的GUID，我们需要复制并开启该选项的调试功能。具体命令格式如下：</span></p><blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">bcdedit&nbsp;/debug&nbsp;{MY_GUID}&nbsp;on</span></p></blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">最后，我们可以看一下调试接口可用的设置，具体命令如下：</span></p><blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">bcdedit&nbsp;/dbgsettings</span></p></blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">在调试方与被调试方之间建立连接</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">调试方与被调试方将通过串行端口COM1进行通信，而该串口是通过主机系统上的命名管道仿真实现的。配置非常简单，我们只需要保证调试方与被调试方具有相同的管道命名集合。调试方创建管道，之后被调试方连接已存在的管道（这就是必须先运行调试方的原因）。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">我使用Linux系统作为主机系统，因此选择管道名称如下：</span></p><blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">/tmp/wke_pipe</span></p></blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">请注意，如果你使用Windows系统作为主机系统，你的管道名称应该遵循不同的约定，例如：</span></p><blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">\\.\pipe\wke_pipe</span></p></blockquote><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">更多内容请参阅网址：</span><span style="font-size: 15px;">https://en.wikipedia.org/wiki/Named_pipe</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="color: rgb(255, 251, 0); background-color: rgb(0, 0, 0); font-size: 18px;"><strong><span style="color: rgb(255, 251, 0); background-color: rgb(0, 0, 0);">测试连接</span></strong></span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">万事俱备，现在我们只需要测试环境是否正确运行！首先启动调试方，运行WinDbg，然后让其等待被调试方的连接。例如：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">“文件”菜单 -&gt; “内核模式调试”选项，如下图所示。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpH3YK2GclnGXVEEytBt9UFRqlNt5nHUzDrGGVUHRQtD5JcEfYvEhaMw/0?wx_fmt=png" style="width: 292px !important; height: 236px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">选择COM作为接口，如下图所示。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpCJ3tPvOMRN4kCShFIPXzBgnsiaRNryfEVKVUAZZUjQQFPrpXA8HSExA/0?wx_fmt=png" style="width: 409px !important; height: 295px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后我们运行被调试方主机；当确定被调试方连接到管道时，我们可以将其中断。例如：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">被调试方连接上管道，如下图所示。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpiaZqNLjQPnHMtJT6LGOInhaibuUqEyt0jZic4SPoEsMtXFwxic4SEu1WKA/0?wx_fmt=jpeg" style="width: 554px !important; height: 317px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">现在我们可以将其中断，选择“调试”菜单 -&gt; “中断”选项，如下图所示。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpWgCD5QqM55vwBHmjW6cd5QPDI6ltibd1icxIUy9wJVjIdpHIBL9GsXibg/0?wx_fmt=png" style="width: 317px !important; height: 181px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">当命令行窗口提示符为“kd”时，代表我们正控制着被调试方，如下图所示。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpJZk3Y3ktaWicRspxmuxQiaFyAkbhzEBGSCY8lt8KbH14RNBvOVBHUMvA/0?wx_fmt=jpeg" style="width: 554px !important; height: 250px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">此时被调试方被冻结，等待着调试方的命令。通过运行“g”命令，我们可以释放被调试方并使其继续运行，如下图所示。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpiawFGXI4t8z5kvGM7hoZsicMPF1cia87fxKmuzYl4hEfsHibC42wd7Y2ZA/0?wx_fmt=png" style="width: 337px !important; height: 103px !important;"><br></p><p style="text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="font-size: 14px; color: rgb(136, 136, 136);">本文由 看雪翻译小组<span class=""> 木无聊偶</span> 编译，来源</span> <span style="font-size: 15px; color: rgb(136, 136, 136);">hasherezade's 1001 nights</span></p><p style="text-align: center; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(136, 136, 136);">转载请注明来自看雪论坛<br></span></p><p style="text-align: center; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(255, 104, 39);">如果你喜欢的话，不要忘记点个赞哦！</span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">热门阅读文章：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283801&amp;idx=3&amp;sn=7b7133c3b9e03a2d3a3110f505655a56&amp;chksm=b1815f9386f6d685d472ab31664b6b46df80402db1c21dd9e6947dec12984554181454a5c1f1&amp;scene=21#wechat_redirect" target="_blank">从内核角度分析 Dirty Cow 原理</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283731&amp;idx=2&amp;sn=7607156e89c10583d4fc3402eb2f9871&amp;chksm=b1815e5986f6d74f401a562ca55e7af38b3c2de32d489dc221955f4f721c32204afb78e3b002&amp;scene=21#wechat_redirect" target="_blank">来自内部的威胁以及如何防御</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283717&amp;idx=1&amp;sn=76b71e037f1582b430ec7b72ac2eacf5&amp;chksm=b1815e4f86f6d759d89b72279c639555607077b74cb933035593187bec6209671d531b042b09&amp;scene=21#wechat_redirect" target="_blank">硬盘 LED 灯中泄露的数据 （一）</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283725&amp;idx=2&amp;sn=5f47edc0822653fb64508ee807efaacc&amp;chksm=b1815e4786f6d751a61088e8514eee5cdfb737ecacbb057e1e65fa3aa32d2ed6a2de9007b5e8&amp;scene=21#wechat_redirect" target="_blank">硬盘 LED 灯中泄露的数据 （二）</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbp7wPVAEujKLHZQicNHsdY9rLP72MmjtDsEjIfRIs36EezoZj3S4a4Qsw/0?wx_fmt=jpeg" style="visibility: visible !important; width: 640px !important; height: 427px !important;"></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499131012&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ62YXf1MWi8Zh8usUjq2T6Tp8olMm-6I1I4qsl-rYUzkEslKlH6cxolxoLxftDKuPmi**P8zPtt9kTSw5*Iu27rWojL-RapRHiLWBQm8oOcn7HhyrQAIlbxq9gEw*V6Ss5HFiXo2u4uKFouhRBqq4yI=">微信地址</a> | <a href="http://bbs.pediy.com/thread-218838.htm">阅读原文</a>
{% endraw  %}

