---
title: 简单看一下 微软新出的内核页表隔离补丁
author: hzqst
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1515984875&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siPPs-NRfvlwjuvH7xFTtLmsOPyUEuRfepE4lmADgDB-KqTGJpoTQDDroKcwkYhW3KfPQA2LmcnhzlStTbBD7vSvFmOwMowo3b4SIrWjf0URKQjjxRURCzyc8I*d7QWJoviwKUPQ9G1mpFqj3M9pxIIQ=
date: '2018-01-09 00:00:00 +0000'

---

{% raw  %}
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8EX9OJYs6GSgGYhMzeXh6ffNSqARBesQn89kiaA48QquZDSWtCpHYV6wAAc3v5qx2pJX3IOEibSQ85g/0?wx_fmt=jpeg" style="width: 770px !important; height: 433.125px !important;"></p><p style="text-align: right;"><span style="font-size: 15px;color: rgb(136, 136, 136);letter-spacing: 2px;"><br></span></p><p style="text-align: right;"><span style="font-size: 15px;color: rgb(136, 136, 136);letter-spacing: 2px;">文 | hzqst</span></p><p style="text-align: right;"><span style="font-size: 15px;color: rgb(136, 136, 136);letter-spacing: 2px;">看雪论坛</span></p><p><br></p><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">相比以往的内核多了一套用户层专用的页表，里面没有内核内存的映射（除了几个r3进r0的入口）</span></p><p><br style="box-sizing: inherit;"></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">KiEnableKvaShadowing由KiInitializeBootStructures和KxInitializeProcessorState调用，应该只初始化一次</span></p><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">signed&nbsp;__int64&nbsp;__fastcall&nbsp;KiEnableKvaShadowing(__int64&nbsp;a1,&nbsp;__int64&nbsp;a2)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v3;&nbsp;//&nbsp;rdx@3</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v4;&nbsp;//&nbsp;rcx@3</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v5;&nbsp;//&nbsp;r8@3</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;char&nbsp;v6;&nbsp;//&nbsp;al@4</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;signed&nbsp;__int64&nbsp;v7;&nbsp;//&nbsp;r9@8</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;signed&nbsp;__int64&nbsp;v8;&nbsp;//&nbsp;r10@8</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;signed&nbsp;__int64&nbsp;v9;&nbsp;//&nbsp;rdx@8</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;signed&nbsp;__int64&nbsp;v10;&nbsp;//&nbsp;rcx@10</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;unsigned&nbsp;__int64&nbsp;v15;&nbsp;//&nbsp;rax@14</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v16;&nbsp;//&nbsp;rdx@15</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;signed&nbsp;__int64&nbsp;result;&nbsp;//&nbsp;rax@21</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;_RBX&nbsp;=&nbsp;a1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;if&nbsp;(&nbsp;!(unsigned&nbsp;__int8)KiIsKvaShadowDisabled()&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;(unsigned&nbsp;__int8)KiIsKvaLeakSimulated()&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v6&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KiKvaLeakageSimulate&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v6&nbsp;=&nbsp;KiKvaLeakageSimulate;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!KiKvaLeakage&nbsp;&amp;&amp;&nbsp;!v6&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)(v4&nbsp;+&nbsp;28288)&nbsp;=&nbsp;__readcr3();</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;=&nbsp;v3&nbsp;+&nbsp;4132;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;7i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)(v3&nbsp;+&nbsp;4216)&nbsp;=&nbsp;*(_QWORD&nbsp;*)(v3&nbsp;+&nbsp;4100);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)(v3&nbsp;+&nbsp;4100)&nbsp;=&nbsp;v3&nbsp;+&nbsp;16896;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;=&nbsp;v3&nbsp;+&nbsp;17376;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;do</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_QWORD&nbsp;*)v7&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;*(_QWORD&nbsp;*)v7&nbsp;-&nbsp;32i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)v9&nbsp;=&nbsp;_RBX&nbsp;-&nbsp;384;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)(v9&nbsp;+&nbsp;8)&nbsp;=&nbsp;v10;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)v10&nbsp;=&nbsp;v9;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)v7&nbsp;=&nbsp;v9;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;+=&nbsp;512i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;+=&nbsp;8i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--v8;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(&nbsp;v8&nbsp;);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_DWORD&nbsp;*)(_RBX&nbsp;+&nbsp;36)&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;KiShadowProcessorAllocation(_RBX,&nbsp;v5);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!(_DWORD)result&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_DWORD&nbsp;*)(_RBX&nbsp;+&nbsp;28312)&nbsp;|=&nbsp;2u;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_23;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;KiInitializeIdt(v5,&nbsp;1);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;*(_BYTE&nbsp;*)(*(_QWORD&nbsp;*)(*MK_FP(__GS__,&nbsp;392i64)&nbsp;+&nbsp;184i64)&nbsp;+&nbsp;703i64)&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;byte_1403BFBFF&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;KiSetAddressPolicy(_CF,&nbsp;_ZF,&nbsp;_SF,&nbsp;_OF,&nbsp;1);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_QWORD&nbsp;*)(_RBX&nbsp;+&nbsp;25192)&nbsp;&amp;&nbsp;0x40000000000i64&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v15&nbsp;=&nbsp;__readcr4()&nbsp;&amp;&nbsp;0xFFFFFFFFFFFFFF7Fui64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_bittestandset(&amp;v15,&nbsp;0x11u);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__writecr4(v15);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__writecr3(__readcr3()&nbsp;|&nbsp;2);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KiFlushPcid&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;HvlRescindEnlightenments(0x40000000000i64,&nbsp;-129i64);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;KiKvaShadow&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;KiFlushPcid&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_BYTE&nbsp;*)(_RBX&nbsp;+&nbsp;1597)&nbsp;!=&nbsp;1&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">LABEL_20:</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KiKvaShadowMode&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">LABEL_23:</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;KiFlushPcid&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__asm&nbsp;{&nbsp;lock&nbsp;bts&nbsp;qword&nbsp;ptr&nbsp;[rbx+6E80h],&nbsp;3Fh&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(&nbsp;*(_BYTE&nbsp;*)(_RBX&nbsp;+&nbsp;1597)&nbsp;!=&nbsp;1&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;KiKvaShadowMode&nbsp;=&nbsp;2;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__writecr4(v16&nbsp;&amp;&nbsp;__readcr4());</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_20;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;KiIsKvaShadowConfigDisabled&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;return&nbsp;1i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">关键代码</span></p><p><br></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">signed&nbsp;__int64&nbsp;__fastcall&nbsp;KiShadowProcessorAllocation(__int64&nbsp;a1,&nbsp;__int64&nbsp;a2)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v2;&nbsp;//&nbsp;rsi@1</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v3;&nbsp;//&nbsp;rdi@1</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;signed&nbsp;int&nbsp;v5;&nbsp;//&nbsp;ebx@4</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v6;&nbsp;//&nbsp;rax@6</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;__int64&nbsp;v7;&nbsp;//&nbsp;rax@6</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v8;&nbsp;//&nbsp;edx@6</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;v2&nbsp;=&nbsp;a2;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;v3&nbsp;=&nbsp;a1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;if&nbsp;(&nbsp;!KiKvaShadow&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;if&nbsp;(&nbsp;MmCreateShadowMapping(a2,&nbsp;20480i64)&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;0;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;MmCreateShadowMapping(v3&nbsp;+&nbsp;28288,&nbsp;4096i64)&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_DWORD&nbsp;*)(v3&nbsp;+&nbsp;36)&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LODWORD(v6)&nbsp;=&nbsp;RtlImageNtHeader(0x140000000i64);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LODWORD(v7)&nbsp;=&nbsp;RtlSectionTableFromVirtualAddress(</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v6,</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x140000000i64,</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(unsigned&nbsp;int)KiDivideErrorFaultShadow&nbsp;-&nbsp;0x40000000);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;*(_DWORD&nbsp;*)(v7&nbsp;+&nbsp;16);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_DWORD&nbsp;*)(v7&nbsp;+&nbsp;8)&nbsp;&gt;&nbsp;v8&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;*(_DWORD&nbsp;*)(v7&nbsp;+&nbsp;8);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;MmCreateShadowMapping(*(_DWORD&nbsp;*)(v7&nbsp;+&nbsp;12)&nbsp;+&nbsp;0x140000000i64,&nbsp;(v8&nbsp;+&nbsp;4095)&nbsp;&amp;&nbsp;0xFFFFF000)&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;MmDeleteShadowMapping(v2,&nbsp;20480i64);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v5&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MmDeleteShadowMapping(v3&nbsp;+&nbsp;28288,&nbsp;4096i64);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;return&nbsp;0i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">似乎是把 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">KiDivideErrorFaultShadow</span> 所在的section这几块内核内存单独拿出来创建了映射。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">刚好这一块都是idt和 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">syscall/sysenter </span>的入口，在<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">KVASCODE</span> 这个section里</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8EX9OJYs6GSgGYhMzeXh6ffNfU4AOkhsFrnluFS0dJeyOy1x9t3N1M90PaicM9CcHXQArkDhS9Nic5w/0?wx_fmt=png" style="width: 697px !important; height: 583px !important;"></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">当然IDT要用shadow的那份</span></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);font-size: 12px;letter-spacing: normal;">KiInitializeIdt(v5, TRUE);</span><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br style="box-sizing: inherit;"></span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">第二个参数应该就是是否使用<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">shadow idt</span></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">然后根据cpu是否有flushpcid功能（KiFlushPcid）选择shadow的方式 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">KiKvaShadowMode = 1 or 2？</span></span></p><p><br style="box-sizing: inherit;"></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">然后看一下 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">sysenter</span> 的入口，内核页表应该是被放在了 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">gs:7000h</span> 里面，太简单了不做分析，jmp后的流程和以前老<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;"> Systemcall</span> 是一样的</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8EX9OJYs6GSgGYhMzeXh6ffKI439GULcBfFwicy1xT6qIO7NbfKn9kkStQ2RhbL4WJZQkJk1GVqk2g/0?wx_fmt=png" style="width: 684px !important; height: 527px !important;"></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">随便挑了个中断分析了下</span></p><p><br style="box-sizing: inherit;"></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8EX9OJYs6GSgGYhMzeXh6ffwWz7AR1Zx8ibE8EhHguVfEszz4QBuSK1qT42fYmhz2psaicIURlxEs9w/0?wx_fmt=png" style="width: 770px !important; height: 330.837px !important;"></p><p><br style="box-sizing: inherit;"></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">然后是 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">AttachProcess</span> 的时候也加了一些特技（以前就一句writecr3）</span></p><p style="margin-left: 8px;margin-right: 8px;"><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8EX9OJYs6GSgGYhMzeXh6ffCK6lf8KWmGoWHoLu7XqDtK5DJewNwr3rSNFLFxaic1cN46ZibzianVOZg/0?wx_fmt=jpeg" style="width: 554px !important; height: 48.0193px !important;"></p><p><br></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">void&nbsp;__fastcall&nbsp;KiLoadDirectoryTableBase(PEPROCESS&nbsp;ProcessObj,&nbsp;unsigned&nbsp;__int64&nbsp;DirTableBase)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;unsigned&nbsp;__int64&nbsp;NewCr3;&nbsp;//&nbsp;rbx@1</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;unsigned&nbsp;__int64&nbsp;v3;&nbsp;//&nbsp;rax@2</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;bool&nbsp;v4;&nbsp;//&nbsp;zf@2</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;bool&nbsp;v5;&nbsp;//&nbsp;sf@2</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;unsigned&nbsp;__int64&nbsp;v6;&nbsp;//&nbsp;rcx@10</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;unsigned&nbsp;__int64&nbsp;v7;&nbsp;//&nbsp;rax@11</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;NewCr3&nbsp;=&nbsp;DirTableBase;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;if&nbsp;(&nbsp;KiKvaShadow&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;=&nbsp;DirTableBase;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v4&nbsp;=&nbsp;(DirTableBase&nbsp;&amp;&nbsp;2)&nbsp;==&nbsp;0;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;(DirTableBase&nbsp;&amp;&nbsp;2&nbsp;&amp;&nbsp;0x80u)&nbsp;!=&nbsp;0i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;DirTableBase&nbsp;&amp;&nbsp;2&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;=&nbsp;DirTableBase&nbsp;|&nbsp;0x8000000000000000ui64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v4&nbsp;=&nbsp;(DirTableBase&nbsp;|&nbsp;0x8000000000000000ui64)&nbsp;==&nbsp;0;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;((DirTableBase&nbsp;|&nbsp;0x8000000000000000ui64)&nbsp;&amp;&nbsp;0x8000000000000000ui64)&nbsp;!=&nbsp;0i64;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;*MK_FP(__GS__,&nbsp;28672i64)&nbsp;=&nbsp;v3;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;KiSetAddressPolicy(0,&nbsp;v4,&nbsp;v5,&nbsp;0,&nbsp;ProcessObj-&gt;Pcb.AddressPolicy);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;if&nbsp;(&nbsp;HvlEnlightenments&nbsp;&amp;&nbsp;1&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;HvlSwitchVirtualAddressSpace(NewCr3);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;else</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__writecr3(NewCr3);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;if&nbsp;(&nbsp;KiKvaShadow&nbsp;&amp;&amp;&nbsp;!KiFlushPcid&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;v6&nbsp;=&nbsp;__readcr4();</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v6&nbsp;&amp;&nbsp;0x20080&nbsp;)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;=&nbsp;v6;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_bittestandcomplement(&amp;v7,&nbsp;7u);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__writecr4(v7);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__writecr4(v6);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__writecr3(__readcr3());</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;}</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">页表还是 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">EPROCESS</span> 里那个页表，只不过看起来是把 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">KvaShadow</span> 暂时禁用了（不然一切换cr3 &nbsp;内核地址空间全没了 直接炸穿） <br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">Detach 的时候也是直接调用的 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">KiLoadDriectoryTableBase</span>，被内联了</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8EX9OJYs6GSgGYhMzeXh6ffwVK5bDIPjxwRcMJ4DvQcmicyQI9nLuvLiakQkkwicUSlo5M9ibdeqe4kwg/0?wx_fmt=png" style="width: 770px !important; height: 511.184px !important;"></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">暂时就先看这么多，如果还有新的欢迎补充</span></p><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: 2px;">原文链接：<span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">https://bbs.pediy.com/thread-223805.htm</span></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;text-align: center;"><span style="font-size: 15px;letter-spacing: 2px;color: rgb(79, 79, 79);">更多详情可参考看雪论坛专题帖：</span><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;text-align: center;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">详情戳左下角“阅读原文”<br></span></p><section label="Copyright © 2014 playhudong All Rights Reserved." style="border-color: currentcolor;border-style: none;border-width: medium;-moz-border-top-colors: none;-moz-border-left-colors: none;-moz-border-bottom-colors: none;-moz-border-right-colors: none;margin: 5px 0px 0px;padding: 10px 0px;background: rgba(0, 0, 0, 0) none repeat scroll 0% 0%;"><img src="http://mmbiz.qpic.cn/mmbiz_gif/1UG7KPNHN8EEkOg6CuibnF1kka3lLuxFPOW3ibZV5ibiaSNMyMQgLfqKGuxlkh0Vxsk96zCMKRnhY990aic6H3vrFKQ/0?wx_fmt=gif" style="margin: 0px auto; display: block; visibility: visible !important; width: 22px !important; height: 10px !important;"><span style="font-size: 15px;letter-spacing: 2px;color: rgb(79, 79, 79);"></span></section><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></span></p><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">热门阅读</span></p><ul class=" list-paddingleft-2" style=""><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287349&amp;idx=1&amp;sn=0763551bb2121d1aa1200a46c2483d09&amp;chksm=b1814c7f86f6c5690de4c83aa499c85bcc36f5177bf707fdffc6d43a845d4a5bed67d587cb9c&amp;scene=21#wechat_redirect" target="_blank">曝出 CPU 严重设计缺陷后，Intel 如坐针毡</a></span></p></li><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287387&amp;idx=1&amp;sn=7db4fde79062d898f320a2cf51c81b96&amp;chksm=b1814d9186f6c487819de2f734da7aa3e2797f46ef339752b037f5eaa29ae27ea55ea20ce2fe&amp;scene=21#wechat_redirect" target="_blank">解读计算机处理器之殇 - Meltdown 与 Spectre</a></span></p></li><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287391&amp;idx=2&amp;sn=36b62672417c3c56a1d8fb23c378eb83&amp;chksm=b1814d9586f6c483d25fb5a6c5e1654751476feedb40617587cdd878fa7bfafd2784eea05980&amp;scene=21#wechat_redirect" target="_blank">方法 | 在Windows系统上修复Meltdown和Specture CPU漏洞</a></span></p></li><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287391&amp;idx=2&amp;sn=36b62672417c3c56a1d8fb23c378eb83&amp;chksm=b1814d9586f6c483d25fb5a6c5e1654751476feedb40617587cdd878fa7bfafd2784eea05980&amp;scene=21#wechat_redirect" target="_blank"></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287415&amp;idx=1&amp;sn=dba14b0b922e4577028ccab4bc6d1451&amp;chksm=b1814dbd86f6c4ab6df058462e0147f59ab8757ab3e65f5fdf6b3058d8d65d146cf4c04a32a6&amp;scene=21#wechat_redirect" target="_blank">通俗理解这次的CPU漏洞，附带修改过带注释源码一份</a></span></p></li></ul><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"></span><br></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">点击阅读原文/read，</span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">更多干货等着你~</span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><img src="https://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HTpGlibXdQ4YIynJnSjWwOjSroH8JkP00Cpl0TvGwSCibJpPmSmcartSbQUfodq49ulaLk1Yicrem3A/?wx_fmt=jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 542px !important; height: 136.065px !important;"></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1515984875&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siPPs-NRfvlwjuvH7xFTtLmsOPyUEuRfepE4lmADgDB-KqTGJpoTQDDroKcwkYhW3KfPQA2LmcnhzlStTbBD7vSvFmOwMowo3b4SIrWjf0URKQjjxRURCzyc8I*d7QWJoviwKUPQ9G1mpFqj3M9pxIIQ=">微信地址</a> | <a href="https://bbs.pediy.com/thread-223805.htm">阅读原文</a>
{% endraw  %}

