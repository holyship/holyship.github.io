---
title: Hips篇高操之正确的全局Patch/拦截模块姿势
author: FaEry
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496016642&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgG9Oe2Y4Txgw7FIHUz2sSP2AphHbOB7c*JU7liblQGWtMVZen7MuttjQKfDcEubrQPUtfJJ1qRjxuroisIqOYbDZ7sWxmA82ae49qEc-dIxs9NWt00LYYg310Em3isWet7n-9ca8Ft5o2-gwAUWZppE=
date: '2017-05-27 00:00:00 +0000'

---

{% raw  %}
<p style="line-height: 1.75em;"><span style="font-size: 15px;">潜水了两个月，由于工作的关系没有什么多余的时间发新帖了，由于临近端午准备休息一下，<span style="line-height: 23px;">于是乎决定在周末搞点事情，</span>恰逢北京今日又下起雨来，在这朦朦胧胧的雨天里给大家呈上一份 Hips 的高端操作，让大家燃一下。</span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 15px;">这也是初入安全时我一直想实现的一个东西，但是由于当时技术局限，很菜，其实今天来看只是当时没有找到好的学习方法，没有办法实现很是遗憾。然而今日在团队的带领下，我改进了自己的学习方法，学会了如何有效看待问题分析问题以及解决问题。在此感谢我的导师以及 leader。</span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 15px;">这个一直想实现的东西就是用驱动拦截模块，看似很简单的一个问题但是实际上要操作起来并非易事，要看得懂代码，得先理解了这张图：</span></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/7982fbe72a0021263cadd0754b824fed5783af19.png" style="width: 770px !important; height: 442.75px !important; visibility: visible !important;">																					</p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 15px;">可以看到，调用API加载模块的时候最后都逃不过ntdll!ZwMapViewOfSection，最后进入系统调用然后触发模块回调，我们唯一能做的就是在模块回调里干一些猥琐的事情。直接Patch？那是不可能的，因为模块回调有限制，这时候有EProcess.AddressCreationLock的限制不说，模块还未能初始化完成，直接去搞肯定是不正确的做法。那么可以想到的是用Apc延迟去Patch模块，因为在ZwMapViewOfSection在内核中最后会返回至Ring3，在返回的过程中调用Apc去Patch这样就完美了。</span></p><p><br></p><p style="line-height: 1.75em;"><span style="font-size: 15px;">话又说回来，模块回调中为每一个模块都插一个Apc？ 这显然也不现实，因此这种方法最好是有一个Ring3层进程来<span style="font-size: 15px; color: rgb(255, 0, 0);">制定策略</span>，<span style="font-size: 15px; color: rgb(255, 0, 0);">指定对哪一个进程加载哪一个模块时执行哪种Patch操作</span>。<span style="font-size: 15px; line-height: 1.7;">那么这就涉及到Ring0与Ring3的通信问题。说到这里就有三种方法可供选择，一种是LPC（ZwConnetPort...），一种是内核可等待对象，还有一种就是Minifilter的双向通信机制。</span></span></p><p><br></p><p style="line-height: 1.75em; margin-bottom: 10px;"><span style="font-size: 15px;">当然，我选择的是最后一种，现在貌似运用这种方法做通信的不多，我也没怎么接触过，一切都是从0开始，那就试试吧...</span></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/68feb0dfb5c7adaa28584354dc248bdf9e16c245.png" style="width: 477px !important; height: 624px !important;"></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/d055983eab1ea9e74432926492ec7912759e0b1c.png" style="width: 560px !important; height: 574px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 10px;"><span style="font-size: 15px;">首先由Ring3进程指定策略，这里拿金山的两个模块开刀：</span></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/1f1c676ae245b2e48c90ecc5f90d375a94bc93ea.png" style="width: 681px !important; height: 607px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">注册这个通信是奠定与Ring3进程通信的基础，应用层进程可以通过连接之后发送策略（即要对哪个进程的哪个模块进行监控），然后由模块回调在匹配策略之后对应用程序进行通知</span></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/d12b5a50ed6cedc88816f683687cd9cc6872e538.png" style="width: 621px !important; height: 624px !important;"></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/2b6f1ef4327fee76dcd464e714abf89feb4c7460.png" style="width: 770px !important; height: 456.984px !important;"></p><p style="line-height: 1.75em; margin-bottom: 15px; margin-top: 10px;"><span style="font-size: 15px;">这里一定要注意，FltSendMessage这个函数msdn上说的很清楚，如果RelpyData为NULL, 
只要是Ring3进程调用了FilterGetMessage取得了数据，那么这个函数不会再等待。而我们需要做的是在GetMessage之后发消息给驱动，让它为LoadImage这个当前线程插入Apc，那么在模块回调中必须卡死直到应用进程调用FilterRelpyMessage回应消息，否则这一次系统调用就返回了。</span></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/670e5689ba2de7c9289c90a9f84abc2c76fc0c98.png" style="width: 770px !important; height: 420.632px !important;"></p><p style="line-height: 1.75em; margin-bottom: 15px;"><span style="font-size: 15px;">Ring3 进程拿到模块监控数据之后决定对该模块采取什么样的 Patch 措施，然后将决定结果送达至 Ring0，这里我就以 <span style="font-size: 15px; line-height: 23px;">Patch </span>基地址即 DosHeader.e_magic 为例了。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 12px;">DWORD&nbsp;WINAPI&nbsp;FilterMessageProc(PVOID&nbsp;lpParam)</span></p><p style="line-height: normal;"><span style="font-size: 12px;">{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;FyLoadImageRecvDat&nbsp;Msg&nbsp;=&nbsp;{0};</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;FyReplyData&nbsp;ReplyMsg&nbsp;=&nbsp;{0};</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(TRUE)</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;bytesReturned&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;hResult;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCHAR&nbsp;buf[260]&nbsp;=&nbsp;{0};</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hResult&nbsp;=&nbsp;FilterGetMessage(</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_hPort,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(PFILTER_MESSAGE_HEADER)&amp;Msg,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sizeof(Msg),</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hResult&nbsp;==&nbsp;S_OK)&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;拿到当前正在映射的模块信</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Now&nbsp;can&nbsp;Send&nbsp;Patch&nbsp;Info</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FySendPatchInfoDat&nbsp;HipsData&nbsp;=&nbsp;{0};</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.MessageType&nbsp;=&nbsp;Lowlayer_Msg_BlockImage;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.Signature&nbsp;=&nbsp;FY_FSFILTER_SIGNATURE;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.DataLength&nbsp;=&nbsp;sizeof(FyPatchInfo);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.Data.PatchType&nbsp;=&nbsp;1;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.Data.ProcessId&nbsp;=&nbsp;Msg.Data.ProcessId;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.Data.ThreadId&nbsp;=&nbsp;Msg.Data.ThreadId;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.Data.PatchAddress&nbsp;=&nbsp;(ULONG64)Msg.Data.ImageBase;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD*)HipsData.Data.lpPatchContent&nbsp;=&nbsp;0x00905a4b;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HipsData.Data.PatchSize&nbsp;=&nbsp;4;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;don't&nbsp;wait</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterSendMessage(g_hPort,&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;HipsData,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sizeof(FySendPatchInfoDat),</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;bytesReturned);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Reply&nbsp;load&nbsp;image&nbsp;message</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReplyMsg.ReplyHeader.MessageId&nbsp;=&nbsp;Msg.MsgHeader.MessageId;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReplyMsg.ReplyHeader.Status&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ReplyMsg.Signature&nbsp;=&nbsp;FY_FSFILTER_SIGNATURE;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hResult&nbsp;=&nbsp;FilterReplyMessage(</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g_hPort,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(PFILTER_REPLY_HEADER)&amp;ReplyMsg,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sizeof(ReplyMsg));</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">}</span></p></blockquote><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">这里要提一点的是，32位进程与64位驱动通信的时候一定要注意结构体的对齐粒度，不然会吃大亏的...</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 12px;">NTSTATUS&nbsp;FyFsFilterMessage&nbsp;(</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;PVOID&nbsp;ConnectionCookie,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__in_bcount_opt(InputBufferSize)&nbsp;PVOID&nbsp;InputBuffer,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;ULONG&nbsp;InputBufferSize,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__out_bcount_part_opt(OutputBufferSize,*ReturnOutputBufferLength)&nbsp;PVOID&nbsp;OutputBuffer,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__in&nbsp;ULONG&nbsp;OutputBufferSize,</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;__out&nbsp;PULONG&nbsp;ReturnOutputBufferLength</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;)</span></p><p style="line-height: normal;"><span style="font-size: 12px;">{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;Status&nbsp;=&nbsp;STATUS_SUCCESS;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;Command;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;pContent&nbsp;=&nbsp;NULL;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;ContentLength&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;UINT32&nbsp;Signature;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;UNREFERENCED_PARAMETER(ConnectionCookie);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;PAGED_CODE();</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">#if&nbsp;defined(_WIN64)</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(IoIs32bitProcess(&nbsp;NULL&nbsp;))&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!IS_ALIGNED(OutputBuffer,sizeof(ULONG)))&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status&nbsp;=&nbsp;STATUS_DATATYPE_MISALIGNMENT;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Status;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">#endif</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!IS_ALIGNED(OutputBuffer,sizeof(PVOID)))&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Status&nbsp;=&nbsp;STATUS_DATATYPE_MISALIGNMENT;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Status;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">#if&nbsp;defined(_WIN64)</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">#endif</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((InputBuffer&nbsp;!=&nbsp;NULL)&nbsp;&amp;&amp;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(InputBufferSize&nbsp;&gt;=&nbsp;sizeof(FYFSFLT_SEND_DATA)))&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__try&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Command&nbsp;=&nbsp;((PFYFSFLT_SEND_DATA)&nbsp;InputBuffer)-&gt;MessageType;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Signature&nbsp;=&nbsp;((PFYFSFLT_SEND_DATA)&nbsp;InputBuffer)-&gt;Signature;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(Signature&nbsp;!=&nbsp;FY_FSFILTER_SIGNATURE)</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;Status;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pContent&nbsp;=&nbsp;&amp;((PFYFSFLT_SEND_DATA)&nbsp;InputBuffer)-&gt;Data;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ContentLength&nbsp;=&nbsp;((PFYFSFLT_SEND_DATA)&nbsp;InputBuffer)-&gt;DataLength;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;__except(&nbsp;EXCEPTION_EXECUTE_HANDLER&nbsp;)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;GetExceptionCode();</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DbgPrint("[%s]Command:%x\n",&nbsp;__FUNCTION__,&nbsp;Command);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(Command)</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;Lowlayer_Msg_SetImagePolicy:</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DbgPrint("[%s]&nbsp;Lowlayer_Msg_SetImagePolicy\n",&nbsp;__FUNCTION__);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SetProcessImagePolicy((PPOLICY_DATA)pContent,&nbsp;ContentLength);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;Lowlayer_Msg_BlockImage:</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DbgPrint("[%s]&nbsp;Lowlayer_Msg_BlockImage\n",&nbsp;__FUNCTION__);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExecuteKernelPatchProcedure((PFyPatchInfo)pContent,&nbsp;ContentLength);</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;STATUS_SUCCESS;</span></p><p style="line-height: normal;"><span style="font-size: 12px;">}</span></p></blockquote><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">当然在Patch的时候还是不能忘了改页属性，这个我也不想多说了，一定调用的是ZwProtectVirtualMemory，不导出就去搜...</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">BOOLEAN&nbsp;ApcRealProcedure1(PFyPatchInfo&nbsp;lpPatchInfo)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;BOOLEAN&nbsp;&nbsp;&nbsp;bRet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;FALSE;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;&nbsp;status;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ulCompareSize;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lpPatchAddr&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lpPatchInfo-&gt;PatchAddress;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;SIZE_T&nbsp;&nbsp;&nbsp;&nbsp;PatchSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;lpPatchInfo-&gt;PatchSize;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dwOldProtect;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;lpPatchInfo-&gt;PatchAddress&nbsp;&lt;&nbsp;MmSystemRangeStart&nbsp;)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ulCompareSize&nbsp;=&nbsp;(ULONG)RtlCompareMemory(lpPatchInfo-&gt;lpPatchContent,&nbsp;lpPatchInfo-&gt;PatchAddress,&nbsp;lpPatchInfo-&gt;PatchSize);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;ulCompareSize&nbsp;!=&nbsp;lpPatchInfo-&gt;PatchSize&nbsp;)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DbgPrint("[%s]&nbsp;RtlCompareMemory:%d\r\n",&nbsp;__FUNCTION__,&nbsp;ulCompareSize);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;g_ZwProtectVirtualMemory&nbsp;)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;g_ZwProtectVirtualMemory(NtCurrentProcess(),&nbsp;&amp;lpPatchAddr,&nbsp;&amp;PatchSize,&nbsp;PAGE_EXECUTE_READWRITE,&nbsp;&amp;dwOldProtect);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;STATUS_UNSUCCESSFUL;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!NT_SUCCESS(status)&nbsp;)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!g_dwSysBuildNumber)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DbgPrint("[%s]&nbsp;g_dwSysBuildNumber:%d\r\n",&nbsp;__FUNCTION__,&nbsp;g_dwSysBuildNumber);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PsGetVersion(&amp;g_dwSysMajorNumber,&nbsp;&amp;g_dwSysMinorNumber,&nbsp;&amp;g_dwSysBuildNumber,&nbsp;NULL);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(g_dwSysBuildNumber&nbsp;&gt;&nbsp;9600)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bRet&nbsp;=&nbsp;CopyMemoryUsingMdl(lpPatchInfo-&gt;PatchAddress,&nbsp;lpPatchInfo-&gt;lpPatchContent,&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ULONG)lpPatchInfo-&gt;PatchSize);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProbeForWrite(lpPatchInfo-&gt;PatchAddress,&nbsp;lpPatchInfo-&gt;PatchSize,&nbsp;1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memcpy(lpPatchInfo-&gt;PatchAddress,&nbsp;lpPatchInfo-&gt;lpPatchContent,&nbsp;lpPatchInfo-&gt;PatchSize)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;g_ZwProtectVirtualMemory&nbsp;)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;g_ZwProtectVirtualMemory(NtCurrentProcess(),&nbsp;&amp;lpPatchAddr,&nbsp;&amp;PatchSize,&nbsp;dwOldProtect,&nbsp;&amp;dwOldProtect);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bRet;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="line-height: 1.75em; margin-top: 20px; margin-bottom: 15px;"><span style="font-size: 15px;">正确的现象是在 ntdll!NtMapViewOfSection 刚回来的时候就已经执行了 Patch 操作，原本为 0x905a4d。</span></p><p style="line-height: 1.75em; margin-bottom: 15px; margin-top: 15px;"><img src="/ikanxue/images/af3b6ed8c6139175f711e81eb536bcc1282c8b95.png" style="width: 770px !important; height: 161.143px !important;"><span style="font-size: 15px;">在 ZwMapViewOfSection 之后 LdrFindOrMapDll 会调用 RtlImageNtHeaderEx 校验DosHeader 和 PEHeader，不对就卸载。</span></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/5a3f238dd114ce5604b8f80c30bea01b2c5c6aba.png" style="width: 770px !important; height: 267.575px !important;"></p><p style="line-height: 1.75em;"><img src="/ikanxue/images/609a0db4ea26b37364b2dfea0d74cca2192b4e3d.png" style="width: 770px !important; height: 365.75px !important;"><br><span style="font-size: 15px;">另外，由于 minifilter 驱动需要 inf 文件安装，为了避免这样的情况，我就用服务启动驱动了（即用即加载），不用手动去加，直接双击 exe 就行。</span></p><p style="line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="line-height: 1.75em;"><span style="font-size: 15px;">LZ 测试平台是 Win7 x64，其他平台未经过测试，应该可以兼容到 Win10... exe 与sys 放同一层目录下。</span></p><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em; text-align: center;"><span style="font-size: 15px; color: rgb(136, 136, 136);">本文由看雪论坛 FaEry<span class=""> </span>原创</span><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">你可能对以下内容感兴趣：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">等你来挑战！| 看雪 CTF 2017 攻击篇</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">【终于等到你！】看雪 CTF 2017</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283039&amp;idx=2&amp;sn=7965f942fd1629eb4b0502b01a522998&amp;chksm=b1815c9586f6d583b224490858104e7a5e5affad9542fe33da744c091ec234c3a55016f41690&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283039&amp;idx=2&amp;sn=7965f942fd1629eb4b0502b01a522998&amp;chksm=b1815c9586f6d583b224490858104e7a5e5affad9542fe33da744c091ec234c3a55016f41690&amp;scene=21#wechat_redirect">MS17-010 SMB 远程命令执行漏洞利用分析</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283033&amp;idx=2&amp;sn=7a0d3fa2c8c5e2bdcac6379351269330&amp;chksm=b1815c9386f6d585439b2186c5fc7099c74ce5398483563db182f868911a3a2c6c4be7500021&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283033&amp;idx=2&amp;sn=7a0d3fa2c8c5e2bdcac6379351269330&amp;chksm=b1815c9386f6d585439b2186c5fc7099c74ce5398483563db182f868911a3a2c6c4be7500021&amp;scene=21#wechat_redirect">新手逆向学习--Win7 下 64 位扫雷逆向以及辅助制作</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283005&amp;idx=2&amp;sn=2fc411b70549c789085e517ef6dfc3e9&amp;chksm=b1815b7786f6d261975cd000d4ddf2c4cffe3cf2d8ab06d870e7971e862c29c7278996bdfb6c&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283075&amp;idx=2&amp;sn=f34b3415519c129a9f829d5fe1673134&amp;chksm=b1815cc986f6d5df43c4d7cdb4be3e16e498f13d4cb60c7e1b41349fee9b4ba5b5d176b0713f&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283075&amp;idx=2&amp;sn=f34b3415519c129a9f829d5fe1673134&amp;chksm=b1815cc986f6d5df43c4d7cdb4be3e16e498f13d4cb60c7e1b41349fee9b4ba5b5d176b0713f&amp;scene=21#wechat_redirect" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">WannaCry深度详细分析报告(偏重策略)</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283003&amp;idx=1&amp;sn=bcfd852aea24f274bf8fda85f9300a85&amp;chksm=b1815b7186f6d26758f7f0f1cb0c7ec9da888ab0d80a7b2e2850453bfc03f05640443839d7bf&amp;scene=21#wechat_redirect" target="_blank">【原创】WannaCry勒索软件中“永恒之蓝”漏洞利用分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="/ikanxue/images/a0942aca19665d63c4ee222be971a37cd63dc1e4.jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496016642&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgG9Oe2Y4Txgw7FIHUz2sSP2AphHbOB7c*JU7liblQGWtMVZen7MuttjQKfDcEubrQPUtfJJ1qRjxuroisIqOYbDZ7sWxmA82ae49qEc-dIxs9NWt00LYYg310Em3isWet7n-9ca8Ft5o2-gwAUWZppE=">微信地址</a> | <a href="http://bbs.pediy.com/thread-217794.htm">阅读原文</a>
{% endraw  %}

