---
title: 初学Windows内核漏洞利用（二）：熟悉HEVD
author: 木无聊偶
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499131012&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ62YXf1MWi8Zh8usUjq2T6Tp8olMm-6I1I4qsl-rYUzkEslKlH6cxolxoLxftDKuPvgdNnLHIR8LTF2*Be9VTK*DixORd-kipN5i9bGvEa7ckt-QyT57FMoa8TysJgeAdcYcbJY2sSInoKcLAyBlO-0=
date: '2017-07-01 00:00:00 +0000'

---

{% raw  %}
<p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; line-height: 1.75em;">上一部分介绍了如何搭建实验环境；现在，我们将接触Ashfaq Ansari所开发的HEVD（HackSys Extreme Vulnerable Driver，HackSys Team小组所开发的一个Kernel Driver，其中包含大量常见漏洞且原理简单，主要考验各种利用方法，项目网址：https://github.com/hacksysteam/HackSysExtremeVulnerableDriver），进而将其熟练掌握。下一部分，我计划简要介绍一些漏洞示例和利用技术。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">本文所用到的软硬件环境：</span></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">上一部分所描述的实验环境；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">HackSys Extreme Vulnerable Driver（HEVD），包括预构建版本（下载网址：</span><span style="font-size: 15px;">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/releases</span><span style="font-size: 15px;">）和源代码（下载网址：</span><span style="font-size: 15px;">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver</span><span style="font-size: 15px;">）；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">OSR驱动加载器（下载网址：</span><span style="font-size: 15px;">https://www.osronline.com/article.cfm?article=157</span><span style="font-size: 15px;">）；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">DebugView工具（下载网址：</span><span style="font-size: 15px;">https://technet.microsoft.com/en-us/sysinternals/debugview.aspx</span><span style="font-size: 15px;">，位于Sysinternals工具集中，下载网址：</span><span style="font-size: 15px;">https://technet.microsoft.com/en-us/sysinternals/bb842062</span><span style="font-size: 15px;">）；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Visual Studio 2012开发环境（可以选择你喜欢的版本）。</span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong><span style="color: rgb(255, 251, 0); background-color: rgb(0, 0, 0);">安装并测试HEVD</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">首先，我将演示如何安装HEVD：我们将搭建并配置调试方和被调试方，使得调试字符串和HEVD的符号可见；我们还将接触专项利用工具。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(255, 251, 0); font-size: 16px; background-color: rgb(0, 0, 0);"><strong><span style="color: rgb(255, 251, 0); background-color: rgb(0, 0, 0);">查看调试字符串</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">HEVD和专项利用工具以调试字符串的形式打印大量的信息。我们既可以从调试方主机（使用WinDbg调试器），也从被调试方主机（使用DebugView工具）查看这些信息。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">为了查看驱动安装过程中所打印的字符串，我们将在安装HEVD之前进行适当的配置。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">调试方：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">为了获得命令行提示符“kd”，我们需要中断被调试方的执行流程（在WinDbg调试器中，选择“调试”菜单 -&gt; “中断”选项）。然后，我们使用如下命令，启动打印调试字符串的功能：</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ed&nbsp;nt!Kd_Default_Mask&nbsp;8</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">之后，我们通过执行“g”命令，使被调试方恢复运行。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">注意：开启该功能会使被调试方运行速度变慢；因此，应尽可能在本地查看调试字符串（即只在被调试方）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">被调试方：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我们需要以管理员权限运行DebugView工具，然后选择“拦截”菜单 -&gt; “拦截内核模式”，如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpA9gTNRHibHSCB1NNsKf89QibXXcJRgH4lJxziaibzibIC76jic4IV4BGYHEw/0?wx_fmt=png" style="width: 363px !important; height: 125px !important;"><br></p><p><span style="color: rgb(255, 251, 0); font-size: 16px; background-color: rgb(0, 0, 0);"><strong><span style="color: rgb(255, 251, 0); line-height: 1.75em; background-color: rgb(0, 0, 0);">安装驱动</span></strong></span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">首先，我们将预构建的程序包（驱动+漏洞）下载到被调试方（即被攻击主机），安装并测试。我们可以在HackSys Team小组的github页面发布版块（网址：</span><span style="font-size: 15px;">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/releases</span><span style="font-size: 15px;">）找到它。程序包丽包括两个版本的驱动，有漏洞/无漏洞；我们选择有漏洞，32位系统编译（i386）的版本，如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpf7G0TsfxdKvhnQv73zbwNvWYAbo01KSJ4BvIpPV3xnDMD197eolDYQ/0?wx_fmt=png" style="width: 457px !important; height: 584px !important;"></p><p><span style="font-size: 15px; line-height: 1.75em;">我们选择服务启动类型为“自动”；然后点击“注册服务”按钮，在其成功后点击“启动服务”。</span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我们可以在WinDbg调试器（调试方主机）和被调试方主机上的DbgView工具上看到所打印的HEVD旗标信息。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(255, 251, 0); font-size: 16px; background-color: rgb(0, 0, 0);"><strong><span style="color: rgb(255, 251, 0); background-color: rgb(0, 0, 0);">添加符号</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">HEVD的预编译程序包自带符号文件（sdb文件），我们可以将其添加到调试方。首先，我们通过发送中断信号来停止被调试方的运行，并使用“lm”命令查看所有已加载模块。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">为了找到HEVD模块，我们通过如下命令来设置过滤器：</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">lm&nbsp;m&nbsp;H*</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">从结果可见，HEVD模块没有附加任何符号；还好，这很容易修复。首先，为了打印WinDbg调试器在搜索符号过程中参考路径的所有信息，我们使用如下命令开启符号加载通知：</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">!sym_noisy</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">然后，使用如下命令尝试重载符号：</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">.reload</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">…并尝试再次引用它们。从所见到的路径中，我们可以复制pdb文件；在将pdb文件移动到调试方主机的合适位置之后，重新加载符号。可以通过使用如下命令尝试打印HEVD中的所有函数，来测试符号是否成功添加：</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">x&nbsp;HEVD!*</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="color: rgb(255, 251, 0); font-size: 16px; background-color: rgb(0, 0, 0);">测试漏洞利用工具</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">相同的程序包中还包含一组专项利用工具，我们可以通过执行适当的命令来运行其中每一个工具。下面我们尝试使用其中一些工具，并将cmd.exe设置为待运行的程序，如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpia6kfMT7L9Og4z5mbsOEsdicHr7JQt9DeXBgicLzVgatqZUdGAlW9qjJQ/0?wx_fmt=png" style="width: 554px !important; height: 352px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">使用Pool Overflow漏洞利用工具，如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpNaux6LB6LuJVrl1bjnZ9ar3HXVzqI3KWh2wF6SRuQokzMNBCxw6yLA/0?wx_fmt=png" style="width: 554px !important; height: 516px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果整个漏洞利用过程运行成功，目标程序（cmd.exe）将被分配更高的权限。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">通过执行命令“whoami”可以确认，该程序确实提权运行了，结果如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpeSKrMDpQv9aXwmbt9Hb8TeH9vCMVDia3noicNpS62Jza0aibGG2Hh77Hg/0?wx_fmt=png" style="width: 554px !important; height: 78px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">同时，我们可以在调试方主机上看到漏洞利用工具所打印的调试字符串，如下图所示。<br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbp4VL1XC8JiagdnojmG5AQldXL2GQIyICiaE1q8HppymibvjknA8rkaNyzA/0?wx_fmt=png" style="width: 554px !important; height: 331px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">除了Double Fetch漏洞之外，其他所有的漏洞利用工具在单核环境下都将运行良好；如果我们想要（Double Fetch）漏洞利用工具生效，就需要保证被调试主机为双核环境。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">注意：某些漏洞利用工具并不是100%可靠，在使用它们之后可能会造成系统崩溃；别担心，这很正常。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">驱动你好，开始交流！</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">与用户层情况类似，内核层的漏洞利用同样开始于寻找能够向程序提供输入的点；然后，我们需要找到能够干扰执行流程（与用户层不同，内核层的一次崩溃将直接导致蓝屏！）的输入；最终，我们将尝试精心构造输入，以便我们能够控制有漏洞程序的执行流程。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">为了能够从用户模式与驱动交流，我们将向其发送IOCTL（Input-Output control， 输入/输出控制）信号。IOCTL信号允许我们从用户层向驱动发送一些输入缓冲区；这就是我们可以尝试漏洞利用突破的点。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">HEVD包含了各种类型漏洞的样例，其中每一个都可以通过使用不同的IOCTL信号来触发，并通过所提交的缓冲区来利用；其中某些（并非所有）漏洞在触发时将导致系统崩溃。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="color: rgb(255, 251, 0); font-size: 16px; background-color: rgb(0, 0, 0);">查找设备名称与IOCTL信号列表</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我们在与驱动交流之前，需要知道两件事情：</span></p><ol style="list-style-type: decimal;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">驱动所创建的设备（若没有创建任何设备，则我们无法与之交流）；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">所接收的IOCTL（输入/输出控制）信号列表。</span></p></li></ol><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">HEVD是开源的，因此我们可以从源代码中直接读取所有必要的数据；而在实际环境中，为了获取这些数据我们将花费大量的时间来对驱动进行逆向分析。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">HEVD创建设备的代码片段（网址：https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HackSysExtremeVulnerableDriver.c#L79），如下图所示。</span></p><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbp0ia0DgiamfQ4WVhHl1QdkawEib44MmY2lLAznAfibrKD0qCOCYnjmehaNw/0?wx_fmt=png" style="width: 554px !important; height: 183px !important;"></p><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">设备名称如上图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">现在，我们需要找到IOCTL信号列表，从阅读IRP数组的相关代码（网址：https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HackSysExtremeVulnerableDriver.c#L109）开始，如下图所示。</span></p><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpu8gIJ4jUW2Zj6m9Ix2eY1D63PPare2vic3lBdmof3cRLu3iaVo8hKFdA/0?wx_fmt=png" style="width: 554px !important; height: 92px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">IRP_MJ_DEVICE_CONTROL相关的函数将分配发送给驱动的IOCTL信号；因此，我们需要深入阅读该函数代码（网址：https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HackSysExtremeVulnerableDriver.c#L193），如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpjJcwRPao5LBnY8qISlGhfwGicqL2DrWvY4U3hiceKkrOYfDurMvaaz9Q/0?wx_fmt=png" style="width: 554px !important; height: 398px !important;"><br></p><p><span style="font-size: 15px; line-height: 1.75em;">代码中包含一个switch语句，其作用是调用一个对应的处理函数来处理一个特定的IOCTL信号；我们可以通过复制该switch语句的case分支来得到IOCTL信号列表。一个头部的预处理生命定义了这些常量的值（网址：https://github.com/hacksysteam/HackSysExtremeVulnerableDriver/blob/master/Driver/HackSysExtremeVulnerableDriver.h#L57），如下图所示。</span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpZhibpykjfHNRaj3U5JXqLdxsZouhTaZHHwWn3J0jGLiaiblWVaUdQ2Syg/0?wx_fmt=png" style="width: 554px !important; height: 162px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(255, 251, 0); font-size: 16px; background-color: rgb(0, 0, 0);"><strong><span style="color: rgb(255, 251, 0); background-color: rgb(0, 0, 0);">编写客户端应用程序</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">至此，我们获取了我们的程序用来和驱动交流的所有必要数据；我们可以将其全部放入一个头文件中（如</span><span style="font-size: 15px;">hevd_constants.h</span><span style="font-size: 15px;">文件中所示）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">每个IOCTL信号的数值由标准Windows系统头文件</span><span style="font-size: 15px;">winioctl.h</span><span style="font-size: 15px;">所定义的一个宏来创建，如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpC1XAe16GG6X3T4ibCgib2CombHagytI0YhjnHQNN7QAVKPcE0YyFww7A/0?wx_fmt=png" style="width: 424px !important; height: 70px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果你的程序中包含了windows.h头文件，则以上宏将自动添加。现在，我们不需要为特定常量的具体含义所烦恼；我们将直接原样使用已定义的元素。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">因此，我们已经准备好编写一个简单的用户层应用程序，来与驱动交流：首先，我们使用CreateFile函数来打开设备；然后，我们使用DeviceIoControl函数来发送IOCTL信号。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">以下你将看到一个精简版的例子，该应用程序向驱动发送STACK_OVERFLOW这一IOCTL信号（具体实现代码见</span><span style="font-size: 15px;">send_ioctl.cpp</span><span style="font-size: 15px;">文件）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">尝试编译该程序，并在被调试方主机上使用。打开DebugView工具，并观察驱动所打印的调试字符串，如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpAXJTh1OicTcPPI7ssEhWKKMnP21KqR6s2CBkAJ0OdFSvLWYczEHJurg/0?wx_fmt=png" style="width: 480px !important; height: 254px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果调试方主机也开启了打印调试字符串的功能，则会看到相同的输出，如下图所示。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbpsuupUlu9E0vDI2F2gicdHGZHtMQibdTwQGavf7TEZ4QED3vL6icEvM5Hg/0?wx_fmt=png" style="width: 554px !important; height: 193px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如图所见，驱动获取了我们的输入，并对其给出报告。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">练习：系统崩溃！</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">作为练习，我创建了一个HEVD的小型客户端，其功能是向HEVD发送多种带有指定长度输入缓冲区的IOCTL信号。源代码网址如下：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">https://github.com/hasherezade/wke_exercises/tree/master/task1</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">以及编译的32位二进制程序网址如下：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">https://drive.google.com/open?id=0Bzb5kQFOXkiSNTlVSjMtZzRfZDg</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">尝试多种IOCTL信号，直到系统崩溃。由于被调试方运行于调试方的控制之下，因此其系统并不会蓝屏；反之，WinDbg调试器将被触发。试着对每种情况进行简单的分析；从使用如下命令打印信息开始：</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">!analyze&nbsp;–v</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">其他一些有帮助的命令如下：</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">k&nbsp;—&nbsp;堆栈跟踪</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">kb&nbsp;—&nbsp;带参的堆栈跟踪</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">r&nbsp;—&nbsp;寄存器</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">dd&nbsp;[地址]&nbsp;—&nbsp;从指定地址处，按DWORD数据类型显示数据</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">更多的命令信息，请使用“.hh”命令查看WinDbg调试器帮助文件。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在我们的示例应用程序中，用户缓冲区使用字符“A”（ASCII码为0x41）进行填充（网址：</span><span style="font-size: 15px;">https://github.com/hasherezade/wke_exercises/blob/master/task1/src/main.cpp#L34</span><span style="font-size: 15px;">），具体语句如下:</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">RtlFillMemory(inBuffer,&nbsp;bufSize,&nbsp;‘A’);</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">因此，只要我们在崩溃分析中见到该形式的字符串，就说明特定的数据能够被用户填充。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">需要注意的是，触发相同的漏洞可能给出不同的输出，这依赖于当前引起崩溃的源头，相关的因素比如溢出的尺寸，内存的当前布局等等。</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; color: rgb(136, 136, 136); box-sizing: border-box !important; word-wrap: break-word !important;">本文由 看雪翻译小组<span class="" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;木无聊偶</span>&nbsp;编译，来源</span>&nbsp;<span style="max-width: 100%; font-size: 15px; color: rgb(136, 136, 136); box-sizing: border-box !important; word-wrap: break-word !important;">hasherezade's 1001 nights</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; text-align: center; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; color: rgb(136, 136, 136); box-sizing: border-box !important; word-wrap: break-word !important;">转载请注明来自看雪论坛<br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; text-align: center; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; color: rgb(255, 104, 39); box-sizing: border-box !important; word-wrap: break-word !important;">如果你喜欢的话，不要忘记点个赞哦！</span><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">热门阅读文章：<br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283801&amp;idx=3&amp;sn=7b7133c3b9e03a2d3a3110f505655a56&amp;chksm=b1815f9386f6d685d472ab31664b6b46df80402db1c21dd9e6947dec12984554181454a5c1f1&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">从内核角度分析 Dirty Cow 原理</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283731&amp;idx=2&amp;sn=7607156e89c10583d4fc3402eb2f9871&amp;chksm=b1815e5986f6d74f401a562ca55e7af38b3c2de32d489dc221955f4f721c32204afb78e3b002&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">来自内部的威胁以及如何防御</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283717&amp;idx=1&amp;sn=76b71e037f1582b430ec7b72ac2eacf5&amp;chksm=b1815e4f86f6d759d89b72279c639555607077b74cb933035593187bec6209671d531b042b09&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">硬盘 LED 灯中泄露的数据 （一）</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283725&amp;idx=2&amp;sn=5f47edc0822653fb64508ee807efaacc&amp;chksm=b1815e4786f6d751a61088e8514eee5cdfb737ecacbb057e1e65fa3aa32d2ed6a2de9007b5e8&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">硬盘 LED 灯中泄露的数据 （二）</a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p></li><li><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170); box-sizing: border-box !important; word-wrap: break-word !important;">关注看雪学院公众号</span>”查看！</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"></span><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HiaLvNnn2vsrHbBaPtQlSbp7wPVAEujKLHZQicNHsdY9rLP72MmjtDsEjIfRIs36EezoZj3S4a4Qsw/640?wx_fmt=jpeg" style="box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 427px !important;"></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"></span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="margin: 15px 1em; max-width: 100%; min-height: 1em; letter-spacing: 0.5px; line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; word-wrap: break-word !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499131012&src=3&ver=1&signature=iU4hCwtQzyv2pey6SDTnZ62YXf1MWi8Zh8usUjq2T6Tp8olMm-6I1I4qsl-rYUzkEslKlH6cxolxoLxftDKuPvgdNnLHIR8LTF2*Be9VTK*DixORd-kipN5i9bGvEa7ckt-QyT57FMoa8TysJgeAdcYcbJY2sSInoKcLAyBlO-0=">微信地址</a> | <a href="http://bbs.pediy.com/thread-218868.htm">阅读原文</a>
{% endraw  %}

