---
title: 【权威报告】WanaCrypt0r勒索蠕虫完全分析报告
author: 360 追日团队
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6ZeYoLYi7On2peh0RUSvK*Ll**XEqfAcojs8e27I66B5Zpp7gCGUriA19-efDRvHUTFNMWOUHuf5REG7dURTyQM=
date: '2017-05-14 00:00:00 +0000'

---

{% raw  %}
<p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; text-indent: 0em; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; color: rgb(0, 112, 192); font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); text-decoration: underline; touch-action: manipulation; outline-width: 0px; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/d9efadfb7050edf0e68de408e5c1ef1e0ab19cc3.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 485px !important; height: 335px !important; visibility: visible !important;"></a></span></span></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><br></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x1 前言</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; text-indent: 2em;">360互联网安全中心近日发现全球多个国家和地区的机构及个人电脑遭受到了一款新型勒索软件攻击，并于5月12日国内率先发布紧急预警，外媒和多家安全公司将该病毒命名为“WanaCrypt0r”（直译：“想哭勒索蠕虫”），常规的勒索病毒是一种趋利明显的恶意程序，它会使用加密算法加密受害者电脑内的重要文件，向受害者勒索赎金，除非受害者交出勒索赎金，否则加密文件无法被恢复，而新的“想哭勒索蠕虫”尤其致命，它利用了窃取自美国国家安全局的黑客工具EternalBlue（直译：“永恒之蓝”）实现了全球范围内的快速传播，在短时间内造成了巨大损失。360追日团队对“想哭勒索蠕虫”国内首家进行了完全的技术分析，帮助大家深入了解此次攻击！</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><br style="box-sizing: inherit;"></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x2 抽样分析样本信息</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-weight: 900;">MD5:&nbsp;</span><span style="box-sizing: inherit; text-indent: 2em;">DB349B97C37D22F5EA1D1841E3C89EB4</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-weight: 900;">文件大小:	</span><span style="box-sizing: inherit;">3,723,264</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-weight: 900;">影响面：</span><span style="box-sizing: inherit;">除Windows 10外，所有未打MS-17-010补丁的Windows系统都可能被攻击</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-weight: 900;">功能: &nbsp;</span><span style="box-sizing: inherit;">&nbsp;释放加密程序，使用RSA+AES加密算法对电脑文件进行加密勒索，通过MS17-010漏洞实现自身的快速感染和扩散。&nbsp;</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><br style="box-sizing: inherit;"></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x03 蠕虫的攻击流程</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; text-indent: 2em;">该蠕虫病毒使用了ms17-010漏洞进行了传播，一旦某台电脑中招，相邻的存在漏洞的网络主机都会被其主动攻击，整个网络都可能被感染该蠕虫病毒，受害感染主机数量最终将呈几何级的增长。其完整攻击流程如下</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/3afe8ae6246c43381cc1c73f4971a22c0c1175e4.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 498px !important; height: 487px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><br style="box-sizing: inherit;"></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x04 蠕虫启动逻辑分析</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; color: rgb(0, 112, 192);"><span style="box-sizing: inherit; font-weight: 900;">1.蠕虫启动时将连接固定url:&nbsp;<a style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;">http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com</a>&nbsp;</span></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">a)如果连接成功,则退出程序</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">b)连接失败则继续攻击</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; color: rgb(0, 112, 192);"><span style="box-sizing: inherit; font-weight: 900;">2.接下来蠕虫开始判断参数个数,小于2时,进入安装流程;大于等于2时,进入服务流程.</span></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-weight: 900;">a)安装流程</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">i.创建服务,服务名称: mssecsvc2.0</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">参数为当前程序路径 –m security</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">ii.释放并启动exe程序</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">移动当前 C:\WINDOWS\tasksche.exe到 C:\WINDOWS\qeriuwjhrf</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">释放自身的1831资源(MD5: 84C82835A5D21BBCF75A61706D8AB549),到C:\WINDOWS\tasksche.exe,并以 /i参数启动</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-weight: 900;">b)服务流程</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">i.服务函数中执行感染功能,执行完毕后等待24小时退出.</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">ii.感染功能</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">初始化网络和加密库,初始化payload dll内存.</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">a)Payload包含2个版本,x86和x64</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/4020e1799846e5313dabaf9cfd4b0a1b5f6822e2.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 374px !important; height: 123px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">b)功能为释放资源到c:\windows\mssecsvc.exe并执行</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">启动线程,在循环中向局域网的随机ip发送SMB漏洞利用代码</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/965b37d56caab9a532b884f8ba9c71099cc3f8f9.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 354px !important; height: 197px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/58a9f3e6a8d5082de2e026cd43853da7fccb96cf.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 434px !important; height: 205px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><br style="box-sizing: inherit;"></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x05 蠕虫利用漏洞确认</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; text-indent: 2em;">通过对其中的发送的SMB包进行分析，我们发现其使用漏洞攻击代码和<a style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;">https://github.com/rapid7/metasploit-framework</a>&nbsp;近乎一致，为Eternalblue工具使用的攻击包。</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/50b5b358d67cc333a3b7a49acf43d5c6d020bdfa.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 499px !important; height: 527px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">蠕虫 SMB数据包:</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/2e5d00b6545580208b10aa88c2a089755c5b47c3.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 476px !important; height: 158px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">Eternalblue工具使用的MS17-010 SMB数据包:</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/acbd51204435cb301361cf9bbfbf928fbf4f4586.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 495px !important; height: 49px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><a style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;">https://github.com/RiskSense-Ops/MS17-010/tree/master/exploits/eternalblue/orig_shellcode</a>&nbsp;</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">文件内容在DB349B97C37D22F5EA1D1841E3C89EB4中出现</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">orig_shellcode文件内容:&nbsp;</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/6751eca64300a527fdd57dccb30ccf0af9224d57.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 497px !important; height: 266px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">DB349B97C37D22F5EA1D1841E3C89EB4 文件:</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/652282753dc02e9c9564a7dc5485de82ea50eaa4.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 498px !important; height: 279px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><br style="box-sizing: inherit;"></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x06 蠕虫释放文件分析</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; text-indent: 2em;">蠕虫成功启动后将开始释放文件，流程如下：</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/288bfb8d0f24a8450e757d3f363245abedc7aba8.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 437px !important; height: 179px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">释放文件与功能列表，如下：</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/e3ee092c029550b439c15dd7a96659e59e6d5c0a.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 600px !important; height: 518.78px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><br style="box-sizing: inherit;"></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x07 关键勒索加密过程分析</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; text-indent: 2em;">蠕虫会释放一个加密模块到内存，直接在内存加载该DLL。DLL导出一个函数TaskStart用于启动整个加密的流程。程序动态获取了文件系统和加密相关的API函数，以此来躲避静态查杀。</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/98066f796ef7e64c53fb5011e8b18d10c5c6616a.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 392px !important; height: 367px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">整个加密过程采用RSA+AES的方式完成，其中RSA加密过程使用了微软的CryptAPI，AES代码静态编译到dll。加密流程如下图所示。</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/4b012103158c90964e121e2520cdee7b2df4f2b9.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 477px !important; height: 469px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">使用的密钥概述：</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/3986eb459f8235a58c0dfd191abbffbf9e94d35d.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 504px !important; height: 255px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">目前加密的文件后缀名列表：</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/d76cf4c0e28ba1131cc42d1929baabc34b60b8c7.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 489px !important; height: 142px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">值得注意的是，在加密过程中，程序会随机选取一部分文件使用内置的RSA公钥来进行加密，这里的目的是解密程序提供的免费解密部分文件功能。</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/f157a79b7a403ae7cb22234e6fc3d5171b352394.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 460px !important; height: 265px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">能免费解密的文件路径在文件f.wnry中</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/57e62a0d8ed9f8e7b07c8640d75fe10bd04cbb92.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 498px !important; height: 140px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;"><br style="box-sizing: inherit;"></span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">0x08 蠕虫赎金解密过程分析</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; text-indent: 2em;">首先，解密程序通过释放的taskhsvc.exe向服务器查询付款信息，若用户已经支付过，则将eky文件发送给作者，作者解密后获得dky文件，这就是解密之后的Key</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">解密流程与加密流程相反，解密程序将从服务器获取的dky文件中导入Key</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/3a34e8798461bfa14bff1d57fb1f358bb7b4ed4a.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 292px !important; height: 74px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/ad9f55ac5629e643bc3a95f91530979359db2032.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 498px !important; height: 219px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">可以看到，当不存在dky文件名的时候，使用的是内置的Key，此时是用来解密免费解密的文件使用的。</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/223d49ab8fbf9c31def8fdafe385b8c28bc7bd6d.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 496px !important; height: 251px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/9dc495c1b13a302b4a061f94f8588fd92bf7f16f.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 290px !important; height: 157px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit;">之后解密程序从文件头读取加密的数据，使用导入的Key调用函数CryptDecrypt解密，解密出的数据作为AES的Key再次解密得到原文件。</span></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-align: center; background-color: rgb(250, 250, 250);"><a target="_blank" style="box-sizing: inherit; color: rgb(51, 51, 51); touch-action: manipulation; line-height: 28px; background-color: transparent;"><img src="/ikanxue/images/1b92a72cc2964ff159ce7400222581486dac502c.png" style="box-sizing: inherit; border: 0px; vertical-align: middle; max-width: 600px; width: 499px !important; height: 72px !important;"></a></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><br style="box-sizing: inherit;"></p><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; font-size: 18px;"><span style="box-sizing: inherit; font-weight: 900;"><span style="box-sizing: inherit;">总结</span></span></span></p><hr style="box-sizing: content-box; height: 1px; overflow: visible; margin-bottom: 25px; border-width: 0px; border-top-style: solid; border-top-color: rgba(0, 0, 0, 0.0980392); white-space: normal; width: 938.125px; font-family: none; font-size: 12px; line-height: 14px; background-color: rgb(225, 225, 225);"><p style="box-sizing: inherit; margin-right: 25px; margin-bottom: 8px; margin-left: 25px; white-space: normal; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; font-family: none; text-indent: 2em; background-color: rgb(250, 250, 250);"><span style="box-sizing: inherit; text-indent: 2em;">该蠕虫在全球首例使用了远程高危漏洞进行自我传播复制，危害不小于冲击波和震荡波蠕虫，并且该敲诈者在文件加密方面的编程较为规范，流程符合密码学标准，因此在作者不公开私钥的情况下，很难通过其他手段对勒索文件进行解密，同时微软已对停止安全更新的xp和2003操作系统紧急发布了漏洞补丁，</span><span style="box-sizing: inherit; text-indent: 2em;">请大家通过更新MS17-010漏洞补丁来及时防御蠕虫攻击。</span></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6ZeYoLYi7On2peh0RUSvK*Ll**XEqfAcojs8e27I66B5Zpp7gCGUriA19-efDRvHUTFNMWOUHuf5REG7dURTyQM=">微信地址</a> | <a href="http://m.bobao.360.cn/learning/appdetail/3853.html?from=timeline&amp;isappinstalled=1">阅读原文</a>
{% endraw  %}

