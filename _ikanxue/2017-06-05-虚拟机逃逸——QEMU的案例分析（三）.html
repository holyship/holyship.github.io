---
title: 虚拟机逃逸——QEMU的案例分析（三）
author: Green奇
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496829841&src=3&ver=1&signature=IbkGB-IUv3NGRNGRf6IuJDEcuRy1*zESqpfOL5NuObERGQ*gbLaFfQ8X2IuMqNyfrhAtNGHPvT-wKPXl9IJKjMXTauH2TbpIzumOCFrqTuFd*gvqlCXRVHmoJIgUIBjmrEnht4DArpDIsmcSueg5ymY8ybskWxIacCh89nh6tfk=
date: '2017-06-05 00:00:00 +0000'

---

{% raw  %}
<section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">5.&nbsp; 结合使用两个漏洞</span></strong><br></p></section></section></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">在这部分，我们合并了这上述两个漏洞，用来实现虚拟机逃逸并获得QEMU的特权实现在宿主机上运行代码。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">首先，我们利用 CVE-2015-5165 来重建 QEMU 的结构。更确切的说，利用该漏洞获得以下地址来实现ASLR的绕道：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">用户物理内存基地址。在我们的漏洞利用中，需要定位用户并获得其在 QEMU 虚拟地址空间中的准确地址。</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">.text 字段的基地址。这是为了获得qemu_set_irq()函数的地址。</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">.plt 字段的基地址。这是为了确定一些函数的地址，比如生成我们恶意代码的fork() 和 execv() 函数。还需要 mprotect() 函数来修改用户物理地址。记得用户的物理地址是不可执行的。</span></p></li></ul><p><br></p><p><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">5.1 RIP 控制</span></strong><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">如第 4 部分所示，我们已经控制了 %rip 寄存器。为了让 QEMU 在特定地址处泄露，我们需要用一个指向假 IRQState 结构体的地址指针来泄露 PCNET 缓冲区，该结构调用了一个我们选择的函数。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">首先，可以尝试构建一个假IRQState结构体调用system()。然而，有时调用会失败，因为一些QEMU内存映射不通过fork()调用。更确切的说即映射的物理内存有 MADV_DONTFORK参数。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdZn2ibEPEwZCkQJQAgYGpg5FST1VacKGvhHU9aicgicBq7h7UBcVALDZoA/0?wx_fmt=png" style="width: 457px !important; height: 29px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">调用execv()也没用，因为我们失去了对用户机器的控制。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">还要注意可以连接一些泄露的IRQState来构造恶意代码调用许多函数，因为qemu_set_irq()被PCNET设备仿真器多次调用。然而，我们发现更方便实用的方法是，设置恶意代码所在页内存的PROT_EXEC参数之后执行恶意代码。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">我们的方法是构造两个假IRQState结构体。第一个调用mprotect()。第二个调用恶意代码，首先取消MADV_DONTFORK参数，然后在用户和主机之间互动。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">如之前所述，当调用qemu_set_irq()时，输入两个参数：irq（IRQstate结构体的指针）和level（IRQ level），然后调用如下处理程序：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdleKlcFvAJ4hDE60QQxibeODgeN9fXFapn56oY0rFzVCLE6uOdO52W8g/0?wx_fmt=png" style="width: 298px !important; height: 104px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">如之前所述，我们只能控制前两个参数。所以怎样调用mprotect()这样有三个参数的函数呢？</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">为了解决这个问题，我们让qemu_set_irq()先调用自己的两个参数：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">&nbsp; - irq：指向假IRQState结构体的指针，设置处理程序指针指向mprotect()函数。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">&nbsp; - level：设置mprotect参数为PROT_READ | PROT_WRITE | PROT_EXEC</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">&nbsp; 这通过构造两个假IRQState结构体来实现，代码段如下：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdbCuwrC0K9O4AlB4S2jBdr3ibW9PVfJAibCbAVbsASyClaw5A3DR5Y56Q/0?wx_fmt=png" style="width: 421px !important; height: 284px !important;"><span style="font-size: 15px; color: rgb(63, 63, 63);"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">当溢出发生后，qemu_set_irq()被一个假的处理程序调用，该处理程序在调整level参数为7（要求mprotect参数）后调用mprotect。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">现在内存可以执行了，我们可以通过将第一个IRQState的处理程序重写为我们的恶意代码地址，把控制权转交给交互式shell。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icd72kvCiaYhpMTNsjTOY6aGxXribNUaVDemYbMLhI2w8BvtSIrpMmnRAyw/0?wx_fmt=png" style="width: 293px !important; height: 44px !important;"></p><p><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">5.2 交互式Shell</span></strong><br></p></section></section></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">好了，我们可以简单的写一个基本的shellcode，构建一个远程控制端口的shell并从一个单独的机器上连接这个shell。这是个好的方案，但是我们可以做的更好来逃过防火墙限制。我们利用在用户和主机之间的共享内存来构建一个bindshell。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">利用QEMU的漏洞是很巧妙的，因为我们在用户内存上写的代码已经在QEMU的进程内存中可用。所以不需要再注入shellcode。更好的，我们可以共享代码并让它运行在用户机和连接的主机上。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">我们构造了两个循环缓冲区（输入和输出）并给这些共享内存空间提供有自旋锁的读/写方法。在主机上，我们运行一个shellcode，在一个单独的进程中复制了其stdin和stdout文件后执行/bin/sh的shell。我们还创建爱你了两个线程。第一个线程从共享内存中读命令并通过一个管道传递给shel。第二个线程读取shell的输出（通过另一个管道）然后写入共享内存。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">这两个线程还分别实例化了用户机，一个写入用户输入的命令到专用的共享内存，一个输出从第二个循环缓冲读取的结果到stdout。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">注意在我们的漏洞利用中，有第三个线程（和一个专用共享区域）来处理stderr输出。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdo6vzgMPzYgCfriaibdLlFfHgjxlhjOmQz91ryquNm377aDXu6gy4QSOw/0?wx_fmt=png" style="width: 474px !important; height: 403px !important;"></p><p><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">5.3 虚拟机逃逸的利用</span></strong><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">这部分我们列出了虚拟机逃逸（vm-escape.c）用到的主要结构体和函数。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">注入的payload结构体定义如下：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdy9NNON6zKHytSGO2QycjZiaRJMyBYnoGxnKYyjZRcajd4lRDsq4gwNg/0?wx_fmt=png" style="width: 280px !important; height: 110px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">fake_irq是与假IRQState结构体一对的，负责调用mprotect()并改变配置所在页的页保护。<br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">shared_data结构体用来传递数据到主shellcode。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdbIM1hbAzVRdcf2z8AKMjhRKia0hDa3TxsdJsO7WI7kEStVywlibaNTiaA/0?wx_fmt=png" style="width: 248px !important; height: 107px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">got 结构体是一个全局变量偏移表。它包括shellcode运行需要的主要函数的地址。这些函数的地址从内存泄露中得到。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdDSo9LKAGxt6wUT3XQ4ReN4QFb0TOXcSia89zHmZwzsB7CJ9CKqib8xZQ/0?wx_fmt=png" style="width: 302px !important; height: 218px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">主 shellcode 定义为如下函数：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FlEwcHvic1GxsM2pNT9H3ufQPQHAeicB15Smfygp9MficMsB4jVwS2DtZibY7ejTQh4nfsoMEyK6KPFg/0?wx_fmt=png" style="width: 722px !important; height: 582px !important;"></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FlEwcHvic1GxsM2pNT9H3ufjxSbDTokIhFP8A7J4MSqBkE5pqvcwkZRn3xssibW1XIQNl1yy59REow/0?wx_fmt=png" style="width: 703px !important; height: 404px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span><span style="font-size: 15px; color: rgb(63, 63, 63);">shellcode首先检查shared_data-&gt;done参数以避免多次执行（记住用来转移控制权给shellcode的qemu_set_irq参数会被 QEMU 代码多次调用）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">shellcode通过将shared_data-&gt;addr指向物理内存来调用 madvise()。必须取消MADV_DONTFORK标记来通过调用fork()保护内存映射。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">shellcode创建一个子进程负责启动一个shell（“/bin/sh”）。父进程启动一个线程使用共享内存区域来从用户机传递Shell命令到连接的主机，然后将这些命令的结果写会到用户机，父线程和子进程之间通过管道相互通信。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">如下所示，共享的内存区域包括一个循环缓冲区，该缓冲区通过sm_read()和sm_write()原语进行访问：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FlEwcHvic1GxsM2pNT9H3ufoNgKmIRiatmedrOK13DCdSzicfSUL3KCxAA3pdiapxeOmq596hicWWnqIg/0?wx_fmt=png" style="width: 742px !important; height: 609px !important;"></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FlEwcHvic1GxsM2pNT9H3ufuq19ZwqRtd3dbnujGZvQiaL3LTnQ6nzLRfe44qq6zJHM3H0O8qyXnicg/0?wx_fmt=png" style="width: 770px !important; height: 577.5px !important;"></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FlEwcHvic1GxsM2pNT9H3ufYeUYTJkDhInx33icLz973siaaUz29EKB5RL6nPiajm4icKiaUtiaZYMLsxyQ/0?wx_fmt=png" style="width: 770px !important; height: 138.103px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span><span style="font-size: 15px; color: rgb(63, 63, 63);">这两个原语被以下线程函数使用。第一个函数从共享内存区域读取数据并写入文件寄存器。第二个函数从文件寄存器中读取数据并写入共享内存区。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FlEwcHvic1GxsM2pNT9H3ufZewZjg06OxNdVPNLpvpnCaKm45cWCppotsZOJQWm6z7VjYdBExKrGA/0?wx_fmt=png" style="width: 681px !important; height: 538px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span><span style="font-size: 15px; color: rgb(63, 63, 63);">注意这些函数的代码共享于主机和用户机。这些线程还在用户机上实例化来读取用户输入的命令并复制到专用共享内存区域（在内存中），并将这些命令运行的结果写入对应的共享内存区域（输出和err 共享内存）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FlEwcHvic1GxsM2pNT9H3ufuRMQCMxYnicSupqFW7Riaicheruic1qtBjxDPrIBIqiagjMeAs3gB2JfsSQ/0?wx_fmt=png" style="width: 689px !important; height: 623px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"></span><span style="font-size: 15px; color: rgb(63, 63, 63);">之前部分讨论过的计算过程表明，共享内存和进程/线程会在用户机和主机上启动。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">该逃逸过程在QEMU的一个脆弱版本4.9.2上实现，通过Gcc的4.9.2版本构建。为了在特定的QEMU版本上也能实现，我们提供一个Shell script（build-exploit.sh）将会输出一个需要的偏移地址的C头文件：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdgHCicL7P1QcjnNnocsPlRMBlfsUMnYKNYicHGoBmK4TFNJxtTHalY7Fw/0?wx_fmt=png" style="width: 475px !important; height: 253px !important;"><br></p><p><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">5.4 局限</span></strong><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">注意，该逃逸过程有时是不能实现的。在我们的测试环境中（Debian 7，3.16内核，x_86_64），我们有十分之一的失败率。大多数的失败，都因无用的泄露的数据而无法重建QEMU的内存泄露。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">该逃逸过程不能在没有CONFIG_ARCH_BINFMT_ELF_RANDOMIZE_PIE标记的linux内核上实现。在这种情况下，QEMU二进制（由 -fPIE默认编译）映射到一个如下所示的单独的地址空间：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HeITaKZ4ia1yZqDFpI1U8icdNMZ8UHSg9OxvNWcedMpO3yliaS8TLWUYLGEBBfewOgaDuqlOwUIP60A/0?wx_fmt=png" style="width: 484px !important; height: 285px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">结论是，我们的4字节溢出不适合irq指针的间接引用（最初位于堆的0x55xxxxxxxxxx处），所以它会指向我们的假IRQState结构体（注入到0x7fxxxxxxxxxx处）。 <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"><br></span></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">6. 结论</span></strong><br></p></section></section></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">本文中，我们阐述了QEMU网卡设备模拟器上的两种漏洞利用。结合使用这两种漏洞可以实现虚拟机逃逸并在宿主机上执行代码。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">在研究过程中，我们测试虚拟机超过1000次。用一个复杂的shellcode给每个进程产生大量的线程，实验不成功是让人沮丧的。所以，我们希望，已经提供了足够的技术细节和通用技术，可以用在将来的QEMU开发中。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);"><br></span></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">7. 结论</span></strong><br></p></section></section></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">我们要感谢 Pierre-Sylvain Desse 的精辟建议。感谢 coldshell 和 Kevin Schouteeten帮助我们在多种环境中测试。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">还要感谢Nelson Elhage在虚拟机逃逸方面所做的工作。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">感谢Phrack Staff的对修改文章和代码的建议。</span></p><p><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">8. 引用</span></strong><br></p></section></section></section></section><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">[1] http://venom.crowdstrike.com</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">[2] media.blackhat.com/bh-us-11/Elhage/BH_US_11_Elhage_Virtunoid_WP.pdf</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">[3] https://github.com/nelhage/virtunoid/blob/master/virtunoid.c</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">[4] http://lettieri.iet.unipi.it/virtualization/2014/Vtx.pdf</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">[5] https://www.kernel.org/doc/Documentation/vm/pagemap.txt</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">[6] https://blog.affien.com/archives/2005/07/15/reversing-crc/</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 14px; color: rgb(136, 136, 136);"><br></span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 14px; color: rgb(136, 136, 136);">本文由 看雪翻译小组 Green奇 编译，来源 Mehdi Talbi和Paul Fariello@phrack</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em; text-align: center;"><span style="font-size: 15px; color: rgb(255, 104, 39);">本系列到此结束了，如果你喜欢的话，不要忘记点个赞哦！</span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">热门阅读文章：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283127&amp;idx=1&amp;sn=a456b8495b438499ab68d1a2c32e543c&amp;chksm=b1815cfd86f6d5eb01205cf7c3052d428b2e9105d34523a276bdfb774c7adbbcbd197210f286&amp;scene=21#wechat_redirect" target="_blank">看雪 CTF 2017 攻击篇 6月强势来袭！</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283184&amp;idx=2&amp;sn=32f3a9e70e3504ed2cd68f1c0a2c8f3d&amp;chksm=b1815c3a86f6d52ca5b25dfb1b6d120712007f74f6d57d062881bcbc3b3b9b0ed31232a1c530&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283184&amp;idx=2&amp;sn=32f3a9e70e3504ed2cd68f1c0a2c8f3d&amp;chksm=b1815c3a86f6d52ca5b25dfb1b6d120712007f74f6d57d062881bcbc3b3b9b0ed31232a1c530&amp;scene=21#wechat_redirect">虚拟机逃逸——QEMU的案例分析（二）</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283175&amp;idx=2&amp;sn=6e8fb6db8c328707308758a8791029b0&amp;chksm=b1815c2d86f6d53b885885136b9b9c0685c72006ff6fe96150e060a6ba56aa8c63651f0daee5&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283175&amp;idx=2&amp;sn=6e8fb6db8c328707308758a8791029b0&amp;chksm=b1815c2d86f6d53b885885136b9b9c0685c72006ff6fe96150e060a6ba56aa8c63651f0daee5&amp;scene=21#wechat_redirect">虚拟机逃逸——QEMU的案例分析（一）</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283005&amp;idx=2&amp;sn=2fc411b70549c789085e517ef6dfc3e9&amp;chksm=b1815b7786f6d261975cd000d4ddf2c4cffe3cf2d8ab06d870e7971e862c29c7278996bdfb6c&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283017&amp;idx=3&amp;sn=745024d678707b6dcf0cdc94ff5472a5&amp;chksm=b1815c8386f6d59538bfeeb8d3837007f07b0b4d3cd77b439f7856edd391127b6b2f36fb105d&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283184&amp;idx=1&amp;sn=fd8246361b0bd21c80717c888e67f55a&amp;chksm=b1815c3a86f6d52cfd48056237427263609a8184b1cea6b28d1bc56f942dd1498dd26764d4bb&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283184&amp;idx=1&amp;sn=fd8246361b0bd21c80717c888e67f55a&amp;chksm=b1815c3a86f6d52cfd48056237427263609a8184b1cea6b28d1bc56f942dd1498dd26764d4bb&amp;scene=21#wechat_redirect">看雪.万能钥匙 CTF 2017第一题 WannaLOL 解题思路</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283114&amp;idx=3&amp;sn=fc763099faeb53bb8407bce865b403c1&amp;chksm=b1815ce086f6d5f60970b9c550518d07199c77e380cee90791c91a6ade3f5abd2b4c3f9588cd&amp;scene=21#wechat_redirect" target="_blank">CVE-2012-0158 两种 PoC 分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8E4ItLe4LX3YbLUffeV86icpcBApdQiakmEMuy4q8mVAaBjA0P1wez6NzO52zvKNlQQQ4siaztZDYhBg/640?wx_fmt=jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 140px !important; height: 140px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496829841&src=3&ver=1&signature=IbkGB-IUv3NGRNGRf6IuJDEcuRy1*zESqpfOL5NuObERGQ*gbLaFfQ8X2IuMqNyfrhAtNGHPvT-wKPXl9IJKjMXTauH2TbpIzumOCFrqTuFd*gvqlCXRVHmoJIgUIBjmrEnht4DArpDIsmcSueg5ymY8ybskWxIacCh89nh6tfk=">微信地址</a> | <a href="http://bbs.pediy.com/thread-218045.htm">阅读原文</a>
{% endraw  %}

