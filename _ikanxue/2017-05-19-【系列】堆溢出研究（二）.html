---
title: 【系列】堆溢出研究（二）
author: TKMoma
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1495451790&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeeBDuFUhCzsMu*BB0SOQM33MAgARkNLSZo0jyCA7SaUudhiQ0fHPlvS7dX48MRKYXWpOBdPN9Ky4FUQ5FGTpkJcx51tWicSW6y1OhXp-jEvclp8LKd3*c87XYM8DpmbiqCjQnN2vHHsxY9yo3-EWIb4=
date: '2017-05-19 00:00:00 +0000'

---

{% raw  %}
<section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">调试中识别堆表</span></p></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">工具：ollydbg 2.0版本 &amp; vc6.0（release模式） &nbsp;编译选项默认 os: windows2000</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>函数的抽离</strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在堆中进行内存分配的时候，C 语言函数调用的是 malloc（）函数，c++ 中调用new（）函数，当动态调试进入函数内部的时候察觉此两个函数调用的都是底层
 ntdll.dll 中的 
RtAllocateHeap() 函数，所有的 windows 分配堆的函数在底层调用的都是此函数，这也死程序员可以看到的关于堆的最底层函数。因此研究堆分配，重点关注此函数即可。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">堆的调试</span></p></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在此之前需要理解一个概念：调试堆与调试栈不同，不能直接加载或者attach 程序，否则堆管理策略就会采用调试状态下的堆管理策略，使用调试状态下的堆管理函数。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>正常堆和调试堆的区别：</strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">1. 调试堆只采用空表分配，不采用快表分配</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">2. 所有的堆块末尾都加上十六个字节的用来防止程序溢出，（仅仅是用来防止程序溢出，而不是堆溢出），其中这十六个字节包括： <br> 8 * 0xAB + 8 * 0x00</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">3. 块首的标志标志位不同，调试状态下的堆和正常堆的区别如同 debug 下的 PE 文件和 release 下的 PE 文件类似，做堆移除实验的时候，调试器中可以正常运行的shellcode，单独运行却不行。很可能就是调试堆与正常堆的差异造成的。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">为拉避免采用调试状态下的堆，我i们直接在程序中嵌入 int3 断点，然后调用实时调试器即可，源码：</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 12px;">#include&nbsp;&lt;windows.h&gt;
main()
{
&nbsp;&nbsp;&nbsp;&nbsp;HLOCAL&nbsp;h1,h2,h3,h4,h5,h6;
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hp;
&nbsp;&nbsp;&nbsp;&nbsp;hp&nbsp;=&nbsp;HeapCreate(0,0x1000,0x10000);
&nbsp;&nbsp;&nbsp;&nbsp;__asm&nbsp;int&nbsp;3

&nbsp;&nbsp;&nbsp;&nbsp;h1&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,3);
&nbsp;&nbsp;&nbsp;&nbsp;h2&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,5);
&nbsp;&nbsp;&nbsp;&nbsp;h3&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,6);
&nbsp;&nbsp;&nbsp;&nbsp;h4&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h5&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,19);
&nbsp;&nbsp;&nbsp;&nbsp;h6&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,24);

&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h1);&nbsp;//free&nbsp;to&nbsp;freelist[2]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h3);&nbsp;//free&nbsp;to&nbsp;freelist[2]&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h5);&nbsp;//free&nbsp;to&nbsp;freelist[4]

&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h4);&nbsp;//coalese&nbsp;h3,h4,h5,link&nbsp;the&nbsp;large&nbsp;block&nbsp;to&nbsp;freelist[8]
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</span></p></pre></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">step：<br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">1. 调整ollydbg 为 just in time （实时调试器）</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">2. 直接进行编译链接运行程序，根据程序中的 int3 断点. ollydbg 会直接断在 int3 断点出如图所示：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/7629194364eabd055998d603ee5b6d709f619f15.jpeg" style="width: 500px !important; height: 237px !important;"><br><span style="font-size: 15px;"> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如上图所示程序断点段在拉地址 VA = 0040101D 处，此时使用快捷键 ALT + M 查看内存映射窗口来到如图所示重点部分已经标注出来：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/8d489eb9d7cd1a6dad4874afa59e43084c481080.jpeg" style="width: 500px !important; height: 246px !important;"><br><span style="font-size: 15px;"> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如上图所示可以、得到信息：发现进程堆地址为： &nbsp;00130000 大小为 0x6000 &nbsp;(此处可以通过函数 GetPcocessHeap() 函数获得句柄)如图：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/fc1908459ab4bb33c3f1d607c28d778b5ce2f9ed.jpeg" style="width: 500px !important; height: 264px !important;"><br><span style="font-size: 15px;"> 还有我们程序中创建出来的堆地址是0x00360000 size = 0x1000</span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">识别堆表</span></p></section></section><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><br></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">根据上图中的信息我们直接转到程序中创建出的堆地址 0x360000处在（数据窗口 &nbsp;直接 快捷键 ctrl + g ）</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/6ed8e26da945f3a1ca453f2600b497d7950234ee.jpeg" style="width: 500px !important; height: 275px !important;"><span style="font-size: 15px;"> &nbsp;<br> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">对于上图来到地址 0x360000处后，根据和堆溢出有关的数据结构我们直接关注 空表索引区即可（即偏移地址 0x178 地址处）：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;">堆初始化的状态<br></p></section></section><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><br></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当堆刚被初始化的时候结构很简单，</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">1. 其中只包含一个空闲大块（称为 “尾块”）</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">2. 此尾块地址位于 0x178（360178）处 （未启用块表的情况下）算上基地址就是 0x360688 &nbsp;(又称为freelist【0】 ) &nbsp;&nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/61726974c9084f1fa8b6f3c34dddff0d119d8405.jpeg" style="width: 500px !important; height: 241px !important;"><span style="font-size: 15px;"> &nbsp; &nbsp;<br> 3.freelist[0] 指向“尾块 ‘，八个字节 （前四个字节是前向指针 后四个字节是后向指针 即：空表中的一对指针） ，其余的各项索引都指向其自身</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">对堆块块首做一个简介 ####</span></p></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">堆块的块首占八个字节下面根据占用态和空闲态分别介绍：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/589962f718e68ebfb84f80ca14d2f78195c1ab8d.jpeg" style="width: 500px !important; height: 318px !important;"><span style="font-size: 15px;"> &nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/19637ae692d801382dedc6e78466a02e9868b7a8.jpeg" style="width: 500px !important; height: 182px !important;"><span style="font-size: 15px;"> &nbsp;<br><strong>共同点：</strong></span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">0-2 字节代表本快的大小（包括块首）</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">2-4字节表示计算单位是多少字节</span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="font-size: 15px;">不同点 </span></strong></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Flags出 占用态标志是1 &nbsp;空闲态标志是 0</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">空闲态块首后的八个字节为一对指针，分别是前向指针和后向指针。当堆块变为占用态的时候重新回分配数据。</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">实际上尾块的起始位置是 0x360680</span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">因此根据地址 0x360680处八个字节的情况可以知道：此尾块的大小是 0x130 &nbsp;计算单位是 0x0008 个字节 &nbsp;总大小是 0x980字节。</span></p><h2 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></h2><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;"><span style="font-size: 18px;">调试中识别堆的分配，释放，合并</span></p></section></section><h2 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><br></h2><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>堆块的分配</strong></span></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我们直接在cpu窗户 命令 F8单步执行程序到地址：0x00401028地址处也就是在源码中我们执行完：</span></p><pre><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">h1&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,3);</span></p></pre><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当h1被分配完以后直接查看地址：0x360178地址处的值： &nbsp; &nbsp;<br></span><img src="/ikanxue/images/bc9a9b4cd3768ed7022b055b8e1adee16795b5ae.jpeg" style="width: 500px !important; height: 168px !important;"> <br><span style="font-size: 15px;"> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">此时的地址0x360178处的值已经从0x360688改变为0x360698 &nbsp;同时跳转到 0x360698,如下图：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/2790aad889f1884353606869325e02836b8340d4.jpeg" style="width: 500px !important; height: 149px !important;"><span style="font-size: 15px;"> &nbsp;<br> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如上图所示：在地址0x360698出值为0x360178 链表的条件。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">同样的根据地址0x360688处的值即：分配的h1可以发现，h1的大小是 0x002 size = 16bytes</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">接下来直接运行到地址 0x00401059 此时直接查看 0x360178的地址出看到 值已经更改为：0x360708.接下来直接来到0x360680处进行查看<br> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">h1 - h6 的分配情况如下图所示： &nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/e431b81747ddd69f839b5985f43938f515e6955f.jpeg" style="width: 500px !important; height: 234px !important;"><br><span style="font-size: 15px;"> 如上所示：尾块现在的地址是：0x360700 大小是 0x120 = 0x130 - 0x2 * 4 - 0x4 * 2 <br> 以上从h1 - h6的分配情况验证啦 空表分配中的找零钱现象（从一个大块中依次一小块一小块地进行切割）</span></p><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>堆块的释放</strong></span></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">接着上面的程序执行，直接执行到地址：00401077地址处</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 12px;">HeapFree(hp,0,h1);&nbsp;//free&nbsp;to&nbsp;freelist[2]&nbsp;
HeapFree(hp,0,h3);&nbsp;//free&nbsp;to&nbsp;freelist[2]&nbsp;
HeapFree(hp,0,h5);&nbsp;//free&nbsp;to&nbsp;freelist[4]</span></p></pre></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">分别释放啦堆块 h1 h3 h5 这样做是防止相邻堆块进行堆块的合并。直接查看地址 0x360178 地址处的值重点观察变化的值如下图：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/27c2d23aa519a337032eb71fddb5f71605eff470.jpeg" style="width: 500px !important; height: 227px !important;"><span style="font-size: 15px;"> &nbsp;<br> 从上图中可以发现地址 0x360188 的值发生啦变化 从原来的指向自身现在变为指向：0x360688 &nbsp;0x3608A8&nbsp; <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">地址 0x360198 处的值变化为： 0x003606C8 和 0x003606c8</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">由上图可知 h1 h3分别被释放到 freelist[2] 空表中， h5被释放到啦 freelist【4】空表中。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">根据freelist【2】 的空表索引 以及h1 h3堆块的指针组，可以发现 ：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/93f118c19b086567911a2c594fc7eb64a3d9e180.jpeg" style="width: 500px !important; height: 473px !important;"><br><span style="font-size: 15px;"> 如图所示左边箭头是前向指针，顺序为 Frllist -&gt; h1 &gt; h3 &nbsp;右边是后向指针 顺序是 h3&gt; h1 &gt; freelist[2]</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">对于h5堆快倒是没啥 ，freelist【5】直接索引到 地址 0x3606c8</span></p><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>堆表的合并</strong></span></h4><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">接着程序运行直接运行到地址 0x401080地址处，执行的是代码：</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 12px;">HeapFree(hp,0,h4);&nbsp;//coalese&nbsp;h3,h4,h5,link&nbsp;the&nbsp;large&nbsp;block&nbsp;to&nbsp;freelist[8]</span></p></pre></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当释放 h4 的时候会发生堆块的合并现象（两个连续的空闲块就会发生合并）。首先是先从空表中将三个空闲块摘下，重新计算合并后的堆块的大小，然后合并成新的空闲块，链入空表。如下图所示分别为空表索引区状态和合并后堆块状态： &nbsp;<br></span><img src="/ikanxue/images/a58ec04bde51087a40ca10884c22f1d51e532ebd.jpeg" style="width: 500px !important; height: 203px !important;"><br><img src="/ikanxue/images/d633687c6fd33b4937e42f127b129852d46bc94a.jpeg" style="width: 500px !important; height: 210px !important;"><br><span style="font-size: 15px;"> 如上图所所示：地址 0x3606A0处的值 0x0008 即是：合并后的堆块的大小。后八个字节的指针对，则指向空表的索引区。</span></p><h4 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="font-size: 15px;">注意事项</span></strong></h4><ol class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">以上是空表中的堆块的合并，并且只发生在空表中。</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">整个过程比较费时，繁琐，在强调效率的情况下，堆块合并就会被禁止，设置为占用太。</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">空表中第一个块的情况下不会向前发生合并，最后一个块不会向后进行合并。</span></p></li></ol><h3 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>快表的申请与释放</strong></span></h3><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">快表和空表的区别在于 HeapCreate()函数的参数的不同。</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 12px;">hp&nbsp;=&nbsp;HeapCreate(0,0,0);//块表
hp&nbsp;=&nbsp;HeapCreate(0,0x1000,0x10000);//空表</span></p></pre></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">源码：</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 12px;">#include&nbsp;&lt;stdio.h&gt;
#include&nbsp;&lt;windows.h&gt;
void&nbsp;main()
{
&nbsp;&nbsp;&nbsp;&nbsp;HLOCAL&nbsp;h1,h2,h3,h4;
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hp;
&nbsp;&nbsp;&nbsp;&nbsp;hp&nbsp;=&nbsp;HeapCreate(0,0,0);
&nbsp;&nbsp;&nbsp;&nbsp;__asm&nbsp;int&nbsp;3
&nbsp;&nbsp;&nbsp;&nbsp;h1&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h2&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
&nbsp;&nbsp;&nbsp;&nbsp;h3&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,16);
&nbsp;&nbsp;&nbsp;&nbsp;h4&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,24);
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h1);
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h2);
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h3);
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h4);
&nbsp;&nbsp;&nbsp;&nbsp;h2&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,16);
&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hp,0,h2);
}</span></p></pre></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">与空表的申请大致类似。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">环境：与空表使用的环境一样</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">直接在dunp窗口中进行跳转到 0x360688处，此时发现快表为空。这也是为什么要反复申请释放内存的原因，接下来分别申请 8，8，16，24字节的内存，然后进行释放，（快表未满时释放到快表中）。&nbsp; <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">先运行程序到地址 0x40109F处。此时直接观察快表中的变化，此时发现让然为空，下面运行释放程序，直接单步执行命令运行到地址：0x401106处，这是观察快表的变化如图所示：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/e545eec50e1cb9c142c1aba4898f6c801f966107.jpeg" style="width: 500px !important; height: 192px !important;"><br><span style="font-size: 15px;"> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">运行程序到地址 0x40110D处观察堆块是否链如块表：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/4a0cc84b6c90c294b575ca90552a553f9da62546.jpeg" style="width: 500px !important; height: 259px !important;"><span style="font-size: 15px;"> &nbsp;<br> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如上图所示h1 - h4已经链接进入块表中并且都是处于占用态。 地址 0x361e90指向下一个堆块（因为h1 h2 同时为八字节的空闲堆块）&nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"> 当程序运行到地址 0x401140时（也就是执行完申请内存的代码时）</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 12px;">h2&nbsp;=&nbsp;HeapAlloc(hp,HEAP_ZERO_MEMORY,16);</span></p></pre></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">此时申请的堆块应该从块表中申请，此时查看堆表区的索引：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/a1712f591003ff1c3647b31dc99e2e9c9a761b01.jpeg" style="width: 500px !important; height: 55px !important;"><span style="font-size: 15px;"> &nbsp;<br></span><img src="/ikanxue/images/515460c5dc3b029385f95a627b87cded62592684.jpeg" style="width: 500px !important; height: 96px !important;"><br><span style="font-size: 15px;"> 从以上两图中可以看到当继续申请内存的时候，是从快表lookside[2]处卸下的堆块。当释放的时候，还是将空闲堆块释放到此处执行代码：</span></p><blockquote><pre><p style="line-height: normal;"><span style="font-size: 12px;">HeapFree(hp,0,h2);</span></p></pre></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">执行完后继续查看上图中地址的值：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/a2be1bbe5a64442dedd89ef71bac9fedd2443e31.jpeg" style="width: 500px !important; height: 62px !important;"><br><span style="font-size: 15px;"> </span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如图所示：当释放完堆块后还是链接进入啦快表 looksize[2]</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">你可能对以下内容感兴趣：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">等你来挑战！| 看雪 CTF 2017 攻击篇</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">【终于等到你！】看雪 CTF 2017</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=1&amp;sn=7ed476d577172ff4b4a93807dae2667c&amp;chksm=b1815a4586f6d35373f6c5d783fa99a7bb7cf2fc35da914761a9cf2d9943a09c1aefb9febfbf&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">春风十里，我在等你</span></a></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282923&amp;idx=1&amp;sn=be6293777eace8c4579dfa2688d014bf&amp;chksm=b1815b2186f6d237a72ae3dee7e29c4c2ec7a140b110daa7eb808723f58bf852e191eebcbdfc&amp;scene=21#wechat_redirect" target="_blank">蠕虫勒索软件WannaCrypt0r的行为分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282923&amp;idx=2&amp;sn=97b766ca3c3ed53d3135be937135e789&amp;chksm=b1815b2186f6d237e580205d6de5dae235d77732aa6eed5a4f124c042b59da07abcfe1c61081&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">还能和wannacry的黑客讨价还价？</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282903&amp;idx=1&amp;sn=ba8828786e9717016b399020a2427850&amp;chksm=b1815b1d86f6d20b9a60848ac2165b8ecacc8809f91851f2ffefc2bcd49f2007c07f42620f99&amp;scene=21#wechat_redirect" target="_blank">谁动了我的论文？我们来扒一扒勒索软件的前世今生</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="/ikanxue/images/a0942aca19665d63c4ee222be971a37cd63dc1e4.jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span><span style="font-size: 15px;"></span><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1495451790&src=3&ver=1&signature=l12Tij*JEXuplVxFRWdZeeBDuFUhCzsMu*BB0SOQM33MAgARkNLSZo0jyCA7SaUudhiQ0fHPlvS7dX48MRKYXWpOBdPN9Ky4FUQ5FGTpkJcx51tWicSW6y1OhXp-jEvclp8LKd3*c87XYM8DpmbiqCjQnN2vHHsxY9yo3-EWIb4=">微信地址</a> | <a href="http://bbs.pediy.com/thread-217613.htm">阅读原文</a>
{% endraw  %}

