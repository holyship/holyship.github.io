---
title: 虚拟机逃逸——QEMU的案例分析（一）
author: Green奇
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496458733&src=3&ver=1&signature=Nemr66ffk*GtagkzYwHqqrf9XEwmhGotSR4SrjzlaxJ1qox4Xls9vHUzotStT0tJ9fk5Ivde0QW-Yudpm4OGu6UYyI14nlK0fxXBGUxr-2O2GcCqB65FYRcc-TTEyXFbHMJqJFNOO7CYFLWH-h0UCF8Vkz4fGmWxFHxb1SwTVVM=
date: '2017-06-02 00:00:00 +0000'

---

{% raw  %}
<section class="" data-tools="135编辑器" data-id="89224" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" style="margin: 10px auto;"><section class="" style="font-size: 14px; color: rgb(176, 176, 177); padding: 30px; background-color: rgb(242, 244, 245); border-radius: 10px; margin-top: -16px; box-sizing: border-box;"><p style="white-space: normal;"><span style="font-size: 15px; color: rgb(63, 63, 63);">本文章，共 9 章，由于篇幅较长，公众号将分三部分发出，比心❤</span></p></section></section></section><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"></span><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">1. 介绍</span></strong><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">如今虚拟机广泛应用于个人或企业中。网络安全供应商通过使用不同的虚拟机，实现在一个可控且封闭的环境中分析恶意软件。一个问题自然而然的出现了：这些恶意软件会从虚拟机中逃逸出来并在宿主机上执行吗？</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">去年，安全公司CrowdStrike的Jason Geffner，已经发布了一系列QEMU漏洞，通过影响虚拟机软盘驱动代码实现让一个攻击者从虚拟机逃逸[1]到宿主机中。虽然这个漏洞已经在网络社区中引起了广泛关注——也许因为它有一个专有名称（VENOM）——但这已经不是第一次出现这种漏洞了。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">2011年，Nelson Elhage[2]发布并成功利用了一个在QEMU虚拟机热插拔PCI设备的漏洞。 利用过程可参见[3]。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">最近，奇虎360的刘旭和汪圣平在HITB 2016黑客大会上展示了KVM/QEMU的成功利用。他们在两种不同的网卡设备仿真模型RTL8139 和PCNET上，演示了两个漏洞（CVE-2015-5165 和CVE-2015-7504）的利用。在展示中，他们列举了在宿主机上运行代码的主要步骤，但没有提供任何漏洞利用或技术细节来再现逃逸过程。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">在本文中，我们对CVE-2015-5165（一个内存泄露漏洞）和CVE-2015-7504（一个堆溢出漏洞）进行了深度分析和利用。同时利用这两个漏洞可以实现虚拟机逃逸并在目标宿主机上运行代码。我们讨论了在QEMU的网卡设备仿真上利用这两个漏洞的技术细节，并提供了继续利用QEMU未来出现的漏洞的通用技术。比如一个用来共享内存区域和共享代码的交互式bindshell。</span></p><p><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">2. <span style="font-size: 15px;">KVM/QEMU 概述</span></span></strong><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">KVM（Kernal-based Virtual Machine）是一个为用户空间程序提供整个虚拟化基础架构的内核模型。它允许运行多个Linux或Windows映像的虚拟机。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">KVM的用户空间部分包含于处理主要设备仿真的主线QEMU（高速虚拟机）。</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"><br></span></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">2.1 工作区环境</span></strong><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">为了方便读者使用本文中示例代码，我们在这一节给出了搭建开发环境的主要步骤。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">因为我们使用的漏洞已经被修补了，所以需要找到QEMU仓库的源并恢复到漏洞被修补之前。然后，我们配置QEM只支持x86_64并激活漏洞：</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/22b3d35a815ed60951b495e42f237d07833bbfe7.png" style="width: 438px !important; height: 127px !important;"></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px; color: rgb(63, 63, 63);">在我们的测试环境中，使用4.9.2版本的Gcc搭建QEMU。</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px; color: rgb(63, 63, 63);">剩下的，我们假设读者已经有一个Linux x86_64映像并可以执行以下命令：</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/65bf27d1a843cb1cac289679d43bfcd8597a24e4.png" style="width: 449px !important; height: 74px !important;"></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px; color: rgb(63, 63, 63);">我们分配2GB内存空间并创建两个网卡： RTL8139和PCNET。</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px; color: rgb(63, 63, 63);">我们在3.16单核x_86_64架构的Debian 7上运行QEMU。</span></p><p><br></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><span style="font-size: 16px;"><strong>2.2 QEMU内存配置</strong></span><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px; color: rgb(63, 63, 63);">为用户分配的物理内存实际上是QEMU虚拟地址空间中的一个mmap映射的私有区域。需要指出的是，为用户分配物理内存时PROT_EXEC参数是不可用的。</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px; color: rgb(63, 63, 63);">下图说明了用户内存和主机内存是如何共存的。</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/c328d69b0087cc9abeb4aa9e081ae4a0532d6339.png" style="width: 497px !important; height: 364px !important;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">此外，QEMU为BIOS和ROM分配了一个内存区域。这些映射保存在QEMU的映射文件中：</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/d8ef85b63d23d30eef40604fae8ba0ba87d50e1b.png" style="width: 494px !important; height: 297px !important;"></p><table class="" cellspacing="0" cellpadding="0"><tbody><tr><td class=""><p style="line-height: normal; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 15px;">1</span></p></td><td class=""><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">&lt;br&gt;</span></p></td></tr></tbody></table><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"><br></span></p><section class="" data-tools="135编辑器" data-id="89811" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section class="" data-tools="135编辑器" data-id="89025" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><section style="text-align: center;"><section data-bglessp="30%" data-bgless="lighten" style="display: inline-block; border-radius: 5px; line-height: 2; border-width: 1px; border-style: solid; border-color: rgb(26, 227, 0); padding: 0px 20px; font-size: 14.56px; color: rgb(4, 190, 2); background-color: rgb(224, 250, 204); box-sizing: border-box;"><p style="box-sizing: border-box; white-space: normal;"><strong><span style="font-size: 16px;">2.3 地址转换</span></strong><br></p></section></section></section><section class="" data-tools="135编辑器" data-id="89808" style="border-width: 0px; border-style: none; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 0px; box-sizing: border-box;"><br></section></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">QEMU中有两个地址转换层：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">1. 从用户虚拟地址转换到用户物理地址。实验中，我们需要配置DMA（Direct Memory Access，直接内存存取）方式的网卡。例如，我们需要为传送缓冲区和接收缓冲区提供物理地址来正确配置网卡。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">2. 从用户物理地址转换到QEMU虚拟地址空间。实验中，我们需要添加虚拟结构并得到它们在QEMU虚拟地址空间中的准确地址。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">在x64系统中，一个虚拟地址由一个页地址（0-11位）和一个页号构成。在linux系统中，pagemap文件允许有CAP_SYS_ADMIN特权的用户空间进程发现每个虚拟页映射到哪个物理框架。为了便于在内核中记录，pagemap文件包含了每个虚拟页的一个64位的值。参考文章[5]：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/0f7741050ba7007a0ef0cdc080d2e19da26c880f.png" style="width: 318px !important; height: 117px !important;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">为了将虚拟地址转换成物理地址，我们使用Nelson Elhage的代码[3]。下面的程序分配了一段缓冲区，用字符串“Where am I?”填充并打印其物理地址：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">---[&nbsp;mmu.c&nbsp;]---</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;&lt;stdio.h&gt;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;&lt;string.h&gt;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;&lt;stdint.h&gt;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;&lt;stdlib.h&gt;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;&lt;fcntl.h&gt;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;&lt;assert.h&gt;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;&lt;inttypes.h&gt;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;PAGE_SHIFT&nbsp;&nbsp;12</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;PAGE_SIZE&nbsp;&nbsp;&nbsp;(1&nbsp;&lt;&lt;&nbsp;PAGE_SHIFT)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;PFN_PRESENT&nbsp;(1ull&nbsp;&lt;&lt;&nbsp;63)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;PFN_PFN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((1ull&nbsp;&lt;&lt;&nbsp;55)&nbsp;-&nbsp;1)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">int&nbsp;fd;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">uint32_t&nbsp;page_offset(uint32_t&nbsp;addr)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;addr&nbsp;&amp;&nbsp;((1&nbsp;&lt;&lt;&nbsp;PAGE_SHIFT)&nbsp;-&nbsp;1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">uint64_t&nbsp;gva_to_gfn(void&nbsp;*addr)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;uint64_t&nbsp;pme,&nbsp;gfn;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;size_t&nbsp;offset;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;((uintptr_t)addr&nbsp;&gt;&gt;&nbsp;9)&nbsp;&amp;&nbsp;~7;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;lseek(fd,&nbsp;offset,&nbsp;SEEK_SET);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;read(fd,&nbsp;&amp;pme,&nbsp;8);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(pme&nbsp;&amp;&nbsp;PFN_PRESENT))</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;gfn&nbsp;=&nbsp;pme&nbsp;&amp;&nbsp;PFN_PFN;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;gfn;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">uint64_t&nbsp;gva_to_gpa(void&nbsp;*addr)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;uint64_t&nbsp;gfn&nbsp;=&nbsp;gva_to_gfn(addr);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;assert(gfn&nbsp;!=&nbsp;-1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(gfn&nbsp;&lt;&lt;&nbsp;PAGE_SHIFT)&nbsp;|&nbsp;page_offset((uint64_t)addr);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">int&nbsp;main()</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;uint8_t&nbsp;*ptr;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;uint64_t&nbsp;ptr_mem;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;open("/proc/self/pagemap",&nbsp;O_RDONLY);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fd&nbsp;&lt;&nbsp;0)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror("open");</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;ptr&nbsp;=&nbsp;malloc(256);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;strcpy(ptr,&nbsp;"Where&nbsp;am&nbsp;I?");</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;printf("%s\n",&nbsp;ptr);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;ptr_mem&nbsp;=&nbsp;gva_to_gpa(ptr);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;printf("Your&nbsp;physical&nbsp;address&nbsp;is&nbsp;at&nbsp;0x%"PRIx64"\n",&nbsp;ptr_mem);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;getchar();</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; color: rgb(63, 63, 63);">如果在用户模式下运行以上代码并连接gdb到QEMU进程，可以看到我们的缓冲区位于分配给用户的物理地址空间上。更确切的说，输出的地址实际上就是基于用户物理内存基地址的偏移地址。</span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/d1595360e532e6def0c4034aab7299d38685dd61.png" style="width: 459px !important; height: 247px !important;"></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><br></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 14px; color: rgb(136, 136, 136);">本文由 看雪翻译小组 Green奇 编译，来源 Mehdi Talbi和Paul Fariello@phrack</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">你可能对以下内容感兴趣：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283127&amp;idx=1&amp;sn=a456b8495b438499ab68d1a2c32e543c&amp;chksm=b1815cfd86f6d5eb01205cf7c3052d428b2e9105d34523a276bdfb774c7adbbcbd197210f286&amp;scene=21#wechat_redirect" target="_blank">看雪 CTF 2017 攻击篇 6月强势来袭！</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283127&amp;idx=3&amp;sn=edffb175ea03c6c9598ba8e1d2d694cd&amp;chksm=b1815cfd86f6d5eb33a788e8a9fa2e4e77f81ea74dfa4832beb439285bdcbf9e2f60c770b7be&amp;scene=21#wechat_redirect" target="_blank">CVE-2011- 0104 栈溢出漏洞在Excel 2003下利用分析</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283121&amp;idx=1&amp;sn=f695db785889733713d011ba913e0c28&amp;chksm=b1815cfb86f6d5ed4d7fff73df9d6d5e5c2f32d935164b918b11d478b46821e2667166ac17d6&amp;scene=21#wechat_redirect" target="_blank">聊聊游戏辅助那些事上部第一篇——过掉那些讨厌的游戏保护</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283005&amp;idx=2&amp;sn=2fc411b70549c789085e517ef6dfc3e9&amp;chksm=b1815b7786f6d261975cd000d4ddf2c4cffe3cf2d8ab06d870e7971e862c29c7278996bdfb6c&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283017&amp;idx=3&amp;sn=745024d678707b6dcf0cdc94ff5472a5&amp;chksm=b1815c8386f6d59538bfeeb8d3837007f07b0b4d3cd77b439f7856edd391127b6b2f36fb105d&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283117&amp;idx=1&amp;sn=cb56cb1cb6e128609b5bcd84534f5caa&amp;chksm=b1815ce786f6d5f1a914e74b3080c4f1c2d4e186e62fdb252fbb99d791dd5af7038e95d48303&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">【OSG】macOS 10.12.2本地提权和XNU port 堆风水</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283114&amp;idx=3&amp;sn=fc763099faeb53bb8407bce865b403c1&amp;chksm=b1815ce086f6d5f60970b9c550518d07199c77e380cee90791c91a6ade3f5abd2b4c3f9588cd&amp;scene=21#wechat_redirect" target="_blank">CVE-2012-0158 两种 PoC 分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="/ikanxue/images/a0942aca19665d63c4ee222be971a37cd63dc1e4.jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496458733&src=3&ver=1&signature=Nemr66ffk*GtagkzYwHqqrf9XEwmhGotSR4SrjzlaxJ1qox4Xls9vHUzotStT0tJ9fk5Ivde0QW-Yudpm4OGu6UYyI14nlK0fxXBGUxr-2O2GcCqB65FYRcc-TTEyXFbHMJqJFNOO7CYFLWH-h0UCF8Vkz4fGmWxFHxb1SwTVVM=">微信地址</a> | <a href="http://bbs.pediy.com/thread-217997.htm">阅读原文</a>
{% endraw  %}

