---
title: Petya勒索病毒的一次详细分析之旅
author: maydayRn
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1500384871&src=3&ver=1&signature=FkzcjJJ48va4gLuFLNnuhkhH-og5pFwEaV31j2I9UYmZuCfoFGBOLJiXHWsGDm4fWeZ-VLFPoNws8A3ckZLudzlLNmcPc2B6VpSkGv8adpsua1afuF9M8HNZWi1rDynjdo39cJ6z0ij0yw1NNVu-ppTUDNuKjSjVcuCwqUBhld0=
date: '2017-07-11 00:00:00 +0000'

---

{% raw  %}
<section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">0x0</span></p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">写在前面</span></p></section><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">新人一枚，注册看雪好多年了，第一次发分析贴，有很多不足，如果发现错误，请大家多加指点。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">Petya勒索病毒在6月底爆发，然后各大安全公司都发出了相关的报告，但是出于对该样本的兴趣，以及想了解更多。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">关于该样本的技术细节，就尝试进行了一次详细分析，希望这个报告可以帮助到一些想自己动手分析该样本的同学们。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">下面就是详细的分析流程：</span></p><p><br></p><section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">0x1</span></p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">概述</span></p></section><p><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">样本名：PetYa</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">MD5：71b6a493388e7d0b40c83ce903bc6b04</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">分析环境及工具：winXp sp3、IDA6.8、吾爱OD1.1</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p><br></p><section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">0x2</span></p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">相关文件</span></p></section><p><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">PetYa.dll：样本主体</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">X.tmp :样本释放pe文件，用于提取本机账户密码的工具</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">Dllhost.dat：样本释放的pe文件，用于远程执行命令</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p><br></p><section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">0x3</span></p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">行为预览</span></p></section><p><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">1、进程自身提权、检测杀软</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">2、拷贝自身代码到堆内存执行，并卸载自身主模块，躲避内存扫描</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">3、加密MBR引导扇区数据，篡改MBR代码</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">4、创建重启计划任务</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">5、释放密码抓取以及远程命令执行工具</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">6、通过多种方式进行传播自身以及远程执行</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">7、加密磁盘指定格式的文件数据，只加密固定磁盘，不对可移动存储设备加密，通过生成AES128密钥加密文件数据、然后用样本内置的RSA公钥加密AES密钥</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">8、系统重启后加密NTFS文件系统的MFT表<br></span></p><p><br></p><section class="" style="border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">0x4</span></p></section><section class="" style="background: rgb(0, 0, 0) none repeat scroll 0% 0%; color: rgb(255, 255, 255); border-width: 2px; border-style: solid; border-color: rgb(0, 0, 0); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 8px 12px; display: inline-block;"><p style="margin: 0px;"><span style="font-size: 18px;">报告正文</span></p></section><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">样本介绍：<br>该样本为一个DLL文件，有一个导出序号为1的函数，该函数为样本整个行为的入口。<br></span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">分析过程：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">1、提升进程权限、检查当前运行的进程、打开自身pe，读取自身pe数据以及保存自身文件信息。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）首先需要写个dllload加载该样本并且调用1号导出函数：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcUFibqVd7IUiaLyU5iapfvywLrEdDwla9rR5pX6dQEia2rvWLfLic110AExQ/0?wx_fmt=png" style="width: 734px !important; height: 269.653px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）提升进程权限，如果提升成功则保存到一个全局变量作为标记：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcK2VEer4eCXU3H0579KOgXCnhIvRkInh9lKY1JoOqZrc1JU9ibR6b5hw/0?wx_fmt=png" style="width: 733px !important; height: 122px !important;"><span style="font-size: 15px;">（3）遍历当期进程列表，判断是否有预期的3个进程在运行，该样本通过自定义的算法将进程字符串计算后得出一个DWORD数值，然后与事先计算好的3个进程名对应的DWORD数值进行比较，判断是否有这三个进程在运行：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcQDYVwBFYKUO454NsBkia2pT5VriaQmhOgLNNYgOOQAxolNQI28MUNZFg/0?wx_fmt=png" style="width: 734px !important; height: 493.407px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">经过分析这3个DWORD数值分别对应杀软：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">0x2E214B44：卡巴斯基</span></p></li><li><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">0x6403527E/651B3005：诺顿</span></p></li></ul><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（4）读取自身数据到堆buffer，并且保存buffer首地址以及文件大小到全局变量：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcvV4FqoXQt04EsYqdZTIsUiansDgLrl2kliac58WZ8s5IlYgcULnfFtQA/0?wx_fmt=png" style="width: 734px !important; height: 369.587px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">2、拷贝自身pe数据到堆buffer中，并且修复重定位，然后流程转移到堆中执行代码，接着卸载掉样本自身的主模块，删除自身pe文件，然后再次调用导出函数1，这么做是为了躲避杀软的内存扫描。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）申请堆空间，拷贝自身代码，修复重定位，流程转移：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcM34GH5duKfbPdDUhBprIx5icHicqVNiaeGOyghBd6S2O2q2HNJiaRSuC8g/0?wx_fmt=png" style="width: 734px !important; height: 459.864px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）卸载自身主模块，删除自身文件然后调用导出函数1：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEczhFxnZ42rRicvicDLvZGd7BbxMqIJxLnFtLSWrdDOCVcYCBFI5kIAj7Q/0?wx_fmt=png" style="width: 625px !important; height: 344px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">3、调用WSAStartUp初始化，检查c：\\windows目录是否存在自身样本文件，如果存在则退出进程：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）初始化全局socket：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcVOF8tTDLmUGAickX5gUrpEwGgXqLPibEwic2qvPe0PxC4iaJuU6wKzu99A/0?wx_fmt=png" style="width: 521px !important; height: 17px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）检查c:\\windows目录下是否有样本自身的文件，如果存在则结束进程，不存在则创建文件：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcHpnmiaWRUrRVU2IaUNvgOdbBWvPN2GrrOJqBYdadB6DeSU4kTkibibBFg/0?wx_fmt=png" style="width: 734px !important; height: 185.866px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">4、篡改硬盘mbr代码：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）如果debug权限提升成功，则进行篡改mbr：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcGboo2dnV5d6eqEAyXr0Afq03rm6ja6bNZianUS2emuVsicaDqrW0ibPog/0?wx_fmt=png" style="width: 727px !important; height: 79px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）打开c盘驱动设备，获取磁盘信息得到扇区大小，然后根据该大小乘以10申请buffer，将buffer写入到第二个扇区中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEctL8X78TlWR2YqXzUGV1CrvD7vDRP95V3nBmnXeaX7icjP1wBadnCsibA/0?wx_fmt=png" style="width: 734px !important; height: 179.309px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcfXZUbicRCY5PlcDbUWVErNDUNL3pClxlBoUbmERTZD9lmoicTrnibFowQ/0?wx_fmt=png" style="width: 598px !important; height: 203px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEctdQ2vreVItlibYBHYdKhCQckJwZUVsKFHK2NGHnFYMyFhYwM3c0o4bA/0?wx_fmt=png" style="width: 618px !important; height: 290px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（3）判断卡巴斯基进程是否存在&nbsp;如果存在则不执行mbr篡改：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEct918ycnhDic0p5wnibtEnCghrZT07zsZ6bwFncUNMMAzOSOey2xZeBhA/0?wx_fmt=png" style="width: 734px !important; height: 72.9029px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（4）获取系统所在的盘符，然后查询该盘符对应的物理磁盘驱动器编号：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcEXpuLn5vJgTzAPmCt3HKlU82mwabrejJAsdqzV0ib4aDOmcZXsXS4ibw/0?wx_fmt=png" style="width: 734px !important; height: 191.361px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">4.1）获取系统路径：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcnicqLXVlkRLqjQ8q4iap3hWWeLD6v1RkiaFjbMwib1pWC6Ip3bM0V01tRA/0?wx_fmt=png" style="width: 677px !important; height: 229px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">4.2）覆盖后得到系统所在盘符的符号链接：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcVRDHQ7dzYoUQ1MKXw3nLSH78KSrXX1eQfCwuqic5wnh4DicH02PhK7Vg/0?wx_fmt=png" style="width: 518px !important; height: 49px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">4.3）打开系统盘符号链接，获取该盘所在的物理磁盘编号，然后将该编号数值转为字符串：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcPN7ugviazc9m8eIfSkL93eqZYvEUWQBaiabAyXfiaUwxoP6H2zzIIa7Iw/0?wx_fmt=png" style="width: 734px !important; height: 75.3511px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcKNdHS8nQTDXaxNB6lZvBvfqF61PC1KfVorarpKuun7nzqILKmBBEkg/0?wx_fmt=png" style="width: 620px !important; height: 181px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">4.4）拼接出完整的物理磁盘符号链接。拷贝到参数指向的buffer内，作为传出数据：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc8yvz4fiak7s5cLtTZJaFzzkythlIHsia2KHPOMGD25ApLJKvPqOhISQA/0?wx_fmt=png" style="width: 593px !important; height: 61px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（5）检查\\.\PhysicalDrive0磁盘设备的分区类型是否为MBR，如果不是则不执行篡改代码：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcbRVN8azLHsbbSqrDKebxrDV9fCibsAJVhKzp2YQeWEvhCHhV9XbbUicA/0?wx_fmt=png" style="width: 734px !important; height: 175.127px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">磁盘分区类型：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcuiaE0JlK2ibbOXjibNl95KOgLEkZh7xId9xJjUyCfNQlTsr2quyghtUnQ/0?wx_fmt=png" style="width: 441px !important; height: 138px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcQ2LpTfwWmiasasxBiaNuhV8IicPayp40wZvzLtvrV2icb6njhrtrkOGOPQ/0?wx_fmt=png" style="width: 734px !important; height: 103.727px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（6）生成60个字节的随机数，然后按字节取余0x3A，得出的值作为一个全局数组的下标，用该下标访问，拼接出一个疑似序列号的字符串：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc85UnoVQFW4szLUrsUrjibMiarlXCdC1EdGz419icprEf4Gvjwozk0YIjA/0?wx_fmt=png" style="width: 653px !important; height: 440px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcqTn7jmEH9suFLuichsbCZ8yb4L373PQl4N4UczyQVNmbJSgPHodzU3g/0?wx_fmt=png" style="width: 734px !important; height: 140.174px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">最终生成的序列号：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc4Ka31WzoSMUU7KWMG63gNuXDQC7iaUP67rZ5PCMzmWuGPmWN5W5mCAA/0?wx_fmt=png" style="width: 536px !important; height: 102px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（7）读取PhysicalDrive起始扇区的mbr引导代码进行异或加密：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc9kc108bCWnoxlEvWK5ricR0F3f8tXQJJAGlavT3S9Rk9ibohW4Yk67icg/0?wx_fmt=png" style="width: 734px !important; height: 318.431px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcCLicmoR0uqa3ug4EgmuVHq8eAO9WgtctLibBDultcUAp9D15SIBjNmbw/0?wx_fmt=png" style="width: 734px !important; height: 98px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">加密前的起始扇区数据：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcAzTib373sIhLSQ3KSHbFDxhcrW4nedFsHUeia6OZ5MCxkp8cv1Y86ribQ/0?wx_fmt=png" style="width: 592px !important; height: 264px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">异或加密后的数据：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcB29Vf53paSfPXPfVicVgIxl157ZnI4SxibicErGMbycvbkIIM0ic3SDAZg/0?wx_fmt=png" style="width: 594px !important; height: 194px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">接着将一个大小为0x200的栈buffer全部初始化为0x7：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcgo7BNp3P2tzLdxZNNc7xmdSEoterqmxXHPLg0fP1mNCZ7dm6eA8Txg/0?wx_fmt=png" style="width: 593px !important; height: 206px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后分别生成了两个32个字节和8字节的随机数，这两个随机数分别是salsa20算法的key以及iv，在MBR代码里面会运用到Key和iv来进行MFT加密：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc4qCTsTJjI6QeQPLb9UiaiczicJZGLajnfQLmZX8frUpNly7YG3ejGhPIQ/0?wx_fmt=png" style="width: 626px !important; height: 159px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">接着拷贝了一串字符串到栈buffer里，这段字符串为比特币钱包地址：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcrwJAic39lhGFlmpXUEMnhQdsV2HCjByI8tCb5RfBibT5A5QZZRuPuUCg/0?wx_fmt=png" style="width: 600px !important; height: 73px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（8）申请分别申请两块内存，大小分别是0x200和0x22B1，然后分别拷贝样本自身的mbr代码到这两个buffer内：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcH5C1OuukmemeYUtegb0Sr1qqPH0vUWT8WNMyKeDRqVYeKuOWNAOrRA/0?wx_fmt=png" style="width: 675px !important; height: 252px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（9）循环写入样本的mbr代码，长度为19个扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEczUicGtGXjFSmu122icGqtMtmX6JhMvr602G7asz3OZV90omw6Y7oDnWA/0?wx_fmt=png" style="width: 638px !important; height: 189px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcqovvRoSNT0yiaBCVwZeic7FayXXdEShCgDO4xLCvov7V3nQ8XzyTG77g/0?wx_fmt=png" style="width: 734px !important; height: 278.618px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">篡改前的代码：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcia2TGXibSX1Ax0G5bnSyjuv66SEl84tskeWdUv0HAxbn61JH06iboBzicg/0?wx_fmt=png" style="width: 631px !important; height: 264px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">篡改后的代码：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcL8ljTttIicMIQuLJmVv3ZDTGhZlJtr4IUKznlmSSNq7FNNicqL0DJFiag/0?wx_fmt=png" style="width: 634px !important; height: 219px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（10）然后将之前通过60字节随机数当做下标生成的序列号字符串、以及用来加密MFT的32字节的key和8字节的iv、</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">还有样本内置的字符串数据（经后面的分析得知该串为比特币钱包）写入第32个扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcXLZRcs28hSXYYQ5sFicMmgFf0rYSo2FPJwVOAIsb9pRCOZMwxETr3Jw/0?wx_fmt=png" style="width: 734px !important; height: 61.468px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcnOibUvdLM9PFZmrWJX7Leyz7mcKA0bfTqcuCIbxozdg2Gv7vnKqcS2g/0?wx_fmt=png" style="width: 734px !important; height: 288.756px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（11）将之前初始化全是0x7的buffer写入第33个扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcWkDj6arswDibfHH2MRftibnicEkOb0uDekG4tRIEW8nbeXbiaFdWxhWnFA/0?wx_fmt=png" style="width: 734px !important; height: 28.288px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcv91kz5dY7efuDntvezaSh9aiaCyUZdsDQwH0vLiaGf2n5xicYUxCoibkvg/0?wx_fmt=png" style="width: 491px !important; height: 243px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（12）将加密后的起始扇区mbr引导代码写入第34个扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcf82pNhOPVXMKPDH8rIyEVFatkMxQAKvZ2kco6Slw5EkFOvltkQfNtg/0?wx_fmt=png" style="width: 734px !important; height: 59.6671px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcgqQWAMrjpUd8BaK4bRou0kv60ic1GsVdNKadJZGCHdB05Ak10LpmZkA/0?wx_fmt=png" style="width: 615px !important; height: 330px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">5、创建重启的任务计划：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEczr2qicydaiaMtPTZCnJIhDsRAvPN1e77T8VpuXCGGAbhOwEibmiap4ibr4w/0?wx_fmt=png" style="width: 734px !important; height: 322.802px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">该任务计划是在样本运行之后一个小时进行重启：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcbMSxoDZrql1446bpDmVtmowyz8iav2vCm3POhYo83VFD22atsicqAMcA/0?wx_fmt=png" style="width: 585px !important; height: 259px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">6、样本自身的传播与远程执行&nbsp;首先该样本通过三种途径传播自身：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）&nbsp;通过局域网勘测，检测一些可以访问的内网ip并且保存起来，然后对这些ip进行传播自身并且远程执行自身。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）&nbsp;通过windows远程桌面的登录凭据记录，获取这些凭据来进行传播自身以及远程执行。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（3）&nbsp;通过（1）步骤获取到的ip地址，利用永恒之蓝漏洞进程传播 。<br></span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">远程执行的方式： <br></span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">样本通过WNetAddConnection2函数连接远程主机，然后将自身pe写入到远程主机的c:\windows目录接下来通过两种方式执行：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">通过资源中释放出来的psexec的远程命令执行工具去运行rundll32.exe&nbsp;，通过该系统exe加载自身dll并且执行导出函数1；</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">通过wimc运行rundll32.exe&nbsp;，通过该系统exe加载自身dll并且执行导出函数1。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）创建线程，进行可攻击ip的勘测，首先样本首先会调用同一个函数初始化两个0x34大小的结构，接下来会对该结构进行分析说明：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc22ml7vjcz1JdbFM7JLtJgFxiaHP9tjwn2ib27nLkwRwG1UoAuicfNKkeQ/0?wx_fmt=png" style="width: 596px !important; height: 34px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">结构初始化函数：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEccjBibSrARdDNvIJia4yJFJgWWcLOiabRCsxm9R4JV8gOceWK4yxicmV1BQ/0?wx_fmt=png" style="width: 734px !important; height: 281.106px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">经过分析还原出如下结构体：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcIO2a4dhnZOZIOwoZiavdpzoAJW12y56bAw49UcD9Vh6d8VSGvCFvuLw/0?wx_fmt=png" style="width: 734px !important; height: 174.943px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">调用该函数初始化的结构体，作用是用来保存一些信息，这些信息用来后续的自身传播以及远程执行，接下来经过实例来说明该结构的作用：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">1.1） 首先样本拿到了之前初始化好的结构，然后调用函数，参数分别是一个ip地址、然后是一个常量值、接下来就是结构的首地址，<br style="color: rgb(68, 68, 68); font-family: none; line-height: 21px;">该函数的目的是要将参数1的字符串数据添加到参数3的结构中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEctbEK1N9OicsA6KXvpePjehfs7021S45lKIanHKEgVvpicsx870PAzYIw/0?wx_fmt=png" style="width: 553px !important; height: 52px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">1.2）10006FC7函数分析：该函数将参数1的字符串拷贝到栈内，然后调用函数10007298，参数分别是结构首地址、拷贝到栈内的字符串、以及外面参数2的常量值：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEccR1AfMghEFryrhvANkwIGj1YaRZt65KJfsEgkCcic9xK9BicicY3mCaHA/0?wx_fmt=png" style="width: 734px !important; height: 307.163px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">1.3）10007298函数分析，由于该结构内有临界区对象，造成idaF5错乱，所以下面贴出反汇编代码。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">首先使用结构中的临界区对象进行同步，然后判断要添加的字符串是否已经存在于结构中，如果不存在则添加：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcXmuAJGl54yARb9u0L8tNHicovd4KVqJctqvBU1ZcBxBAtkQrF8uXs7A/0?wx_fmt=png" style="width: 674px !important; height: 343px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">接下来判断m_pppPointerArray数组的当前下标是否已经超出最大值（m_IndexRange）&nbsp;如果超出则不添加：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcnuOpPI0mOwLawp7eoJRich2Cflz4ZgVYH4HTUOibXqa50ZiaiaZicYslF6w/0?wx_fmt=png" style="width: 734px !important; height: 72.7387px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后申请8字节大小的堆内存，如果申请成功，则将该内存首地址根据m_CurrentIndex下标保存在m_pppPointerArray数组中，并且这个堆内存是算是个二级指针：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcWVft3kuicWQH9pcibruZibeic4ZZNVQoNYDicIQvDs0gicq6Ct00503Lh4Tw/0?wx_fmt=png" style="width: 650px !important; height: 162px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后再次申请堆内存，大小为结构中的m_remote_buffer_size成员，这次申请的堆内存是用来保存参数2的字符串，如果申请成功，则将该段内存的首地址保存在上一步骤中申请的8字节堆内存的首地址处：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcxjxtDKyHvOBKTKgpYy8uBIf788AHSm4uvkq94JHicxNs8FdJLjhTxsQ/0?wx_fmt=png" style="width: 734px !important; height: 177.408px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后将参数3的常量值，这里暂时看作为flag，将这个常量值保存在第一次申请的8个字节堆内存首地址+4处：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcBhANNthlkR6fKPeX5oX8PsqqC6WfJ6vJBQVHibV5lbibYOMUQOUz1lNA/0?wx_fmt=png" style="width: 693px !important; height: 80px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">接着拷贝参数2的字符串到第二次申请的堆buffer中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEctOeicw1sNowA8QaaPPNPAwN2ibwibia3Ngal1xcVeYzB0BQ5SLNpcFicSkg/0?wx_fmt=png" style="width: 665px !important; height: 107px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">到此一个新的信息就添加完毕了，接下来用od调试一下上述的过程，<br>此处调用10007298函数进行将参数字符串的信息添加到结构中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEctFYwqBE6X0woAiav78vkbeuAKm2UphqgHRjh2TR3h7q9iaVJOCMwWaYA/0?wx_fmt=png" style="width: 631px !important; height: 234px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">参数：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc3to6sOj01jstmA1vhWys78uPGrDTdNImJmlVl1qRbGr1EveFkzl5hg/0?wx_fmt=png" style="width: 475px !important; height: 99px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">接下来在内存中查看该结构的分布情况：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcmiaGQia8sc57k9jWKa1dBUx9hVNVZ6VjUGLamwL0SUGViaB98sWVurJwg/0?wx_fmt=png" style="width: 680px !important; height: 139px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc6G3TBUxEQrRQmZJ8pvauLNLoQF05wkelB8mHRxq9DnMPWYFbiclduwg/0?wx_fmt=png" style="width: 710px !important; height: 363px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">根据上面静态分析添加远程传播执行所需信息的过程，首先m_pppPointerArray中保存了一个8字节大小的堆buffer地址：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcfc4bltxU3OhVHJ0jyyhMqTcrMq8hnx7bmfptyVudHMBllwfJ65GBrg/0?wx_fmt=png" style="width: 482px !important; height: 121px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后继续查看这个8字节大小的buffer：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc6WRChzQZ0WUw6KwibyZMAS1rmas3iaNS72am5GZpia0hibKRQf8fp8dkicQ/0?wx_fmt=png" style="width: 605px !important; height: 111px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">继续查看第二次申请的buffer：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEckTGdd0vXL7VW4CUW0icKicM9uSrLM9dZAOzFFC7rXHL8Aiaysv7nMk0iaw/0?wx_fmt=png" style="width: 630px !important; height: 102px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">可以看出该buffer保存了参数中传进来的ip地址信息。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">tag_remote_penetration_info结构分析总结：该样本中大量运用了这个结构，该结构用来保存各种样本后续传播感染所需要的信息，<br style="color: rgb(68, 68, 68); font-family: none; line-height: 21px;">经过后面的分析已知的信息有：后续代码勘测到可以攻击的内网ip以及远程桌面登录的凭据的TagetName以及账户名和密码。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）获取本机NetBios名称，以及回环地址、loaclhost等字符串信息拷贝到tag_remote_penetration_info结构中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcB29O3DUKib3R5g98ytx8jgxLZic9pUxp3Tz6licGdraJWibzfYhAq1yk8Q/0?wx_fmt=png" style="width: 734px !important; height: 83.1257px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（3）获取本机网络适配器信息链表，遍历该链表将所有适配器对应的ip地址以及dhcp服务器地址保存在tag_remote_penetration_info结构中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcPnJlXIB5dL3L1uLralm0Wor4deHXVNPocBXpn1etFIdkyg4keC1esg/0?wx_fmt=png" style="width: 734px !important; height: 378.887px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（4）检查当前系统是否是域控制器或者是Server，如果是则枚举dhcp内网池中的ip地址，保存在tag_remote_penetration_info结构中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcHC13bkGnn13Uey8SoqqVGg2AEO23I6Z2fSJJonlof0N1zPicwd49LoA/0?wx_fmt=png" style="width: 734px !important; height: 454.698px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（5）计算出本机ip的ip段范围，例如本机ip为192.168.1.111，则计算的范围就是192.168.1.0 - 192.168.1.255:，计算出这个范围后创建线程，<br style="color: rgb(68, 68, 68); font-family: none; line-height: 21px;">该线程尝试使用socket连接本机ip范围的所有ip地址，连接端口为445和139，如果可以连通，则将这些ip地址全部保存在tag_remote_penetration_info中，<br style="color: rgb(68, 68, 68); font-family: none; line-height: 21px;">该步骤是在为后面利用永恒之蓝漏洞攻击进行环境勘测：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc7sNOkJZPKUqZe3nkqNokUwOO4U0iaJDWuqoBvuG1Ff4YMhqqicRWGBSw/0?wx_fmt=png" style="width: 734px !important; height: 328.291px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcnpC6SwWQ9nx1FHXXrFCnICYanPcsJSxB4OibNLORVZPNYSe47A2Exrw/0?wx_fmt=png" style="width: 734px !important; height: 275.149px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEctNRHcra2xmgpXpKX6MQMS7oJc9JrtbcfdiaOdh6YwMukrqK0AzReEXg/0?wx_fmt=png" style="width: 734px !important; height: 81.2704px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcQVuW0H2w3Vmamgx2LJE7EfjKGXObe6afjOmCzWNKianXI31EXETEG9Q/0?wx_fmt=png" style="width: 550px !important; height: 543px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（6）接着死循环分别调用函数来进一步获取可攻击的目标：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc0pkd2icibxBfTHfjBTF2WYuibTKpniab901599icFlPgMJwDjibB0cNIa1zw/0?wx_fmt=png" style="width: 734px !important; height: 132.721px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">上述的各步骤勘测出的一些ip全部都加到tag_remote_penetration_info结构中，该结构也就充当了一个可感染的ip列表，之后的远程传播以及执行代码则会用到这个ip列表。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（7）加载1号资源，解密资源数据为一个pe文件，接着释放并执行该pe文件，这个程序是类似mimikatz的系统密码抓取工具，并且该工具的输出进行了管道重定向。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">它会向命令行参数内带的管道进行输出系统的账号密码。接下来通过guid构造出一个管道名，然后创建该mimikatz进程，命令行参数为构造的管道名，并且同时创建线程，等待mimikatz线程连接该管道进行与mimikatz进程的通信：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcDiaRmk6micxfibtSRicNSnQ70ficvg3NGmzDQWe17icmKHicdohq4Yic75icmtw/0?wx_fmt=png" style="width: 734px !important; height: 397.182px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">创建进程：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc9uLngic7ajlGN1XcWqZ2ZST5JDITogZz6ReLKOIvsEuYHrW6Z0FVJhw/0?wx_fmt=png" style="width: 734px !important; height: 146.315px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">创建线程：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcibvlrK6eJxDibsV0aura9kAtRKbpfa8DbZWjRpvVfTtL4gdQCEDf3uTA/0?wx_fmt=png" style="width: 734px !important; height: 460.47px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（8）加载3号资源，解密资源数据，3号资源保存的pe数据为psexec远程命令执行工具：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcKHZicJwnI2sh6ibqqqFmOySAhUcTEc6ER0LhxtaSicg1GHJXCaIVUm4qQ/0?wx_fmt=png" style="width: 734px !important; height: 619.081px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（9）新申请一个局部tag_remote_penetration_info结构：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcDg7WxK2CmwRoyicJEjb0cf41OzXSZ8NYCrbRsuJ5p7l1Je3QFZWVJiaw/0?wx_fmt=png" style="width: 601px !important; height: 18px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（10）枚举系统凭据，并且将TERMSRV类型，也就是远程桌面登录的凭据过滤出来，保存其TargetName以及远程登录的系统账户密码，TargetName保存在局部tag_remote_penetration_info结构中，然后账户密码保存在另一个全局tag_remote_penetration_info结构中：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcauHPWF7UOCzb2j5RpF9AFWmqdzxpd98IrTXiau3E9qkBwLDbql4VMLw/0?wx_fmt=png" style="width: 734px !important; height: 717.888px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（11）接下来程序将利用远程桌面的登录凭据尝试远程连接主机，进行传播自身，并且通过wmic或psecex进行远程执行，而且之前获取的可攻击ip的列表，也是通过相同的方式去尝试连接并传播自身，远程执行：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEciaSHXDOPiaslATfiahAKVo3enYibBib88xLnlToeMg0nmcWIadmurrg4hog/0?wx_fmt=png" style="width: 734px !important; height: 574.47px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcCPtwueqL7pKWeJic2MhQy4dH3aROAvwAHYGvNtj7cBGojXME8DU0TQg/0?wx_fmt=png" style="width: 734px !important; height: 320.664px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">可以看出，将自身文件传播到远程主机以后，构造两种远程执行的命令，同样利用rundll32去加载自身样本。</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">远程执行：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEch6ibC6lwa1RXN5Ryfh59UNUUVbnqkcyjdnujHZibeokLMoRUHZ4w1iatg/0?wx_fmt=png" style="width: 734px !important; height: 354.798px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">Psexec命令：Dllhost.dat \\TargetName -accepteula -s -d C:\\Windows\\System32\\rundll32.exe \"C:\\Windows\\petya.dll\",#1&nbsp;<br style="color: rgb(68, 68, 68); font-family: Calibri; line-height: 21px;"><br style="color: rgb(68, 68, 68); font-family: Calibri; line-height: 21px;">Wmic命令：C:\Windows\Wbem\wmic.exe /node:&lt;TargetName&gt; /user:&lt;UserName&gt; /password:&lt;Password&gt;process call create&nbsp;<br style="color: rgb(68, 68, 68); font-family: Calibri; line-height: 21px;">\”C:\Windows\System32\rundll32.exe “C:\\windows\\petya.dll” #1”</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（12）利用之前获取到的攻击ip列表（可以连接上445、139端口的ip）进行永恒之蓝漏洞传播：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcDNRACZh8jpubszLB1puEPNFa3rpDxzkZXMrs9yicC5ApH1gOJVegAnQ/0?wx_fmt=png" style="width: 732px !important; height: 646px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">7、文件加密</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）首先样本会获取系统所有的盘符，然后进行循环遍历盘符，判断盘符类型是否是非移动存储设备时，则开启线程进行加密：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcsibw2y1GFkaExXibXEgkE9HC17t9k6HaIW5lvPbxyibAl1Jk4Rjm2daPQ/0?wx_fmt=png" style="width: 734px !important; height: 367px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）文件加密过程</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">2.1）获取csp密钥容器句柄：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcHTXYsgBicnnQAJRmej7BdibrII8EibGIicLmjSZYLZmz2K8zO0pImYPLDQ/0?wx_fmt=png" style="width: 732px !important; height: 128px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">2.2）通过密钥容器句柄获取AES128密钥，保存在回调参数的buffer+0x14偏移处：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc8icpicW60y3wb4iczPexXxTib6ZaiaetaZum1qEdyyAol8mykxgMopXxWow/0?wx_fmt=png" style="width: 734px !important; height: 193.643px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">2.3）开始递归遍历文件，递归层数为0xF，如果文件夹深度大于0xF则退出递归，然后判断文件是否是要加密的文件格式，如果是则进行加密：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcRMRxYFYILibM4ibpwtibFWQKrOLqSBwyYozutiaKRe1BKFdj26kZ4EsogA/0?wx_fmt=png" style="width: 734px !important; height: 374.928px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcaBBvhOibrITxLibBND12vHgetsYUCKdguuqviaErVVFeklduJnMJgw0Eg/0?wx_fmt=png" style="width: 734px !important; height: 262.201px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc5bY7o2S0ln5WyCrmHsxAW6PegP9aRe564mV5cmR0mxuEnVtMpn8FYA/0?wx_fmt=png" style="width: 732px !important; height: 538px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（3）加密流程：样本针对每个盘符申请一个AES128密钥&nbsp;---&gt;&nbsp;用该密钥加密文件&nbsp;---&gt;&nbsp;接着用样本内置的RSA公钥去加密AES128密钥&nbsp;---&gt;将加密后的AES128密钥保存在文件中</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">3.1） 导入内置RSA公钥：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc9OhJF8BBGiacnicD6r0km1r6RAzEfmRc4UT7PWQia1HLujFgo1fPgCgDg/0?wx_fmt=png" style="width: 734px !important; height: 381.185px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">3.2）利用RSA公钥加密AES密钥：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcKqumEw4uudjvsbOxIaPOY4LMZicTFwwLj9Id4UianOhoQoavzOaVjgFg/0?wx_fmt=png" style="width: 734px !important; height: 171.895px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">8、保存说明信息到加密盘符的根目录</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcElf0SfVN30sibIBaatsKroFAx9xaWnk1xnysU3E21XPfQcBHOVA9wfA/0?wx_fmt=png" style="width: 734px !important; height: 325.123px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">9、样本篡改的MBR代码分析：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（1）调用int 13中断，将扇区1-32从磁盘加载到内存0x8000开始的地址，然后流程转移到0x8000开始执行指令：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcwfPgM6Psul95F9FHtJZ1AhZysribysZZ5q6EaIdZeK5D9Eu2Ljpnstw/0?wx_fmt=png" style="width: 656px !important; height: 120px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcLe8cw43dPJsnJnsTqr3KTYoJUkRT92SHqIROgVmmCJ0SCIteOCmfGg/0?wx_fmt=png" style="width: 569px !important; height: 244px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（2）调用int 10中断，设置一些屏幕显示模式等信息：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcNzF3xhfdibMn0AQPbD9xZ8Sia4VGZiaUmZbhdGyXECds8tQUIpASPciaIQ/0?wx_fmt=png" style="width: 520px !important; height: 197px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（3）调用int 13中断&nbsp;42h功能号，读取0x20扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcKHlo2fsBTWpzQthHlfaHxRNh8A7ODibiaxJELicZr1NnBoba2AHA6RzWA/0?wx_fmt=png" style="width: 479px !important; height: 99px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcRZ2QAmibVb194nEwVrrB1psXDvVjyFubHoWshtsaKt3D57YCdCPzuibg/0?wx_fmt=png" style="width: 639px !important; height: 150px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">经过之前的分析，该扇区存放着salsa算法的key和iv，以及比特币钱包，随机生成的用户序列号等：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEch3v4nVFHXlMz4Zd5ib2ic0j69aicdCw1XVFuT0Znkc7L6vhyJKTEwCq0g/0?wx_fmt=png" style="width: 540px !important; height: 252px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（4）通过检查0x20扇区首字节，判断加密标记，如果为1，则代表已经完成加密，直接显示勒索信息，如果为0，则执行加密流程：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcppBQYBh24BW6xcia2Rwuic84WeHg27jFyklj9c8cjvEx9aLeDMXFne2A/0?wx_fmt=png" style="width: 617px !important; height: 326px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（5）调用int 10中断，显示病毒伪装的磁盘检查界面：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc1Wp64hgDMlqx7icU04s16Bw1QffWUtXNz0bzJLB8nN8uzvjqex9jlxQ/0?wx_fmt=png" style="width: 516px !important; height: 74px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcv61nJUiaWR3KE7cZoGiatHB3lbddm9j6bueXMAPLFonBTPBfxjM741zQ/0?wx_fmt=png" style="width: 544px !important; height: 285px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcDxA9F8prklXexW5QXbpWKCOibDMxKiazV7lFILzkiclrgVG8QMeicib7QSQ/0?wx_fmt=png" style="width: 571px !important; height: 145px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcavI6vUfonZLibmhzgMwXNjKz3cfibaDVTGg7lt6iatgUrvsXFYeZ7yiamA/0?wx_fmt=png" style="width: 696px !important; height: 185px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（6）将加密标记设置为1，然后拷贝0x20扇区buffer的salsa key到栈buffer内，然后抹掉原buffer内的salsa key，防止用户使用该key解密MFT：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc14p2ZYw34O6ubQmibREqGguXa2eoH0ZcNdwS99IQExfPSjJGc9W0FVA/0?wx_fmt=png" style="width: 716px !important; height: 298px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcUoMu8bYicXN9XCMexBLlOA0Pj6Hun9b2DaBaNKVibJ9QPEMfDJicss8oQ/0?wx_fmt=png" style="width: 680px !important; height: 100px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（7）将已经设置加密标记以及抹掉了salsa_key的扇区buffer数据，在写回0x20扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcs4h1sIzwVkwPkkySZ0R8M7YDwicUPYJONbDhAnbVtLR8UtLJtiblDcUQ/0?wx_fmt=png" style="width: 513px !important; height: 107px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEciaca4dj0qQE0Szc97lTCHULeEAUqmicJ2MzmsKXiaqLk0wX7MP5ge5JpA/0?wx_fmt=png" style="width: 722px !important; height: 190px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEccicFvuBAnOX5MSyhpPIUpO6riawSpiadrLznxpyoz4ehJdWulH7ZkY3Yw/0?wx_fmt=png" style="width: 679px !important; height: 164px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（8）读取0x21扇区数据，然后调用salsa加密该扇区数据，加密完成后写回磁盘：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc0vy4H1Bc7LVvaWUOfJzKY8WP5mV7kL5O56OF6CPv2ic97X7p0d1qTfA/0?wx_fmt=png" style="width: 526px !important; height: 118px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcS8hvDbGgvATvs9bD6JyVb5QvI5ky9DFcKKh41yYsXqxWRbJtXZicmXw/0?wx_fmt=png" style="width: 606px !important; height: 164px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">数据buffer：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcq4rhw4baoXAKK23pQqHic2WKXnGNPAulWFmXFp3LdicMSKdb8KeKYXOg/0?wx_fmt=png" style="width: 582px !important; height: 221px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">加密函数调用：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEczBZMd3ib89711YNmJcOWthwLA2ZJibHyicTmrv1tBIrFRJFlZahkNMadQ/0?wx_fmt=png" style="width: 565px !important; height: 131px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">参数：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc1eYD9PJgoQaJfKPCbTPlOwAOJbjcLGs4KWpwTUR0vtNVULB56coNdg/0?wx_fmt=png" style="width: 734px !important; height: 106.813px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">加密后的Buffer：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcymYNxclDwW5KbHDO8uyl55sqNwd72aUPRzRJpO8ic5wng4VIWQia49EA/0?wx_fmt=png" style="width: 634px !important; height: 170px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">然后写回0x21扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEce0wR1csGV57iaUSkjLIfTWFvrQdqtKYhIDm2AcKCgE0nw2cHBwFCRxA/0?wx_fmt=png" style="width: 669px !important; height: 116px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（9）读取0x22扇区的数据，该扇区保存了mbr引导扇区加密后的数据，然后在循环单字节异或0x7解密mbr引导扇区代码：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcT9p2O1kASVPZpyR7dZPFPu9xjzKM1qj8nDw1oF8ty7abywNRNS6ddA/0?wx_fmt=png" style="width: 633px !important; height: 124px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcfry1OypVtKLd4glmmmE3yiahUlVWCuPrkDGMnMqaC8Jjs0bI8AnSXlg/0?wx_fmt=png" style="width: 648px !important; height: 170px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">解密mbr引导扇区：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc9qDZqVCNBqibCeDq46UW2ZukVG51NgrLazheYJAdgkXKKIRsrqT0DRw/0?wx_fmt=png" style="width: 639px !important; height: 115px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcuU6lbGY0FKfLju18vb9YFBPcmPbcLyzHYUepBeY1sia1wvG3TvdQNMw/0?wx_fmt=png" style="width: 652px !important; height: 281px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（10）遍历MBR引导扇区内的分区表结构，进行判断分区类型、以及保存引导扇区起始到磁盘扇区起始的相对偏移量、以及每个分区的扇区总数：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcBzaXcHLeE00yVHfumXdPbUZtG1Mu6cKk7spTQJzIK8JtTZpV8mRFkg/0?wx_fmt=png" style="width: 702px !important; height: 547px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（11）通过扇区起始的相对偏移量0x3F，也就是c盘分区的起始扇区号，读取该扇区号的数据，该扇区保存了c盘分区的NTFS结构：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc9Ov2ql8EMRiavrAAX9wW5myskrXdIAh8tqicxjXUxKNdfibsUianQQ024Q/0?wx_fmt=png" style="width: 695px !important; height: 210px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">Buffer数据：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcZhxddLPtDicB2a68pCNFKKaXHs9z8E0Y2x8YcC54SGBSJicicd2jqhfag/0?wx_fmt=png" style="width: 650px !important; height: 437px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（12）通过（11）步骤得到的NTFS结构，取出DBR结构中的MTF起始簇号*每个簇单位的扇区数 得到一个扇区号，然后用该扇区号+0x3F定位到MFT表所在的扇区位置：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcktoicLibO2eewiaEBr60C1y8azykiaEyHjhx5vbzEQDRvvWjRvHXXGjAeg/0?wx_fmt=png" style="width: 734px !important; height: 165.089px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（13）读取MFT扇区表：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcRQ5QPdicFrJDSXLic2RNYDuibiaZDiclKiaaXVUwb9LE5SMgw4PSzCU5lTibg/0?wx_fmt=png" style="width: 640px !important; height: 107px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcTradqZgd1TjzBYs5tk4Nc2tMJ5UV9CJsElcvBsVHxFM6N94x0OkwLA/0?wx_fmt=png" style="width: 734px !important; height: 162.89px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（14）调用int10中断显示磁盘检查进度：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcD0rS4kvnLKvlZ9xWwNHOD8Exm5KgiblkWaicK7PnqH9LGxQEDdq6MkWA/0?wx_fmt=png" style="width: 620px !important; height: 404px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcNDkBX6ibCGr3UwPFaAhktqEDQRaIjCCUl6lgmicCAlVHvwTkVkxtargA/0?wx_fmt=png" style="width: 713px !important; height: 233px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（15）循环遍历读取MFT表，通过检查MFT的FILE标记判断该表是否有效：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcI7mCJtDHrJTHubiapTqvqyRptme544DyUJYkonhbKzSao4UGSIc9oUw/0?wx_fmt=png" style="width: 674px !important; height: 148px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（16）如果15步骤的检查通过，则开始遍历MFT表中的属性结构，遍历每个属性结构的属性类型，如果具有属性类型为0x30，<br style="color: rgb(68, 68, 68); font-family: none; line-height: 21px;">并且属性文件名开头有$符号，则加密该MFT表，如果没有30属性，则检查0x80(数据流)属性类型 有该属性类型的MFT表也进行加密：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcMsDJTrXa7QtRokrgmIyUEWMgeSuGVaO6WRjcPIdxa5z1F5JBy0tV1g/0?wx_fmt=png" style="width: 734px !important; height: 340.002px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcbGsXicslKoBRKMZpBpS2jjozibTASqEl3DX4MA6T0NaTpRJgd7qib0yrg/0?wx_fmt=png" style="width: 734px !important; height: 102.564px !important;"><br></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcpxeocNiaYtwbDX9u1ia8bkI0tWZ8INGwV8SDIKUjTJiaLFRpQWFSPU7HQ/0?wx_fmt=png" style="width: 734px !important; height: 79.202px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEcmhWhWVx5Le8QKLwiculCXbSxmfgly7lN8JqSVsGzgBn9GjVFwR7TzTQ/0?wx_fmt=png" style="width: 734px !important; height: 171.559px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc70EvI1ib4w7UyBCLeOKPAg6jDZrmgcyEbxkrYibAZibzexAkC1zFBaUZw/0?wx_fmt=png" style="width: 734px !important; height: 108.632px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;">（17）一个MFT结构加密完成后，则读取下一个MFT表，在重复执行（13）--（16）步骤：</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc0zlUTlqRlJCNLCAoHialjHb6WqS64D3dy1OJJblZCUuCS078JXjktZA/0?wx_fmt=png" style="width: 729px !important; height: 134px !important;"></p><p style="text-align: center; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="color: rgb(136, 136, 136); font-size: 15px;">本文由 看雪论坛 maydayRn 原创，转载请注明来自看雪社区<br></span></p><p style="text-align: center; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="color: rgb(255, 104, 39); font-size: 15px;">如果你喜欢的话，不要忘记点个赞哦！<br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_gif/1UG7KPNHN8G6kVfOtWaiaf9AwhniaXWPEc9hqDcHce5Ir40eYF2j3h2OPDe9VOOw8XYhicnhxfxpfh5uXZFGrwjww/0?wx_fmt=gif" style="width: 658px !important; height: 368px !important;"></p><p style="text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="color: rgb(63, 63, 63); font-size: 15px;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">热门阅读文章：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul style="list-style-type: circle;" class="list-paddingleft-2"><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283175&amp;idx=1&amp;sn=c799c0b1773dea71c74457c446cb2c59&amp;chksm=b1815c2d86f6d53b6e6722395e4d3d4cfdd2af00131e0462b3a19767bf4e271dd8ead5c8e35b&amp;scene=21#wechat_redirect" target="_blank">选择看雪企业 SRC 的 5 大理由</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283930&amp;idx=1&amp;sn=10ee30d52b572f38ae6f5998ea8af20c&amp;chksm=b1815f1086f6d606a6f9db4656d772d7d090f5ac06d56edb7aef8cf96a625f570ed04a859f19&amp;scene=21#wechat_redirect" target="_blank">工控安全入门之Modbus</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283930&amp;idx=2&amp;sn=e766f70bc83f2c8762f4722b27eb985f&amp;chksm=b1815f1086f6d6068378f46f36964817c519fd49ed1ad563ac91ccdd953fea658becd0933e76&amp;scene=21#wechat_redirect" target="_blank">给腾讯TIM插入广告木马（二）</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283585&amp;idx=3&amp;sn=a7dc01fb0dca60054a4cd8aba4f3e9a8&amp;chksm=b1815ecb86f6d7ddbe2fb1f42592fe3c27aa814cf1e7fd1695e524af437f781ec48cd27efadd&amp;scene=21#wechat_redirect" target="_blank">黑掉SQL Server数据库链接：实验的设置和攻击指南</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283627&amp;idx=2&amp;sn=1ed3120f3b060dc5cccfd37add8fce45&amp;chksm=b1815ee186f6d7f75a6d74837204683da588dc1d4fa8fe1f94b4399eb54e4e08c097267556f1&amp;scene=21#wechat_redirect" target="_blank">黑掉SQL Server数据库链接：实验的设置和攻击指南（二）</a><br></span></p></li></ul><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; text-align: left; letter-spacing: 0.5px; margin: 15px 1em; line-height: 1.75em;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63); font-size: 15px;"></span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8F7ckRiaZtp76v0KXiaibibdH9bCfZtDdhqeqbk5LToic1TlqZZJ05wLxqexpbloufvSCKbUEPbEtFUzzQ/640?wx_fmt=jpeg" style="visibility: visible !important; width: 734px !important; height: 489.142px !important;"></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="font-size: 15px;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important; color: rgb(63, 63, 63);"></span><span style="color: rgb(136, 136, 136); font-size: 15px;">&nbsp; &nbsp; 看雪论坛：http://bbs.pediy.com/<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="color: rgb(136, 136, 136); font-size: 15px;">&nbsp; &nbsp; 微信公众号 ID：ikanxue</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="color: rgb(136, 136, 136); font-size: 15px;">&nbsp;&nbsp;&nbsp; 微博：看雪安全</span></p><p style="letter-spacing: 0.5px; margin: 15px 1em; text-align: left; line-height: 1.75em;"><span style="color: rgb(136, 136, 136); font-size: 15px;">&nbsp;&nbsp;&nbsp; 商务合作：wsc@kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1500384871&src=3&ver=1&signature=FkzcjJJ48va4gLuFLNnuhkhH-og5pFwEaV31j2I9UYmZuCfoFGBOLJiXHWsGDm4fWeZ-VLFPoNws8A3ckZLudzlLNmcPc2B6VpSkGv8adpsua1afuF9M8HNZWi1rDynjdo39cJ6z0ij0yw1NNVu-ppTUDNuKjSjVcuCwqUBhld0=">微信地址</a> | <a href="http://bbs.pediy.com/thread-219061.htm">阅读原文</a>
{% endraw  %}

