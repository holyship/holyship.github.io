---
title: Shellcode：x86优化（一）
author: lumou
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1498051979&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQyx1hdTxM6K*VNtcxOeUN354nW26WI5lTIy9FI3*gxCaEHwjjiMY16zPEkDRPZ*5EGbWeh0UoenTKIfD5Zep1ZOEUgVk7fEHbChrEjVrqLfgCJWsYCFTeusfAOxZNTshe7mibbxunArN49yNyfIZBG0=
date: '2017-06-13 00:00:00 +0000'

---

{% raw  %}
<section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;">引言<br></p></section></section><h3 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><span style="font-size: 15px;">本文要介绍的是几种用来精简 shellcode 的基本方法。在后面的文章中，我将介绍一些方法来混淆它们以躲过签名检测算法。</span></h3><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">本文中的一些例子也同样适用于 boot loader， PE protector/compress，代码演示或者其他一些需要精简代码的地方。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">文章中有些技巧是从其他地方借鉴来的，我在文末的致谢部分会给出部分人的名字。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我确实有想过要不要介绍 x86 架构，但是在其他地方已经有很多相关的信息了，所以我就假设你已经对它比较熟悉了。</span></p><section label="小黄人科技" style="margin: 5px 0px 0px; padding: 10px; border-width: 2.1px; border-style: dashed; border-color: rgb(182, 182, 182); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; font-size: 16px; line-height: 25px; color: rgb(51, 51, 51); background-color: rgb(244, 244, 244);"><span style="font-size: 15px;">本文讲包括一下四个部分：</span><ol class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">声明和初始化变量/寄存器</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">测试变量/寄存器的值</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">条件跳转/控制流</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">字符转换</span></p></li></ol></section><p class=""><br></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;">初始化寄存器<br></p></section></section><h2 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><span style="font-size: 15px;">每个 CPU 寄存器就像是一个变量。</span></h2><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">延伸模式（&nbsp;legacy mode&nbsp; ）的 x86 CPU 有 8 个通用寄存器（General Purpose Register，GPR），每个寄存器可以存储 32 位或者 4 字节的信息。当然，我们不会用栈指针寄存器（ESP）来做除了栈管理之外的事，所以我们只有 7 个通用寄存器可用。其中有 4 个寄存器可以写 8 和 16 位的字。</span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTiccpf3IEsayWciaHiayvtvQ1ibvFo1KgDAQ7WmQ6JIBq0wcfnpvgm3xM0A/0?wx_fmt=png" style="width: 633px !important; height: 471px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;">&nbsp;<span style="font-size: 15px;">一个很普遍的操作是设置一个变量（在这里是寄存器）为 0。下面就是常见的用来完成这个操作的几种方法。有些会比其他要好一些，这都取决于具体情况。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTAaEpiatS6BjjzrqNc1n1xee0jtYnAvDOnAXqFSdy0AfMoHekpCCtUmA/0?wx_fmt=png" style="width: 770px !important; height: 783.926px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">这里没有列出所有可以用来初始化某一特定寄存器的方法，但是用同样的方法，MOV, XOR, SUB, AND&nbsp;这些操作也能将其他变量设置为0。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">关于最后一条指令 XOR RAX, RAX 我要说的是，你不一定要在 RAX 上执行这个操作，你也可以通过执行&nbsp;XOR EAX, EAX 来节省一个字节，因为结果是扩展到 64 位的0。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">将一个寄存器的值移到另一个寄存器。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJT9NXicm9NR3SiardHiaBak7FO1UmCvL01ribakqZIP6iajuFyZqt3rCtIr5g/0?wx_fmt=png" style="width: 477px !important; height: 193px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">初始化为立即数也是一个比较常见的操作，但是在 shellcode 中初始化立即数会比较麻烦。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">比如说你需要把 1 放到 EAX/RAX 中，这在 linux 下表示退出系统调用。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTNhMuVUo6tm658OUz9YdFOe17VYENlwXI7L6vI8iad7bQsAZKicfgLHvQ/0?wx_fmt=png" style="width: 505px !important; height: 177px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">用 PUSH/POP 这个组合不只是一个原因。首先它比其他的更简洁，其次，它兼容 32 位和 64 位，其他的可能就不兼容了。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">一般来说，如果立即数是 -128 到 +127 之间的话，就用 PUSH/POP 组合。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">对上面的值，操作码比较长。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">假设你打算在一个 egg hunter shellcode 中读内存。这通常会涉及到把寄存器设置为4096，4096 代表一张页表的边界。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">比较常见的是下面的方法：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTicw6tmfjiaHuOTgfq1lQJL1ZeicGhAUuPOlyHes93bEvtaq2suZAm7AlQ/0?wx_fmt=png" style="width: 450px !important; height: 147px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">这里还有一些其他的方法，其中最后两个是最简洁的。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTOmQIUADUqaE6KKzdxkOQ24DdqG7iaicBCDzxq783ibZx14PFT1L1l0V2w/0?wx_fmt=png" style="width: 420px !important; height: 208px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当说到要将 1 或 -1 压入栈的时候，我常看到会使寄存器加1或减1的代码。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">从&nbsp;</span><span style="font-size: 15px;">block_shell.asm</span><span style="font-size: 15px;"> 提取中这部分代码。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTCKH7zsqfvYzqZc96s4AGuWN0THR7SQHalp9AoatyVKVS22Ojo7xqQw/0?wx_fmt=png" style="width: 654px !important; height: 44px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">将 1 压入栈</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJT1kbbvZJu18e3Duj8xIodIFNR4jdj3VZzVJhiayYwJby5iaLQltbUTBnA/0?wx_fmt=png" style="width: 440px !important; height: 59px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">超完美的有没有的？但是你也可以直接把 1 压入栈然后节省一个字节。</span></p><section label="Copyright Reserved by ipaiban.com." style="margin: 5px 0px 0px; border-width: medium medium medium 10px; border-style: none none none solid; border-color: currentcolor currentcolor currentcolor rgb(233, 233, 233); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; font-size: 16px; line-height: 25px; color: rgb(153, 153, 153); background-color: rgb(243, 243, 243); box-shadow: 1px 1px 2px rgb(153, 153, 153);"><span style="font-size: 14px;">"\x6a\x01"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;push&nbsp;0x1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在代码最后也有同样的操作。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTgxxHKm3La2XrlRerozvf7NFfqmqbEta8DRlkZ4rcQ4puy04rzwp64g/0?wx_fmt=png" style="width: 617px !important; height: 119px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTniaUhGdohPgE5F6deaNR4Pm3q6VTmgO1eYrxrxsv4I3B60FTaOIlFCw/0?wx_fmt=png" style="width: 509px !important; height: 59px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我们可以用下面的方法节省一个字节。</span></p><section label="Copyright Reserved by ipaiban.com." style="margin: 5px 0px 0px; border-width: medium medium medium 10px; border-style: none none none solid; border-color: currentcolor currentcolor currentcolor rgb(233, 233, 233); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; font-size: 16px; line-height: 25px; color: rgb(153, 153, 153); background-color: rgb(243, 243, 243); box-shadow: 1px 1px 2px rgb(153, 153, 153);"><span style="font-size: 14px;">"\x6a\xff"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;push&nbsp;0xffffffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span></section><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">好了，我不是要告诉你优化 metasploit&nbsp;的所有方法……只是想用现实中的例子来说明一下。在现实中像这样的立即数，如果你只需要1，你应该把它压入栈。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在 64 位的版本中，用下面的方法：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTBBR8iaew8h7ic5VhTatTJJZvJGS88lO6ohQK080VUSwgFzyv0JqoSP8g/0?wx_fmt=png" style="width: 640px !important; height: 44px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">为了压入立即数，将生成的字节数和2比较。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTZf7wwLgQfeIOQg2fHzh3U0ygJvYlXo0tut2gTXLtT0LK2AQ4vXfd3A/0?wx_fmt=png" style="width: 475px !important; height: 62px !important;"></p><h2 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br><strong><span style="font-size: 15px;"></span></strong></h2><h2 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 16px;"><strong>分配/初始化内存</strong></span></h2><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">编译器会用 ADD, SUB 或者在过去用 ENTER(Pascal/Ada) &nbsp;来分配栈内存。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">比较简单的方法是用来分配 PUSH/PUSHFD&nbsp; 大于等于4 byte 的内存。不过PUSHAD&nbsp;可以只用一个字节就能分配到 32-byte 的内存。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在使用 PUSHAD 的时候，如果后面你不想用 POPAD 来回收垃圾，你也可以用 ADD, SUB 或者 LEA 来做这件事。下面是一些分配 32byte 空间的例子。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTLl8pYzTOAHL63j4CqYMsawkkSd5Yd2KGXvr13hiauLgTyahwibbdNZow/0?wx_fmt=png" style="width: 444px !important; height: 195px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">下面是分配 8byte 并初始化为 0.</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTLDGMHP8hlMGqWQrvicZ9FdjibqMb1IklTKcc9PGROyjDCdRzpkgKAU3A/0?wx_fmt=png" style="width: 505px !important; height: 494px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">下面是我用来分配 4096byte 缓冲区的方法。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTbx9vSVAibXoysHMymdwpYQnLONWu74RXOhBWviaf2dMexUicx9DplQxAg/0?wx_fmt=png" style="width: 400px !important; height: 123px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">由于不同平台的栈限制（stack limit），上面的代码在 Windows 下可能会引发异常（在基于UNIX的系统下不确定）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在 Windows 下默认的栈大小（stack size）最大值是1MB，在 Linux 下它至少是4MB。Windows 预先分配给栈页的是64KB、Linux 的是128KB。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当你想要分配超过最大值的栈内存的时候，你要确保该页是可用的。编译器如&nbsp;MSVC&nbsp;和 MINGW&nbsp;会自动完成这个操作，你无需担心，但是在组装程序的时候你要自己执行栈查探（stack probe）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">比如说，下面的代码要在一个 4096-byte 的内存块上申请近 20KB 的栈空间。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTLHLslwt4oY0AMj3T0ibtAeS44mA9XM8aZagpDLj7D4xgpficHeaNoySQ/0?wx_fmt=png" style="width: 453px !important; height: 140px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">“test [esp], esp ”这条指令会引发 kernel 层异常强制扩大栈内存。如果那部分内存不可用，程序就会抛出异常。</span></p><section label="Copyright Reserved by ipaiban.com." style="text-align: left; margin: 5px 0px 0px; border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; padding: 10px; border-style: none;"><section style="display: inline-block; padding: 0.5em; border-radius: 3px; color: white; font-size: 1em; box-shadow: 0.1em 0.1em 0.2em rgb(165, 165, 165); background-color: rgb(0, 0, 0);"><p class="" style="color: rgb(255, 255, 255); line-height: 22px; font-size: 18px;">测试寄存器<br></p></section></section><h2 style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"> </span><span style="font-size: 15px;">很多函数都喜欢用返回 1 表示成功（TRUE），0 表示失败（FALSE）。有些也会用-1 或者小于 0 表示失败。</span></h2><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">检查这些值最好的方法就是对这些寄存器做一些能够反映状态标志的操作。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTUtQ8BTNnSL1Hkuy3HnvX7gRcicPibGCaGJ9a2lHkwaIKhHsuGWOt3XcA/0?wx_fmt=png" style="width: 272px !important; height: 342px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在这里你比较常用的几个是零标志（ZF）、符号标志（SF）、奇偶标志（PF）、进位标志（CF）。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当然你也可以用溢出标志（OF），但是在本部分的例子中我不会用到它。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">辅助标志（AF）也可以用，但是很遗憾，没有哪个跳转操作码可以与它关联。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果要测试这些标志位的值你要用 PUSHFD/POP 组合将其压入栈，或者用一字节指令 LAHF 。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">测试 0 或 FALSE. <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTwE0jPQ7RfrCtntib81c9HzbaPBnR1sHVOJclGCml57kLVUgrRul50mQ/0?wx_fmt=png" style="width: 352px !important; height: 225px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"> 测试 1 或 TRUE. <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJToib5ElPDNjHDX2DQ3k0pkqMM03ph5icib5yyJbZs12WUzlKUdpMKXeicbg/0?wx_fmt=png" style="width: 353px !important; height: 324px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">测试 -1&nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我看到的用来直接测试-1的代码最常用的就是第一个例子中的那样，但是像第二个例子那样用符号标志（SF）的会更高效和简洁。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果是在延伸模式（legacy mode）下运算，我们可以通过inc该寄存器然后测试零标志（ZF）来节省一个字节。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">因为加1后ZF=1,PF=1,SF=0,你就可以选择用JP或者JNS而不是像第三个例子那样用JZ。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果像最后一个例子用dec ，那么 SF=1,ZF=0,PF=0，我们就可以用JS,JNP,JNZ或JL.</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTcEibkhY55vRIcDVjOiaqCEUJT7avfCLYCIXaEmKWj1TmjO3xiazQ1dibWQ/0?wx_fmt=png" style="width: 396px !important; height: 157px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">关于后面那两个例子，有一个问题是，在64位模式下没有一字节的 INC/DEC 指令，因为这些是为 REX prefix 预留的。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在这种情况下，最后用 TEST 或者 inc 一个 8 位寄存器（如果可以的话）比如EAX/RAX 的 AL。你也可以只检查 AL 或 -1，这样更简单些。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">JLE 可以用在调用 BSD socket 的类似 recv 或 send 函数之后，因为如果出错它会返回0或-1.</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTInQ60M5tkjfUvBsH1lfiaFZIvHZZOHfObVnvEAMtBWdACA0mJZibib8tg/0?wx_fmt=png" style="width: 392px !important; height: 58px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">测试 0x80, 0x8000, 0x80000000 <br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">执行加倍/乘以 2 之后可能会溢出。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">执行 TEST 指令后各标志位为：PF=1, SF=1, ZF=0 。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">假如要测试的值是 0x80000000</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTRThf5MBB3WdgEDcaqpFEia52WOqywKu6CNE6ticzJDn29cgVZQwLhCvA/0?wx_fmt=png" style="width: 399px !important; height: 60px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我们也可以用 INC EAX 来设置&nbsp;SF=1, PF=0, OF=0&nbsp;，然后我们就可以用&nbsp;JS, JNP, JNO 或 JL 了。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTVxR9b1tEWVsJpK6nt4VZXSV0waUqBYCG0BuLkSzibllk0BcbYy29G3Q/0?wx_fmt=png" style="width: 384px !important; height: 60px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">那么，如果用 DEC EAX 来代替会怎样呢？这将使&nbsp;SF=0, PF=1, OF=1&nbsp;，那我们可以用&nbsp;JNS, JP, JO, 或JG 。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJT9iarU5bZkAweMytY5NjCnSiaeTNHU4zDGibzNpoQlpa39TxOft1oP6rww/0?wx_fmt=png" style="width: 395px !important; height: 60px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">加&nbsp;0x80000000 后结果是0，将使ZF=1, OF=1, CF=1.&nbsp; 用JZ, JO 或者JC/JB。如果是减法，将使 ZF=1, OF=0, CF=0.&nbsp; 用&nbsp;JZ, JNO 或 JNC/JNB. &nbsp;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTwuIvwWdMfSXytuibQtOsYzspcRHiahicsEoNJfLx3FXuQhic0EPU65Ahmg/0?wx_fmt=png" style="width: 389px !important; height: 60px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">除了用 add，sub，还可以左移 1 位。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJT9DWxCJXDYnf12OwwMGFZfibewVX0MC4NqEctkwmU6AxSUnGdj8laAjA/0?wx_fmt=png" style="width: 388px !important; height: 60px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">用 edx</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJT2kymZ3vovcU9ArXsScHqJapcVZU97priaxpI00ibdodxCWBe3zHsT2lQ/0?wx_fmt=png" style="width: 386px !important; height: 77px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">用算术右移（Shift Arithmetic Right ，SAR）</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8HxIStQPFl5lkZ5DYtwCaJTWuVnjicJ2BdFzspZfaQsAebJXSNlm8vLQnXcykSHJiaH9oymTypHM2xg/0?wx_fmt=png" style="width: 370px !important; height: 72px !important;"></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 14px; color: rgb(136, 136, 136);">本文由 看雪翻译小组 lumou 编译，来源 modexp</span><span style="font-size: 15px; color: rgb(136, 136, 136);"><br></span></p><p style="line-height: normal; margin-top: 15px; margin-bottom: 15px; text-align: center;"><br><span style="font-size: 14px; color: rgb(136, 136, 136);"></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em; text-align: center;"><span style="font-size: 15px; color: rgb(255, 104, 39);">如果你喜欢的话，不要忘记点个赞哦！</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em; text-align: center;"><span style="font-size: 15px; color: rgb(255, 104, 39);">明日续更！</span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">热门阅读文章：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283127&amp;idx=1&amp;sn=a456b8495b438499ab68d1a2c32e543c&amp;chksm=b1815cfd86f6d5eb01205cf7c3052d428b2e9105d34523a276bdfb774c7adbbcbd197210f286&amp;scene=21#wechat_redirect" target="_blank">看雪 CTF 2017 攻击篇 6月强势来袭！</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283372&amp;idx=2&amp;sn=667897f27a1a4327164e179f7efd70ac&amp;chksm=b1815de686f6d4f0e42672beece10320af227b03091fc2b746d2bcee7b749502a33153b21aed&amp;scene=21#wechat_redirect" target="_blank">SQL注入新手教程（第一部分）2</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283363&amp;idx=1&amp;sn=ab837d12482aa4092204664301720b31&amp;chksm=b1815de986f6d4fff83647e7ff6d85bc3c31ff58384fbdf5c43ec2b9ab35ba1dc657a8076119&amp;scene=21#wechat_redirect" target="_blank">SQL注入新手教程（第一部分）1</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283357&amp;idx=3&amp;sn=28d3ad1dca38b1010b60c0413a0b3c24&amp;chksm=b1815dd786f6d4c1782465c6788e2e08a7578d1561c909899b500cda50a8396a61c36632d4a3&amp;scene=21#wechat_redirect" target="_blank">frame busting 各种姿势，防护总结（二）</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283322&amp;idx=1&amp;sn=ac35a5a101382ed74fe8d4ef90662fa5&amp;chksm=b1815db086f6d4a65c92af5167d9a5a5e8dd565f5579d706f206fd6a6f7ac3c8c9ebbf544f82&amp;scene=21#wechat_redirect" target="_blank">frame busting 各种姿势，防护总结（一）</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8E4ItLe4LX3YbLUffeV86icpcBApdQiakmEMuy4q8mVAaBjA0P1wez6NzO52zvKNlQQQ4siaztZDYhBg/640?wx_fmt=jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1498051979&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQyx1hdTxM6K*VNtcxOeUN354nW26WI5lTIy9FI3*gxCaEHwjjiMY16zPEkDRPZ*5EGbWeh0UoenTKIfD5Zep1ZOEUgVk7fEHbChrEjVrqLfgCJWsYCFTeusfAOxZNTshe7mibbxunArN49yNyfIZBG0=">微信地址</a> | <a href="http://bbs.pediy.com/thread-218410.htm">阅读原文</a>
{% endraw  %}

