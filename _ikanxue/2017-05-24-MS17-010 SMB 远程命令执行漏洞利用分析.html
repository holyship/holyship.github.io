---
title: MS17-010 SMB 远程命令执行漏洞利用分析
author: lcz
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496016642&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgG9Oe2Y4Txgw7FIHUz2sSP2AphHbOB7c*JU7liblQGWtMVZen7MuttjQKfDcEubrQBcDRvCLSY1RrO2z5UwO7TzPZiv2osinmCWlL46Yc027j4WYE7FiH0sItndz4ckdCkyssFuEN353NEePwpE-Z2o=
date: '2017-05-24 00:00:00 +0000'

---

{% raw  %}
<p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">第一次尝试分析漏洞，水平有限有不对的地方请大家指正，轻拍啊。呵呵。MS17-010漏洞出现在的原因是SrvOs2FeaListSizeToNt在计算需要分配的内存长度时存在问题，以至于可以溢出到邻近的内存块。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;int __stdcall SrvOs2FeaListSizeToNt(_DWORD *</span><a style="text-decoration: underline; font-size: 14px;"><span style="font-size: 14px;">a1</span></a><span style="font-size: 14px;">)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; _WORD *v1; // eax@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; unsigned int v2; // edi@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; unsigned int v3; // esi@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; int v4; // ebx@3</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; int v6; // [sp+Ch] [bp-4h]@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v1 = a1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v6 = 0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v2 = (unsigned int)a1 + *a1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v3 = (unsigned int)(a1 + 1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; if ( (unsigned int)(a1 + 1) &lt; v2 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; while ( v3 + 4 &lt; v2 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v4 = *(_WORD *)(v3 + 2) + *(_BYTE *)(v3 + 1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( v4 + v3 + 4 + 1 &gt; v2 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( RtlSizeTAdd(v6, (v4 + 12) &amp; 0xFFFFFFFC, &amp;v6) &lt; 0 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v3 += v4 + 5;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( v3 &gt;= v2 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return v6;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v1 = a1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; </span><a style="text-decoration: underline; font-size: 14px;"><span style="font-size: 14px;">&nbsp;*v1 = v3 - (_WORD)v1;</span></a></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; return v6;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">按上面的逻辑如果v3这个缓存区中全是0，那么每次循环v3向前移动5个字节，v6就会加0xC（也就是12字节）。问题就出现在*v1 = v3 - (_WORD)v1;上a1的长度是一个四字节，但这里却是个双字节。那么如果长度为三字节以上，且执行到这里时就有可能把的长度改大。Eternalblue就设长度是0x10000，最后最后一个分片长度是0xA8,这时v3已经是偏移了FF5D了。加上0xa8就超0x10000了，所以就会走到了这一句，执行后长度变成了0x1FF5D比原来大了不少。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">signed int __stdcall SrvOs2FeaListToNt(char *a1, _DWORD *a2, int *a3, _WORD *a4)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; char *v4; // edi@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; int v5; // eax@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; _DWORD *v7; // eax@3</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; char *v8; // ebx@9</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; char *v9; // esi@9</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; signed int v10; // esi@14</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; __int16 v11; // [sp+8h] [bp-4h]@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; _DWORD *v12; // [sp+14h] [bp+8h]@11</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v11 = 0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v4 = a1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v5 = SrvOs2FeaListSizeToNt(a1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; *a3 = v5;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; if ( !v5 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; *a4 = 0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; return -1063718657;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v7 = (_DWORD *)SrvAllocateNonPagedPool(v5, 21);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; *a2 = v7;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; if ( v7 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; v8 = &amp;a1[*(_DWORD *)a1 - 5];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; v9 = a1 + 4;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; if ( a1 + 4 &gt; v8 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">LABEL_13:</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( v9 == &amp;v4[*(_DWORD *)v4] )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *v7 = 0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *a4 = v11 - (_WORD)v4;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v10 = -1073741823;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; else</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; while ( !(*v9 &amp; 0x7F) )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v12 = v7;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v11 = (signed __int16)v9;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v7 = (_DWORD *)SrvOs2FeaToNt((int)v7, (int)v9);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v9 += (unsigned __int8)v9[1] + *((_WORD *)v9 + 1) + 5;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( v9 &gt; v8 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v7 = v12;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto LABEL_13;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *a4 = (_WORD)v9 - (_WORD)v4;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; v10 = -1073741811;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; SrvFreeNonPagedPool(*a2);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; return v10;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;
 if ( *((_BYTE *)WPP_GLOBAL_Control + 29) &gt;= 2u &amp;&amp; *((_BYTE 
*)WPP_GLOBAL_Control + 32) &amp; 1 &amp;&amp; KeGetCurrentIrql() &lt; 2u
 )</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; {</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; DbgPrint("SrvOs2FeaListToNt: Unable to allocate %d bytes from nonpaged pool.", *a3, 0);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp; DbgPrint("\n");</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; }</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; return -1073741307;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">上面的循环中：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 15px;">v9 += (unsigned __int8)v9[1] + *((_WORD *)v9 + 1) + 5;</span></p><p style="line-height: normal;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( v9 &gt; v8 )</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">这里虽有判断，但长度v8已经被上面SrvOs2FeaListSizeToNt(a1);改的很大了，当v7已经到末尾时v9还是小于v8，再执行SrvOs2FeaToNt就分溢出了。溢出后从while ( !(*v9 &amp; 0x7F) )这句退出从而不影响其它内存。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">unsigned int __stdcall SrvOs2FeaToNt(int a1, int a2)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; int v2; // esi@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; _BYTE *v3; // ebx@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; unsigned int result; // eax@1</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v2 = a1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; *(_BYTE *)(a1 + 4) = *(_BYTE *)a2;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; *(_BYTE *)(a1 + 5) = *(_BYTE *)(a2 + 1);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; *(_WORD *)(a1 + 6) = *(_WORD *)(a2 + 2);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; _memmove((void *)(a1 + 8), (const void *)(a2 + 4), *(_BYTE *)(a2 + 1));</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; v3 = (_BYTE *)(*(_BYTE *)(a1 + 5) + a1 + 8);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; *v3++ = 0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; _memmove(v3, (const void *)(*(_BYTE *)(v2 + 5) + a2 + 5), *(_WORD *)(v2 + 6));</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; result = (unsigned int)&amp;v3[*(_WORD *)(a1 + 6) + 3] &amp; 0xFFFFFFFC;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; *(_DWORD *)v2 = ((unsigned int)&amp;v3[*(_WORD *)(v2 + 6) + 3] &amp; 0xFFFFFFFC) - v2;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp; return result;</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 14px;">} </span><span style="font-size: 15px;"><br></span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Eternalblue第一步先建立一系列链接并发送长度为fff7的SMB包，但每个连接第一次只发前0x80字节，然后等带完成第二步再发。为研究这个漏洞是怎么利用的，用下面的方法设置了一个断点，发现每次在srvnet!SrvNetWskReceiveEvent调用afd!WskProAPIReceive时分配的MDL的地址都间隔了0x11000字节。</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: normal;"><span style="font-size: 14px;">bp
 afd!WskProAPIReceive&nbsp; ".echo ##############;dd esp l8; .echo 
*************;dd poi(esp+8) l20;.echo *************;dt poi(poi(esp+8)) 
_MDL;&nbsp; gc;"</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">而srvnet在接收这些包时，分配置了接收环境块及接收的内存等相关内容。其中接收环境块偏移0x18开的地方存了就存了调用afd!WskProAPIReceive时的WSK_BUF。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">typedef&nbsp;struct&nbsp;_WSK_BUF&nbsp;{<br> &nbsp;&nbsp;PMDL&nbsp;&nbsp;Mdl;<br> &nbsp;&nbsp;ULONG&nbsp;&nbsp;Offset;<br> &nbsp;&nbsp;SIZE_T&nbsp;&nbsp;Length;<br> }&nbsp;WSK_BUF,&nbsp;*PWSK_BUF;</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">而WSK_BUF中的Mdl指向的正是环境块偏移0x2c的地址。如下面86811010是接收环境块的开始86811028是调用afd!WskProAPIReceive时的WSK_BUF，8681103c就是接收数据所用内存的MDL描述。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">3: kd&gt; dd 86811000 l100</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811000&nbsp; 00011000 00000000 0044006d 00740061</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811010&nbsp; 005c0008 0069004d 00720063 86811160</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811020&nbsp; 00010ea0 00000000 8681103c 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811030&nbsp; 0000fff7 8825f568 868110a4 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811040&nbsp; 10040060 00000000 86811160 86811000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811050&nbsp; 00010ea0 00000160 0007f811 0007f812</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811060&nbsp; 0007f813 0007f814 0007f815 0007f816</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811070&nbsp; 0007f817 0007f818 0007f819 0007f81a</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811080&nbsp; 0007f81b 0007f81c 0007f81d 0007f81e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811090&nbsp; 0007f81f 0007f820 0007f821 00650078</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110a0&nbsp; 005c0072 00000000 00000064 0065006c</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110b0&nbsp; 005c0073 00000000 00010ea0 00000fff</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110c0&nbsp; 00340030 0063002e 00000069 00690064</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110d0&nbsp; c0100002 04240116 0880e96f 00000001</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110e0&nbsp; 977dd5f0 0044005c 00760065 00630069</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110f0&nbsp; 005c0065 00610048 00640072 00690064</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811100&nbsp; 006b0073 006f0056 0075006c 0065006d</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811110&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811120&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811130&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811140&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811150&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">因为前面的步骤发送了一系列的包，让srvnet驱动分配了一系列的内存块。内存块的分配规律就如同前面说描述的那样。这时Eternalblue再发送一个超大的SMB包, srvnet驱动接收后会走到 SrvOs2FeaListToNt 函数处理。就像一开始分析的那样这个函数里触发那个字段操作错误，把相邻的内存块覆盖掉。而被覆盖的这块内存恰恰正好是srvnet驱动之前接收SMB包的接收环境块，并且MDL早已经投递给网路驱动接收数据了。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">3: kd&gt; dd 86811000 l100</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811000&nbsp; 00000000 00000000 0000ffff 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811010&nbsp; 0000ffff 00000000 00000000 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811020&nbsp; 00000000 00000000 ffdff100 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811030&nbsp; 00000000 ffdff020 ffdff100 ffffffff</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811040&nbsp; 10040060 00000000 ffdfef80 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811050&nbsp; ffd00010 ffffffff ffd00118 ffffffff</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811060&nbsp; 00000000 00000000 00000000 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811070&nbsp; 10040060 00000000 00000000 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811080&nbsp; ffcfff90 ffffffff 00000000 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811090&nbsp; 00001080 00000000 00000000 00000000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110a0&nbsp; 005c0054 00000000 00000064 0065006c</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110b0&nbsp; 005c0073 00000000 00010ea0 00000fff</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110c0&nbsp; 00340030 0063002e 00000069 00690064</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110d0&nbsp; c0100002 04240116 0880e96f 00000001</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110e0&nbsp; 977dd5f0 0044005c 00760065 00630069</span></p><p style="line-height: normal;"><span style="font-size: 14px;">868110f0&nbsp; 005c0065 00610048 00640072 00690064</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811100&nbsp; 006b0073 006f0056 0075006c 0065006d</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811110&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811120&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811130&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811140&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p><p style="line-height: normal;"><span style="font-size: 14px;">86811150&nbsp; 4e4e4e4e 4e4e4e4e 4e4e4e4e 4e4e4e4e</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">再看MDL描述的内存地址变成了什么。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">0: kd&gt; dt 8681103C _MDL</span></p><p style="line-height: normal;"><span style="font-size: 14px;">ntdll!_MDL</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x000 Next&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 0xffffffff _MDL</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x004 Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 0n96</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x006 MdlFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 0n4100</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x008 Process&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : (null) </span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x00c MappedSystemVa&nbsp;&nbsp; : 0xffdfef80 Void</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x010 StartVa&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : (null) </span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x014 ByteCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 0xffd00010</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp; +0x018 ByteOffset&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 0xffffffff</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">MDL描述的内存地址变成了0xffdfef80因为链接之前已经接收了先发送的0x80个字节,等待接收下面的数据呢，要再接收的话会把数据COPY到0xffdfef80+0x80的地方，即0xffdff000位置。而这个位置是可写可执行的。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">2: kd&gt; !pte 0xffdff000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VA ffdff000</span></p><p style="line-height: normal;"><span style="font-size: 14px;">PDE at C0603FF0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; PTE at C07FEFF8</span></p><p style="line-height: normal;"><span style="font-size: 14px;">contains 000000000018A063&nbsp; contains 00000000001E2163</span></p><p style="line-height: normal;"><span style="font-size: 14px;">pfn 18a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---DA--KWEV&nbsp; pfn 1e2&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-G-DA--KWEV</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">下面只要发送SHELLCODE就会被写到这个位置。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当接收完成后会调用srvnet!SrvNetWskReceiveComplete即接收IRP的完成函数，同时会把接收环境块传给它。而接收环境块在偏移0x24的位置存储着一个地址，它指向了一块内存，这块内存偏移0x16c存了一个地址，这个地址是一个函数指针数组，里面分别存的是SrvConnectHandler，SrvReceiveHandler，SrvDisconnectHandler，SrvCredentialHandler。很明显在覆盖后接受环境块，偏移0x24的位置变成了ffdff020，指向了存放SHELLCODE的内存区，完全可被攻击者控制。从而能很轻松就转到攻击代码部份执行。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em; text-align: center;"><span style="font-size: 15px; color: rgb(136, 136, 136);">本文由看雪论坛 <span class=""><span class="">lcz</span> </span>原创</span><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">你可能对以下内容感兴趣：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">等你来挑战！| 看雪 CTF 2017 攻击篇</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">【终于等到你！】看雪 CTF 2017</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=1&amp;sn=7ed476d577172ff4b4a93807dae2667c&amp;chksm=b1815a4586f6d35373f6c5d783fa99a7bb7cf2fc35da914761a9cf2d9943a09c1aefb9febfbf&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">春风十里，我在等你</span></a></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283017&amp;idx=3&amp;sn=745024d678707b6dcf0cdc94ff5472a5&amp;chksm=b1815c8386f6d59538bfeeb8d3837007f07b0b4d3cd77b439f7856edd391127b6b2f36fb105d&amp;scene=21#wechat_redirect" target="_blank">Ring3 注入总结及编程实现【有码】</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283005&amp;idx=2&amp;sn=2fc411b70549c789085e517ef6dfc3e9&amp;chksm=b1815b7786f6d261975cd000d4ddf2c4cffe3cf2d8ab06d870e7971e862c29c7278996bdfb6c&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">【系列】堆溢出研究（三）</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283003&amp;idx=1&amp;sn=bcfd852aea24f274bf8fda85f9300a85&amp;chksm=b1815b7186f6d26758f7f0f1cb0c7ec9da888ab0d80a7b2e2850453bfc03f05640443839d7bf&amp;scene=21#wechat_redirect" target="_blank">【原创】WannaCry勒索软件中“永恒之蓝”漏洞利用分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><img src="/ikanxue/images/a0942aca19665d63c4ee222be971a37cd63dc1e4.jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496016642&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgG9Oe2Y4Txgw7FIHUz2sSP2AphHbOB7c*JU7liblQGWtMVZen7MuttjQKfDcEubrQBcDRvCLSY1RrO2z5UwO7TzPZiv2osinmCWlL46Yc027j4WYE7FiH0sItndz4ckdCkyssFuEN353NEePwpE-Z2o=">微信地址</a> | <a href="http://bbs.pediy.com/thread-217745.htm">阅读原文</a>
{% endraw  %}

