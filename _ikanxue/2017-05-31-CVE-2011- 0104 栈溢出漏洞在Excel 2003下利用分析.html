---
title: CVE-2011- 0104 栈溢出漏洞在Excel 2003下利用分析
author: dolphindiv
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496307545&src=3&ver=1&signature=93SzgWWUmeel8Ref4eZJuIODr9gzme7fJtytKfz*8Te*huPLcrDR7zVn0cJjpY*sniFCQ4qoj4lMopJTTObiD48vKnADyzOtjsg8Pw9qLWHdwOQXq-Cjlm*bt*1MdKlkO1ccII4Y8q2YZvXcIfLrVTkwu*IUkP4k51TANv93PIA=
date: '2017-05-31 00:00:00 +0000'

---

{% raw  %}
<p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">最近在研究 CVE-2011-0104 栈溢出漏洞，学习了《漏洞战争》中关于该漏洞的分析，书中介绍了 Excel 2003 下利用已公布的 PoC 代码触发异常、下断点定位导致溢出的复制操作位置以及基于污点追踪的漏洞分析方法，但是对如何在 Excel 2003 下如何利用该漏洞没有做更加深入的分析，同时 abysssec 组织提供的漏洞样本也是基于Excel 2007 (xp) SP2的。笔者在学习该篇文章的基础上，动手进行了调试，通过定位字符串复制操作、分析函数调用栈、修改样本数据、修复异常，成功完成了 Excel2003 下该漏洞的利用，弹出了计算器。现将该调试分析过程发布出来，供学习交流。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"><br></span></p><section label="Copyright © 2016 playhudong All Rights Reserved." style="border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-style: none; width: 3em; margin: 2em auto;"><section class="" style="width: 10px; height: 10px; opacity: 0.5; background-color: rgb(78, 130, 247); margin-left: 2.05em;"></section><section class="" style="width: 1.7em; height: 1.7em; border-width: 1px; border-style: solid; border-color: white; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; background-color: rgb(78, 130, 247); color: white; text-align: center; margin: 0px auto; transform: rotate(360deg);"><p>01</p></section><section class="" style="width: 15px; height: 15px; background-color: rgb(78, 130, 247); margin-top: -7px; margin-left: 2px;"><br></section></section><p style="text-align: center;">分析环境</p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;"><br></span></p><table width="626" cellspacing="0" cellpadding="0"><tbody><tr><td style="padding: 0px 7px;" width="125" valign="top"><br></td><td style="padding: 0px 7px;" width="217" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">推荐使用环境</span></p></td><td style="padding: 0px 7px;" width="285" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">备注</span></p></td></tr><tr><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="125" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">操作系统</span></p></td><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="217" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">Windows xp</span></p></td><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="285" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">简体中文版</span></p></td></tr><tr><td style="padding: 0px 7px;" width="125" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">虚拟机</span></p></td><td style="padding: 0px 7px;" width="217" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">VMware Workstation</span></p></td><td style="padding: 0px 7px;" width="285" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">版本号：12.1.1 build</span></p></td></tr><tr><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="125" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">调试器</span></p></td><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="217" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">Immunity Debugger</span></p></td><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="285" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">版本号：V1.73</span></p></td></tr><tr><td style="padding: 0px 7px;" width="125" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">调试器</span></p></td><td style="padding: 0px 7px;" width="217" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">WinDbg</span></p></td><td style="padding: 0px 7px;" width="285" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">版本号：6.12.0002.633</span></p></td></tr><tr><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="125" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">漏洞软件</span></p></td><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="217" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">Microsoft Office Excel</span></p></td><td style="background: rgb(242, 242, 242) none repeat scroll 0% 0%; padding: 0px 7px;" width="285" valign="top"><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">版本号：2003 11.5612.6568</span></p></td></tr></tbody></table><p><br></p><section label="Copyright © 2016 playhudong All Rights Reserved." style="border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-style: none; width: 3em; margin: 2em auto;"><section class="" style="width: 10px; height: 10px; opacity: 0.5; background-color: rgb(78, 130, 247); margin-left: 2.05em;"></section><section class="" style="width: 1.7em; height: 1.7em; border-width: 1px; border-style: solid; border-color: white; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; background-color: rgb(78, 130, 247); color: white; text-align: center; margin: 0px auto; transform: rotate(360deg);"><p>02</p></section><section class="" style="width: 15px; height: 15px; background-color: rgb(78, 130, 247); margin-top: -7px; margin-left: 2px;"><br></section></section><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 16px;">分析调试过程</span></p><p><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">运行excel.exe，然后用WinDbg附加excel2003进程，在命令输入框中按g，使excel2003运行出现打开后的界面，打开exploit.xlb样本文件，打开后触发异常：</span></p><table cellspacing="0" cellpadding="0"><tbody><tr><td style="border-top-color: rgb(127, 127, 127); border-top-width: 1px; border-bottom-color: rgb(127, 127, 127); border-bottom-width: 1px; padding: 0px 7px;" width="553" valign="top"><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">(e48.e4c): Access violation - code c0000005 &nbsp; (first chance)</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">First chance &nbsp; exceptions are reported before any exception handling.</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">This exception &nbsp; may be expected and handled.</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">eax=51453844 &nbsp; ebx=00000002 ecx=00000006 edx=3161feb0 esi=00000000 edi=00000400</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">eip=300ce361 &nbsp; esp=0013aa24 ebp=0013aa8c &nbsp; iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nv up ei pl nz na pe nc</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">cs=001b&nbsp; ss=0023&nbsp; &nbsp; ds=0023&nbsp; es=0023&nbsp; fs=003b&nbsp; &nbsp; gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; efl=00010206</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">***
 ERROR: &nbsp; Symbol file could not be found.&nbsp; &nbsp; Defaulted to export symbols
 for C:\Program Files\Microsoft &nbsp; Office\OFFICE11\EXCEL.EXE -</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">EXCEL!Ordinal41+0xce361:</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">300ce361 &nbsp; 8908&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mov&nbsp;&nbsp;&nbsp;&nbsp; dword ptr [eax],ecx&nbsp; ds:0023:51453844=????????</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">0:000&gt; kb</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">ChildEBP RetAddr&nbsp; Args to Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">WARNING: Stack &nbsp; unwind information not available. Following frames may be wrong.</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">0013aa8c 30424232 42414242 41385058 494a7542 &nbsp; EXCEL!Ordinal41+0xce361</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">0013aa90 &nbsp; 42414242 41385058 494a7542 &nbsp; 584b4c4b &nbsp; EXCEL!Ordinal41+0x424232</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">0013aa94 &nbsp; 41385058 494a7542 &nbsp; 584b4c4b &nbsp; 30435451 0x42414242</span></p><p style="line-height: 1.5em; margin-bottom: 5px; margin-top: 5px;"><span style="font-size: 14px;">0013aa98 494a7542 584b4c4b 30435451 50453043 0x41385058</span></p></td></tr></tbody></table><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">运行excel.exe，然后用Immunity Debugger附加excel2003进程，按F9，使excel2003运行出现打开后的界面，打开exploit.xlb样本文件，打开后触发异常：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/f30bf0a1ecda27c8ae9a28b964ec716eaf7bce1d.png" style="width: 407px !important; height: 252px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">通过向上进行代码回溯分析，崩溃地址位于函数sub_300CE252：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/a16ec4b85a6697005a56451289ebe82b5323967f.png" style="width: 347px !important; height: 221px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">然后，在0x300CE252下断点，并对栈顶下内存写入断点（此处的栈顶就是调用sub_300CE252函数时将返回地址压栈时的ESP值，即0x0013AA90）：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"></span><img src="/ikanxue/images/0825e9cc4c9ac35d32737b70f8b1799db1141958.png" style="line-height: 1.7; width: 554px !important; height: 339px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">按F9执行到0x300CE3C8，此处进行循环复制数据到栈上，导致溢出：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/75f5414192ccef043f36a69efc41a75dd511b45d.png" style="width: 499px !important; height: 239px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">此时中断，查看寄存器值发现EBP=0013AA3B，EDI=0013AA9B，复制了0x60个字节：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/1fa9fb5b28e00ea96ddcf587dccd64f112baee3e.png" style="width: 554px !important; height: 342px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">根据《漏洞战争》P53和P54的分析，REP MOVS 操作的目的地址由ebp提供，由此得知，当复制0x60个字节时edi的值由于递增覆盖到了栈顶（0x0013AA90，此处在漏洞利用中应为“跳板地址”）。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">单步执行到该段程序的末尾处Retn 0c处时，此时栈如图：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/e5c43ced61d4b090c81885b3d947b21a24bccec7.png" style="width: 478px !important; height: 169px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">此时ESP值为0x001379EC。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">通过向上回溯代码，发现该段函数开始于0x300CE380，因此定义该函数为sub_300CE380:</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/63f74900746f3c56764f3e2db8c7e40cab7099c9.png" style="width: 447px !important; height: 239px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">从Call Stack中可以看出，函数sub_300CE380被函数sub_306DF0DC调用：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/ce2e7cc52a79df740baafc1c8dfe8acf98ae4c33.png" style="width: 554px !important; height: 103px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">为了找出异常发生地址所在函数sub_300CE252与sub_300CE380之间的调用关系，我们再次回到sub_300CE252函数开头，F8单步执行，同时注意观察栈中0x0013AA90的数据变化情况。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">执行CALL&nbsp; EXCEL.306DEEFE之前：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/555f0a87b45ac3382fc44ff415a5efef41310ff7.png" style="width: 481px !important; height: 111px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">此时栈中0013AA90中的内容仍为正常的返回地址：&nbsp;&nbsp;</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/a4db82733ff577b801aef27957e8ae5353323b22.png" style="width: 548px !important; height: 105px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">当执行完0x302188D8处CALL&nbsp; EXCEL.306DEEFE后，0x0013AA90处内容被覆写：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/2b7fe721db4942be86cee492e06cdc22de866aa7.png" style="width: 308px !important; height: 75px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">观察此时函数Call Stack：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/fe37184026900245f0bfadcf486da00621812ec1.png" style="width: 554px !important; height: 114px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">可以看出，函数sub_306DEEFE由函数sub_302188D8调用。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">重复以上步骤，从sub_300CE252开始，执行到0x300CE30C处执行JE EXCEL.302188B5，跳转到0x302188B5处，单步执行到0x302188D8处调用CALL EXCEL.306DEEFE，结合前面对sub_300CE380 Call Stack的分析，单步执行并在0x306DF0DC处下断点，执行CALL EXCEL.300CE380，继续单步执行，执行完0x300CE3C8处的REP MOVS后，sub_300CE252的返回地址被覆写。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/cdc37aaabc90f38ddd8150bb8480daf288318248.png" style="width: 480px !important; height: 219px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">执行跳转</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/d8582c8bf1ec452eba40cc236f325b38a9f011f9.png" style="width: 517px !important; height: 207px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">调用EXCEL.306DEEFE</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/2cc541f77f24bbbbe9cdd93414db7f0549e7ca51.png" style="width: 520px !important; height: 141px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">进入EXCEL.306DEEFE代码段</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/58b164104ade549e4b4058f5170906fcfa2ed9bf.png" style="width: 525px !important; height: 131px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">调用EXCEL.300CE380</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/10fca3a1ce7d444b2c967b8be8b909af6d347e4b.png" style="width: 528px !important; height: 345px !important;"></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">执行0x300CE3C8处的REP MOVS</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"><br></span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">通过以上调试过程，可以得知sub_300CE252、sub_300CE380、sub_306DF0DC、sub_306DEEFE和sub_302188D8之间的调用关系为：</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp;&nbsp;sub_300CE25</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><img src="/ikanxue/images/736a4f3f0f9b43f5c73595a2b0ee88f295dcd083.png" style="width: 26px !important; height: 33px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x302188B5&nbsp;</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub_302188D8</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span><img src="/ikanxue/images/736a4f3f0f9b43f5c73595a2b0ee88f295dcd083.png" style="width: 26px !important; height: 33px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp; sub_306DEEFE</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp; sub_306DF0DC</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp;</span><img src="/ikanxue/images/736a4f3f0f9b43f5c73595a2b0ee88f295dcd083.png" style="width: 26px !important; height: 33px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sub_300CE380</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 15px;">&nbsp; &nbsp; &nbsp; &nbsp; 0x 300CE3C8</span></p><p><br></p><section label="Copyright © 2016 playhudong All Rights Reserved." style="border-width: medium; border-color: currentcolor; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-style: none; width: 3em; margin: 2em auto;"><section class="" style="width: 10px; height: 10px; opacity: 0.5; background-color: rgb(78, 130, 247); margin-left: 2.05em;"></section><section class="" style="width: 1.7em; height: 1.7em; border-width: 1px; border-style: solid; border-color: white; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; background-color: rgb(78, 130, 247); color: white; text-align: center; margin: 0px auto; transform: rotate(360deg);"><p>03</p></section><section class="" style="width: 15px; height: 15px; background-color: rgb(78, 130, 247); margin-top: -7px; margin-left: 2px;"><br></section></section><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="font-size: 16px;">样本分析</span></p><p><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">用HexEditor2.exe打开样本exploit.xlb，发现在0000000610附近出现recordType、recordLength等字段的值（\xA7\x00,\x04\x00），0000000620附近出现0x326551EE（EXCEL 2007下CALL ESP指令地址）。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/81069fd990fd3ea1501335a6b92430c7318ea7d7.png" style="width: 554px !important; height: 123px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">我们现在的目标是使指令执行到sub_300CE252函数的末尾处（retn）,按F9执行，当执行到0x300CE361处的MOV DWORD PTR DS:[EAX],ECX时出现访问违例：访问到一个不可写的地址0x51453844，此时EAX=0x51453844，向上回溯程序，找出EAX的赋值处，发现在0x300CE354处出现给EAX赋值的操作: MOV EAX, DWORD PTR SS:[EBP+2C]，此时EBP=0x0013AA8C,EBP+2C=0x0013AAB8,0x0013AAB8处的值恰好是0x51453844。观察栈中的数据，51453844恰好又是shellcode中的数据。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/7eef5face751799fa192fde3217816c62277c46a.png" style="width: 192px !important; height: 252px !important;"><span style="font-size: 15px;"> <br></span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">因此考虑，在shellcode前面继续添加0x90，同时确保返回地址0x0013AA90处的值为EXCEL2003下的跳板指令CALL ESP的地址0x300F2903, 因为函数sub_300CE252末尾为retn 2C,即跳板地址和shellcode之间有0x30个字节的空间（shellcode的开头地址应该为0x0013AAC0&gt;0x0013AAB8），所以不妨将0x0013AAB8处的值填充为一个可写的内存地址（如0x001379E4）。这样，既解决了访问违例的问题，又不会影响shellcode的执行。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/69c2678b5c296f4d73305ec72df18192256db0a6.png" style="width: 543px !important; height: 533px !important;"><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;">修改样本数据后，重新用EXCEL2003打开，弹出了计算器。</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/c73ffd51972001f7d76eb29d199e2d05fc8b7cf1.png" style="width: 554px !important; height: 431px !important;"></p><p><br></p><p style="text-align: center; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px; color: rgb(136, 136, 136);">本文由看雪论坛 dolphindiv 原创<br></span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"><br></span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">你可能对以下内容感兴趣：<br></strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="list-style-type: circle;"><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">等你来挑战！| 看雪 CTF 2017 攻击篇</a></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">【终于等到你！】看雪 CTF 2017</a></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283121&amp;idx=1&amp;sn=f695db785889733713d011ba913e0c28&amp;chksm=b1815cfb86f6d5ed4d7fff73df9d6d5e5c2f32d935164b918b11d478b46821e2667166ac17d6&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283121&amp;idx=1&amp;sn=f695db785889733713d011ba913e0c28&amp;chksm=b1815cfb86f6d5ed4d7fff73df9d6d5e5c2f32d935164b918b11d478b46821e2667166ac17d6&amp;scene=21#wechat_redirect">聊聊游戏辅助那些事上部第一篇——过掉那些讨厌的游戏保护</a><br></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283114&amp;idx=3&amp;sn=fc763099faeb53bb8407bce865b403c1&amp;chksm=b1815ce086f6d5f60970b9c550518d07199c77e380cee90791c91a6ade3f5abd2b4c3f9588cd&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283114&amp;idx=3&amp;sn=fc763099faeb53bb8407bce865b403c1&amp;chksm=b1815ce086f6d5f60970b9c550518d07199c77e380cee90791c91a6ade3f5abd2b4c3f9588cd&amp;scene=21#wechat_redirect">CVE-2012-0158 两种 PoC 分析</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px; text-decoration: underline;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283005&amp;idx=2&amp;sn=2fc411b70549c789085e517ef6dfc3e9&amp;chksm=b1815b7786f6d261975cd000d4ddf2c4cffe3cf2d8ab06d870e7971e862c29c7278996bdfb6c&amp;scene=21#wechat_redirect" target="_blank" style="text-decoration: underline; font-size: 15px;"><span style="font-size: 15px;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283109&amp;idx=2&amp;sn=a76e18449e2a7c0d60170e0e452af7fc&amp;chksm=b1815cef86f6d5f9690abc8810e071a0529249402dd3e009005dbb5413301de4028cbd1d12b9&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283109&amp;idx=2&amp;sn=a76e18449e2a7c0d60170e0e452af7fc&amp;chksm=b1815cef86f6d5f9690abc8810e071a0529249402dd3e009005dbb5413301de4028cbd1d12b9&amp;scene=21#wechat_redirect" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">Hips篇高操之正确的全局Patch/拦截模块姿势</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283075&amp;idx=2&amp;sn=f34b3415519c129a9f829d5fe1673134&amp;chksm=b1815cc986f6d5df43c4d7cdb4be3e16e498f13d4cb60c7e1b41349fee9b4ba5b5d176b0713f&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458283075&amp;idx=2&amp;sn=f34b3415519c129a9f829d5fe1673134&amp;chksm=b1815cc986f6d5df43c4d7cdb4be3e16e498f13d4cb60c7e1b41349fee9b4ba5b5d176b0713f&amp;scene=21#wechat_redirect">WannaCry深度详细分析报告(偏重策略)</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><img src="/ikanxue/images/a0942aca19665d63c4ee222be971a37cd63dc1e4.jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 426px !important;"></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="font-size: 15px;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">看雪论坛：http://bbs.pediy.com/</span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">微信公众号 ID：ikanxue</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important; line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">微博：看雪安全</span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px;"><span style="max-width: 100%; color: rgb(178, 178, 178); box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;">投稿、合作：www.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496307545&src=3&ver=1&signature=93SzgWWUmeel8Ref4eZJuIODr9gzme7fJtytKfz*8Te*huPLcrDR7zVn0cJjpY*sniFCQ4qoj4lMopJTTObiD48vKnADyzOtjsg8Pw9qLWHdwOQXq-Cjlm*bt*1MdKlkO1ccII4Y8q2YZvXcIfLrVTkwu*IUkP4k51TANv93PIA=">微信地址</a> | <a href="http://bbs.pediy.com/thread-217940.htm">阅读原文</a>
{% endraw  %}

