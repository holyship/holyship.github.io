---
title: Xen hypervisorçš„è·¨è™šæ‹Ÿæœºä»£ç æ‰§è¡Œ
author: ghostway
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6WbLQqVN9R81LxiMolMYb5HxJb7Or3u0svWfQJ8Rx1zLdXImq0REGvjHGIF0REVvg7Lowd03Bv-nwy88bR4sghM=
date: '2017-05-12 00:00:00 +0000'

---

{% raw  %}
<p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 18px; color: rgb(217, 150, 148);"><strong>å‰è¨€</strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">2017-03-14ï¼Œæˆ‘ç»™ Xenâ€™s security teamp æŠ¥å‘Šäº†ä¸€ä¸ª Bugã€‚è¯¥ Bug å…è®¸ä½äºparavirtualizedï¼ˆåŠè™šæ‹ŸåŒ–ï¼‰Guest ä¸­çš„ä¸€ä¸ªæ‹¥æœ‰ root æƒé™çš„çš„æ”»å‡»è€…è·³å‡º hypervisor&nbsp; çš„ç®¡ç†ï¼Œå®Œå…¨æ§åˆ¶å®¿ä¸»æœºçš„ç‰©ç†å†…å­˜ã€‚Xen Project åœ¨ 2017-04-04<br>å‘å¸ƒäº†ä¸€ä¸ªå…¬å‘Šå’Œ Patch è¡¥ä¸ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 18px;"><strong><span style="color: rgb(217, 150, 148);">èƒŒæ™¯çŸ¥è¯†</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">åœ¨ x86-64 ä¸Šï¼ŒXen PV(paravirtualized) guests å’Œ hypervisor å…±äº«è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚ç²—ç•¥çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</span></p><p style="text-align: center;"><img src="/ikanxue/images/a966fe83a7bb16479ceb211a8e1fb3726446b0de.png" style="width: 441px !important; height: 492px !important; visibility: visible !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Xen å…è®¸ guest å†…æ ¸æ‰§è¡Œ hypercallï¼Œå³ä½¿ç”¨ Sytem V AMD64 AMI æ¥å®ç°ä» guest å†…æ ¸åˆ° hypervisor çš„ä¸€ä¸ªå¿…å¤‡çš„ç³»ç»Ÿè°ƒç”¨ã€‚é€šå¸¸æ˜¯ä½¿ç”¨æŒ‡ä»¤ syscall å®ç°ï¼Œæœ€å¤š 6 ä¸ªå‚æ•°ï¼Œé€šè¿‡å¯„å­˜å™¨ä¼ é€’ã€‚å°±åƒæ­£å¸¸å†…æ ¸çš„ syscallï¼ŒXen hypercall é€šå¸¸ç›´æ¥<br>ä½¿ç”¨ guest ä¸Šçš„æŒ‡é’ˆæ¥ä½œä¸ºå‚æ•°ã€‚ç”±äº hypervisor å…±äº«å®ƒçš„åœ°å€ç©ºé—´ï¼Œæ•…å®ƒèƒ½ç†è§£ç›´æ¥ä¼ é€’è¿‡æ¥çš„ guest-virtual æŒ‡é’ˆã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å°±åƒæ‰€æœ‰å†…æ ¸ä¸€æ ·ï¼Œåœ¨éœ€è¦è§£å¼•ç”¨guest-virtualæŒ‡é’ˆçš„æ—¶å€™ï¼ŒXenå¿…é¡»ç¡®ä¿å®ƒä»¬å¹¶æ²¡æœ‰å®é™…æŒ‡å‘hypervisor-ownedçš„å†…å­˜åŒºåŸŸã€‚å®ƒå®é™…ä¸Šä½¿ç”¨ç”¨æˆ·æ€çš„accessorï¼ˆå’ŒLinuxå†…æ ¸ä¸­çš„é‚£äº›ç›¸ä¼¼ï¼‰æ¥å®Œæˆè¿™äº›ä»»åŠ¡ã€‚</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; background-color: rgb(255, 215, 213);">access_ok(addr,size) </span><span style="font-size: 15px;">ï¼šæ£€æŸ¥æ˜¯å¦ä¸€ä¸ª guest-supplied çš„è™šæ‹Ÿåœ°å€å¯ä»¥å®‰å…¨è®¿é—®ï¼Œæ¢å¥è¯è¯´ï¼Œå®ƒä¼šæ£€æŸ¥è®¿é—®å†…å­˜åŒºåŸŸä¸ä¼šä¿®æ”¹åˆ°hypervisorå†…å­˜ã€‚</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; background-color: rgb(255, 215, 213);">__copy_to_guest(hnd, ptr, nr)</span><span style="font-size: 15px;"> ï¼šä» hypervisor çš„ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">ptr</span> åœ°å€æ‹·è´ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">nr</span> ä¸ªå­—èŠ‚åˆ° gueståœ°å€ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">hnd</span> ï¼Œä½†æ˜¯ä¸æ£€æŸ¥ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">hnd</span> æ˜¯å¦æœ‰æ•ˆã€‚</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px; background-color: rgb(255, 215, 213);">copy_to_guest(hnd, ptr, nr) </span><span style="font-size: 15px;">ï¼šä»hypervisorçš„ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">ptr</span> åœ°å€æ‹·è´ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">nr</span> ä¸ªå­—èŠ‚åˆ° guest åœ°å€ hnd ï¼ŒéªŒè¯ hnd æœ‰æ•ˆæ€§ã€‚</span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">åœ¨ Linux å†…æ ¸ä¸­ï¼Œå®<span style="font-size: 15px; background-color: rgb(255, 215, 213);"> access_ok() </span>æ£€æµ‹åœ°å€èŒƒå›´ addr åˆ° addr+size-1 æ˜¯å¦å¯ä»¥å®‰å…¨è®¿é—®ï¼Œä½¿ç”¨ä»»æ„çš„å†…å­˜è®¿é—®æ¨¡å¼ã€‚ç„¶è€Œï¼ŒXen çš„ access_ok() å¹¶ä¸ç¡®ä¿è¿™äº›ï¼š</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: normal;"><span style="font-size: 14px;">/*<br>* Valid if in +ve half of 48â€bit address space, or above Xenâ€reserved area.<br>* This is also valid for range checks (addr, addr+size). As long as the<br>* start address is outside the Xenâ€reserved area then we will access a<br>* nonâ€canonical address (and thus fault) before ever reaching VIRT_START.<br>*/<br>#define __addr_ok(addr) \<br>(((unsigned long)(addr) &lt; (1UL&lt;&lt;47)) || \<br>((unsigned long)(addr) &gt;= HYPERVISOR_VIRT_END))<br>#define access_ok(addr, size) \<br>(__addr_ok(addr) || is_compat_arg_xlat_range(addr, size))</span><span style="font-size: 15px;"><br></span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Xen é€šå¸¸åªæ˜¯æ£€æŸ¥æŒ‡é’ˆ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">addr</span> ä½äºåœ°å€ç©ºé—´æˆ–è€…å†…æ ¸ç©ºé—´ï¼Œä½†ä¸æ£€æŸ¥å¤§å° <span style="font-size: 15px; background-color: rgb(255, 215, 213);">size</span> ã€‚å¦‚æœå®é™…çš„ Guest Memory è®¿é—®ä»åœ°å€addré™„è¿‘å¼€å§‹ï¼Œçº¿æ€§çš„å¤„ç†ï¼Œåªè¦ä¸€ä¸ª guest memory è®¿é—®å¤±è´¥ï¼Œåˆ™ bails out æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå¤§ç‰‡çš„ non-canonical åœ°å€ç©ºé—´æ­£å¥½å……å½“äº†ä¸€ä¸ªå¤§çš„ä¿æŠ¤åŒºã€‚ç„¶è€Œï¼Œå¦‚æœä¸€ä¸ª hypercall æƒ³è¦è®¿é—®ä¸€ä¸ªèµ·å§‹äº 64-bit offset çš„ guest bufferï¼Œåˆ™å®ƒéœ€è¦ç¡®ä¿è°ƒç”¨æ—¶ access_ok() å¡«å…¥æ­£ç¡®çš„åç§»ï¼Œæ£€æŸ¥æ•´ä¸ª userspace buffer æ˜¯ä¸å®‰å…¨çš„ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Xen æä¾›äº†å›´ç»• <span style="font-size: 15px; background-color: rgb(255, 215, 213);">access_ok()&nbsp;</span> çš„å°è£…æ¥æ£€æŸ¥ guest ä¸­è®¿é—®æ•°ç»„ã€‚å¦‚æœæƒ³æ£€æŸ¥æ˜¯å¦å¯ä»¥å®‰å…¨çš„è®¿é—®ä¸€ä¸ªæ•°ç»„ï¼ˆä»ä¸‹æ ‡ 0 å¼€å§‹ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">guest_handle_okay(hnd,nr)</span> ã€‚ç„¶è€Œï¼Œå¦‚æœä½ æƒ³æ£€æŸ¥ä¸ä»ä¸‹æ ‡ 0 å¼€å§‹çš„æ•°ç»„ï¼Œåº”è¯¥ä½¿ç”¨ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">guest_handle_subrange_okay(hnd, first, last)</span> ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å½“æˆ‘çœ‹åˆ°äº† access_ok çš„å®šä¹‰ï¼Œå‘ç°å…¶ç¼ºä¹å®Œæ•´çš„å®‰å…¨æ€§éªŒè¯ï¼Œæ‰€ä»¥ï¼Œæˆ‘å¼€å§‹æŸ¥æ‰¾è°ƒç”¨å®ƒçš„åœ°æ–¹ï¼Œæ¥çœ‹æ˜¯å¦æœ‰ä¸å®‰å…¨çš„ä½¿ç”¨è¡Œä¸ºã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(217, 150, 148); font-size: 18px;"><strong><span style="color: rgb(217, 150, 148);">Hypercall çš„æŠ¢å æœºåˆ¶(Preemption)</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å½“è°ƒåº¦ Tick å‘ç”Ÿï¼ŒXen éœ€è¦å¿«é€Ÿçš„ä»å½“å‰æ‰§è¡Œçš„ vCPU åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè™šæ‹Ÿæœºçš„vCPUã€‚ç„¶è€Œç®€å•çš„ä¸­æ–­ hypercall çš„æ‰§è¡Œæ˜¯ä¸ä¼šèµ·ä½œç”¨çš„ï¼ˆeg.hypercall å¯èƒ½æ­£æ‹¥æœ‰ä¸€ä¸ªè‡ªæ—‹é”ï¼‰ï¼Œæ•… Xenï¼ˆåƒå…¶ä»–æ“ä½œç³»ç»Ÿï¼‰éœ€è¦ä¸€äº›æœºåˆ¶æ¥å»¶è¿Ÿ vCPU çš„åˆ‡<br>æ¢ï¼Œç›´åˆ°å®ƒè¶³å¤Ÿå®‰å…¨çš„æ¥æ‰§è¡Œã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">åœ¨ Xen é‡Œï¼Œhypercall çš„æŠ¢å æ˜¯é€šè¿‡ä½¿ç”¨ <span style="font-size: 15px; background-color: rgb(255, 215, 213);">è‡ªæ„¿æ€§æŠ¢å (voluntary preemption)</span> å®ç°çš„ï¼šä»»ä½•é•¿æ—¶é—´è¿è¡Œçš„ hypercall ä»£ç éœ€è¦æå‰è°ƒç”¨<span style="font-size: 15px; background-color: rgb(255, 215, 213);"> hypercall_preempt_check()</span> æ¥æ£€æŸ¥æ˜¯å¦è°ƒåº¦å™¨æƒ³è¦è°ƒåº¦åˆ°å¦ä¸€ä¸ª vCPU ä¸Šã€‚å¦‚æœè¯¥äº‹ä»¶å‘ç”Ÿäº†ï¼Œhypercall<br>ä»£ç é€€å‡ºåˆ° guestï¼Œå› æ­¤ï¼Œä»¥ä¿¡å·çš„æ–¹å¼é€šçŸ¥è°ƒåº¦å™¨ï¼ŒæŠ¢å å½“å‰ä»»åŠ¡æ˜¯å®‰å…¨çš„ï¼Œè°ƒæ•´äº† hypercall argument å‚æ•°åï¼ˆåœ¨guest registeræˆ–è€…guest å†…å­˜ï¼‰ï¼Œåªè¦å½“å‰ vCPU å†æ¬¡è¢«è°ƒåº¦ï¼Œå®ƒå°†é‡æ–°è¿›å…¥ hypercall ä¹‹åï¼Œæ‰§è¡Œå‰©ä½™çš„å·¥ä½œã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Hypercall æ— æ³•åŒºåˆ†æŠ¢å ä¹‹åçš„æ­£å¸¸çš„ hypercall entry å’Œ hypercall re-entryã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Xen ä½¿ç”¨ Hypercall re-entry çš„æœºåˆ¶ï¼Œå› ä¸º Xen å¹¶ä¸æ˜¯æ¯ä¸€ä¸ª vCPU éƒ½æœ‰ä¸€ä¸ªhypervisor æ ˆã€‚å®ƒæ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªç‰©ç†æ ¸æœ‰ä¸€ä¸ª hypervisor æ ˆã€‚è¿™æ„å‘³ç€ï¼Œåˆ«çš„æ“ä½œç³»ç»Ÿï¼Œæ¯”å¦‚ Linuxï¼Œå¯ä»¥ç®€å•çš„ç¦»å¼€ä¸€ä¸ªä¸­æ–­çš„ syscall çš„çŠ¶æ€ï¼Œè€Œ Xen æ— æ³•è½»æ¾çš„åšåˆ°ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">è¿™ä¸ªè®¾è®¡æ„å‘³ç€å¯¹äºä¸€äº› hypercallï¼Œå…è®¸ä»–ä»¬é€‚å½“åœ° resume å®ƒä»¬çš„å·¥ä½œï¼Œé¢å¤–çš„æ•°æ®ä¿å­˜åˆ° guest memory ä¸­ï¼Œè€Œ guest momory çš„æ•°æ®æœ‰å¯èƒ½è¢«ä¿®æ”¹ guest ç²¾å¿ƒä¿®æ”¹è€Œç”¨æ¥æ”»å‡» hypervisorã€‚</span></p><p style="margin-top: 25px; margin-bottom: 25px; line-height: 2em;"><span style="font-size: 18px; color: rgb(217, 150, 148);"><strong>memory_exchange()</strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">hypercall <span style="font-size: 15px; background-color: rgb(255, 215, 213);">HYPERVISOR_memory_op(XENMEM_exchange, arg)</span> è°ƒç”¨å‡½æ•° <span style="font-size: 15px; background-color: rgb(255, 215, 213);">memory_exchange(arg)(source code: xen/common/memory.c)</span> ã€‚è¯¥å‡½æ•°å…è®¸ä¸€ä¸ª guest å°†å®ƒä»¬æ‹¥æœ‰çš„çš„ç‰©ç†å†…å­˜ç”¨æ¥äº¤æ¢ä¸€äº›åœ¨ç‰©ç†åœ°å€è¿ç»­æ€§ä¸Šæœ‰é™åˆ¶çš„æ–°çš„ç‰©ç†å†…å­˜ã€‚è¯¥åŠŸèƒ½å¯¹äºæƒ³å®ç° DMA åŠŸèƒ½çš„ guest éå¸¸æœ‰ç”¨ï¼Œå› ä¸º DMA éœ€è¦ç‰©ç†ä¸Šè¿ç»­çš„ç¼“å†²åŒºã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: normal;"><span style="font-size: 15px;">è¯¥ hypercall éœ€è¦ä¸€ä¸ªç»“æ„ä¸º <span style="font-size: 15px; background-color: rgb(255, 215, 213);">struct xen_memory_exchage</span> çš„å‚æ•°ï¼Œå®šä¹‰å¦‚ä¸‹:<span style="font-size: 14px;"><br></span></span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: normal;"><span style="font-size: 15px;"><span style="font-size: 14px;">truct xen_memory_reservation {<br>/* [...] */<br>XEN_GUEST_HANDLE(xen_pfn_t) extent_start; /* in: physical page list */<br>/* Number of extents, and size/alignment of each (2^extent_order pages). */<br>xen_ulong_t nr_extents;<br>unsigned int extent_order;<br>/* XENMEMF flags. */<br>unsigned int mem_flags;<br>/*<br>* Domain whose reservation is being changed.<br>* Unprivileged domains can specify only DOMID_SELF.<br>*/<br>domid_t domid;<br>};<br>struct xen_memory_exchange {<br>/*<br>* [IN] Details of memory extents to be exchanged (GMFN bases).<br>* Note that @in.address_bits is ignored and unused.<br>*/<br>struct xen_memory_reservation in;<br>/*<br>* [IN/OUT] Details of new memory extents.<br>* We require that:<br>* 1. @in.domid == @out.domid<br>* 2. @in.nr_extents &lt;&lt; @in.extent_order ==<br>* @out.nr_extents &lt;&lt; @out.extent_order<br>* 3. @in.extent_start and @out.extent_start lists must not overlap<br>* 4. @out.extent_start lists GPFN bases to be populated<br>* 5. @out.extent_start is overwritten with allocated GMFN bases<br>*/<br>struct xen_memory_reservation out;<br>/*<br>* [OUT] Number of input extents that were successfully exchanged:<br>* 1. The first @nr_exchanged input extents were successfully<br>* deallocated.<br>* 2. The corresponding first entries in the output extent list correctly<br>* indicate the GMFNs that were successfully exchanged.<br>* 3. All other input and output extents are untouched.<br>* 4. If not all input exents are exchanged then the return code of this<br>* command will be nonâ€zero.<br>* 5. THIS FIELD MUST BE INITIALISED TO ZERO BY THE CALLER!<br>*/<br>xen_ulong_t nr_exchanged;<br>};</span><br></span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å’Œè¯¥ Bug ç›¸å…³çš„æˆå‘˜æœ‰: in.extent_start, in.nr_extents, out.extent_start, out.nr_extents å’Œ nr_exchangednr_exchanged æ–‡æ¡£ä¸­é»˜è®¤æ€»æ˜¯è¢« guest åˆå§‹åŒ–ä¸º 0ï¼Œè¿™æ˜¯å› ä¸ºï¼Œå®ƒä¸ä»…ç”¨æ¥è¿”å›ä¸€ä¸ªç»“æœï¼ŒåŒæ—¶ hypercall çš„æŠ¢å ä¸­ä¹Ÿä¼šç”¨åˆ°ã€‚å½“ memory_exchange() è¢«æŠ¢å åï¼Œ nr_exchaged å­˜å‚¨å®ƒçš„è¿›åº¦ï¼Œè¿™æ ·ï¼Œå½“ä¸‹ä¸€æ¬¡æ‰§è¡Œ memory_exchage() æ—¶ï¼Œä½¿ç”¨ nr_exchanged æ¥å†³å®šè¾“å…¥æ•°ç»„ä¸­ in.extent_startå’Œout.extent_start çš„å“ªä¸ªç‚¹åº”è¯¥è¢«resumeã€‚åŸæ¥çš„ memory_exchange() å¹¶ä¸æ£€æŸ¥ç”¨æˆ·ç©ºé—´çš„æ•°ç»„æŒ‡é’ˆï¼Œåœ¨ä½¿ç”¨ __copy_from_guest_offsetå’Œ__copy_to_guest_offset() è®¿é—®å®ƒä»¬ä¹‹å‰ï¼Œè€Œä¸”ä¸è¿›è¡Œè‡ªèº«çš„ä»»ä½•æ£€æŸ¥ï¼Œæ•…ï¼Œä½¿ç”¨æä¾›çš„hypervisoræŒ‡é’ˆï¼Œå¯èƒ½å¯¼è‡´Xenå»è¯»æˆ–è€…å†™hypervisorå†…å­˜â€“ä¸€ä¸ªéå¸¸ä¸¥é‡çš„Bugã€‚è¯¥é—®é¢˜åœ¨2012å¹´è¢«å‘ç°(XSA-29,CVE-2012-5513)ï¼ŒåŒæ—¶è¿›è¡Œäº†å¦‚ä¸‹ä¿®è¡¥ï¼ˆhttps://xenbits.xen.org/xsa/xsa29-4.1.patchï¼‰ï¼š</span></p><blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: normal;"><span style="font-size: 14px;">diff â€â€git a/xen/common/memory.c b/xen/common/memory.c<br>index 4e7c234..59379d3 100644<br>â€â€â€ a/xen/common/memory.c<br>+++ b/xen/common/memory.c<br>@@ â€289,6 +289,13 @@ static long memory_exchange(XEN_GUEST_HANDLE(xen_memory_exchange_t)<br>arg)<br>goto fail_early;<br>}<br>+ if ( !guest_handle_okay(exch.in.extent_start, exch.in.nr_extents) ||<br>+ !guest_handle_okay(exch.out.extent_start, exch.out.nr_extents) )<br>+ {<br>+ rc = â€EFAULT;<br>+ goto fail_early;<br>+ }<br>+<br>/* Only privileged guests can allocate multiâ€page contiguous extents. */<br>if ( !multipage_allocation_permitted(currentâ€&gt;domain,<br>exch.in.extent_order) ||</span><span style="font-size: 15px;"><br></span></p></blockquote><p style="margin-top: 25px; margin-bottom: 25px; line-height: 2em;"><span style="color: rgb(217, 150, 148); font-size: 18px;"><strong><span style="color: rgb(217, 150, 148);">The Bug</span></strong></span></p><p style="line-height: normal;"><span style="font-size: 15px;">å¦‚ä¸‹ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼Œ64bit resumption åç§» nr_exchanged ï¼Œå¯ä»¥è¢« guest æ§åˆ¶ï¼Œç”±äºXenâ€™s çš„ hypercall resumption æœºåˆ¶ï¼Œå¯ä»¥è¢« guest ç”¨æ¥ä» out.extent_start é€‰æ‹©ä¸€ä¸ªåç§»ç”¨æ¥å†™ï¼š</span><span style="font-size: 14px;"><br></span></p><p style="line-height: normal;"><span style="font-size: 14px;"><br></span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">static long memory_exchange(XEN_GUEST_HANDLE_PARAM(xen_memory_exchange_t) arg)<br>{<br>[...]<br>/* Various sanity checks. */<br>[...]<br>if ( !guest_handle_okay(exch.in.extent_start, exch.in.nr_extents) ||<br>!guest_handle_okay(exch.out.extent_start, exch.out.nr_extents) )<br>{<br>rc = â€EFAULT;<br>goto fail_early;<br>} [<br>...]<br>for ( i = (exch.nr_exchanged &gt;&gt; in_chunk_order);<br>i &lt; (exch.in.nr_extents &gt;&gt; in_chunk_order);<br>i++ )<br>{<br>[...]<br>/* Assign each output page to the domain. */<br>for ( j = 0; (page = page_list_remove_head(&amp;out_chunk_list)); ++j )<br>{<br>[...]<br>if ( !paging_mode_translate(d) )<br>{<br>[...]<br>if ( __copy_to_guest_offset(exch.out.extent_start,<br>(i &lt;&lt; out_chunk_order) + j,<br>&amp;mfn, 1) )<br>rc = â€EFAULT;<br>}<br>}[<br>...]<br>}[<br>...]<br>}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ç„¶è€Œï¼Œ guest_handle_okay() åªæ£€æŸ¥äº†æ˜¯å¦å¯ä»¥å®‰å…¨è®¿é—®ä»ä¸‹æ ‡ 0 å¼€å§‹çš„ guest æ•°ç»„ exch.out.extent_start ã€‚ guest_handle_subrange_okay æ‰åº”è¯¥æ˜¯æ­£ç¡®çš„æ–¹å¼ã€‚å› æ­¤ï¼Œä¸€ä¸ª attacker å¯ä»¥æ”»å‡»è€…å¯ä»¥é€šè¿‡å¦‚ä¸‹æ¡ä»¶æ¥è¾¾åˆ°ç»™ä»»æ„åœ°å€å†™ 8 ä¸ªå­—èŠ‚çš„æ•°æ®çš„ç›®çš„ï¼š</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">exch.in.extent_order å’Œ exch.out.extent_order ä¸º0ï¼ˆæ–°é¡µå¤§å°çš„å—æ›¿æ¢åŸæ¥çš„é¡µå¤§å°çš„å—ï¼‰ã€‚</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">exch.out.extent_start å’Œ exch.nr_exchanged ï¼š exch.out.extent_start æŒ‡å‘ç”¨æˆ·ç©ºé—´å†…å­˜ï¼Œç„¶è€Œ exch.out.extent_start+8*exch.nr_exchanged æŒ‡å‘hypervisorå†…å­˜ä¸­çš„ç›®æ ‡åœ°å€ï¼Œå½“exch.out.extent_startè¶‹è¿‘ä¸NULLæ—¶ï¼Œå¯ä»¥è¿™æ ·è®¡ç®—:</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">exch.out.extent_start=target_add%8, exch.nr_exchanged=target_addr/8 ã€‚</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">exch.in.nr_extents å’Œ exch.out.nr_extents ä¸º exch.nr_exchanged+1 ã€‚</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">exch.in.extent_start ä¸º input_bufferâ€8*exch.nr_exchanged(input_bufferæ˜¯ä¸€ä¸ªåˆç†çš„æŒ‡å‘ç‰©ç†é¡µçš„guest_å†…æ ¸åœ°å€æŒ‡é’ˆ) è¿™ä¸ªç¡®ä¿æ€»æ˜¯æŒ‡å‘guestç”¨æˆ·ç©ºé—´èŒƒå›´(é€šè¿‡äº†access_ok()æ£€æŸ¥)ï¼Œå› ä¸º exch.out.extent_start ç²—ç•¥åœ°æŒ‡å‘ç”¨æˆ·ç©ºé—´åœ°å€èŒƒå›´çš„èµ·å§‹åœ°å€ï¼Œè€Œä¸”ï¼Œguestå†…æ ¸åœ°å€èŒƒå›´å’Œç”¨æˆ·ç©ºé—´åœ°å€èŒƒå›´ä¸€æ ·å¤§ã€‚<br>å†™å…¥åˆ°æ”»å‡»è€…æ§åˆ¶çš„åœ°å€ä¸­çš„å€¼æ˜¯ä¸€ä¸ªPFNå·ã€‚</span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><br></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(217, 150, 148); font-size: 18px;"><strong><span style="color: rgb(217, 150, 148);">åˆ©ç”¨è¯¥bugï¼šè·å–é¡µè¡¨çš„æ§åˆ¶</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">åœ¨ä¸€ä¸ªå¿™ç¢Œçš„ç³»ç»Ÿä¸Šï¼Œæ§åˆ¶ç”±å†…æ ¸å†™çš„é¡µå·æ˜¯éå¸¸å›°éš¾çš„ã€‚å› æ­¤ï¼Œå‡ºäºç¨³å®šæ€§çš„è€ƒè™‘ï¼Œæœ‰å¿…è¦å°†è¯¥ bug è§†ä¸ºä¸€ä¸ª primitiveï¼Œå³å¾ªç¯åœ°åœ¨ä¸€ä¸ªå›ºå®šçš„åœ°å€å†™ 8 ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ŒåŒæ—¶å¤§éƒ¨åˆ†æœ‰æ•ˆçš„ä½åˆå§‹åŒ–ä¸º 0ï¼ˆç”±äºæœ‰é™çš„ç‰©ç†å†…å­˜ï¼‰ï¼ŒåŒæ—¶å°‘é‡çš„æœ‰æ•ˆä½åˆå§‹åŒ–ä¸ºéšæœºå€¼ã€‚å¯¹äºæˆ‘çš„ exploitï¼Œæˆ‘å†³å®šå°†è¿™ä¸ª primitive è§†ä¸ºå†™ä¸€ä¸ªå¿…é¡»åœ°éšæœºå­—èŠ‚å’Œç´§éš 7 ä¸ªåƒåœ¾å­—èŠ‚çš„æ–¹å¼ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">äº‹å®è¯æ˜ï¼Œå¯¹äºä¸€ä¸ª x86-64PV guestï¼Œæœ‰è¿™æ ·ä¸€ä¸ª primitiveï¼Œå¯¹äºç¨³å®šçš„åˆ©ç”¨æ˜¯éå¸¸æœ‰æ•ˆçš„ï¼Œå› ä¸ºï¼š</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">x86-64PV guest çŸ¥é“æ‰€æœ‰å®ƒå¯ä»¥è®¿é—®çš„ç‰©ç†é¡µçš„é¡µå·ã€‚</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">x86-64PV guest å¯ä»¥æ˜ å°„å±äºå®ƒä»¬ domain çš„é¡µè¡¨ï¼ˆ4ä¸ªlevelçš„ï¼‰ä¸ºå¯è¯»ã€‚Xemåªé˜»æ­¢å°†å®ƒä»¬æ˜ å°„ä¸ºå¯å†™ã€‚</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Xen æ˜ å°„æ‰€æœ‰çš„ç‰©ç†å†…å­˜ä¸ºå¯å†™ï¼Œåœ¨åœ°å€ 0xffff830000000000ã€‚<br></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">æ”»å‡»çš„ç›®æ ‡æ˜¯å°† level 3 é¡µè¡¨ï¼ˆæˆ‘ç§°ä¸ºâ€œå—å®³é¡µè¡¨â€ï¼‰ä¸­çš„ä¸€ä¸ª entry æŒ‡å‘ä¸€ä¸ª guest æœ‰å†™æƒé™çš„é¡µï¼ˆæˆ‘ç§°ä¸ºâ€œå‡é¡µè¡¨â€ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œæ”»å‡»è€…å¿…é¡»å†™å…¥ 8 ä¸ªå­—èŠ‚æ•°æ®ï¼ŒåŒæ—¶è¦æœ‰å‡é¡µè¡¨çš„ç‰©ç†é¡µå·å’Œä¸€äº›å…¶å®ƒçš„ Flagï¼ŒåŒæ—¶è¿˜è¦ç¡®ä¿ï¼Œä¹‹åçš„ 8 ä¸ªå­—èŠ‚<br>çš„é¡µè¡¨é¡¹ä¿æŒç¦ç”¨çŠ¶æ€ï¼ˆeg.é€šè¿‡è®¾ç½®ä¸‹ä¸€ä¸ªentryçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0ï¼‰ã€‚æœ€ç»ˆï¼Œæ”»å‡»è€…å¿…é¡»å†™8ä¸ªæ§åˆ¶åœ°å­—èŠ‚ï¼Œä¹‹ååœ° 7 ä¸ªå­—èŠ‚ä¸ç”¨å…³å¿ƒã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å› ä¸ºæ‰€æœ‰ç›¸å…³é¡µçš„ç‰©ç†é¡µå·å’Œå¯å†™çš„æ˜ å°„çš„ç‰©ç†åœ°å€å¯¹äº guest æ¥è¯´éƒ½æ˜¯å¯çŸ¥çš„ï¼Œå› æ­¤ï¼Œæ‰¾å‡ºå†™åˆ°å“ªå’Œè¦å†™ä»€ä¹ˆéå¸¸è½»æ¾ï¼Œæ‰€ä»¥ï¼Œå”¯ä¸€çš„é—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•åˆ©ç”¨ primitive æ¥çœŸæ­£åœ°å†™å…¥æ•°æ®ã€‚<br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å› ä¸ºæ”»å‡»è€…æƒ³ä½¿ç”¨ primivite æ¥å†™åˆ°ä¸€ä¸ªå¯è¯»åœ°é¡µé¢ï¼Œæ•…å†™å…¥ä¸€ä¸ªå­—èŠ‚éšæœºæ•°æ®å’Œ7å­—èŠ‚åƒåœ¾æ•°æ®çš„æ–¹å¼å¯ä»¥è½»æ¾åœ°è½¬æ¢ä¸ºå†™å…¥ä¸€ä¸ªå­—èŠ‚çš„æ§åˆ¶æ•°æ®å’Œ 7 ä¸ªå­—èŠ‚çš„åƒåœ¾æ•°æ®ï¼Œè€Œå†™å…¥ä¸€ä¸ªå­—èŠ‚çš„æ§åˆ¶æ•°æ®å’Œ 7 ä¸ªå­—èŠ‚åƒåœ¾æ•°æ®çš„ primitive å¯ä»¥è½¬æ¢ä¸ºå†™å…¥æ§åˆ¶æ•°æ®å’Œ 7 ä¸ªå­—èŠ‚åƒåœ¾æ•°æ®çš„ primitiveï¼Œé€šè¿‡å†™å…¥å­—èŠ‚åˆ°è¿ç»­çš„åœ°å€ï¼Œè¿™æ‰æ˜¯çœŸæ­£çš„ primitive neededã€‚<br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">åˆ°æ­¤æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥æ§åˆ¶ä¸€ä¸ªå®æ—¶çš„é¡µè¡¨ï¼Œæ¥å…è®¸æ”»å‡»è€…æ˜ å°„ä»»æ„åœ°ç‰©ç†åœ°å€åˆ°guest çš„è™šæ‹Ÿåœ°å€ã€‚ä¹Ÿæ„å‘³ç€æ”»å‡»è€…å¯ä»¥ä»å†…å­˜ä¸­å¯é çš„è¯»å–å’Œå†™å…¥ï¼ŒåŒ…æ‹¬ä»£ç å’Œæ•°æ®ç­‰ï¼Œåˆ° hypervisor å’Œè¯¥ç³»ç»Ÿä¸Šæ‰€æœ‰å…¶ä»–çš„è™šæ‹Ÿæœºä¸­ã€‚</span></p><p style="margin-top: 25px; margin-bottom: 25px; line-height: 2em;"><span style="color: rgb(217, 150, 148); font-size: 18px;"><strong><span style="color: rgb(217, 150, 148);">åœ¨å…¶ä»–è™šæ‹Ÿæœºä¸­æ‰§è¡Œ shell å‘½ä»¤</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">åœ¨æ­¤æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥å®Œå…¨æ§åˆ¶æœºå™¨äº†ï¼Œç›¸å½“äºæ‹¥æœ‰äº† hypervisor çš„ç‰¹æƒçº§ï¼ŒåŒæ—¶é€šè¿‡æœç´¢ç‰©ç†å†…å­˜å¯ä»¥è½»æ˜“åœ°è·å–ä¸€äº›æœºå¯†ä¿¡æ¯ã€‚ä½†æ˜¯ä¸€ä¸ªå®é™…ä¸»ä¹‰çš„æ”»å‡»è€…ï¼Œè€ƒè™‘åˆ°æ›´å¤šçš„è¢«æ£€æµ‹åˆ°çš„é£é™©ï¼Œå¾ˆå¯èƒ½ä¸ä¼šæ³¨å…¥ä»£ç åˆ°è™šæ‹Ÿæœºä¸­ã€‚<br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ä½†æ˜¯åœ¨åˆ«çš„ VM ä¸­è¿è¡Œä»»æ„ä¸€ä¸ª shell å‘½ä»¤æ›´ä½è°ƒä¸€äº›ã€‚æ‰€ä»¥ï¼Œæˆ‘æ‰“ç®—ç»§ç»­å®Œå–„æˆ‘çš„exploit ä½¿å…¶å¯ä»¥ç»™æ‰€æœ‰çš„å…¶ä»– PV è™šæ‹Ÿæœºæ³¨å…¥ä¸€ä¸ª shell å‘½ä»¤ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ç¬¬ä¸€æ­¥ï¼Œæˆ‘æ‰“ç®—åœ¨ hypervisor ä¸Šä¸‹æ–‡ä¸­ï¼Œè·å–å¯é çš„ä»£ç æ‰§è¡Œèƒ½åŠ›ã€‚é€šè¿‡è¯»å†™ç‰©ç†å†…å­˜çš„èƒ½åŠ›ï¼Œä¸€ä¸ªç›¸å¯¹ OS (æˆ–è€… hypervisor )ç‹¬ç«‹çš„ä»¥ kernel/hypervisor æƒé™è°ƒç”¨ä»»æ„åœ°å€çš„æ–¹å¼æ˜¯ä½¿ç”¨éç‰¹æƒæŒ‡ä»¤ SIDT æ¥å®šä½ IDT è¡¨ï¼ŒåŒæ—¶å†™å…¥ä¸€ä¸ª DPL3 çš„ IDT entryï¼Œä¹‹åäº§ç”Ÿä¸­æ–­ã€‚Xen æ”¯æŒ SMEP å’Œ SMAPï¼Œæ•…ä¸å¯èƒ½å°† IDT Entry æŒ‡åˆ° guest å†…å­˜ä¸­ï¼Œä½†æ˜¯ä½¿ç”¨è¯»å†™é¡µè¡¨é¡¹çš„èƒ½åŠ›ï¼Œå¯ä»¥æ˜ å°„ä¸€ä¸ª guest æ‹¥æœ‰çš„ï¼Œä½äº hypervisorä¸Šä¸‹æ–‡çš„ shellcode é¡µä¸º nonâ€userâ€accessible ï¼Œè¿™æ ·å¯ä»¥ç»•è¿‡ SMEPã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ä¹‹åï¼Œåœ¨ hypervisor ä¸Šä¸‹æ–‡ä¸­ï¼Œå¯ä»¥é€šè¿‡è¯»å†™ IA32_LSTAR MSR å¯„å­˜èµ·æ¥ hook Syscall å…¥å£ç‚¹ã€‚Syscall å…¥å£ç‚¹ï¼ŒåŒæ—¶é€‚ç”¨äºæ¥è‡ª guest ç”¨æˆ·ç©ºé—´çš„ syscall å’Œæ¥è‡ª guest å†…æ ¸çš„ hypercallã€‚é€šè¿‡æ˜ å°„ä¸€ä¸ªæ”»å‡»è€…æ§åˆ¶çš„é¡µé¢åˆ° guestâ€userâ€accessible å†…å­˜ï¼Œæ”¹å˜å¯„å­˜å™¨çŠ¶æ€ï¼Œè°ƒç”¨ sysretï¼Œæœ‰å¯èƒ½å°†ç”¨æˆ·ç©ºé—´çš„æ‰§è¡Œè½¬ç§»åˆ°ä»»æ„ guest ç”¨æˆ·çš„ shellcodeä¸Šï¼Œè¯¥æ“ä½œç‹¬ç«‹äº hypervisor å’Œ guest æ“ä½œç³»ç»Ÿã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">æˆ‘çš„ exploit æ³¨å…¥ shellcode åˆ°æ‰€æœ‰ guest ç”¨æˆ·ç©ºé—´æ¯ä¸€ä¸ªè°ƒç”¨ write() Syscall çš„è¿›ç¨‹ã€‚å½“ shellcode è¿è¡Œæ—¶ï¼Œå®ƒæ£€æŸ¥å®ƒæ˜¯å¦å®ƒæ˜¯å¦ä»¥ root æƒé™è¿è¡Œï¼ŒåŒæ—¶æ˜¯å¦åœ¨ guest çš„æ–‡ä»¶ç³»ç»Ÿä¸å­˜åœ¨ lockfile æ–‡ä»¶ã€‚å¦‚æœè¿™äº›æ¡ä»¶è¢«æ»¡è¶³ï¼Œè°ƒç”¨ clone() syscall æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œä»»æ„çš„ shell å‘½ä»¤ã€‚ï¼ˆæ³¨æ„ï¼Œæˆ‘çš„ exploit å¹¶æ²¡æœ‰ç»“æŸè‡ªèº«ï¼Œæ•…å½“attacking domain ä¹‹åå…³é—­äº†ï¼Œhoo kç‚¹å°†å¯¼è‡´ hypervisor å´©æºƒï¼‰ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å¦‚ä¸‹æ˜¯ä¸€ä¸ª Qube OS3.2 æˆåŠŸæ”»å‡»çš„ä¸€ä¸ªæˆªå›¾ã€‚è¯¥ä»£ç å®åœ¨ä¸€ä¸ªéç‰¹æƒçš„ domain&nbsp; â€œtest1234â€ä¸­æ‰§è¡Œçš„ï¼Œæˆªå›¾æ˜¾ç¤ºï¼Œå®ƒæˆåŠŸæ³¨å…¥ä»£ç åˆ° dom0 å’Œ firewallvm è™šæ‹Ÿæœºä¸­ï¼š</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p><img src="/ikanxue/images/51c728f3e700aba6ccea9e579ee4350160045246.png" style="width: 671px !important; height: 325px !important;"></p><p style="margin-top: 25px; margin-bottom: 25px; line-height: 2em;"><span style="font-size: 15px;"></span><span style="font-size: 18px;"><strong><span style="color: rgb(217, 150, 148);">ç»“è®º</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">æˆ‘åšä¿¡å¯¼è‡´è¯¥é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ç”±äº accessok() çš„ä½å®‰å…¨éªŒè¯ã€‚å½“å‰ç‰ˆæœ¬çš„ access_ok() æ˜¯ 2005 å¹´æäº¤çš„ï¼Œä¸¤å¹´åï¼Œå‘å¸ƒäº† Xen å’Œ XSA çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚è€Œä¸”çœ‹èµ·æ¥è€çš„ä»£ç æ¯”æ–°çš„ä»£ç æ›´å¯èƒ½åŒ…å«å¤šçš„ç›¸å¯¹ç›´æ¥çš„å®‰å…¨ç¼ºé™·ï¼Œå› ä¸ºå½“æ—¶æäº¤æ—¶å¹¶æ²¡æœ‰å¤ªå¤šè€ƒè™‘å®‰å…¨å› ç´ ï¼Œå¦‚æ­¤è€ä»£ç ä¸€ç›´æ²¿ç”¨è‡³ä»Šã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å½“åŸºäºè¿™äº›è®¾æƒ³çš„å®‰å…¨ç›¸å…³çš„ä»£ç è¢«ä¼˜åŒ–æ—¶ï¼Œä¸€å®šè¦ç•™æ„é˜²æ­¢è¿™äº›è®¾æƒ³è¢«åˆ©ç”¨ã€‚ access_ok() äº‹å®ä¸Šå¸¸ç”¨æ¥æ£€æµ‹æ˜¯å¦æ•´ä¸ªèŒƒå›´å’Œ hypervisor å†…å­˜é‡å¤ï¼Œè¿™æ ·å°†é˜»æ­¢è¯¥bug çš„äº§ç”Ÿã€‚ä¸å¹¸çš„æ˜¯ï¼Œ2005 å¹´ï¼Œ a commit with "x86_64 fixes/cleanups" æ”¹å˜äº† access_ok() åœ¨ x86_64 ä¸Šçš„è¡Œä¸ºï¼Œä¸€ç›´æ²¿ç”¨åˆ°ç°åœ¨çš„ç‰ˆæœ¬ã€‚å°±æˆ‘ç›®å‰è®¤ä¸ºï¼Œå”¯ä¸€æ²¡æœ‰ç›´æ¥ä½¿ MEMOP_increase_revervation å’Œ MEMOP_decrease_reservation hypercallæœ‰æ¼æ´çš„åŸå› æ˜¯å› ä¸º do_dom_mem_op() çš„å‚æ•° nr_extents æ˜¯ 32 ä½çš„â€”-ä¸€ä¸ªç›¸å¯¹è„†å¼±çš„é˜²å¾¡ã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ç„¶è€Œï¼Œå·²ç»å‘ç°äº†å¥½äº› Xen æ¼æ´æ˜¯åªå½±å“ PV guest çš„ï¼Œå› ä¸ºå½“å¤„ç† HVM guest æ—¶ï¼Œä»£ç ä¸­çš„é‚£äº›é—®é¢˜ä¸æ˜¯å¿…é¡»çš„ï¼Œæˆ‘åšä¿¡è¿™ä¸ª bug ä¸æ˜¯å…¶ä¸­çš„ä¸€ä¸ªã€‚å¯¹äº PV guest æ¥è¯´è®¿é—® guest è™šæ‹Ÿå†…å­˜æ¯” HVM guest æ›´ç›´æ¥ï¼šå¯¹äº PVguestï¼Œraw_copy_from_guest è°ƒç”¨ copy_from_user() ï¼Œåªæ˜¯ç®€å•çš„åšäº†ä¸€æ¬¡è¾¹ç•Œåˆ¤æ–­ï¼Œä¹‹åä¾¿æ˜¯æœ‰å†…å­˜é¡µ fixup çš„ä¸€ä¸ªmemcpyï¼Œå’Œæ­£å¸¸æ“ä½œç³»ç»Ÿæ‰§è¡Œç”¨æˆ·æ€ç©ºé—´å†…å­˜æ£€æŸ¥ä¸€è‡´ã€‚å¯¹äº HVM guestï¼Œ raw_copy_from_guest() è°ƒç”¨ copy_from_user_hvm() ï¼Œä¼šåšä¸€ä¸ªéå† guest é¡µè¡¨çš„page-wise çš„æ‹·è´ï¼ˆå› ä¸ºå†…å­˜åŒºåŸŸå¯èƒ½ç‰©ç†ä¸Šæ˜¯ä¸è¿ç»­çš„ï¼ŒåŒæ—¶ hypervisor å¹¶æ²¡æœ‰ä¸€ä¸ªè¿ç»­çš„è™šæ‹Ÿæ˜ å°„ï¼‰ï¼ŒåŒæ—¶ guest frame æŸ¥æ‰¾æ˜¯å¯¹æ¯ä¸€ä¸ªé¡µçš„ï¼ŒåŒ…æ‹¬å¼•ç”¨ï¼Œæ˜ å°„ guesté¡µåˆ° hypervisor å†…å­˜å’Œæ¯”å¦‚é˜»æ­¢ HVM guest å†™åªè¯»é¡µçš„å„ç§æ£€æŸ¥ç­‰ã€‚æ•…å¯¹äº HVMï¼Œå¤„ç† guest memory çš„å¤æ‚æ€§è¦é«˜äº PVã€‚</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">å¯¹äºå®‰å…¨ç ”ç©¶å‘˜æ¥è¯´ï¼Œæˆ‘è®¤ä¸ºäº†è§£æ­£å¸¸å†…æ ¸è°ƒç”¨åæ¥ç†è§£åŠè™šæ‹ŸåŒ–ä¸æ˜¯å¾ˆéš¾ã€‚å¦‚æœä½ å®¡è®¡è¿‡å†…æ ¸ä»£ç ï¼Œå…¶å® hypercall entry(lstar_enter and int80_direct_trap in xen/arch/x86/x86_64/entry.S) ï¼ŒåŸºæœ¬çš„ hypercall(for x86 PV: listed in the pv_hypercall_table in xen/arch/x86/pv/hypercall.c) è®¾è®¡å¤„ç†å’Œæ­£å¸¸çš„<br>ç³»ç»Ÿè°ƒç”¨çœ‹èµ·æ¥å·®ä¸å¤šã€‚<br><br></span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="color: rgb(136, 136, 136);"><span style="font-size: 15px;">æœ¬æ–‡ç”± çœ‹é›ªç¿»è¯‘å°ç»„ ghostway ç¼–è¯‘ï¼Œæ¥æº</span><span style="font-family: arial; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; text-align: start; text-indent: 0px; text-transform: none; white-space: pre-wrap; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none; font-size: 15px; color: rgb(136, 136, 136);">Jann Horn, Project Zero</span><br></span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="color: rgb(136, 136, 136);"></span></p><p style="text-align: center;"><span style="line-height: 28px; color: rgb(255, 76, 65); font-size: 15px; background-color: rgb(255, 255, 255);">æˆ³ğŸ‘‡ å›¾ç‰‡åŠ å…¥çœ‹é›ªç¿»è¯‘<span style="color: rgb(255, 76, 65); font-size: 15px; line-height: 28px; text-align: center; background-color: rgb(255, 255, 255);">å°ç»„</span>å“¦ï¼</span></p><p style="text-align: center;"><span style="color: rgb(136, 136, 136); font-size: 14px; line-height: 28px; background-color: rgb(255, 255, 255);"></span></p><p style="text-align: center;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458280357&amp;idx=2&amp;sn=9a41f0328e6f5853340dd6e605353616&amp;chksm=b181512f86f6d839e20a9af0da2542ce2daa898161a5fbbb9f7fdeb9d82753caa881d0190002&amp;scene=21#wechat_redirect" target="_blank"><img src="/ikanxue/images/99f5d62e1f36b46338e6b298f23b2419d2081d0b.png" style="visibility: visible !important; width: 411px !important; height: 201px !important;"></a></p><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">å¾€æœŸçƒ­é—¨å†…å®¹æ¨è</strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul style="list-style-type: circle;" class="list-paddingleft-2"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">ç­‰ä½ æ¥æŒ‘æˆ˜ï¼| çœ‹é›ª CTF 2017 æ”»å‡»ç¯‡</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">ã€ç»ˆäºç­‰åˆ°ä½ ï¼ã€‘çœ‹é›ª CTF 2017</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=1&amp;sn=7ed476d577172ff4b4a93807dae2667c&amp;chksm=b1815a4586f6d35373f6c5d783fa99a7bb7cf2fc35da914761a9cf2d9943a09c1aefb9febfbf&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">æ˜¥é£åé‡Œï¼Œæˆ‘åœ¨ç­‰ä½ </span></a></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282782&amp;idx=2&amp;sn=da69736b13ced5d06f89dd966b208105&amp;chksm=b1815b9486f6d282d284bdc39a63806d5802dc130382888699f624ca1c5565b296906d0e0575&amp;scene=21#wechat_redirect" target="_blank">Headless Chromeå…¥é—¨</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282766&amp;idx=1&amp;sn=085e5cf9a00e31ddc0ff43c858b3cb5b&amp;chksm=b1815b8486f6d29245021ddf2adb665c85c8709e1c4aeafb54fbf99d3a6db24c7c527e961638&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">ä½¿ç”¨æœ€æ–°çš„ä»£ç é‡ç”¨æ”»å‡»ç»•è¿‡æ‰§è¡Œæµä¿æŠ¤ï¼ˆä¸€ï¼‰</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282758&amp;idx=2&amp;sn=68099a77861c39f15d5646551a08a9cd&amp;chksm=b1815b8c86f6d29ab49792fb843073e16ca35c48656e26209f37baa4b11cbbe3efd5980576c4&amp;scene=21#wechat_redirect" target="_blank">èœé¸Ÿè°ƒè¯•ç»å…¸è€æ¸¸æˆä¹‹å¯Œç”²å¤©ä¸‹3</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">æ›´å¤šä¼˜ç§€æ–‡ç« ï¼Œé•¿æŒ‰ä¸‹æ–¹äºŒç»´ç ï¼Œâ€œ<span style="max-width: 100%; color: rgb(0, 122, 170);">å…³æ³¨çœ‹é›ªå­¦é™¢å…¬ä¼—å·</span>â€æŸ¥çœ‹ï¼</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p><img src="/ikanxue/images/ec0991a2106a71402e2ef66768cefbfc74037025.jpeg" style="width: 770px !important; height: 513.013px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">çœ‹é›ªè®ºå›ï¼šhttp://bbs.pediy.com/<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">å¾®ä¿¡å…¬ä¼—å· IDï¼šikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">å¾®åšï¼šçœ‹é›ªå®‰å…¨</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">æŠ•ç¨¿ã€åˆä½œï¼šwww.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6WbLQqVN9R81LxiMolMYb5HxJb7Or3u0svWfQJ8Rx1zLdXImq0REGvjHGIF0REVvg7Lowd03Bv-nwy88bR4sghM=">å¾®ä¿¡åœ°å€</a> | <a href="http://bbs.pediy.com/thread-217527.htm">é˜…è¯»åŸæ–‡</a>
{% endraw  %}

