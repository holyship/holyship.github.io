---
title: PoS 端恶意软件LockPos采用一种新注入技术逃避杀软检测
author: knowit
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1515984875&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siPPs-NRfvlwjuvH7xFTtLmsOPyUEuRfepE4lmADgDB-KqTGJpoTQDDroKcwkYhW3KXzQAJ7vp-FelDokblJ4A9gXLfzKennH5HxpYQ2jGF56FEow*GNjpb1Ip-AOXRIdbPJsCac8BjYhdIsaaWjxbvs=
date: '2018-01-12 00:00:00 +0000'

---

{% raw  %}
<p style="max-width: 100%;min-height: 1em;text-align: center;box-sizing: border-box !important;overflow-wrap: break-word !important;margin-left: 8px;margin-right: 8px;"><img src="https://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8FoAVvkRfcoHPbd54Uawv7JXzAaBR8bGFELuHKGfy3sY6Ih9FK8KIgB0ksHjuM8Qk4RDpNicR6RauQ/0?wx_fmt=jpeg" style="color: rgb(11, 21, 29); visibility: visible !important; width: 542px !important; height: 283.77px !important;"></p><section class="" style="padding: 10px;max-width: 100%;box-sizing: border-box;display: inline-block;width: 670px;vertical-align: top;background-color: rgb(246, 246, 246);overflow-wrap: break-word !important;"><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;letter-spacing: 2px;color: rgb(79, 79, 79);"></span></p><h2 style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">Cyberbit的安全研究人员在一款名为LockPoS的恶意软件中发现了一种新型恶意软件注入技术。LockPoS是Flokibot恶意软件的一个变种。</span><br></h2><p><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">销售终端（PoS）恶意软件是一种恶意的应用程序，它从连接到信用卡设备的计算机内存中窃取信用卡数据。 <br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">一旦系统被感染， LockPoS恶意软件就会试图去获得访问权限并读取当前正在使用进程的内存，并开始搜索信用卡信息数据，搜索到之后将这些数据发送到其命令和控制服务器（C&amp;C）。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">Flokibot 僵尸网络也被用来传播LockPoS，并且它们的源代码有一些相似之处。需要注意到的是，此恶意软件有一些用来解压缩（unpack）和解密不同的技术和例程的行为（stage）来调用与Flokibot的注入相关的API。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">CyberBit发现的PoS恶意软件有三个主要的API用于远程注入：<span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: normal;">NtCreateSection，NtMapViewOfSection和NtCreateThreadEx</span>。 注入技术中使用了Windows系统原生的核心dll文件ntdll.dll。 <br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"><br></span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">与ntdll相关的（前缀为“NT”）Windows API被使用来分离用户空间和内核空间。 注入技术涉及使用NtCreateSection在内核中创建一个段对象（section object），然后调用NtMapViewOfSection来把其他进程中的段转化成一个映射来查看其他进程中的段内存，然后将代码复制到自己的某个段中，最后使用NtCreateThreadEx或CreateRemoteThread API创建一个远程线程来执行这些段中的代码。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">一旦来自ntdll的例程被调用，系统调用编号的十六进制值就会被复制到EAX寄存器中，这是一条指令使线程跳转到内核模式。 然后内核根据EAX寄存器的值来执行相关例程，用户栈中的参数将会被复制到内核栈中并继续执行。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">恶意软件不会调用ntdll中的API来注入代码，以避免反病毒软件的检测。而是将磁盘上ntdll的相关API函数代码映射到自己的虚拟地址空间。通过这样做，恶意软件会保留一个干净的dll副本，而防病毒软件不会检测到这个副本。</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">而且，Cyberbit的研究人员注意到，恶意软件为explorer.exe进程调用NtMapViewOfSection函数</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">分析总结道，“LockPoS恶意软件使用到的注入技术涉及使用NtCreateSection在内核中创建一个段对象（section object），调用NtMapViewOfSection将该段的代码映射到另一个进程，将代码复制到该段并使用NtCreateThreadEx或CreateRemoteThread 创建一个远程线程来执行映射的代码。 ”</span></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">&nbsp;</span></p><p style="text-align: center;"><img src="http://mmbiz.qpic.cn/mmbiz_png/1UG7KPNHN8FoAVvkRfcoHPbd54Uawv7JaqiauVB0Rlb18HeBeLdicoWAibIUZItlDiahEwR75Y8V6TQlxw8QI0n5zg/0?wx_fmt=png" style="width: 650px !important; height: 606.846px !important;"></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;"></span><br></p><p style="margin-left: 8px;margin-right: 8px;"><span style="font-size: 15px;color: rgb(79, 79, 79);letter-spacing: 2px;">安全研究人员报告还指出，由于Windows 10内核函数调用无法被监控，所以改进内存分析可能是唯一有效的检测方法。</span></p><p><br></p><p><br></p><section class="" style="max-width: 100%;letter-spacing: 2px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section class="" style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><section class="" style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;box-sizing: border-box;min-height: 1em;background-color: rgba(1, 0, 0, 0);text-align: justify;overflow-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);box-sizing: border-box !important;overflow-wrap: break-word !important;">来源：securityaffairs</span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;box-sizing: border-box;min-height: 1em;background-color: rgba(1, 0, 0, 0);text-align: justify;overflow-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);box-sizing: border-box !important;overflow-wrap: break-word !important;">本文由看雪翻译小组 knowit 编译<br></span></p></section></section></section></section><p><br></p><p><br></p><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;letter-spacing: 2px;line-height: 1.5em;text-align: justify;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">往期热门内容推荐</strong></span></p><ul class=" list-paddingleft-2" style=""><li><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;letter-spacing: 2px;line-height: 1.5em;text-align: justify;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287274&amp;idx=4&amp;sn=9f497d3365eb08deed563891d86853d6&amp;chksm=b1814c2086f6c5369fbd9a11002ca526258f0641808179ed27e83c2d8d23a6261e5bbb000fe1&amp;scene=21#wechat_redirect" target="_blank">看雪学院招募看雪讲师</a></span></p></li><li><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;letter-spacing: 2px;line-height: 1.5em;text-align: justify;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287480&amp;idx=3&amp;sn=69e3f150bb5be7d53515f3c16e2c4a51&amp;chksm=b1814df286f6c4e4e12ffbfab58621c270f58e53816a0ee4e8f426a42e70d2d37ee010b99de8&amp;scene=21#wechat_redirect" target="_blank">“幽灵超距作用”测试获突破，量子通讯安全问题有望解决</a></span></p></li><li><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;letter-spacing: 2px;line-height: 1.5em;text-align: justify;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287468&amp;idx=3&amp;sn=a8c8ddd1b984f5285e1e619b0d30472d&amp;chksm=b1814de686f6c4f0fcb655da294d3fc7feeb7412b40f045db2cee4b6939255d5216a061071e1&amp;scene=21#wechat_redirect" target="_blank">AMD 彻底躺枪：微软 KB4056892 补丁或导致系统变砖</a></span></p></li><li><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;letter-spacing: 2px;line-height: 1.5em;text-align: justify;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(63, 63, 63);font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458287480&amp;idx=2&amp;sn=c7c7e65ce44969372a5cd5c132af8965&amp;chksm=b1814df286f6c4e49941b3b7a06ab5d065230e5a43b31d79d832dace9ac02066c7da1afc7d38&amp;scene=21#wechat_redirect" target="_blank">苹果新版macOS又出漏洞：任意密码可解锁App Store设置</a></span></p></li></ul><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;letter-spacing: 2px;line-height: 1.5em;text-align: justify;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);box-sizing: border-box !important;overflow-wrap: break-word !important;"></span></p><p style="margin: 15px 8px;max-width: 100%;min-height: 1em;text-align: justify;letter-spacing: 2px;line-height: 1.5em;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">更多安全资讯，戳左下角“阅读原文”查看！<br style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></strong></span></p><p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;text-align: center;letter-spacing: 2px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;color: rgb(63, 63, 63);letter-spacing: 1px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"></strong></span><img src="https://mmbiz.qpic.cn/mmbiz_jpg/1UG7KPNHN8HTpGlibXdQ4YIynJnSjWwOjSroH8JkP00Cpl0TvGwSCibJpPmSmcartSbQUfodq49ulaLk1Yicrem3A/?wx_fmt=jpeg" style="box-sizing: border-box !important; overflow-wrap: break-word !important; visibility: visible !important; width: 754px !important; height: 189.285px !important;"></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1515984875&src=3&ver=1&signature=yyLj*6br2FUtW3BtBE3siPPs-NRfvlwjuvH7xFTtLmsOPyUEuRfepE4lmADgDB-KqTGJpoTQDDroKcwkYhW3KXzQAJ7vp-FelDokblJ4A9gXLfzKennH5HxpYQ2jGF56FEow*GNjpb1Ip-AOXRIdbPJsCac8BjYhdIsaaWjxbvs=">微信地址</a> | <a href="https://bbs.pediy.com/thread-224028.htm">阅读原文</a>
{% endraw  %}

