---
title: Windows 平台下的最优化 Shellcode 代码编写指引
author: 木无聊偶
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6dv4SfwDR7VaHSGUIUzrphdlD5ct*0DKJsfWnUATla-hbww4NCTxQ10ZFHyYMPPfKT9*Cvqyu6FspJQs*9r*Rv8=
date: '2017-05-10 00:00:00 +0000'

---

{% raw  %}
<p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);">前言</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在构造一个 Shellcode 载荷时总是存在多种方法，特别是对于 Windows 平台来说。需要手工编写所有的汇编代码，或者说编译器能够有所帮助吗？需要直接使用syscall，还是需要在内存中搜索函数？因为构造载荷一般来说不会很简单，所以我决定写一篇文章来专门论述相关问题。我习惯于用 C 语言来完成所有的工作，并使用 Visual
 Studio 来对其进行编译：因为 C 语言的源代码更加优美，编译器能够更好地对其进行优化，并且如果需要的话可以使用 LLVM 框架实现自己的混淆器。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在本例中，我将针对于 x86 架构下的 Shellcode 代码；当然，相关的分析完全可以应用于 x86（64位）架构下的 Shellcode 代码或者别的处理器。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 18px; color: rgb(129, 39, 145);"><strong>寻找基本DLL</strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 18px; color: rgb(129, 39, 145);"><strong><br></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 16px;"><strong>简介</strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">当一个 Shellcode 载荷加载到 Windows 系统中的时候，第一步就是要定位需要使用的函数，即搜索存储函数的动态链接库（DLL）。为此，我们需要用到以下各小节所描述的不同的结构。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145);"><strong><span style="font-size: 15px;">线程环境块</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Windows 系统使用TEB结构来描述一个线程，每个线程通过使用 FS（x86平台）或GS（x86,64 位平台）寄存器来访问其自身的 TEB 结构。TEB结构具体如下：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><img src="/ikanxue/images/a6468f0494b4ff0dedf48a6fb7f20b07e13e07f8.png" style="width: 570px !important; height: 374px !important;"></p><p><span style="font-size: 15px;">因此，若想要访问 PEB 结构，只需要进行如下操作：</span></p><p><span style="font-size: 15px;"><br></span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">PEB*&nbsp;getPeb()&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;__asm&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,&nbsp;fs:[0x30];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><strong><span style="font-size: 15px; color: rgb(129, 39, 145);">进程环境块</span></strong></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果说 TEB 结构给出了一个线程的相关信息，那么 PEB 结构将告诉我们关于进程自身的信息，其中我们所需要的信息是基本 DLL 的位置。实际上，在 Windows 系统加载一个进程到内存中的时候，至少要映射两个 DLL：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ntdll.dll，其中包含执行 syscall 的函数，它们都以前缀 Nt 开头（形如Nt*），并调用内核中以Zw开头（形如Zw*）名称相同的函数；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">kernel32.dll，在更高层次上使用 NTDLL 中的函数。比如，kernel32!CreateFileA 函数将调用 ntdll!NtCreateFileW 函数，而后者又将调用 ntoskrnl!ZwCreateFileW 函数。</span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">在不同版本的 Windows 系统下，其他的 DLL 可能已经存在于内存中，但是是完全可移植的；因此，我们假设以上两个 DLL 是唯一加载的 DLL 模块。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">让我们看一下 PEB 结构，如下所示：</span></p><p><img src="/ikanxue/images/d440a95c749713adc9430302b24894dac8165e0b.png" style="width: 386px !important; height: 343px !important;"></p><p><span style="font-size: 15px;"><br></span></p><p><span style="font-size: 15px;">可以看到，其中一个成员名为 PEB.BeingDebugged，可被 IsDebuggerPresent() 函数使用；而我们感兴趣的部分是成员 PEB.Ldr，其对应于如下结构：</span></p><p><span style="font-size: 15px;"><br></span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">0:000&gt;&nbsp;dt&nbsp;nt!_PEB_LDR_DATA</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x000&nbsp;Length&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x004&nbsp;Initialized&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;UChar</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x008&nbsp;SsHandle&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Ptr32&nbsp;Void</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x00c&nbsp;InLoadOrderModuleList&nbsp;:&nbsp;_LIST_ENTRY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x014&nbsp;InMemoryOrderModuleList&nbsp;:&nbsp;_LIST_ENTRY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x01c&nbsp;InInitializationOrderModuleList&nbsp;:&nbsp;_LIST_ENTRY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x024&nbsp;EntryInProgress&nbsp;&nbsp;:&nbsp;Ptr32&nbsp;Void</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x028&nbsp;ShutdownInProgress&nbsp;:&nbsp;UChar</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x02c&nbsp;ShutdownThreadId&nbsp;:&nbsp;Ptr32&nbsp;Void</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">顾名思义，成员 PEB.Ldr-&gt;In*OrderModuleList 是包含所有已加载到内存中的 DLL 模块的链表（LIST_ENTRY）；三个表以不同的顺序指向相同的对象。我更倾向于使用InLoadOrderModuleList，因为可以像使用一个指向 _LDR_DATA_TABLE_ENTRY 的指针一样直接使用 InLoadOrderModuleList.Flink。例如，如果使用InMemoryOrderModuleList，由于 InMemoryOrderModuleList.Flink 指针指向下一个InMemoryOrderModuleList，所以LDR_DATA_TABLE_ENTRY 将位于（_InMemoryOrderModuleList.Flink–0x10）的位置。每个链表成员具有如下结构：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">0:000&gt;&nbsp;dt&nbsp;nt!_LDR_DATA_TABLE_ENTRY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x000&nbsp;InLoadOrderLinks&nbsp;:&nbsp;_LIST_ENTRY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x008&nbsp;InMemoryOrderLinks&nbsp;:&nbsp;_LIST_ENTRY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x010&nbsp;InInitializationOrderLinks&nbsp;:&nbsp;_LIST_ENTRY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x018&nbsp;DllBase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Ptr32&nbsp;Void</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x01c&nbsp;EntryPoint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Ptr32&nbsp;Void</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x020&nbsp;SizeOfImage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x024&nbsp;FullDllName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_UNICODE_STRING</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x02c&nbsp;BaseDllName&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_UNICODE_STRING</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;...</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x0a0&nbsp;DependentLoadFlags&nbsp;:&nbsp;Uint4B</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">BaseDllName 包含 DLL 模块的名称（比如，ntdll.dll），而 DllBase 包含 DLL 模块所加载到内存中的地址。通常，InLoadOrderModuleList 中的第一个成员就是可执行程序自身，在之后我们能够找到 NTDLL 和 KERNEL32；然而，我们并不确定在所有版本的 Windows 系统中都是这个次序，所以最好根据 DLL 名称（大写/小写）进行搜索。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145);"><strong><span style="font-size: 15px;">DJB散列</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如前所述，我们并不信任 DLL 顺序而选择根据 DLL 名称进行搜索。然而在一段 Shellcode 代码中，使用 ASCII 字符串（或更糟的，UNICODE 字符串）并不是一个好主意：这将使得我们的 Shellcode 代码过于臃肿！因此我建议，使用散列机制来比较 DLL 名称。由于其简洁有效性我选择使用DJB散列算法，具体代码如下所示：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">DWORD&nbsp;djbHashW(wchar_t*&nbsp;str)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;hash&nbsp;=&nbsp;5381;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;i&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;str[i]&nbsp;!=&nbsp;0;&nbsp;i++)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hash&nbsp;=&nbsp;((hash&nbsp;&lt;&lt;&nbsp;5)&nbsp;+&nbsp;hash)&nbsp;+&nbsp;str[i];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hash;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">由于 DLL 名称可能大写也可能小写，因此在散列算法中最好满足如下等式关系：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">djbHashW(L"ntdll.dll")&nbsp;==&nbsp;djbHashW(L"NTDLL.DLL")</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);">代码</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">现在我们已经讨论了如何完成以上工作，是时候来编码实现我们的想法了。具体代码如下所示：</span></p><p><img src="/ikanxue/images/54e2b5e91b7ea787047b8416c49d085a8f020409.png" style="width: 548px !important; height: 612px !important;"></p><p><img src="/ikanxue/images/b84434c3ffca5599253176afce12574a618b3348.png" style="width: 663px !important; height: 499px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"></span></p><p><img src="/ikanxue/images/69f7a68f2a7cc2a15477cab6c5654f45971c219c.png" style="width: 643px !important; height: 242px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">如果想要使用其他的 DLL 模块，只需要使用 LoadLibrary() 函数来将其加载。不要着急，我们将在 user32.dll 相关的 Shellcode 代码中进行该项工作。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);">函数地址</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 16px;"><strong><span style="color: rgb(129, 39, 145);">简介</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">现在我们已经找到 DLL，下一步需要在 DLL 内存空间中搜寻所需的函数在哪儿。幸运的是，透彻理解 PE 文件头部结构的前提下这并不复杂。要牢记的是，当我们讨论 PE 文件头部时，提到的大部分地址都与可执行程序地址相关。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 16px;"><strong><span style="color: rgb(129, 39, 145);">可移植的执行体头部</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">执行体的开始位置是一个 DOS 头部，但它只是为了兼容（DOS 系统）而存在。具体结构如下所示：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">0:000&gt;&nbsp;dt&nbsp;nt!_IMAGE_DOS_HEADER</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x000&nbsp;e_magic&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x002&nbsp;e_cblp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x004&nbsp;e_cp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x006&nbsp;e_crlc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x008&nbsp;e_cparhdr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x00a&nbsp;e_minalloc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x00c&nbsp;e_maxalloc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x00e&nbsp;e_ss&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x010&nbsp;e_sp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x012&nbsp;e_csum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x014&nbsp;e_ip&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x016&nbsp;e_cs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x018&nbsp;e_lfarlc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x01a&nbsp;e_ovno&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x01c&nbsp;e_res&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;[4]&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x024&nbsp;e_oemid&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x026&nbsp;e_oeminfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x028&nbsp;e_res2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;[10]&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x03c&nbsp;e_lfanew&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Int4B</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">成员 e_lfanew 将指示 NT 头部的位置。由于这是一个相对地址，所以需要进行 pFile+e_lfanew 操作。NT 头部具体结构如下所示：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">0:000&gt;&nbsp;dt&nbsp;-r1&nbsp;nt!_IMAGE_NT_HEADERS</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x000&nbsp;Signature&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x004&nbsp;FileHeader&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_IMAGE_FILE_HEADER</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x000&nbsp;Machine&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x002&nbsp;NumberOfSections&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x004&nbsp;TimeDateStamp&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x008&nbsp;PointerToSymbolTable&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x00c&nbsp;NumberOfSymbols&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x010&nbsp;SizeOfOptionalHeader&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x012&nbsp;Characteristics&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x018&nbsp;OptionalHeader&nbsp;&nbsp;&nbsp;:&nbsp;_IMAGE_OPTIONAL_HEADER</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x000&nbsp;Magic&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x002&nbsp;MajorLinkerVersion&nbsp;:&nbsp;UChar</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x003&nbsp;MinorLinkerVersion&nbsp;:&nbsp;UChar</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x004&nbsp;SizeOfCode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x008&nbsp;SizeOfInitializedData&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x00c&nbsp;SizeOfUninitializedData&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x010&nbsp;AddressOfEntryPoint&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x014&nbsp;BaseOfCode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x018&nbsp;BaseOfData&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x01c&nbsp;ImageBase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x020&nbsp;SectionAlignment&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x024&nbsp;FileAlignment&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x028&nbsp;MajorOperatingSystemVersion&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x02a&nbsp;MinorOperatingSystemVersion&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x02c&nbsp;MajorImageVersion&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x02e&nbsp;MinorImageVersion&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x030&nbsp;MajorSubsystemVersion&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x032&nbsp;MinorSubsystemVersion&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x034&nbsp;Win32VersionValue&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x038&nbsp;SizeOfImage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x03c&nbsp;SizeOfHeaders&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x040&nbsp;CheckSum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x044&nbsp;Subsystem&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x046&nbsp;DllCharacteristics&nbsp;:&nbsp;Uint2B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x048&nbsp;SizeOfStackReserve&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x04c&nbsp;SizeOfStackCommit&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x050&nbsp;SizeOfHeapReserve&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x054&nbsp;SizeOfHeapCommit&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x058&nbsp;LoaderFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x05c&nbsp;NumberOfRvaAndSizes&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+0x060&nbsp;DataDirectory&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;[16]&nbsp;_IMAGE_DATA_DIRECTORY</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">数据目录中包含了一些有趣成员的地址；而对我们来说，它包含了所有导出函数的地址。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">0:000&gt;&nbsp;dt&nbsp;nt!_IMAGE_DATA_DIRECTORY</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x000&nbsp;VirtualAddress&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;+0x004&nbsp;Size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Uint4B</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"> 因此，我们可以使用DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress 来直接获取导出目录的地址：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">typedef&nbsp;struct&nbsp;_IMAGE_EXPORT_DIRECTORY&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Characteristics;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;TimeDateStamp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;MajorVersion;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;MinorVersion;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Name;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Base;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;NumberOfFunctions;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;NumberOfNames;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;AddressOfFunctions;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;AddressOfNames;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;AddressOfNameOrdinals;&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}&nbsp;IMAGE_EXPORT_DIRECTORY,&nbsp;*PIMAGE_EXPORT_DIRECTORY;</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">可以通过名字或者通过序号来导出一个函数；因此，以下三个数组保持更新：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">AddressOfFunctions，按照序号顺序依次保存函数的地址；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">AddressOfNames，保存函数名称；</span></p></li><li><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">AddressOfNameOrdinals，保存序号，该数组与AddressOfNames数组次序相同。</span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">因此，如果想要根据名称来查找函数地址，我们需要浏览 AddressOfNames 数组中的所有名称，并将数组索引用于 AddressOfNameOrdinals[index]；而这将返回一个序号用于 AddressOfFunctions[ordinal]。整个过程的伪代码如下所示：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">int&nbsp;i&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">while&nbsp;(AddressOfNames[i]&nbsp;!=&nbsp;searchedName)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;i++;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">return&nbsp;AddressOfFunctions[&nbsp;AddressOfNamesOrdinals[i]&nbsp;];</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 16px;"><strong><span style="color: rgb(129, 39, 145);">代码</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">正如搜索 DLL 时所做的那样，我们将使用 DJB 散列算法（不过这次用 ASCII 字符串）：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">PVOID&nbsp;getFunctionAddr(DWORD&nbsp;dwModule,&nbsp;DWORD&nbsp;functionHash)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DOS_HEADER&nbsp;dosHeader&nbsp;=&nbsp;(PIMAGE_DOS_HEADER)dwModule;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_NT_HEADERS&nbsp;ntHeaders&nbsp;=&nbsp;(PIMAGE_NT_HEADERS)((DWORD)dosHeader&nbsp;+&nbsp;dosHeader-&gt;e_lfanew);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DATA_DIRECTORY&nbsp;dataDirectory&nbsp;=&nbsp;&amp;ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(dataDirectory-&gt;VirtualAddress&nbsp;==&nbsp;0)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_EXPORT_DIRECTORY&nbsp;exportDirectory&nbsp;=&nbsp;(PIMAGE_EXPORT_DIRECTORY)(dwModule&nbsp;+&nbsp;dataDirectory-&gt;VirtualAddress);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PDWORD&nbsp;ardwNames&nbsp;=&nbsp;(PDWORD)(dwModule&nbsp;+&nbsp;exportDirectory-&gt;AddressOfNames);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PWORD&nbsp;arwNameOrdinals&nbsp;=&nbsp;(PWORD)(dwModule&nbsp;+&nbsp;exportDirectory-&gt;AddressOfNameOrdinals);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PDWORD&nbsp;ardwAddressFunctions&nbsp;=&nbsp;(PDWORD)(dwModule&nbsp;+&nbsp;exportDirectory-&gt;AddressOfFunctions);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;szName&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;wOrdinal&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(unsigned&nbsp;int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;exportDirectory-&gt;NumberOfNames;&nbsp;i++)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;szName&nbsp;=&nbsp;(char*)(dwModule&nbsp;+&nbsp;ardwNames[i]);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(djbHash(szName)&nbsp;==&nbsp;functionHash)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wOrdinal&nbsp;=&nbsp;arwNameOrdinals[i];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(PVOID)(dwModule&nbsp;+&nbsp;ardwAddressFunctions[wOrdinal]);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);"><br></span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);">编译</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);"><br></span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 16px;"><strong><span style="color: rgb(129, 39, 145);">最终代码</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我们已经讨论了所用的重要结构和算法，下面看看如何生成 Shellcode 代码。</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">#pragma&nbsp;comment(linker,&nbsp;"/ENTRY:main")</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;"makestr.h"</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#include&nbsp;"peb.h"</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">typedef&nbsp;HMODULE&nbsp;(WINAPI*&nbsp;_LoadLibraryA)(LPCSTR&nbsp;lpFileName);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">typedef&nbsp;int&nbsp;(WINAPI*&nbsp;_MessageBoxA)(HWND&nbsp;hWnd,&nbsp;LPCSTR&nbsp;lpText,&nbsp;LPCSTR&nbsp;lpCaption,&nbsp;UINT&nbsp;uType);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">int&nbsp;main();</span></p><p style="line-height: normal;"><span style="font-size: 14px;">DWORD&nbsp;getDllByName(DWORD&nbsp;dllHash);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">PVOID&nbsp;getFunctionAddr(DWORD&nbsp;dwModule,&nbsp;DWORD&nbsp;functionHash);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">DWORD&nbsp;djbHash(char*&nbsp;str);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">DWORD&nbsp;djbHashW(wchar_t*&nbsp;str);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">int&nbsp;main()&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;hashKernel32&nbsp;=&nbsp;0x6DDB9555;&nbsp;//&nbsp;djbHashW(L"KERNEL32.DLL");</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;hKernel32&nbsp;=&nbsp;getDllByName(hashKernel32);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hKernel32&nbsp;==&nbsp;0)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;hashLoadLibraryA&nbsp;=&nbsp;0x5FBFF0FB;&nbsp;//&nbsp;djbHash("LoadLibraryA");</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;_LoadLibraryA&nbsp;xLoadLibraryA&nbsp;=&nbsp;getFunctionAddr(hKernel32,&nbsp;hashLoadLibraryA);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(xLoadLibraryA&nbsp;==&nbsp;NULL)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;szUser32[]&nbsp;=&nbsp;MAKESTR("user32.dll",&nbsp;10);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;hUser32&nbsp;=&nbsp;xLoadLibraryA(szUser32);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(hUser32&nbsp;==&nbsp;0)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;hashMessageBoxA&nbsp;=&nbsp;0x384F14B4;&nbsp;//&nbsp;djbHash("MessageBoxA");</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;_MessageBoxA&nbsp;xMessageBoxA&nbsp;=&nbsp;getFunctionAddr(hUser32,&nbsp;hashMessageBoxA);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(xMessageBoxA&nbsp;==&nbsp;NULL)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;szMessage[]&nbsp;=&nbsp;MAKESTR("Hello&nbsp;World",&nbsp;11);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;szTitle[]&nbsp;=&nbsp;MAKESTR(":)",&nbsp;2);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;xMessageBoxA(0,&nbsp;szMessage,&nbsp;szTitle,&nbsp;MB_OK|MB_ICONINFORMATION);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">inline&nbsp;PEB*&nbsp;getPeb()&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;__asm&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,&nbsp;fs:[0x30];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">DWORD&nbsp;djbHash(char*&nbsp;str)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;hash&nbsp;=&nbsp;5381;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;i&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;str[i]&nbsp;!=&nbsp;0;&nbsp;i++)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hash&nbsp;=&nbsp;((hash&nbsp;&lt;&lt;&nbsp;5)&nbsp;+&nbsp;hash)&nbsp;+&nbsp;str[i];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hash;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">DWORD&nbsp;djbHashW(wchar_t*&nbsp;str)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;hash&nbsp;=&nbsp;5381;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;i&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;str[i]&nbsp;!=&nbsp;0;&nbsp;i++)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hash&nbsp;=&nbsp;((hash&nbsp;&lt;&lt;&nbsp;5)&nbsp;+&nbsp;hash)&nbsp;+&nbsp;str[i];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hash;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">DWORD&nbsp;getDllByName(DWORD&nbsp;dllHash)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PEB*&nbsp;peb&nbsp;=&nbsp;getPeb();</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PPEB_LDR_DATA&nbsp;Ldr&nbsp;=&nbsp;peb-&gt;Ldr;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PLDR_DATA_TABLE_ENTRY&nbsp;moduleList&nbsp;=&nbsp;(PLDR_DATA_TABLE_ENTRY)Ldr-&gt;InLoadOrderModuleList.Flink;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;wchar_t*&nbsp;pBaseDllName&nbsp;=&nbsp;moduleList-&gt;BaseDllName.Buffer;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;wchar_t*&nbsp;pFirstDllName&nbsp;=&nbsp;moduleList-&gt;BaseDllName.Buffer;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;do&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pBaseDllName&nbsp;!=&nbsp;NULL)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(djbHashW(pBaseDllName)&nbsp;==&nbsp;dllHash)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(DWORD)moduleList-&gt;BaseAddress;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;moduleList&nbsp;=&nbsp;(PLDR_DATA_TABLE_ENTRY)moduleList-&gt;InLoadOrderModuleList.Flink;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pBaseDllName&nbsp;=&nbsp;moduleList-&gt;BaseDllName.Buffer;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;while&nbsp;(pBaseDllName&nbsp;!=&nbsp;pFirstDllName);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">PVOID&nbsp;getFunctionAddr(DWORD&nbsp;dwModule,&nbsp;DWORD&nbsp;functionHash)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DOS_HEADER&nbsp;dosHeader&nbsp;=&nbsp;(PIMAGE_DOS_HEADER)dwModule;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_NT_HEADERS&nbsp;ntHeaders&nbsp;=&nbsp;(PIMAGE_NT_HEADERS)((DWORD)dosHeader&nbsp;+&nbsp;dosHeader-&gt;e_lfanew);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_DATA_DIRECTORY&nbsp;dataDirectory&nbsp;=&nbsp;&amp;ntHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(dataDirectory-&gt;VirtualAddress&nbsp;==&nbsp;0)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PIMAGE_EXPORT_DIRECTORY&nbsp;exportDirectory&nbsp;=&nbsp;(PIMAGE_EXPORT_DIRECTORY)(dwModule&nbsp;+&nbsp;dataDirectory-&gt;VirtualAddress);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PDWORD&nbsp;ardwNames&nbsp;=&nbsp;(PDWORD)(dwModule&nbsp;+&nbsp;exportDirectory-&gt;AddressOfNames);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PWORD&nbsp;arwNameOrdinals&nbsp;=&nbsp;(PWORD)(dwModule&nbsp;+&nbsp;exportDirectory-&gt;AddressOfNameOrdinals);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;PDWORD&nbsp;ardwAddressFunctions&nbsp;=&nbsp;(PDWORD)(dwModule&nbsp;+&nbsp;exportDirectory-&gt;AddressOfFunctions);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;szName&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;wOrdinal&nbsp;=&nbsp;0;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(unsigned&nbsp;int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;exportDirectory-&gt;NumberOfNames;&nbsp;i++)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;szName&nbsp;=&nbsp;(char*)(dwModule&nbsp;+&nbsp;ardwNames[i]);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(djbHash(szName)&nbsp;==&nbsp;functionHash)&nbsp;{</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wOrdinal&nbsp;=&nbsp;arwNameOrdinals[i];</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(PVOID)(dwModule&nbsp;+&nbsp;ardwAddressFunctions[wOrdinal]);</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">函数声明的次序非常重要：它将定义编译次序。因此，如果我们想要直接调用Shellcode 代码，最好首先声明我们的main函数，因为它将是入口点。我不知道这是Visual Studio 的特性，还是所有的编译器都这样处理。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">ASCII 字符串使用宏定义 MAKESTR 像数组一样来声明字符串，该宏将字符串强制按照如下格式进行分配：</span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">mov&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp+szUser32],&nbsp;&nbsp;&nbsp;72657375h&nbsp;&nbsp;&nbsp;;&nbsp;user</span></p><p style="line-height: normal;"><span style="font-size: 14px;">mov&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp+szUser32+4],&nbsp;642E3233h&nbsp;&nbsp;&nbsp;;&nbsp;32.d</span></p><p style="line-height: normal;"><span style="font-size: 14px;">mov&nbsp;&nbsp;word&nbsp;ptr&nbsp;[ebp+szUser32+8],&nbsp;&nbsp;6C6Ch&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;ll</span></p><p style="line-height: normal;"><span style="font-size: 14px;">mov&nbsp;&nbsp;[ebp+szUser32+0Ah],&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;'\x00'</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">以上代码由 Python 脚本生成，因为它是冗余的：<br></span></p><blockquote><p style="line-height: normal;"><span style="font-size: 14px;">#pragma&nbsp;once</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR(s,&nbsp;length)&nbsp;MAKESTR_##length(s)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">/*</span></p><p style="line-height: normal;"><span style="font-size: 14px;">for&nbsp;i&nbsp;in&nbsp;range(1,51):</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;"#define&nbsp;MAKESTR_%d(s)&nbsp;{"&nbsp;%&nbsp;i</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;j&nbsp;in&nbsp;range(i):</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;+=&nbsp;"s[%d],"&nbsp;%&nbsp;j</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;s&nbsp;+=&nbsp;"0}"</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;print(s)</span></p><p style="line-height: normal;"><span style="font-size: 14px;">*/</span></p><p style="line-height: normal;"><span style="font-size: 14px;">&nbsp;&nbsp;</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_1(s)&nbsp;{s[0],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_2(s)&nbsp;{s[0],s[1],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_3(s)&nbsp;{s[0],s[1],s[2],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_4(s)&nbsp;{s[0],s[1],s[2],s[3],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_5(s)&nbsp;{s[0],s[1],s[2],s[3],s[4],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_6(s)&nbsp;{s[0],s[1],s[2],s[3],s[4],s[5],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_7(s)&nbsp;{s[0],s[1],s[2],s[3],s[4],s[5],s[6],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_8(s)&nbsp;{s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_9(s)&nbsp;{s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_10(s)&nbsp;{s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9],0}</span></p><p style="line-height: normal;"><span style="font-size: 14px;">#define&nbsp;MAKESTR_11(s)&nbsp;{s[0],s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9],s[10],0}</span></p></blockquote><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);"><br></span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="color: rgb(129, 39, 145); font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);">编译配置</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">我所用的是 Visual Studio 2017，但我认为在其他版本中选项也是相同的：</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">C&nbsp;/&nbsp;C++</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;Optimisation</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reduce&nbsp;the&nbsp;size&nbsp;/O1</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Smaller&nbsp;code&nbsp;/Os</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;Code&nbsp;generation</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Disable&nbsp;security&nbsp;verifications&nbsp;/GS-</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Linker</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;Entries</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ignore&nbsp;all&nbsp;the&nbsp;defaults&nbsp;libraries&nbsp;/NODEFAULTLIB</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">最终得到一个 3KB 大小的文件；一个简单的反汇编器即可从文件中提取 Shellcode 代码。</span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;"><br></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 18px;"><strong><span style="color: rgb(129, 39, 145);">Shellcode 代码</span></strong></span></p><p style="margin-top: 15px; margin-bottom: 15px; line-height: 1.75em;"><span style="font-size: 15px;">Shellcode 代码有 339 字节大小，但其中最大的部分是函数加载和 DLL 模块搜索。因此，即使对于一个更大的程序，Shellcode 代码也不会增大很多。我们的 Shellcode 代码是非常简单的，因为它仅仅弹出一个消息框，但你可以很容易地将其改造成比如一个下载器之类的程序。</span></p><p><img src="/ikanxue/images/68eef8874800b7610e13b0c810bc54505e2f3cba.png" style="width: 510px !important; height: 507px !important;"></p><p><img src="/ikanxue/images/42ea8697cca6539ac5c8b5f2473cb890b770b847.png" style="width: 727px !important; height: 171px !important;"></p><p><br></p><p><br></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="color: rgb(136, 136, 136);"><span style="font-size: 15px;">本文由 看雪翻译小组 木无聊偶 编译，来源</span>Dimitri Fourny&nbsp; <br></span></p><p style="line-height: 1.75em; margin-top: 15px; margin-bottom: 15px; text-align: center;"><span style="color: rgb(136, 136, 136);"></span></p><p style="text-align: center;"><span style="line-height: 28px; color: rgb(255, 76, 65); font-size: 15px; background-color: rgb(255, 255, 255);">戳👇 图片加入看雪翻译<span style="color: rgb(255, 76, 65); font-size: 15px; line-height: 28px; text-align: center; background-color: rgb(255, 255, 255);">小组</span>哦！</span></p><p style="text-align: center;"><span style="color: rgb(136, 136, 136); font-size: 14px; line-height: 28px; background-color: rgb(255, 255, 255);"></span></p><p style="text-align: center;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458280357&amp;idx=2&amp;sn=9a41f0328e6f5853340dd6e605353616&amp;chksm=b181512f86f6d839e20a9af0da2542ce2daa898161a5fbbb9f7fdeb9d82753caa881d0190002&amp;scene=21#wechat_redirect" target="_blank"><img src="/ikanxue/images/99f5d62e1f36b46338e6b298f23b2419d2081d0b.png" style="visibility: visible !important; width: 411px !important; height: 201px !important;"></a></p><p><br></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(79, 138, 187); box-sizing: border-box !important; overflow-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">往期热门内容推荐</strong></span></p><hr style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p><ul style="list-style-type: circle;" class="list-paddingleft-2"><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282630&amp;idx=1&amp;sn=61fcbc708235dec5d7897a0d7c315756&amp;chksm=b1815a0c86f6d31a50ba1f9a39d876e28f2c71096100b28e961df185f7be94ec77b9199efd51&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">等你来挑战！| 看雪 CTF 2017 攻击篇</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282621&amp;idx=1&amp;sn=15f5bc0fa2b0b34ae241668b23a3939b&amp;chksm=b1815af786f6d3e1fd4bad2c336d725ec600551a6477bbc4c6af93167074ac83873aeba89938&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">【终于等到你！】看雪 CTF 2017</a></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=1&amp;sn=7ed476d577172ff4b4a93807dae2667c&amp;chksm=b1815a4586f6d35373f6c5d783fa99a7bb7cf2fc35da914761a9cf2d9943a09c1aefb9febfbf&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;">春风十里，我在等你</span></a></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important; font-size: 15px;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282782&amp;idx=2&amp;sn=da69736b13ced5d06f89dd966b208105&amp;chksm=b1815b9486f6d282d284bdc39a63806d5802dc130382888699f624ca1c5565b296906d0e0575&amp;scene=21#wechat_redirect" target="_blank">Headless Chrome入门</a><br></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282703&amp;idx=3&amp;sn=bfa728ff73cd389cd9258ca32008c6e2&amp;chksm=b1815a4586f6d353468f3adf9545aab3ffdce4f4c3e0e47c967298eca045db0558e37865c3a7&amp;scene=21#wechat_redirect" target="_blank" style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></a><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282766&amp;idx=1&amp;sn=085e5cf9a00e31ddc0ff43c858b3cb5b&amp;chksm=b1815b8486f6d29245021ddf2adb665c85c8709e1c4aeafb54fbf99d3a6db24c7c527e961638&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: none;"><span style="font-size: 15px;">使用最新的代码重用攻击绕过执行流保护（一）</span></a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&amp;mid=2458282758&amp;idx=2&amp;sn=68099a77861c39f15d5646551a08a9cd&amp;chksm=b1815b8c86f6d29ab49792fb843073e16ca35c48656e26209f37baa4b11cbbe3efd5980576c4&amp;scene=21#wechat_redirect" target="_blank">菜鸟调试经典老游戏之富甲天下3</a><br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li><li><p style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; min-height: 1em; line-height: normal; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">......<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p></li></ul><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">更多优秀文章，长按下方二维码，“<span style="max-width: 100%; color: rgb(0, 122, 170);">关注看雪学院公众号</span>”查看！</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p><img src="/ikanxue/images/ec0991a2106a71402e2ef66768cefbfc74037025.jpeg" style="width: 770px !important; height: 513.013px !important;"></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 14px; box-sizing: border-box !important; overflow-wrap: break-word !important;">看雪论坛：http://bbs.pediy.com/<br style="max-width: 100%; box-sizing: border-box !important; overflow-wrap: break-word !important;"></span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微信公众号 ID：ikanxue</span></p><p style="margin-top: 15px; margin-bottom: 15px; max-width: 100%; min-height: 1em; line-height: 1.75em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">微博：看雪安全</span></p><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; overflow-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(178, 178, 178); font-size: 15px; box-sizing: border-box !important; overflow-wrap: break-word !important;">投稿、合作：www.kanxue.com</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6dv4SfwDR7VaHSGUIUzrphdlD5ct*0DKJsfWnUATla-hbww4NCTxQ10ZFHyYMPPfKT9*Cvqyu6FspJQs*9r*Rv8=">微信地址</a> | <a href="http://bbs.pediy.com/thread-217513.htm">阅读原文</a>
{% endraw  %}

