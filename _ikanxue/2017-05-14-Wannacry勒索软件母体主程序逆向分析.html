---
title: Wannacry勒索软件母体主程序逆向分析
author: expsky@MS509Team
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6ZeYoLYi7On2peh0RUSvK*J9Yoa5swgGJx*eTpbpThEQJKgQrxeqMdVgiiyJsVPNYqMkzKjTgP7CMQNwlpeqzXI=
date: '2017-05-14 00:00:00 +0000'

---

{% raw  %}
<p>声明：本文由expsky@MS509Team原创，仅用于技术交流分享 &nbsp; &nbsp;</p><p><br></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;">Wannacry勒索软件的背景大家都知道了，就是老美的重武器泄漏出来，结果被其他人捡了便宜所利用。类似这样的事情几年前我在以前的公司也做过，从国外弄来的高级样本，然后逆向后改良成自己的产品。毕竟这些高级货能原创出来的人太少了，逆向分析下改造改造这个擅长^_^</span> &nbsp; &nbsp;</p><h2 style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; font-size: 18px; max-width: 100%; box-sizing: border-box; white-space: normal; font-family: 微软雅黑; line-height: 1.1; color: rgb(55, 56, 56); word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; color: rgb(51, 51, 51); word-wrap: break-word !important;">0×01 逆向分析</span></span></h2><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">好了，说正题，我从<a style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;">这里</a>下载了<span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;">Wannacry样本，一些枯燥的汇编分析细节就不多讲，我们尽量快速的了解到整体过程。</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;"><a class="" target="_blank" style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;"><img src="/ikanxue/images/586a4c04ad595dd084cc60d614f6da8df8412fdb.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 365px !important; height: 594px !important;"></a><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;">首先会通过一个函数算出一个标识，我们将这个函数命名为getDisplayName，本质就是通过GetComputerNameW获取计算机名然后取随机数算出一个唯一对应的标识（我们命名为DisplayName），后面的执行过程会用到这个标识</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62); font-size: 16px;">接下来会做几件事情，任意一项未执行成功都会退出</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62); font-size: 16px;"><a class="" target="_blank" style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;"><img src="/ikanxue/images/6a3c9509fbc86940919598d5008126b8a8035960.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 328px !important; height: 204px !important;"></a><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); word-wrap: break-word !important;">检查命令行参数是否为两个，并且是否有/i这个参数</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); word-wrap: break-word !important;"><img src="/ikanxue/images/0c7c412baca8bd2395c5b606d9235b58da7beef3.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; word-wrap: break-word !important; visibility: visible !important; width: 433px !important; height: 150px !important;"><img src="/ikanxue/images/daa557476e8e315de3bd61cb2845c4bf6c10b0ee.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; word-wrap: break-word !important; visibility: visible !important; width: 374px !important; height: 182px !important;"><img src="/ikanxue/images/f49844a2115de055d0e33e9fb53f882782011084.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 357px !important; height: 194px !important;"><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);">检查并尝试在</span><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">ProgramData目录</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);"> 或</span><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;"> Intel目录</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);"> 或</span><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(62, 62, 62); word-wrap: break-word !important;"> </span> &nbsp; &nbsp;<span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">Temp系统临时目录</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);">下创建前面算出的DisplayName为标识的目录</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);"><img src="/ikanxue/images/d43d97bda9cf2e05301a1c9bee32a4192b258e50.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 381px !important; height: 193px !important;"><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); word-wrap: break-word !important;">将这个工作目录设置为6也就是0×2 和 0×4（FILE_ATTRIBUTE_HIDDEN 和&nbsp;FILE_ATTRIBUTE_SYSTEM ）隐藏和系统</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); word-wrap: break-word !important;"><img src="/ikanxue/images/8d3c352664d2c42e47d9801704ec4440ec6cf247.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 440px !important; height: 172px !important;"><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); word-wrap: break-word !important;">创建自身的副本并命名为tasksche.exe</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); word-wrap: break-word !important;"><img src="/ikanxue/images/4219d34e38aaee5060c84019eb7af27219fe83d0.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; word-wrap: break-word !important; visibility: visible !important; width: 398px !important; height: 491px !important;"><img src="/ikanxue/images/df5014442074845f41a5cc206a666061b08d3254.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 373px !important; height: 86px !important;"><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; font-size: 16px;">将tasksche.exe优先以服务方式启动，如果失败则以普通进程方式启动（副本启动的入口点和原始文件启动的入口点不同，从而实现不同的逻辑）</span><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/5d9212f6c99e8e4ff65ed78c23da0b7d4a6615f9.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 611px !important; height: 441px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">通过<span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">互斥体Global\\MsWinZonesCacheCounterMutexA</span>来判断是否启动成功</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">以上几项都成功完成后流程才会继续，否则终止。</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/3a4678fe8f69f498f6cc51e49e84350a073636bf.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; word-wrap: break-word !important; visibility: visible !important; width: 404px !important; height: 410px !important;"><img src="/ikanxue/images/5c3ff94f4304f68183c036e4df77032d274795b3.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 348px !important; height: 375px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">创建注册表项<span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">HKEY_LOCAL_MACHINE\Software\WanaCrypt0r\wd</span><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 176, 80); word-wrap: break-word !important;"> </span>，写入当前路径值</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/2541d69ef34fb843c2d39c62bcec30d0c6fb9f0c.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 349px !important; height: 492px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">从资源中释放PE文件taskdl.exe、taskse.exe，为了免杀，资源中的PE文件是加了密的，释放过程中会解密，比较繁琐</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">会给释放的资源传一个类似key之类的参数过去，参数值为<span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 176, 80); word-wrap: break-word !important;">WNcry@2ol7</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/8129b08fc22acc15dbc3fbc1d3090972f2c14191.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 333px !important; height: 350px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">然后在当前目录下读取c.wnry文件</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/f60933becf24ec0d3d08cabac3eaaabb7cc5acd6.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 690px !important; height: 399px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">如果读取到了c.wnry文件，就会将<span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94</span>通过一个随机数加密后写回到<span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;">c.wnry，而这一串数字就是黑客的比特币地址，也就是说c.wnry文件里保存的是加密后的黑客的比特币地址</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51);"><img src="/ikanxue/images/5912012b251ef33a488b85ddc40ed356fe71f6eb.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 330px !important; height: 39px !important;"><br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">上图就是</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all;"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">c.wnry文件的加密算法</span>，这个加密很简单，只用了两句来实现</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">下面的临时解决方案的自动化工具里就用到了这三个黑客的比特币地址</p><blockquote style="margin-bottom: 20px; padding: 10px 20px; max-width: 100%; box-sizing: border-box; border-left-width: 5px; border-left-color: rgb(238, 238, 238); white-space: normal; font-size: 14px; color: rgb(88, 88, 88); font-family: 微软雅黑; line-height: 26px; word-wrap: break-word !important; background: rgb(247, 247, 247);"><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; word-wrap: break-word !important;">13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94<br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; word-wrap: break-word !important;">12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw<br style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"></span></p><p style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; word-wrap: break-word !important;">115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn</span> &nbsp; &nbsp; &nbsp; &nbsp;</p></blockquote><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/d575400d8a70a083221e43341c0f3c5b11e0b4b9.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 333px !important; height: 73px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">执行这两句命令</p><blockquote style="margin-bottom: 20px; padding: 10px 20px; max-width: 100%; box-sizing: border-box; border-left-width: 5px; border-left-color: rgb(238, 238, 238); white-space: normal; font-size: 14px; color: rgb(88, 88, 88); font-family: 微软雅黑; line-height: 26px; word-wrap: break-word !important; background: rgb(247, 247, 247);"><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;">attrib +h .</p><p style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;">icacls . /grant Everyone:F /T /C /Q</p></blockquote><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; word-wrap: break-word !important;">attrib</span>命令将<span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);">DisplayName工作目录设置为隐藏</span></span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51);"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; word-wrap: break-word !important;">icacls</span>命令开放目录的用户权限</span></span> &nbsp; &nbsp;</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51); font-size: 16px;"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(62, 62, 62);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; word-break: break-all; color: rgb(51, 51, 51);">接下来是动态获取所需的API地址</span></span> &nbsp; &nbsp;</span></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/c4da42632a7368288da45744bf295e600db6260a.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 383px !important; height: 532px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">首先是获取kernel32.dll中的文件相关的API</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/57d377983fddf46e5a86ce54259f96e0d88f12a1.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 480px !important; height: 487px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">然后是获取advapi32.dll中的加解密相关的API</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/e3bc75a6d902a9810e164169b1467c53fca39a38.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 653px !important; height: 198px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">CSP用的是系统默认或者是RSA and AES</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/7aee9fa2cab21dc46708192db2802d34dda9cd0e.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 371px !important; height: 165px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">加密文件以<span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(0, 112, 192); word-wrap: break-word !important;">WANACRY!</span>为特征头</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/42891b0849ea1e69338a630b4c442d3a6e65702e.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 598px !important; height: 597px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">被加密的文件涉及到各种文档、文本、虚拟机、压缩包、镜像、图片、视频、音乐、源代码、脚本、数据库、邮件、证书等近200种文件类型，几乎涵盖了方方面面，但确没有BT种子文件，看来黑客还是有所为有所不为啊^_^</p><h2 style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; font-size: 18px; max-width: 100%; box-sizing: border-box; white-space: normal; font-family: 微软雅黑; line-height: 1.1; color: rgb(55, 56, 56); word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; color: rgb(51, 51, 51); word-wrap: break-word !important;">0×02&nbsp;</span><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; color: rgb(51, 51, 51); word-wrap: break-word !important;">临时解决方案自动化工具</span></span></span></h2><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">网上流传了一个临时解决方案的思路是：</p><blockquote style="margin-bottom: 20px; padding: 10px 20px; max-width: 100%; box-sizing: border-box; border-left-width: 5px; border-left-color: rgb(238, 238, 238); white-space: normal; font-size: 14px; color: rgb(88, 88, 88); font-family: 微软雅黑; line-height: 26px; word-wrap: break-word !important; background: rgb(247, 247, 247);"><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;">获取黑客收款地址的交易记录</p><p style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;">将别人支付赎金的记录信息（交易hash值）冒充是自己付的发送给黑客来蒙混过关（挺贼的^_^）</p></blockquote><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">通过<a style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;">https://btc.com/</a>可以查询到交易记录，但是我们需要有黑客的收款地址，上面我们已经分析出来了</p><blockquote style="margin-bottom: 20px; padding: 10px 20px; max-width: 100%; box-sizing: border-box; border-left-width: 5px; border-left-color: rgb(238, 238, 238); white-space: normal; font-size: 14px; color: rgb(88, 88, 88); font-family: 微软雅黑; line-height: 26px; word-wrap: break-word !important; background: rgb(247, 247, 247);"><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;">13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;">12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw</p><p style="max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; word-break: break-all; white-space: pre-wrap;">115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn</p></blockquote><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">网上有个python的自动化脚本，这里再优化一下，而且还有很多人不是搞IT的，不懂什么python，于是做了一个傻瓜式的exe程序来自动获取交易记录</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; text-align: center; background-color: rgb(255, 255, 255);"><img src="/ikanxue/images/a0123db39efd0d961cdc607b30d72eea5c53de7e.jpeg" style="box-sizing: border-box; border: 0px; vertical-align: middle; display: inline; word-wrap: break-word !important; visibility: visible !important; width: 690px !important; height: 494px !important;"> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">工具链接: <span style="max-width: 100%; box-sizing: border-box; font-weight: 700; word-wrap: break-word !important;"></span><a target="_blank" style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;">http://pan.baidu.com/s/1hsbwQaC </a>密码: p263</p><h2 style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; font-size: 18px; max-width: 100%; box-sizing: border-box; white-space: normal; font-family: 微软雅黑; line-height: 1.1; color: rgb(55, 56, 56); word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><span style="max-width: 100%; box-sizing: border-box; color: rgb(51, 51, 51); word-wrap: break-word !important;">0×03 结尾</span></span></h2><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">从下午开始一直坐在电脑前就没起过身，分析、码字、写工具，一晃现在都到半夜了，搞这行伤不起啊。写不动了，今天先休息了。不过也能猜到其他还要做什么，就是扫端口，找到开放了445端口SMBv1的就使用NSA老大的Eternalblue Doublepulsar实现蠕虫式传播</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">最后再分享下这次罪魁祸首的工具：</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><a target="_blank" style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;">https://github.com/x0rz/EQGRP_Lost_in_Translation</a> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><a target="_blank" style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;">https://github.com/misterch0c/shadowbroker</a> &nbsp; &nbsp;</p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">是工具（没有源码），用了一个python攻击框架Fuzzbunch简称fb，这个框架怎么用，可以看这里<a target="_blank" style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;">http://www.freebuf.com/articles/system/133853.html</a></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);">微软的补丁信息：<a target="_blank" style="color: rgb(6, 154, 239); text-decoration: underline; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background: 0px 0px;">https://blogs.technet.microsoft.com/msrc/2017/04/14/protecting-customers-and-evaluating-risk/</a></p><p style="margin-bottom: 10px; max-width: 100%; box-sizing: border-box; word-wrap: break-word; min-height: 1em; font-size: 15px; line-height: 26px; word-break: break-all; white-space: pre-wrap; color: rgb(88, 88, 88); font-family: 微软雅黑; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; box-sizing: border-box; font-weight: 700; color: rgb(239, 71, 71); font-size: 16px; word-wrap: break-word !important;">*声明：本文来源于中国网安，由expsky@MS509Team原创，仅用于技术交流分享。</span> &nbsp; &nbsp;</p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1494849877&src=3&ver=1&signature=FqhZ2eqkNX-xbZfPTDWJFyyUKemv954mf5Q*MuC9JH720SqIESAnz8-uzXmDzovZMdiRZ8GMhE0ZmV0qTfay6ZeYoLYi7On2peh0RUSvK*J9Yoa5swgGJx*eTpbpThEQJKgQrxeqMdVgiiyJsVPNYqMkzKjTgP7CMQNwlpeqzXI=">微信地址</a> | <a href="https://mp.weixin.qq.com/s?__biz=MzA3NzM2MTQ3OA==&amp;mid=2649803508&amp;idx=1&amp;sn=96e726743ef6b6833ee60c1045a49408&amp;chksm=875752ddb020dbcb5785caeb0405fa539453fe8d685c2700a10263a13f8801d5016ad83019a4&amp;mpshare=1&amp;scene=1&amp;srcid=0514YGIs24VEzHXnpNA89myp&amp;key=01b3e78de374587fb1d9bbb6878d1c46e25cfe100e420c0e49ada824d1a1668909c7c7905e07dd6a5201023ae30784279300e9d534d34928bed770617a5448472dcb66b799a396e9401b615db5786aba&amp;ascene=0&amp;uin=MTA4MjkyMDE4MQ%3D%3D&amp;devicetype=iMac+MacBookAir5%2C1+OSX+OSX+10.11.6+build(15G1421)&amp;version=12020110&amp;nettype=WIFI&amp;fontScale=100&amp;pass_ticket=%2Fm9IrYM5%2B5ch30LscK9ju9SbG6F%2FxEL63Fj0666sX6UlZZeJPMIr8wDzYvHt3ns1#rd">阅读原文</a>
{% endraw  %}

