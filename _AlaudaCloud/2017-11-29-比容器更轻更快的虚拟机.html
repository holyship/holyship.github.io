---
title: 比容器更轻更快的虚拟机
author: 刘梦馨
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512888038&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKGJUBnDL1UEu2oMbeSwc72A-6W*6wLDnhDrFj82qZffJnkFFPAi0gQkNmjamCM7nwIkrQLdjWzcnqLlQMWOlTxrK*L4rqXyXdggFUtu03VrfDmW0vVnlYrnhRCwhr0nSIJjdTUEN*HEpOZNUE4jKYdg=
date: '2017-11-29 00:00:00 +0000'

---

{% raw  %}
<p style="line-height: 1.75em;"><span style="font-size: 14px;">尽管容器技术在今天越来越被人接受，但是安全性依然是一个绕不开的问题，由于容器采用的是共享内核外加 cgroups 和 namespaces 等黑魔法的方式进行隔离注定了会有很多路径的 bug 导致隔离性问题，安全隐患依然存在。而不使用虚拟机的原因不外乎虚拟机启动太慢，额外开销太高，性能由于多了一层会下降。面对容器和虚拟机这两个极端，容器一方想把容器做的隔离性更好，虚拟化方面想把虚拟机做的更轻。结果， <strong>neclab 的一群人居然做到把虚拟机的启动速度做的比 Docker 还快，内存开销比 Docker 还小</strong>。这种反常识的事情居然发生了！他们把工作以 paper 的形式发表在了 SOSP'17 上，（文章地址参见：https://dl.acm.org/citation.cfm?id=3132763&amp;CFID=835048118&amp;CFTOKEN=26631303，或在PC端点击下面的“阅读原文”），这篇文章会介绍下他们是动用了什么样的核武器达到了这样的效果。</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">想要加速就要先有个预期，看一下我们的现状是什么，极限又能到哪里。作者对比了进程启动时间，容器启动时间以及一个虚拟机启动的时间。其中进程启动时间作为一个理论上的极限需要 3.5 ms，docker 容器启动时间需要 200ms，而一个 Debian 虚拟机的启动时间需要大约 2s，其中创建 vm 需要 0.5 s， 启动 vm 需要 1.5s。</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">而和启动速度相关最重要的一个因素就是镜像体积大小，启动的速度基本上随着镜像的体积线性增加。如下图所示：</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><img src="https://mmbiz.qpic.cn/mmbiz_png/CiaJxoTn5Fwo4LJI262HjJJ9spZnxcF5AZlXIyslAaM7q2MnDxGdaJSyoq1teBc6iaPPibg1c8xAHes5D8z23LBvw/0?wx_fmt=png" style="width: 770px !important; height: 439.091px !important; visibility: visible !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">vm 通常需要一个完整的操作系统，所以体积会比较大，如果想优化速度就必须要精简操作系统了，作者通过两种方法实现了这种精简。</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">第一种也是最极端的一种 Unikernels，这可以算是终极核武了。Unikernels 的定义比较复杂，简单来说就是专门为这个应用做一个操作系统内核，这个内核只提供能运行这个服务的最基本功能，除了能跑这个应用别的什么都干不了。应用和内核也是 link 在一起的，你甚至不好说是给这个应用定制了一个内核，还是定制了具有一定应用功能的内核。这种方法需要为每个特定应用定制一个特定内核，听着就是个不可能完成的任务，不过作者还是做了好几个这样的 unikernels，甚至还做了个能跑 serverless 功能的 unikernels。</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">当然这种方法太极端了，第二种方法就相对温和一些，不过依然是洲际导弹重量级别的。既然定制 unikernels 太难了，那就拿一个 Linux 内核进行精简化只保留需要的模块和功能，为每个应用编译一个精简化的 Linux 内核，这样就不需要做应用改造了。为了达到这个目的作者还专门做了个 Tinyx 工具，可以根据应用 objdump 出来的信息来自动寻找依赖，并且根据启发性的测试不断地去寻找哪些 linux 模块可以关闭，去除掉那些和应用无关的功能和编译选项。除了缩小镜像体积，另一个带来的好处是会降低 vm 启动占用的内存。经过精简的内核可以只占用 1.8M 内存，要知道 docker 给每个容器开启的 shim 进程也需要占据 4M 左右的内存。</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">最终的结果是利用 Tinyx 精简内核后镜像大小是&nbsp; 9.5M 的启动时间是 180ms，而 Unikernels 方法镜像大小是 480K，启动时间只需要 3ms，这两种方案都已经比 200ms 的 docker 启动时间还要快了。并且更要命的是他们的内存额外开销比 docker 还要低，从下图可以看出当运行到 3K 容器时宿主机已经无法再创建 docker 容器了，而 Unikernels 可以平稳跑到 8K。</span></p><p><br></p><p style="line-height: 1.75em;"><img src="https://mmbiz.qpic.cn/mmbiz_png/CiaJxoTn5Fwo4LJI262HjJJ9spZnxcF5AgtlXPTTORRHe0Bib1jud44rgmLoIpC5bOhVcx9ouThmVD2tIsb8dXgQ/0?wx_fmt=png" style="width: 770px !important; height: 571.049px !important;"></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">上面介绍的是优化启动速度，主要是精简内核的内容，paper 中还有将近一半的篇幅是介绍如何优化创建 vm 的过程，包括把消息队列的机制改为共享内存机制，虚拟机的预创建以及很多脚本工具 binary 化等很黑科技的优化，对 Xen 进行了大刀阔斧的改进，（毕竟 Xen 也不是用来做这种事情的），有兴趣的同学可以去看下原文链接里的 paper。</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">话说回来，尽管作者真的做到了虚拟机比容器更轻更快，但是这个过程中用到的技术基本上是属于『即使我告诉你原理，你也依旧做不出来』的范畴。这其中需要太多内核和虚拟化的专业技术，一般的应用开发，甚至一般的底层开发都接触不到。而容器和虚拟化两者的融合，我相信依然是未来的一个必然要走的路线，虚拟机会越来越轻量化，容器也越来越会像虚拟机。这篇 paper 的工作也告诉了我们虚拟化还有大量的性能优化空间，而且既然虚拟机都能比容器更轻更快，那么现在的容器在这方面也要努力了。让我们看一下最终是容器长成了虚拟机，还是虚拟机变成了容器呢？</span></p><p><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="line-height: 1.75em;"><span style="font-size: 14px;">更多的细节，包括 Xen 的优化，CPU 性能方面的开销，具体的 Use Case 测试，都可以从原文链接的 paper 中获得。接下来几周我应该都会在看 SOSP'17 的论文，写一些心得体会，想继续看的就关注一下呗。</span></p><p style="max-width: 100%;min-height: 1em;color: rgb(62, 62, 62);font-size: 16px;white-space: normal;box-sizing: border-box !important;word-wrap: break-word !important;"><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-size: 16px;white-space: normal;color: rgb(62, 62, 62);font-family: 微软雅黑;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section class="" data-tools="135编辑器" data-id="87697" data-color="rgb(128, 177, 53)" style="border: 0px none;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="margin-top: 0.5em;margin-bottom: 0.5em;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="border-top-left-radius: 0.5em;border-top-right-radius: 0.5em;border-bottom-right-radius: 0px;border-bottom-left-radius: 0px;color: rgb(255, 255, 255);background-color: rgb(128, 177, 53);max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="transform: translate3d(10px, 0px, 0px);max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="margin-left: 10px;display: inline-block;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="width: 0px;display: inline-block;vertical-align: top;border-right-width: 0.5em;border-right-style: solid;border-right-color: rgb(255, 255, 255);border-bottom-width: 1em;border-bottom-style: solid;border-bottom-color: rgb(255, 255, 255);max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;border-left-width: 0.5em !important;border-left-style: solid !important;border-left-color: transparent !important;border-top-width: 1em !important;border-top-style: solid !important;border-top-color: transparent !important;"></section><section style="padding-right: 10px;padding-left: 10px;height: 2em;line-height: 2em;min-width: 6em;display: inline-block;vertical-align: top;text-align: center;color: rgb(128, 177, 53);background-color: rgb(255, 255, 255);max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="color: rgb(0, 0, 0);"><strong><span style="font-size: 14px;">灵雀云</span></strong></span></section></section><section style="width: 0px;display: inline-block;vertical-align: top;border-left-width: 0.5em;border-left-style: solid;border-left-color: rgb(255, 255, 255);border-top-width: 1em;border-top-style: solid;border-top-color: rgb(255, 255, 255);max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;border-right-width: 0.5em !important;border-right-style: solid !important;border-right-color: transparent !important;border-bottom-width: 1em !important;border-bottom-style: solid !important;border-bottom-color: transparent !important;"></section></section></section></section><section style="padding-right: 10px;padding-left: 10px;border-top-left-radius: 0px;border-top-right-radius: 0px;border-bottom-right-radius: 0.5em;border-bottom-left-radius: 0.5em;border-right-width: 1px;border-style: none solid solid;border-color: rgb(128, 177, 53);border-bottom-width: 1px;border-left-width: 1px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><section style="padding: 5px 10px;text-align: justify;font-size: 14px;letter-spacing: 0px;line-height: 1.8;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><p><span style="color: rgb(136, 136, 136);"><br></span></p><p><span style="color: rgb(136, 136, 136);"></span></p><p>灵雀云Alauda成立于2014年，由原微软Azure云平台的核心创始团队创立。作为容器服务和企业级PaaS领域的领军企业，灵雀云的技术团队拥有全球领先、超大规模企业级云平台的开发、运维和管理经验，并在西雅图和北京都设有研发中心。</p><p><br></p><p>灵雀云不仅是容器技术社区早期的实践者，也是CNCF的正式成员。继2016年发布SaaS版本的Alauda cloud和Alauda cloud Pro之后，灵雀云于2017年面向企业级市场推出了支持私有部署的PaaS平台Alauda EE企业专享版，它是基于容器技术，以DevOps为理念，面向微服务应用的新一代企业级PaaS平台。目前Alauda EE已拥有金融、运营商、制造、能源、航空、汽车等领域的诸多中国五百强企业客户，帮助他们实现基础设施云化、应用架构现代化和开发流程敏捷化。</p><p><br></p><p>2017年11月，灵雀云获得由腾讯云战略领投，高榕资本、宽带资本跟投的超亿元人民币B轮融资。作为迄今为止国内唯一一家实现B轮融资的容器PaaS企业，同时也是在容器PaaS领域目前估值最高、融资额最大的 IT服务企业，灵雀云已经奠定了在该领域的领导者地位。</p><p><br></p><p>灵雀云的核心使命，是通过革命性技术，帮助企业客户在数字化转型的过程当中，不断获得持续创新的能力。</p><p><span style="color: rgb(136, 136, 136);"><br></span></p></section></section></section></section></section></section><p style="white-space: normal;"><br></p><p style="font-size: 16px;white-space: normal;min-height: 1em;color: rgb(62, 62, 62);line-height: 1.75em;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/CiaJxoTn5FwpuZBwfvgS25CSwnaPmLqOiaHF4wELKIt4sltMC7yZOkrvn6ukxRQNibvpvgPFfRFUichyCPJpyFcOWA/640?wx_fmt=jpeg" style="text-indent: 0em; text-align: center; display: inline; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 12px !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p><p style="font-size: 16px;text-indent: 0em;white-space: normal;min-height: 1em;color: rgb(62, 62, 62);line-height: 1.75em;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;color: rgb(136, 136, 136);max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></span></p><p style="font-size: 16px;text-indent: 0em;white-space: normal;min-height: 1em;color: rgb(62, 62, 62);line-height: 1.75em;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/CiaJxoTn5Fwo05XycQqnzTvWIdL639OblycyABp2pYUiatm7bLz7FD6cgYPXscVQ6KmQPPvnAyqRWKficqoboMx5A/640?wx_fmt=jpeg" style="box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 770px !important; height: 581.711px !important;"></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512888038&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKGJUBnDL1UEu2oMbeSwc72A-6W*6wLDnhDrFj82qZffJnkFFPAi0gQkNmjamCM7nwIkrQLdjWzcnqLlQMWOlTxrK*L4rqXyXdggFUtu03VrfDmW0vVnlYrnhRCwhr0nSIJjdTUEN*HEpOZNUE4jKYdg=">微信地址</a> | <a href="https://dl.acm.org/citation.cfm?id=3132763&amp;CFID=835048118&amp;CFTOKEN=26631303">阅读原文</a>
{% endraw  %}

