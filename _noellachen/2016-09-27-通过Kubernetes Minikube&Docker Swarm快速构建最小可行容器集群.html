---
title: 通过Kubernetes Minikube&Docker Swarm快速构建最小可行容器集群
author: 陈爱珍
date: '2016-09-27 00:00:00 +0000'

---

{% raw  %}
<p style="background:white"><span style="font-size:15px;color:#333333">对于开发可能更多关注的是产品功能的实现，并不希望花费太多的时间用于构建一个基于容器集群的开发环境，所以能快速构建一个最小可行性的容器集群环境对开发来说非常重要。那么开发人员如何能快速构建一个最小可行的容器集群呢？介绍一下分别使用</span><span style="font-size:15px;color:#333333">Kubernetes 的Minikube，Docker Swarm 如何快速构建最小可行容器集群。</span></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><strong><span style="font-size:15px;color:#333333">Kubernetes Minikube</span></strong></p><p style="background:white"><span style="font-size:15px;color:#333333">在容器编排工具中安装配置最复杂的就是 </span><span style="font-size:15px;color:#333333">Kubernetes，想要运行一个简单的容器集群环境，对于没有使用过 </span><span style="font-size:15px;color:#2B2B2B">Kubernetes的人来说，需要花费一定的时间去理解各组件的概念和功能，再做大量的安装配置工作才能运</span><span style="font-size:15px;color:#333333">行一个 </span><span style="font-size:15px;color:#333333">kubernetes集群。而在 Kubernetes 1.3 提供了一个叫Minikube 的强大测试工具，可以在任意笔记本上运行单节点的小型集群，这个工具默认安装和配置了一个Linux&nbsp;VM，Docker和Kubernetes 的相关组件，并且提供 Dashboard。目前支持在 Linux, OSX及 Windows 上安装，今天介绍的是在 OSX 上的安装。</span></p><p style="background:white"><span style="font-size:15px;color:#333333">安装步骤：</span></p><p style="background:white"><span style="font-size:15px;color:#333333">1、检查笔记本环境</span></p><p style="background:white"><span style="font-size:15px;color:#333333">Minikube要求在BIOS中对VT-x/AMD-v进行了虚拟化，执行如下命令：</span></p><p style="background:#F0F0F0"><strong><span style="font-size:15px;color:#333333">$sysctl -a | grep machdep.cpu.features | grep VMX&nbsp;</span></strong></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">如果已经设置了，则命令执行后会有内容输出，以下是我电脑的输出结果：</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">machdep.cpu.features:FPU VME DE PSE TSC MSR PAE MCE CX8 APIC SEP MTRR PGE MCA CMOV PAT PSE36 CLFSH DSACPI MMX FXSR SSE SSE2 SS HTT TM PBE SSE3 PCLMULQDQ DTES64 MON DSCPL VMX ESTTM2 SSSE3 FMA CX16 TPR PDCM SSE4.1 SSE4.2 x2APIC MOVBE POPCNT AES PCID XSAVEOSXSAVE SEGLIM64 TSCTMR AVX1.0 RDRAND F16C</span><span style="font-size:12px;color:#333333"><br><br></span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">2、安装虚拟机驱动</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">在</span><span style="font-size:15px;color:#2B2B2B">OS X上支持<span style="color: rgb(112, 177, 231)">xhyve driver</span>,&nbsp;<span style="color: rgb(112, 177, 231)">VirtualBox</span>&nbsp;or&nbsp;<span style="color: rgb(112, 177, 231)">VMware Fusion</span>，这里使用的是virtualbox</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">下载最新版本的</span><span style="font-size:15px;color:#2B2B2B">virtualbox，下载地址：<span style="color: rgb(112, 177, 231)">https://www.virtualbox.org/wiki/Downloads</span></span></p><p style="background:white"><span style="font-size:12px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">3、下载 minikube</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">下载最新的版本</span><span style="font-size:15px;color:#2B2B2B">v0.10.0，</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$curl -Lo minikube <span style="color: rgb(43, 43, 43)">https://storage.googleapis.com/minikube/releases/v0.10.0/minikube-darwin-amd64</span>&amp;&amp; chmod +x minikube &amp;&amp; sudo mv minikube /usr/local/bin/</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">4、下载 kubectl</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$curl -Lo kubectl <span style="color: rgb(43, 43, 43)">http://storage.googleapis.com/kubernetes-release/release/v1.3.0/bin/darwin/amd64/kubectl</span>&amp;&amp; chmod +x kubectl &amp;&amp; sudo mv kubectl /usr/local/bin/</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">5、启动一个容器集群</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$minikube start&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">Startinglocal Kubernetes cluster...&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">Kubernetesis available at <span style="color: rgb(43, 43, 43)">https://192.168.99.100:443</span>.</span></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">以上是官网的输出，我的电脑操作时输出如下：</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/27da318a693cf8a32a3dc4bb9f2b032bce4b1c86.png" style="width: 770px !important; height: 81.5678px !important;"><br><span style="color: rgb(51, 51, 51); font-size: 15px;">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">一个简单的</span><span style="font-size:15px;color:#333333">Kubernetes集群环境就创建好了。可以使用minikube -help命令查看命令的使用方法，下面我们可以执行一些命令来查看minikube的一些状态和信息:</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style=";background:white"><strong><span style="font-size:15px;color:#333333"><strong style="white-space: pre-wrap; background-color: rgb(255, 255, 255);"><span style="font-size: 15px; color: rgb(51, 51, 51);">查看</span></strong>状态</span></strong></p></li></ul><p style="text-align:center;background:white"><img src="/noellachen/images/17650afb73af4b43137157b6dbb2e4d7b5f8aabe.png" style="width: 770px !important; height: 87.5191px !important;"><br></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style=";background:white"><strong><span style="font-size:15px;color:#333333"><strong style="white-space: pre-wrap; background-color: rgb(255, 255, 255);"><span style="font-size: 15px; color: rgb(51, 51, 51);">查看</span></strong>IP：</span></strong></p></li></ul><p style="text-align:center;background:white"><img src="/noellachen/images/378606588cf3153d5785d6e676d6f81219ff8fe0.png" style="width: 770px !important; height: 64.5113px !important;"><br></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style=";background:white"><strong><span style="font-size:15px;color:#333333"><strong style="white-space: pre-wrap; background-color: rgb(255, 255, 255);"><span style="font-size: 15px; color: rgb(51, 51, 51);">查看</span></strong>Pod：</span></strong></p></li></ul><p style="text-align:center;background:white"><img src="/noellachen/images/3b597363972788d4283e3d9bd8f88cbbde7a23a4.png" style="width: 770px !important; height: 54.0351px !important;"><br></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style=";background:white"><strong><span style="font-size:15px;color:#333333">查看可使用的</span></strong><strong><span style="font-size:15px;color:#333333">Kubernetes的版本</span></strong></p></li></ul><p style="text-align:center;background:white"><img src="/noellachen/images/5c619c395a706707be25d0e1c21db9c43974a76e.png" style="width: 770px !important; height: 219.066px !important;"><br></p><p style="background:white"><span style="font-size:15px;color:#333333">6、部署一个应用</span></p><p style="background:white"><span style="font-size:15px;color:#333333">部署有</span><span style="font-size:15px;color:#333333">dashboard窗口操作方法和命令行方式，分别介绍一下：</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style=";background:white"><strong><span style="font-size:15px;color:#333333">Dashboard</span></strong></p></li></ul><p style="background:white"><span style="font-size:15px;color:#333333">1）执行minikube dashboard命令后会自动弹出浏览器，如下：</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/10fd7abd44c1b41da12eb358555b6f427d89e5bc.png" style="width: 770px !important; height: 401.633px !important;"><br></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">2）点击右上角的CREATE键进行部署配置：</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/3ebc7d5ea0e46f0d62fe439d959eb0ef7090c749.png" style="width: 770px !important; height: 379.432px !important;"><br></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">参考配置如下：</span></p><p style=";background:white"><span style="font-size:13px;font-family:Symbol;color:#333333">·<span style="font-size: 9px;line-height: normal">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span style=";color:#333333">App Name: static-web</span></p><p style=";background:white"><span style="font-size:13px;font-family:Symbol;color:#333333">·<span style="font-size: 9px;line-height: normal">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span style=";color:#333333">Container image:nginx:latest</span></p><p style=";background:white"><span style="font-size:13px;font-family:Symbol;color:#333333">·<span style="font-size: 9px;line-height: normal">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span style=";color:#333333">Number of pods: 1</span></p><p style=";background:white"><span style="font-size:13px;font-family:Symbol;color:#333333">·<span style="font-size: 9px;line-height: normal">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span style=";color:#333333">Service: External</span></p><p style=";background:white"><span style="font-size:13px;font-family:Symbol;color:#333333">·<span style="font-size: 9px;line-height: normal">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span style=";color:#333333">Port: 80</span></p><p style=";background:white"><span style="font-size:13px;font-family:Symbol;color:#333333">·<span style="font-size: 9px;line-height: normal">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span style=";color:#333333">Target Port: 80</span></p><p style="background:white"><span style=";color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">配置好后在</span><span style="font-size:15px;color:#333333">Dashboard可以看到：</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/924b46a720422f8be5bafec6424e7305d211d727.png" style="width: 770px !important; height: 313.798px !important;"><br></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style=";background:white"><strong><span style="font-size:15px;color:#333333">命令行的方式：</span></strong></p></li></ul><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$kubectl run hellominikube --image=gcr.io/google_containers/echoserver:1.4--port=8080</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">deployment"hello-minikube" created</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$kubectl expose deployment hello-minikube --type=NodePort</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">service"hellominikube" exposed</span></p><p style="text-align:center;background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">配置好后在</span><span style="font-size:15px;color:#333333">Dashboard可以看到：</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/4121ecf52dc0d483a27f273a93c4321d2767e5fb.png" style="width: 770px !important; height: 408.571px !important;"><br></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">我这里用的是</span><span style="font-size:15px;color:#333333">OS X 的方式安装，其他方式可参Minikube相关连接：</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">下载地址：</span><span style="font-size:15px;color:#2B2B2B"><span style="color: rgb(112, 177, 231)">https://github.com/kubernetes/minikube/releases</span></span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">安装指导：</span><span style="font-size:15px;color:#2B2B2B"><span style="color: rgb(112, 177, 231)">http://kubernetes.io/docs/getting-started-guides/minikube/#download-kubectl</span></span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B"><span style="color: rgb(112, 177, 231)">https://github.com/kubernetes/minikube/blob/v0.10.0/README.md</span></span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">DockerSwarm</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">那么下面介绍一下如何使用</span><span style="font-size:15px;color:#2B2B2B">DockerSwarm快速构建。Docker1.12版本带有内置的Swarm 编排功能，所以不需要再特别安装其他的编排工具，只需四步，就可以快速启动一个具有弹性扩展及服务发现的容器集群。集群为三个节点，一个manager节点，两个node节点</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">1.安装docker 1.12，请参考官方文档</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">2.在manager节点上启动管理节点，假设IP为192.168.10.1，执行如下命令：</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$docker swarm init --advertise-addr 192.168.10.1</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">命令回车后会在屏幕显示：</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">Swarminitialized: current node (dxn1zf6l61qsb1josjja83ngz) is now a manager.</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;Toadd a worker to this swarm, run the following command:</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;&nbsp;&nbsp;docker swarm join \</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;&nbsp;&nbsp;--tokenSWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c\</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;&nbsp;&nbsp;192.168.10.1:2377</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">Toadd a manager to this swarm, run 'docker swarm join-token manager' and followthe instructions.</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">这个显示内容告诉两个信息，如何加</span><span style="font-size:15px;color:#2B2B2B">work节点和如何加manager节点。</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">3.将Node 节点加入集群</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">参考</span><span style="font-size:15px;color:#2B2B2B">manager节点上命令的提示，到两个work节点上分别输入manager上显示的命令：</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$docker swarm join \</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;&nbsp;&nbsp;--tokenSWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c\</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">&nbsp;&nbsp;&nbsp;192.168.10.1:2377</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">在</span><span style="font-size:15px;color:#2B2B2B">manager节点上执行docker node ls 命令就可以显示所有节点的信息：</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/3f1227d33e0f11f31968dd1fe05bdd659cd34b33.png" style="width: 704px !important; height: 87px !important;"><br></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">一个简单的容器集群就建成了，是不是</span><span style="font-size:15px;color:#2B2B2B">soeasy?</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#2B2B2B">4.创建服务</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">$docker service create --replicas 1 --name hellowswarm alpine pingdocker.com&nbsp;</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/120c546f44248d96500db30f05cce47f80b439f2.png" style="width: 770px !important; height: 78.2822px !important;"><br></p><p style="background:white"><span style="font-size:15px;color:#333333">&nbsp;</span></p><p style="background:white"><span style="font-size:15px;color:#333333">5．扩展服务数量到5个</span></p><p style="background:#F0F0F0"><span style="font-size:15px;color:#2B2B2B">#dockerservice scale helloswarm=5</span></p><p style="text-align:center;background:white"><img src="/noellachen/images/e40642a45d5144baeaf67586c7a51b1524f35c5f.png" style="width: 770px !important; height: 99.0272px !important;"><br></p><p>&nbsp;</p><p><br></p>
{% endraw  %}

