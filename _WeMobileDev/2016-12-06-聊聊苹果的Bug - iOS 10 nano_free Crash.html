---
title: 聊聊苹果的Bug - iOS 10 nano_free Crash
author: 张三华
date: '2016-12-06 00:00:00 +0000'

---

{% raw  %}
<h2 style="line-height: 1.1;"><span style="font-size: 24px;"><strong>背景</strong></span></h2><hr><h2 style="line-height: 1.1;"><strong><span style="font-size: 20px;"></span></strong><br></h2><p>iOS 10.0-10.1.1上，新出现了一类堆栈为nano_free字样的crash问题，困扰了我们一段时间，这里主要分享解决这个问题的思路，最后尝试提出一个解决方案可供参考。</p><p><br></p><p>它的crash堆栈大致为：<img src="/WeMobileDev/images/cdb769c461efc0f24de423861d6e87baeb2ea847.png" style="width: 694px !important; height: 112px !important; visibility: visible !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>这种crash我们并不陌生，一般野指针的问题，也是这样的堆栈。但在iOS 10发布之后，这类crash就嗖地窜到了微信的crash排行榜的前列，而此时微信并没有发布新版本。&nbsp;</p></li><li><p>通过和一些内部、外部团队的交流，发现这是个共性问题，例如：<a>https://forums.developer.apple.com/thread/63546</a>&nbsp;</p></li></ul><p>这两种迹象表明，这很可能是苹果的bug。按流程，我们向苹果提了bug report，并得到回复：“iOS 10.2 Beta有稳定性提升”。</p><p><br></p><p>终于等到iOS 10.2 Beta发布，我们重新统计了此类crash的系统版本分布。发现不仅在10.2 Beta正常，而且iOS 9也没有crash。</p><p>苹果给我们的建议是：“引导用户升级系统”。这当然能解决问题，但用户升级系统是个漫长的周期。<br></p><p><img src="/WeMobileDev/images/ae874f5dc94af62a550b79682755c719cd5af85d.png" style="width: 323px !important; height: 379px !important; visibility: visible !important;"></p><p>而其实我们非常关注这个问题的原因，不仅是线上版本的crash，更是在我们的开发分支，它的crash概率异常的高。如果不搞清楚触发crash的原因，那这将是一颗定时炸弹，不知道何时就会被我们合入主线，发布出去。因此我们着手开始做一些尝试。</p><p><br></p><h2 style="line-height: 1.1;"><span style="font-size: 24px;"><strong>尝试</strong></span></h2><hr><h2 style="line-height: 1.1;"><strong><span style="font-size: 20px;"></span></strong><br></h2><p>首先我们的切入点是iOS 9和10.2 Beta没有crash。既然如此，能否将正常的代码合入微信，替换掉系统的呢？</p><p><br></p><h3 style="line-height: 1.1;"><strong><span style="font-size: 20px;">尝试一：替换dylib</span></strong></h3><p>各版本的dylib可以在macOS的<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">~/Library/Developer/Xcode/iOS DeviceSupport/</code>找到，我们选了iOS 9.3.5的<span style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 12.75px; white-space: pre-wrap; background-color: rgba(0, 0, 0, 0.0392157);">libsystem_malloc.dylib</span>。尝试编入时却报链接错误：</p><blockquote><p><span class="">ld:</span> <span class="">cannot</span> <span class="">link</span> <span class="">directly</span> <span class="">with</span> <span class="" style="color: rgb(104, 118, 135);">/</span><span class="">Users</span><span class="" style="color: rgb(104, 118, 135);">/</span><span class="">sanhuazhang</span><span class="" style="color: rgb(104, 118, 135);">/</span><span class="">Desktop</span><span class="" style="color: rgb(104, 118, 135);">/</span><span class="">TestNanoCrash</span><span class="" style="color: rgb(104, 118, 135);">/</span><span class="">libsystem_malloc.dylib.</span> &nbsp;<span class="">Link</span> <span class="">against</span> <span class="">the</span> <span class="">umbrella</span> <span class="">framework</span> '<span class="">System.framework</span>' <span class="">instead.</span> <span class="" style="color: rgb(147, 15, 128);">for</span> <span class="">architecture</span> <span class="">arm64</span></p><p><span class="">clang:</span> <span class="">error:</span> <span class="">linker</span> <span class="">command</span> <span class="">failed</span> <span class="">with</span> <span class="" style="color: rgb(60, 76, 114);">exit</span> <span class="">code</span> <span class="" style="color: rgb(0, 0, 205);">1</span> <span class="">(use</span> <span class="" style="color: rgb(104, 118, 135);">-</span><span class="">v</span> <span class="">to</span> <span class="">see</span> <span class="">invocation)</span></p></blockquote><p>这个是因为dylib的<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 15.300000190734863px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">LY_SUB_FRAEWORK</code>段指明它属于<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 15.300000190734863px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">System.framework</code>，直接被编译器拒绝了。看来没有办法。（如果有同学知道如何绕过这个保护，烦请赐教。）</p><p><br></p><h3 style="line-height: 1.1;"><strong><span style="font-size: 20px;">尝试二：编入源码</span></strong></h3><p><code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">libsystem_malloc.dylib</code>的源码可以在 <a>https://opensource.apple.com/tarballs/libmalloc/</a> 找到。这里有多个版本，用otool找到iOS 9.3.5对应的源码是libmalloc-67.40.1.tar.gz。</p><p><img src="/WeMobileDev/images/d9f52d2f3e5bc78134fe4d767df425abd8722791.jpeg" style="width: 770px !important; height: 106.629px !important;"><br>然而这份源码是不完整的，只能读不能编译。看来这个方法也行不通。</p><p><br></p><h2 style="line-height: 1.1;"><span style="font-size: 24px;"><strong>阅读源码</strong></span></h2><hr><h2 style="line-height: 1.1;"><strong><span style="font-size: 20px;"></span></strong><br></h2><p>上述两个方法不行，就有点束手无策了，只能阅读源码，尝试找突破口。</p><p>在<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">libsystem_malloc.dylib</code>中，对内存的管理有两个实现：nano zone和scalable zone。他们分别管理不同大小的内存块：</p><p><a target="_blank" data-spm-anchor-id="5176.100239.blogcont3065.8" style="box-sizing: border-box; transition: color 0.2s; -webkit-transition: color 0.2s; color: rgb(66, 139, 202); font-family: 'Helvetica Neue', Helvetica, Arial, 'Hiragino Sans GB', 'Microsoft Yahei', sans-serif; font-size: 16px; background-position: 0px 0px;"><img src="/WeMobileDev/images/c02f1347a95313d8c8350bddc0822e72c37d1e2a.png" style="width: 770px !important; height: 242.925px !important;"><br></a>其中nano zone分配nano类型的指针，而scalable zone则分配其他三种类型。nano zone的管理区间和scalable zone是有重叠的，可以理解为nano zone是scalable在小内存下的一个优化。</p><p>这两种方法通过<code style="padding-top: 0.2em; padding-bottom: 0.2em; white-space: pre-wrap; font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneN</code><code style="padding-top: 0.2em; padding-bottom: 0.2em; white-space: pre-wrap; font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">ano</code>的环境变量进行配置：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>当<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneN</code><code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">ano=1</code>时，defau<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;"></code>lt zone为nano zone，不满足nano zone的内存会fall through到它的helper zone，而helper zone是一个scalable zone。<br></p></li><li><p>当<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneNano=0</code>时，deafult zone为scalable zone。</p></li></ul><p><br></p><p>通过<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">getenv("MallocZoneNano")</code>可以拿到环境变量的值，我们发现，在iOS 9和iOS 10.2 Beta中，<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneNano=0</code>，而其他系统<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneNano=1</code>。</p><p>换句话说，苹果并不是修复了这个问题，而只是屏蔽了。因此其实我们在尝试一中提到替换dylib，即使替换成功，也是不解决问题的。</p><p>结合最初的crash堆栈，我们知道crash是发生在nano zone内的，那是否可以关掉nano zone呢？</p><p><br></p><h3 style="line-height: 1.1;"><strong><span style="font-size: 20px;">尝试三：修改环境变量<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 15.300000190734863px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneNano=0</code></span></strong></h3><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p>通过<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">setenv</code>方法，可以设置环境变量，修改<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 12.75px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneNano=0</code>。然而并没有效果，因为dylib的初始化在微信之前，此时微信还未启动。</p></li><li><p>根据苹果的文档，Info.plist的<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 15.300000190734863px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">LSEnvironment</code>字段，可以设置环境变量，然而这个只适用于macOS。<img src="/WeMobileDev/images/180529075d316067f20973fabc9c51068a1dd2da.png" style="width: 740px !important; height: 119.552px !important;"></p></li><li><p>在Xcode的Schema里设置<code style="font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; line-height: 1.4; padding-top: 0.2em; padding-bottom: 0.2em; font-size: 15.300000190734863px; background-color: rgba(0, 0, 0, 0.0392157); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">MallocZoneNano=0</code>后，本地不再出现crash。但schema只适用于调试阶段，不能编进app里。<img src="/WeMobileDev/images/8aa3f4ada32faec54708c65f7a8ed84f6c12d8b1.jpeg" style="width: 740px !important; height: 306.921px !important;"></p></li></ol><p>看来这个方法也行不通，但起码验证了，关掉nano zone是可以解决问题。</p><p><br></p><h3 style="line-height: 1.1;"><strong><span style="font-size: 20px;">尝试四：hook</span></strong></h3><p>既然无法完全关闭nano zone，那就尝试跳过它。</p><p>因为我们自己通过<span style="white-space: pre-wrap;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 15.300000190734863px;  background-color: rgba(0, 0, 0, 0.0392157);">malloc_zone_create</span>创建的zone都属于scalable zone，不会导致crash。因此我们可以</span></p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="white-space: pre-wrap;">通过<span style="white-space: pre-wrap;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 15.300000190734863px;  background-color: rgba(0, 0, 0, 0.0392157);">malloc_zone_create</span>创建一个新的zone，并命名为guard zone</span></span></p></li><li><p><span style="white-space: pre-wrap;">用fishhook，将<span style="white-space: pre-wrap;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 15.300000190734863px;  background-color: rgba(0, 0, 0, 0.0392157);">malloc</span>和<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 15.300000190734863px;  background-color: rgba(0, 0, 0, 0.0392157);">malloc_zone_malloc</span>等一众常用的内存管理的方法，转发到guard zone</span></span></p></li></ol><p><span style="white-space: pre-wrap;">使用这个方案后，crash的概率确实降了一些。但并不彻底解决问题。</span></p><p>因为<span style="white-space: pre-wrap;">fishhook无法hook掉其他dylib的调用，<span style="white-space: pre-wrap;">也就是说，系统的调用（如Cocoa、CoreFoundation等）依然是走nano zone。</span></span></p><p><br></p><h3 style="line-height: 1.1;"><strong><span style="font-size: 20px;">尝试五：跳过nano zone</span></strong></h3><p>从上面我们知道，nano zone管理的是0-256字节的内存，如果内存不在这个区间，则会fall through到helper zone。而zone的结构是公开的：</p><p><img src="/WeMobileDev/images/51cb8dce82ca935ad14c1f8240bcd0bac1334ddb.jpeg" style="width: 770px !important; height: 424.703px !important;"><br>那么可以用tricky一点的方法：修改nano zone和helper zone的函数指针，让nano zone的内存申请虚增，超过256字节，以骗过nano zone，而fall through到helper zone后，再恢复为真正的大小。以malloc为例，具体实现为：</p><p><img src="/WeMobileDev/images/4806f0a7c2b38c80388a855e3ecf4c7669240ccf.jpeg" style="width: 770px !important; height: 528.773px !important;"><br>由于内存有限，size的最高位一般不会被使用，因此我们可以用这一位来标记。</p><p><br></p><p>当我满心以为终于解决问题时，却发现，crash概率不仅没有降低，反而到了几乎必现的程度。而此时除了少数在替换前就申请的内存是走的nano zone，其他内存都是在scalable zone内被管理。这一现象不禁让人怀疑，nano_free的crash，很可能是zone判断错误。即在scalable zone申请的内存，却在nano zone中释放。</p><p><br></p><p><strong><span style="font-size: 24px;">重现问题</span></strong></p><hr><p><strong><span style="font-size: 24px;"></span></strong><br></p><p>为了验证，我们还得从源码中搞清楚怎么区分一个指针属于nano zone还是scalable zone：<img src="/WeMobileDev/images/930e22846eb5ec6b6ee63d172a785a26b16e6593.png" style="width: 770px !important; height: 492.381px !important;"></p><p>可以看到，在x86下，是通过获取指针地址所属的段来判断zone的。当signature满足0x00006这个段时，则属于nano zone。</p><p><br></p><p>虽然这份代码里没有提供arm下的判断方式，但可以结合源码中对signature判断的函数，并通过符号断点，很快就能找到arm下比较signature的汇编。</p><p><img src="/WeMobileDev/images/1d9e69ff00ef4a6ab19dab758c60aeaffeaad2d8.jpeg" style="width: 770px !important; height: 194.829px !important;"><br>即：当ptr&gt;&gt;28==0x17时，属于nano zone。</p><p><br></p><p>通过测试代码可以发现，小于256字节的指针确实在0x17段。然而，代码跑了一阵子之后，大于256字节的指针也落在了0x17段。</p><p><img src="/WeMobileDev/images/2b0078669f2eddd5b0c28ac0f8ba10d4788cd046.jpeg" style="width: 770px !important; height: 216.067px !important;"></p><p><br></p><p><span style="white-space: pre-wrap;">似乎我们已经很接近问题的核心了。再来一段测试代码验明真身。</span></p><p>先通过循环不断地申请257字节的内存，并保存起来。这些内存应该都落在scalable zone中。当出现0x17段的内存时，我们break掉。</p><p>可以假设在此之后scalable zone内申请的内存，都在0x17段，具体代码为：</p><p><img src="/WeMobileDev/images/6f113ea83dfeaaf4faf0b920fb70a821eca1b730.png" style="width: 761px !important; height: 293px !important;"></p><p><br></p><p>我们新建了一个iOS的Single View Application，除了这段代码，没有做其他任何的修改。问题重现了：</p><p><img src="/WeMobileDev/images/25811f7149f9e072a588e438b227acd4d6273e4b.jpeg" style="width: 770px !important; height: 749.96px !important;"><br></p><h3 style="line-height: 1.1;"><br></h3><h3 style="line-height: 1.1;"><strong><span style="font-size: 24px;">解决方案</span></strong></h3><hr><h3 style="line-height: 1.1;"><strong><span style="font-size: 24px;"></span></strong><br></h3><p>从重现的代码来看，要真正规避nano_free类型的crash出现，只能是减少内存的使用，但这并不好操作。因此，解决思路还是回到保护上。</p><p><br></p><p>结合上面提到尝试3和4，我们进行了这样的修改。</p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p>创建一个自己的zone，命名为guard zone。</p></li><li><p>修改nano zone的函数指针，重定向到guard zone。</p></li><ol class="list-paddingleft-2" style="list-style-type: lower-alpha;"><li><p>对于没有传入指针的函数，直接重定向到guard zone。</p></li><li><p>对于有传入指针的函数，先用size判断所属的zone，再进行分发。</p></li></ol></ol><p>这里需要特别注意的是，因为在修改函数指针前，已经有一部分指针在nano zone中申请了。因此对于每个传入的指针，我们都需要找到它所属的zone。代码示例为：</p><p><img src="/WeMobileDev/images/db5dbf8869c708ecc21485411249523e4bcfe9c0.jpeg" style="width: 770px !important; height: 607.498px !important;"><br><img src="/WeMobileDev/images/b6ac405ef1e8ce7959d5c6b1239f02fae96261c3.jpeg" style="width: 770px !important; height: 253.258px !important;"><br>注：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>该问题不止有一种方式解决，可自行发散思维。</p></li><li><p>这种方式目前还在灰度中，若要使用，请搭配适当的灰度和回退措施。</p></li></ul><p><br></p>
{% endraw  %}

