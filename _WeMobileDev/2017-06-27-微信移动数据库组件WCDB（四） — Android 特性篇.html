---
title: 微信移动数据库组件WCDB（四） — Android 特性篇
author: johnwhe
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1499657001&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvW9frk29Hk1En3LpsHLaTv7ipZAVwDYHwVCzjmmHA4TJhC2c9oR45DNKTeFBDtusuR1VyJ431hp5BTG6k4p8WbF5kryHqDsIYi8eICbPzZJ7JRu55bAUEWTUVQfp9FEXVmu-lBooKtXLEq5--68YoBhc=
date: '2017-06-27 00:00:00 +0000'

---

{% raw  %}
<p><span style="font-size: 18px;"></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="2"><span style="font-size: 16px;">微信的移动端数据库组件 WCDB 已经正式开源了，有关注的小伙伴可能已经用上了。如果还没用上，可以翻到文末关注我们的 GitHub 和公众号其他文章。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="2"><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="5"><span style="font-size: 16px;">之前我们已经发过几篇 iOS 和修复的文章，Android 由于接口跟系统几乎一样，相信大家都比较熟悉，不熟悉用法也可以到 Android Developer 官网看一下。但是，我们也有一些特色功能和优化大家可能不容易注意到， 现在就单独拿出来说说。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="5"><br></p><h1 class="" style=" padding-bottom: 0.3em; line-height: 1.2; border-bottom: 1px solid rgba(0, 0, 0, 0.180392); font-weight: normal; border-top-color: rgba(0, 0, 0, 0.180392); border-right-color: rgba(0, 0, 0, 0.180392); border-left-color: rgba(0, 0, 0, 0.180392);  color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="9"><strong><span style="font-size: 24px;">加密接口</span></strong></h1><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="11"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="11"><span style="font-size: 16px;">WCDB 使用了 SQLCipher 的 C 层库，但没有直接使用 SQLCipher Android 的封装层。SQLCipher Android 封装层中很多设置需要手写 PRAGMA 语句实现，比如设置 KDF 迭代次数（兼容老版本 SQLCipher DB）、设置 Page Size 等操作。</span></p><p><span style="font-size: 16px;"></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="11"><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/csvJ6rH9Mcvx9E3oHykce0icz1c1rhagqZt09oTHw5r94mia6VvPKCQoyM1oOMaIEtF78gtyeKcctZBI58RuZicmA/0?wx_fmt=png" style="width: 770px !important; height: 360.826px !important; visibility: visible !important;"></p><p><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="32"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="32"><span style="font-size: 16px;">对于开发者来说，这需要了解 SQLCipher 底下的 PRAGMA 指令，更重要的是要搞清楚这些指令正确的调用顺序。 哪些是需要在设置 key 之前执行的？哪些是只有设置了 key 之后才生效的？开发者往往必须仔细查阅 SQLCipher 的文档来了解这些细节。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="32"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="36"><span style="font-size: 16px;">WCDB 对这个部分做了改进，封装了&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteCipherSpec</span></code><span style="font-size: 16px;">&nbsp;用于设置加密参数，设置好了传给&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteDatabase</span></code><span style="font-size: 16px;">&nbsp;工厂方法就好了，不需要考虑 PRAGMA 语法和调用顺序。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="36"><span style="font-size: 16px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/csvJ6rH9Mcvx9E3oHykce0icz1c1rhagqQr37qyJv5fjPkiccsAXSXRjsoicBYYArFKSn2APkJWW2T2FHicJToregg/0?wx_fmt=png" style="width: 770px !important; height: 118.342px !important;"></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="36"><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="47"><span style="font-size: 16px;">使用&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteCipherSpec</span></code><span style="font-size: 16px;">&nbsp;另一个好处是，同样的结构可以传给&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">RepairKit</span></code><span style="font-size: 16px;">&nbsp;用于恢复损坏 DB，不需要两套 接口了。由于 RepairKit 底层不使用 PRAGMA，原来 hook 的形式不能满足需要。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="47"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="50"><span style="font-size: 16px;">另外，WCDB 将&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">String</span></code><span style="font-size: 16px;">&nbsp;类型的密码改为&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">byte[]</span></code><span style="font-size: 16px;">&nbsp;类型，可以支持非打印字符作为密码（比如&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">hash(user id)</span></code><span style="font-size: 16px;">&nbsp;方式），原来字符类型密码只要转换为 UTF-8 的 byte 数组即可，和 SQLCipher Android 兼容。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="50"><span style="font-size: 16px;"><br></span></p><h1 class="" style=" padding-bottom: 0.3em; line-height: 1.2; border-bottom: 1px solid rgba(0, 0, 0, 0.180392); font-weight: normal; border-top-color: rgba(0, 0, 0, 0.180392); border-right-color: rgba(0, 0, 0, 0.180392); border-left-color: rgba(0, 0, 0, 0.180392);  color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="54"><strong><span style="font-size: 24px;">数据迁移</span></strong></h1><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="56"><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="56"><span style="font-size: 16px;">SQLCipher 提供了&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">sqlcipher_export</span></code><span style="font-size: 16px;">&nbsp;SQL 函数用于导出数据到挂载的另一个 DB，可以用于数据迁移。 但这个函数用于 Android 的&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteOpenHelper</span></code><span style="font-size: 16px;">&nbsp;并不方便。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="56"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="59"><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteOpenHelper</span></code><span style="font-size: 16px;">&nbsp;主要帮助开发者做 Schema 版本管理，通过它打开 SQLite 数据库，会读取&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">user_version</span></code><span style="font-size: 16px;">&nbsp;字段来判断是否需要升级，并调用子类实现的&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">onCreate</span></code><span style="font-size: 16px;">、</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">onUpgrade</span></code><span style="font-size: 16px;">&nbsp;等接口来完成创建或升级操作。&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">sqlcipher_export</span></code><span style="font-size: 16px;">&nbsp;由于是导出而非导入，就跟&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">onCreate</span></code><span style="font-size: 16px;">&nbsp;等接口不搭了，因为要关闭原来的 DB， 打开老的 DB，执行 export 到新 DB，再重打开。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="59"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="64"><span style="font-size: 16px;">为了方便使用，WCDB 就做了扩展，将&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">sqlcipher_export</span></code><span style="font-size: 16px;">&nbsp;扩展为可以接受第二个参数表示从哪里导出， 从而实现了导入。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="64"><span style="font-size: 16px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/csvJ6rH9Mcvx9E3oHykce0icz1c1rhagqK24LzHjiaYYRib8UYxehxkcEW3NoeJouOuvVNMuZY7Y39jCLk77rIPoQ/0?wx_fmt=png" style="width: 675px !important; height: 126px !important;"></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="64"><span style="font-size: 16px;"></span><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="64"><span style="font-size: 16px;"></span><span style="font-size: 16px;">如此就可以不关闭原来的数据库实现数据导入，可以兼容&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteOpenHelper</span></code><span style="font-size: 16px;">&nbsp;的接口了。详细可以看我们的 Sample。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="74"><br></p><h1 class="" style=" padding-bottom: 0.3em; line-height: 1.2; border-bottom: 1px solid rgba(0, 0, 0, 0.180392); font-weight: normal; border-top-color: rgba(0, 0, 0, 0.180392); border-right-color: rgba(0, 0, 0, 0.180392); border-left-color: rgba(0, 0, 0, 0.180392);  color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="81"><strong><span style="font-size: 24px;">全文搜索分词器与动态 ICU 加载</span></strong></h1><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="83"><span style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  ; ; ; ; ; ; "><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="83"><span style=" color: rgb(30, 30, 30); text-transform: none; text-indent: 0px; letter-spacing: normal ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ">WCDB Android 自带了一个 FTS3/4 分词器，名为&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);  "><span style="font-size: 16px;">mmicu</span></code><span style=" color: rgb(30, 30, 30); text-transform: none; text-indent: 0px; letter-spacing: normal ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ">，用于实现&nbsp;</span><span style="font-size: 16px;">SQLite 全文搜索</span><span style=" color: rgb(30, 30, 30); text-transform: none; text-indent: 0px; letter-spacing: normal ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ">。 分词器的使用与 SQLite 自带的&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);  "><span style="font-size: 16px;">simple</span></code><span style=" color: rgb(30, 30, 30); text-transform: none; text-indent: 0px; letter-spacing: normal ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ">、</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21); font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);  "><span style="font-size: 16px;">icu</span></code><span style=" color: rgb(30, 30, 30); text-transform: none; text-indent: 0px; letter-spacing: normal ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ">&nbsp;等分词器一样，创建虚拟表的时候带上名字即可：</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="83"><span style=" color: rgb(30, 30, 30); text-transform: none; text-indent: 0px; letter-spacing: normal ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; "><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/csvJ6rH9Mcvx9E3oHykce0icz1c1rhagqAQgyjkNYRSok4WMpU2kuwRHr6mXhmc1hYeXNaRtAsIms9LYVenywDw/0?wx_fmt=png" style="width: 770px !important; height: 76.7576px !important;"><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="83"><span style=" color: rgb(30, 30, 30); text-transform: none; text-indent: 0px; letter-spacing: normal ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; "></span><span style="font-size: 16px;">MMICU 分词器与官方 ICU 分词器类似，但对中文（象形文字）分词以及 ICU 库加载做了特殊处理。 ICU 对中文的分词是基于词库的，Android 系统不同版本会附带不同版本的 ICU，捎带不同版本的中文 词库，当然也会带来不同的分词结果，这个对于统一产品体验是非常不利的。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="91"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="95"><span style="font-size: 16px;">另外，ICU 自带的中文词库并非非常完整，组词效果也一般，但若自带一个完整好用的词库， 又需要非常大的空间，这个空间会体现在 APK 体积上。最终，我们做了折中，&nbsp;<strong>中文字全部单字成词，其他文字则使用 ICU 默认规则。</strong></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="95"><span style="font-size: 16px;"><strong><br></strong></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="99"><span style="font-size: 16px;">ICU 还有一个严重的问题是动态库和自带的数据文件体积很大，超过 10MB，编译进 APK 里相当不划算， 最好能直接加载系统自带的 ICU 库。但加载系统库有另一个障碍：<strong>ICU 库不同版本会在函数名称后面 带上版本号后缀</strong>，直接编译时连接行不通。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="99"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="103"><span style="font-size: 16px;">为了克服这个障碍，WCDB 做了一个兼容层&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">icucompat</span></code><span style="font-size: 16px;">，通过系统带的数据文件推断 ICU 版本， 通过&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">dlopen</span></code><span style="font-size: 16px;">&nbsp;动态加载不同的符号名称，然后通过宏来模拟直接调用方便开发。最终实现效果便是&nbsp;<strong>在不需要自带 ICU 库的前提下使用 ICU 库的断词、归一化等功能</strong>，为最终 APK 包省下 10MB 以上空间。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="103"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="108"><span style="font-size: 16px;">有了 ICU 兼容层，要实现 Android 框架自带的 ICU 相关功能就简单了，比如&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">LOCALIZED</span></code><span style="font-size: 16px;">排序。 但是，WCDB 目前没有接入（主要是没有相关需求），有这方面需要的话，可以到我们的 GitHub 提 Issue 哦。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="108"><span style="font-size: 16px;"><br></span></p><h1 class="" style=" padding-bottom: 0.3em; line-height: 1.2; border-bottom: 1px solid rgba(0, 0, 0, 0.180392); font-weight: normal; border-top-color: rgba(0, 0, 0, 0.180392); border-right-color: rgba(0, 0, 0, 0.180392); border-left-color: rgba(0, 0, 0, 0.180392);  color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="112"><strong><span style="font-size: 24px;">日志重定向与性能监控</span></strong></h1><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="114"><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="114"><span style="font-size: 16px;">SQLite 和 WCDB 框架在运行中会产生日志，这些日志默认会打印到系统日志（logcat），但这可能不是 所有开发者都希望的行为。比如担心日志里带有敏感信息，直接输出到系统不妥，或者希望将日志写到文件 用于上报和分析，WCDB 提供接口来完成日志重定向。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="114"><span style="font-size: 16px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/csvJ6rH9Mcvx9E3oHykce0icz1c1rhagqKy8YiblV7P3J11hTqdtaR2voJkss6WMEghpicaQnH2M4XF2uAclLdbsQ/0?wx_fmt=png" style="width: 770px !important; height: 276.779px !important;"></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="114"><span style="font-size: 16px;"></span><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="114"><span style="font-size: 16px;"></span><span style="font-size: 16px;">要实现高性能日志持久化，可以考虑使用我们 mars 里面的 xlog 组件。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="114"><span style="font-size: 16px;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286403&amp;idx=1&amp;sn=7b258bc931150b93d282f2c64a4a7d08&amp;chksm=8334c381b4434a97920cd5d2a443f6c8c5c159a23bb5baf11a2018db9a2bc1b1a634a3eb0870&amp;scene=21#wechat_redirect" target="_blank">微信终端跨平台组件 mars 系列（一） - 高性能日志模块xlog</a></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="133"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="135"><span style="font-size: 16px;">WCDB 还提供了性能监控接口&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteTrace</span></code><span style="font-size: 16px;">，实现接口并绑定到&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteDatabase</span></code><span style="font-size: 16px;">&nbsp;可以在每次 执行 SQL 语句或连接池拥堵的时候得到回调。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="135"><span style="font-size: 16px;"><br></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/csvJ6rH9Mcvx9E3oHykce0icz1c1rhagq2AHrJU7XsdjFKJlWGsjSNjE5rUCdWcJyicaBx7sG97S0uibul3jVW79w/0?wx_fmt=png" style="width: 770px !important; height: 462.4px !important;"></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="135"><span style="font-size: 16px;"></span><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="135"><span style="font-size: 16px;"></span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteDatabase</span></code><span style="font-size: 16px;">&nbsp;也开放了&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">dump</span></code><span style="font-size: 16px;">&nbsp;方法，可以打印出数据库的当前状态，包括连接池内所有连接 被持有的状态以及最近执行的 SQL 语句和耗时，对排查性能和死锁问题也有很大帮助。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="165"><strong><span style="font-size: 24px;"><br></span></strong></p><h1 class="" style=" padding-bottom: 0.3em; line-height: 1.2; border-bottom: 1px solid rgba(0, 0, 0, 0.180392); font-weight: normal; border-top-color: rgba(0, 0, 0, 0.180392); border-right-color: rgba(0, 0, 0, 0.180392); border-left-color: rgba(0, 0, 0, 0.180392);  color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="168"><strong><span style="font-size: 24px;">优化 Cursor 实现</span></strong></h1><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="170"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="170"><span style="font-size: 16px;">在 WCDB 发布时，我们的一篇文章上提到 Cursor 实现优化。对于&nbsp;<strong>查询获取 Cursor → 遍历 → 关闭</strong>&nbsp;这种简单的场景，我们通过&nbsp;</span><code style="   ; ; ;  font-size: 14px; line-height: 19px; color: rgb(163, 21, 21);  "><span style="font-size: 16px;">SQLiteDirectCursor</span></code><span style="font-size: 16px;">&nbsp;直接操作 SQLite 底层的查询，避免 CursorWindow 的重复分配带来的损耗。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="170"><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="174"><span style="font-size: 16px;">可以看一下我们发布时的文章： <a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286603&amp;idx=1&amp;sn=d243dd27f2c6614631241cd00570e853&amp;chksm=8334c349b4434a5fd81809d656bfad6072f075d098cb5663a85823e94fc2363edd28758ab882&amp;scene=21#wechat_redirect" target="_blank">微信WCDB进化之路 - 开源与开始</a></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="176"><br></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="176"><span style="font-size: 16px;">需要注意的是 Direct Cursor 未关闭前会占用一个数据库连接，使用完需要尽快关闭，否则会一直占用 造成别的线程无法请求到连接。遍历 Cursor 过程中同一线程不做其他 DB 操作，遍历完关闭，配合 WAL 使用，是最佳实践。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="176"><span style="font-size: 16px;"><br></span></p><h1 class="" style=" padding-bottom: 0.3em; line-height: 1.2; border-bottom: 1px solid rgba(0, 0, 0, 0.180392); font-weight: normal; border-top-color: rgba(0, 0, 0, 0.180392); border-right-color: rgba(0, 0, 0, 0.180392); border-left-color: rgba(0, 0, 0, 0.180392);  color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="180"><strong><span style="font-size: 24px;">关注我们</span></strong></h1><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="182"><span style="font-size: 16px;"><br></span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="182"><span style="font-size: 16px;">欢迎到 GitHub 关注 WCDB 的最新动态。</span></p><p class="" style=" color: rgb(30, 30, 30) ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ; ;  " data-line="182"><span style="font-size: 16px;"></span></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/csvJ6rH9McvgYsBSDMUAdEibvxr3BhiaTRT4YUKnTVD4lf9ufehmvAWic2EvpIwUPCuB5OoJ1TO4kSYHHnF7e3jHQ/0?wx_fmt=png" style="width: 222px !important; height: 222px !important;"></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1499657001&src=3&ver=1&signature=Hv6rg8SdYuiUQmONS3uvW9frk29Hk1En3LpsHLaTv7ipZAVwDYHwVCzjmmHA4TJhC2c9oR45DNKTeFBDtusuR1VyJ431hp5BTG6k4p8WbF5kryHqDsIYi8eICbPzZJ7JRu55bAUEWTUVQfp9FEXVmu-lBooKtXLEq5--68YoBhc=">微信地址</a> | <a href="https://github.com/WeMobileDev/article/blob/master/%E5%BE%AE%E4%BF%A1%E7%A7%BB%E5%8A%A8%E7%AB%AF%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%84%E4%BB%B6WCDB%E7%B3%BB%E5%88%97%EF%BC%88%E5%9B%9B%EF%BC%89%20%E2%80%94%20Android%20%E7%89%B9%E6%80%A7%E7%AF%87.md">阅读原文</a>
{% endraw  %}

