---
title: 微信移动端数据库组件WCDB系列（一）-iOS基础篇
author: sanhuazhang
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496017364&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgDuTqaQI0bu7GAfVOHWEj6uPIzMyXc4dSRFE4UUXj4oAE8lLyA5uUNzjPbw6YHOZIC-B*OeBaQr8dVSm450X*vEnB4O3zpFi5vjMtHLXTXMsu7t1JDTMUm8RUj7UVqtA-uyhEs7MCJFictEe8yWvHFw=
date: '2017-05-24 00:00:00 +0000'

---

{% raw  %}
<p><strong><span style="font-size: 24px;">前言</span></strong></p><hr><p style="margin-top: 10px;"><strong style="line-height: 1.6;">WCDB</strong><span style="line-height: 1.6;">（</span><strong style="line-height: 1.6;">W</strong><span style="line-height: 1.6;">e</span><strong style="line-height: 1.6;">C</strong><span style="line-height: 1.6;">hat </span><strong style="line-height: 1.6;">D</strong><span style="line-height: 1.6;">ata</span><strong style="line-height: 1.6;">B</strong><span style="line-height: 1.6;">ase）是微信官方的移动端数据库组件，致力于提供一个高效、易用、完整的移动端存储方案。</span><br></p><p style="line-height: 1.75em; margin-top: 5px;">它包含三个模块：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em;">WCDB-iOS/Mac</p></li><li><p style="line-height: 1.75em;">WCDB-Android</p></li><li><p style="line-height: 1.75em;">数据库损坏修复工具WCDBRepair</p></li></ul><p style="line-height: 1.75em; margin-bottom: 15px; margin-top: 5px;">目前正在筹备开源中。</p><p><strong><span style="font-size: 24px;">背景</span></strong></p><hr><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.6;">对于iOS开发者来说，数据库的技术选型一直是个令人头痛的问题。</span></p><p style="line-height: 1.75em; margin-top: 5px;"><span style="line-height: 1.75em;">由于Apple提供的CoreData框架差强人意，使得开发者们纷纷将目光投向开源社区，寻找更好的存储方案。&nbsp;</span></p><p style="line-height: 1.75em; margin-top: 5px;">对于微信也是如此。数据库是微信内最基础的组件之一，消息收发、联系人、朋友圈等等业务都离不开数据库的支持。为了满足需求，我们也对现有方案做了对比研究：</p><p style="line-height: 1.75em; margin-top: 5px;">目前移动端数据库方案按其实现可分为两类，</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em;"><strong>关系型数据库</strong>，代表有CoreData、FMDB等。</p></li></ul><ul class="list-paddingleft-2" style="list-style-type: circle;"><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em;"><strong>CoreData &nbsp;</strong></p><p style="line-height: 1.75em;">它是苹果内建框架，和Xcode深度结合，可以很方便进行ORM；但其上手学习成本较高，不容易掌握。稳定性也堪忧，很容易crash；多线程的支持也比较鸡肋。</p></li><li><p style="line-height: 1.75em;"><strong>FMDB &nbsp; </strong></p><p style="line-height: 1.75em;">它基于SQLite封装，对于有SQLite和ObjC基础的开发者来说，简单易懂，可以直接上手；而缺点也正是在此，FMDB只是将SQLite的C接口封装成了ObjC接口，没有做太多别的优化，即所谓的胶水代码(Glue Code)。使用过程需要用大量的代码拼接SQL、拼装Object，并不方便。</p></li></ul></ul><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>key-value数据库</strong>，代表有Realm、LevelDB、RocksDB等。</p></li></ul><ul class="list-paddingleft-2" style="list-style-type: circle;"><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em;"><strong>Realm</strong></p><p style="line-height: 1.75em;">因其在各平台封装、优化的优势，比较受移动开发者的欢迎。对于iOS开发者，key-value的实现直接易懂，可以像使用NSDictionary一样使用Realm。并且ORM彻底，省去了拼装Object的过程。但其对代码侵入性很强，Realm要求类继承RLMObject的基类。这对于单继承的ObjC，意味着不能再继承其他自定义的子类。同时，key-value数据库对较为复杂的查询场景也比较无力。</p></li></ul></ul><p style="margin-top: 5px;"><span style="line-height: 1.75em;">可见，各个方案都有其独特的优势及劣势，没有最好的，只有最适合的。</span><br></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">而对于微信来说，我们所期望的数据库应满足：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>高效</strong>；增删改查的高效是数据库最基本的要求。除此之外，我们还希望能够支持多个线程高并发地操作数据库，以应对微信频繁收发消息的场景。</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>易</strong><strong>用</strong>；这是微信开源的原则，也是WCDB的原则。SQLite本不是一个易用的组件：为了完成一个查询，往往我们需要写很多拼接字符串、组装Object的胶水代码。这些代码冗长繁杂，而且容易出错，我们希望组件能统一完成这些任务。</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>完整</strong>；数据库操作是一个复杂的场景，我们希望数据库组件能完整覆盖各种场景。包括数据库损坏、监控统计、复杂的查询、反注入等。</p><p><span style="line-height: 1.75em;"></span></p></li></ul><p style="margin-top: 5px;"><span style="line-height: 1.75em;">显然，上述各个方案都不能完全满足微信的需求。</span><br></p><p style="line-height: 1.75em; margin-bottom: 15px;">于是，我们造了这个“轮子” - WCDB-iOS/Mac</p><p><span style="font-size: 24px;"><strong>WCDB-iOS/Mac</strong></span></p><hr><p style="margin-top: 10px; line-height: 1.75em;"><span style="line-height: 1.6;">WCDB-iOS/Mac（以下简称WCDB，均指代WCDB的iOS/Mac版本），是一个基于SQLite封装的Objective-C++数据库组件，提供了如下功能：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>便捷的ORM和CRUD接口</strong>：通过WCDB，开发者可以便捷地定义数据库表和索引，并且无须写一坨胶水代码拼装对象。</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>WINQ（WCDB语言集成查询）</strong>：通过WINQ，开发者无须拼接字符串，即可完成SQL的条件、排序、过滤等等语句。</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>多线程高并发</strong>：基本的增删查改等接口都支持多线程访问，开发者无需操心线程安全问题。</p></li><ul class="list-paddingleft-2" style="list-style-type: square;"><li><p style="line-height: 1.75em;">线程间读与读、读与写操作均支持并发执行。</p></li><li><p style="line-height: 1.75em;">写与写操作串行执行，并且有基于SQLite源码优化的性能提升。可参考我们分享的另一篇文章<a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286361&amp;idx=1&amp;sn=78bbcda7f41a14291ad71289e4821f71&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286361&amp;idx=1&amp;sn=78bbcda7f41a14291ad71289e4821f71&amp;scene=21#wechat_redirect">《微信iOS SQLite源码优化实践》</a></p></li></ul><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>损坏修复</strong>：数据库损坏一直是个难题，WCDB内置了我们自研的修复工具WCDBRepair。同样可参考我们分享的另一篇文章《<a href="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286467&amp;idx=1&amp;sn=ea5b6dbfecffd33e333ec814473e1313&amp;chksm=8334c3c1b4434ad7c364ff3acae1e62bc5e871a7350aa9cdcb24bd299b42875f0b020acb3620&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286467&amp;idx=1&amp;sn=ea5b6dbfecffd33e333ec814473e1313&amp;chksm=8334c3c1b4434ad7c364ff3acae1e62bc5e871a7350aa9cdcb24bd299b42875f0b020acb3620&amp;scene=21#wechat_redirect">微信 SQLite 数据库修复实践》</a></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>统计分析</strong>：WCDB提供接口直接获取SQL的执行耗时，可用于监控性能。</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><strong>反注入</strong>：WCDB框架层防止了SQL注入，以避免恶意信息危害用户数据。</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">...</p></li></ul><p style="margin-top: 10px;"><span style="line-height: 1.75em;">WCDB覆盖了数据库使用的绝大部分场景，且经过微信海量用户的验证，并将持续不断地增加新的能力。</span><br></p><p style="margin-top: 5px;"><span style="line-height: 1.75em;">本文是WCDB系列文章的第一篇，主要介绍WCDB-iOS/Mac的基本用法，包含：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin-top: 5px;">ORM、CRUD与Transaction</p></li><li><p>WINQ</p></li><li><p style="margin-bottom: 15px;">高级用法</p></li></ul><p><span style="font-size: 24px;"><strong>ORM</strong></span></p><hr><p style="margin-top: 10px; line-height: 1.75em;"><span style="line-height: 1.6;">在WCDB内，ORM（Object Relational Mapping）是指</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin-top: 5px;">将一个ObjC的类，映射到数据库的表和索引；</p></li><li><p>将类的property，映射到数据库表的字段；</p></li></ul><p style="line-height: 1.75em; margin-top: 10px;">这一过程。通过ORM，可以达到直接通过Object进行数据库操作，省去拼装过程的目的。</p><p style="line-height: 1.75em; margin-top: 5px;">WCDB通过内建的宏实现ORM的功能。如下</p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/5ce3e9e364872252130cf853b5440a801253a370.jpeg" style="width: 723px !important; height: 414px !important;"></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/9eb2ade283d0f817a90f0802625194547e9c40fc.jpeg" style="width: 696px !important; height: 390px !important;"></p><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.75em;">对于一个已有的ObjC类，</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;">引用WCDB框架头文件<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px;  background-color: rgba(0, 0, 0, 0.0392157);">#</span><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">imp</span><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;"></span><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">ort &lt;WCDB/WCDB.h&gt;</span>，并定义类遵循<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTTableCoding</span>协议</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCDB_PROPERTY</span>用于在头文件中声明绑定到数据库表的字段。</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCDB_IMPLEMENTATION</span>，用于在类文件中定义绑定到数据库表的类。同时，该宏内实现了<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTTableCoding</span>。因此，开发者无须添加更多的代码来完成<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTTableCoding</span>的接口</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCDB_SYNTHESIZE</span>，用于在类文件中定义绑定到数据库表的字段。</p></li></ul><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.75em;">简单几行代码，就完成了将类和需要的字段绑定到数据库表的过程。这三个宏在名称和使用习惯上，也都和定义一个ObjC类相似，以此便于记忆。</span><br></p><p style="line-height: 1.75em;">除此之外，WCDB还提供了许多可选的宏，用于定义数据库索引、约束等，如：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCDB_PRIMARY</span>用于定义主键</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCDB_INDEX</span>用于定义索引</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCDB_UNIQUE</span>用于定义唯一约束</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCDB_NOT_NULL</span>用于定义非空约束</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">...</p></li></ul><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.75em;">定义完成后，只需要调用</span><span style="line-height: 1.75em; color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">createTableAndIndexesOfName:withClass:</span><span style="line-height: 1.75em;">接口，即可创建表和索引。</span><br></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/5a1127e2d4aaf5cd9398b6ac11a8a3c760b3003e.jpeg" style="width: 770px !important; height: 236.173px !important;"></p><p style="line-height: 1.75em; margin-bottom: 15px;">接口会根据ORM的定义，创建对应表和索引。</p><p><span style="font-size: 24px;"><strong>CRUD</strong></span></p><hr><p style="margin-top: 10px; line-height: 1.75em;"><span style="line-height: 1.6;">得益于ORM的定义，WCDB可以直接进行通过object进行增删改查（CRUD）操作。</span><br></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/6d57d350ec120e3d221061f2a4e0e65fdf189bd1.jpeg" style="width: 760px !important; height: 281px !important;"></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/233f6e70e55a2afbdfb24746b7d89dd8f8ef553c.jpeg" style="width: 770px !important; height: 101.377px !important;"></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/21fd68879b07e9b732dbce323e79f891b69769fe.jpeg" style="width: 770px !important; height: 212.448px !important;"></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/b834aaebe4d497f911f7ee4cca172f6ccc640a59.jpeg" style="width: 770px !important; height: 97.8761px !important;"></p><p><br></p><p><span style="font-size: 24px;"><strong>Transaction</strong></span></p><hr><p style="margin-top: 10px; line-height: 1.75em;"><span style="line-height: 1.6;">WCDB内可通过两种方式执行Transaction（事务），一是</span><span style="line-height: 1.6; color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">runTransaction:</span><span style="line-height: 1.6;">接口</span><br></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/7110abe8ac0b9726444942fb94b452db0beeb36c.jpeg" style="width: 770px !important; height: 125.656px !important;"></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">这种方式要求数据库操作在一个BLOCK内完成，简单易用。</span><br></p><p style="line-height: 1.75em;">另一种方式则是获取<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTTransaction</span>对象</p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/babd7609a189cf9fc26fee598aace6cd63334aa7.jpeg" style="width: 770px !important; height: 217.179px !important;"></p><p style="line-height: 1.75em; margin-top: 5px; margin-bottom: 15px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTTransaction</span>对象可以在类或函数间传递，因此这种方式也更具灵活性。</p><p><strong><span style="font-size: 24px;">WINQ</span></strong></p><hr><p style="margin-top: 10px; line-height: 1.75em;"><span style="line-height: 1.6;">有心的同学可能会注意到上述例子中的一些特殊语法：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">where:<strong>Message.localID&gt;0</strong></span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">onProperties:<strong>Message.content</strong></span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">orderBy<strong>:Message.localID.order()</strong></span></p></li></ul><p style="margin-top: 10px;"><span style="line-height: 1.75em;">这个便是WINQ。</span><br></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">WINQ（</span><strong style="line-height: 1.75em;">W</strong><span style="line-height: 1.75em;">CDB </span><strong style="line-height: 1.75em;">In</strong><span style="line-height: 1.75em;">tegrated </span><strong style="line-height: 1.75em;">Q</strong><span style="line-height: 1.75em;">uery，音'wink'），即WCDB集成查询，是将自然查询的SQL集成到WCDB框架中的技术，基于C++实现。</span><br></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">传统的SQL语句，通常是开发者拼接字符串完成。这种方式不仅繁琐、易错，而且出错后很难定位到问题所在。同时也容易给SQL注入留下可乘之机。</span><br></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">而WINQ将查询语言集成到了C++中，可以通过类似函数调用的方式来写SQL查询。借用IDE的代码提示和编译器的语法检查，达到易用、纠错的效果。</span><br></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">对于一个已绑定ORM的类，可以通过</span><span style="line-height: 1.75em; color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">className.propertyName</span><span style="line-height: 1.75em;">的方式，获得数据库内字段的映射，以此书写SQL的条件、排序、过滤等等所有语句。如下是几个例子：</span><br></p><p><img src="/WeMobileDev/images/d45dcb79efbeee511ed7acdd13805e6e3c038b7a.jpeg" style="width: 770px !important; height: 487.867px !important;"></p><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.75em;">由于WINQ通过接口调用实现SQL查询，因此在书写过程中会有IDE的代码提示和编译器的语法检查，从而提升开发效率，避免写错。</span><br></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/dd764c04e8927c9aaeea4637aba31b474b9c7b57.jpeg" style="width: 770px !important; height: 184.569px !important;"></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/5d2bbacbdc6a96b34fcdbd5fd1d8c4a880afb978.jpeg" style="width: 770px !important; height: 91.3813px !important;"></p><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.75em;">WINQ的接口包括但不限于：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;">一元操作符：+、-、!等</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">二元操作符：||、&amp;&amp;、+、-、*、/、|、&amp;、&lt;&lt;、&gt;&gt;、&lt;、&lt;=、==、!=、&gt;、&gt;=等</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">范围比较：IN、BETWEEN等</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">字符串匹配：LIKE、GLOB、MATCH、REGEXP等</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">聚合函数：AVG、COUNT、MAX、MIN、SUM等</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">...</p></li></ul><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 15px;"><span style="line-height: 1.75em;">凡是SQLite支持的语法规则，WINQ基本都有其对应的接口。且接口名称与SQLite的语法规则基本保持一致。</span><strong style="line-height: 1.75em;">对于熟悉SQL的开发者，无须特别学习即可立刻上手使用。</strong></p><p><strong><span style="font-size: 24px;">高级用法</span></strong></p><hr><p style="margin-top: 10px;"><strong style="line-height: 1.6;"><span style="font-size: 20px;">as重定向</span></strong><br></p><p style="margin-top: 10px; line-height: 1.75em;"><span style="line-height: 1.6;">基于ORM的支持，我们可以从数据库直接取出一个Object。然而，有时候需要取出并非是某个字段，而是有一些组合。例如：</span></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/1a7a347fce64dedaf8ebb21fd0b89622a774d45e.jpeg" style="width: 770px !important; height: 81.2109px !important;"></p><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.75em;">这段代码从数据库中取出了消息的最新的修改时间，并以此将此时间作为消息的创建时间，新建了一个message。这种情况下，就可以使用as重定向。</span><br></p><p style="margin-top: 5px;"><span style="line-height: 1.75em;">as重定向，它可以将一个查询结果重定向到某一个字段，如下：</span><br></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/b81f4a5ff1576ebcb4cb43198a8961079c4bb565.jpeg" style="width: 770px !important; height: 37.2969px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 15px;">通过<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">as(Message.createTime)</span>的语法，将查询结果重新指向了createTime。因此只需一行代码便可完成原来的任务。</p><p style="line-height: 1.75em;"><span style="font-size: 20px;"><strong>链式调用</strong></span></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">链式调用是指对象的接口返回一个对象，从而允许在单个语句中将调用链接在一起，而不需要变量来存储中间结果。</span><br></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">WCDB对于增删改查操作，都提供了对应的类以实现链式调用</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTInsert</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTDelete</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTUpdate</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTSelect</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTRowSelect</span></p></li><li><p style="line-height: 1.75em; margin-bottom: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTMultiSelect</span></p></li></ul><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/94cdc0cc9e577e9aaff8a2187e3684c8162104bf.jpeg" style="width: 770px !important; height: 53.5391px !important;"></p><p style="line-height: 1.75em; margin-top: 10px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">where</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">orderBy</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">limit</span>等接口的返回值均为<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">self</span>，因此可以通过链式调用，更自然更灵活的写出对应的查询。</p><p style="margin-top: 5px;"><span style="line-height: 1.75em;">传统的接口方便快捷，可以直接获得操作结果；链式接口则更具灵活性，开发者可以获取数据库操作的耗时、错误信息；也可以通过遍历逐个生成object。</span><br></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/eba562c165c055ad6a86f19d867624b3f398455f.jpeg" style="width: 684px !important; height: 287px !important;"></p><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 15px;">WCDB内同时支持这两种接口，优势互补，开发者可以根据需求，选择使用。</p><p style="line-height: 1.75em;"><span style="font-size: 20px;"><strong>多表查询</strong></span></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">SQLite支持联表查询，在某些特定的场景下，可以起到优化性能、简化表结构的作用。</span><br></p><p style="line-height: 1.75em; margin-top: 5px;">WCDB同样提供了对应的接口，并在ORM的支持下，通过<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTMultiSelect</span>的链式接口，可以同时从表中取出多个类的对象。</p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/49168cbae65918ee03106eab4d92a070ae1b4998.jpeg" style="width: 770px !important; height: 262.883px !important;"></p><p><br></p><p style="line-height: 1.75em;"><strong><span style="font-size: 20px;">类字段绑定</span></strong></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">在ORM中，我们通过宏，将ObjC类的property绑定为数据库的一个字段。但并非所有property的类型都能绑定到字段。</span><br></p><p style="margin-top: 10px;"><span style="line-height: 1.75em;">WCDB内置支持的类型有：</span><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">const char*</span>的C字符串类型</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">包括但不限于<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">int</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">unsigned</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">long</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">unsigned long</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">long long</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">unsigned long long</span>等所有基于整型的C基本类型</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">包括但不限于<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">float</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">double</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">long double</span>等所有基于浮点型的C基本类型</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">enum</span>及所有基于枚举型的C基本类型</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSString</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSMutableString</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSData</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSMutableData</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSArray</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSMutableArray</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSDictionary</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSMutableDictionary</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSSet</span>、<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSMutableSet</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSValue</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSDate</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSNumber</span></p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSURL</span></p></li></ul><p style="line-height: 1.75em; margin-top: 10px;"><span style="line-height: 1.75em;">然而，内置支持得再多，也不可能完全覆盖开发者所有的需求。因此WCDB支持开发者自定义类字段绑定。</span><br></p><p style="margin-top: 5px;"><span style="line-height: 1.75em;">类只需实现</span><span style="line-height: 1.75em; color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">WCTColumnCoding</span><span style="line-height: 1.75em;">协议，即可支持绑定。</span><br></p><p style="line-height: 1.75em;"><img src="/WeMobileDev/images/6b6b88c06ad8c845afca94719a93506ad7734c0b.jpeg" style="width: 770px !important; height: 248.797px !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">columnTypeForWCDB</span>接口定义类对应数据库中的类型</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">unarchiveWithWCTValue:</span>接口定义从数据库类型反序列化到类的转换方式</p></li><li><p style="line-height: 1.75em; margin-top: 5px;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">archivedWCTValue</span>接口定义从类序列化到数据库类型的转换方式</p></li></ul><p style="margin-top: 10px;"><span style="line-height: 1.75em;">为了简化定义，WCDB提供了文件模版来创建类字段绑定。</span></p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p style="line-height: 1.75em; margin-top: 5px;">首先需要安装文件模版。该模版的安装脚本集成在WCDB的编译脚本中，只需编译一次WCDB，就会自动安装文件模版。安装完成后重启Xcode，新建文件，即可看到对应的文件模版<img src="/WeMobileDev/images/1c38ddaaf43d3f2da435cf6b65c8e9b37774f979.jpeg" style="width: 740px !important; height: 542.408px !important;"></p></li><li><p style="line-height: 1.75em; margin-top: 5px;">选择<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">WCTColumnCoding</span><img src="/WeMobileDev/images/b2fe51bc8a97fc2a6faf2e0dc782c735ae5a320e.jpeg" style="width: 740px !important; height: 542.408px !important;">&nbsp; &nbsp; &nbsp; &nbsp;</p></li><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="line-height: 1.75em; margin-top: 5px;">Class：需要进行字段绑定的类，这里以NSDate为例</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">Language：WCDB支持绑定ObjC类和C++类，这里选择Objective-C</p></li><li><p style="line-height: 1.75em; margin-top: 5px;">Type In DataBase：类对应数据库中的类型。包括</p></li><ul class="list-paddingleft-2" style="list-style-type: square;"><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">WCTColumnTypeInteger32</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">WCTColumnTypeInteger64</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">WCTColumnTypeDouble</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">WCTColumnTypeString</span></p></li><li><p style="line-height: 1.75em;"><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);"></span><span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px; background-color: rgba(0, 0, 0, 0.0392157);">WCTColumnTypeBinary</span></p></li></ul><p><br></p></ul><li><p style="line-height: 1.75em;">我们知道<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">N<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; font-size: 16px;  background-color: rgba(0, 0, 0, 0.0392157);">S</span>Date</span>是遵循<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSCoding</span>协议的，因此这里选择了Binary类型。即，将<span style="color: rgb(51, 51, 51); font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, source-code-pro, monospace; background-color: rgba(0, 0, 0, 0.0392157); font-size: 16px;">NSDate</span>以二进制数据的形式存到数据库中。完成后会自动创建如下的文件模版：<img src="/WeMobileDev/images/9066c7ef9b9f76c29fb0df6153941535fd34a55e.jpeg" style="width: 740px !important; height: 554.334px !important;"></p></li><li><p style="line-height: 1.75em; margin-top: 10px; margin-bottom: 15px;">然后只需将NSDate和NSData互相转换的方式填上去即可。如下：<img src="/WeMobileDev/images/2e749f5fe01a0eb268cb7c27497dfbf0be15733d.jpeg" style="width: 740px !important; height: 367.933px !important;"></p></li></ol><p><span style="font-size: 24px;"><strong>总结</strong></span></p><hr><p style="margin-top: 10px; line-height: 1.75em;"><span style="line-height: 1.6;">WCDB通过ORM和WINQ，体现了其易用性上的优势，使得数据库操作不再繁杂。同时，通过链式调用，开发者也能够方便地获取数据库操作的耗时等性能信息。而高级用法则扩展了WCDB的功能和用法。</span></p><p style="line-height: 1.75em; margin-top: 5px;">由于篇幅所限，本文只介绍了WCDB最表层的功能。该系列接下来还将深入介绍WCDB的架构和原理，分享WCDB高并发的解决方案、WINQ实现中的思考等等。敬请期待！</p><p style="line-height: 1.75em;"><br></p><p><img src="/WeMobileDev/images/529bda16fcbe2c3269dc006f37eab57e31c3c8c1.png" style="width: 689px !important; height: 600px !important;"></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496017364&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgDuTqaQI0bu7GAfVOHWEj6uPIzMyXc4dSRFE4UUXj4oAE8lLyA5uUNzjPbw6YHOZIC-B*OeBaQr8dVSm450X*vEnB4O3zpFi5vjMtHLXTXMsu7t1JDTMUm8RUj7UVqtA-uyhEs7MCJFictEe8yWvHFw=">微信地址</a> | <a href="https://github.com/WeMobileDev/article/blob/master/微信移动端数据库组件WCDB系列（一）-iOS基础篇.md">阅读原文</a>
{% endraw  %}

