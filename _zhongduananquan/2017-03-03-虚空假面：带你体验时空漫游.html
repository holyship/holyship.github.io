---
title: 虚空假面：带你体验时空漫游
author: 李存宽
date: '2017-03-03 00:00:00 +0000'

---

{% raw  %}
<h2 style="margin-top: 5px;"><strong><span style="font-size: 22px;">前言</span></strong></h2><p style="margin-top: 15px;">玩过DOTA的人都知道，Dota里面有个特别牛逼的英雄叫<strong>虚空假面</strong>。虚空假面这个英雄很有意思，它的技能都是和时间有关，可以将时间停住，甚至倒流。</p><p style="margin-top: 15px;">最近脑洞大开想到一个有意思的点子，将系统事件录制回放从而进行自动化测试，然后将它做成了一个辅助工问题场景重现或者具，以虚空假面命名是取其操控时间的相似之处。现在抛砖引玉和大家分享一下。</p><p><br></p><h2 style="margin-top: 15px;"><strong><span style="font-size: 22px;">一 / 工具介绍</span></strong></h2><p style="margin-top: 15px;"><strong>“虚空假面”</strong>是基于注入技术实现的辅助工具，目前是围绕WiFi场景重现来进行搭建的。</p><p style="margin-top: 15px;">我们来看看它能做什么：</p><p><br></p><h3 style="margin-top: 15px;"><strong><span style="font-size: 18px;">1、重现Bug场景</span></strong></h3><p style="margin-top: 15px;">举个例子，我用虚空假面录制了一段事件，包含了在已连接WiFiXXX的情况下，WiFi XXX信号消失的过程。然后在一台手机中，使用虚空假面进行回放（注意，在回放过程中这台手机的WiFi开关全程是关闭的）。</p><p style="margin-top: 15px;">&nbsp;假设在这个场景中我们发现了WiFi管家出现Bug，那么就可以利用虚空假面进行反复回放来调试问题。通过虚空假面的应用，能有效减少类似这种对话出现的场景：</p><blockquote><p style="margin-top: 15px;">A童鞋：明明系统已连上WiFi，WiFi管家却显示未连接WiFi，赶紧看看怎么一回事！</p><p style="margin-top: 5px;">开发GG：好。当时连接的WiFi ssid、bssid是怎样的，之前有做什么连接操作吗？</p><p style="margin-top: 5px;">A童鞋：不记得了，偶然发现的。<br>开发GG：手机上有没有安装竞对？竞对表现如何？</p><p style="margin-top: 5px;">A童鞋：没安装。<br>开发GG：好吧，你这个是正式包没法调试。那我试试重新进入界面，咦还是有问题。我再试试杀掉界面重新进入，咦怎么恢复正常了。</p><p style="margin-top: 5px;">A童鞋：囧。。。</p></blockquote><p><br></p><h3 style="margin-top: 15px;"><strong><span style="font-size: 18px;">2、自动化测试</span></strong></h3><p style="margin-top: 15px;">传统的自动化测试，主要是通过<strong>UIAutomator</strong>等测试工具，对人的操作行为进行模拟。这种方法有一个不足，缺乏对系统环境的模拟能力。举个例子，一个是以地理位置为要素的需求，传统的自动化测试比较难覆盖到。</p><p style="margin-top: 15px;">通过虚空假面可以弥补这个不足，因为我们可以通过预录制/编排的方式，将系统环境录制下来，再结合自动化测试在适当的时机回放。这样自动化测试覆盖的场景能够得以扩充。</p><p><br></p><h2 style="margin-top: 15px;"><strong><span style="font-size: 22px;">二 / 实现原理</span></strong></h2><p style="margin-top: 15px;">在Android系统中，通过注入技术能改变任意进程的运行方式，其应用场景非常广泛，笔者接触过的就有通知栏管理、短信入口抢占、短信拦截等等。虚空假面也是基于注入实现的，因为这样不需要在重现问题或自动化测试时换包。</p><p style="margin-top: 15px;">另外，虚空假面的核心能力是录制和回放，我们期望在无ROOT环境至少能在本进程进行录制，有ROOT环境下能够在任意进程进行录制和回放。此外基于代码开源，可以顺便学习研究的考虑，虚空假面引入了<strong>Deposed框架</strong>。</p><p><br></p><h3 style="margin-top: 15px;"><strong><span style="font-size: 18px;">1、Dexposed介绍</span></strong></h3><p style="margin-top: 15px;">Dexposed是基于久负盛名的开源Xposed框架实现的一个Android平台上功能强大的无侵入式运行时APO框架。常见的使用场景是无ROOT下实现热补丁机制。</p><p style="margin-top: 15px;">它的原理是：在native层中先找到要修复的Java函数对应的Method对象，修改它变为native方法，把它的nativeFunc指向hookedMethodCallback。这样对这个java函数的调用就转为调用hookedMethodCallback这个native函数了，然后再用这个native函数回调java层自己实现的统一接口来处理。</p><p style="margin-top: 15px;">由于本文篇幅有限，Dexposed就不展开介绍了。网上有很多文章，大家感兴趣可以另行了解。</p><p><br></p><h3 style="margin-top: 15px;"><strong><span style="font-size: 18px;">2、数据封装方法</span></strong></h3><p style="margin-top: 15px;">虚空假面支持录制回放的内容包括系统接口、系统广播。<br>为方便统一控制，将将可录制回放的内容抽象成AbsHpEvent基类，它定义了所有事件的基本属性：</p><p style="margin-top: 15px;"><strong>1、mStartDelay用于控制回放的时间</strong></p><p style="margin-top: 15px;"><strong>2、getKey函数用于建立回放埋点与录制内容的映射关系。</strong>其中，对于接口事件，是以接口类名、类方法为key；对于广播事件，是以广播action为key。</p><p style="margin-top: 15px;"><strong>3、</strong>writeToJsonString、readFromJsonString这对函数，顾名思义是<strong>将整个事件实体以Json格式进行序列化和反序列化</strong>的方法（使用Json格式是为了让录制生成的文件可以直观察看）。<br></p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/8a476cf2326949051ceeb1c3a381f08936351ca6.png" style="width: 648px !important; height: 720px !important;"></p><p style="margin-top: 15px;">上图可以看到，工具为了支持多样的事件，进行了各种派生。<br>为辅助HpEvent的序列化、反序列化，我们还定义了一些常见的解析器：</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/fb116669e6c161fda3720cd10e33278e05311cb9.png" style="width: 503px !important; height: 509px !important;"></p><p style="margin-top: 15px;">其中ParcelParser较为常见，毕竟无论是系统接口还是系统广播，基本都要进行跨进程传递。所以数据实体除了基本数据类型，都实现了Parcel接口。Parcel格式的转换比较简单，直接利用Parcel的marshall和unmarshall方面转换就可以了。</p><p><img src="/zhongduananquan/images/eaf15db6318276d2fd4cc4094318f321a0491a62.png" style="width: 770px !important; height: 169.813px !important;"></p><h3 style="margin-top: 15px;"><strong><span style="font-size: 18px;">3、录制方案</span></strong></h3><p style="margin-top: 15px;">虚空假面的录制事件功能，目的是把一段时间内的系统接口状态、广播事件转成HpEvent，然后以文件的方式持久化，以便后面方便地从文件回放这些事件。</p><p style="margin-top: 15px;">大家可以想像，系统的接口所返回的值，变化频繁且难以捕捉，并且有些系统接口还能接收入参得出不同的结果。</p><p style="margin-top: 15px;">现阶段的虚空假面将录制模型进行了简化。首先放弃能接收入参的方法（或者直接忽略入参返回固定结果）。另外我们假定常见的系统接口变化，都与系统广播有直接联系。举个例子，当系统发送连接状态变化广播时，意味着对应的WifiManager.isWifiEnabled()、ConnectivityManager.getNetworkInfo()、ConectivityManager.getActivieNetworkInfo()等关联接口的状态也相应变化。所以录制的思路，是在接收系统广播事件的同时，将关联的接口变化事件也记录下来。</p><p style="margin-top: 15px;">这样简化后，对于WiFi环境的记录、重现已经足够，其他场景可能还需要进一步扩展。</p><p style="margin-top: 15px;">另外还有个考量，我们录制的对象是系统接口、系统广播，在工具内完成可以直接获取到这些信息。所以只要在本进程实现就可以了，不需要使用注入能力。<br><br>虚空假面支持的录制方式有三种：<strong>手动录制、自动录制、手动编排</strong>。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/5f3fce39ba2bf6407b952f092d2c03c148196dd7.png" style="width: 563px !important; height: 502px !important;"></p><p style="margin-top: 15px;">这里重点介绍下手动录制和自动录制。</p><p style="margin-top: 15px;">手动录制适合发现必现问题时先记录下来等后续跟进，或者准备自动化测试的素材时使用。</p><p style="margin-top: 15px;">在进行手动录制前，我们已经在工具中注册了关心的广播，及广播绑定的接口。</p><p style="margin-top: 15px;">以针对WiFi事件进行录制为例：</p><p><img src="/zhongduananquan/images/89d1002486552d5bb4ef36703143bb02cc88ce44.png" style="width: 770px !important; height: 207.765px !important;"></p><p style="margin-top: 15px;">当进行手动录制时，在工具内部动态注册这些广播监听，每接收到系统广播就产生对应的变化事件，从而生成上一章介绍的数据封装实体，并写入到文件中。（考虑到时序问题，需要先记录广播绑定的接口变化事件，再记录广播事件）</p><p style="margin-top: 15px;">自动录制则适合记录偶现的问题，以方便重现。</p><p style="margin-top: 15px;">自动录制是在工具保活的情况下，持续去监听关心的广播。目前设计成自动保存5分钟内所有广播、接口状态。当发现Bug出现时，需要手动进入工具结束录制以保存记录。</p><p style="margin-top: 15px;">在缓存自动录制结果的过程中，为了保证数据一致性，定义了事件录制窗口的概念：</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/934bba61cd8a84588d4a7b15a8a2d3f5bd49e530.png" style="width: 770px !important; height: 241.775px !important;"></p><p style="margin-top: 15px;">如上图所示，随着时间轴前进，会产生诸如“事件1”、“事件2”等HpEvent。我们的事件录制窗口记录了当前5分钟内的所有事件。当事件录制窗口随时间流逝向右偏移，那么部分事件因过期会从录制窗口移出，如“事件1”，这时我们将它囊括的接口状态及时刷新到缓存队尾中。</p><p style="margin-top: 15px;">通过这样的设计，队尾会固定保存录制窗口左侧的所有系统接口的最新状态，这样就能保证后面回放时，所有系统接口状态的初始状态能够准确记录下来。</p><h3 style="margin-top: 15px;"><span style="font-size: 18px;"><strong>4、回放方案</strong></span></h3><p style="margin-top: 15px;">回放功能是虚空假面最核心的部分，回放分成两种：<strong>工具内回放</strong>和<strong>向任意进程回放</strong>。这两种回放有着不同的用处。</p><p style="margin-top: 15px;">工具内回放不需要ROOT，通常作用是针对Bug环境录制后进行回放，让我们快速地知道发生了什么事情。</p><p style="margin-top: 15px;">向任意进程回放需要ROOT，通常作用是自动化测试，以及观察BUG发生时产品的表现情况，当然也可以方便地对应用进行调试。</p><p style="margin-top: 15px;">无论是工具内回放还是向任意进程回放，思路都是相同的：</p><p style="margin-top: 15px;"><strong>·&nbsp; 针对系统接口的回放</strong></p><p style="margin-top: 15px;">我们通过HOOK掉这些函数，从而根据播放进度来控制函数的回参。对于工具内回放，基于Dexposed框架进行本进程的函数HOOK。对于向任意进程回放，需要依赖Xposed框架注入全世界的能力，HOOK掉目标进程的函数。核心代码如下：</p><p><img src="/zhongduananquan/images/85174c124c4bcbb960bc1846c57ffb6df3809f29.png" style="width: 770px !important; height: 316.284px !important;"></p><p style="margin-top: 15px;">FakeEventCacheManager以className+methodName为key缓存了接口事件的最新状态。回放时以时间顺序将记录文件中的事件一 一取出，并根据其录制时的mStartTime定时处理。处理时将状态刷新到FakeEventCacheManager中。如果回放过程中其他地方正好调用了这个接口，其回参就会被劫持成这个虚假的状态。</p><p style="margin-top: 15px;"><strong>·&nbsp; 针对广播事件的回放</strong></p><p style="margin-top: 15px;">对于动态注册的广播接收器，我们在目标进程启动的第一时间就HOOK掉广播注册函数，发现有地方进行针对的广播action注册时，就做一层代理，将我们的代理接收器注册到系统中：</p><p><img src="/zhongduananquan/images/c558d5ba8ce1f48486ecbb0ccd2eb87dd6565931.png" style="width: 770px !important; height: 546.657px !important;"></p><p style="margin-top: 15px;">将这个代理注册到系统的目的是，在回放过程中屏蔽系统的正常广播事件。然后在回放广播事件时，我们以action为key从FakeEventCacheManager中取出所有真实的receiver，主动调用其onReceiver函数。</p><p style="margin-top: 15px;">对于静态注册的广播接收器，每次进行事件回放时，就直接反射创建一个新的receiver来调用其onReceiver函数。</p><p style="margin-top: 15px;">整个回放模块目前是基于隐式广播来进行控制开启和结束的。入参包括目标进程、待播放的文件路径。这样也便于自动化工具进行接入。</p><p style="margin-top: 15px;"><br></p><h2 style="margin-top: 15px;"><strong><span style="font-size: 22px;">三、结语</span></strong></h2><p style="margin-top: 15px;">WiFi管家经常面临问题场景难以重现、上线前测试因涉及诸多外部环境难以实施自动化测试等痛点，使用虚空假面工具是一个不错的补充。后续也会持续优化并推广使用，协助WiFi管家提升功能的稳定性。</p><p style="margin-top: 15px;">感谢小性、BK、胸毛等同事在文章撰写过程提供的建议和意见。</p><p style="margin-top: 15px;">&nbsp;</p><p style="margin-top: 15px; white-space: normal;"><span style="color: rgb(0, 176, 240); font-family: 宋体; font-size: 14px; white-space: pre-wrap;">✎ 如果您想了解更多关于移动终端安全的内容，请收听我们的</span><strong style="color: rgb(0, 176, 240); font-family: 宋体; font-size: 14px; white-space: pre-wrap; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">微信公众号(终端安全那些事儿)</strong><span style="color: rgb(0, 176, 240); font-family: 宋体; font-size: 14px; white-space: pre-wrap;">，我们将定期为您分享；</span><br></p><p style="white-space: normal; line-height: 25.6px; color: rgb(62, 62, 62); font-family: Verdana, 宋体, sans-serif; min-height: 1em; border: 0px; list-style: none; word-break: normal; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="color: rgb(0, 176, 240); font-family: 宋体; line-height: 22.5px; word-break: normal; font-size: 14px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">✎ 如果您对移动终端安全有什么问题和建议，关注我们的公众账号后直接回复消息联系我们。</span></p><p style="white-space: normal; line-height: 25.6px; color: rgb(62, 62, 62); font-family: Verdana, 宋体, sans-serif; min-height: 1em; border: 0px; list-style: none; word-break: normal; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="color: rgb(0, 176, 240); font-family: 宋体; line-height: 22.5px; word-break: normal; font-size: 14px; max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><br></span></p><p style="margin-bottom: 10px; white-space: normal; line-height: 25.6px; text-align: center;"><span style="max-width: 100%; color: rgb(0, 176, 240); box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 12px; box-sizing: border-box !important; word-wrap: break-word !important;">终端安全那些事儿&nbsp;</span></strong></span><span style="max-width: 100%; color: rgb(0, 176, 240); font-size: 12px; box-sizing: border-box !important; word-wrap: break-word !important;">汇聚最优影响力的安全技术文章</span></p><p style="white-space: normal; line-height: 25.6px; text-align: center;"><img src="/zhongduananquan/images/a1c02648331a7d53620c4031cfba35723042669a.png" style="width: 138px !important; height: 137px !important;"></p><p style="white-space: normal; line-height: 25.6px; text-align: center;"><span style="color: rgb(0, 176, 240); font-size: 11px;">▲长按二维码可识别关注</span></p><p><br></p>
{% endraw  %}

