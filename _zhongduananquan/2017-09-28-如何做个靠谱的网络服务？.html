---
title: 如何做个靠谱的网络服务？
author: 詹勋昌
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1512889106&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKIQC8ajyzJPAXQ2hw4mnWo*7Zo-jG5kifamqpZ0653aYghqzw89XhHbfifuGLho5rU2Qwz2HqiiqaDhsI2K34xHxu072YtPCAzckEcLOpQdwf2sRXphPj*oaKidDAxmRek0RW7IvnvOhJuQqz*UdflM=
date: '2017-09-28 00:00:00 +0000'

---

{% raw  %}
<p style="margin-bottom: 15px;">关于网络优化的技术文章非常多，大家看到最多的可能是弱网络下如何提高请求的成功率或者模拟弱网络环境进行测试等。这方面已经有很多优秀的内容了，笔者试图从另一个角度切入，结合腾讯手机管家Android在移动网络方面的实践谈谈怎么做一个靠谱的网络服务。</p><p><br></p><h1 style="margin-bottom: 15px;"><strong><span style="font-size: 20px;">0 / 背景知识</span></strong></h1><p style="margin-bottom: 15px;">手机管家的客户端网络模块叫做Shark，与之对接的后台接入层叫做Mazu，两者在客户端和服务器之间为上层业务提供了统一的网络通道。由于二者有着非常紧密的联系，本文将二者统一称为Shark网络服务。</p><p style="margin-bottom: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/Sa7mwT4mK88MibQ60gtHWesUjNs6zhaTtFa1ct07bhUPJaiamheiaakWRfVibWBWPC80Dntdtq0p9ibAHQAY90Qd5eQ/0?wx_fmt=png" style="width: 770px !important; height: 425.902px !important; visibility: visible !important;"></p><p style="margin-bottom: 15px;">以下是我们在做Shark网络服务的过程中总结出来的，一个靠谱的网络服务应该考虑的几个点。</p><p><br></p><h1 style="margin-bottom: 15px;"><strong><span style="font-size: 20px;">1 / 安全</span></strong></h1><p style="margin-bottom: 15px;">网络通道的安全性是首要考虑的因素，在Shark中，我们做了以下几个事情。</p><h2 style="margin-bottom: 15px;"><strong>1)动态密钥</strong></h2><p style="margin-bottom: 15px;">Shark综合考虑安全和性能问题，采用了业界主流的对称加密与非对称加密结合的方案。即利用RSA非对称加密算法交换密钥，再用对称加密算法加密数据。这里为了防止暴力破解，密钥要有过期机制，且过期之后能够自动更新。RSA公钥的强度需要达到1024bit才能认为足够安全，因为当前可以被破解的最高强度是768bit。Shark交换密钥的流程如下图所示。</p><p style="margin-bottom: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/Sa7mwT4mK88MibQ60gtHWesUjNs6zhaTtJQKVz9seLudzUS5YNuPaFfG9gKicunceCyOpsDPibeuiaPV33r3osyFww/0?wx_fmt=png" style="width: 770px !important; height: 335.641px !important;"></p><p style="margin-bottom: 15px;">过程描述：</p><p style="margin-bottom: 15px;">a.当终端本地没有密钥或密钥过期，则发起交换密钥请求；</p><p style="margin-bottom: 15px;">b.终端随机生成一个密钥randomKey，用RSA算法对公钥非对称加密后，发送给服务器；</p><p style="margin-bottom: 15px;">c.后台接入层用对应的私钥解密得到randomKey，并为其分配一个标识SA，存储SA-randomKey的对应关系，将SA返回给终端；</p><p style="margin-bottom: 15px;">d.终端收到响应后，后续每次请求都带上该标识SA，并用之前随机生成的randomKey和对称算法加密数据；</p><p style="margin-bottom: 15px;">e.后台接入层收到请求后，根据携带的SA映射到randomKey，用randomKey和对称算法解密数据，然后发给后端服务。</p><h2 style="margin-bottom: 15px;"><strong>2)协议可混淆</strong></h2><p style="margin-bottom: 15px;">Java是一门很容易反编译的语言，如果协议字段不能混淆则很容易被破解。老的jce协议在序列化的时候把协议的字段名也作为序列化的一部分，会使得通信协议无法混淆，而Shark使用了jce的v3版本则可以避免这个问题。</p><h2 style="margin-bottom: 15px;"><strong>3)IP直连</strong></h2><p style="margin-bottom: 15px;">众所周知，如果使用域名连接，首先需要把域名解析成ip地址，这个过程有可能受到域名劫持风险。Shark使用IP直连的方式，既省去了解析域名的耗时，也能防止域名劫持的情况。所谓IP直连就是通过直接使用云端下发的IP+端口列表（IPLIST）绕过域名解析。实际工作过程如下：</p><p style="margin-bottom: 15px;">a.客户端首次使用域名或内置的默认ip进行连接；</p><p style="margin-bottom: 15px;">b.建立连接后，由后台对当前的连接信息（APN、地区、网络类型等）选择最优的调度策略，并通过PUSH通道下发相应的IPLIST。</p><p style="margin-bottom: 15px;">c.终端在获取到IPLIST之后，按APN(WIFI情况下为SSID)为KEY保存起来(实际使用中还要区分正式环境和测试环境)。</p><p style="margin-bottom: 15px;">d.在下一次连接或网络切换时，根据APN(WIFI情况下为SSID)选择对应的IPLIST进行连接。</p><p style="margin-bottom: 15px;">调度策略是由Halley调度系统经过自动测速、异地容灾、负载均衡等一系列计算得到的最优接入方案。为了保证尽可能的可用，每组IPLIST实际上会包含多个IP和端口的组合，客户端在单次请求中以轮循的方式尝试IPLIST中的IP和端口组合，直至连接成功。若尝试完所有IP都失败，则可以ping一下大型域名（例如www.qq.com）以判断网络是否连通，通过此上报此类错误可以排除网络不通导致失败的客观情况。另外，为了保证可用性，下发的IPLIST都需要设定有效期，超过有效期后则使用域名或默认的ip进行连接，而正常情况下后台会在其过期之前下发更新以保证一直是在有效期内。</p><p style="margin-bottom: 15px;">&nbsp;</p><h1 style="margin-bottom: 15px;"><strong><span style="font-size: 20px;">2 / 稳定可用</span></strong></h1><p style="margin-bottom: 15px;">Shark做了以下事情来保证通道是稳定可用的。</p><p style="margin-bottom: 15px;"><strong>1)独立进程</strong>：如果应用需要保持长连接，则需要一个稳定的后台进程，尽可能保证这个进程的存活。</p><p style="margin-bottom: 15px;"><strong>2)长连接保活</strong>：长连接需要通过发心跳包来保活。Shark终端采用比较通用的4.5分钟一次心跳的机制，当心跳无响应时进行重连。同时后台也会做定期的探测，对于已经僵死的连接主动清理，触发终端重连。</p><p style="margin-bottom: 15px;"><strong>3)监控网络变化</strong>：移动互联网的不稳定在于手机在不断移动中，因此随时可能进入一个没有网络的环境。终端需要监控网络变化，在网络切换后主动断开重连。</p><p style="margin-bottom: 15px;"><strong>4)网络探测</strong>：对于Wifi网络，常常会出现需要认证的WiFi或者只是有WiFi信号实际是不通的，这时需要增加是否需要认证的判断或进行网络探测，出现这种情况时不应该重试以免加大功耗。</p><p style="margin-bottom: 15px;"><strong>5)长短连接并用</strong>：Shark是双通道的，支持TCP和HTTP。对于普通信令，由于流量非常小，优先用TCP通道发送，发送失败时再用HTTP通道发送。对于一些流量比较大的业务，支持由业务侧指定用HTTP通道发送。</p><p style="margin-bottom: 15px;"><strong>6)权限引导</strong>：通过建立连接的错误堆栈上报，我们发现有部分一部分用户可能会禁止我们我们的联网权限。其中比较多是利用一些系统自带的网络管理软件，比如小米系统有一个联网防火墙功能。一些安全类软件也有此功能。这个时候可以做些引导，通过提醒用户禁止联网权限会影响什么功能，并引导用户跳转到相应的设置页面重新开启联网权限。</p><p><br></p><h1 style="margin-bottom: 15px;"><strong><span style="font-size: 20px;">3 / 省流量</span></strong></h1><p style="margin-bottom: 15px;">在业务需求一定的情况下，Shark力求流量尽可能小，在这方面可以考虑做以下事情。</p><h2 style="margin-bottom: 15px;"><strong>1)使用二进制协议</strong></h2><p style="margin-bottom: 15px;">在流量方面二进制协议比起文本协议优势明显。我们发现外面有很多小公司的产品是使用Json或者XML作为通信协议的，如果你的产品也在使用，赶紧换成二进制协议吧。Shark使用的是MIG通用的jce协议，其作用类似于ProtocolBuffer。</p><h2 style="margin-bottom: 15px;"><strong>2)压缩</strong></h2><p style="margin-bottom: 15px;">对发送的数据做压缩是最常规的省流量方法。压缩算法有很多，根据自己的需要综合考量性能和压缩比选择即可。当然，通讯的对方需要能还原，所以必须是选择无损压缩算法。Shark使用的是deflate压缩算法。有意思的是，并不是任何时候压缩之后流量就会更少，有时候是反而大过压缩前的，这时候我们会选择不压缩，并通过一个标记位告知对方是否做了压缩，终端和接入层都有这个逻辑。</p><h2 style="margin-bottom: 15px;"><strong>3)公共属性上提，且做session管理</strong></h2><p style="margin-bottom: 15px;">由于各种原因，很多时候需要带上一些常用的用户属性，比如用户的imei、产品的版本号、build号等。一般的做法可能是定义一个结构把这些信息包含进去，然后每个请求者带上来。随着业务需求越来越多，这个结构会不断膨胀，最后变成一个庞然大物，序列化后占用的流量甚至可能超出实际业务的数据。</p><p style="margin-bottom: 15px;">在Shark协议中，我们将这些常用的用户属性分为稳定属性和易变属性。稳定属性通过注册GUID一次性上报到云端，后台接入层将GUID和这些属性关联起来，此后每个请求只需要带上GUID即可，由接入层通过GUID将常用字段反查出来携带给后端的服务。易变属性相对稳定属性而言更有可能发生变化，我们一个用统一的Sharkfin结构表示，由Shark框架统一携带，业务也不需要关心。对于长连接，我们还可以将Sharkfin结构和物理连接（即一个session）进行关联，对于同一个session，终端和后台接入层一起对Sharkfin做管理。除了首包需要携带Sharkfin外，在发送其他业务包时，由Shark框架自动判断Sharkfin是否发生了变化，只有实际发生变化时才需要携带，而且整个过程完全由框架完成。</p><h2 style="margin-bottom: 15px;"><strong>4)心跳包协议最简</strong></h2><p style="margin-bottom: 15px;">对于长连接，需要不断发心跳包来给链路做保活。关于心跳包的知识这里不作展开，有兴趣的同学请自行查阅。这里需要说明的是，心跳包只是为了维持长连接，其内容并无实际的作用。因此，在兼容协议格式的基础上可以将流量压到最小，在Shark中，心跳包的数据部分只保留了一个字节作为序列号。</p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/Sa7mwT4mK88MibQ60gtHWesUjNs6zhaTtfJG7adZVpY7vNMVWEtfHeFdI7Lic4MDYgweY9XdBZbwpsAY0Kmfpw6g/0?wx_fmt=png" style="width: 770px !important; height: 467.715px !important;"></p><h2 style="margin-bottom: 15px;"><strong>5)合包发送</strong></h2><p style="margin-bottom: 5px;">前面提到，每个请求总避免不了一些公共的字段要上报，同时在应用层之下还有tcp头和ip头要携带，因此在可能的情况下可以考虑将连续的请求包合并成一条发送。对于手管，由于大部分业务的请求数据都非常小，合并请求是非常值得的。</p><p style="margin-bottom: 10px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/Sa7mwT4mK88MibQ60gtHWesUjNs6zhaTtYcft1J0QbicssRiaSOv1qGPSwB0bmqwAic2MzibyUwsTd9au5joRtsdSjg/0?wx_fmt=png" style="width: 652px !important; height: 191px !important;"></p><p style="margin-bottom: 15px;"><strong><span style="font-size: 16px;">6)有损服务</span></strong></p><p style="margin-bottom: 15px;">关于这一点，实际上Shark并没有做具体的事情，在这里提出来只是觉得这也是一个非常实用的方法。建议业务侧按需使用。例如，涉及到图片的上传下载时，可以根据网速和设备性能选择不同质量的图片。</p><p style="margin-bottom: 15px;">&nbsp;</p><h1 style="margin-bottom: 15px;"><strong><span style="font-size: 20px;">4 / 快</span></strong></h1><p style="margin-bottom: 15px;">对手管来说，其实对快的要求并不是特别高，因为手管不是一个IM类的应用，因此在建立连接的时候并没有使用并发连接或微信那种复合连接的方式。这一点上我们主要只是通过IP直连节省掉域名解析的耗时。</p><p style="margin-bottom: 15px;">快的另一层含义是快速触达用户，这一点对于大型应用来说是必备的。对于手管来说也一样，比如我们发现了一个最新的病毒，并且判断一个用户有可能受到威胁，那么我们希望尽快告知用户以帮助他及时消除风险。为了快速触达用户，不能依靠用户主动操作或客户端定期请求的方式，而要有云端主动推送的能力（PUSH服务）。为了支持PUSH，终端与后台就需要维持TCP长连接。但手管和微信、手Q等IM应用不同，手管的PUSH并不要求完全的实时，因此综合考量性能和实时性后，我们使用一种叫半长连接的机制，即连一段时间断开一段时间。这样在准实时的同时可以减少心跳包的流量消耗和电量消耗。并且联网策略是云端可控的。</p><p><br></p><h1 style="margin-bottom: 15px;"><span style="font-size: 20px;"><strong>5 / 云端可控</strong></span></h1><p style="margin-bottom: 15px;">Shark的联网策略支持云端调控，可以根据每个业务的需要随时调整半长连接的规则或网络参数如默认超时、心跳间隔等。使用的IPLIST也是由云端下发的。另外，每个业务用一个整型的命令字表示，当发现有异常时可以关闭某个命令字。</p><p><br></p><h1 style="margin-bottom: 15px;"><span style="font-size: 20px;"><strong>6 / 低功耗</strong></span></h1><p style="margin-bottom: 15px;">根据测试shark消耗的电量和流量都是非常小的，这主要得益于我们根据手管结合自身的特点特别做了半长连接而不是完全的长连接。值得一提的是，由于保持长连接的心跳包需要定时喊醒cpu，主要的功耗问题一般会发生在这里，对于需要保持长连接的应用，可以考虑实现类似微信的智能心跳策略。</p><p><br></p><h1 style="margin-bottom: 15px;"><strong><span style="font-size: 20px;">7 / 质量监控</span></strong></h1><p style="margin-bottom: 15px;">网络服务作为一个基础服务，需要保证其质量稳定，监控并快速发现问题的重要性不言而喻，因此从后台到终端者要有完善的质量监控体系。</p><h2 style="margin-bottom: 15px;"><strong>1)错误码划分要清晰而具体</strong></h2><p style="margin-bottom: 15px;">清晰而具体的错误码对于定位问题非常有帮助。Shark服务对错误码的划分是：0-成功，正数-后台服务的错误码，负数-终端的错误码。另外，通道错误和具体业务的错误也分开，用retCode表示Shark通道的错误，dataRetCode表示业务的错误。以终端的错误码为例，根据构架分层和逻辑将错误码分为几段，使得通过一个错误码即可定位到某一行代码。</p><p style="margin-bottom: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/Sa7mwT4mK88MibQ60gtHWesUjNs6zhaTtDbZ8jMb2OaXWl08PSlRqXWKpjA4QcoNzd2gzVzXh1mclEQeGIL9kbA/0?wx_fmt=png" style="width: 472px !important; height: 173px !important;"></p><h2 style="margin-bottom: 15px;"><strong>2)监控覆盖后台和终端各个环节</strong></h2><p style="margin-bottom: 15px;">对于Shark，终端监控每个命令字的成功率，Mazu监控实时在线用户数并可以查到某个设备的每一次请求情况，运维监控调度策略（IPLIST）的跨网率和连接成功率等。</p><p><br></p><h1 style="margin-bottom: 15px;"><span style="font-size: 20px;"><strong>8 / 易用</strong></span></h1><p style="margin-bottom: 15px;">一个靠谱的网络服务，除了质量要好，还应该是容易使用的。对于Shark，在以下方面力求做到好用。</p><h2 style="margin-bottom: 15px;"><strong>1)</strong>由框架自动完成序列化、加缩、加密等组包过程及对应的解包过程，业务完全不用操心，专注自己的逻辑即可；</h2><h2 style="margin-bottom: 15px;"><strong>2)</strong>新业务定协议非常方便，具体协议的内容由业务侧的终端和后台自行完成，不需要框架支持，只需要统一申请命令字唯一标识一条协议；</h2><h2 style="margin-bottom: 15px;"><strong>3)</strong>纯异步的网络接口，怎么用都不用担心出现ANR；</h2><h2 style="margin-bottom: 15px;"><strong>4)</strong>完善的Guid体系，查询设备信息、版本信息非常方便；</h2><h2 style="margin-bottom: 15px;"><strong>5)</strong>在开发模式下，每个网络请求的耗时、流量、错误码统一打印，每个请求执行到哪一步以及每一步的耗时也统一打印，便于查问题、性能优化；</h2><h2 style="margin-bottom: 15px;"><strong>6)</strong>配备详细的自助调试手册，方便业务侧使用；</h2><p style="margin-bottom: 15px;">&nbsp;</p><h1 style="margin-bottom: 15px;"><span style="font-size: 20px;"><strong>9 / 易维护</strong></span></h1><h2 style="margin-bottom: 15px;"><strong>1)协议可扩展性</strong>：业务侧增加新协议时，具体协议的内容由业务侧自行完成，不需要框架支持，只需要统一申请命令字唯一地标识一条协议；</h2><h2 style="margin-bottom: 15px;"><strong>2)统一的对外接口</strong>：对外接口归结为发包接口的接受push的接口，通过统一的接口可以非常方便地进行优化和监控。</h2><p><br></p><h1 style="margin-bottom: 15px;"><span style="font-size: 20px;"><strong>10 / 其他</strong></span></h1><p style="margin-bottom: 15px;">除了以上这些，我们还有以下几点建议。</p><p style="margin-bottom: 15px;"><strong>（1）&nbsp;终端的主动请求尽可能离散，避免某个时刻集中访问。</strong>这点无论是网络服务框架还是具体业务都要特别留意。正常情况下用户平时都是离散上线的，对于服务器来说任何时候的实时请求量都不会太大。但如果不小心写了一个在某个时刻去联网的逻辑，则服务器的压力会瞬间暴增，而服务器一般只会保留正常流量的2-3倍容量，出现这种情况很可能会扛不住。</p><p style="margin-bottom: 15px;"><strong>（2）&nbsp;业务做好推拉结合，依赖推送的逻辑不要放在UI进程，</strong>因为UI进程生命周期是短暂的，进程退出了就无法再收到推送了。</p><p style="margin-bottom: 15px;"><strong>（3）&nbsp;最好的网络优化是结合具体业务场景来做的，监控网络连上事件、适当重试是简单实用的方法。</strong>对于实时性要求不高的业务，也可考虑伴随联网，即在其他较频繁联网的业务联网成功的时候顺带执行，成功率非常有保障，也可以减少重试造成的性能损耗。</p><p style="margin-bottom: 15px;">&nbsp;</p><h1 style="margin-bottom: 15px;"><span style="font-size: 20px;"><strong>结语</strong></span></h1><p style="margin-bottom: 15px;">网络服务的维护涉及到终端、后台、运维等多个角色，本文主要是从终端的视角介绍手机管家的Shark网络的一些经验。如果大家有兴趣，还可以结合我们后台同学和运维同学的文章一起看，他们分别从接入层和调度的角度做了另外的分享。具体链接见文后附录。</p><p style="margin-bottom: 15px;">除了以上这些，要做一个靠谱的网络服务还会遇到很多的问题，我们还在努力中。欢迎大家交流指导。</p><p style="margin-bottom: 15px;"><br></p><p style="margin-top: 15px;white-space: normal;"><span style="color: rgb(0, 176, 240);font-family: 宋体;font-size: 14px;white-space: pre-wrap;">✎ 如果您想了解更多关于移动终端安全的内容，请收听我们的</span><strong style="color: rgb(0, 176, 240);font-family: 宋体;font-size: 14px;white-space: pre-wrap;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">微信公众号(终端安全那些事儿)</strong><span style="color: rgb(0, 176, 240);font-family: 宋体;font-size: 14px;white-space: pre-wrap;">，我们将定期为您分享；</span><br></p><p style="white-space: normal;line-height: 25.6px;color: rgb(62, 62, 62);font-family: Verdana, 宋体, sans-serif;min-height: 1em;border: 0px;list-style: none;word-break: normal;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="color: rgb(0, 176, 240);font-family: 宋体;line-height: 22.5px;word-break: normal;font-size: 14px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">✎ 如果您对移动终端安全有什么问题和建议，关注我们的公众账号后直接回复消息联系我们。</span></p><p style="white-space: normal;line-height: 25.6px;color: rgb(62, 62, 62);font-family: Verdana, 宋体, sans-serif;min-height: 1em;border: 0px;list-style: none;word-break: normal;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="color: rgb(0, 176, 240);font-family: 宋体;line-height: 22.5px;word-break: normal;font-size: 14px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><br></span></p><p style="margin-bottom: 10px;white-space: normal;line-height: 25.6px;text-align: center;"><span style="max-width: 100%;color: rgb(0, 176, 240);box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 12px;box-sizing: border-box !important;word-wrap: break-word !important;">终端安全那些事儿&nbsp;</span></strong></span><span style="max-width: 100%;color: rgb(0, 176, 240);font-size: 12px;box-sizing: border-box !important;word-wrap: break-word !important;">汇聚最优影响力的安全技术文章</span></p><p style="white-space: normal;line-height: 25.6px;text-align: center;"><img src="http://mmbiz.qpic.cn/mmbiz/Sa7mwT4mK886dCibVZvJVBnhzGR5E6sDE6ZJgeuFIakefoSvcCf6jRUXNO5JMLnqAsicWL4yXpxiaC0cbX2iaWibcYA/0?wx_fmt=png" style="width: 138px !important; height: 137px !important;"></p><p style="white-space: normal;line-height: 25.6px;text-align: center;"><span style="color: rgb(0, 176, 240);font-size: 11px;">▲长按二维码可识别关注</span></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1512889106&src=3&ver=1&signature=0dsH*cvrb7sDcdE*f0PtKIQC8ajyzJPAXQ2hw4mnWo*7Zo-jG5kifamqpZ0653aYghqzw89XhHbfifuGLho5rU2Qwz2HqiiqaDhsI2K34xHxu072YtPCAzckEcLOpQdwf2sRXphPj*oaKidDAxmRek0RW7IvnvOhJuQqz*UdflM=">微信地址</a>
{% endraw  %}

