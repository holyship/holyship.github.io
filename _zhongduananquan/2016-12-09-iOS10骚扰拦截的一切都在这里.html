---
title: iOS10骚扰拦截的一切都在这里
author: 陈泽滨
date: '2016-12-09 00:00:00 +0000'

---

{% raw  %}
<h2 style="margin-top: 5px;"><strong><span style="font-size: 24px;">前言</span></strong></h2><p style="margin-top: 15px;">2016年9月14日，苹果正式对外全量推送了iOS10更新。作为iOS系统走过10个年头的里程碑版本，iOS10推出了大量新特性吸引用户。即便是在更新发布期间出现大量用户白苹果的乌龙事件，依旧是变砖难当升级心。据统计，iOS10首日系统升级占比达到14.45%，高于去年iOS9的12.6%。在iOS10的众多新特性中，最受中国用户关注的，便是新加入的Callkit带来的骚扰电话标记与拦截功能。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/b3df811c1bb88a4721df3b77ca2c2996a6b5a530.jpeg" style="width: 770px !important; height: 575.622px !important; visibility: visible !important;"><br>本文将为大家介绍iOS10 Callkit中骚扰拦截相关的Call Directory Extension工作原理，同时分析插件的号码规则、运作性能等技术细节，并分享腾讯手机管家在iOS10骚扰拦截上的解决方案。</p><p><br></p><h2 style="margin-top: 15px;"><strong><span style="font-size: 24px;">工作原理与机制</span></strong></h2><p style="margin-top: 15px;">Callkit framework主要包含2个功能模块，网络电话（VoIP）和来电标记拦截（callblocking &amp; identification），这里主要介绍来电标记拦截部分。</p><p style="margin-top: 15px;">一如苹果以往的开放模式，本次针对电话开放的拦截标记功能同样沿用了+Extension的插件模式，对应新增的插件叫做Call Directory Extension。第三方应用通过此插件可以将标记电话信息或需要拦截的电话号码导入系统电话数据库，系统来电时由电话进程进行数据库搜索，根据预先成功导入数据进行标记或拦截操作。在这里，苹果考虑到号码隐私的问题，系统来电时不会激活第三方应用或电话插件，我们无法获取用户电话号码，只能提前进行数据导入操作。</p><p style="margin-top: 15px;"><span style="font-size: 18px;"><strong>Callkit电话插件进程工作示意图：</strong></span></p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/3bf36d36c19bac2363327ee4059ec034696168b1.png" style="width: 714px !important; height: 213px !important;"><br><span style="font-size: 18px;"><strong>Callkit中电话标记拦截模块框架</strong>：</span></p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/dc09c03e345067a06e625878bd44a2361a8683c1.jpeg" style="width: 770px !important; height: 425.906px !important;"></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="margin-top: 15px;"><strong>CXCallDirectoryManager</strong></p></li></ul><p style="margin-top: 15px;">提供接口让主APP管理电话插件，如调起插件或获取插件启用状态</p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px;"><strong>CXCallDirectoryProvider</strong></p></li></ul><p style="margin-top: 15px;">主APP调起电话插件的入口</p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px;"><strong>CXCallDirectotyExtensionContext</strong></p></li></ul><p style="margin-top: 15px;">插件具体作业的上下文，包括添加标记电话和拦截电话，由CXCallDirectoryProvider进行传递</p><p style="margin-top: 15px;">- 如何进行骚扰电话标记？</p><p style="margin-top: 15px;">通过-[addIdentificationEntryWithNextSequentialPhoneNumber:label:]接口将电话号码（PhoneNumber:Int64）和标记信息描述（label:String）导入系统电话数据库</p><p style="margin-top: 15px;">- 如何进行骚扰电话拦截？</p><p style="margin-top: 15px;">通过-[addBlockingEntryWithNextSequentialPhoneNumber:]接口将电话号码（PhoneNumber:Int64）加入系统电话数据库</p><p><br></p><h2 style="margin-top: 15px;"><strong><span style="font-size: 24px;">规则与性能</span></strong></h2><h3 style="margin-top: 15px;"><span style="font-size: 18px;"><strong>号码规则</strong></span></h3><p style="margin-top: 15px;">导入电话号码是Call Directory Extension的唯一工作，对此苹果采用了SQLITE的本地数据存储方案，考虑到性能与稳定性问题，插件导入数据包含以下规则（截止目前Apple Developer尚未有Callkit的完整说明文档）：</p><p style="margin-top: 15px;">1、&nbsp; 单次导入最多不超过200万号码</p><p style="margin-top: 15px;">2、&nbsp; 导入号码必须严格按照数字大小顺序排序</p><p style="margin-top: 15px;">3、&nbsp; 不允许重复号码导入</p><p style="margin-top: 15px;">4、&nbsp; 每个号码必须严格按照国际归一化标准处理</p><p style="margin-top: 15px;">不难发现前两条主要出于SQLITE的性能考虑，最后一条涉及到iPhone手机电话号码归一化处理问题。我们知道，电话号码的国际标准归一化处理格式为：“+|国际号|地区号|电话号码”。举个例子，中国北京市的移动客服电话，经过归一化处理后为+861010086，注意这里010的北京市区号，开头的0将会被省略。</p><p style="margin-top: 15px;"><span style="color: rgb(113, 113, 123);"><strong>【前方有坑】</strong></span></p><p style="margin-top: 15px;">我们在实际测试中也发现，由于一些不可描述的原因，苹果在处理一些号码归一化识别的时候仍然存在部分缺陷，特别是针对香港号码的处理。例如，我们将+852160500的香港号码标记为“诈骗电话”写入电话数据库，当我们拨打“+852160500”号码时候Callkit却没有命中这个标记，反而在我们拨打“852160500”的时候（归一化后应该是+86852160500）被Callkit错误地命中。这个缺陷在最新的iOS10系统中依旧存在。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/aa92a414b3024dd239087a440e43ce997547b8c5.png" style="width: 605px !important; height: 73px !important;"><br></p><h3 style="margin-top: 15px;"><span style="font-size: 18px;"><strong>内存</strong></span></h3><p style="margin-top: 15px;">常规插件的内存上限是6MB，Call Directory Extension也不例外，超过6MB内存插件进程将会因memoryissue被系统强制关闭，所以应用在做数据导入过程中要注意及时将临时变量内存进行释放。</p><p style="margin-top: 15px;"><strong><span style="color: rgb(113, 113, 123);">【前方有坑】</span></strong></p><p style="margin-top: 15px;">从iOS10.0 beta4开始我们发现电话插件在导入大量不同的号码标记信息（如黄页号码）时候大概率出现写入失败。经过测试分析发现（以iPhone5为例），电话插件通过XPC进程通信调起com.apple.Callkit进程开始写入数据，在写入到18w左右号码量级时候，com.apple.Callkit突然被killed从而导致进程通信中断（connection interrupted），最终回调插件应用写入失败。</p><p style="margin-top: 15px;">从这条路径分析：首先大量的黄页号码标签会在导入过程产生较多字符串对象，而且从Callkit进程被killed前大幅增涨的内存可基本断定为memory issue导致的异常。在确认我们已经对临时变量及时进行了释放的前提下，我们终于发现原来</p><p style="margin-top: 15px;">-[CXCallDirectoryExtensionContextaddIdentificationEntryWithNextSequentialPhoneNumber:label:]这个函数对传入的label字符串未做及时释放，我们可以为系统增加一个autoreleasepool来临时规避这个问题，这个缺陷目前在最新的iOS10系统中依旧存在。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/478413ae3c7d6572943c407e34a38d9cab145aa8.png" style="width: 654px !important; height: 131px !important;"><br><span style="font-size: 18px;"><strong>耗时</strong></span></p><p style="margin-top: 15px;">前面提到，导入大量号码是电话插件的唯一工作。所以在设计初期，导入数据的性能问题是苹果不断优化的一个重点课题。在iOS10.0 beta3之前，电话号码（PhoneNumber）是以string类型存入数据库，iOS10.0 beta4之后苹果对电话号码数据结构进行升级，改用int64位类型</p><p style="margin-top: 15px;">进行存储，大大提升了整体数据插入与检索效率。</p><p style="margin-top: 15px;">截止目前，我们暂时没有办法对电话插件内部的SQLITE数据表进行解析，但我们发现清空数据的耗时要大于写入数据，而且每次重新导入数据Callkit都会先对插件原始数据做全量清空，再插入新的数据。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/2a2cb32c1bbfa6f6a4edc2019e13dd4951883978.png" style="width: 640px !important; height: 385px !important;"><br></p><p><br></p><h2 style="margin-top: 15px;"><span style="font-size: 24px;"><strong>手机管家骚扰拦截</strong></span></h2><p style="margin-top: 15px;">本章节开始将介绍手机管家基于iOS10电话插件之上的骚扰拦截功能解决方案。</p><p><br></p><h3 style="margin-top: 15px;"><span style="font-size: 18px;"><strong>云端——为用户筛选最有价值的数据</strong></span></h3><p style="margin-top: 15px;">由于本地导入的数据有限，同时兼顾到性能与用户体验，云端需要对海量的号码预先进行一轮严格的筛选。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/c4a0119c68cd4c7f38e1df3fa21fa1ecc9db7d1b.png" style="width: 770px !important; height: 107.944px !important;"><br>首先服务器将符合标记类型的号码进行归类过滤，如骚扰类型、疑似诈骗类型、广告推销类型等，再按照地区（省份）进行划分，一般而言用户接收到的来电辐射范围取决与他的活动常住地，用户可以在手机管家选择常住地后服务器再对应下发，这样本地号码包可以更有效覆盖用户的日常生活来电。</p><p style="margin-top: 15px;">下一步是过滤标记次数，这里主要是去除部分用户可能误标记的电话号码。然后是按照热度进行排序（这里我们定义某个号码在一段时间内的呼入呼出总次数为热度），取头部高热度的号码同时也剔除了对用户价值不大的长尾号码。</p><p style="margin-top: 15px;">最后是归一化处理，整体排序并压缩打包。这里主要配合终端电话插件的号码规则，将部分逻辑提前处理完毕，降低终端工作量以提升写入效率。</p><p style="margin-top: 15px;">&nbsp;</p><h3 style="margin-top: 15px;"><strong><span style="font-size: 18px;">终端——以可用性为前提，做有损服务，保持数据及时更新</span></strong></h3><h4 style="margin-top: 15px;"><strong>平衡点</strong></h4><p style="margin-top: 15px;">我们知道，本地号码库的数量越多，覆盖的骚扰号码自然越多。但受限于iOS10系统电话插件的性能与稳定性，随着插件写入号码的增加，在增加整体写入耗时的同时，也会降低数据写入的成功率。从收集反馈的失败分布我们可以看到，绝大部分来自系统的Callkit进程异常（NSCocoaDomain-4097/4099，占比50.37%）或者电话数据库异常（sqlite，占比41.52%），前者在短时间内会持续写入失败，后者表现为电话数据库永久性崩溃，除非通过刷机来重置整个电话数据库，方可恢复电话插件正常作业，这对用户的体验来说是致命的。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/f18818347378f5056cebb63794cedf525f93d8e7.png" style="width: 655px !important; height: 421px !important;"><br>所以，一切以可用性为前提。我们不能无限制地增加本地号码库的号码量，需要在骚扰号码的覆盖度、电话插件的写入成功率以及整体写入耗时几个关键指标中找到一个合适的平衡点，确保用户得到最好的骚扰拦截功能体验。如下图所示，三条折线分别代表广东省的号码覆盖率，iPhone6 Plus设备的写入耗时以及电话插件万次写入成功率。</p><p style="margin-top: 15px;"><img src="/zhongduananquan/images/82399f11b53f7e06a443047d399a26006f90c3b4.png" style="width: 570px !important; height: 371px !important;"><br>从数据规律上分析：</p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px;">成功率是核心指标，代表用户是否可以直接使用此功能，权重最高。但整体变化曲率较小，意味着号码量需要大幅下降才能带来较大的成功率提升。</p></li><li><p style="margin-top: 15px;">覆盖率代表骚扰拦截功能的能力强弱，权重中等。当号码量低于30w开始将会有一个较大的覆盖率下降趋势。</p></li><li><p style="margin-top: 15px;">写入耗时代表用户的使用体验，相对权重次之。为了保持号码的数量级可以维持一个中等水平，在交互视觉上进行用户感知优化。</p></li></ul><p style="margin-top: 15px;">我们结合数据曲率与权重分配，可以推演得出整体较高效益的区域（折线图中的绿色区域），号码量取30w-70w。</p><p><br></p><h4 style="margin-top: 15px;"><strong>有损服务</strong></h4><p style="margin-top: 15px;">低端机器由于性能问题，在号码写入成功率上面也有不同的表现。特别32位机器如iPhone5/5c，更容易出现黄页号码导入产生的Callkit进程中断问题（memory issues &amp; interrupt）。</p><p style="margin-top: 15px;">在这里，我们针对不同机型我们提供不同的号码库定制，如低端机器加载相对少量的号码量（覆盖率较低），高端机器可以加载更多号码量级（覆盖率较高）。通过有损服务来控制整体用户在骚扰拦截功能上的可用性。</p><p><br></p><h4 style="margin-top: 15px;"><strong>及时更新</strong></h4><p style="margin-top: 15px;">骚扰拦截功能的核心能力来自号码库，大部分的骚扰号码都是在短时间内辐射到特定的区域范围内，因此保持本地号码库的时效性也是骚扰拦截能力的一个体现。<br>后台服务器至少每天都会推送一次标记库的号码更新，然而每次都需要用户主动进来我们的应用进行一次更新操作显然是个糟糕的用户体验，那么如何在iOS系统有限的后台模式下，尽可能多地帮用户进行自动更新操作呢？</p><p style="margin-top: 15px;">我们挖掘到下面这些后台时机，除了可作业时间有限之外，在iOS系统上这些时机或多或少都有他们的不足：</p><ul style="list-style-type: disc;" class="list-paddingleft-2"><li><p style="margin-top: 15px;">Silent Push：需要用户开启后台应用刷新权限，受限于APNS的触达率</p></li><li><p style="margin-top: 15px;">Fetch：需要用户开启应用后台刷新权限</p></li></ul><p style="margin-top: 15px;">对比发现，目前我们有90%以上的用户通过我们的后台模式来完成号码库的更新。</p><p><br></p><h2 style="margin-top: 15px;"><span style="font-size: 24px;"><strong>后记</strong></span></h2><p style="margin-top: 15px;">革命尚未成功，同志仍需努力。</p><p style="margin-top: 15px;">目前iOS10系统的Callkit，在性能与稳定性上还有较大的提升优化空间。为了提供更好的用户体验，手机管家项目组持续与苹果工程师保持沟通，截至目前已提供输出近30个Radars（bug report | advice）。相信随着iOS系统的不断完善和手机管家的技术突破，在不久的将来，iPhone用户将真正可以告别骚扰电话，免收垃圾诈骗电话伤害。</p><p><br></p>
{% endraw  %}

