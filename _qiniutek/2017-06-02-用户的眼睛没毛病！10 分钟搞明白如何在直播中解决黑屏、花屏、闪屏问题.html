---
title: 用户的眼睛没毛病！10 分钟搞明白如何在直播中解决黑屏、花屏、闪屏问题
author: 卢俊
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496459140&src=3&ver=1&signature=Nemr66ffk*GtagkzYwHqqo7gsyuK79PPnm5GN4m-4Lawv5SQU3ljmVLEGoRC-O4xHhoevn4WAazBEaH9yGAX6Ud2kDz--O2xtSEh3kjGQ50kKrvCMJ29wExN5rmp-*ojqs5BYLFVboaQjMBYwQZjx-1MzigntKB9ujCQ1gEh0L8=
date: '2017-06-02 00:00:00 +0000'

---

{% raw  %}
<section class="" style="display:none;" data-tools="新媒体管家" data-label="powered by xmt.cn"></section><section style="background-color: rgb(255, 255, 255); box-sizing: border-box;"><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="font-size: 15px; text-align: justify; line-height: 1.8; letter-spacing: 1px; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ6dtHRdeyHX0MlicuExRIOjyBibanph9Pz2ZBdCrcDYwJdicIGex2MGrFBxWfP71cuG555icP3KdoYeaw/640?wx_fmt=png" style="box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 196px !important;"></p><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-tools="135编辑器" data-id="88654" style="max-width: 100%; box-sizing: border-box; border-width: 0px; border-style: none; border-color: initial; word-wrap: break-word !important;"><section style="margin-top: 10px; margin-bottom: 10px; max-width: 100%; box-sizing: border-box; text-align: center; word-wrap: break-word !important;"><section style="padding: 2px; max-width: 100%; box-sizing: border-box; display: inline-block; vertical-align: middle; width: 0.8em; height: 0.8em; line-height: 1; border-left: 2px solid rgb(30, 155, 232); border-bottom: 2px solid rgb(30, 155, 232); border-top-color: rgb(30, 155, 232); border-right-color: rgb(30, 155, 232); transform: rotate(-45deg); word-wrap: break-word !important;"></section></section></section></section><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); font-family: 微软雅黑; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-tools="135编辑器" data-id="16" data-color="#D1D7D8" style="max-width: 100%; box-sizing: border-box; border-width: 0px; border-style: none; border-color: initial; word-wrap: break-word !important;"><section class="" style="margin: 10px auto; padding: 15px; max-width: 100%; box-sizing: border-box; word-wrap: break-word !important; background-color: rgb(209, 215, 216); border-color: rgb(209, 215, 216); color: rgb(78, 90, 92); border-radius: 4px;"><p style="max-width: 100%; min-height: 1em; letter-spacing: 1px; line-height: 1.5em; text-align: justify; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(127, 127, 127); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">「黑屏、花屏、闪屏」经常出现在直播应用中，除了网络问题，在直播过程中的黑屏、花屏、闪屏却有很多技术原因，这篇文章将全方位为你解决直播中的「黑屏、花屏、闪屏」问题。</span></p></section></section></section><section style="max-width: 100%; box-sizing: border-box; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); word-wrap: break-word !important;"><section class="" powered-by="xiumi.us" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="max-width: 100%; box-sizing: border-box; word-wrap: break-word !important;"><section class="" style="padding-right: 4px; padding-left: 4px; max-width: 100%; box-sizing: border-box; font-size: 15px; text-align: justify; line-height: 1.8; letter-spacing: 1px; word-wrap: break-word !important;"><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;">继<a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">《直播技术详解》</strong></a>系列文章之后，我们推出了这个新的系列<strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">《直播疑难杂症排查》</strong>，把解决直播问题的经验逐步分享出来，同时也会穿插一些音视频开发的基础知识和优化经验，希望能够帮助到直播领域的开发者们。</p><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%; font-family: 微软雅黑; font-size: 16px; box-sizing: border-box !important; word-wrap: break-word !important;"><section class="" data-tools="135编辑器" data-id="16401" style="max-width: 100%; box-sizing: border-box; border-width: 0px; border-style: none; border-color: initial; word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; text-align: center; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/v6uP0lGcBZ6dtHRdeyHX0MlicuExRIOjytwsJlnQARGEjpkRWRKQxDia1pwNY2z6yMvxWqNaVzV4y7NnbhkVgIfg/640?wx_fmt=jpeg" style="display: inline; box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 640px !important; height: 12px !important;"></p></section><section data-role="paragraph" class="" style="max-width: 100%; box-sizing: border-box; border-width: 0px; border-style: none; border-color: initial; word-wrap: break-word !important;"><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></section></section><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;">本系列会涵盖的内容包括但不限于如下一些主题：</p><ul class="list-paddingleft-2" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">播放失败</a></p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192941&amp;idx=1&amp;sn=42d4aa5fadfbc98aece72e5ad322e44e&amp;chksm=bd0176388a76ff2e6dc9b23062728b95e6657e8a4b7781b7092290fb41dc116df2e5778284a3&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192941&amp;idx=1&amp;sn=42d4aa5fadfbc98aece72e5ad322e44e&amp;chksm=bd0176388a76ff2e6dc9b23062728b95e6657e8a4b7781b7092290fb41dc116df2e5778284a3&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">直播卡顿</a></p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192964&amp;idx=1&amp;sn=c68793ee2f7f9d4b66ddeda3ad59cd0d&amp;chksm=bd0176518a76ff4745bf41716d81dfd8ac4776ff075c94c59ad112896ae90175b967b243d6d0&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192964&amp;idx=1&amp;sn=c68793ee2f7f9d4b66ddeda3ad59cd0d&amp;chksm=bd0176518a76ff4745bf41716d81dfd8ac4776ff075c94c59ad112896ae90175b967b243d6d0&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">首开慢</a></p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193023&amp;idx=1&amp;sn=d01045267be48621ac93c145af46cd53&amp;chksm=bd01766a8a76ff7cd9e1e1994f5db2dab53560c44579b3bfef14a32bf638245b28de1405b026&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193023&amp;idx=1&amp;sn=d01045267be48621ac93c145af46cd53&amp;chksm=bd01766a8a76ff7cd9e1e1994f5db2dab53560c44579b3bfef14a32bf638245b28de1405b026&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">延时高</a></p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193052&amp;idx=1&amp;sn=15b320405ca6189c72ca9b2b828bd991&amp;chksm=bd0177898a76fe9fbb371b246c26fe85a702c866eeceedf516fbeb3a466b9f5e793ea488237c&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193052&amp;idx=1&amp;sn=15b320405ca6189c72ca9b2b828bd991&amp;chksm=bd0177898a76fe9fbb371b246c26fe85a702c866eeceedf516fbeb3a466b9f5e793ea488237c&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">音画不同步</a></p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193074&amp;idx=1&amp;sn=59444be00fe1bb5123ab19f2b8da8126&amp;chksm=bd0177a78a76feb1ceb3bea0c76adb943eecbc70ec1a0e4d3a734cf06f5a101ad6db3a6970eb&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193074&amp;idx=1&amp;sn=59444be00fe1bb5123ab19f2b8da8126&amp;chksm=bd0177a78a76feb1ceb3bea0c76adb943eecbc70ec1a0e4d3a734cf06f5a101ad6db3a6970eb&amp;scene=21#wechat_redirect">马赛克严重</a></p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;">播放黑屏、花屏、绿屏</p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;">播放杂音、噪音、回声</p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;">点播拖动不准</p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;">直播发热问题</p></li><li><p style="max-width: 100%; box-sizing: border-box; min-height: 1em; word-wrap: break-word !important;">其他问题（待续）</p></li></ul></section></section></section></section><p style="white-space: normal; box-sizing: border-box;"><br></p><p style="white-space: normal; box-sizing: border-box;">本文是 《直播疑难杂症排查》系列的第七篇文章，我们来重点看看直播中常见的各种黑屏、花屏、闪屏问题。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">首先我们要明白，黑屏、花屏、闪屏等问题，可能是推流端的问题，也可能是播放器的问题，遇到这些现象，我们要第一时间用别的播放器（如 VLC，ffplay）试试，如果都出现同样的问题，那么多半是流本身的问题了，反之，则很可能是播放器的问题。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section class="" data-tools="135编辑器" data-id="87851" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;  "><section style="margin-right: auto; margin-left: auto; text-align: center;"><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid rgb(6, 163, 224); display: inline-block; opacity: 0.5; box-sizing: border-box;"></section><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 10px solid rgb(6, 163, 224); display: inline-block; margin-left: -3px; box-sizing: border-box;"></section><section class="" data-brushtype="text" style="margin-left: 0.5em;display: inline-block;"><p style="white-space: normal;"><strong>播放黑屏</strong></p></section><section style="margin-left: 0.5em; width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 10px solid rgb(6, 163, 224); display: inline-block; box-sizing: border-box;"></section><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid rgb(6, 163, 224); display: inline-block; opacity: 0.5; margin-left: -3px; box-sizing: border-box;"></section></section></section><p style="white-space: normal; box-sizing: border-box;"><br></p><p style="white-space: normal; box-sizing: border-box;">现象：画面是黑的，没有图像，但是有声音。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><span style="color: rgb(6, 163, 224); box-sizing: border-box;"><strong style="box-sizing: border-box;">1.主播端摄像头权限问题</strong></span><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">无论 Android 还是 iOS，App 使用摄像头都是需要申请授权的，特别是 Android 6.0 以后，如果 App 层面不做专门的处理的话，很可能出现摄像头权限被禁用的情况。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">如果 App 没有获取到摄像头权限，视频就无法采集成功，从而导致推出来的流只有音频数据。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong>解决方案：</strong>App 层面肯定要小心处理权限问题，检测到未获取相应权限则禁止开播，或者反复提示主播授予权限。另外，可以询问出现问题的主播是否有摄像头预览画面，如果 App 没有获得权限的话，是没有预览画面的。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong style="box-sizing: border-box;"><span style="color: rgb(6, 163, 224); box-sizing: border-box;">2.主播端编码失败</span></strong></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">视频数据采集到后，下一步就是经过编码器，由于参数配置或者某些机型的硬编兼容性问题，很可能数据送入编码器后，编码失败，并无输出，从而导致没有视频数据送入到推流模块。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong>解决方案：</strong>一般推流 SDK 都会统计推流的实时视频帧率，CDN 服务端也会有一些帧率监控，因此，如果发现这些统计得到的推流帧率为 0，同时又确定不是没有采集到数据，那么多半是编码器的原因，可以想办法查看下该机型的日志看看具体的报错信息。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><span style="color: rgb(6, 163, 224); box-sizing: border-box;"><strong style="box-sizing: border-box;">3.视频解码失败</strong></span></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">前面的文章有提到过，当播放器遇到不支持的视频格式，或者数据内容/格式异常，则会解码失败，从而导致无解码视频输出。</p><p style="white-space: normal; box-sizing: border-box;">针对不支持的格式：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="white-space: normal; box-sizing: border-box;">要提前了解播放器本身支持哪些音视频格式，如 H.264，mp4v，aac 等等，避免播放不支持的格式</p></li><li><p style="white-space: normal; box-sizing: border-box;">播放器本身遇到的硬解或者软解失败，应该有日志报错，或者抛出异常给应用层提示用户</p></li></ul><p style="white-space: normal; box-sizing: border-box;">针对视频数据内容错误：</p><p style="white-space: normal; box-sizing: border-box;">需要分析码流文件本身，常见的数据内容错误导致的解码失败有如下几种：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="white-space: normal; box-sizing: border-box;">送入解码器的帧数据不完整</p></li><li><p style="white-space: normal; box-sizing: border-box;">H.264 的视频码流，缺失了 SPS，PPS 等必要的信息头</p></li><li><p style="white-space: normal; box-sizing: border-box;">iOS 的 VideoToolbox 解码，只支持 avcc 方式打包的 H.264 数据</p></li><li><p style="white-space: normal; box-sizing: border-box;">部分 Android 机型硬编出来的数据有额外的 naul 头</p></li><li><p style="white-space: normal; box-sizing: border-box;">其他等等</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><span style="color: rgb(6, 163, 224); box-sizing: border-box;"><strong style="box-sizing: border-box;">4.码流的前半段只有音频没有视频</strong></span></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">这种情况，多半出自 HLS 切片产生的码流，当主播用同一个地址推流，前半段只推了音频（可能是摄像头权限被禁用，也可能是选择了纯音频推流等等），然后接着又同时推了音视频流，那么，服务端 HLS 切片产生的文件，就会出现这样的情况。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">基于 ffmpeg 的播放器，会在解析完视频头后初始化解码器，因此，对于这种码流，往往会出现仅有音频或者仅有视频播放的情况。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong>解决方案：</strong>从 App 端尽可能避免出现这种使用姿势，修改播放器的代码，对这种码流进行兼容处理。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section class="" data-tools="135编辑器" data-id="87851" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;  "><section style="margin-right: auto; margin-left: auto; text-align: center;"><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid rgb(6, 163, 224); display: inline-block; opacity: 0.5; box-sizing: border-box;"></section><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 10px solid rgb(6, 163, 224); display: inline-block; margin-left: -3px; box-sizing: border-box;"></section><section class="" data-brushtype="text" style="margin-left: 0.5em;display: inline-block;"><p style="white-space: normal;"><strong>播放花屏/绿屏</strong></p></section><section style="margin-left: 0.5em; width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 10px solid rgb(6, 163, 224); display: inline-block; box-sizing: border-box;"></section><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid rgb(6, 163, 224); display: inline-block; opacity: 0.5; margin-left: -3px; box-sizing: border-box;"></section></section></section><p style="white-space: normal; box-sizing: border-box;"><br></p><p style="white-space: normal; box-sizing: border-box;">现象：播放画面出现图像紊乱，大面积的异常颜色的方块图，或者绿屏现象</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><span style="color: rgb(6, 163, 224);"><strong>1.丢失参考帧导致的</strong></span></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">一般 H.264 码流有 I、B、P 三种帧类型，I 帧是关键帧，B 帧是双向预测内插编码帧，P 帧是前向预测编码帧。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">I 帧由于是帧内压缩，因此可以独立解码播放，而 B 帧，一旦丢失了 I 帧或者后面的 P 帧，则会解码失败，而 P 帧一旦丢失了前面的 I/B/P 帧，也会导致解码失败。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">对于丢失了参考帧而导致的解码失败，一般就会出现花屏的现象，花屏的严重程度依赖于丢失的参考帧对即将解码的帧的重要程度。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">那么，什么情况下会丢失参考帧呢 ？</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">首先，推流/播放的代码层面，需要注意，不要丢弃编码后、解码前的视频帧数据，不过实际场景中，遇到下面的情况，难免还是会产生丢帧：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="white-space: normal; box-sizing: border-box;">网络不好，编码后的数据发不出去</p></li><li><p style="white-space: normal; box-sizing: border-box;">系统低内存，队列里面无法承受更多的帧数据</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">因此，在这些极端的情况下，不得不丢帧的话，最合理的策略就应该是一次丢一整个 GOP，即：一旦开始丢了一个 I 帧，那么在遇到下一个 I 帧之前的所有视频帧，均丢弃掉，这样即可有效避免播放器端产生解码花屏。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong><span style="color: rgb(6, 163, 224);">2.播放器没有从关键帧开始解码</span></strong></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">原理依然如上面所述，如果不从关键帧开始解码，则必然会由于丢失了参考信息而导致解码花屏。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">因此，播放器，无论是首播，还是断网重连后，都应该判断第一帧视频是否是关键帧，如果不是，则应该等到第一个关键帧到达之后再送入解码器。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">基于 ffmpeg 的播放器，如何判断关键帧，可以参考文章：《FFMPEG Tips (3) 如何读取每一帧的信息》</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong><span style="color: rgb(6, 163, 224);">3.码流中视频尺寸发生变化</span></strong></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">很多直播 App，横屏直播和竖屏直播，使用的是不同的推流尺寸 ，当主播由竖屏推流改为横屏推流，同时又不改变推流地址的话，观众端拉到的流就会出现中间发生了视频尺寸的变化，比如：从 848 x 480 变成了 1280 x 720 等等。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">播放器需要实时检测，如果发现视频尺寸发生了变化，则需要重置解码器以及相关逻辑，否则容易出现解码花屏或者出现内存越界等异常。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong><span style="color: rgb(6, 163, 224);">4.硬编硬解的兼容性问题</span></strong></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">当然，如果使用的是 Android 硬编硬解，则难免会遇到一些比较坑爹的手机，硬编硬解没有失败报错，但是输出的图像确实异常的情况。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">Android 硬编硬解的兼容性问题，代码上小心仔细，充分考虑机型的兼容性，不轻易写死任何参数，剩下能做的就是靠白名单/黑名单了。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong><span style="color: rgb(6, 163, 224);">5.推流端图像尺寸和格式处理不当</span></strong><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">图像的格式和尺寸，都是非常重要的参数，一定要严格配置正确。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">比如：如果采集到的视频是 NV21 ，编码器只支持 I420，那么编码出来的图像自然会出现颜色问题。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">比如：在一些场景切换的过程中，前后摄像头切换，视频的尺寸可能发生了变化，但是剪裁、处理、编码模块没有相应的修改尺寸，那么，也会出现各种视频错乱的现象。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section class="" data-tools="135编辑器" data-id="87851" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;  "><section style="margin-right: auto; margin-left: auto; text-align: center;"><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid rgb(6, 163, 224); display: inline-block; opacity: 0.5; box-sizing: border-box;"></section><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 10px solid rgb(6, 163, 224); display: inline-block; margin-left: -3px; box-sizing: border-box;"></section><section class="" data-brushtype="text" style="margin-left: 0.5em;display: inline-block;"><p style="white-space: normal;"><strong>播放闪屏</strong></p></section><section style="margin-left: 0.5em; width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 10px solid rgb(6, 163, 224); display: inline-block; box-sizing: border-box;"></section><section style="width: 0px; height: 0px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 10px solid rgb(6, 163, 224); display: inline-block; opacity: 0.5; margin-left: -3px; box-sizing: border-box;"></section></section></section><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">闪屏问题，从根源来看，就是播放的过程中，出现了两种不同的画面来回切换，从而看起来像&nbsp;「闪屏」，比如，黑白两张图片交替渲染。下面我们再来看看直播场景下，什么原因会引发该现象。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong><span style="color: rgb(6, 163, 224);">1.播放器缓冲机制原因</span></strong><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">网络不好的时候，播放器会频繁缓冲，曾遇到过一种案例，就是某直播 App 应用，在缓冲的时候，使用了一张广告图片，在某种极端弱网情况下，由于频繁缓冲，导致真实的播放画面和广告图片来回快速切换，导致闪屏现象。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">这个情况是完全可以从播放器的缓冲策略上避免的，每次缓冲后，不要收到一帧后就立即渲染，而是适当地多缓冲一些数据，再发送缓冲结束的消息，从而可以频繁 ms 级别的缓冲切换产生的闪屏。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;"><strong><span style="color: rgb(6, 163, 224);">2.推流端的原因</span></strong></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">推流端产生闪屏的流，往往发生在有画面合成的代码模块，比如：叠加水印、摄像头/图片切换推流、连麦合流等等。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">画面的合成，一定要铭记一点，任何情况下，都要避免出现，有合成/没有合成两种画面的交替。</p><p style="white-space: normal; box-sizing: border-box;"><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="87417" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="text-align: center; white-space: normal;"><img src="http://mmbiz.qpic.cn/mmbiz_gif/v6uP0lGcBZ4FhW73KumQMfEGpxVLnEcfSs2b12GiaQR44GYcxFcJmXf27o0xxEWib9ZTyCkzwdAS9qAW8JzP7rTw/0?wx_fmt=gif" style="display: inline; width: 22px !important; height: 10px !important;"></p></section><section data-role="paragraph" class="" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="white-space: normal;"><br></p><p style="white-space: normal; text-align: center;"><strong><span style="font-size: 15px;">【六月大派送】</span></strong><br></p><p style="white-space: normal; text-align: center;"><strong><span style="font-size: 15px;"><br></span></strong></p></section></section><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193103&amp;idx=1&amp;sn=93592caae4fa1ae22252b88f5e080408&amp;chksm=bd0177da8a76fecc951bd5de2914bd1f43a2fb750ca797831652c6961c107f05e1f4f4cfb67e&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652193103&amp;idx=1&amp;sn=93592caae4fa1ae22252b88f5e080408&amp;chksm=bd0177da8a76fecc951bd5de2914bd1f43a2fb750ca797831652c6961c107f05e1f4f4cfb67e&amp;scene=21#wechat_redirect"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/v6uP0lGcBZ4FhW73KumQMfEGpxVLnEcfTc840aicTVslw3GJza9EIC4jLlQ7JNUptNvDMD2ryqIoohqM8WKMibBA/0?wx_fmt=jpeg" style="width: 762px !important; height: 381px !important;"></a></p><p style="text-align: center;"><span style="font-size: 14px; color: rgb(178, 178, 178);">（点击图片，查看活动详情）</span></p></section></section></section></section><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496459140&src=3&ver=1&signature=Nemr66ffk*GtagkzYwHqqo7gsyuK79PPnm5GN4m-4Lawv5SQU3ljmVLEGoRC-O4xHhoevn4WAazBEaH9yGAX6Ud2kDz--O2xtSEh3kjGQ50kKrvCMJ29wExN5rmp-*ojqs5BYLFVboaQjMBYwQZjx-1MzigntKB9ujCQ1gEh0L8=">微信地址</a>
{% endraw  %}

