---
title: 《直播疑难杂症排查》之三：首开慢
author: 卢俊
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1493907687&src=3&ver=1&signature=jvrZY0qSmN7bPZVZ51WRRa-Fy2tAsoZd6ra6KEXYq3CNUsfYoS*nuXltPcZDxSGDEdaOoRWChBkZhE91GnAu8w5yyoJQjaTgs7cgZBvQ9I21B8EOiRev5lhk7LVeVfMbTyLvK*NXiFF7d*UT0ByyT-eWQddmcggXgB51OG4GVdM=
date: '2017-05-03 00:00:00 +0000'

---

{% raw  %}
<section class="" style="display:none;" data-tools="新媒体管家" data-label="powered by xmt.cn"></section><section style="background-color: rgb(255, 255, 255); box-sizing: border-box;"><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; letter-spacing: 0px; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>七牛直播云在 2016 年 6 月发布之后，帮助广大客户解决过形形色色的问题，如直播卡顿、马赛克、花屏、黑屏、杂音、音画不同步等等等等，这其中，有一些是网络原因，有一些是开发者的使用姿势问题，有一些是参数配置错误，当然，也有一些是 SDK 本身的问题。</p><p><br></p><p>总结下来，如果开发者能够对直播领域的一些基础知识有更深入的了解，掌握一些基本的排障手段，很多问题是能够很快自行解决的，甚至也能够更好地防患于未然。</p><p><br></p><p>因此，继<a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect">《直播技术详解》</a>系列文章之后，我们推出了这个新的系列《直播疑难杂症排查》，我们会把协助客户解决直播问题的经验逐步分享出来，同时也会穿插一些音视频开发的基础知识和优化经验，希望能够帮助到直播领域的开发者们。</p><p><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="16401" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="text-align: center; white-space: normal;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/v6uP0lGcBZ5ic3Pia0bKSrayzj6pCd3o0JticGaa0HtuvY09qLHoEaLmNHfG1CvwucVFCc8LIdIpsZJlE2d1KrXLA/0?wx_fmt=jpeg" style="display: inline; width: 640px !important; height: 12px !important; visibility: visible !important;"></p></section><p style="white-space: normal;"><br></p></section><p>本系列会涵盖的内容包括但不限于如下一些主题：</p><ul class="list-paddingleft-2" style="box-sizing: border-box;"><li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect">播放失败</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192941&amp;idx=1&amp;sn=42d4aa5fadfbc98aece72e5ad322e44e&amp;chksm=bd0176388a76ff2e6dc9b23062728b95e6657e8a4b7781b7092290fb41dc116df2e5778284a3&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192941&amp;idx=1&amp;sn=42d4aa5fadfbc98aece72e5ad322e44e&amp;chksm=bd0176388a76ff2e6dc9b23062728b95e6657e8a4b7781b7092290fb41dc116df2e5778284a3&amp;scene=21#wechat_redirect">播放卡顿</a></p></li><li><p>首开慢</p></li><li><p>延时高</p></li><li><p>音画不同步</p></li><li><p>马赛克严重</p></li><li><p>播放黑屏、花屏、绿屏</p></li><li><p>播放杂音、噪音、回声</p></li><li><p>点播拖动不准</p></li><li><p>直播发热问题</p></li><li><p>其他问题（待续）</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p>本文是 《直播疑难杂症排查》系列的第三篇文章，我们来看看直播过程中，最重要的一个性能指标：<strong>首开</strong>。</p><p><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">首开慢的表现</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ5ic3Pia0bKSrayzj6pCd3o0J4EFLJuactNXa9I10VlDZ5W1HUwAkbw4YVzhmxmHkaEcrOI3eFUGS6Q/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; letter-spacing: 0px; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>点击播放后，需要好几秒才能显示播放画面。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">常见首开慢问题排查</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ5ic3Pia0bKSrayzj6pCd3o0J4EFLJuactNXa9I10VlDZ5W1HUwAkbw4YVzhmxmHkaEcrOI3eFUGS6Q/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; letter-spacing: 0px; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="1" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; " data-color="#06A3E0"><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p style="white-space: normal;"><span style="">点击播放后才从服务器取播放地址</span></p></section></section><p style="white-space: normal;"><span style="   ;    ">播放视频，第一件事就是要拿到播放地址，大多数直播 App，主播的播放地址是由 App 向服务端发 HTTP GET 请求才能拿到的，因此，什么时候去「拿」&nbsp;这个播放地址，显得至关重要，常见的做法有如下两种：</span><br></p></section><ol class="list-paddingleft-2" style="box-sizing: border-box;"><li><p>App 拉取正在视频列表的时候</p></li><li><p>用户点击某个视频，跳转到播放界面之后</p></li></ol><p><br></p><p>显然，后者的用户体验明显会比前者差，因为通过 HTTP GET 请求播放地址的过程，无形增加了首开时间，特别是在弱网下，会更慢。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="1" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; " data-color="#06A3E0"><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p style="white-space: normal;"><span style="   ;    ">DNS 解析慢</span></p></section></section></section><p>不同的播放域名，DNS 解析有快有慢，再加上 DNS 解析服务的缓存策略，在本地没有该域名缓存的情况下，会逐级向更高级的域名服务器查询域名，因此，播放域名解析的耗时，会对首开产生不小的影响。</p><p><br style="box-sizing: border-box;"></p><p>为了有效降低 DNS 解析对首开的影响，我们可以提前完成播放域名-&gt;IP 地址的解析，并缓存起来，播放的时候，直接传入带 IP 地址的播放地址，从而省去了 DNS 解析的耗时。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="text-align: left;">如果要支持用&nbsp;IP&nbsp;地址播放，是需要修改底层 ffmpeg 源码的，目前我们七牛的&nbsp;PLDroidPlayer&nbsp;就支持这样的播放地址：</p><p style="text-align: left;">URL 格式「protocol://ip/path?domain=xxxx.com」</p><p><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="1" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; " data-color="#06A3E0"><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p style="white-space: normal;"><span style="   ;    ">播放策略原因</span></p></section></section></section><p>播放首开时间的定义，就是从点击播放到第一帧画面显示出来的耗时，因此，我们需要尽一切可能加快播放进度。</p><p><br></p><p>很多侧重点播的播放器，为了减少卡顿，会有一些缓冲策略，当缓冲足够多的数据之后 ，再送入解码播放。</p><p><br></p><p>而为了加快首开效果，需要对播放的缓冲策略做一些调整，如果第一帧还没有渲染出来的情况下，不要做任何缓冲，直接送入解码器解码播放，这样就可以保证没有任何因为「主动」缓冲带来的首开延时。</p><p><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="1" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; " data-color="#06A3E0"><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p style="white-space: normal;"><span style="   ;    ">播放参数配置</span></p></section></section></section><p>所有基于 ffmpeg 的播放器，都会遇到<span style="color: rgb(6, 163, 224); background-color: rgb(214, 214, 214);"> `avformat_find_stream_info`&nbsp;</span><span style="background-color: rgb(255, 255, 255); color: rgb(6, 163, 224);"> </span>这个函数耗时比较久，从而增大了首开时间，该函数主要作用是通过读取一定字节的码流数据，来分析码流的基本信息，如编码信息、时长、码率、帧率等等，它由两个参数来控制其读取的数据量大小和时长，一个是 probesize，一个是 analyzeduration。</p><p><br></p><p>减少 probesize 和 analyzeduration 可以有效地减少&nbsp; <span style="color: rgb(6, 163, 224); background-color: rgb(214, 214, 214);">`avformat_find_stream_info`</span>&nbsp; 的函数耗时，从而加快首开，但是需要注意的是，设置地太小可能会导致读取的数据量不足，从而无法解析出码流信息，导致播放失败，或者出现只有音频没有视频，只有视频没有音频的问题。</p><p><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="1" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; " data-color="#06A3E0"><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p style="white-space: normal;"><span style="   ;    ">服务端线路原因</span></p></section></section></section><p>当播放端的优化做到极限后，剩下的首开快慢的决定性因素就是服务端的线路了，服务端的线路主要有哪些方面会影响首开呢？</p><ul class="list-paddingleft-2" style="box-sizing: border-box;"><li><p>冷热流</p></li></ul><p>当你去附近的边缘服务器节点拉取某个流的时候，如果最近没有任何人从该服务器拉过这个流，那么这台服务器就需要逐级向源头拉流，而且该服务器也没有任何 GOP 缓存，从而产生比较大的首开延时。</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>边缘节点的 TTL</p></li></ul><p>同等大小的数据，客户端距离服务器越近，ttl 越小，那么传输速度也就越快，首开也会越快。</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>服务器的响应速度</p></li></ul><p>影响服务器响应速度的因素，一个是跟服务器的协议层优化有关，另一个就是服务端的负载和性能了，服务器当前负载越大，响应自然越慢。</p><p><br></p><p>下面给出一张图，来直观的感受一下服务端在加速首开这件事上的关键作用：</p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ5ic3Pia0bKSrayzj6pCd3o0JETOKM0ku1USDEVWsXHsEz87fZricp2au5B2Gfz2PpibHHIx4Bax6jJGQ/0?wx_fmt=png" style="width: 762px !important; height: 382.594px !important;"></p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p>七牛的实时流网络 (LiveNet)，我们会根据网络流量、各节点的连接、负载状况及到用户网络的响应时间等综合信息，实时地将用户的请求调度到最佳服务节点上，同时可计算出最佳服务节点与视频源节点的最佳网络路径，使用户可以更快速的获取到视频内容，提高视频服务的响应速度和用户体验。</p><p><br></p><p style="white-space: normal; box-sizing: border-box;"><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ5ic3Pia0bKSrayzj6pCd3o0J2jlaCcctBjwwzP0UvvlkV5PPZ1pDL0iaqZq4DdtsJmaHIIzvYmS6ZQQ/0?wx_fmt=png" style="width: 762px !important; height: 300.072px !important;"></p><p style="white-space: normal; box-sizing: border-box;"><br></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">小结</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ5ic3Pia0bKSrayzj6pCd3o0J4EFLJuactNXa9I10VlDZ5W1HUwAkbw4YVzhmxmHkaEcrOI3eFUGS6Q/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; letter-spacing: 0px; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p style="white-space: normal; box-sizing: border-box;">关于首开慢的排查大致就介绍到这里了，下篇我们将对<strong>延迟高</strong>这个话题进行探讨。</p><p style="white-space: normal; box-sizing: border-box;"><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="87417" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="text-align: center; white-space: normal;"><img src="http://mmbiz.qpic.cn/mmbiz_gif/v6uP0lGcBZ5ic3Pia0bKSrayzj6pCd3o0JtibfuXNibDwz1HXUTXdL2f87wZ2QqUfu1zqriaRfQaiawW15Y8JmFibobkQ/0.gif?tp=webp&amp;wxfrom=5&amp;wx_lazy=1" style="display: inline; width: 22px !important; height: 10px !important;"></p></section><section data-role="paragraph" class="" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="white-space: normal;"><br></p></section></section><p style="white-space: normal; box-sizing: border-box;">如果你对七牛直播云感兴趣欢迎点击<strong><span style="text-align: justify;  background-color: rgb(255, 255, 255);">「</span>阅读原文<span style="text-align: justify;  background-color: rgb(255, 255, 255);">」</span></strong>了解详情。</p></section></section></section></section><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1493907687&src=3&ver=1&signature=jvrZY0qSmN7bPZVZ51WRRa-Fy2tAsoZd6ra6KEXYq3CNUsfYoS*nuXltPcZDxSGDEdaOoRWChBkZhE91GnAu8w5yyoJQjaTgs7cgZBvQ9I21B8EOiRev5lhk7LVeVfMbTyLvK*NXiFF7d*UT0ByyT-eWQddmcggXgB51OG4GVdM=">微信地址</a> | <a href="https://developer.qiniu.com/pili/manual/1209/live-the-core-function">阅读原文</a>
{% endraw  %}

