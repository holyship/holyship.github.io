---
title: 《直播疑难杂症排查》之四：延时高
author: 卢俊
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1494425894&src=3&ver=1&signature=T3pUTKCUVTFXYE3cOj0PN1KjZ-hqoxlTMFfSJrPwli1r9RImybDPSypRAWBQNwt0PQHUqB0yulvoo4I0aPsVQbf-uQ747EgC2WqiQdMlwHmsJ-ubVzTDddwv9Ow04RF1KIs0T1RMxOqtZd9*sv8rCbfphxxI1lsVBaOBS1oplQs=
date: '2017-05-10 00:00:00 +0000'

---

{% raw  %}
<section style="background-color: rgb(255, 255, 255); box-sizing: border-box;"><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>七牛直播云在 2016 年 6 月发布之后，帮助广大客户解决过形形色色的问题，如直播卡顿、马赛克、花屏、黑屏、杂音、音画不同步等等等等，这其中，有一些是网络原因，有一些是开发者的使用姿势问题，有一些是参数配置错误，当然，也有一些是 SDK 本身的问题。</p><p><br style="box-sizing: border-box;"></p><p>总结下来，如果开发者能够对直播领域的一些基础知识有更深入的了解，掌握一些基本的排障手段，很多问题是能够很快自行解决的，甚至能够更好地防患于未然。</p><p><br style="box-sizing: border-box;"></p><p>因此，继<a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect">《直播技术详解》</a>系列文章之后，我们推出了这个新的系列《直播疑难杂症排查》，我们会把协助客户解决直播问题的经验逐步分享出来，同时也会穿插一些音视频开发的基础知识和优化经验，希望能够帮助到直播领域的开发者们。</p><p><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="16401" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="text-align: center; white-space: normal;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/v6uP0lGcBZ4Nt086EQcpBDIvialicUvico5C2HmY1eibfMBwuvV3fo4mtqCLBnNuP3nH4uAGRJ2FXgNoFibdWa9TzHQ/0?wx_fmt=jpeg" style="display: inline; width: 640px !important; height: 12px !important; visibility: visible !important;"></p></section><section data-role="paragraph" class="" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="white-space: normal;"><br></p></section></section><p>本系列会涵盖的内容包括但不限于如下一些主题：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect">播放失败</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192941&amp;idx=1&amp;sn=42d4aa5fadfbc98aece72e5ad322e44e&amp;chksm=bd0176388a76ff2e6dc9b23062728b95e6657e8a4b7781b7092290fb41dc116df2e5778284a3&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192941&amp;idx=1&amp;sn=42d4aa5fadfbc98aece72e5ad322e44e&amp;chksm=bd0176388a76ff2e6dc9b23062728b95e6657e8a4b7781b7092290fb41dc116df2e5778284a3&amp;scene=21#wechat_redirect">直播卡顿</a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192964&amp;idx=1&amp;sn=c68793ee2f7f9d4b66ddeda3ad59cd0d&amp;chksm=bd0176518a76ff4745bf41716d81dfd8ac4776ff075c94c59ad112896ae90175b967b243d6d0&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192964&amp;idx=1&amp;sn=c68793ee2f7f9d4b66ddeda3ad59cd0d&amp;chksm=bd0176518a76ff4745bf41716d81dfd8ac4776ff075c94c59ad112896ae90175b967b243d6d0&amp;scene=21#wechat_redirect">首开慢</a></p></li><li><p>延时高</p></li><li><p>音画不同步</p></li><li><p>马赛克严重</p></li><li><p>播放黑屏、花屏、绿屏</p></li><li><p>播放杂音、噪音、回声</p></li><li><p>点播拖动不准</p></li><li><p>直播发热问题</p></li><li><p>其他问题（待续）</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p>本文是 《直播疑难杂症排查》系列的第四篇文章，我们来看看<strong>直播的延时问题</strong>。</p><p style="white-space: normal; box-sizing: border-box;"><br></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">延时的测量</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4Nt086EQcpBDIvialicUvico5ibib5bvWHYvoflT1pmhGY9HAErC1iaC70rdfia0wNAKjA9HicSjSZlbFicvQ/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>一般测量延时最简单的方法，就是推流端和播放端对着同一个时钟，然后用播放端显示的时间减去推流端显示的时间，就得到了粗略的直播延时。</p><p><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">延时高问题分析</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4Nt086EQcpBDIvialicUvico5ibib5bvWHYvoflT1pmhGY9HAErC1iaC70rdfia0wNAKjA9HicSjSZlbFicvQ/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>首先，我们看看可能产生延时的模块有哪些：</p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p>图像处理延时，比如画面剪裁、美颜、特效处理</p></li><li><p>视频编码/解码延时</p></li><li><p>网络传输的延时</p></li><li><p>业务代码中的缓冲区</p></li></ol><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">一般图像处理、数据拷贝、编解码带来的延时，都是 ms 级别的，真正会产生比较大延时的地方，一个是互联网上的网络传输延时，另一个就是业务代码中的缓冲区了。</p><p style="white-space: normal; box-sizing: border-box;"><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="85988" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; " data-color="#06A3E0" data-custom="#06A3E0"><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="41173" data-color="#06A3E0" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="margin-top: 8px; font-weight: bold; line-height: 28px; max-width: 100%; color: rgb(6, 163, 224); min-height: 32px; border-bottom: 1.5px solid rgb(6, 163, 224); border-top-color: rgb(6, 163, 224); border-right-color: rgb(6, 163, 224); border-left-color: rgb(6, 163, 224); text-align: justify; white-space: normal;"><span class="" data-original-title="" placeholder="1" style="color: rgb(255, 255, 255); display: block; float: left; line-height: 20px; margin-right: 8px; max-width: 100%; padding: 4px 10px; background-color: rgb(6, 163, 224); word-wrap: break-word !important;" title="">1</span><strong class="" data-brushtype="text" style="border-color: rgb(6, 163, 224); color: inherit;"><strong><span style="   ;    ">网络传输延时</span></strong></strong></p></section></section></section></section><p style="white-space: normal; box-sizing: border-box;">数据在网络上传输，从一个节点经过多级服务器转发到达另一个节点，是不可避免有物理延时的，下面这个表格给出了理论上数据在光纤中的网络传输的时间（实际场景中的延时往往比这个要大很多，因为涉及到带宽、网络抖动等干扰）：</p><p style="white-space: normal; box-sizing: border-box;"><br></p><p style="white-space: normal; box-sizing: border-box;"><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4Nt086EQcpBDIvialicUvico5mKMiciarCyfWm6BuNBoW6ojCSZdJ2D5zCmTQ0dJbribJLLDWTINSae0rQ/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: pointer; color: rgb(51, 51, 51); width: 762px !important; height: 302.305px !important;"></p><p style="white-space: normal; box-sizing: border-box;"><br></p><p style="white-space: normal; box-sizing: border-box;">由该表可以看出：播放端离推流端或者边缘服务器节点的物理距离越近，延时会越小。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="41173" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; "><p style="margin-top: 8px; font-weight: bold; line-height: 28px; max-width: 100%; color: rgb(6, 163, 224); min-height: 32px; border-bottom: 1.5px solid rgb(6, 163, 224); border-top-color: rgb(6, 163, 224); border-right-color: rgb(6, 163, 224); border-left-color: rgb(6, 163, 224); text-align: justify; white-space: normal;"><span class="" data-original-title="" placeholder="1" style="color: rgb(255, 255, 255); display: block; float: left; line-height: 20px; margin-right: 8px; max-width: 100%; padding: 4px 10px; background-color: rgb(6, 163, 224); word-wrap: break-word !important;" title="">2</span><strong class="" data-brushtype="text" style="border-color: rgb(6, 163, 224); color: inherit;"><strong><span style="   ;    ">业务代码中的缓冲区</span></strong></strong></p></section></section><p style="white-space: normal; box-sizing: border-box;">业务代码中的缓冲区，主要是推流端的缓冲区和播放端的缓冲区，一个 30 fps 的视频流，缓冲区每滞留 30 帧，延时就会增大 1s，那么，它们是怎么产生缓冲数据的呢 ？</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="85988" data-color="#8B9194" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box; text-align: left;"><section style="margin-right: auto; margin-left: auto; border-width: initial; border-style: none; border-color: initial; display: inline-block; width: 100%; box-sizing: border-box;" data-width="100%"><section style="font-size: 18px; letter-spacing: -2px; display: inline-block; box-sizing: border-box;"><strong><span style="color: rgb(139, 145, 148); font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.7; font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.5; font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.3; font-family: 宋体;">&gt;</span></strong></section><section style="margin-left: 10px; color: rgb(139, 145, 148); display: inline-block;"><p class="" data-brushtype="text" style="color: inherit; white-space: normal;"><span style="font-size: 16px;"><strong><span style="   ;    ">推流端的数据怎么「积累」起来的呢 ？</span></strong></span></p></section></section></section></section><p style="white-space: normal; box-sizing: border-box;">采集 -&gt; 编码 -&gt; 数据发送 -&gt; [服务器]</p><p style="white-space: normal; box-sizing: border-box;">当网络产生抖动的时候，「数据发送」会因此减慢，产生一定的阻塞，从而导致这些数据会被 「积累」在了推流端的发送缓冲区中。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="85988" data-color="#8B9194" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; "><section style="margin-right: auto; margin-left: auto; border-width: initial; border-style: none; border-color: initial; display: inline-block; width: 100%; box-sizing: border-box;" data-width="100%"><section style="font-size: 18px; letter-spacing: -2px; display: inline-block; box-sizing: border-box;"><strong><span style="color: rgb(139, 145, 148); font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.7; font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.5; font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.3; font-family: 宋体;">&gt;</span></strong></section><section style="margin-left: 10px; color: rgb(139, 145, 148); display: inline-block;"><p class="" data-brushtype="text" style="color: inherit; white-space: normal;"><strong><span style="">播放端的数据怎么 「积累」起来的呢 ？</span></strong></p></section></section></section></section><p style="white-space: normal; box-sizing: border-box;">[服务器]-&gt; 数据接收 -&gt; 解码 -&gt; 渲染</p><p style="white-space: normal; box-sizing: border-box;">当网络产生抖动的时候，服务器的数据无法「及时」地传输到播放端，而由于 TCP 协议的可靠性，所有的数据都会被服务端积累起来，在网络恢复良好的时候，会快速传输到播放端，这些数据会被动地&nbsp;「积累」在接收缓冲区中。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="85988" data-color="#8B9194" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; "><section style="margin-right: auto; margin-left: auto; border-width: initial; border-style: none; border-color: initial; display: inline-block; width: 100%; box-sizing: border-box;" data-width="100%"><section style="font-size: 18px; letter-spacing: -2px; display: inline-block; box-sizing: border-box;"><strong><span style="color: rgb(139, 145, 148); font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.7; font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.5; font-family: 宋体;">&gt;</span><span style="color: rgb(139, 145, 148); opacity: 0.3; font-family: 宋体;">&gt;</span></strong></section><section style="margin-left: 10px; color: rgb(139, 145, 148); display: inline-block;"><p class="" data-brushtype="text" style="color: inherit; white-space: normal;"><strong><span style="">怎么消除业务缓冲区的累计延时呢 ？</span></strong></p></section></section></section></section><p style="white-space: normal; box-sizing: border-box;">推流端的发送缓冲区，可以在网络恢复良好的时候，快送发送出去，从而消除掉这个累计延时。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">播放端的接收缓冲区，可以通过丢帧或者加速播放的方式快速消费掉缓冲区中的数据，从而消除累计延时。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="41173" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial;  box-sizing: border-box; "><p style="margin-top: 8px; font-weight: bold; line-height: 28px; max-width: 100%; color: rgb(6, 163, 224); min-height: 32px; border-bottom: 1.5px solid rgb(6, 163, 224); border-top-color: rgb(6, 163, 224); border-right-color: rgb(6, 163, 224); border-left-color: rgb(6, 163, 224); text-align: justify; white-space: normal;"><span class="" data-original-title="" placeholder="1" style="color: rgb(255, 255, 255); display: block; float: left; line-height: 20px; margin-right: 8px; max-width: 100%; padding: 4px 10px; background-color: rgb(6, 163, 224); word-wrap: break-word !important;" title="">3</span><strong class="" data-brushtype="text" style="border-color: rgb(6, 163, 224); color: inherit;"><strong><span style="   ;    ">协议延时</span></strong></strong></p></section></section><p style="white-space: normal; box-sizing: border-box;">通常标准的直播协议有 RTMP，HLV，HLS 三种，一般 RTMP/HLV 协议的延时在 1～3s，HLS 协议的直播延时则会更大，注重延时的直播应用，大都会选择 RTMP/HLV 协议，这些协议均是基于 tcp 的协议，tcp 协议的多个特性导致其延时明显要高于基于 udp 的私有协议，主要有如下方面：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p style="white-space: normal; box-sizing: border-box;">建立连接的三次握手</p></li><li><p style="white-space: normal; box-sizing: border-box;">ACK 机制</p></li><li><p style="white-space: normal; box-sizing: border-box;">丢包重传</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">因此，如果想从本质上解决直播延时问题，还是要换成基于 udp 的私有协议来传输数据。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">小结</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4Nt086EQcpBDIvialicUvico5ibib5bvWHYvoflT1pmhGY9HAErC1iaC70rdfia0wNAKjA9HicSjSZlbFicvQ/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p style="white-space: normal; box-sizing: border-box;">关于播放延时高的问题排查大致就介绍到这里了，下篇我们将对<strong>音画不同步</strong>这个话题进行探讨。</p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="87417" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="text-align: center; white-space: normal;"><img src="http://mmbiz.qpic.cn/mmbiz_gif/v6uP0lGcBZ4Nt086EQcpBDIvialicUvico5kIueEX8OT81G3fEsHgIPe8c8tqXg2WXBrzvw8pUyY1u50ADjIww8uA/0?wx_fmt=gif" style="display: inline; width: 22px !important; height: 10px !important;"></p></section></section></section></section></section></section><p><br></p><p>如果你对七牛直播云感兴趣欢迎点击<strong>「阅读原文」</strong>了解详情。</p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1494425894&src=3&ver=1&signature=T3pUTKCUVTFXYE3cOj0PN1KjZ-hqoxlTMFfSJrPwli1r9RImybDPSypRAWBQNwt0PQHUqB0yulvoo4I0aPsVQbf-uQ747EgC2WqiQdMlwHmsJ-ubVzTDddwv9Ow04RF1KIs0T1RMxOqtZd9*sv8rCbfphxxI1lsVBaOBS1oplQs=">微信地址</a> | <a href="https://developer.qiniu.com/pili/manual/1209/live-the-core-function">阅读原文</a>
{% endraw  %}

