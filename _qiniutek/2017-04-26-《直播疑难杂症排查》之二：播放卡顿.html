---
title: 《直播疑难杂症排查》之二：播放卡顿
author: 卢俊
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1493342577&src=3&ver=1&signature=L9XD8GAQyzHEmNm3CARkqbmCGXT4QOVOOq-YAK-mX3fwsSu-QDUp*ciyZRMNZz*qv6Ue93331*4CyKIVBANJTzzikV-E6hFOWI*d275SmeS*kfh--Z1y*Vx8O7e41AF*Ar5iYCONbKVZt914RikjxU3tOdPraZ-1f2hfO26hmVQ=
date: '2017-04-26 00:00:00 +0000'

---

{% raw  %}
<section style="background-color: rgb(255, 255, 255); box-sizing: border-box;"><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>七牛直播云在 2016 年 6 月发布之后，帮助广大客户解决过形形色色的问题，如直播卡顿、马赛克、花屏、黑屏、杂音、音画不同步等等等等，这其中，有一些是网络原因，有一些是开发者的使用姿势问题，有一些是参数配置错误，当然，也有一些是 SDK 本身的问题。</p><p><br style="box-sizing: border-box;"></p><p>总结下来，如果开发者能够对直播领域的一些基础知识有更深入的了解，掌握一些基本的排障手段，很多问题是能够很快自行解决的，甚至也能够更好地防患于未然。</p><p><br style="box-sizing: border-box;"></p><p style="text-align: justify;">因此，继<a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652191628&amp;idx=1&amp;sn=9bcaecc65f11b4587f4ee3f3b03f003e&amp;chksm=bd010d198a76840ff84ac001f35d539c41be14cdf3e894f96ae33facc4d657c2bdad9b8ba808&amp;scene=21#wechat_redirect">《直播技术详解》</a>系列文章之后，我们推出了这个新的系列《直播疑难杂症排查》，我们会把协助客户解决直播问题的经验逐步分享出来，同时也会穿插一些音视频开发的基础知识和优化经验，希望能够帮助到直播领域的开发者们。</p><p style="text-align: justify;"><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="16401" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="text-align: center; white-space: normal;"><img src="http://mmbiz.qpic.cn/mmbiz_jpg/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xmKjibPibW6fXOogWEuff1mJGM9udrQvjtEML3C0xUjJbV73sY5NDD4ibQ/0?wx_fmt=jpeg" style="display: inline; width: 640px !important; height: 12px !important; visibility: visible !important;"></p></section><section data-role="paragraph" class="" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="white-space: normal;"><br></p></section></section><p>本系列会涵盖的内容包括但不限于如下一些主题：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><a href="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MjM5NzAwNDI4Mg==&amp;mid=2652192909&amp;idx=1&amp;sn=e6a0a8a348cd71c0cb5563c44c4062e6&amp;chksm=bd0176188a76ff0e803885a466cde1533d6e54757cdd90e609f60a6776b32fb650a1b9fabeaa&amp;scene=21#wechat_redirect">播放失败</a></p></li><li><p>直播卡顿</p></li><li><p>首开慢</p></li><li><p>延时高</p></li><li><p>音画不同步</p></li><li><p>马赛克严重</p></li><li><p>播放黑屏、花屏、绿屏</p></li><li><p>播放杂音、噪音、回声</p></li><li><p>点播拖动不准</p></li><li><p>直播发热问题</p></li><li><p>其他问题（待续）</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p>本文是 《直播疑难杂症排查》系列的第二篇文章，我们主要分析下<strong>如何排查播放卡顿问题</strong>。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">播放卡顿的表现</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xiat3pP9DR55vnegHibRficiakJvNmhgxwhCcicq1iaUpAQrj8dcSO1WlgMFw/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>播放卡顿的表现总结下来包括但不限于以下这些：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>频繁出现缓冲</p></li><li><p>播放不够流畅，画面一卡一卡的</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px;  box-sizing: border-box; "><section class="" style="background-color: rgb(254, 255, 255); width: 100%; padding: 5px 10px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">常见播放卡顿问题排查</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xiat3pP9DR55vnegHibRficiakJvNmhgxwhCcicq1iaUpAQrj8dcSO1WlgMFw/0?wx_fmt=png" style="margin-top: -1em; float: left; box-sizing: border-box; width: 770px !important; height: 74.5938px !important;"> <section class="" style="clear: both; box-sizing: border-box;"></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>从代码层面来看，什么是卡顿？其实是指播放器渲染的帧率太低，比如：1s 显示 3～5 帧，或者渲染完一帧后，过很久才渲染下一帧。</p><p><br style="box-sizing: border-box;"></p><p>因此，我们需要排查，是什么原因导致了播放器无法流畅地渲染数据，通常可能有如下几大类：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>网络带宽不足</p></li><li><p>播放设备性能不足</p></li><li><p>视频流时间戳问题</p></li></ul><p>下面我们一一来分析下具体的原因。</p><p style="white-space: normal; box-sizing: border-box;"><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section data-role="outer" label="Powered by 135editor.com"><section class="" data-tools="135编辑器" data-id="1" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;  "><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p style="white-space: normal;"><span style="">原因一：网络带宽不足</span></p></section></section></section></section><p>一个完整的直播应用，简单来说数据流是这样的：主播 -&gt; CDN -&gt; 观众</p><p><br style="box-sizing: border-box;"></p><p>因此，直播出现卡顿，三个端都可能是问题的源头：</p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p>主播端的网络不好，导致推流上行不稳定</p></li><li><p>服务端的线路质量不好，导致分发不稳定</p></li><li><p>观众端的网络不好，导致拉流下行不稳定</p></li></ol><p><br style="box-sizing: border-box;"></p><p>那么，我们如何确切地判断是哪一个环节出了问题导致的播放卡顿呢 ？</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px; line-height: 1;  box-sizing: border-box; "><section class="" style="display: inline-block; vertical-align: top; box-sizing: border-box;"><span style="width: 0px; display: inline-block; opacity: 0.6; border-left: 0.6em solid rgb(6, 163, 224); border-top: 0.5em solid transparent !important; border-bottom: 0.5em solid transparent !important; box-sizing: border-box;"> </span><span style="width: 0px; display: inline-block; border-left: 0.6em solid rgb(6, 163, 224); border-top: 0.5em solid transparent !important; border-bottom: 0.5em solid transparent !important; box-sizing: border-box;"> </span> </section><section class="" style="display: inline-block; vertical-align: top; line-height: 1.2; padding-left: 3px; box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">如何判断主播网络不好</strong></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>主播端网络不好，直接影响到的就是千千万万的观众，因此，如果发现所有的观众都出现频繁卡顿，那么多半就是主播端的问题了。</p><p><br></p><p>1. 带宽测试</p><p style="text-align: left;">用带宽测试工具<span style="color: rgb(6, 163, 224);">http://www.speedtest.net/</span>&nbsp;测试下主播的带宽，如果主播的上行带宽明显小于推流的码率，那么肯定会出现推流帧率不稳定。</p><p><br></p><p>2. 统计回调</p><p>一般的推流 SDK 都会统计主播推流的实时视频帧率，如果预设的帧率是 20&nbsp;fps，但是实际的帧率低得很多，比如 5&nbsp;fps，排除手机性能低的原因的话，多半也是网络带宽不足引起的。</p><p><br></p><p>3. CDN 厂商给出的后台统计</p><p>比如，七牛直播云就给我们的每一个客户提供了如下的后台 Portal 界面，可以用于监控每一个主播的实时推流情况：</p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xdVPaNibhmQRvQMicR3H3WiagN42NIlSg38n1EDnmmkWHicaQYq87YjsVfg/0?wx_fmt=png" style="width: 762px !important; height: 430.378px !important;"></p><p><br></p><p>从这个图来看，该主播的推流上行其实还是蛮稳定的，一直在 20 fps 左右。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style=" margin-top: 10px; margin-bottom: 10px; line-height: 1;  box-sizing: border-box; "><section class="" style="display: inline-block; vertical-align: top; box-sizing: border-box;"><span style="width: 0px; display: inline-block; opacity: 0.6; border-left: 0.6em solid rgb(6, 163, 224); border-top: 0.5em solid transparent !important; border-bottom: 0.5em solid transparent !important; box-sizing: border-box;"> </span><span style="width: 0px; display: inline-block; border-left: 0.6em solid rgb(6, 163, 224); border-top: 0.5em solid transparent !important; border-bottom: 0.5em solid transparent !important; box-sizing: border-box;"> </span> </section><section class="" style="display: inline-block; vertical-align: top; line-height: 1.2; padding-left: 3px; box-sizing: border-box;"><p style="box-sizing: border-box;"><strong style="box-sizing: border-box;">如何判断观众端网络不好</strong></p></section></section></section><section class="" style="   box-sizing: border-box; " powered-by="xiumi.us"><section class="" style="   box-sizing: border-box; "><section class="" style="text-align: justify; line-height: 1.8; padding-right: 4px; padding-left: 4px; box-sizing: border-box;"><p>观众是整个直播的终端环节，一般如果不是大面积的观众出现卡顿，那么很可能是这个观众自身的网络问题，可以考虑切换到别的 WiFi 网络，或者 4G 下播放试试，我们还可以通过如下手段，具体确认下是网络的原因。</p><p><br></p><p>1.&nbsp;带宽测试</p><p>跟主播端类似，我们依然可以用带宽测试工具，测试下观众端的带宽，如果该观众的带宽明显低于主播的推流码率，那么肯定会出现卡顿。</p><p><br></p><p>2. 网络质量测试</p><p>可以在观众端的网络下，ping 一下播放域名，看看当前丢包率是多少，一般好的网络，ping 值的丢包率是 0%。</p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xwYMlSgAnHl7SXXjlchqy7MpPP62vMAP4SjGPxjW5x59AZTlGGWeQlQ/0?wx_fmt=png" style="width: 762px !important; height: 285.75px !important;"></p><p><br></p><p>当然，还有一些更加专业的网络性能测试工具，如 iperf，这里就不展开详细的介绍了。</p><p><br></p><p>3. 如何判断 CDN 线路不好</p><p>如果排除了主播端上行网络原因以及观众端下行的网络原因，那么，剩下的就很可能是 CDN 线路质量原因了。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p style="white-space: normal; box-sizing: border-box;">关于 CDN 线路质量，一方面可以通过联系 CDN 厂商来排查，另一方面，也可以通过播放端的打点上报，统计出各家 CDN 的线路质量（比如：首开，卡顿率），分地区做一些线路的调整和优化。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p>七牛实时流网络 （LiveNet）会根据网络流量、各节点的连接、负载状况及到用户网络的响应时间等综合信息，实时地将用户的请求调度到最佳服务节点上，同时可计算出最佳服务节点与视频源节点的最佳网络路径，使用户可以更快速的获取到视频内容，提高视频服务的响应速度和用户体验。</p><p><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section data-role="outer" label="Powered by 135editor.com"><section class="" data-tools="135编辑器" data-id="1" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;  "><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p>原因二：播放设备性能不足</p></section></section></section></section><p>越高清的码率，对解码的要求也越高，很多手机性能不足以支撑 720P 甚至 1080P 的视频解码，特别是很多低端的 Android 手机，因此导致实际解码播放的帧率远小于视频码流的实际帧率，从而产生卡顿。</p><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><p>解决这个问题的思路主要有如下几个方面：</p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p>尽可能选择使用硬解，充分利用 GPU 加速</p></li><li><p>如果有多种码流，尽可能在低端机上选择非高清码流</p></li><li><p>增大缓冲区，有助于缓解解码不稳定带来的卡顿</p></li></ul><p style="white-space: normal; box-sizing: border-box;"><br style="box-sizing: border-box;"></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section data-role="outer" label="Powered by 135editor.com"><section class="" data-tools="135编辑器" data-id="1" data-color="#06A3E0" style=" border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;  "><section class="" style="border-left: 5px solid rgb(6, 163, 224); font-weight: bold; line-height: 32px; color: rgb(102, 102, 102); padding: 5px 10px; margin-top: 10px; margin-bottom: 10px; box-sizing: border-box;"><p style="white-space: normal;"><span style="">原因三：视频流时间戳问题</span></p></section></section></section></section><p>这个问题也遇到的比较多，特别是客户自己写的推流 SDK 或者码流经过一些转码处理后，没有处理好音视频时间戳从而产生的问题。播放器一般是严格根据码流中的音视频的时间戳来做音画同步的，因此，如果码流中的音视频时间戳出现错误，肯定会影响到播放画面的渲染时机。</p><p><br style="box-sizing: border-box;"></p><p>例如，曾经遇到一个流的时间戳信息如下：</p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xibS4uNb45W0qIHpJ9W6ZEEKE5KKXDGiaiajGRRWBMlFKbWp7TcPy9xntw/0?wx_fmt=png" style="width: 762px !important; height: 390.378px !important;"></p><p><br></p><p>可以看到，它的视频时间戳出现了「回退」，而播放器一般 master 主时钟是单调递增的，当后来的视频帧小于了当前的主时钟，播放器就会做丢帧处理，从而导致播放的视频帧率远低于实际码流中的视频帧率，从而产生卡顿现象。</p><p><br style="box-sizing: border-box;"></p><p>这个问题的排查，大家可以修改 ffplay 源码，把读取到的每一帧音频、视频的时间戳打印出来看看，这里我给出对 ffplay 的修改 commit 记录，大家可以参考一下：</p><p><span style="color: rgb(6, 163, 224); font-size: 15px;">https://github.com/Jhuster/pili-ffmpeg/commit/4d0476faba5016b291c2eed2c0a2cd6fe303bd50</span></p><p style="text-align: justify;"><br></p><section class="" style="padding: 5px 10px; white-space: normal; background-color: rgb(254, 255, 255); width: 556px; display: inline-block; text-align: center; font-size: 18px; box-sizing: border-box;"><p style="clear: none; box-sizing: border-box;"><strong style="box-sizing: border-box;">小结</strong></p></section><img src="http://mmbiz.qpic.cn/mmbiz_png/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xiat3pP9DR55vnegHibRficiakJvNmhgxwhCcicq1iaUpAQrj8dcSO1WlgMFw/0?wx_fmt=png" style="margin-top: -1em; white-space: normal; background-color: rgb(255, 255, 255); float: left; box-sizing: border-box; width: 556px !important; height: 53.8625px !important;"><br><p>关于播放卡顿的问题排查大致就介绍到这里了，下篇我们将对<strong>首开慢</strong>这个话题进行探讨。<br></p><p><br></p><section data-role="outer" label="Powered by 135editor.com" style="font-family:微软雅黑;font-size:16px;"><section class="" data-tools="135编辑器" data-id="87417" style="border-width: 0px; border-style: none; border-color: initial; box-sizing: border-box;"><p style="text-align: center; white-space: normal;"><img src="http://mmbiz.qpic.cn/mmbiz_gif/v6uP0lGcBZ4qk6T5PR8qZMVGyVDIbH4xiaEh5RsSaWib8HX10pFSgMJ51rC5zkIcfYNggiaB6VcWVdU7lrCAyvQPQ/0?wx_fmt=gif" style="display: inline; width: 22px !important; height: 10px !important;"></p><p style="text-align: center; white-space: normal;"><br></p><p>如果你对七牛直播云感兴趣，欢迎点击<strong>「<span style="font-family: 微软雅黑; font-size: 16px; text-align: justify;  background-color: rgb(255, 255, 255);">阅读原文</span>」</strong>了解详情。<span class="" style="text-align: justify;  background-color: rgb(255, 255, 255); border-bottom: 0px solid rgb(166, 154, 202);"></span></p></section></section></section></section></section></section><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1493342577&src=3&ver=1&signature=L9XD8GAQyzHEmNm3CARkqbmCGXT4QOVOOq-YAK-mX3fwsSu-QDUp*ciyZRMNZz*qv6Ue93331*4CyKIVBANJTzzikV-E6hFOWI*d275SmeS*kfh--Z1y*Vx8O7e41AF*Ar5iYCONbKVZt914RikjxU3tOdPraZ-1f2hfO26hmVQ=">微信地址</a> | <a href="https://developer.qiniu.com/pili"/>阅读原文</a>
{% endraw  %}

