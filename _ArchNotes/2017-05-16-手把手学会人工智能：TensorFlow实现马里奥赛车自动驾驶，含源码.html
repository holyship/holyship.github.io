---
title: 手把手学会人工智能：TensorFlow实现马里奥赛车自动驾驶，含源码
author: 侠天 译
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1496016930&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgB5lnsSjL7IwmEgqPuFWPOG0*S*s8q-dgRBIq4NYLQ0KRWo8tCHRtd0kOPhiUCLP56ItZ5xVpcu0FglQ3DZ5O3TzepLR5KvYwBPB9aP02c3A8QBS6vX3RMF-qPezo88czXjYDsHTo*Jsu4etlJc6LP4=
date: '2017-05-16 00:00:00 +0000'

---

{% raw  %}
<p>这次年假没啥事做，作者想着试试完成一个两年前就已开始的项目：训练人工智能神经网络来玩《马里奥赛车 64》游戏。因为一年前做过一些机器学习，现在想蹭个热点，TensorFlow 越来越火了。<br></p><p><br></p><p><strong>项目：</strong>使用 TensorFlow 来训练一个模型玩《马里奥赛车 64》游戏。</p><p><br></p><p><strong>目标：</strong>作者想做个人人都能跟着“说明书”一步步理解和实现的机器学习 demo。</p><p><br></p><p>在不断的玩《马里奥赛车》游戏并且用 C 语言开发了一个模拟器后，作者得到了一个漂亮的结果。</p><p><br></p><p>下图是驾驶未经训练的 Royal Raceway 部分：</p><p><br></p><p><img src="/ArchNotes/images/514dbcdebb51b38dc35ccab7ccfb763209fc9489.jpeg" style="width: 480px !important; height: 270px !important; visibility: visible !important;"></p><p><br></p><p>动画参看：</p><p><span style="color: rgb(0, 82, 255);">https://media.giphy.com/media/1435VvCosVezQY/giphy.gif</span></p><p><br></p><p>下图是驾驶 Luigi Raceway 部分：</p><p><br></p><p><img src="/ArchNotes/images/805cf904ab8441bb1767f63810dbce50f552d429.png" style="width: 471px !important; height: 260px !important;"></p><p><br></p><p>动画参看 <span style="color: rgb(0, 82, 255);">https://youtu.be/vrccd3yeXnc</span></p><p><br></p><p><br></p><p>达到上面的成绩还是不容易的，作者想分享自己的经验和学习到的知识。</p><p><br></p><p><strong><span style="font-size: 18px;">训练数据集</span></strong></p><p><br></p><p>为了创建一个训练数据集，作者编写了一个程序来截图 Xbox 玩《马里奥赛车》游戏的桌面。然后作者跑一个任天堂 N64 模拟器，定位截图区域的位置，如下图：</p><p><br></p><p><img src="/ArchNotes/images/7a6f4bc4eba54422bf519fe5afd08d28b92345fb.png" style="border-width: 0px; border-style: initial; border-color: initial; vertical-align: middle; color: rgb(129, 129, 129); width: 480px !important; height: 238px !important;"></p><p><br></p><p>这只是作者开始该项目以来完成的部分成果。有趣的是在几年来做该项目中发现自己代码风格的变化以及工具选用的变化。</p><p><br></p><p><strong><span style="font-size: 18px;">机器学习模型</span></strong></p><p><br></p><p>刚开始是修改 TensorFlow tutorial 的字符识别的例子（ MNIST 数据集），改变输入层和输出层的大小，因为作者准备的图片比 MNIST 数据集中的 28 x 28 要大。修改图片大小的工作是非常无趣的，但是 TensorFlow 提供了很好的函数来帮助我们。</p><p><br></p><p>后来，作者转而使用 Nvidia’s Autopilot 来开发自动驾驶部分。这简化了数据预处理的代码，该模型可以直接将彩色图片转化成向量，而不需要手动转化成灰度图再展开为向量。</p><p><br></p><p><strong><span style="font-size: 18px;">训练模型</span></strong></p><p><br></p><p>为了训练一个 TensorFlow 模型，你必须定义一个 TensorFlow 优化函数。在 MNIST tutorial 中使用的优化函数是错误分类的总和，而 Nvidia’s Autopilot 中使用的是预测值和角度传感记录的差值。对于本项目来讲，有一些重要的游戏手柄输出。作者使用预测输出向量和记录值两者的欧式距离作为优化函数。</p><p><br></p><p>TensorFlow 一个最重要的特征之一是显式的函数定义。High Level 的机器学习框架会抽象，但是 TensorFlow 逼着开发者来思考发生了什么，帮助他们消除机器学习的神秘。</p><p><br></p><p>模型训练其实是本项目最容易的一部分。TensorFlow 有着优秀的官方文档，以及大量的 tutorial 和源代码。</p><p><br></p><p><strong><span style="font-size: 18px;">一显身手</span></strong></p><p><br></p><p>训练完模型，作者打算让其在《马里奥赛车 64》上一显身手。但是好像还缺点啥：如何将模型训练的结果转换到任天堂 N64 模拟器？首先，作者使用 python-uinput 来发送输入事件。该功能在作者以前的几个项目中能够作为游戏手柄工作，但是不幸地，这次不行。</p><p><br></p><p>接着作者深挖开发出 mupen64plus-input-sdl，所以作者觉得开发自己的输入插件是明智的。</p><p><br></p><p><strong>编写一个 mupen64plus 输入插件</strong></p><p><br></p><p>好长一段时间没写过一个像样的 C 程序了，我拿到一个原始输入驱动程序，做了一些简单的复制粘贴工作，我的目标是在模拟器中编译和运行一个插件。 当插件加载时，仿真器检查几个函数定义和错误（如果有的话）。这意味着我的插件需要定义几个空函数。</p><p><br></p><p>当插件工作后，我搞明白了如何设置控制器输出，让马里奥能够在跑道上无限的跑起来。</p><p><br></p><p><img src="/ArchNotes/images/805cf904ab8441bb1767f63810dbce50f552d429.png" style="white-space: normal; width: 471px !important; height: 260px !important;"></p><p><br></p><p>下一步是向本地服务器询问输入的内容。 这需要在 C 中发出 http 请求，这证明是个复杂的任务。人们抱怨分布式系统很难，的确是这样！经过解决几个小问题之后，我终于完成了消费数据并将其输出到内部的 N64 仿真器。</p><p><br></p><p>我完成的输入插件可以在GitHub上找到。</p><p><span style="color: rgb(0, 82, 255);">https://github.com/kevinhughes27/mupen64plus-input-bot</span></p><p><br></p><p><strong><span style="font-size: 18px;">玩《马里奥赛车 64》游戏</span></strong></p><p><br></p><p>现在是见证奇迹的时刻了，不过第一场比赛太让人失望了：马里奥直接开车撞到墙上，连一个弯都没转。</p><p><br></p><p>为了 debug，作者增加了一个手动的控制，当需要时才从 AI 获取控制。作者通过试玩，观察返回的输出结果，提出了两件需要 fix 的点：</p><p><br></p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p>重新检查训练数据时，作者发现偶尔有些截图是模拟器窗口的图片。解决方法是简单的从数据集中移除，继续训练。</p></li><li><p>作者注意到《马里奥赛车 64》是一种比较急速的游戏，典型的是你不能平缓的转弯。通常，游戏者需要在大转弯时来个急速调整。由于数据的混淆，一些《马里奥赛车 64》的图片在转弯的中间，假设模型学习从来不转弯，而这将导致一些小误差。模型训练仍然是一个优化问题，如果数据集有问题，那训练的结果也会这样。</p></li></ol><p><br></p><p>记住这些继续玩《马里奥赛车 64》游戏来记录新的训练数据。</p><p><br></p><p>随着上面两点的调整，作者得到更好的结果，见文章开始部分。</p><p><br></p><p><strong><span style="font-size: 18px;">最终畅想</span></strong></p><p><br></p><p>TensorFlow 是一个超级棒的 low level 抽象的深度学习框架。受益于 cuDNN，TensorFlow 的计算速度不错，并且梯度下降算法也是顶尖的。不过，如果再做另外一个深度学习项目的话，作者说不会直接使用 TensorFlow，而是更愿意尝试 keras ，keras 是基于 TensorFlow 基础上加了一些语法糖。</p><p><br></p><p>在寒假的几周里，作者已经能使用 Google 的自动驾驶技术来驾驶虚拟的赛车。数据训练大概 20 分钟之后，作者的 AI 已经可以驾驶大部分简单的赛道，Luigi Raceway 和未经训练的 racetack。作者期待使用更多的数据来构建一个完整的 AI 自动驾驶马里奥赛车 64 游戏。</p><p><br></p><p><span style="font-size: 18px;"><strong>源代码</strong></span></p><p><br></p><ul class="list-paddingleft-2" style="list-style-type: disc;"><li><p><span style="color: rgb(0, 82, 255);">http://github.com/kevinhughes27/TensorKart</span></p></li><li><p><span style="color: rgb(0, 82, 255);">http://github.com/kevinhughes27/mupen64plus-input-bot</span></p></li></ul><p><br></p><p>延伸阅读</p><p><br></p><p>OpenAI 公司开发的 AI 框架。</p><p><span style="color: rgb(0, 82, 255);">https://openai.com/blog/universe/</span></p><p><br></p><p>Commaai 是一家致力于研发基于人工智能技术的汽车无人驾驶系统的公司，也发布他们的自动驾驶的源代码。</p><p><span style="color: rgb(0, 82, 255);">https://github.com/commaai/research</span></p><p><br></p><p style="font-size: 16px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">本文作者 KEVIN HUGHES，由侠天翻译，转载请注明出处，技术原创及架构实践文章，欢迎通过公众号菜单「联系我们」进行投稿。</span><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="font-size: 16px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><br></span></p><p style="font-size: 16px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">侠天，专注于大数据、机器学习和数学相关的内容，并有个人公众号：bigdata_ny 分享相关技术文章。</span></p><p><br></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 20px; box-sizing: border-box !important; word-wrap: break-word !important;">推荐阅读</span></strong></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="max-width: 100%; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; width: 728.641px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548680&amp;idx=1&amp;sn=85102002a7cb5bbb119604b2666baa1c&amp;chksm=813a6110b64de806aae8ad702e6f025f5217d72e71cf5fa3135015002d8c0cfe65bf869eae4b&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548680&amp;idx=1&amp;sn=85102002a7cb5bbb119604b2666baa1c&amp;chksm=813a6110b64de806aae8ad702e6f025f5217d72e71cf5fa3135015002d8c0cfe65bf869eae4b&amp;scene=21#wechat_redirect" style="text-decoration: underline; font-size: 14px; color: rgb(0, 82, 255);"><span style="font-size: 14px; color: rgb(0, 82, 255);">问答系统中机器学习算法应用：Quora 2017年ML平台规划</span></a><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548693&amp;idx=1&amp;sn=39787591b01bda4fd7b832aee0d634e2&amp;chksm=813a610db64de81b7a313d19ccf8b254a9bb355f8432857612d471352375c512b2af56339869&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548693&amp;idx=1&amp;sn=39787591b01bda4fd7b832aee0d634e2&amp;chksm=813a610db64de81b7a313d19ccf8b254a9bb355f8432857612d471352375c512b2af56339869&amp;scene=21#wechat_redirect" style="text-decoration: underline; font-size: 14px; color: rgb(0, 82, 255);"><span style="font-size: 14px; color: rgb(0, 82, 255);">人工智能应用微服务化：从模型到线上系统搭建的最佳实践</span></a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548691&amp;idx=1&amp;sn=94d1cd11f398929013dae85fdd468fc9&amp;chksm=813a610bb64de81d1d92e82cb1ba2425681b5f88b167b581fc9ffc45ac4c496bdaa681f1e4bf&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548691&amp;idx=1&amp;sn=94d1cd11f398929013dae85fdd468fc9&amp;chksm=813a610bb64de81d1d92e82cb1ba2425681b5f88b167b581fc9ffc45ac4c496bdaa681f1e4bf&amp;scene=21#wechat_redirect" style="text-decoration: underline; font-size: 14px; color: rgb(0, 82, 255);"><span style="font-size: 14px; color: rgb(0, 82, 255);">创业过5家大数据公司，Kaggle竞赛冠军：互联网深度学习误区—花大力气在那些影响力很小的事情上</span></a><br></p></li></ul><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><br></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">高可用架构</strong></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">改变互联网的构建方式</strong></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="/ArchNotes/images/f6d330d516dce1ccc8afa78eadcccb86f8851363.jpeg" style="box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 200px !important; height: 200px !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></strong></span><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">长按二维码 关注「高可用架构」公众号</span></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1496016930&src=3&ver=1&signature=1Hp-JGX68UwholXKdYsHgB5lnsSjL7IwmEgqPuFWPOG0*S*s8q-dgRBIq4NYLQ0KRWo8tCHRtd0kOPhiUCLP56ItZ5xVpcu0FglQ3DZ5O3TzepLR5KvYwBPB9aP02c3A8QBS6vX3RMF-qPezo88czXjYDsHTo*Jsu4etlJc6LP4=">微信地址</a> | <a href="http://kevinhughes.ca/blog/tensor-kart">阅读原文</a>
{% endraw  %}

