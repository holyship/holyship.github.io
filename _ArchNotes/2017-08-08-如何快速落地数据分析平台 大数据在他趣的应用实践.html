---
title: 如何快速落地数据分析平台 大数据在他趣的应用实践
author: 张嵩
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1503366004&src=3&ver=1&signature=OYewMZH60kmig22U24i7m9KATgmqVaMHgld42a4AbVw*ZdsI-1U0VHgIZB8eM2c5t*lRBBWGes32Ij-wSvxIuqGo2uYV*7KTt**ZP-VQrwwgtTXcUwdmQqHePAoeUm9UJZVOlevmcJ3Ocm4*EkHwgKoolBZDvBbHCvvEbRKcu4A=
date: '2017-08-08 00:00:00 +0000'

---

{% raw  %}
<p><inherit style="display: block;"><span class="" style="font-size: 10pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color: rgb(65, 70, 75); font-size: 10pt;">导读：大数据发展到现今阶段，</span><span style="font-size: 10pt;">平台和技术的应用也开始普遍，</span><span style="color: rgb(65, 70, 75); font-size: 10pt;">大部分企业已经对大数据技术和应用有了初步了解，大数据部门在很多公司都得以组建并高度重视。但是实际上，很多企业的数据量其实并不是很大，可能只能称为小数据或者中数据，只是业务的倒逼使得它们必须使用到大数据的方案，而对于这个阶段的公司来说，其主要困难在于大数据的场景应用，即如何利用大数据来提升业务，如何利用数据创造价值上。他趣首席架构师张嵩在由七牛云主办的“架构师实践日（厦门站）”中，详细分享了对于大数据的实践经验。</span></span></inherit><inherit style="display: block;"><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;"><br></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 12pt !important;">讲师简介</span></inherit></p><p><inherit style="display: block;"><span class="" style="   display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: center; "><img src="http://mmbiz.qpic.cn/mmbiz_jpg/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GB5zfDkzKs7GmxP9VLbPNPfl1LnbGJaGfY9HuPf3EuvEmqiaZIgoibH1g/0?wx_fmt=jpeg" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 150px !important; height: 150px !important; visibility: visible !important;"></span></inherit></p><p><inherit style="display: block;"><br></inherit></p><p><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">张嵩，厦门大学计算机硕士毕业，现于他趣任首席架构师，主要负责微服务体系健全及持续交付体系建设。Go</span><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">语言爱好者及c</span><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">ontributor</span><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">，近期专注于</span><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">k8s</span><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">在他趣的第二版落地及探寻 Machine Learning 在社区的应用。</span></p><p><inherit style="display: block;"><span class="" style="height: 0px; display: block; margin-top: 1em; margin-left: -2px; margin-bottom: 1em; border-bottom: 0px solid rgb(65, 70, 75);"></span></inherit></p><hr class="" style="height: 0px; box-sizing: content-box; border-bottom: none; border-left: none; border-top-style: solid; border-top-color: rgb(153, 153, 153); border-right: none;"><p><br></p><p><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">在各种 RDB 的支撑下，通过埋点等我们已经能够实现各种业务统计、监控、分析等方面的需求，但是我们会最先触碰到哪些瓶颈呢？而碰到瓶颈后又要如何通过大数据应用来解决呢？这是本文想要着重探讨的地方。</span></p><p><strong><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;"><br></span></strong></p><p><inherit style="display: block;"><span style="font-size: 15px;"><strong><span class="" style="border-bottom: 0px solid rgb(65, 70, 75);">探索三步曲 步步简化</span></strong></span></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5G5tibNHzcQNqUYs1bnK2E6iaYicLQ9bE3UJQQ0Mwg93a2InzaBG1R8V09w/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 257.908px !important; visibility: visible !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 1&nbsp;&nbsp;&nbsp;&nbsp;</span></inherit></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 1 是一个常见的情况，在每一台服务器日志上去部署一些数据分析，简单分析后会上报到RDB Redis上，之后会进行二次运算，紧接着到达展示层；在这个过程中，查询日志可以在ELK上进行。这算是比较简单的一个方案，基本可以满足大家的需求。但是这样做也会产生一些问题：</span></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">新增不易；</span></p></li></ul><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 一开始的条件都是写好的话，每一个新增都需要写一个模板，所以新增很麻烦。</span></inherit></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">直接统计出结果数据集过于庞大，二次运算的复杂度取决于空间的维度；</span></p></li></ul><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如果每次都直接统计出一个结果的话，最后就会导致整个数据集越来越大。例如查询来自安卓，渠道为小米(版本号：6443)，时间粒度为5min的订单；遇到这样的情况，假如直接统计出结果，因为需要维护的版本号大约有两百多个，渠道号约有六七十个，平台约四五个，那么5min需要维护的数据就会累积，结果集就会很庞大。</span></inherit></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">可接受的时间复杂度</span></p></li></ul><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">时间复杂度就是后台进行查询的时间，二次结果如果数据量大了，查询复杂结果数据就会耗费很长的时间。</span></inherit></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">集群维护复杂度</span></p></li></ul><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">每一台机器上都需要写脚本去统计数据，所以每次新增都要重新rsync等，这样集群的维护就会很复杂。</span></inherit></p><p><inherit style="display: block;"><br></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GZAw66lIKJibH4yOOu5GNIDmJmmRpr4vV0zILhKot7zQrwqPsIbNONmQ/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 526px !important; height: 208px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 2</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;"><br></span></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">鉴于这几个问题，我们将需求重新整理，如图 2 所示，最开始（从左至右）是数据源，数据源包含很多，比如日志；第二步是数据处理清洗，主要的目的是将一些不需要的数据清除掉；第三步是落存储，有很多方法，比如HBase；最后一步就是数据应用，比如做一些统计报表、进行报警之类的应用。</span></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5G3eqf2nGfDge5G8DA4x22zthYibAib27AgGU5GQ9ibfVriargqKjErH8UTg/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 254.243px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 3</span></inherit></p><p><inherit style="display: block;"><span style="border-bottom: 2px dotted rgb(65, 70, 75); font-size: 15px;"><br></span></inherit><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">再细化下的话，底层是数据源，服务器日志代表的是半结构化的数据，数据库代表的是结构化数据，图片代表的是非结构化的数据；向上一层是数据收集传输层，包含 Kafka 和 Flume（日志收集系统）两种组件；第三层是数据存储层，这一块主要是使用 HDFS 与 HBase。第四层是数据计算层，包括 Spark、MR、Storm；顶层是数据应用层，进行一些数据开发和展示功能。图 4 便是我们第一代的结构图。</span></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GpCO2pic87dGQeapULeyiasd0XSrKHqdl8zckFTPq8UpYWEHZwmphv94w/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 582px !important; height: 286px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 4</span></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5Gygp46p2eoibDH3PSy1Ebh81D0xRPeh4zV6tZGdFyibKPuhossnzsGC9Q/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 393.548px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 5</span></inherit></p><p><br></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 5 是一代的流程图。从数据源，也就是服务器上日志开始，数据流经 Flume，到达 Kafka后，分成两路流（实时流与非实时流），一路推入HDFS、一路经过 Storm 进行处理；非实时流主要是用 MR 和 Spark，进行清洗加工后将数据存储到 HBase；实时流则经过 Spark&nbsp; Streaming&nbsp;、Storm处理，最终也是存储到 HBase。这些是早期比较常见的结构。</span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">这种结构下，组件之间兼容问题很多；人力成本消耗大；batchjob、streaming资源、核心非核心资源的竞争难以隔离；由于作业之间依赖关系会导致作业管理复杂；</span></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GWPqsXOJXe7AbthAf8vUvRKX1T5jkFCx3Cib48OPN0aBRiblibX2ia4lTIA/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 595px !important; height: 229px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 6</span></inherit></p><p><inherit style="display: block;"><span style="border-bottom: 2px dotted rgb(65, 70, 75); font-size: 15px;"><br></span></inherit><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">因为成本问题，我们规划了第二代的结构图，如图 6 所示。</span></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5Gl1OL1pHlqhiaZWXEmOTiaoaicgU3XPD6Pibicbc3qFJGApLz5n3AHMvptRw/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 397.496px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 7</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;"><br></span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 7 是二代的流程图。我们使用了阿里的 EMR、MAXComputer 等产品，此时，服务器则使用的是 LogStash，日志服务则使用&nbsp; LogHub，存储则采用OSS。这里也产生一些新的问题。首先，日志服务相对自己搭建ELK要简易很多，但是索引按照字段大小收费，价格较高；其次，不同组件间集成异常繁琐；第三虽然扩容方便，但是人力并未得到释放；第四内存型计算服务可以实现准实时分析出数据，但是价格偏高；第五是资源竞争问题难以隔离的问题依然存在；第六就是产品变更太快，有时候产品会突然下线或者功能迁移到新的产品中。</span></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GrjfTpYFA7GUoxMfzEbqCrAu7wo1BS96Z3xZyWBZIyz88oibDWJDUNOw/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 581px !important; height: 191px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;"><br></span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 8 是我们最新的结构图。在第三代中我们采用了七牛云的大数据产品，他们会把一些不属于我们应该做的操作直接放在他们自己的平台上，由他们进行维护，这个产品就是他们的大数据产品Pandora。</span></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5G0MC7CAkX6mMPickt8icfnE1Lv3ic2fBUuP63347ofOibOrlpofl3JNZNiaw/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 363.141px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 9</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;"><br></span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 9 也是我们最新的一个流程图。最开始还是服务器，然后是Logkit，当搜集到数据源之后，将非实时数据打到对象存储上，利用离线计算去处理这些工作流，经过离线计算的工作流，如果需要做二次计算或存储就再次返回到对象存储，如果需要直接计算出结果的话，就直接写入到J16组件上，J16是我们自己写的接收http结果的组件，实心箭头代表现在这块还未完善，我们是通过额外的脚本进行结果收集到J16的操作；实时数据也采用类似于离线处理的方式，后面步骤与离线计算一致，处理之后的数据，可以用于展示报表和数据挖掘。</span></p><p><br></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">这三张结构图一张比一张简单，而且我们自己承担的东西越来越少，其中也包括人力资源的消耗。同时，迁移是很麻烦的一件事情，在一开始最好就选定一种结构，尽量不再修改；</span></inherit><inherit style="display: block;"><br></inherit></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">类似于saas的最后一种流程，可以让我们的人力接近完全解放。同时组件不存在集成与兼容的问题。因为上面设计的离线工作流和在线工作流是完全分离的，所以资源可以完全隔离。</span></p><p><inherit style="display: block;"><strong><span style="font-size: 15px;"><span class="" style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);"><br></span></span></strong></inherit><inherit style="display: block;"><strong><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">实战分享 少走弯路</span></strong></inherit></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">讲到实战，首先对我们目前的情况做一下简介。</span></inherit></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">【数据方面】</span></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">日均500GB数据增量；</span></inherit></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">日均产生几十亿条日志数据；</span></inherit></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">客户端SLA、数据库审计数据等未迁移；</span></inherit></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">【业务】</span></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">商城、社区、直播、运维等</span></inherit></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">【数据处理】</span></inherit></p><p><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">分析、统计、监控、告警等</span></inherit><inherit style="display: block;"><span style="border-bottom: 2px dotted rgb(65, 70, 75); font-size: 15px;"><br></span></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GqRL9MK9vOibfhr4W7VEWicuHlJGe2LwibZmVAwANoic0yv0CB4iaoYWpj9Q/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 470px !important; height: 243px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 10</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;"><br></span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">如图 10 所示，我们的业务和数据处理之间其实是相互交叉的。</span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">为了减少大家在实际过程中碰到的弯路，所以我会分享一些实践上的经验，供大家参考。</span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">从数据源开始，数据源常见的是nginx、tomcat、fpm、网关、业务、数据库日志、上报异常、Sla日志等客户端统计数据。</span></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GKkT6mMVibJl00wIddcVPj39ztXibBib0PrZkd0J08NAXVzIDI22r6RDcA/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 410.777px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">&nbsp;&nbsp;&nbsp; 图 11</span></inherit></p><p><inherit style="display: block;"><br></inherit><inherit style="display: block;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">日志统计是一个比较麻烦的事情，最开始接入，如果不统一日志格式，那么之后再进行日志分析就很困难，因为后期如果修改日志格式则所有的建模都要进行修改，非常麻烦，所以在一开始就要选择并且确定一种日志格式。</span></inherit></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 11 是 nginx 的日志，涵盖的内容很多，比如设备号、跟踪IP、UA头；微服务存在一个很大的问题，就是如何处理用户日志追踪；处理方式就是当客户端进行访问时，带一个唯一的ID号，最终通过这个ID号可以直接抓出这次所有落在不同服务的请求数据。</span></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: center; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5G8hSaxblkUqLVJLBSjc4TaetFcsnnicxvw2mtRSWfso0dFTyucHGFmNQ/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 552.028px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 12</span></inherit></p><p><inherit style="display: block;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图&nbsp;12 是业务层的一个日志。</span></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GQWmFbHFEwT8a1YJUXyzrEu5GRl9LckuDVQ0XaicxQUhzxsYfp3rNFeg/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 324.266px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 13</span></inherit></p><ul class="list-paddingleft-2" style="list-style-type: none;"><li><p><br></p></li><li><p style="text-align: left; text-indent: 0em;"><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75);">图 13 是日志查询界面，为服务端人员提供查询功能。可以通过设备号，唯一请求ID等，得到客户端的请求日志，也可以支持高级的自定义查询功能。</span></p></li></ul><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5G7OoUHNkcq1f8I7ACXiaQCqCtel1qS9Bz0B41q7kwnNPQN7qQ8vMOIvg/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 313.498px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;">图 14</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;"><br></span></p><p><span style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21);">图 14 是时序图，通过这张图，可以判断到底是自己调用其他系统服务时耗费时间长还是自己进行查询时耗费时间长，以及慢查询发生在何处，是因为查询数据库慢了还是其它的原因。</span></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GqIuExtqibvYg2sxEjZk71Jdia0iaCTzIsNRJrlELypnhCdfDhaoJ5BjIA/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 294.844px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 15</span></inherit></p><p><inherit style="display: block;"><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;"><br></span></inherit><inherit style="display: block;"><span style="font-size: 15px;"><span class="" style="font-size: 15px; border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21);">图 15 是对之前统计的数据所做的一些应用。比如说API状态码统计；SOA调用状态码统计，前一天发生了多少次SOA请求</span><span class="" style="font-size: 15px; border-bottom: 2px dotted rgb(65, 70, 75); color: rgb(13, 0, 21);">。</span></span></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GOjwmJ9Awt56vibz5XFL9GCDyicorH0pDcuLehztbJq1Joiapt08IVTeSg/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 300.279px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;">图 16</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;"><br></span></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 16 是业务在服务器上运行的时间，这边可以反映出代码的质量问题。比如两秒以上的接口几乎都是比较复杂的接口，例如下单操作或者调用第三方接口。</span></p><p><inherit style="display: block;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">通过慢查询数据，我们可以有针对性地去做优化，例如每天出一个报表，通过数量去做一个排序比如第一个接口发生了五十多万次慢查询，这一定是新迭代修改过的接口，因为我们每两周三次迭代，每次上线之后可能会导致一些修改过的接口变慢。通过这个报表的话我们就可以实时知道说这次迭代是否有性能问题会影响到用户的体验。</span></inherit></p><p><inherit style="display: block;"><br></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GhL0icbPbYKQgH6xBSVZPU5E1GCiaZtyqzcwAbmMl0iaxIGXNSquIoch1g/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 270.058px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 17</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;"><br></span></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;">图 17 是微服务带来的问题，微服务有一个版本控制，比如微博接口也从V1、V2、V3一路升上来，就很难确定说什么时候可以下掉这些旧版本，比如我已经升级到V4版本，但是我的V2版本由于旧版本客户端的原因，需要还能够使用。这样子的话一旦出现bug，就必须V2、V3、V4都打一个补丁过去，对开发人员来说是一个很大的负担。</span></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;">有分析的话，就可以统计处哪些版本访问量对高，哪些版本访问量最低，这样我们就可以不断地根据访问情况下掉旧版本的系统，少维护一些系统。然后也可以知道使用这些API的客户端到底是哪些版本，有没有包括当前最新的版本，有的话就不能下架，需要安排逐步修改。例如今年我们就下掉了六七个版本。</span></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;">也可以通过历史数据来做一些运维方面的自动化，例如通过前一七天带宽等的分析来做到带宽的自动增减，以及类似推送高峰期前自动扩容等的各种操作。</span></p><p><inherit style="display: block;"><br></inherit></p><p><inherit style="display: block;"><span style="display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: inherit; font-size: 15px;"><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5G4E7ydPysRGCOVDmExyY9nOYJqD1dlVcfbFGAztfNqIfNu0TWmwvwfw/0?wx_fmt=png" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 610px !important; height: 361.45px !important;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span style="border-bottom: 0px solid rgb(65, 70, 75); font-size: 15px;">图 18</span></inherit></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;"><br></span></p><p><span style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(13, 0, 21); font-size: 15px;">我们每天都要应对不同的攻击，例如CC攻击这一块，我们有做一些WAF的防御，还有网关的限流，但是因为阈值的关系，也很难说完全限制住。这个时候我们可以实时的统计当前有哪些客户端访问的数目是异常偏高的，例如图18，我们看最高都是在上面那五条线，每秒钟可能都有几十万人访问，这五个设备访问频率在里面出现次数最高，就说明有异常。这种就可以做一些特殊处理，针对异常设备进行限流。因为你很难说对所有的设备进行限流，有时候客户端的访问确实会很高，比如抢红包之类的。</span></p><p><inherit style="display: block;"><span class="" style="border-bottom: 0px solid rgb(65, 70, 75);">－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－</span></inherit></p><p><inherit style="display: block; text-align: center;"><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;"></span></inherit></p><p><inherit style="display: block; text-align: center;"><span class="" style="color: rgb(55, 118, 166); font-size: 11pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color:#3776a6"><span style="font-size: 11pt;"><span style="font-weight: 700;">8月19日 北京</span></span></span></span></inherit></p><p><inherit style="display: block;"><span class="" style="color: rgb(65, 70, 75); font-size: 10pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color:#41464b"><span style="font-size: 10pt;">七牛云携手链家，共同推出</span></span></span><span class="" style="color: rgb(65, 70, 75); font-size: 10pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color:#41464b"><span style="font-size: 10pt;"><span style="font-weight: 700;">“</span></span></span></span><span class="" style="color: rgb(55, 118, 166); font-size: 11pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color:#3776a6"><span style="font-size: 11pt;"><span style="font-weight: 700;">大数据最新场景化应用实践</span></span></span></span><span class="" style="color: rgb(65, 70, 75); font-size: 10pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color:#41464b"><span style="font-size: 10pt;"><span style="font-weight: 700;">”</span></span></span></span><span class="" style="color: rgb(65, 70, 75); font-size: 10pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color:#41464b"><span style="font-size: 10pt;">主题架构师实践日</span></span></span></inherit></p><p><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">七牛云技术总监陈超、链家网大数据部负责人吕毅联袂出品，精选干货内容：</span></p><ul class="list-paddingleft-2" style=""><li><p><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">链家网资深大数据研发工程师邓钫元，分享如何运用“开源＋自身业务定制”解决大数据多维分析痛点</span></p></li></ul><ul class="list-paddingleft-2" style=""><li><p><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">七牛云大数据高级工程师党合萱，全面揭秘七牛自主研发千亿级大数据平台的实践之路</span></p></li></ul><ul class="list-paddingleft-2" style=""><li><p><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">蚂蜂窝大数据平台负责人汪木铃带来蚂蜂窝作为国内最早一批使用 Druid 的公司，在实战过程中踩过的“坑”和优化经验</span></p></li><li><p><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">前新浪微博技术专家、三好网 CTO 卫向军，讲解如何利用大数据技术方案在实际业务应用中增值</span></p><p><br></p></li></ul><ul class="list-paddingleft-2" style=""></ul><p><inherit style="display: block;"><strong><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">高可用架构粉丝福利：</span></strong></inherit></p><p><inherit style="display: block;"><strong><span class="" style="border-bottom: 0px solid rgb(65, 70, 75); color: rgb(65, 70, 75); font-size: 10pt;">点击“阅读原文”即可享免费报名</span></strong></inherit><inherit style="display: block;"><span class="" style="color: rgb(55, 118, 166); font-size: 11pt; border-bottom: 0px solid rgb(65, 70, 75);"><span style="color:#3776a6"><span style="font-size: 11pt; font-weight: 700;">提供精彩留言点赞最多的十位读者即可现场领取七牛云限量定制纯棉T恤一件！</span></span></span></inherit></p><p><inherit style="display: block;"><br></inherit></p><p><inherit style="display: block;"><span class="" style="   display: block; width: 613px; min-height: 60px; border-width: 1px 1px 0px; border-style: solid; border-color: transparent transparent rgb(65, 70, 75); text-align: center; "><img src="http://mmbiz.qpic.cn/mmbiz_jpg/8XkvNnTiapOOyK8Gc7EwPHNhC48ZnMt5GN35p4c4PZQATMDf6YQycG3bZXCcXTtsx4ia5Ros1IInTYBQwibyQTa5Q/0?wx_fmt=jpeg" style="border-width: 0px; border-style: initial; border-color: initial; cursor: default; width: 335px !important; height: 251.25px !important;"><br></span></inherit></p><p style="text-align: center;"><strong style="max-width: 100%; color: rgb(62, 62, 62); font-size: 16px; text-align: center; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 20px; box-sizing: border-box !important; word-wrap: break-word !important;">&nbsp;推荐阅读</span></strong></p><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=207366121&amp;idx=1&amp;sn=7e272b5b498db9c503b895f218ee6ef8&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: underline;"><span style="font-size: 15px;">【图文直播全文记录】酷狗音乐的大数据实践（纯干货）</span></a><br></p><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653547838&amp;idx=1&amp;sn=0296bc661fff4306f5b67baec0f9e982&amp;chksm=813a7ca6b64df5b03fbc4949bb050ae144da0c09457b0d3168e24a3c9a20e945c07b9a23bdfb&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: underline;"><span style="font-size: 15px;">未来大数据平台：使用Zeppelin和Spark一键搭建数据分析及可视化平台案例</span></a><br></p><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=403255855&amp;idx=1&amp;sn=1b8a4c9edcc5c7bf8306adcd9dc66e8f&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px; text-decoration: underline;"><span style="font-size: 15px;">【年度案例】大数据盘点之Spark篇</span></a><br></p><p><br></p><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">高可用架构</strong></span></p><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">改变互联网的构建方式</strong></span></p><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOPOK9rQud9XibGhPOPsA3gA8Wr4CEnzmhfZQzSGu0Q09GOuk18S9icZtuVnQewvyqZtOWyDnJPBDn1A/640?wx_fmt=jpeg" style="box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 200px !important; height: 200px !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></strong></span><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">长按二维码 关注「高可用架构」公众号</span></p><p><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><br></span></p><p><br></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1503366004&src=3&ver=1&signature=OYewMZH60kmig22U24i7m9KATgmqVaMHgld42a4AbVw*ZdsI-1U0VHgIZB8eM2c5t*lRBBWGes32Ij-wSvxIuqGo2uYV*7KTt**ZP-VQrwwgtTXcUwdmQqHePAoeUm9UJZVOlevmcJ3Ocm4*EkHwgKoolBZDvBbHCvvEbRKcu4A=">微信地址</a> | <a href="http://www.huodongxing.com/event/6399093228300">阅读原文</a>
{% endraw  %}

