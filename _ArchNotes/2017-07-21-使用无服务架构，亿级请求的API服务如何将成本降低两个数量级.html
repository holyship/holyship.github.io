---
title: 使用无服务架构，亿级请求的API服务如何将成本降低两个数量级
author: Jesse 译
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1502116814&src=3&ver=1&signature=fMd4ZeYncDjRuvdiU8EiAnUULkvryB4DXbE6sTjTCTqAU6Wo3FeIV0BwKDpBDcxRzySp9S3gfEatTuMceIQGwycvRcW24uW9xPg1f*INBhnoi2zDslQ7R-7U*h9ecnjAMYFGa1eyCWULjZqxWKcIT753C9Zx1VRjonJKWeDj5aI=
date: '2017-07-21 00:00:00 +0000'

---

{% raw  %}
<p><span style="color: rgb(136, 136, 136); font-family: 'Helvetica Neue', STHeiti, 'Microsoft YaHei', Helvetica, Arial, sans-serif; font-size: 14px; background-color: rgb(255, 255, 255);">Serverless 是当今软件架构领域最热的话题，本文作者使用 Serverless 架构重构了 Readability Parser API，使得 API 成本大幅度下降，尽管其架构是基于 AWS，但对于我们通用的架构仍然具有参考价值。</span><br></p><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">当我去年加入 Postlight 时，第一个任务是重写转码服务（Readability Parser API）。转码服务为稍后阅读应用程序以及其他服务提供 API 支持，它接受互联网上任何文章的链接，然后返回了该文章的结构化内容展示（它可以从网络上混乱的内容中提取结构化内容）[1]。 <br><br>重写的原因有三个：<br></span></p><p><br></p><ol class="list-paddingleft-2"><li><p style="text-align: justify;"><span style="font-size: 15px;">API 多年来变得老旧而脆弱，解析结果都存储在数据库中，这意味着整个数据库非常庞大。执行稍微复杂的查询都有问题，这意味着我们对 API 内部发生了什么一无所知。同时也存在原始文章如果更改，API 响应将不会包含更新的结果。</span></p></li><li><p style="text-align: justify;"><span style="font-size: 15px;">最初作者已经不在公司了，新工程师缺乏必要的领域知识。</span></p></li><li><p style="text-align: justify;"><span style="font-size: 15px;">最重要的是这个服务每月要花费公司大约 10,000 美元。</span></p></li></ol><p><br></p><p><span style="font-size: 15px;">重写的几个目标：<br></span></p><p><br></p><ol class="list-paddingleft-2"><li><p><span style="font-size: 15px;">生成功能相同的库，返回与原始代码相同的结果。</span></p></li><li><p><span style="font-size: 15px;">工程师可以轻松贡献代码。</span></p></li><li><p><span style="font-size: 15px;">减少每月产生的费用。</span></p></li></ol><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">对于语言，我们选择了JavaScript。选择 JavaScript 意味着代码理论上可以在服务器或浏览器中运行。 公司的每个工程师都有 Web 编程经验，所以选择 JavaScript 也意味着几乎每人都可以给新项目提交代码。 旧的代码是用 Python 编写的，但是 Python 缺乏浏览器运行的优势。<br><br>为了大幅度降低成本，我们选择了运行在 AWS Lambda[2] 和 API Gateway[3] 上的无服务器架构，它使用 Serverless 框架[4]来构建和部署。<br><br>去年十月，我们发布了 Mercury Web Parser[5]，结果令人震惊。我们的成本大幅度下降，Mercury Web Parser 每月的成本约为 400 美元，比老的服务的成本要低两个数量级。 （当然也是因为需求或架构略有不同，以前的费用也包括数据库费用，而现在的无服务器架构使用缓存，因此存在数据库开销。）<br><br>以下是我们如何实现的一些细节。</span><br></p><p><br></p><h2><span style="font-size: 18px;"><strong>1、使用无服务器架构</strong></span></h2><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">假设您以在无服务器环境中满足需求，采用无服务器架构将大大降低成本。简单地转到无服务器环境对降低托管成本有很大帮助。在我们完成改变之后，运行成本降低两个数量级。即使在切换到无服务器架构之后，仍然有降低成本的余地。<br><br>如果您对 Lambda 没有任何经验，则其定价将如下所示：<br><br></span></p><blockquote style="text-align: justify;"><span style="font-size: 15px;">Lambda 免费套餐包含每月 1M 免费请求以及每月 400,000 GB 秒的计算时间。您为 Lambda 函数选择的内存大小决定着它们能以免费套餐运行多久。Lambda 免费套餐在 AWS 免费套餐 12 个月的期限到期后不会自动过期，而是无期限地提供给现有的和新的 AWS 客户。</span></blockquote><p style="text-align: justify;"><br><span style="font-size: 15px;">当您希望在 Lambda上优化成本时，最重要的是该函数分配的内存大小决定运行成本。该成本与执行函数所需的时间成比例增加或减少。<br><br>（注意：GB-seconds 是分配给函数的内存及执行时间的计量单位，例如，如果你调用一次 3 秒钟的函数，并且你已经为该函数分配了 1GB 内存， 就是执行了 3GB-seconds 的计算时间，如果将该分配减少到 512MB，执行时间保持 3 秒，则将计算时间缩短到 1.5GB-seconds。）<br><br>这意味着您可以通过加快执行函数所需的时间，降低内存分配或两者都用来降低 Lambda 成本。由于我们程序的执行速度已经很不错了，所以降低内存是显而易见的选择。</span><br></p><p><br></p><h2><span style="font-size: 18px;"><strong>2、降低内存分配</strong></span></h2><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">Lambda 的内存分配范围从 128MB 到 1536MB。降低 Lambda 成本的过程很简单。持续降低您的 Serverless 配置中的 <span style="font-size: 15px; background-color: rgb(214, 214, 214);">memorySize</span> 分配，部署，然后关注您的函数的执行延迟。如果我们的函数的延迟在几个小时后没有显示出显着的变化，那么我们会保留变化并降低成本。<br><br></span></p><p style="text-align: justify;"><span style="font-size: 15px;">请记住，每次将函数的内存分配减半时，您的 Lambda 成本大致减半。例如，根据官方的 Lambda 定价计算器，100 万次调用（不包括免费级别），平均运行 2 秒（不快，不是特别慢），分配 1GB 内存，将花费 33.54 美元。如果使用 512MB，将花费 $16.87。 256MB 花费 $8.54。<br><br></span></p><p style="text-align: justify;"><span style="font-size: 15px;">对于转码服务，我们目前运行的函数使用 256MB 配置。</span><br></p><h2><br></h2><h2><span style="font-size: 18px;"><strong>3、API Gateway Responses 缓存</strong></span></h2><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">API Gateway 中的缓存响应可以显著减少 Lambda 调用。 例如，用户通常会为相同的文章发起请求。 我们每个月只需要为 API Gateway（使用 0.5GB 内存，1 小时TTL）支付约 14 美元。 在上个月，API 请求中有 52％（2 千万）由缓存命中返回，这意味着只有不到一半（1870 万请求）需要调用我们的 Lambda 函数，这可以为我们节省 240 美元。</span><br></p><h2><br></h2><h2><span style="font-size: 18px;"><strong>关于可伸缩性的注意事项</strong></span></h2><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">除了节省成本之外，无服务器架构也可能会大大降低维护/配置成本以及复杂性。 我们的 API 可以使用相同的配置，缓存和部署方法来为 1,000 个请求到 100,000,000 个请求提供服务。<br><br></span></p><p style="text-align: justify;"><span style="font-size: 15px;">此外，随着服务的扩展，成本并不一定会增加。 毕竟超过一半的 API 请求可以由我们的缓存提供服务。 </span><br></p><p><br></p><h2><span style="font-size: 18px;"><strong>最终成本</strong></span></h2><p><br></p><p><span style="font-size: 15px;">在上述所有优化之后，我们目前运行 Mercury Web Parser API 的成本如下所示：</span><br></p><p><br></p><h3><span style="font-size: 15px;"><strong>API 网关</strong></span></h3><p><span style="font-size: 15px;"><strong><br></strong></span></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 15px;">服务费用为137美元</span></p></li><li><p><span style="font-size: 15px;">缓存：$ 14</span></p></li><li><p><span style="font-size: 15px;">数据传输：$ 42（这是以0.09美元/ GB计算）</span></p></li></ul><h3><br></h3><h3><span style="font-size: 15px;"><strong>LAMBDA</strong></span></h3><p><span style="font-size: 15px;"><strong><br></strong></span></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 15px;">请求费用：3美元</span></p></li><li><p><span style="font-size: 15px;">计算成本：$ 174（平均2.37s /调用，内存分配256MB）</span></p></li></ul><p><br></p><p><span style="font-size: 15px;">总成本：$ 370<br></span></p><p><br></p><h2><span style="font-size: 15px;"><strong><span style="font-size: 20px;">看好无服务器架构的未来</span></strong></span></h2><p><br></p><p style="text-align: justify;"><span style="font-size: 15px;">我们已经使用 Lambda 做了很多事情，从解析网页到编写 Slack 机器人; 从批量转换数十万张照片到转码数十万部影片。<br><br>我们越多使用它，就越认为无服务器架构解决了很多问题。到目前为止，Mercury Web Parser 及其所使用的工具一直是我们决定使用无服务器架构的最佳验证。</span><br></p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_jpg/8XkvNnTiapOOlVqt3EvfVu4xoDCGF7AcOSQwLtfsIf3n4qiciaHBBiacj2JL0ibhnm8Or0pjnEIL1S7RricjXAe4ksSg/0?wx_fmt=jpeg" style="width: 770px !important; height: 388.468px !important;"></p><h2></h2><h2><span style="font-size: 18px;"><strong><br></strong></span></h2><h2><span style="font-size: 18px;"><strong>关于我们的转码服务</strong></span></h2><p><br></p><p><span style="font-size: 15px;">在 Postlight，我们使用了 Mercury Web Parser 来支持：<br></span></p><p><br></p><ul class="list-paddingleft-2"><li><p><span style="font-size: 15px;">Mercury AMP 转换器[6]，任何使用 Google AMP 的网站，只需要加入一行代码。</span></p></li><li><p><span style="font-size: 15px;">Mercury Reader[7] 是超过 100 万用户使用的 Chrome 扩展程序，通过点击按钮可以消除文章中的广告和干扰，只留下任何网站上的文字和图像。</span></p></li><li><p><span style="font-size: 15px;">Bloomberg Lens[8]，Chrome 扩展程序和 iOS 共享表应用程序，其中提供有关网络上任何文章的相关新闻，公司数据和个人信息。</span></p></li></ul><p><br></p><p><span style="font-size: 15px;">我们还支持数千名每天使用 Mercury 的开发人员从网络上的任何文章中提取结构化内容。 每月完成 3900 万个请求，只需 370 美元。<br><br></span></p><p><span style="font-size: 15px;">对于每一百万的请求，花费还不到 10 美元，并且可以轻松地扩容。&nbsp;</span></p><p><br></p><p><span style="font-size: 15px;">相关链接：</span></p><p><br></p><ol class="list-paddingleft-2" style="list-style-type: decimal;"><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://trackchanges.postlight.com/extracting-content-from-the-chaos-of-the-web-introducing-the-mercury-web-parser-e920a1db7f86</span></p></li><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://aws.amazon.com/lambda/</span></p></li><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://aws.amazon.com/api-gateway/</span></p></li><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://serverless.com</span></p></li><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://trackchanges.postlight.com/extracting-content-from-the-chaos-of-the-web-introducing-the-mercury-web-parser-e920a1db7f86</span></p></li><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://mercury.postlight.com/amp-converter/</span></p></li><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://mercury.postlight.com/reader/</span></p></li><li><p><span style="font-size: 14px; color: rgb(0, 82, 255);">https://trackchanges.postlight.com/fat-static-and-happy-building-bloomberg-lens-8a458a10ed2a</span></p></li></ol><p><span style="font-size: 14px; color: rgb(0, 82, 255);"></span></p><p><span style="font-size: 14px; color: rgb(136, 136, 136);">英文原文：https://trackchanges.postlight.com/serving-39-million-requests-for-370-month-or-how-we-reduced-our-hosting-costs-by-two-orders-of-edc30a9a88cd</span></p><p><br></p><p style="max-width: 100%; min-height: 1em; background-color: rgb(255, 255, 255); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 20px; box-sizing: border-box !important; word-wrap: break-word !important;">推荐阅读</span></strong></p><p><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="max-width: 100%; width: 728.641px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548239&amp;idx=1&amp;sn=9202d4d708cfada26d9f9aa1c62aa3c2&amp;chksm=813a7f57b64df6416b9893800a8557405a4505e77ffa5a384fa89e62080a83b131803c7b8a2e&amp;scene=21#wechat_redirect" target="_blank" style="text-decoration: underline; font-size: 15px; color: rgb(0, 82, 255);"><span style="font-size: 15px; color: rgb(0, 82, 255);">无服务器架构 - 从使用场景分析其6大特性</span></a></p></li><li><p><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548079&amp;idx=1&amp;sn=2377b625db58b2ea93c3ef2d87e4c395&amp;chksm=813a7fb7b64df6a1cd6d1da7ebcc18f958939b7d1226555552dcc098fa64dca9441bc054e567&amp;scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548079&amp;idx=1&amp;sn=2377b625db58b2ea93c3ef2d87e4c395&amp;chksm=813a7fb7b64df6a1cd6d1da7ebcc18f958939b7d1226555552dcc098fa64dca9441bc054e567&amp;scene=21#wechat_redirect" style="text-decoration: underline; font-size: 15px; color: rgb(0, 82, 255);"><span style="font-size: 15px; color: rgb(0, 82, 255);">走向无后端的系统开发实践：CRUD自动化与强约定的REST接口</span></a></p></li></ul><p style="max-width: 100%; min-height: 1em; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><br></span></p><p style="max-width: 100%; min-height: 1em; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">本文作者 Adam Pash，由 Jesse 翻译，转载译文请注明出处，技术原创及架构实践文章，欢迎通过公众号菜单「联系我们」进行投稿。</span><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="max-width: 100%; min-height: 1em; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">高可用架构</strong></span></p><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">改变互联网的构建方式</strong></span></p><p style="max-width: 100%; min-height: 1em; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOPOK9rQud9XibGhPOPsA3gA8Wr4CEnzmhfZQzSGu0Q09GOuk18S9icZtuVnQewvyqZtOWyDnJPBDn1A/640?wx_fmt=jpeg" style="box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 200px !important; height: 200px !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></strong></span><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">长按二维码 关注「高可用架构」公众号</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1502116814&src=3&ver=1&signature=fMd4ZeYncDjRuvdiU8EiAnUULkvryB4DXbE6sTjTCTqAU6Wo3FeIV0BwKDpBDcxRzySp9S3gfEatTuMceIQGwycvRcW24uW9xPg1f*INBhnoi2zDslQ7R-7U*h9ecnjAMYFGa1eyCWULjZqxWKcIT753C9Zx1VRjonJKWeDj5aI=">微信地址</a> | <a href="https://trackchanges.postlight.com/serving-39-million-requests-for-370-month-or-how-we-reduced-our-hosting-costs-by-two-orders-of-edc30a9a88cd">阅读原文</a>
{% endraw  %}

