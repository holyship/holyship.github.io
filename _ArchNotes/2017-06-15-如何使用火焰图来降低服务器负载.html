---
title: 如何使用火焰图来降低服务器负载
author: Thayne McCombs
wechat_source: >-
  http://mp.weixin.qq.com/s?timestamp=1498052243&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ8OdiaQdxkVRGA4BYpGktYizaefUuMB1yICAw2oJGyPWe7WuPN2tjn3Tq6bNLSbc5ogQSjpV6gLWo35rxzXOtKbWQZyUrbCUY8v7GBjCiDuTKLC9HR6Fv5o4yQNDgx1q5f2AE07KR3oxF0G*1L9KVnU=
date: '2017-06-15 00:00:00 +0000'

---

{% raw  %}
<blockquote><p><span style="color: rgb(136, 136, 136);">LucidChart 提供在线编辑流程图、网络拓扑图、ER 图、 UML 图以及脑图等多种图表服务，有超过 7 百万的用户，因其简单直观的交互体验和强大的多人协作功能，是可以替代 Visio 的最佳选择。</span></p></blockquote><p><br></p><p>在 Lucid，我们使用面向服务的架构来建设我们的系统。其中字体服务（font service）就是其中之一，它负责根据字体族名称和 unicode 编码范围来提供相应的字体服务，同时也对用户上传的字体进行校验和检查。在生产环境中，该服务的负载一直很高，这一点超出我们的预期（使用或等待 CPU 的平均线程数）。特别从去年开始，我们注意到字体服务的负载高的惊人，特别是在晚上这样的流量低峰时期。</p><p><br></p><p>幸运的是最终我们找到了根本原因，并通过改进大大提高了服务的整体性能和稳定性。通过下面的内容，您将了解到我们是如何做到的。</p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOrjzCw8MgaZricsNU29j0eV80TKA9aqX7UVYLY7JQ8Sibu6j6XU5lqRRfGEfqqXvetUKVPrXKiaXoXA/0?wx_fmt=png" style="width: 576px !important; height: 167px !important; visibility: visible !important;"></p><p style="text-align: center;"><span style="font-size: 14px; color: rgb(136, 136, 136);">图1: 字体服务在变更前后服务器平均负载对比</span></p><p><br></p><h2 style="text-align: center;"><strong><span style="font-size: 18px;">通过火焰图来调试和发现问题</span></strong></h2><p><br>我们从 Netflix 找到了一个非常棒的火焰图工具[1][2]，并部署到生产环境。 此工具可以将多个不同调试分析工具的数据组合在一起并生成火焰图，以可视化的方式展示服务器和 JVM 的资源使用情况。</p><p><br></p><p>如下图所示，每个矩形表示一个栈帧，同时矩形的宽度代表了资源（比如 CPU 时间）的使用情况，Y 轴表示调用栈。通过识别那些宽的矩形块，就能快速缩小问题范围。在调试和排查字体服务时，它极大地帮助了我们。</p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOrjzCw8MgaZricsNU29j0eVTDFWjyMtzxlqn58vl1F0W7NDHUs4WPxYQrJibSXBv0lMDgCeMb2OShg/0?wx_fmt=png" style="width: 770px !important; height: 672.202px !important;"></p><p style="text-align: center;"><span style="font-size: 14px; color: rgb(136, 136, 136);">图2: 高负载时字体服务中一台服务器的火焰图</span></p><p><br></p><p>在高负载状态下，我们对字体服务收集数据并生成了几个火焰图。下图是其中之一，并且特别展示了 JVM 相关栈的部分。可以分析得出，大部分时间都花在了 <code>libz.so</code> 这一步（gzip 使用该库进行压缩/解压缩操作），剩下大部分时间都花在了 XML 转义和 UTF-8 编码上。<br></p><p><br></p><p><img src="http://mmbiz.qpic.cn/mmbiz_png/8XkvNnTiapOOrjzCw8MgaZricsNU29j0eVjqhDCxlA7JrmrdSG1x08BbjHyQOElEQHPbTqVvXmpd0LRvUx7gpIDA/0?wx_fmt=png" style="width: 770px !important; height: 673.342px !important;"></p><p style="text-align: center;"><span style="font-size: 14px; color: rgb(136, 136, 136);">图3: JVM 相关栈活动的局部火焰图</span></p><p><br></p><h2 style="text-align: center;"><span style="font-size: 18px;"><strong>找到慢的原因</strong></span></h2><p><br>首先多啰嗦几句这个字体服务的一些背景情况。我们将所有字体相关数据存储在 Amazon S3 中，具体来说是将每个字体的每个 unicode 范围分别存为一个 <code>S3 object</code>。当其他服务请求为了获取字体族，一组 unicode 范围，或者是用户自定义字体时会向字体服务请求字体数据，接着字体服务将字体数据包裹在 XML 中返回。<br><br>功能非常简单，并没有什么明显的密集型计算。但是对于出现的高负载问题，火焰图帮助我们识别出了问题所在—— <code>libz</code>，XML 转义和 UTF-8编码都使用了大量的 CPU。</p><p><br></p><p>但是为什么会产生这么多编码和压缩的消耗？记得前面提到晚上时间的负载反而是最高的吗？我们的晚上（美国山区时间）正好是亚洲地区的白天，该地区很多用户都使用中文、日文或韩文等亚洲语言。会进行大量的 gzip 解压缩 → UTF-8解码 → XML 转义 → UTF-8编码 → gzip 压缩。相比于拉丁语系，单个 CJK 的 unicode 范围比拉丁语系的 unicode 范围大2个数量级（1MB：60KB）。所以上述的转换过程都压到了 CPU 上，特别压缩和解压缩，以及 XML 转义这类操作。</p><p><br></p><h2 style="text-align: center;"><span style="font-size: 18px;"><strong>如何改进？</strong></span></h2><p><br>字体服务对请求的响应本质上只是 S3 上原始数据的集合。它确实需要执行一些重要的附加任务，如权限检查和从字体族中检索名称。但是，字体服务根本没必要挡在 S3 前面来代理那些字体数据！所以解决办法很简单， 直接用包含 S3 object 的链接（就是那些字体数据）的列表作为响应返回，字体服务不再从 S3 下载并重新编码字体数据。所以从图1中可以看出负载几乎降低到可忽略的程度。</p><p><br></p><h2 style="text-align: center;"><span style="font-size: 18px;"><strong>总结</strong></span></h2><p><br>通过调试分析生产环境，我们能够找到并消除那些不必要的任务和工作，进而降低服务器负载。<br></p><p><br></p><ol class="list-paddingleft-2"><li><p>使用例如火焰图之类的分析工具（profiling tool）来帮助识别 CPU 高占用的操作。</p></li><li><p>压缩/解压缩和各种编码/解码的操作都是昂贵的。</p></li><li><p>如果客户端可以直接访问数据，那么相比代理（客户端去请求）数据，直接返回链接是最好的选择，可以显著提高整体性能。</p></li></ol><p><br></p><h2><span style="font-size: 18px;"><strong>参考链接</strong></span></h2><p><span style="font-size: 18px;"><strong><br></strong></span></p><p>[1] Brendan D. Gregg的个人网站 http://www.brendangregg.com</p><p>[2] Flame graphs http://www.brendangregg.com/flamegraphs.html</p><p>[3] 白话火焰图 https://huoding.com/2016/08/18/531</p><p>[4] Java Flame graphs http://www.brendangregg.com/blog/2014-06-12/java-flame-graphs.html</p><p>[5] OpenRestry 关于火焰图在 Lua 中的使用&nbsp;https://moonbingbing.gitbooks.io/openresty-best-practices/flame_graph.html</p><p>[6] 在 Netflix 中的应用 http://techblog.netflix.com/2015/07/java-in-flames.html</p><p>[7] 在 Netflix 中的应用 http://techblog.netflix.com/2016/04/saving-13-million-computational-minutes.html</p><p><br></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 20px; box-sizing: border-box !important; word-wrap: break-word !important;">推荐阅读</span></strong></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><ul class="list-paddingleft-2" style="max-width: 100%; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; width: 728.641px; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548757&amp;idx=1&amp;sn=aece7852a527533bf21c70e60fac5c49&amp;chksm=813a614db64de85bca595ac90e32ba6f342ed4ef69c8fed4612e915d506c0c6d22265e4d7a33&amp;scene=21#wechat_redirect" target="_blank" style="text-decoration: underline; font-size: 14px; color: rgb(0, 82, 255);"><span style="font-size: 14px; color: rgb(0, 82, 255);">被忽视的位图数据库：Pilosa查询十亿级出租车搭乘数据案例</span></a></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548705&amp;idx=1&amp;sn=e066f09d766fc5e900b512e644d7c11b&amp;chksm=813a6139b64de82f74f7b3d684cb8dd2558a930f17574b5335028c42bb59fd105a1861afd2d3&amp;scene=21#wechat_redirect" target="_blank" style="text-decoration: underline; font-size: 14px; color: rgb(0, 82, 255);"><span style="font-size: 14px; color: rgb(0, 82, 255);">如何快速获得高并发编程经验？PCC性能挑战赛作品简介及源代码</span></a></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548547&amp;idx=1&amp;sn=bffe32cb7e0365a00e0cc60609ba644b&amp;chksm=813a619bb64de88d12da51aff3cdcf29f6c8ef1f47c0defa32fcb3e86276607565a21bdfdff3&amp;scene=21#wechat_redirect" target="_blank" style="text-decoration: underline; font-size: 14px; color: rgb(0, 82, 255);"><span style="font-size: 14px; color: rgb(0, 82, 255);">如何构建日请求数十亿次高性能高可用广告系统：微博广告架构解密</span></a></p></li><li><p style="max-width: 100%; min-height: 1em; box-sizing: border-box !important; word-wrap: break-word !important;"><a href="http://mp.weixin.qq.com/s?__biz=MzAwMDU1MTE1OQ==&amp;mid=2653548227&amp;idx=1&amp;sn=3deb458aa18fa878dc9eaf89aaa78303&amp;chksm=813a7f5bb64df64d7037213ef34b3ff6c09375593ec82919b214829b825e82565b6058366ef1&amp;scene=21#wechat_redirect" target="_blank" style="text-decoration: underline; font-size: 14px; color: rgb(0, 82, 255);"><span style="font-size: 14px; color: rgb(0, 82, 255);">LinkedIn:如何利用大数据算法定位网站性能瓶颈(BOSS)</span></a><br></p></li></ul><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">本文作者 Thayne McCombs，由魏佳翻译，转载请注明出处，技术原创及架构实践文章，欢迎通过公众号菜单「联系我们」进行投稿。</span><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(136, 136, 136); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">高可用架构</strong></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">改变互联网的构建方式</strong></span></p><p style="max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); font-size: 16px; white-space: normal; line-height: 25.6px; text-align: center; background-color: rgb(255, 255, 255); box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 18px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><img src="http://mmbiz.qpic.cn/mmbiz/8XkvNnTiapOPOK9rQud9XibGhPOPsA3gA8Wr4CEnzmhfZQzSGu0Q09GOuk18S9icZtuVnQewvyqZtOWyDnJPBDn1A/640?wx_fmt=jpeg" style="box-sizing: border-box !important; word-wrap: break-word !important; visibility: visible !important; width: 200px !important; height: 200px !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"></strong></span><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">长按二维码 关注「高可用架构」公众号</span></p><hr/><a href="http://mp.weixin.qq.com/s?timestamp=1498052243&src=3&ver=1&signature=nULoNfhbsabgcFJEB9PUQ8OdiaQdxkVRGA4BYpGktYizaefUuMB1yICAw2oJGyPWe7WuPN2tjn3Tq6bNLSbc5ogQSjpV6gLWo35rxzXOtKbWQZyUrbCUY8v7GBjCiDuTKLC9HR6Fv5o4yQNDgx1q5f2AE07KR3oxF0G*1L9KVnU=">微信地址</a> | <a href="https://www.lucidchart.com/techblog/2017/06/02/tips-tricks-for-reducing-server-load/">阅读原文</a>
{% endraw  %}

