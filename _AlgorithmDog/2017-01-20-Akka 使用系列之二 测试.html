---
title: 'Akka 使用系列之二: 测试'
author: lietal
date: '2017-01-20 00:00:00 +0000'

---

{% raw  %}
<p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp; &nbsp; &nbsp; 通过上一篇文章，我们已经大致了解怎么使用 Akka，期待细致用法。这篇文章将介绍如何用 Akka-testkit 对 Akka 程序进行测试。<span style="border: 0px; vertical-align: baseline; background: transparent;"></span></p><p><a rel="attachment wp-att-3677" style="border: 0px; vertical-align: baseline; color: rgb(116, 51, 153); background: transparent;"><img src="/AlgorithmDog/images/78b591024347057b2e704a3a3e5727c5f57997c3.png" style="border: none; vertical-align: baseline; background: transparent; width: 770px !important; height: 331.209px !important; visibility: visible !important;"></a></p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;并行程序是最难调试的程序类型之一，因此做好测试是相当重要的事情。为了减轻 Akka 的程序的测试难度, Akka 官方专门开发了一个测试工具包 Akka-testkit。</p><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;">1 Actor 的测试需求</span></h3><hr><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;"></span><br></h3><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于一个 Actor, 我们要测什么呢？不同的文章有不同的说法，比如<a style="border: 0px; vertical-align: baseline; color: rgb(116, 51, 153); background: transparent;">http://rerun.me/2014/09/29/akka-notes-logging-and-testing/&nbsp;</a>就把 Actor 测试需求分为:1)发送消息给 Actors, 2)测试内部状态，3）测试日志和 4)带参数 Actor 的测试。我个人认为，对于一个 Actor, 我们要测的有三个方面：1）Actor 接收消息之后，是否返回正确的消息，2）Actor 接收消息之后，是否正确地改变内部状态和执行内部行为，3）Actor 接收消息之后，是否正确地发消息给后续 Actor。当然这是我的一家之言，有什么不完善的地方，欢迎大家讨论。下面是一个简单的示例图。</p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);"><a rel="attachment wp-att-3758" style="   ; ; ; ; ; ; ;   "><img src="/AlgorithmDog/images/d1aecbee3624454ebb894b0b64a1ff188ac3deb4.png" style="border: none; vertical-align: baseline; background: transparent; width: 507px !important; height: 247px !important;"></a></p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">下面是 studentActor 的一段代码，反应了 studentActor 接受到早上时间消息之后的动作，包括：1）给环境或者闹钟回应“关闭闹钟”，2）内部变量 DayInSchool 加 1，3）向老师发送问题消息。这段代码将包含所有要测试的元素，后面我们将示例怎么用 Akka-testkit 测试这段代码。</p><p><img src="/AlgorithmDog/images/467c93d9a29e0e0fa17c30ea12f3456abf5580ec.png" style="width: 657px !important; height: 270px !important;"><br></p><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;"><br></span></h3><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;">2 不适用的 Scalatest</span></h3><hr><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;"></span><br></h3><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Scalatest 是 Scala 开发者们最常见的测试工具，其用法非常简便。下面是一个 Scalatest 的简单示例。</p><p><img src="/AlgorithmDog/images/a082cd8b08f51ffab40f5e276197e720f547458d.png" style="width: 648px !important; height: 138px !important;"><br></p><p src="http://mmbiz.qpic.cn/mmbiz_png/Q3H1TCddfvMSOOpWZIN8qK9coArqicAKjSykRMqY2SLSVdyIGbhPlGlwG9GlJic5THP9iaRwhyuQhEFmvxdntSr7Q/0?wx_fmt=png" data-type="png"><br></p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">但是我们无法使用 scalatest 测试 Actor。原因在于：1）Scalatest 无法捕捉被测 Actor 回应的消息，因此无法测试被测 Actor 是否正确回应消息; 2）Scalatest 无法获取被测 Actor 的内部状态，因此无法测试被测 Actor 内部状态的改变是否正确; 3) Scalatest 无法捕捉被测 Actor 对外发送的消息，因此无法测试被测 Actor 对外发送的消息是否正确。因此有必要针对 Akka 开发一套测试工具, Akka-testkit 测试包应运而生。<br></p><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;">3 Akka-testkit 的使用</span></h3><hr><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;"></span><br></h3><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maven 项目要使用 Akka-testkit，需要在 pom.xml 文件中加入 akka-testkit 包，如下所示。</p><p><img src="/AlgorithmDog/images/79a15cbd044d7037d9b9ec204e045326a88c5dd7.png" style="width: 656px !important; height: 124px !important;"><br></p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">然后编写单元测试的代码，其基本范例如下。</p><p><img src="/AlgorithmDog/images/5d9fab072a20742fff8fcd375a14bea94a72a1f0.png" style="width: 658px !important; height: 310px !important;"><br></p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp; &nbsp; &nbsp; Akka-testkit 的主要工具包括, 1) testProbe 用于测试 Actor 回应和发送消息，testActor 用于简便情况下测试 Actor 回应消息，和 2) testActorRef 用于测试 Actor 内部状态的改变。<br></p><h4 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 24px;"><span style="border: 0px; vertical-align: baseline; background: transparent;">3.1 回应消息的测试</span></h4><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于被测 Actor 是否正确地回应消息，可以用 testProbe 测试。首先将 testProbe 给被测 Actor 发送消息，再看 testProbe 是否接受到期望的回应消息。下面是一个示例。</p><p><img src="/AlgorithmDog/images/be93af1c25ab160ccb7b644b9723ca8d7e4e4c6e.png" style="width: 652px !important; height: 334px !important;"><br></p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;除了使用 testProbe 之外，Akka-testkit 还提供一种简便方法: 使用 testActor。 如果测试类实现特质 ImplicitSender， studentActorRef ! 7.toLong 发送给 studentActor 的消息 7.toLong 就是从 testActor 来的。然后在调用 expectMsg("关闭闹钟") 就可以测试 testActor 是否收到 studentActor 回应消息 "关闭闹钟" 了。具体代码如下所示。</p><p><img src="/AlgorithmDog/images/46ba3d7f9035a74aee0e1b63f53377d541698abf.png" style="width: 652px !important; height: 412px !important;"><br></p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">我们可以看出，使用 testActor 的代码比使用 testProbe 的简便。但是，一个东西的用法越是简便，功能便越缺失。testActor 最大的缺失是只能接受被测 Actor 发来的一个回应消息。比如下面的代码就会报错。</p><p><img src="/AlgorithmDog/images/5d77a2d59fe21e5e7bde85dcbb033c6a081c3859.png" style="width: 653px !important; height: 201px !important;"><br></p><h4 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 24px;"></h4><h4 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 24px;"><span style="border: 0px; vertical-align: baseline; background: transparent;">3.2 内部状态的测试</span></h4><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于被测 Actor 内部状态的改变，可以用 TestActorRef 进行测试。TestActorRef.underlyingActor 可以探测被测 Actor 的内部，用于测试被测 Actor 内部状态是否符合预期。 下面是一个示例。</p><p><img src="/AlgorithmDog/images/d5a2725b24cecf3e3523fddf9c1b9e4680fac8c2.png" style="width: 652px !important; height: 226px !important;"><br></p><h4 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 24px;">3.3 发出消息的测试</h4><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于被测 Actor 是否正确地发出消息，也可以用 testProbe 测试。首先将 testProbe 设置为被测 Actor 发出消息的目标，然后让被测 Actor 发出消息，再看 testProbe 是否接受到期望的消息。下面是一个示例。</p><p><img src="/AlgorithmDog/images/7b468f0db3324d43dc17371eff23f1670c07e1ec.png" style="width: 655px !important; height: 415px !important;"><br></p><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;"><br></span></h3><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;">4 总结</span></h3><hr><h3 style="border: 0px; margin-bottom: 10px; vertical-align: baseline; clear: both; line-height: 1.5em;"><span style="border: 0px; vertical-align: baseline; background: transparent;"></span><br></h3><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Akka-testkit 是 Akka 官方推出的 Akka 测试工具包，用于减轻 Akka 程序的测试难度。Akka-testkit 的主要工具包括, 1) testProbe 用于测试被测 Actor 回应和发送消息，testActor 用于简便情况下测试被测 Actor 回应消息，和 2) testActorRef 用于测试被测 Actor 内部状态的改变。完整的项目代码已经上传到&nbsp;<a style="border: 0px; vertical-align: baseline; color: rgb(116, 51, 153); background: transparent;"></a>https: //github. com/ AlgorithmDog/ AkkaUsageLearner&nbsp;上了。被测 Actor 是 org. algorithmdog. akkalearning. StudentActor, 测试类是 org. algorithmdog. akkalearning. StudentActorTest。</p><p style="border: 0px; margin-bottom: 24px; vertical-align: baseline; color: rgb(51, 51, 51);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这篇文章难产了很长一段时间，对不住支持我的读者们。对不起。Akka 和 Actor 模型对我来说是一个全新的东西，花了比较多的时间学习和熟悉。学习之后，觉得第一篇写得太不清楚了，准备重构第一篇。对于这篇文章质量，我个人比较满意的，甚至敢认为这篇文章应该是国内关于 Akka-testkit 最清楚的文章之一（ps:大牛们轻喷）。最后欢迎关注我的公众号，每两周的更新就会有提醒哦~</p><p><a rel="attachment wp-att-2360" style="border: 0px; vertical-align: baseline; color: rgb(116, 51, 153); background: transparent;"><img src="/AlgorithmDog/images/eb33a2f79669ea2345d3f07cd71b28c400579001.png" style="border: none; vertical-align: baseline; background: transparent; width: 709px !important; height: 324px !important;"></a></p><p><br></p>
{% endraw  %}

